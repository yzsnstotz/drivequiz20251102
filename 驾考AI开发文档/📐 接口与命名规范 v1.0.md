ğŸ“ æ¥å£ä¸å‘½åè§„èŒƒ v1.0

é€‚ç”¨èŒƒå›´

ä¸»ç«™ APIï¼ˆNext.js App Routerï¼‰ï¼š/api/ai/*ã€/api/admin/ai/*

AI å­æœåŠ¡ï¼ˆExpress/Fastifyï¼‰ï¼š/v1/*

æ—¥åæ–°å¢æœåŠ¡éœ€æ²¿ç”¨æœ¬è§„èŒƒ

ç»Ÿä¸€çº¦å®š

JSON å­—æ®µï¼šcamelCase

æ•°æ®åº“å­—æ®µï¼šsnake_case

è¡¨åï¼šå¤æ•°ã€snake_case

æ—¶é—´ï¼šISO 8601ï¼ˆUTCï¼Œå¸¦ Zï¼‰ï¼Œä¾‹å¦‚ï¼š2025-11-03T03:21:00Z

å¸ƒå°”å‘½åï¼šä»¥ is/has/can å‰ç¼€ï¼Œå¦‚ isEnabled

æšä¸¾å¸¸é‡ï¼šå­—ç¬¦ä¸²å°å†™ä¸­åˆ’çº¿æˆ–ä¸‹åˆ’çº¿ï¼Œå¦‚ï¼š"ok" | "needs_human" | "blocked"

è¯­è¨€ä»£ç ï¼šIETF BCP-47ï¼ˆä¾‹ï¼šja-JP, zh-CN, en-USï¼‰ï¼›å†…éƒ¨å¯ç®€åŒ–å­˜ ja/zh/enï¼Œå¯¹å¤–å“åº”ä¿ç•™åŸå§‹ locale

0. ç‰ˆæœ¬ä¸è·¯å¾„

ä¸»ç«™å¯¹å‰ç«¯ï¼š/api/ai/*ï¼ˆç¨³å®šï¼‰ï¼Œ/api/admin/ai/*ï¼ˆä»…ç®¡ç†å‘˜ï¼‰

AI å­æœåŠ¡å¯¹ä¸»ç«™ï¼š/v1/*

ç‰ˆæœ¬æ¼”è¿›ï¼šæ–°ç ´åæ€§æ”¹åŠ¨èµ° æ–°è·¯å¾„ï¼ˆä¾‹å¦‚ /v2/askï¼‰ï¼Œæ—§è·¯å¾„ä¿ç•™ 30 å¤©è¿ç§»æœŸ

1. é‰´æƒä¸å®‰å…¨
1.1 ä¸»ç«™ï¼ˆå¯¹å‰ç«¯ï¼‰

ç”¨æˆ·é‰´æƒï¼šAuthorization: Bearer <JWT>ï¼ˆç™»å½•ç”¨æˆ·ï¼‰

è·¨åŸŸï¼šä»…ä¸»åŸŸåï¼Œä¸¥æ ¼ CORSï¼ˆå¦‚éœ€ï¼‰

é™æµï¼ˆä¸šåŠ¡ï¼‰ï¼šæ¯æ—¥ 10 æ¬¡/ç”¨æˆ·ï¼›å•æ¬¡å›ç­” â‰¤ 300 å­—ï¼ˆè¾“å‡ºçº¦æŸï¼‰ï¼›è¯·æ±‚ä½“æœåŠ¡å™¨ç«¯æ ¡éªŒ

1.2 ä¸»ç«™ â†’ AI å­æœåŠ¡ï¼ˆæœåŠ¡é—´ï¼‰

Service Tokenï¼ˆå›ºå®šç™½åå•ï¼‰ï¼š
Authorization: Bearer <SERVICE_TOKEN>

AI å­æœåŠ¡ä»…æ¥å—æ¥è‡ªä¸»ç«™çš„è°ƒç”¨

å¤šæœåŠ¡æ—¶å¯é…ç½®é€—å·åˆ†éš”çš„ token ç™½åå•

1.3 ç®¡ç†ç«¯

Authorization: Bearer <ADMIN_JWT> + è§’è‰²æ ¡éªŒï¼ˆrole=adminï¼‰

2. é€šç”¨è¯·æ±‚ä¸å“åº”
2.1 Headers

Content-Type: application/json; charset=utf-8

Authorization: Bearer <token>ï¼ˆæŒ‰åœºæ™¯ï¼‰

2.2 æˆåŠŸå“åº”ï¼ˆç»Ÿä¸€åŒ…è£¹ï¼‰
{
  "ok": true,
  "data": { /* å…·ä½“å¯¹è±¡æˆ–æ•°ç»„ */ },
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 132,
    "pages": 7
  }
}


æ— åˆ†é¡µæ—¶çœç•¥ paginationã€‚

2.3 é”™è¯¯å“åº”ï¼ˆç»Ÿä¸€åŒ…è£¹ï¼‰
{
  "ok": false,
  "errorCode": "RATE_LIMIT_EXCEEDED",
  "message": "Daily ask limit exceeded.",
  "details": { "limit": 10, "resetAt": "2025-11-04T00:00:00Z" }
}


æ ‡å‡†é”™è¯¯ç ï¼ˆèŠ‚é€‰ï¼‰

AUTH_REQUIREDï¼ˆç¼ºå°‘æˆ–æ— æ•ˆå‡­è¯ï¼‰

FORBIDDENï¼ˆæ— æƒé™ï¼‰

VALIDATION_FAILEDï¼ˆå‚æ•°ä¸åˆæ³•ï¼‰

RATE_LIMIT_EXCEEDEDï¼ˆè¶…å‡ºé…é¢/é™æµï¼‰

NOT_RELEVANTï¼ˆéåœ¨æ—¥é©¾é©¶/è½¦è¾†ç›¸å…³ï¼Œå·²æ‹’ç­”ï¼‰

SAFETY_BLOCKEDï¼ˆå‘½ä¸­æ•æ„Ÿ/ç¦ç­”ç­–ç•¥ï¼‰

PROVIDER_ERRORï¼ˆä¸Šæ¸¸æ¨¡å‹/æ£€ç´¢å¼‚å¸¸ï¼‰

INTERNAL_ERRORï¼ˆæœªæ•è·å¼‚å¸¸ï¼‰

HTTP çŠ¶æ€ç 

200/201ï¼ˆæˆåŠŸ/å·²åˆ›å»ºï¼‰

400ï¼ˆå‚æ•°æ ¡éªŒå¤±è´¥ï¼‰

401ï¼ˆé‰´æƒå¤±è´¥ï¼‰

403ï¼ˆç¦æ­¢è®¿é—®ï¼‰

404ï¼ˆèµ„æºä¸å­˜åœ¨ï¼‰

409ï¼ˆå†²çªï¼Œå¦‚é‡å¤ä¸Šä¼ ï¼‰

429ï¼ˆé™æµ/é…é¢è¶…é™ï¼‰

500ï¼ˆæœåŠ¡å¼‚å¸¸ï¼‰

502/504ï¼ˆä¸Šæ¸¸è¶…æ—¶/é”™è¯¯ï¼Œä¸»ç«™ä»£å›ï¼‰

3. å­—æ®µä¸å‘½å
3.1 å¸¸ç”¨å­—æ®µè¯­ä¹‰

userId: stringï¼ˆUUID / CUIDï¼‰

locale: stringï¼ˆja-JP/zh-CN/en-USï¼‰

question: stringï¼ˆç”¨æˆ·é—®é¢˜ï¼ŒåŸæ–‡ï¼‰

answer: stringï¼ˆæœ€ç»ˆå›ç­”ï¼Œâ‰¤300 å­—ï¼‰

sources: SourceRef[]ï¼ˆRAG å¼•ç”¨ï¼‰

model: stringï¼ˆä¾‹ï¼šgpt-4o-miniï¼‰

safetyFlag: "ok" | "needs_human" | "blocked"

costEstimate: { inputTokens: number, outputTokens: number, approxUsd: number }

createdAt/updatedAt: string (ISO 8601)

3.2 SourceRefï¼ˆRAG æ¥æºï¼‰
type SourceRef = {
  title: string;     // "é“è·¯äº¤é€šæ³• ç¬¬â—‹æ¡"
  url: string;       // å®˜æ–¹æˆ–èµ„æ–™é“¾æ¥
  snippet?: string;  // å‘½ä¸­ç‰‡æ®µæ‘˜è¦
  docId?: string;    // å†…éƒ¨æ–‡æ¡£ID
  score?: number;    // ç›¸ä¼¼åº¦(0~1)
  version?: string;  // çŸ¥è¯†åº“ç‰ˆæœ¬æ ‡ç­¾
}

4. ä¸»ç«™å¼€æ”¾æ¥å£ï¼ˆå¯¹å‰ç«¯ï¼‰
4.1 æé—®ï¼šPOST /api/ai/ask

Authï¼šç”¨æˆ· JWT
ç”¨é€”ï¼šç”¨æˆ·å‘èµ·åœ¨æ—¥é©¾é©¶ç›¸å…³é—®ç­”

Request

{
  "question": "å¤–å›½å…è¨±ã§æ—¥æœ¬ã®å…¬é“ã‚’é‹è»¢ã§ãã¾ã™ã‹ï¼Ÿ",
  "locale": "ja-JP"
}


locale å¯é€‰ï¼Œç¼ºçœæ—¶æŒ‰ç”¨æˆ·è®¾ç½®æˆ–è‡ªåŠ¨è¯†åˆ«ã€‚

Response

{
  "ok": true,
  "data": {
    "answer": "çŸ­æœŸæ»åœ¨ä¸­ã¯æ¡ä»¶ä»˜ãã§å¯èƒ½ã§ã™ãŒâ€¦ï¼ˆâ‰¤300å­—ï¼‰",
    "sources": [
      {
        "title": "è­¦å¯Ÿåº å¤–å›½å…è¨±FAQ",
        "url": "https://www.npa.go.jp/...",
        "snippet": "å¤–å›½å…è¨±ã«é–¢ã™ã‚‹â€¦",
        "score": 0.86
      }
    ],
    "model": "gpt-4o-mini",
    "safetyFlag": "ok",
    "costEstimate": { "inputTokens": 432, "outputTokens": 210, "approxUsd": 0.0002 }
  }
}


å¯èƒ½é”™è¯¯

400 VALIDATION_FAILEDï¼ˆç©ºé—®é¢˜/è¿‡é•¿ï¼‰

403 FORBIDDENï¼ˆå°ç¦ç”¨æˆ·ï¼‰

429 RATE_LIMIT_EXCEEDEDï¼ˆè¶…è¿‡10æ¬¡/æ—¥ï¼‰

400 NOT_RELEVANTï¼ˆéåœ¨æ—¥é©¾é©¶/è½¦è¾†ç±»ï¼‰

5. ç®¡ç†ç«¯æ¥å£ï¼ˆå¯¹ç®¡ç†å‘˜ï¼‰
5.1 æ—¥å¿—æŸ¥è¯¢ï¼šGET /api/admin/ai/logs

Authï¼šadmin
Query

?page=1&limit=20&userId=...&q=...&locale=ja&model=gpt-4o-mini&from=2025-11-01&to=2025-11-03


Response

{
  "ok": true,
  "data": [
    {
      "id": "log_01J...",
      "userId": "u_123",
      "question": "â€¦",
      "answer": "â€¦",
      "locale": "ja-JP",
      "model": "gpt-4o-mini",
      "ragHits": 2,
      "safetyFlag": "ok",
      "costEstimate": { "inputTokens": 300, "outputTokens": 290, "approxUsd": 0.0003 },
      "createdAt": "2025-11-03T03:21:00Z"
    }
  ],
  "pagination": { "page": 1, "limit": 20, "total": 132, "pages": 7 }
}

5.2 æ¯æ—¥æ±‡æ€»ï¼šGET /api/admin/ai/summary

Query

?date=2025-11-02


Response

{
  "ok": true,
  "data": {
    "date": "2025-11-02",
    "totalCalls": 1200,
    "avgCostUsd": 0.015,
    "cacheHitRate": 0.72,
    "ragHitRate": 0.81,
    "topQuestions": [
      { "q": "å¤–å›½å…è¨±â€¦", "count": 42 },
      { "q": "åˆå¿ƒè€…ãƒãƒ¼ã‚¯â€¦", "count": 31 }
    ]
  }
}

5.3 ç¦ç­”å…³é”®è¯ï¼šGET /api/admin/ai/filters / POST /api/admin/ai/filters

POST Body

{
  "items": [
    { "type": "not-driving", "pattern": "é¸æŒ™|ç·ç†|åŒ»ç™‚|æ‹æ„›" },
    { "type": "sensitive", "pattern": "å€‹äººæƒ…å ±|å…è¨±ç•ªå·" }
  ]
}

5.4 çŸ¥è¯†åº“ä¸Šä¼ ï¼ˆè§¦å‘å‘é‡åŒ–ï¼‰

POST /api/admin/ai/rag/docs

{
  "title": "è­¦å¯Ÿåº å¤–å›½å…è¨± FAQ 2025ç‰ˆ",
  "url": "https://www.npa.go.jp/...",
  "content": "ï¼ˆçº¯æ–‡æœ¬æˆ–å·²æŠ½å–çš„æ®µè½â€¦ï¼‰",
  "version": "2025Q4"
}


Response

{ "ok": true, "data": { "docId": "doc_01J...", "chunks": 128 } }

5.5 é…ç½®è¯»å†™

GET /api/admin/ai/configï¼šè¯»å– dailyAskLimitã€answerCharLimitã€modelã€cacheTtl ç­‰

PUT /api/admin/ai/configï¼šæ›´æ–°ä¸Šè¿°é…ç½®ï¼ˆéœ€å®¡è®¡æ—¥å¿—ï¼‰

6. ä¸»ç«™ â†’ AI å­æœåŠ¡æ¥å£
6.1 POST /v1/ask

Headers

Authorization: Bearer <SERVICE_TOKEN>
Content-Type: application/json


Request

{
  "userId": "u_123",
  "locale": "ja-JP",
  "question": "ä¸­å›½å…è¨±ã§æ—¥æœ¬ã®å…¬é“ã‚’é‹è»¢ã§ãã¾ã™ã‹ï¼Ÿ",
  "metadata": { "channel": "web", "client": "zalem" }
}


Response

{
  "ok": true,
  "data": {
    "answer": "çŸ­æœŸæ»åœ¨ä¸­ã¯â€¦ï¼ˆâ‰¤300å­—ï¼‰",
    "sources": [
      { "title": "è­¦å¯Ÿåº å¤–å›½å…è¨±FAQ", "url": "https://www.npa.go.jp/...", "score": 0.86 }
    ],
    "model": "gpt-4o-mini",
    "safetyFlag": "ok",
    "costEstimate": { "inputTokens": 432, "outputTokens": 210, "approxUsd": 0.0002 }
  }
}


é”™è¯¯ï¼ˆç¤ºä¾‹ï¼‰

401 AUTH_REQUIREDï¼ˆç¼ºå°‘/æ— æ•ˆ Service Tokenï¼‰

400 VALIDATION_FAILEDï¼ˆå‚æ•°ç¼ºå¤±ï¼‰

400 NOT_RELEVANTï¼ˆéåœ¨æ—¥é©¾é©¶/è½¦è¾†ç±»ï¼‰

403 SAFETY_BLOCKEDï¼ˆå‘½ä¸­æ•æ„Ÿï¼‰

502 PROVIDER_ERRORï¼ˆOpenAI/æ£€ç´¢å¼‚å¸¸ï¼‰

500 INTERNAL_ERROR

7. åˆ†é¡µä¸æ’åº
7.1 æŸ¥è¯¢å‚æ•°

pageï¼ˆé»˜è®¤ 1ï¼‰ã€limitï¼ˆé»˜è®¤ 20ï¼Œä¸Šé™ 100ï¼‰

æ’åºå­—æ®µç™½åå•ï¼ˆä¾‹å¦‚æ—¥å¿—ï¼‰ï¼š

sortBy âˆˆ { createdAt, costEstimate, ragHits }

order âˆˆ { asc, desc }ï¼ˆé»˜è®¤ descï¼‰

é”™è¯¯å¤„ç†

éç™½åå•å­—æ®µ â†’ VALIDATION_FAILEDï¼ˆ"sortBy not allowed"ï¼‰

8. æ ¡éªŒä¸é•¿åº¦é™åˆ¶

questionï¼šå¿…å¡«ï¼ŒUTF-8ï¼Œå»ºè®® â‰¤ 300 æ±‰å­—æˆ–ç­‰æ•ˆé•¿åº¦ï¼›ç¡¬æ€§ä¸Šé™ 1000 å­—ç¬¦

answerï¼šAI ç«¯ä¸¥æ ¼è£åˆ‡åˆ° â‰¤ 300 å­—ï¼ˆå¤šè¯­è¨€å…¼å®¹ï¼Œä¼˜å…ˆæŒ‰å­—ç¬¦æ•°ï¼‰

localeï¼šå¯ç©ºï¼›éç©ºæ—¶éœ€æ»¡è¶³ BCP-47 æ­£åˆ™

sourcesï¼šæ•°ç»„ä¸Šé™ 5 æ¡ï¼Œå»é‡åè¿”å›

9. è´¹ç”¨ä¸ç›‘æ§å­—æ®µ

costEstimate.inputTokens / outputTokensï¼šæ¥è‡ªæ¨¡å‹è¿”å›æˆ–æœ¬åœ°ä¼°ç®—

approxUsdï¼šæŒ‰å½“å‰ä»·ç›®ä¼°ç®—ï¼ˆå¯ä¸å®é™…è´¦å•æœ‰å¾®å·®ï¼‰

æ—¥å¿—è½åº“ï¼šai_logs.cost_estï¼ˆnumeric(10,4)ï¼‰

10. ç¼“å­˜è§„èŒƒ

Keyï¼šsha256(normalize(question) + "|" + locale)

TTLï¼šé»˜è®¤ 24hï¼Œå¯é…ç½®

å‘½ä¸­æ¡ä»¶ï¼šç›¸åŒå½’ä¸€åŒ–é—®é¢˜ + è¯­è¨€ç›¸åŒ + åŒç‰ˆæœ¬çŸ¥è¯†åº“ï¼ˆversionï¼‰

å›æºç­–ç•¥ï¼šç¼“å­˜å¤±æ•ˆ â†’ RAG æ£€ç´¢ â†’ ç”Ÿæˆå¹¶å›å¡«

11. OpenAPI ç‰‡æ®µï¼ˆAI å­æœåŠ¡ï¼‰
openapi: 3.0.3
info:
  title: ZALEM AI-Service API
  version: "1.0.0"
paths:
  /v1/ask:
    post:
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [userId, question]
              properties:
                userId: { type: string }
                locale: { type: string }
                question: { type: string, maxLength: 1000 }
                metadata:
                  type: object
                  additionalProperties: true
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  data:
                    type: object
                    properties:
                      answer: { type: string, maxLength: 1200 }
                      sources:
                        type: array
                        items:
                          type: object
                          properties:
                            title: { type: string }
                            url: { type: string, format: uri }
                            snippet: { type: string }
                            score: { type: number }
                            version: { type: string }
                      model: { type: string }
                      safetyFlag:
                        type: string
                        enum: [ok, needs_human, blocked]
                      costEstimate:
                        type: object
                        properties:
                          inputTokens: { type: integer }
                          outputTokens: { type: integer }
                          approxUsd: { type: number }
        "400": { description: Bad Request }
        "401": { description: Unauthorized }
        "403": { description: Forbidden }
        "429": { description: Too Many Requests }
        "500": { description: Internal Error }
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer

12. å‘½åé»‘åå•ä¸é£é™©ç‚¹

ç¦æ­¢åœ¨ JSON ä¸­ä½¿ç”¨ snake_case

ç¦æ­¢æš´éœ²å†…éƒ¨è‡ªå¢ä¸»é”®ç»™å‰ç«¯ï¼ˆå¯¹å¤–ç”¨ id çš„å®‰å…¨å­—ç¬¦ä¸²ï¼‰

æ’åºå­—æ®µå¿…é¡»èµ°ç™½åå•ï¼Œç¦æ­¢ç”¨æˆ·è‡ªç”±æ‹¼æ¥ SQL

é”™è¯¯ç ä¸æç¤ºæ–‡æ¡ˆå¿…é¡»ä¸ä¸Šè¡¨ä¿æŒä¸€è‡´ï¼Œä¾¿äºå‰ç«¯ç»Ÿä¸€å¤„ç†

13. å˜æ›´æ§åˆ¶ï¼ˆChangelog çº¦å®šï¼‰

ä»»ä½•æ–°å¢å­—æ®µ = å‘åå…¼å®¹ï¼ˆå‰ç«¯å¯å¿½ç•¥ï¼‰

ä»»ä½•å­—æ®µé‡å‘½å/åˆ é™¤ = æ–°ç‰ˆæœ¬è·¯å¾„ï¼ˆ/v2/...ï¼‰ï¼Œå‘ç‰ˆå…¬å‘Š + 30 å¤©å¹¶è¡ŒæœŸ

OpenAPI ä¸æœ¬è§„èŒƒéœ€åŒæ­¥æ›´æ–°ï¼ˆåŒä»“æäº¤ï¼‰