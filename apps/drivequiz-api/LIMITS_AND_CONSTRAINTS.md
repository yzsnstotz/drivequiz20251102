# DriveQuiz API 限制与约束说明

本文档详细说明 DriveQuiz API 的各项限制和约束，帮助调用方合理规划请求，避免因过度调用导致的问题。

---

## 📊 API 调用频率限制

### 1. 全局速率限制

**限制说明：**
- **默认限制**：100 请求/分钟
- **时间窗口**：60 秒（1分钟）
- **作用范围**：所有 API 端点（除健康检查外）

**配置方式：**
通过环境变量可调整限制：

```bash
# 设置每分钟最大请求数
RATE_LIMIT_DOCS=100

# 设置时间窗口（毫秒）
RATE_LIMIT_WINDOW=60000  # 60秒 = 60000毫秒
```

**超出限制响应：**
```json
{
  "success": false,
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "Rate limit exceeded"
  }
}
```

**HTTP 状态码：** `429 Too Many Requests`

**建议：**
- 单文档上传：建议控制在 **50-80 请求/分钟** 以内，留出安全余量
- 批量上传：建议控制在 **10-20 批次/分钟** 以内
- 如需更高频率，请联系管理员调整 `RATE_LIMIT_DOCS` 配置

---

## 📦 批量上传限制

### 1. 批次大小限制

**限制说明：**
- **最大批次大小**：100 条文档/批次
- **最小批次大小**：1 条文档/批次
- **配置方式**：通过环境变量 `MAX_BATCH_SIZE` 可调整（默认 100）

**超出限制响应：**
```json
{
  "success": false,
  "error": {
    "code": "INVALID_REQUEST",
    "message": "Validation failed: Array must have at most 100 items"
  }
}
```

**建议：**
- 推荐批次大小：**20-50 条文档/批次**
- 避免单批次过大导致请求超时
- 如需上传大量文档，建议分批处理

### 2. 并发处理限制

**限制说明：**
- **并发处理数**：10 个文档同时处理
- **固定配置**：代码中硬编码，不可通过环境变量调整

**影响：**
- 批量上传时，系统会并发处理最多 10 个文档
- 超出部分会排队等待处理
- 建议根据实际处理速度调整批次大小

---

## 📏 请求体大小限制

### 1. 请求体大小

**限制说明：**
- **最大请求体大小**：10MB
- **配置位置**：Fastify 服务器配置（`bodyLimit: 10 * 1024 * 1024`）

**超出限制响应：**
- Fastify 会自动拒绝请求
- 返回 `413 Payload Too Large` 错误

**建议：**
- 单文档上传：单个文档内容建议控制在 **100KB** 以内
- 批量上传：100 条文档的总大小建议控制在 **5-8MB** 以内
- 避免单次请求过大导致网络超时

---

## 📄 文档内容限制

### 1. 内容长度限制

**限制说明：**
- **最小长度**：100 字符
- **最大长度**：2000 字符
- **验证位置**：文档验证器（`validator.ts`）

**超出限制响应：**
```json
{
  "success": false,
  "error": {
    "code": "CONTENT_TOO_SHORT",
    "message": "Content must be at least 100 characters"
  }
}
```

**建议：**
- 确保文档内容在 **100-2000 字符** 范围内
- 如果内容过长，建议在 Datapull 端进行分片处理

---

## 🔗 Local AI Service Embedding 限制

### 1. Embedding 输入长度限制

**限制说明：**
- **最大输入长度**：3000 字符
- **实现位置**：`apps/local-ai-service/src/lib/ollamaClient.ts`
- **处理方式**：自动截断超出部分（`text.slice(0, 3000)`）

**影响：**
- 如果传入的文本超过 3000 字符，会被自动截断
- 可能导致向量化结果不完整
- **建议在 Datapull 端确保分片内容不超过 3000 字符**

### 2. Embedding 模型限制

**限制说明：**
- **模型**：`nomic-embed-text`（Ollama）
- **向量维度**：768 维
- **性能影响**：大量并发请求可能导致 Ollama 服务压力过大

**建议：**
- 控制向量化请求的并发数量
- 避免短时间内大量触发向量化任务
- 监控 Ollama 服务的资源使用情况

---

## ⚠️ 综合建议

### 1. 调用频率建议

| 操作类型 | 推荐频率 | 最大频率 | 说明 |
|---------|---------|---------|------|
| 单文档上传 | 50-80 次/分钟 | 100 次/分钟 | 留出安全余量 |
| 批量上传（20条/批次） | 10-15 批次/分钟 | 20 批次/分钟 | 考虑处理时间 |
| 批量上传（50条/批次） | 5-8 批次/分钟 | 10 批次/分钟 | 批次越大，频率越低 |
| 批量上传（100条/批次） | 2-5 批次/分钟 | 5 批次/分钟 | 避免超时 |

### 2. 批次大小建议

| 文档大小 | 推荐批次大小 | 说明 |
|---------|------------|------|
| 小文档（<1KB） | 50-100 条/批次 | 可以较大批次 |
| 中等文档（1-5KB） | 20-50 条/批次 | 平衡处理速度 |
| 大文档（5-10KB） | 10-20 条/批次 | 避免请求过大 |
| 超大文档（>10KB） | 5-10 条/批次 | 单文档上传更安全 |

### 3. 错误处理建议

**遇到 `RATE_LIMIT_EXCEEDED` 错误时：**
1. 立即停止请求，等待 1 分钟后再试
2. 降低请求频率，增加请求间隔
3. 考虑使用批量上传减少请求次数
4. 如需更高频率，联系管理员调整配置

**遇到 `413 Payload Too Large` 错误时：**
1. 减小批次大小
2. 检查单个文档内容是否过大
3. 考虑在 Datapull 端进行更细粒度的分片

**遇到 Embedding 服务压力过大时：**
1. 降低向量化任务的触发频率
2. 考虑使用异步批量处理
3. 监控 Ollama 服务的资源使用情况

---

## 🔧 环境变量配置

### DriveQuiz API 相关配置

```bash
# 速率限制
RATE_LIMIT_DOCS=100              # 每分钟最大请求数
RATE_LIMIT_WINDOW=60000          # 时间窗口（毫秒）

# 批量上传限制
MAX_BATCH_SIZE=100               # 最大批次大小

# 其他配置
LOG_LEVEL=info                   # 日志级别
PORT=8789                        # 服务端口
```

### Local AI Service 相关配置

```bash
# Embedding 模型
EMBEDDING_MODEL=nomic-embed-text

# Ollama 服务地址
OLLAMA_BASE_URL=http://localhost:11434/v1
```

---

## 📈 监控指标

### 建议监控的指标

1. **API 调用频率**
   - 每分钟请求数
   - 速率限制触发次数
   - 平均响应时间

2. **批量上传性能**
   - 批次处理时间
   - 成功率
   - 失败率

3. **Embedding 服务性能**
   - Ollama 服务响应时间
   - 向量化任务队列长度
   - 资源使用率（CPU/内存）

---

## 🚨 故障排查

### 问题 1：频繁收到 `RATE_LIMIT_EXCEEDED` 错误

**可能原因：**
- 请求频率过高
- 时间窗口内请求数超过限制

**解决方法：**
1. 降低请求频率
2. 增加请求间隔
3. 使用批量上传减少请求次数
4. 联系管理员调整 `RATE_LIMIT_DOCS` 配置

### 问题 2：批量上传超时

**可能原因：**
- 批次过大
- 单个文档内容过大
- 并发处理过多

**解决方法：**
1. 减小批次大小
2. 检查单个文档内容大小
3. 分批处理大量文档

### 问题 3：Embedding 服务响应慢

**可能原因：**
- Ollama 服务压力过大
- 输入文本过长
- 资源不足

**解决方法：**
1. 降低向量化任务触发频率
2. 确保输入文本不超过 3000 字符
3. 检查 Ollama 服务资源使用情况
4. 考虑增加 Ollama 服务资源

---

## 📝 总结

**关键限制汇总：**

| 限制类型 | 限制值 | 可配置 | 说明 |
|---------|--------|--------|------|
| API 调用频率 | 100 次/分钟 | ✅ | 通过 `RATE_LIMIT_DOCS` 配置 |
| 批量上传大小 | 100 条/批次 | ✅ | 通过 `MAX_BATCH_SIZE` 配置 |
| 并发处理数 | 10 个 | ❌ | 代码中硬编码 |
| 请求体大小 | 10MB | ❌ | Fastify 配置 |
| 文档内容长度 | 100-2000 字符 | ❌ | 验证器限制 |
| Embedding 输入长度 | 3000 字符 | ❌ | Ollama 客户端限制 |

**最佳实践：**
1. ✅ 控制请求频率，留出安全余量
2. ✅ 合理设置批次大小（20-50 条/批次）
3. ✅ 确保文档内容在限制范围内
4. ✅ 监控服务性能，及时调整策略
5. ✅ 实现错误重试机制，处理临时限制

---

## 🔗 相关文档

- [DriveQuiz API README](./README.md)
- [接口联调文档](../../增加模块研发文档/Datapull协同API项目研发/🔌%20DriveQuiz%20API%20接口联调文档%20v1.1.md)
- [环境变量配置](./ENV_SETUP.md)

