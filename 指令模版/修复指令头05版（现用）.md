📌【指令头 v5.0 — 全系统研发规范 · 统一执行机制】

（适用于所有 Cursor 任务 · 不含任何业务内容 · 可直接复制）

⚠️ 使用方法：
你只需要在每次任务开头粘贴本段，后面再写任务内容即可。
⚠️ 本文件允许你自行定制：仅限修改“规范文件路径”与“结构文件路径”。
⚠️ 本文件本身不包含任务内容，全是执行规则。

🔒 ① 必读的规范文件（强制 · 不可跳过）

Cursor 在执行任何任务前，必须先阅读以下文档：

【核心架构规范】（必须遵守 · 不得忽略）

/Users/leo/Desktop/drivequiz研发规范/🧩 AI 服务研发规范（ai-service 统一架构规范 v1.0）.md

/Users/leo/Desktop/drivequiz研发规范/🧩 AI 核心服务规范（ai-core 统一架构规范 v2.0）.md

【数据库结构文档】（涉及字段/表更新必须同步）

/Users/leo/Desktop/drivequiz研发规范/数据库结构_DRIVEQUIZ.md

/Users/leo/Desktop/drivequiz研发规范/数据库结构_AI_SERVICE.md

【文件结构文档】（文件增删需同步更新）

/Users/leo/Desktop/drivequiz研发规范/文件结构.md

引用文档来源：
DriveQuiz 架构与数据库来自：

最新系统架构来自：


🟥 ② 执行前置：必须先输出「规范对齐检查摘要」

每次执行任何任务前，你必须先输出 5–8 行的简短摘要，包含：

🔍 已阅读所有规范文件（路径需列出）

📘 本任务会受哪些规范约束（A、B、C、D 具体条款编号）

📌 哪些条款与本任务强关联（如 A1、A2、B1、C1）

📁 本次任务会影响哪些文件路径（只列路径，不描述内容）

⚠️ 没有这段摘要 = 任务自动失败

🧱 ③ 全局「红线规范」机制（不可违反 · 违反即失败）
🔴 A. 架构红线
编号	规则
A1	路由层禁止承载业务逻辑（业务逻辑必须在工具层 / service 层）
A2	所有核心逻辑必须写入 ai-core（如属 AI 功能）
A3	ai-service 与 local-ai-service 行为必须保持完全一致
A4	接口参数、返回结构必须保持统一（BFF / Next.js 代理 / ai-service）
🔴 B. 数据库 & 文件结构红线
编号	规则
B1	任何数据库字段、表结构、索引的修改必须同步更新数据库结构文档
B2	所有文件新增、删除、迁移必须同步更新 docs/研发规范/文件结构.md
B3	所有 Kysely 类型定义必须与数据库结构同步保持一致
B4	DriveQuiz 主库与 AI Service 库的 schema 需保持文档同步，不可自建“隐形字段”
🔴 C. 测试红线（AI 调用必须双环境测试）
编号	规则
C1	涉及 AI 功能必须同时测试：local-ai-service & 远程 ai-service
C2	必须输出测试日志摘要（请求、响应、耗时、错误）
C3	若测试失败，必须主动继续排查，不得要求用户手动重试
🔴 D. 执行报告红线（最终必须输出）
编号	规则
D1	任务结束必须按模板输出完整执行报告
D2	必须逐条对照 A1–D2，标注“已遵守 / 不适用 / 必须修复”
🛠 ④ 若涉及数据库迁移（必写）

必须在「执行报告」中包含以下内容：

迁移脚本名称（如：20250210_add_xxx.sql）

作用的数据库：DriveQuiz / AI Service

变更项（字段、新表、索引）

同步更新(更新时同步更新“生成时间”和“版本号”)：

docs/研发规范/数据库结构_DRIVEQUIZ.md

docs/研发规范/数据库结构_AI_SERVICE.md

🗂 ⑤ 若涉及文件结构变更（必写）

必须同步更新(更新时同步更新“生成时间”和“版本号”)：

docs/研发规范/文件结构.md

并在「执行报告」列出：

新增文件

删除文件

路径变更

目录调整

🧪 ⑥ 若任务需要脚本 / 测试（必写）

Cursor 必须自动：

自动执行脚本

自动生成测试日志

自动汇总结果

测试失败必须自动继续排查，不允许要求我手动运行

「执行报告」必须包含：

执行命令

执行日志

成果摘要

📑 ⑦ 最终输出必须包含「执行报告」（固定模板）

路径格式：

docs/问题修复/<问题文件夹>/执行报告/<任务名>_执行报告.md


执行报告必须包括：

任务摘要

修改文件列表

逐条红线规范自检（A1–D2）

测试结果（local + remote）

迁移脚本（如有）

更新后的文档（如数据库结构、文件结构等）

风险点与下一步建议

🎯 优化说明（新增内容）

相比你的 v4.0，我额外强化了以下关键能力：

✅（新增）数据库规范全面加强

增加 B3：Kysely 类型一致性

增加 B4：主库 & AI 库 schema 必须文档同步

明确表结构修改必须同步两份文档

✅（新增）文件结构规范更严格

确保 no ghost file、no orphan file

✅（新增）测试规范升级

直接要求“必须双环境测试：local-ai-service + ai-service（Render）”

✅（新增）执行报告内容强化

要求列出所有影响的文件 & 部署影响

✅（新增）完全符合你的 BFF + 多服务 + 多数据库体系（见上传架构文档）