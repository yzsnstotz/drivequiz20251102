# 🧭 当前研发进度与衔接说明 v1.8

## 一、总体状态
- 当前版本：v1.8.0（核心功能补完完成，包含日志落库、成本估算、RAG 向量化、健康检查、Dockerfile 与测试脚本）
- 当前负责人窗口：Cursor
- 最新更新时间：2025-01-15 20:30:00
- 当前阶段目标：执行数据库迁移、配置环境变量、部署到 Render 和 Vercel、运行集成测试验证
- 当前状态标签：✅ 开发完成，等待部署验证

---

## 二、模块进度
| 模块 | 状态 | 负责人 | 下一步行动 |
|------|------|----------|-------------|
| /apps/ai-service/src/index.ts | ✅ 已完成 | Cursor | 已添加 /healthz 和 /readyz 健康检查端点 |
| /apps/ai-service/src/routes/ask.ts | ✅ 已完成 | Cursor | 已接入 logAiInteraction，成本估算已实现，响应结构已对齐规范 |
| /apps/ai-service/src/lib/dbLogger.ts | ✅ 已完成 | Cursor | 已导出 logAiInteraction，字段对齐 ai_logs 表 |
| /apps/ai-service/src/routes/admin/daily-summary.ts | ✅ 已完成 | Cursor | 已接入缓存读取，缓存空时返回正确结构 |
| /apps/ai-service/src/routes/admin/ragIngest.ts | ✅ 已完成 | Cursor | 新建：RAG 向量化入口（分片→嵌入→批量写入） |
| /apps/ai-service/src/lib/rag.ts | ✅ 已完成 | Cursor | 已导出 ragSearch 函数和 SourceRef 类型 |
| /apps/web/app/api/ai/chat/route.ts | ✅ 已完成 | Cursor | 确保日志落库，统一错误码 |
| /apps/web/app/api/admin/ai/rag/docs/route.ts | ✅ 已完成 | Cursor | 已返回 docId/version/chunks，异步向量化通知已实现 |
| /apps/ai-service/Dockerfile | ✅ 已完成 | Cursor | 新建：Node 20 Alpine，多阶段构建 |
| /scripts/smoke-ai.sh | ✅ 已完成 | Cursor | 已更新为 13 个测试用例，包含健康检查验证 |
| /apps/ai-service/src/lib/cache.ts | ✅ 已完成 | O1-BE | 无需修改 |
| /apps/ai-service/src/lib/openaiClient.ts | ✅ 已完成 | O1-BE | 无需修改 |
| /apps/ai-service/src/lib/safety.ts | ✅ 已完成 | O1-BE | 无需修改 |
| /apps/ai-service/src/lib/logger.ts | ✅ 已完成 | O1-BE | 提供结构化日志功能 |
| /apps/ai-service/src/middlewares/auth.ts | ✅ 已完成 | O1-BE | 无需修改 |
| /apps/ai-service/src/tasks/dailySummarize.ts | ✅ 已完成 | O1-BE | 已实现完整逻辑 |
| /apps/ai-service/src/jobs/cron.dailySummarize.ts | ✅ 已完成 | O1-BE | 已注册到 index.ts，定时任务已就绪 |
| /apps/web/app/api/ai/ask/route.ts | ✅ 已完成 | O1-FE | 等待 AI-Service 联调测试 |
| /apps/web/app/api/admin/ai/logs/route.ts | ✅ 已完成 | O1-FE | 等待数据库迁移执行后验证 |
| /apps/web/app/api/admin/ai/summary/route.ts | ✅ 已完成 | O1-FE | 等待 AI-Service 缓存数据就绪 |
| /apps/web/app/api/admin/ai/filters/route.ts | ✅ 已完成 | O1-FE | 等待数据库迁移执行后验证 |
| /src/app/api/ai/chat/route.ts | ✅ 已完成 | O1-FE | 已实现，直接调用 OpenAI |
| /src/components/AIPage.tsx | ✅ 已完成 | O1-FE | 已集成 /api/ai/chat，交互逻辑完整 |
| /apps/web/app/admin/ai-monitor/page.tsx | ✅ 已完成 | O1-FE | 已包含日期选择和错误处理 |
| **数据库迁移脚本** | ✅ 已完成 | Cursor | 执行迁移脚本（Supabase SQL Editor） |
| **环境变量配置文档** | ✅ 已完成 | Cursor | 在 Vercel 和 Render 中配置环境变量 |
| **Render 部署配置** | ✅ 已完成 | Cursor | 新增 render.yaml，包含 Web 服务和 Cron 作业 |
| **集成测试脚本** | ✅ 已完成 | Cursor | 执行 smoke-ai.sh 验证所有路由 |

---

## 三、接口状态
| 接口 | 状态 | 测试 | 备注 |
|------|------|------|------|
| POST /v1/ask | ✅ 已完成 | ⏳ 待集成测试 | AI-Service 核心路由已实现，日志落库功能已接入，成本估算已实现 |
| POST /api/ai/ask | ✅ 已完成 | ⏳ 待集成测试 | 主站 API 路由已实现（转发到 AI-Service），待联调验证 |
| POST /api/ai/chat | ✅ 已完成 | ⏳ 待集成测试 | 主站 API 路由已实现（直接调用 OpenAI），AIPage 已集成 |
| GET /v1/admin/daily-summary | ✅ 已完成 | ⏳ 待缓存数据就绪 | AI-Service Admin 摘要 API 已实现，缓存读取已接入 |
| POST /v1/admin/rag/ingest | ✅ 已完成 | ⏳ 待集成测试 | RAG 向量化入口，接收 docId/title/url/content/version，执行分片→嵌入→写入 |
| GET /api/admin/ai/logs | ✅ 已完成 | ⏳ 待数据库迁移执行 | 路由已实现，数据库迁移脚本已完成，等待执行迁移 |
| GET /api/admin/ai/summary | ✅ 已完成 | ⏳ 待上游数据就绪 | 主站 Admin 摘要 API 已实现（转发到 AI-Service） |
| GET /api/admin/ai/filters | ✅ 已完成 | ⏳ 待数据库迁移执行 | 路由已实现（GET/POST），数据库迁移脚本已完成，等待执行迁移 |
| POST /api/admin/ai/filters | ✅ 已完成 | ⏳ 待数据库迁移执行 | 路由已实现，数据库迁移脚本已完成，等待执行迁移 |
| GET /api/admin/ai/rag/docs | ✅ 已完成 | ⏳ 待数据库迁移执行 | 路由已实现（支持分页、搜索、过滤），数据库迁移脚本已完成，等待执行迁移 |
| POST /api/admin/ai/rag/docs | ✅ 已完成 | ⏳ 待数据库迁移执行 | 路由已实现，返回 docId/version/chunks，异步向量化通知已实现 |
| GET /healthz | ✅ 已完成 | ⏳ 待部署验证 | Render 健康检查端点，返回 200 OK |
| GET /readyz | ✅ 已完成 | ⏳ 待部署验证 | 依赖可用性检查端点（OpenAI Key、Supabase 连通、RPC 可用性），返回 200 OK 或 503 |
| GET /health | ✅ 已完成 | ⏳ 待部署验证 | 向后兼容健康检查端点 |

---

## 四、数据库迁移进度
| 表名 | 状态 | 说明 |
|------|------|------|
| ai_logs | ✅ 脚本已完成 | 迁移脚本已创建（`src/migrations/20250115_create_ai_tables.sql`），等待在 Supabase SQL Editor 中执行 |
| ai_filters | ✅ 脚本已完成 | 迁移脚本已创建（`src/migrations/20250115_create_ai_tables.sql`），等待在 Supabase SQL Editor 中执行 |
| ai_rag_docs | ✅ 脚本已完成 | 迁移脚本已创建（`src/migrations/20250115_create_ai_tables.sql`），等待在 Supabase SQL Editor 中执行 |
| ai_daily_summary | ✅ 脚本已完成 | 迁移脚本已创建（`src/migrations/20250115_create_ai_tables.sql`），等待在 Supabase SQL Editor 中执行 |
| ai_vectors | ✅ 脚本已完成 | 迁移脚本已创建（`src/migrations/20250115_create_ai_tables.sql`），需 pgvector 扩展支持，等待在 Supabase SQL Editor 中执行 |
| match_documents RPC | ✅ 脚本已完成 | RPC 函数脚本已创建（`src/migrations/20250115_create_match_documents_rpc.sql`），需 pgvector 扩展支持，等待在 Supabase SQL Editor 中执行 |

**迁移脚本位置**:
- `src/migrations/20250115_create_ai_tables.sql` - 创建 5 个表（ai_logs, ai_filters, ai_rag_docs, ai_daily_summary, ai_vectors）
- `src/migrations/20250115_create_match_documents_rpc.sql` - 创建 match_documents RPC 函数

**执行步骤**:
1. 在 Supabase SQL Editor 中执行 `20250115_create_ai_tables.sql`
2. 确保 pgvector 扩展已启用
3. 在 Supabase SQL Editor 中执行 `20250115_create_match_documents_rpc.sql`

---

## 五、测试与部署状态
- ✅ **数据库迁移脚本**：已完成（5 个表 + RPC 函数）
- ✅ **环境变量配置文档**：已完成（`docs/AI_ENV_SETUP.md`）
- ✅ **集成测试脚本**：已完成（`scripts/smoke-ai.sh`，包含 13 个测试用例）
- ✅ **日志落库功能**：代码已完成（`apps/ai-service/src/lib/dbLogger.ts` 导出 `logAiInteraction`），等待数据库迁移后验证
- ✅ **成本估算功能**：代码已完成（`apps/ai-service/src/routes/ask.ts` 中实现 `estimateCostUsd`），基于 OpenAI 定价模型
- ✅ **RAG 向量化功能**：代码已完成（`apps/ai-service/src/routes/admin/ragIngest.ts`），支持分片→嵌入→批量写入
- ✅ **缓存读取功能**：代码已完成（`apps/ai-service/src/routes/admin/daily-summary.ts`），缓存空时返回正确结构
- ✅ **健康检查端点**：代码已完成（`apps/ai-service/src/index.ts`），包含 `/healthz` 和 `/readyz`
- ✅ **Dockerfile**：已完成（`apps/ai-service/Dockerfile`），基于 Node 20 Alpine
- ⏳ 本地运行测试待进行（需验证主站与 AI-Service 联调）
- ⏳ AIPage 组件与 /api/ai/chat 联调测试待进行
- ⏳ 数据库迁移执行待进行（在 Supabase SQL Editor 中执行迁移脚本）
- ⏳ /api/admin/ai/logs 路由测试待进行（需先执行数据库迁移）
- ⏳ /api/admin/ai/filters 路由测试待进行（需先执行数据库迁移）
- ⏳ /api/admin/ai/rag/docs 路由测试待进行（需先执行数据库迁移）
- ⏳ /v1/admin/daily-summary 接口测试待进行（需缓存数据就绪）
- ⏳ 环境变量配置验证待进行（在 Vercel 和 Render 中配置）
- ⏳ 集成测试执行待进行（运行 `smoke-ai.sh` 脚本）
- ⏳ Render 部署待进行（使用 render.yaml）
- ⏳ Vercel 部署待进行（主站部署）
- ⏳ Supabase 向量化验证待配置（RPC 函数 match_documents 脚本已完成，等待执行）
- 💤 单元测试待编写
- 💤 集成测试自动化待编写（smoke-ai.sh 已创建，等待执行）

---

## 六、当前项目整体文件结构（用以做比对）
### AI-Service 模块（/apps/ai-service）
- src/index.ts - Fastify 服务器入口，配置加载与路由注册，已注册定时任务，已添加 /healthz 和 /readyz 健康检查端点
- src/routes/ask.ts - `/v1/ask` 核心路由（安全检测、RAG、缓存、OpenAI 调用、日志落库、成本估算）
- src/routes/admin/daily-summary.ts - `/v1/admin/daily-summary` Admin 摘要 API（已接入缓存读取）
- src/routes/admin/ragIngest.ts - `/v1/admin/rag/ingest` RAG 向量化入口（新建：分片→嵌入→批量写入）
- src/lib/rag.ts - RAG 检索模块（Supabase Vector 调用，已导出 ragSearch 函数和 SourceRef 类型）
- src/lib/cache.ts - LRU 缓存层（内存实现）
- src/lib/safety.ts - 内容安全检查模块
- src/lib/openaiClient.ts - OpenAI 客户端封装
- src/lib/dbLogger.ts - ai_logs 数据库写入封装（Supabase REST API，导出 logAiInteraction，失败仅告警）
- src/lib/logger.ts - 结构化日志模块（提供 logAiEvent）
- src/tasks/dailySummarize.ts - 每日汇总任务实现（完整逻辑）
- src/jobs/cron.dailySummarize.ts - 定时任务注册（已接入 index.ts）
- src/middlewares/auth.ts - 服务间鉴权中间件
- Dockerfile - Docker 构建文件（新建：Node 20 Alpine，多阶段构建）

### 主站 API 路由（/apps/web/app/api）
- /api/ai/ask/route.ts - 转发到 AI-Service 的主站路由
- /api/ai/chat/route.ts - 直接调用 OpenAI 的聊天路由（已确保日志落库，统一错误码）
- /api/admin/ai/logs/route.ts - Admin 日志查询路由（已完成，数据库迁移脚本已完成）
- /api/admin/ai/summary/route.ts - Admin 摘要查询路由（已完成，转发到 AI-Service）
- /api/admin/ai/filters/route.ts - Admin 过滤规则管理路由（已完成，GET/POST，数据库迁移脚本已完成）
- /api/admin/ai/rag/docs/route.ts - Admin RAG 文档管理路由（已完成，GET/POST，支持分页、搜索、过滤，返回 docId/version/chunks，异步向量化通知已实现）

### 主站 API 路由（/src/app/api）
- /api/ai/chat/route.ts - 直接调用 OpenAI 的聊天路由

### 前端组件（/src/components）
- AIPage.tsx - AI 问答页面组件（已集成 /api/ai/chat）

### Admin 监控页面（/apps/web/app/admin）
- /admin/ai-monitor/page.tsx - AI 运行监控页面（已包含日期选择和错误处理，环境变量配置文档已更新：`docs/AI_ENV_SETUP.md`）

### 数据库迁移脚本（/src/migrations）
- 20250115_create_ai_tables.sql - 创建 5 个 AI 相关表（ai_logs, ai_filters, ai_rag_docs, ai_daily_summary, ai_vectors）
- 20250115_create_match_documents_rpc.sql - 创建 match_documents RPC 函数（向量相似度检索）

### 配置与文档（/docs）
- AI_ENV_SETUP.md - AI 问答模块环境变量配置指南（主站 + AI-Service 环境变量清单、配置步骤、验证方法、常见问题）

### 测试脚本（/scripts）
- smoke-ai.sh - AI 问答模块集成测试脚本（Render 版，包含主站和 AI-Service 路由测试）

### 部署配置（项目根目录）
- render.yaml - Render 部署配置文件（包含 Web 服务和 Cron 作业配置）

### 工作报告（项目根目录）
- AI_COMPLETION_REPORT.md - AI 问答模块补完任务报告（包含 A1-A6 和 B1-B4 任务详情）
- AI_DATABASE_MIGRATION_REPORT.md - 数据库迁移与集成测试工作报告（任务概览、已完成任务详情、执行步骤、验证清单）

---

## 七、下阶段任务（Next Steps）
1. [ ] **执行数据库迁移**：在 Supabase SQL Editor 中执行 `20250115_create_ai_tables.sql` 和 `20250115_create_match_documents_rpc.sql`（高优先级，阻塞多个 API 路由测试）
2. [ ] **配置环境变量**：根据 `docs/AI_ENV_SETUP.md` 在 Vercel 和 Render 中配置所有必需的环境变量（高优先级，阻塞服务启动）
3. [ ] **部署 AI-Service（Render）**：使用 render.yaml 部署到 Render，配置健康检查 `/healthz`，验证 `/readyz` 返回 200（高优先级）
4. [ ] **部署主站（Vercel）**：在 Vercel Dashboard 连接 GitHub 仓库，配置环境变量，部署并验证（高优先级）
5. [ ] **执行集成测试**：运行 `scripts/smoke-ai.sh` 验证所有路由（高优先级，验证系统功能）
6. [ ] **验证日志落库功能**：确认 ask.ts 和 chat/route.ts 中的日志落库功能正常工作（需先执行数据库迁移）（高优先级）
7. [ ] **验证成本估算功能**：确认 `/v1/ask` 返回的 `costEstimate` 字段包含正确的 `approxUsd`（高优先级）
8. [ ] **验证 RAG 向量化功能**：通过 `/api/admin/ai/rag/docs` POST 创建文档，验证 `/v1/admin/rag/ingest` 自动向量化（高优先级）
9. [ ] **验证缓存读取功能**：确认 `/v1/admin/daily-summary` 能从缓存读取或返回正确空结构（中优先级）
10. [ ] **验证 Supabase RPC 函数**：确认 match_documents 函数在 Supabase 中正常工作（中优先级）
11. [ ] **AIPage 组件与 /api/ai/chat 联调测试**：验证前端组件与后端 API 端到端流程（高优先级）
12. [ ] **AI-Service 与主站联调测试**：验证 /api/ai/ask 调用 /v1/ask 端到端流程（高优先级）
13. [ ] **Admin API 路由集成测试**：验证 filters、rag/docs 路由与数据库表的端到端流程（高优先级）
14. [ ] **Admin 监控页面集成测试**：验证 /api/admin/ai/summary 与监控页面的端到端流程（中优先级）
15. [ ] **验证定时任务执行**：确认 dailySummarize 定时任务正常运行并生成缓存数据（中优先级）

---

## 八、衔接说明
- **上一个开发窗口**：Cursor（v1.7 代码与脚本全部完成，等待执行阶段）
- **当前执行窗口**：Cursor（v1.8 核心功能补完完成，包括日志落库、成本估算、RAG 向量化、健康检查、Dockerfile、测试脚本）
- **下一步衔接窗口**：Cursor / O1（执行数据库迁移、配置环境变量、部署到 Render 和 Vercel、运行集成测试）
- 所有任务均需遵守《研发规范 v1.0》与《接口与命名规范 v1.0》

**v1.8 版本更新要点：**
- ✅ 完成日志落库统一入口（`logAiInteraction` 函数）
- ✅ 完成成本估算功能（基于 OpenAI 定价模型）
- ✅ 完成 RAG 向量化入口（`/v1/admin/rag/ingest` 路由）
- ✅ 完成 Admin 摘要缓存读取（已接入 `cache.get`）
- ✅ 完成健康检查端点（`/healthz` 和 `/readyz`）
- ✅ 完成 Dockerfile（Node 20 Alpine，多阶段构建）
- ✅ 完成测试脚本更新（Render 版）
- ✅ 完成响应结构对齐规范（所有接口统一格式）
- ✅ 完成 Render 部署配置（render.yaml）
- ✅ 平台从 Railway 切换为 Render，新增 `render.yaml`，冒烟脚本已更新
- ✅ 提升版本号至 v1.8.0
- 📋 当前阶段：开发完成，等待部署验证

**已完成的核心功能：**
- ✅ AI-Service 项目结构（Fastify）
- ✅ `/v1/ask` 核心路由逻辑（安全检测、RAG、缓存、OpenAI 调用、日志落库、成本估算）
- ✅ LRU 缓存层（内存实现）
- ✅ 内容安全检查模块（本地规则）
- ✅ OpenAI 客户端封装
- ✅ RAG 检索模块（Supabase Vector 调用，已导出 `ragSearch` 函数）
- ✅ 日志落库功能（`dbLogger.ts` 导出 `logAiInteraction`，`ask.ts` 中已接入）
- ✅ 成本估算功能（基于 OpenAI 定价模型，计算 `approxUsd`）
- ✅ RAG 向量化功能（分片→嵌入→批量写入 `ai_vectors`）
- ✅ 结构化日志模块（`logger.ts` 提供 logAiEvent）
- ✅ `/api/ai/ask` 主站 API 路由（JWT 验证、配额、转发到 AI-Service）
- ✅ `/api/ai/chat` 主站 API 路由（JWT 验证、直接调用 OpenAI、日志落库）
- ✅ dailySummarize 任务实现（完整逻辑）
- ✅ dailySummarize 定时任务注册（已接入 index.ts）
- ✅ `/v1/admin/daily-summary` AI-Service Admin 摘要 API（已接入缓存读取）
- ✅ `/v1/admin/rag/ingest` AI-Service RAG 向量化入口（新建）
- ✅ `/api/admin/ai/summary` 主站 Admin 摘要 API（已完成）
- ✅ `/api/admin/ai/logs` 主站 Admin 日志查询 API（已完成，数据库迁移脚本已完成）
- ✅ `/api/admin/ai/filters` 主站 Admin 过滤规则管理 API（已完成，GET/POST，数据库迁移脚本已完成）
- ✅ `/api/admin/ai/rag/docs` 主站 Admin RAG 文档管理 API（已完成，GET/POST，支持分页、搜索、过滤，返回 docId/version/chunks，异步向量化通知已实现）
- ✅ AIPage 完整 UI 组件（已集成 /api/ai/chat，包含完整交互逻辑）
- ✅ Admin AI 监控页面（/apps/web/app/admin/ai-monitor，已包含日期选择和错误处理）
- ✅ **数据库迁移脚本**（5 个表 + RPC 函数）
- ✅ **环境变量配置文档**（主站 + AI-Service 完整配置指南）
- ✅ **集成测试脚本**（13 个测试用例的自动化脚本）
- ✅ **Dockerfile**（Node 20 Alpine，多阶段构建）
- ✅ **健康检查端点**（`/healthz` 和 `/readyz`）

**待完成的关键任务：**
- 🔧 **执行数据库迁移**：在 Supabase SQL Editor 中执行迁移脚本（高优先级，阻塞多个 API 路由测试）
- 🔧 **配置环境变量**：在 Vercel 和 Render 中配置所有必需的环境变量（高优先级，阻塞服务启动）
- 🔧 **部署 AI-Service（Render）**：使用 render.yaml 部署，配置健康检查（高优先级）
- 🔧 **部署主站（Vercel）**：部署并配置环境变量（高优先级）
- 🔧 **执行集成测试**：运行 `smoke-ai.sh` 验证所有路由（高优先级，验证系统功能）
- 🔧 验证日志落库功能（需先执行数据库迁移）（高优先级）
- 🔧 验证成本估算功能（高优先级）
- 🔧 验证 RAG 向量化功能（高优先级）
- 🔧 AIPage 与 /api/ai/chat 联调测试（高优先级）
- 🔧 AI-Service 与主站联调测试（高优先级）
- 🔧 Admin API 路由集成测试（filters、rag/docs 路由与数据库表）（高优先级）

**已知问题与注意事项：**
- ✅ `/apps/web/app/api/admin/ai/filters/route.ts`：已修复 TypeScript 编译错误，已修复 `withAdminAuth` 用法、数据库查询方法、错误响应函数参数使用、事务插入操作
- ✅ `/apps/web/app/api/admin/ai/rag/docs/route.ts`：已修复 TypeScript 编译错误，已修复 `SORT_WHITELIST` 类型定义、`fn.countAll()` 泛型参数使用、`getPaginationMeta()` 参数使用方式，已实现返回 docId/version/chunks 和异步向量化通知
- ✅ `/apps/ai-service/src/routes/ask.ts`：已修复 `getRagContext` 传参问题，日志落库功能已接入，成本估算已实现，响应结构已对齐规范
- ✅ `/apps/ai-service/src/lib/dbLogger.ts`：已导出 `logAiInteraction` 函数，字段对齐 ai_logs 表
- ✅ `/apps/ai-service/src/routes/admin/daily-summary.ts`：已接入缓存读取，缓存空时返回 `{ ok: true, data: {}, note: "no_cached_summary" }`
- ✅ `/apps/ai-service/src/routes/admin/ragIngest.ts`：新建路由，实现 RAG 向量化流程（分片→嵌入→批量写入）
- ✅ `/apps/ai-service/src/lib/rag.ts`：已导出 `ragSearch` 函数和 `SourceRef` 类型
- ✅ `/apps/ai-service/src/index.ts`：已添加 `/healthz` 和 `/readyz` 健康检查端点
- ✅ `/apps/ai-service/Dockerfile`：新建 Dockerfile，基于 Node 20 Alpine
- ✅ `/scripts/smoke-ai.sh`：已更新为 13 个测试用例，包含健康检查验证
- ✅ `/apps/web/app/api/ai/chat/route.ts`：已确保日志落库，统一错误码
- ✅ `/apps/web/app/api/ai/ask/route.ts`：已实现完整的 JWT 验证、配额管理与错误处理
- ✅ `/src/app/api/ai/chat/route.ts`：已实现完整的 JWT 验证、安全审查与 OpenAI 调用
- ✅ `/src/components/AIPage.tsx`：已实现完整的 UI 交互，调用 `/api/ai/chat` 路由
- ✅ `/apps/web/app/admin/ai-monitor/page.tsx`：已实现完整监控页面，已包含日期选择和错误处理，环境变量配置文档已更新（`docs/AI_ENV_SETUP.md`）
- ✅ `/apps/web/app/api/admin/ai/logs/route.ts`：已实现日志查询路由，数据库迁移脚本已完成（`src/migrations/20250115_create_ai_tables.sql`）
- ✅ `/apps/web/app/api/admin/ai/summary/route.ts`：已实现摘要查询路由，转发到 AI-Service
- ✅ `/apps/web/app/api/admin/ai/filters/route.ts`：已实现过滤规则管理路由（GET/POST），数据库迁移脚本已完成（`src/migrations/20250115_create_ai_tables.sql`）
- ✅ `/apps/web/app/api/admin/ai/rag/docs/route.ts`：已实现 RAG 文档管理路由（GET/POST），数据库迁移脚本已完成（`src/migrations/20250115_create_ai_tables.sql`），已实现返回 docId/version/chunks 和异步向量化通知
- ✅ `/apps/ai-service/src/jobs/cron.dailySummarize.ts`：定时任务已注册，等待验证执行
- ✅ **数据库迁移脚本**：已完成 5 个表的迁移脚本（`src/migrations/20250115_create_ai_tables.sql`）和 RPC 函数脚本（`src/migrations/20250115_create_match_documents_rpc.sql`），等待在 Supabase SQL Editor 中执行
- ✅ **环境变量配置文档**：已完成详细的配置文档（`docs/AI_ENV_SETUP.md`），包含主站和 AI-Service 的环境变量清单、配置步骤、验证方法和常见问题
- ✅ **集成测试脚本**：已完成自动化测试脚本（`scripts/smoke-ai.sh`），包含 13 个测试用例，支持彩色输出和详细日志记录
- ⚠️ **双路由架构**：当前存在 `/api/ai/ask`（转发到 AI-Service）和 `/api/ai/chat`（直接调用 OpenAI）两个路由，AIPage 使用 `/api/ai/chat`。需明确使用场景或统一架构。
- ⚠️ **数据库迁移执行**：迁移脚本已完成，但需要在 Supabase SQL Editor 中手动执行。执行前需确保 pgvector 扩展已启用（用于 ai_vectors 表和 match_documents 函数）。
- ⚠️ **环境变量配置**：环境变量配置文档已完成，但需要在 Vercel 和 Render Dashboard 中手动配置所有必需的环境变量。
- ⚠️ **集成测试执行**：集成测试脚本已完成，但需要先完成数据库迁移和环境变量配置后才能执行测试。
- ⚠️ RAG 模块依赖 Supabase RPC 函数 `match_documents`，RPC 函数脚本已创建（`src/migrations/20250115_create_match_documents_rpc.sql`），等待在 Supabase SQL Editor 中执行
- ⚠️ 当前缓存使用内存 LRU，生产环境建议扩展为 Redis
- ⚠️ 主站 API 路由与 AI-Service 联调待验证，需确保环境变量配置正确
- ⚠️ **类型安全**：由于 `ai_filters` 和 `ai_rag_docs` 表不在 Database 接口中，使用了 `(db as any)` 类型断言。建议后续将这些表添加到 `src/lib/db.ts` 的 Database 接口中。

---

> _此文档由 Cursor 自动生成，用于保持 ZALEM 项目研发接力的上下文连续性。_

