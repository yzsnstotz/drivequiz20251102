# 🧭 当前研发进度与衔接说明 v1.5

## 一、总体状态
- 当前版本：v1.5.0（Admin API 路由完成，准备数据库迁移与集成测试）
- 当前负责人窗口：Cursor
- 最新更新时间：2025-11-03 16:58:49
- 当前阶段目标：完成 Admin AI 管理 API 路由（filters、rag/docs），准备数据库迁移与集成测试
- 当前状态标签：🚧 开发中

---

## 二、模块进度
| 模块 | 状态 | 负责人 | 下一步行动 |
|------|------|----------|-------------|
| /apps/ai-service/src/index.ts | ✅ 已完成 | O1-BE | 无需修改 |
| /apps/ai-service/src/routes/ask.ts | ✅ 已完成 | O1-BE | 接入日志落库功能 |
| /apps/ai-service/src/lib/rag.ts | ✅ 已完成 | O1-BE | 验证 Supabase RPC 连接 |
| /apps/ai-service/src/lib/cache.ts | ✅ 已完成 | O1-BE | 无需修改 |
| /apps/ai-service/src/lib/openaiClient.ts | ✅ 已完成 | O1-BE | 无需修改 |
| /apps/ai-service/src/lib/safety.ts | ✅ 已完成 | O1-BE | 无需修改 |
| /apps/ai-service/src/middlewares/auth.ts | ✅ 已完成 | O1-BE | 无需修改 |
| /apps/ai-service/src/routes/admin/dailySummary.ts | ✅ 已完成 | O1-BE | 接入缓存读取（当前为占位实现） |
| /apps/ai-service/src/tasks/dailySummarize.ts | ✅ 已完成 | O1-BE | 已实现完整逻辑 |
| /apps/ai-service/src/jobs/cron.dailySummarize.ts | ✅ 已完成 | O1-BE | 已注册到 index.ts，定时任务已就绪 |
| /apps/web/app/api/ai/ask/route.ts | ✅ 已完成 | O1-FE | 等待 AI-Service 联调测试 |
| /apps/web/app/api/admin/ai/logs/route.ts | ✅ 已完成 | O1-FE | 等待 ai_logs 表创建后验证 |
| /apps/web/app/api/admin/ai/summary/route.ts | ✅ 已完成 | O1-FE | 等待 AI-Service 缓存数据就绪 |
| /apps/web/app/api/admin/ai/filters/route.ts | ✅ 已完成 | O1-FE | 等待 ai_filters 表创建后验证 |
| /apps/web/app/api/admin/ai/rag/docs/route.ts | ✅ 已完成 | O1-FE | 等待 ai_rag_docs 表创建后验证 |
| /src/app/api/ai/chat/route.ts | ✅ 已完成 | O1-FE | 已实现，直接调用 OpenAI |
| /src/components/AIPage.tsx | ✅ 已完成 | O1-FE | 已集成 /api/ai/chat，交互逻辑完整 |
| /apps/web/app/admin/ai-monitor/page.tsx | ✅ 已完成 | O1-FE | 配置环境变量验证 |

---

## 三、接口状态
| 接口 | 状态 | 测试 | 备注 |
|------|------|------|------|
| POST /v1/ask | ✅ 已完成 | ⏳ 待集成测试 | AI-Service 核心路由已实现 |
| POST /api/ai/ask | ✅ 已完成 | ⏳ 待集成测试 | 主站 API 路由已实现（转发到 AI-Service），待联调验证 |
| POST /api/ai/chat | ✅ 已完成 | ⏳ 待集成测试 | 主站 API 路由已实现（直接调用 OpenAI），AIPage 已集成 |
| GET /v1/admin/daily-summary | ✅ 已完成 | ⏳ 待缓存数据就绪 | AI-Service Admin 摘要 API 已实现（占位版，等待接入缓存） |
| GET /api/admin/ai/logs | ✅ 已完成 | ⏳ 待数据库表创建 | 路由已实现，等待 ai_logs 表创建后验证 |
| GET /api/admin/ai/summary | ✅ 已完成 | ⏳ 待上游数据就绪 | 主站 Admin 摘要 API 已实现（转发到 AI-Service） |
| GET /api/admin/ai/filters | ✅ 已完成 | ⏳ 待数据库表创建 | 路由已实现（GET/POST），等待 ai_filters 表创建后验证 |
| POST /api/admin/ai/filters | ✅ 已完成 | ⏳ 待数据库表创建 | 路由已实现，等待 ai_filters 表创建后验证 |
| GET /api/admin/ai/rag/docs | ✅ 已完成 | ⏳ 待数据库表创建 | 路由已实现（支持分页、搜索、过滤），等待 ai_rag_docs 表创建后验证 |
| POST /api/admin/ai/rag/docs | ✅ 已完成 | ⏳ 待数据库表创建 | 路由已实现，等待 ai_rag_docs 表创建后验证 |

---

## 四、数据库迁移进度
| 表名 | 状态 | 说明 |
|------|------|------|
| ai_logs | 💤 未建 | 需创建迁移脚本（记录问答调用），/api/admin/ai/logs 路由已准备好 |
| ai_filters | 💤 未建 | 需创建迁移脚本（存储禁答关键词规则），/api/admin/ai/filters 路由已准备好 |
| ai_rag_docs | 💤 未建 | 需创建迁移脚本（存储 RAG 文档元数据），/api/admin/ai/rag/docs 路由已准备好 |
| ai_vectors / ai_docs_embeddings | 💤 未建 | 需创建 Supabase pgvector 表与 RPC 函数 match_documents |
| ai_daily_summary | 💤 未建 | 等 dailySummarize 完成后迁移（当前使用缓存存储） |

---

## 五、测试与部署状态
- ⏳ 本地运行测试待进行（需验证主站与 AI-Service 联调）
- ⏳ AIPage 组件与 /api/ai/chat 联调测试待进行
- ⏳ /api/admin/ai/logs 路由测试待进行（需先创建 ai_logs 表）
- ⏳ /api/admin/ai/filters 路由测试待进行（需先创建 ai_filters 表）
- ⏳ /api/admin/ai/rag/docs 路由测试待进行（需先创建 ai_rag_docs 表）
- ⏳ /v1/admin/daily-summary 接口测试待进行（需缓存数据就绪）
- 💤 Railway 部署配置待创建
- 💤 Supabase 向量化验证待配置（RPC 函数 match_documents 待创建）
- 💤 日志落库功能待实现（ai_logs 表待创建，ask.ts 和 chat/route.ts 需接入）
- 💤 成本估算功能待实现（需扩展 token 统计）
- 💤 单元测试待编写
- 💤 集成测试待编写

---

## 六、当前项目整体文件结构（用以做比对）
### AI-Service 模块（/apps/ai-service）
- src/index.ts - Fastify 服务器入口，配置加载与路由注册，已注册定时任务
- src/routes/ask.ts - `/v1/ask` 核心路由（安全检测、RAG、缓存、OpenAI 调用）
- src/routes/admin/dailySummary.ts - `/v1/admin/daily-summary` Admin 摘要 API（占位版，等待接入缓存）
- src/lib/rag.ts - RAG 检索模块（Supabase Vector 调用）
- src/lib/cache.ts - LRU 缓存层（内存实现）
- src/lib/safety.ts - 内容安全检查模块
- src/lib/openaiClient.ts - OpenAI 客户端封装
- src/tasks/dailySummarize.ts - 每日汇总任务实现（完整逻辑）
- src/jobs/cron.dailySummarize.ts - 定时任务注册（已接入 index.ts）
- src/middlewares/auth.ts - 服务间鉴权中间件

### 主站 API 路由（/apps/web/app/api）
- /api/ai/ask/route.ts - 转发到 AI-Service 的主站路由
- /api/admin/ai/logs/route.ts - Admin 日志查询路由（已完成，等待 ai_logs 表）
- /api/admin/ai/summary/route.ts - Admin 摘要查询路由（已完成，转发到 AI-Service）
- /api/admin/ai/filters/route.ts - Admin 过滤规则管理路由（已完成，GET/POST，等待 ai_filters 表）
- /api/admin/ai/rag/docs/route.ts - Admin RAG 文档管理路由（已完成，GET/POST，支持分页、搜索、过滤，等待 ai_rag_docs 表）

### 主站 API 路由（/src/app/api）
- /api/ai/chat/route.ts - 直接调用 OpenAI 的聊天路由

### 前端组件（/src/components）
- AIPage.tsx - AI 问答页面组件（已集成 /api/ai/chat）

### Admin 监控页面（/apps/web/app/admin）
- /admin/ai-monitor/page.tsx - AI 运行监控页面（需配置 AI_SERVICE_SUMMARY_URL 和 AI_SERVICE_TOKEN）

---

## 七、下阶段任务（Next Steps）
1. [ ] **创建数据库迁移脚本**：ai_logs 表（高优先级，阻塞 /api/admin/ai/logs 测试）
2. [ ] **创建数据库迁移脚本**：ai_filters 表（高优先级，阻塞 /api/admin/ai/filters 测试）
3. [ ] **创建数据库迁移脚本**：ai_rag_docs 表（高优先级，阻塞 /api/admin/ai/rag/docs 测试）
4. [ ] **实现日志落库功能**：在 ask.ts 和 chat/route.ts 中调用后记录到 ai_logs 表（高优先级）
5. [ ] **接入 Admin 摘要 API 缓存读取**：在 /v1/admin/daily-summary 中接入 cache.get 读取 dailySummarize 生成的数据（中优先级）
6. [ ] **创建 Supabase RPC 函数**：实现 match_documents 函数供 RAG 检索使用（中优先级）
7. [ ] **AIPage 组件与 /api/ai/chat 联调测试**：验证前端组件与后端 API 端到端流程（高优先级）
8. [ ] **AI-Service 与主站联调测试**：验证 /api/ai/ask 调用 /v1/ask 端到端流程（高优先级）
9. [ ] **Admin API 路由集成测试**：验证 filters、rag/docs 路由与数据库表的端到端流程（高优先级）
10. [ ] **Admin 监控页面集成测试**：验证 /api/admin/ai/summary 与监控页面的端到端流程（中优先级）
11. [ ] **创建 ai_vectors / ai_docs_embeddings 数据库表**：支持向量检索（中优先级）
12. [ ] **扩展成本估算**：统计 tokens 并计算费用（中优先级）
13. [ ] **验证定时任务执行**：确认 dailySummarize 定时任务正常运行并生成缓存数据（中优先级）
14. [ ] **编写单元测试与集成测试**：覆盖核心功能（中优先级）
15. [ ] **Railway 部署配置与验证**：创建部署配置文件（低优先级）

---

## 八、衔接说明
- **上一个开发窗口**：Cursor（v1.4 完成 Admin 摘要 API 与定时任务注册，准备集成测试）
- **当前执行窗口**：Cursor（v1.5 完成 Admin 过滤规则与 RAG 文档管理 API，准备数据库迁移）
- **下一步衔接窗口**：Cursor / O1（完成数据库迁移与路由集成测试）
- 所有任务均需遵守《研发规范 v1.0》与《接口与命名规范 v1.0》

**v1.5 版本更新要点：**
- ✅ 完成 `/api/admin/ai/filters` Admin 过滤规则管理 API 路由实现（GET/POST，已修复 TypeScript 错误）
- ✅ 完成 `/api/admin/ai/rag/docs` Admin RAG 文档管理 API 路由实现（GET/POST，支持分页、搜索、过滤、排序，已修复 TypeScript 错误）
- 🔄 提升版本号至 v1.5.0
- 📋 明确下阶段任务优先级（数据库迁移为高优先级，阻塞多个 API 路由测试）

**已完成的核心功能：**
- ✅ AI-Service 项目结构（Fastify）
- ✅ `/v1/ask` 核心路由逻辑（安全检测、RAG、缓存、OpenAI 调用）
- ✅ LRU 缓存层（内存实现）
- ✅ 内容安全检查模块（本地规则）
- ✅ OpenAI 客户端封装
- ✅ RAG 检索模块（Supabase Vector 调用，待验证 RPC 函数）
- ✅ `/api/ai/ask` 主站 API 路由（JWT 验证、配额、转发到 AI-Service）
- ✅ `/api/ai/chat` 主站 API 路由（JWT 验证、直接调用 OpenAI）
- ✅ dailySummarize 任务实现（完整逻辑）
- ✅ dailySummarize 定时任务注册（已接入 index.ts）
- ✅ `/v1/admin/daily-summary` AI-Service Admin 摘要 API（占位版）
- ✅ `/api/admin/ai/summary` 主站 Admin 摘要 API（已完成）
- ✅ `/api/admin/ai/logs` 主站 Admin 日志查询 API（已完成）
- ✅ `/api/admin/ai/filters` 主站 Admin 过滤规则管理 API（已完成，GET/POST）
- ✅ `/api/admin/ai/rag/docs` 主站 Admin RAG 文档管理 API（已完成，GET/POST，支持分页、搜索、过滤、排序）
- ✅ AIPage 完整 UI 组件（已集成 /api/ai/chat，包含完整交互逻辑）
- ✅ Admin AI 监控页面（/apps/web/app/admin/ai-monitor，需配置环境变量）

**待完成的关键任务：**
- 🔧 创建 ai_logs 数据库表（高优先级，阻塞日志查询功能）
- 🔧 创建 ai_filters 数据库表（高优先级，阻塞过滤规则管理功能）
- 🔧 创建 ai_rag_docs 数据库表（高优先级，阻塞 RAG 文档管理功能）
- 🔧 实现日志落库功能（在 ask.ts 和 chat/route.ts 中记录日志）（高优先级）
- 🔧 接入 Admin 摘要 API 缓存读取（在 dailySummary.ts 中接入 cache.get）（中优先级）
- 🔧 AIPage 与 /api/ai/chat 联调测试（高优先级）
- 🔧 AI-Service 与主站联调测试（高优先级）
- 🔧 Admin API 路由集成测试（filters、rag/docs 路由与数据库表）（高优先级）
- 🔧 创建 Supabase RPC 函数 match_documents（中优先级）
- 🔧 验证定时任务执行与缓存数据生成（中优先级）

**已知问题与注意事项：**
- ✅ `/apps/web/app/api/admin/ai/filters/route.ts`：已修复 TypeScript 编译错误（17 个 → 0 个），已修复 `withAdminAuth` 用法、数据库查询方法、错误响应函数参数使用、事务插入操作
- ✅ `/apps/web/app/api/admin/ai/rag/docs/route.ts`：已修复 TypeScript 编译错误（2 个 → 0 个），已修复 `SORT_WHITELIST` 类型定义、`fn.countAll()` 泛型参数使用、`getPaginationMeta()` 参数使用方式
- ✅ `/apps/ai-service/routes/ask.ts`：已修复 `getRagContext` 传参问题
- ✅ `/apps/web/app/api/ai/ask/route.ts`：已实现完整的 JWT 验证、配额管理与错误处理
- ✅ `/src/app/api/ai/chat/route.ts`：已实现完整的 JWT 验证、安全审查与 OpenAI 调用
- ✅ `/src/components/AIPage.tsx`：已实现完整的 UI 交互，调用 `/api/ai/chat` 路由
- ✅ `/apps/web/app/admin/ai-monitor/page.tsx`：已实现完整监控页面，需配置 `AI_SERVICE_SUMMARY_URL` 和 `AI_SERVICE_TOKEN`
- ✅ `/apps/web/app/api/admin/ai/logs/route.ts`：已实现日志查询路由，等待 ai_logs 表创建
- ✅ `/apps/web/app/api/admin/ai/summary/route.ts`：已实现摘要查询路由，转发到 AI-Service
- ✅ `/apps/web/app/api/admin/ai/filters/route.ts`：已实现过滤规则管理路由（GET/POST），等待 ai_filters 表创建
- ✅ `/apps/web/app/api/admin/ai/rag/docs/route.ts`：已实现 RAG 文档管理路由（GET/POST），等待 ai_rag_docs 表创建
- ✅ `/apps/ai-service/src/routes/admin/dailySummary.ts`：已实现占位版，等待接入缓存读取
- ✅ `/apps/ai-service/src/jobs/cron.dailySummarize.ts`：定时任务已注册，等待验证执行
- ⚠️ **双路由架构**：当前存在 `/api/ai/ask`（转发到 AI-Service）和 `/api/ai/chat`（直接调用 OpenAI）两个路由，AIPage 使用 `/api/ai/chat`。需明确使用场景或统一架构。
- ⚠️ RAG 模块依赖 Supabase RPC 函数 `match_documents`，需在 Supabase 中创建该函数
- ⚠️ 当前缓存使用内存 LRU，生产环境建议扩展为 Redis
- ⚠️ 主站 API 路由与 AI-Service 联调待验证，需确保环境变量配置正确
- ⚠️ Admin 摘要 API 当前为占位版，需接入缓存读取 dailySummarize 生成的数据
- ⚠️ 日志落库功能未实现，ask.ts 和 chat/route.ts 需要接入日志记录逻辑
- ⚠️ **数据库表缺失**：ai_logs、ai_filters、ai_rag_docs 表未创建，阻塞多个 Admin API 路由的测试与验证
- ⚠️ 定时任务执行与缓存数据生成待验证，需确认 dailySummarize 正常运行
- ⚠️ **类型安全**：由于 `ai_filters` 和 `ai_rag_docs` 表不在 Database 接口中，使用了 `(db as any)` 类型断言。建议后续将这些表添加到 `src/lib/db.ts` 的 Database 接口中。

---

> _此文档由 Cursor 自动生成，用于保持 ZALEM 项目研发接力的上下文连续性。_

