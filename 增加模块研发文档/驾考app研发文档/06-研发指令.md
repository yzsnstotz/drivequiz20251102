# 🔧 ZALEM 后台管理 · 研发指令包（按文件逐个提交）

## 全局执行规则（研发窗口必须遵守）

1. **一次只提交一个文件**。
2. 研发回复应只有增加/修改，不应有代码审查和具体代码逐行修改的要求
2. 若本次任务涉及**修改现有文件**且你需要现有代码全文，请**立刻向我索要该文件的当前完整代码体**，不得自行假设。
3. **每次输出必须是该文件的完整代码体**，包含全部 import、类型、导出、注释与边界处理。
4. 我确认“通过”后，你再进入**下一文件**。
5. 统一响应格式：成功 `{ ok: true, data, pagination? }`；错误 `{ ok: false, errorCode, message }`（源自统一规范）
6. Kysely 强制规则：禁止嵌套 where、`ILIKE`/时间比较使用 SQL 模板、排序字段白名单映射等（K-1…K-7） 。
7. API 命名/时间/分页/鉴权统一约定（camelCase 输出、ISO8601 UTC、`Authorization: Bearer <ADMIN_TOKEN>` 等）必须严格执行  。

---

## 研发顺序与文件清单（P0 → P1 → P2）

### P0（业务阻塞项 & 基础前端骨架）✅ **已完成**

> **状态更新**: P0 阶段的所有文件已完成。核心功能已实现，管理端可正常"看与生码"。

1. ✅ **`src/app/api/activate/route.ts`**（修复/增强）- **已完成**
   * 状态：已添加状态检查（`suspended`/`expired`/`disabled`拒绝）和过期检查（自动写回`expired`）
   * 剩余：响应格式使用`ok/data`而非`success`（可选优化，当前功能正常）

2. ✅ **`src/lib/apiClient.ts`**（新增）- **已完成**
   * 状态：API客户端封装完整，支持自动鉴权和统一错误处理

3. ✅ **`src/app/admin/layout.tsx`**（新增）- **已完成**
   * 状态：布局组件完整，包含导航菜单和鉴权守卫

4. ✅ **`src/app/admin/login/page.tsx`**（新增）- **已完成**
   * 状态：登录页面完整，Token管理和自动跳转功能正常

5. ✅ **`src/app/admin/activation-codes/page.tsx`**（新增）- **已完成**
   * 状态：激活码列表页完整，包含筛选、排序、分页、删除功能

6. ✅ **`src/app/admin/activation-codes/new/page.tsx`**（新增）- **已完成**
   * 状态：批量生成页面完整，表单验证和结果展示功能正常

> **P0 完成度**: 6/6 (100%) ✅

---

### P1（一致性修复 & 其余页面 & 运维）⚠️ **进行中**

> **状态更新**: P1 阶段正在进行中。需要修复后端规范性问题并完成剩余前端页面。

7. **`src/app/api/admin/activation-codes/route.ts`**（修复）⚠️ **待完成**

   * 目的：补齐**排序字段白名单映射**、**输出层 camelCase 转换**、计数查询一致性（若缺） 。
   * 关键点：
     * GET方法：添加排序白名单校验（`createdAt|enabledAt|expiresAt|usedCount|usageLimit|status`）
     * GET方法：将数据库返回的`snake_case`字段转换为`camelCase`（如`usage_limit`→`usageLimit`）
     * GET方法：时间字段统一转换为ISO 8601格式
   * 参考白名单键：`createdAt|enabledAt|expiresAt|usedCount|usageLimit|status`，映射到表列名（`created_at` 等） 。
   * 验收：传入非法 `sortBy` 返回 400；响应字段全为 camelCase；时间字段为ISO格式。

8. **`src/app/api/_lib/pagination.ts`**（修复或确认）⚠️ **待确认**

   * 目的：将 `getPaginationMeta` **统一为对象入参版**：`getPaginationMeta({ page, limit, total })`，并在本仓库**所有调用处**同步替换（若有） 。
   * 当前状态：实现为位置参数版，需确认是否改为对象入参版
   * 验收：`npx tsc --noEmit` 通过；相关路由编译无误；调用处已同步更新。

9. **`.env.example`**（新增）⚠️ **待创建**

   * 目的：提供环境变量模板与注释：`DATABASE_URL`、`ADMIN_TOKEN`、`TZ=UTC`，并声明禁止提交真实 `.env` 。
   * 验收：三变量齐全+用途注释+安全警示。

10. **`src/app/admin/activation-codes/[id]/page.tsx`**（新增）⚠️ **待创建**

    * 目的：激活码编辑页面，对接 `PUT /api/admin/activation-codes/:id`。支持编辑使用次数、状态、到期时间、备注。
    * 关键点：
      * 加载激活码详情（GET `/api/admin/activation-codes/:id` 或复用列表接口数据）
      * 编辑表单：`usageLimit`、`status`（禁止从`expired`改回）、`expiresAt`、`notes`
      * 状态流转提示（禁止expired改回）
      * 提交后返回列表页或显示成功提示
    * 验收：能加载并编辑激活码信息；状态流转校验正确；提交成功后可刷新列表。

11. **`src/app/admin/users/page.tsx`**（新增）⚠️ **待创建**

    * 目的：对接 `GET /api/admin/users`（邮箱/激活码查询+分页+排序） 。
    * 关键点：
      * 搜索表单：邮箱、激活码（模糊查询）
      * 表格展示：邮箱、激活码、激活时间、IP地址、User-Agent、关联激活码状态
      * 排序：`activatedAt`、`email`、`code`
      * 分页组件
    * 验收：可按邮箱/激活码过滤；排序键 `activatedAt|email|code` 正常；分页功能正常。

12. **`src/app/admin/stats/page.tsx`**（新增）⚠️ **待创建**

    * 目的：对接 `GET /api/admin/activation-codes/stats`，展示总数、各状态分布、使用率图表 。
    * 关键点：
      * 总数卡片
      * 状态分布图表（饼图/柱状图，显示enabled/disabled/expired/suspended数量）
      * 使用率图表（已用/未用数量和使用率）
      * 刷新按钮
      * 错误态提示
    * 验收：饼图/柱图任一；刷新按钮；错误态提示；数据实时更新。

13. **`src/app/admin/tasks/page.tsx`**（新增）⚠️ **待创建**

    * 目的：提供 `sweep-expired` 任务卡片：Dry-run 与 Execute 两个按钮，调用 `POST /api/admin/tasks/sweep-expired`，展示 affected 数量与时间戳  。
    * 关键点：
      * Dry-run按钮：`mode=dry`参数，仅显示将受影响的数量，不执行更新
      * Execute按钮：执行过期检查任务，返回实际更新的数量
      * 结果展示：受影响数量、执行时间戳
      * 界面区分：Dry-run和Execute按钮样式/提示明确区分
    * 验收：Dry-run 不改数据、Execute 改数据，界面区分明显；结果展示清晰。

14. **运维：Vercel Cron Job 配置文档**（新增 Markdown：`docs/cron-sweep-expired.md`）⚠️ **待创建**

    * 目的：指导将 `/api/admin/tasks/sweep-expired` 配置为每日 00:00 UTC 执行的 Vercel Cron。
    * 内容：面板路径、示例 payload（POST 空体即可）、成功/失败观察点。
    * 验收：按文档操作可完成配置（文字走查即可） 。

> **P1 完成度**: 0/8 (0%) ⚠️ **下一步优先**: 修复激活码列表接口的排序白名单和数据格式转换

---

### P2（优化 & 测试）❌ **未开始**

15. **`src/app/api/admin/activation-codes/route.ts`（POST 段）**：生成算法加**唯一性保护**与分批插入注释（降低碰撞/超时风险） 。

    * 目的：优化批量生成激活码的唯一性保证和性能
    * 关键点：
      * 添加唯一性检查（查询数据库中是否已存在相同激活码）
      * 若存在碰撞，重试生成
      * 大量生成时考虑分批插入（降低超时风险）
      * 添加相关注释说明
    * 验收：批量生成时不会出现插入失败；大量生成（如10000个）不会超时。

16. **测试骨架**（新增 `tests/`）

    * `tests/api/errors.spec.ts`：错误工具函数单元测试
    * `tests/api/pagination.spec.ts`：分页 & meta 单元测试
    * `tests/api/activate.spec.ts`：激活场景 3 例（正常激活/过期拒绝/状态非法拒绝）集成测试
    * `tests/api/admin/activation-codes.spec.ts`：激活码管理接口测试
    * 参考风险评估中"测试待补充"条目 。

> **P2 完成度**: 0/2 (0%) ❌ **优先级**: 低，待P1完成后进行

---

## 研发窗口的**提交格式**（每个文件固定模板）

> **标题**：`[P#] <文件路径> - 完整代码体`
> **说明**：本次修改目的、关键实现点（≤5 条）、影响面（类型/依赖/迁移）
> **代码**：紧随其后，**该文件完整代码体**（勿省略任一 import/export）
> **自检用例**：列出 2–3 条最小用例/curl/伪数据验证方式
> **后续动作**：是否需要我提供其他现有文件的完整代码体

示例开头（请照抄）：

```
[P0] src/app/api/activate/route.ts - 完整代码体

说明：
- 新增状态检查（suspended/expired 拒绝），过期自动写回 expired
- 统一错误返回与 errorCode
- 保持原用量校验逻辑与事务

【代码开始】
...（完整代码体）
【代码结束】

自检用例：
1) 正常激活：curl ...
2) 过期码：curl ... -> 409 且数据库状态写回 expired
3) 状态为 suspended：curl ... -> 403

后续动作：
- 无
```

---

## 研发窗口的**索码请求格式**（当需要现有文件全文时）

> 「请提供当前仓库中 `<文件路径>` 的**完整代码体**，我需要在其基础上做差异化修改；若该文件不存在，请明确告知。」

---

## 串口启动语（请研发窗口先回这段）

> **状态更新**: P0阶段已完成 ✅，当前进入P1阶段。将从 `src/app/api/admin/activation-codes/route.ts` 开始修复，若需原文件我会马上索码。

> 「收到。P0已完成 ✅，将按 P1→P2 顺序逐文件提交，每次输出完整代码体；遇到修改现有文件会先向你索取当前完整代码。先从 `src/app/api/admin/activation-codes/route.ts`（修复排序白名单和数据格式转换）开始，若需原文件我会马上索码。」

---

### 参考依据（摘录）

* 后台产品需求与前端页面列表、到期任务与状态机规则：激活码列表/生成/编辑/统计/用户查询/任务页等  。
* 统一参数与接口契约（分页、时间、鉴权、字段命名、响应格式、各路由契约）：`04-Zalem 后台管理 · 统一参数 & 接口规范 v1.0.md` 。
* vNext 研发规范（Kysely 红线、分页签名、错误工具函数等）：`ZALEM 后台管理 API · 统一研发规范 vNext.md` 。
* 当前状态与风险评估（P0/P1/P2 划分、具体问题与建议）：`03-当前研发状态与风险评估.md` 。

---

## 📊 当前进度总览

| 阶段 | 完成度 | 状态 | 说明 |
|------|--------|------|------|
| **P0** | 6/6 (100%) | ✅ 已完成 | 核心功能和基础前端骨架已完成 |
| **P1** | 0/8 (0%) | ⚠️ 进行中 | 后端规范修复和剩余前端页面 |
| **P2** | 0/2 (0%) | ❌ 未开始 | 优化和测试 |
| **总计** | 6/16 (37.5%) | ⚠️ 进行中 | 核心功能已完成，规范优化进行中 |

---

——
请按照上述内容开工，当前优先处理P1阶段任务