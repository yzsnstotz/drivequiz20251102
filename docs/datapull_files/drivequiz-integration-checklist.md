# DriveQuiz 集成联调清单

本文档用于 datapull 和 drivequiz 两个团队的联调配合，确保 API 对接顺利完成。

## 📋 联调前准备

### DriveQuiz 团队需要完成

#### 1. 基础功能实现

- [ ] **健康检查接口**
  - [ ] `GET /api/v1/rag/health` 实现完成
  - [ ] 返回正确格式的 JSON
  - [ ] 响应时间 < 100ms
  - [ ] 不需要认证即可访问

#### 2. 核心 API 实现

- [ ] **单文档上传接口**
  - [ ] `POST /api/v1/rag/docs` 实现完成
  - [ ] 请求验证（字段、长度等）
  - [ ] 内容去重逻辑
  - [ ] 数据库存储
  - [ ] 操作记录创建
  - [ ] 错误处理完整

- [ ] **批量文档上传接口**
  - [ ] `POST /api/v1/rag/docs/batch` 实现完成
  - [ ] 批量验证和存储
  - [ ] 事务处理
  - [ ] 部分成功处理（207）
  - [ ] 操作记录关联

- [ ] **操作记录查询接口**
  - [ ] `GET /api/v1/rag/operations` 实现完成
  - [ ] 过滤条件支持
  - [ ] 分页功能
  - [ ] 查询性能优化

- [ ] **操作详情查询接口**
  - [ ] `GET /api/v1/rag/operations/{operationId}` 实现完成
  - [ ] 关联文档查询
  - [ ] 统计信息返回

#### 3. 数据库准备

- [ ] **表结构创建**
  - [ ] `rag_documents` 表创建完成
  - [ ] `rag_operations` 表创建完成
  - [ ] `rag_operation_documents` 表创建完成
  - [ ] 索引创建完成

- [ ] **数据库迁移**
  - [ ] 迁移脚本准备完成
  - [ ] 测试环境数据准备
  - [ ] 生产环境部署计划

#### 4. 认证系统

- [ ] **Token 生成**
  - [ ] Token 生成功能实现
  - [ ] Token 管理界面（可选）
  - [ ] Token 过期机制

- [ ] **Token 验证**
  - [ ] Bearer Token 验证实现
  - [ ] API Key 验证实现（可选）
  - [ ] 错误处理（401）

#### 5. 向量化集成

- [ ] **向量化触发**
  - [ ] 文档上传后自动触发向量化
  - [ ] 异步处理机制
  - [ ] 状态管理（pending/processing/completed/failed）

- [ ] **向量化状态更新**
  - [ ] 文档状态字段更新
  - [ ] 错误记录和重试机制

#### 6. 错误处理

- [ ] **错误码实现**
  - [ ] 所有错误码实现完成
  - [ ] 错误响应格式统一
  - [ ] 错误信息清晰明确

- [ ] **速率限制**
  - [ ] 速率限制实现
  - [ ] 响应头包含限制信息
  - [ ] 429 错误处理

---

### datapull 团队需要准备

#### 1. 测试环境

- [ ] **环境配置**
  - [ ] 开发环境配置完成
  - [ ] 测试数据准备
  - [ ] 测试脚本准备

#### 2. 测试用例

- [ ] **基础测试**
  - [ ] 健康检查测试用例
  - [ ] 单文档上传测试用例
  - [ ] 批量上传测试用例
  - [ ] 操作记录查询测试用例

- [ ] **边界测试**
  - [ ] 内容长度边界测试
  - [ ] 批量数量边界测试
  - [ ] 错误处理测试

#### 3. 测试工具

- [ ] **测试脚本**
  - [ ] cURL 测试脚本
  - [ ] Postman 测试集合（可选）
  - [ ] 自动化测试脚本

---

## 🔄 联调流程

### 阶段 1: 基础接口联调（预计 1-2 天）

#### 目标
验证基础接口可访问和认证机制正常工作。

#### 步骤

1. **健康检查**
   ```bash
   # datapull 团队测试
   curl -X GET https://dev-api.drivequiz.com/api/v1/rag/health
   
   # 预期结果
   # 200 OK
   # {"status": "ok", "timestamp": "...", "version": "v1"}
   ```
   - [ ] 接口可访问
   - [ ] 返回格式正确
   - [ ] 响应时间正常

2. **认证测试**
   ```bash
   # datapull 团队测试
   curl -X POST https://dev-api.drivequiz.com/api/v1/rag/docs \
     -H "Authorization: Bearer TEST_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"title": "test", "url": "https://example.com", "content": "test content", "version": "2025Q1", "lang": "ja"}'
   
   # 预期结果
   # 200 OK 或 401 Unauthorized（如果 token 无效）
   ```
   - [ ] 有效 Token 可以访问
   - [ ] 无效 Token 返回 401
   - [ ] 缺少 Token 返回 401

#### 验收标准

- [ ] 健康检查接口正常
- [ ] 认证机制正常工作
- [ ] 错误处理正确

#### 问题记录

| 问题 | 状态 | 负责人 | 解决方案 |
|------|------|--------|----------|
|      |      |        |          |

---

### 阶段 2: 单文档上传联调（预计 1-2 天）

#### 目标
验证单文档上传功能正常，包括验证、存储、去重等。

#### 步骤

1. **正常上传测试**
   ```bash
   # datapull 团队测试
   curl -X POST https://dev-api.drivequiz.com/api/v1/rag/docs \
     -H "Authorization: Bearer TEST_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{
       "title": "测试文档",
       "url": "https://example.com/test",
       "content": "这是一个测试文档内容，长度超过100字符...",
       "version": "2025Q1",
       "lang": "ja",
       "meta": {
         "sourceId": "test_source",
         "type": "official"
       }
     }'
   ```
   - [ ] 上传成功
   - [ ] 返回 docId 和 operationId
   - [ ] 数据库中有记录

2. **验证测试**
   ```bash
   # 测试内容过短
   curl -X POST ... -d '{"content": "短", ...}'
   # 预期: 400 CONTENT_TOO_SHORT
   
   # 测试缺少必填字段
   curl -X POST ... -d '{"title": "test", ...}'
   # 预期: 400 INVALID_REQUEST
   ```
   - [ ] 内容长度验证正确
   - [ ] 必填字段验证正确
   - [ ] 错误信息清晰

3. **去重测试**
   ```bash
   # 上传相同文档两次
   curl -X POST ... -d '{...}'
   curl -X POST ... -d '{...}'  # 相同内容
   ```
   - [ ] 重复文档正确处理
   - [ ] 返回 409 或跳过

4. **操作记录测试**
   ```bash
   # 查询操作记录
   curl -X GET https://dev-api.drivequiz.com/api/v1/rag/operations?sourceId=test_source \
     -H "Authorization: Bearer TEST_TOKEN"
   ```
   - [ ] 操作记录正确保存
   - [ ] 查询结果正确

#### 验收标准

- [ ] 单文档上传功能正常
- [ ] 验证逻辑正确
- [ ] 去重逻辑正确
- [ ] 操作记录正确

#### 问题记录

| 问题 | 状态 | 负责人 | 解决方案 |
|------|------|--------|----------|
|      |      |        |          |

---

### 阶段 3: 批量上传联调（预计 1-2 天）

#### 目标
验证批量上传功能正常，包括批量处理、事务、部分成功等。

#### 步骤

1. **正常批量上传测试**
   ```bash
   # datapull 团队测试
   curl -X POST https://dev-api.drivequiz.com/api/v1/rag/docs/batch \
     -H "Authorization: Bearer TEST_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{
       "docs": [
         {"title": "文档1", "url": "https://example.com/1", "content": "...", "version": "2025Q1", "lang": "ja"},
         {"title": "文档2", "url": "https://example.com/2", "content": "...", "version": "2025Q1", "lang": "ja"}
       ]
     }'
   ```
   - [ ] 批量上传成功
   - [ ] 返回批量 operationId
   - [ ] 所有文档都保存成功

2. **部分成功测试**
   ```bash
   # 包含一个无效文档的批量
   curl -X POST ... -d '{
     "docs": [
       {"title": "文档1", ...},  # 有效
       {"content": "短", ...}    # 无效
     ]
   }'
   ```
   - [ ] 返回 207 Multi-Status
   - [ ] 部分成功文档正确保存
   - [ ] 失败文档错误信息清晰

3. **数量限制测试**
   ```bash
   # 超过 100 个文档
   curl -X POST ... -d '{"docs": [101个文档]}'
   ```
   - [ ] 返回 400 错误
   - [ ] 错误信息清晰

4. **操作记录关联测试**
   ```bash
   # 查询批量操作详情
   curl -X GET https://dev-api.drivequiz.com/api/v1/rag/operations/{operationId} \
     -H "Authorization: Bearer TEST_TOKEN"
   ```
   - [ ] 操作详情正确
   - [ ] 文档列表正确
   - [ ] 统计信息正确

#### 验收标准

- [ ] 批量上传功能正常
- [ ] 事务处理正确
- [ ] 部分成功处理正确
- [ ] 操作记录关联正确

#### 问题记录

| 问题 | 状态 | 负责人 | 解决方案 |
|------|------|--------|----------|
|      |      |        |          |

---

### 阶段 4: 完整流程联调（预计 2-3 天）

#### 目标
验证 datapull 完整抓取和上传流程，包括向量化触发等。

#### 步骤

1. **完整流程测试**
   ```bash
   # datapull 团队运行完整流程
   pnpm crawl
   
   # 验证
   # - 抓取成功
   # - 上传成功
   # - 操作记录正确
   ```
   - [ ] 抓取流程正常
   - [ ] 上传流程正常
   - [ ] 操作记录正确

2. **向量化触发测试**
   ```bash
   # 上传文档后检查向量化状态
   curl -X GET https://dev-api.drivequiz.com/api/v1/rag/docs?sourceId=test_source \
     -H "Authorization: Bearer TEST_TOKEN"
   ```
   - [ ] 向量化状态更新
   - [ ] 向量化任务触发

3. **性能测试**
   ```bash
   # 批量上传 100 个文档
   # 测试响应时间
   ```
   - [ ] 响应时间满足要求（< 5s）
   - [ ] 并发处理正常

4. **数据验证**
   ```bash
   # 验证数据库中的数据
   # - 文档数量正确
   # - 内容正确
   # - 元数据正确
   ```
   - [ ] 数据完整性验证
   - [ ] 数据准确性验证

#### 验收标准

- [ ] 完整流程正常
- [ ] 向量化触发正常
- [ ] 性能满足要求
- [ ] 数据正确性验证通过

#### 问题记录

| 问题 | 状态 | 负责人 | 解决方案 |
|------|------|--------|----------|
|      |      |        |          |

---

### 阶段 5: 生产环境准备（预计 1-2 天）

#### 目标
准备生产环境部署和上线。

#### 步骤

1. **生产环境配置**
   - [ ] 生产环境 API 地址确认
   - [ ] 生产环境 Token 生成（安全传输）
   - [ ] 生产环境数据库准备

2. **生产环境测试**
   - [ ] 小规模测试（10-20 个文档）
   - [ ] 验证功能正常
   - [ ] 验证性能正常

3. **监控和告警**
   - [ ] 监控仪表盘配置
   - [ ] 告警规则配置
   - [ ] 日志收集配置

4. **上线准备**
   - [ ] 上线计划制定
   - [ ] 回滚方案准备
   - [ ] 应急预案准备

#### 验收标准

- [ ] 生产环境配置完成
- [ ] 生产环境测试通过
- [ ] 监控和告警配置完成
- [ ] 上线准备完成

---

## 📊 联调状态跟踪

### 总体进度

- [ ] 阶段 1: 基础接口联调（预计 1-2 天）
- [ ] 阶段 2: 单文档上传联调（预计 1-2 天）
- [ ] 阶段 3: 批量上传联调（预计 1-2 天）
- [ ] 阶段 4: 完整流程联调（预计 2-3 天）
- [ ] 阶段 5: 生产环境准备（预计 1-2 天）

### 问题跟踪

| 问题ID | 问题描述 | 优先级 | 状态 | 负责人 | 解决方案 | 完成时间 |
|--------|----------|--------|------|--------|----------|----------|
|        |          |        |      |        |          |          |

---

## 📞 联系方式

### DriveQuiz 团队

- **负责人**: [待填写]
- **联系方式**: [待填写]
- **技术支持**: [待填写]

### datapull 团队

- **负责人**: [待填写]
- **联系方式**: [待填写]
- **技术支持**: [待填写]

### 联调会议

- **时间**: [待安排]
- **频率**: 每周 [待确定]
- **方式**: [待确定]

---

## 📝 注意事项

1. **测试环境**: 确保使用测试环境进行联调，避免影响生产环境
2. **数据清理**: 联调过程中产生的测试数据需要定期清理
3. **问题记录**: 所有问题都要记录在问题跟踪表中
4. **版本控制**: API 变更需要及时通知对方团队
5. **文档更新**: API 文档需要及时更新

---

**文档版本**: v1.0.0  
**最后更新**: 2025-01-06

