# å‘é‡åŒ–æœåŠ¡æ›¿ä»£æ–¹æ¡ˆåˆ†æ

**é—®é¢˜**: å‘é‡åŒ–æ˜¯å¦ä¸€å®šéœ€è¦é€šè¿‡è°ƒç”¨AIæœåŠ¡æ¥å®ç°ï¼Ÿ  
**ç­”æ¡ˆ**: âŒ **ä¸ä¸€å®š**ï¼Œæœ‰å¤šç§æ›¿ä»£æ–¹æ¡ˆ

---

## ğŸ“Š å½“å‰å®ç°æ–¹å¼

### å½“å‰æ¶æ„

```
å¤–éƒ¨æœåŠ¡ â†’ AI-Service (å‘é‡åŒ–) â†’ Supabase (å­˜å‚¨)
          â†“
     OpenAI API
```

**ç‰¹ç‚¹**:
- é€šè¿‡ AI-Service ç»Ÿä¸€å¤„ç†å‘é‡åŒ–
- ä½¿ç”¨ OpenAI text-embedding-3-smallï¼ˆ1536ç»´ï¼‰
- æ”¯æŒè‡ªå®šä¹‰ `OPENAI_BASE_URL`ï¼ˆå¯å…¼å®¹ Ollamaï¼‰

---

## ğŸ”„ æ›¿ä»£æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: æœ¬åœ°éƒ¨ç½²æ¨¡å‹ï¼ˆæ¨èï¼‰

**æ¶æ„**:
```
å¤–éƒ¨æœåŠ¡ â†’ æœ¬åœ°æ¨¡å‹æœåŠ¡ â†’ Supabase (å­˜å‚¨)
```

**å®ç°æ–¹å¼**:

#### 1.1 ä½¿ç”¨ Ollamaï¼ˆæœ¬åœ°éƒ¨ç½²ï¼‰

```bash
# å®‰è£… Ollama
curl -fsSL https://ollama.com/install.sh | sh

# æ‹‰å– embedding æ¨¡å‹ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰
ollama pull nomic-embed-text
# æˆ–ä½¿ç”¨å…¶ä»–æ¨¡å‹ï¼šmxbai-embed-large, multilingual-e5-large
```

**ä»£ç ä¿®æ”¹**:
```typescript
// åœ¨å¤–éƒ¨æœåŠ¡ä¸­ç›´æ¥è°ƒç”¨æœ¬åœ°æ¨¡å‹
async function createEmbeddingLocal(text: string): Promise<number[]> {
  const response = await fetch('http://localhost:11434/api/embeddings', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      model: 'nomic-embed-text',
      prompt: text
    })
  });
  
  const data = await response.json();
  return data.embedding;
}
```

**ä¼˜ç‚¹**:
- âœ… é›¶æˆæœ¬ï¼ˆæœ¬åœ°è¿è¡Œï¼‰
- âœ… æ— é€Ÿç‡é™åˆ¶
- âœ… æ•°æ®éšç§ï¼ˆä¸å‘é€åˆ°å¤–éƒ¨ï¼‰
- âœ… æ”¯æŒç¦»çº¿è¿è¡Œ

**ç¼ºç‚¹**:
- âš ï¸ éœ€è¦æœåŠ¡å™¨èµ„æºï¼ˆGPU æ¨èï¼‰
- âš ï¸ å‘é‡ç»´åº¦å¯èƒ½ä¸åŒï¼ˆéœ€è°ƒæ•´æ•°æ®åº“ï¼‰
- âš ï¸ éœ€è¦ç»´æŠ¤æ¨¡å‹æœåŠ¡

#### 1.2 ä½¿ç”¨ sentence-transformersï¼ˆPythonï¼‰

```python
# pip install sentence-transformers
from sentence_transformers import SentenceTransformer

model = SentenceTransformer('paraphrase-multilingual-MiniLM-L12-v2')

def create_embedding(text: string):
    embedding = model.encode(text)
    return embedding.tolist()
```

**ä¼˜ç‚¹**:
- âœ… å¼€æºå…è´¹
- âœ… æ”¯æŒå¤šè¯­è¨€
- âœ… å¯æœ¬åœ°éƒ¨ç½²
- âœ… å‘é‡ç»´åº¦å¯é€‰ï¼ˆ384ã€768ç­‰ï¼‰

**ç¼ºç‚¹**:
- âš ï¸ éœ€è¦ Python ç¯å¢ƒ
- âš ï¸ å†…å­˜å ç”¨è¾ƒå¤§ï¼ˆ~500MB-2GBï¼‰
- âš ï¸ é¦–æ¬¡åŠ è½½è¾ƒæ…¢

---

### æ–¹æ¡ˆ 2: ä½¿ç”¨å…¶ä»–äº‘æœåŠ¡

#### 2.1 Google Cloud Vertex AI

```typescript
import { VertexAI } from '@google-cloud/aiplatform';

const vertexAI = new VertexAI({
  project: 'your-project-id',
  location: 'us-central1'
});

async function createEmbeddingGoogle(text: string): Promise<number[]> {
  const embeddings = await vertexAI.preview.getGenerativeModel({
    model: 'textembedding-gecko@001'
  }).generateEmbeddings([text]);
  
  return embeddings[0].values;
}
```

**ä¼˜ç‚¹**:
- âœ… å®˜æ–¹äº‘æœåŠ¡
- âœ… æ”¯æŒå¤šç§æ¨¡å‹
- âœ… æœ‰å…è´¹é¢åº¦

**ç¼ºç‚¹**:
- âš ï¸ éœ€è¦ Google Cloud è´¦æˆ·
- âš ï¸ ä»æœ‰æˆæœ¬ï¼ˆä½äº OpenAIï¼‰
- âš ï¸ éœ€è¦ç½‘ç»œè¿æ¥

#### 2.2 Azure OpenAI

```typescript
import { AzureOpenAI } from 'openai';

const client = new AzureOpenAI({
  apiKey: process.env.AZURE_OPENAI_API_KEY,
  endpoint: process.env.AZURE_OPENAI_ENDPOINT,
  apiVersion: '2024-02-15-preview'
});

async function createEmbeddingAzure(text: string): Promise<number[]> {
  const response = await client.embeddings.create({
    model: 'text-embedding-ada-002',
    input: text
  });
  
  return response.data[0].embedding;
}
```

**ä¼˜ç‚¹**:
- âœ… å…¼å®¹ OpenAI API
- âœ… ä¼ä¸šçº§æ”¯æŒ
- âœ… æ•°æ®å¯ä¿ç•™åœ¨æŒ‡å®šåŒºåŸŸ

**ç¼ºç‚¹**:
- âš ï¸ éœ€è¦ Azure è´¦æˆ·
- âš ï¸ ä»æœ‰æˆæœ¬

---

### æ–¹æ¡ˆ 3: ç›´æ¥å†™å…¥æ•°æ®åº“ï¼ˆç»•è¿‡AI-Serviceï¼‰

**æ¶æ„**:
```
å¤–éƒ¨æœåŠ¡ â†’ æœ¬åœ°/äº‘æ¨¡å‹ â†’ ç›´æ¥å†™å…¥ Supabase
```

**å®ç°æ–¹å¼**:

```typescript
// å¤–éƒ¨æœåŠ¡ä¸­ç›´æ¥å®ç°å®Œæ•´æµç¨‹
async function vectorizeAndStore(
  docId: string,
  content: string,
  title: string,
  url: string
) {
  // 1. æœ¬åœ°å‘é‡åŒ–ï¼ˆä½¿ç”¨ Ollama æˆ–å…¶ä»–ï¼‰
  const chunks = chunkText(content); // 500-800å­—ç¬¦/ç‰‡
  const vectors = [];
  
  for (const chunk of chunks) {
    const embedding = await createEmbeddingLocal(chunk);
    vectors.push({
      doc_id: docId,
      content: chunk,
      embedding: embedding, // ç¡®ä¿ç»´åº¦åŒ¹é…ï¼ˆ1536ï¼‰
      source_title: title,
      source_url: url,
      version: 'v1'
    });
  }
  
  // 2. ç›´æ¥å†™å…¥ Supabase
  const supabaseUrl = process.env.SUPABASE_URL;
  const supabaseKey = process.env.SUPABASE_SERVICE_KEY;
  
  // åˆ†æ‰¹å†™å…¥ï¼ˆæ¯æ‰¹100æ¡ï¼‰
  for (let i = 0; i < vectors.length; i += 100) {
    const batch = vectors.slice(i, i + 100);
    await fetch(`${supabaseUrl}/rest/v1/ai_vectors`, {
      method: 'POST',
      headers: {
        'apikey': supabaseKey,
        'Authorization': `Bearer ${supabaseKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(batch)
    });
  }
  
  // 3. æ›´æ–°æ–‡æ¡£ç»Ÿè®¡
  await fetch(`${supabaseUrl}/rest/v1/ai_rag_docs?id=eq.${docId}`, {
    method: 'PATCH',
    headers: {
      'apikey': supabaseKey,
      'Authorization': `Bearer ${supabaseKey}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ chunks: vectors.length })
  });
}
```

**ä¼˜ç‚¹**:
- âœ… å®Œå…¨è‡ªä¸»æ§åˆ¶
- âœ… å‡å°‘ä¸­é—´ç¯èŠ‚
- âœ… å¯è‡ªå®šä¹‰æµç¨‹

**ç¼ºç‚¹**:
- âš ï¸ éœ€è¦åœ¨å¤–éƒ¨æœåŠ¡ä¸­å®ç°
- âš ï¸ éœ€è¦ç»´æŠ¤å‘é‡åŒ–é€»è¾‘
- âš ï¸ éœ€è¦ç¡®ä¿å‘é‡ç»´åº¦åŒ¹é…

---

## ğŸ“‹ æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æˆæœ¬ | æ€§èƒ½ | éšç§ | å¤æ‚åº¦ | æ¨èåº¦ |
|------|------|------|------|--------|--------|
| **å½“å‰ï¼šOpenAI API** | $0.02/1M tokens | å¿« | ä½ï¼ˆæ•°æ®å¤–ä¼ ï¼‰ | ä½ | â­â­â­ |
| **Ollama æœ¬åœ°** | é›¶ | ä¸­ï¼ˆéœ€GPUï¼‰ | é«˜ï¼ˆæœ¬åœ°ï¼‰ | ä¸­ | â­â­â­â­â­ |
| **sentence-transformers** | é›¶ | ä¸­ | é«˜ï¼ˆæœ¬åœ°ï¼‰ | ä¸­ | â­â­â­â­ |
| **Google Vertex AI** | ä½ | å¿« | ä¸­ | ä½ | â­â­â­ |
| **Azure OpenAI** | ä¸­ | å¿« | ä¸­ | ä½ | â­â­â­ |
| **ç›´æ¥å†™å…¥** | å–å†³äºæ¨¡å‹ | å–å†³äºæ¨¡å‹ | å–å†³äºæ¨¡å‹ | é«˜ | â­â­â­â­ |

---

## ğŸ¯ æ¨èæ–¹æ¡ˆ

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰

**ç»§ç»­ä½¿ç”¨å½“å‰æ–¹æ¡ˆï¼ˆOpenAI APIï¼‰**:
- âœ… æˆæœ¬å¯æ§ï¼ˆ$6-10/æœˆï¼‰
- âœ… å®ç°ç®€å•
- âœ… æ€§èƒ½ç¨³å®š

### ä¸­æœŸï¼ˆ1ä¸ªæœˆï¼‰

**åˆ‡æ¢åˆ° Ollama æœ¬åœ°éƒ¨ç½²**:
- âœ… é›¶æˆæœ¬
- âœ… æ•°æ®éšç§
- âœ… æ— é€Ÿç‡é™åˆ¶
- âš ï¸ éœ€è¦æœåŠ¡å™¨èµ„æºï¼ˆ8GB+ RAMï¼ŒGPU æ¨èï¼‰

**å®æ–½æ­¥éª¤**:
1. åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½² Ollama
2. æ‹‰å– embedding æ¨¡å‹ï¼ˆå¦‚ `nomic-embed-text`ï¼‰
3. ä¿®æ”¹ `OPENAI_BASE_URL` æŒ‡å‘æœ¬åœ° Ollama
4. æˆ–ç›´æ¥åœ¨å¤–éƒ¨æœåŠ¡ä¸­è°ƒç”¨æœ¬åœ°æ¨¡å‹

### é•¿æœŸï¼ˆ3ä¸ªæœˆï¼‰

**æ··åˆæ–¹æ¡ˆ**:
- å¼€å‘/æµ‹è¯•ç¯å¢ƒï¼šä½¿ç”¨æœ¬åœ°æ¨¡å‹ï¼ˆOllamaï¼‰
- ç”Ÿäº§ç¯å¢ƒï¼šæ ¹æ®éœ€æ±‚é€‰æ‹©ï¼ˆæˆæœ¬ vs éšç§ï¼‰

---

## ğŸ”§ æŠ€æœ¯å®ç°è¦ç‚¹

### 1. å‘é‡ç»´åº¦å…¼å®¹æ€§

**å½“å‰æ•°æ®åº“**: `vector(1536)`ï¼ˆOpenAI text-embedding-3-smallï¼‰

**ä¸åŒæ¨¡å‹çš„å‘é‡ç»´åº¦**:
- OpenAI text-embedding-3-small: **1536**
- OpenAI text-embedding-3-large: **3072**
- Ollama nomic-embed-text: **768**
- sentence-transformers multilingual: **384/768/1024**

**è§£å†³æ–¹æ¡ˆ**:
- æ–¹æ¡ˆA: ä½¿ç”¨ç›¸åŒç»´åº¦çš„æ¨¡å‹ï¼ˆæ¨èï¼‰
- æ–¹æ¡ˆB: ä¿®æ”¹æ•°æ®åº“è¡¨ç»“æ„ï¼Œæ”¯æŒåŠ¨æ€ç»´åº¦
- æ–¹æ¡ˆC: ä½¿ç”¨å‘é‡è½¬æ¢å±‚ï¼ˆé™ç»´/å‡ç»´ï¼‰

### 2. ä»£ç ä¿®æ”¹ç¤ºä¾‹

#### ä½¿ç”¨ Ollamaï¼ˆå…¼å®¹ OpenAI APIï¼‰

```typescript
// ä¿®æ”¹ç¯å¢ƒå˜é‡
OPENAI_BASE_URL=http://localhost:11434/v1
OPENAI_API_KEY=ollama  // ä»»æ„å€¼ï¼ŒOllamaä¸éœ€è¦çœŸå®key

// ä»£ç æ— éœ€ä¿®æ”¹ï¼Œç›´æ¥ä½¿ç”¨ OpenAI å®¢æˆ·ç«¯
const openai = new OpenAI({
  baseURL: process.env.OPENAI_BASE_URL,
  apiKey: 'ollama'
});

// è°ƒç”¨æ–¹å¼ç›¸åŒ
const response = await openai.embeddings.create({
  model: 'nomic-embed-text', // Ollama æ¨¡å‹å
  input: text
});
```

#### ç›´æ¥ä½¿ç”¨æœ¬åœ°æ¨¡å‹ï¼ˆä¸é€šè¿‡AI-Serviceï¼‰

```typescript
// å¤–éƒ¨æœåŠ¡ä¸­ç›´æ¥å®ç°
async function vectorizeDocument(content: string) {
  // 1. æ–‡æœ¬åˆ†ç‰‡
  const chunks = chunkText(content, 500, 800, 100);
  
  // 2. æ‰¹é‡å‘é‡åŒ–ï¼ˆä½¿ç”¨æœ¬åœ°æ¨¡å‹ï¼‰
  const vectors = await Promise.all(
    chunks.map(async (chunk) => {
      const embedding = await callLocalModel(chunk);
      return { chunk, embedding };
    })
  );
  
  // 3. ç›´æ¥å†™å…¥æ•°æ®åº“
  await insertVectorsToSupabase(vectors);
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å‘é‡ç»´åº¦ä¸€è‡´æ€§

- âœ… å¿…é¡»ç¡®ä¿æ‰€æœ‰å‘é‡ä½¿ç”¨ç›¸åŒç»´åº¦
- âœ… æ•°æ®åº“è¡¨ç»“æ„å¿…é¡»åŒ¹é…
- âš ï¸ åˆ‡æ¢æ¨¡å‹æ—¶éœ€è¦é‡æ–°å‘é‡åŒ–æ‰€æœ‰æ–‡æ¡£

### 2. æ€§èƒ½è€ƒè™‘

- **æœ¬åœ°æ¨¡å‹**: éœ€è¦è¶³å¤Ÿçš„æœåŠ¡å™¨èµ„æºï¼ˆRAMã€GPUï¼‰
- **äº‘æœåŠ¡**: éœ€è¦è€ƒè™‘ç½‘ç»œå»¶è¿Ÿå’Œé€Ÿç‡é™åˆ¶
- **æ‰¹é‡å¤„ç†**: å»ºè®®å®ç°é˜Ÿåˆ—å’Œé‡è¯•æœºåˆ¶

### 3. æˆæœ¬å¯¹æ¯”

| åœºæ™¯ | OpenAI API | Ollama æœ¬åœ° |
|------|-----------|-------------|
| 10,000 æ–‡æ¡£/æœˆ | ~$6-10 | æœåŠ¡å™¨æˆæœ¬ï¼ˆå·²æœ‰æœåŠ¡å™¨åˆ™ä¸ºé›¶ï¼‰ |
| 100,000 æ–‡æ¡£/æœˆ | ~$60-100 | æœåŠ¡å™¨æˆæœ¬ï¼ˆå·²æœ‰æœåŠ¡å™¨åˆ™ä¸ºé›¶ï¼‰ |
| 1,000,000 æ–‡æ¡£/æœˆ | ~$600-1000 | æœåŠ¡å™¨æˆæœ¬ï¼ˆå·²æœ‰æœåŠ¡å™¨åˆ™ä¸ºé›¶ï¼‰ |

---

## ğŸ“ æ€»ç»“

**ç»“è®º**: å‘é‡åŒ–**ä¸ä¸€å®š**éœ€è¦é€šè¿‡AIæœåŠ¡å®ç°ï¼Œæœ‰ä»¥ä¸‹é€‰æ‹©ï¼š

1. âœ… **ç»§ç»­ä½¿ç”¨ OpenAI API**ï¼ˆå½“å‰æ–¹æ¡ˆï¼‰
   - é€‚åˆï¼šä¸­å°è§„æ¨¡ï¼Œæˆæœ¬å¯æ§
   
2. âœ… **åˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å‹ï¼ˆOllamaï¼‰**
   - é€‚åˆï¼šå¤§è§„æ¨¡ï¼Œæ³¨é‡éšç§ï¼Œé›¶æˆæœ¬
   
3. âœ… **ç›´æ¥å†™å…¥æ•°æ®åº“**
   - é€‚åˆï¼šéœ€è¦å®Œå…¨æ§åˆ¶æµç¨‹çš„åœºæ™¯

**æ¨è**: æ ¹æ®æ•°æ®é‡ã€æˆæœ¬é¢„ç®—å’Œéšç§è¦æ±‚é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2025-01-15  
**é€‚ç”¨åœºæ™¯**: é¡¹ç›®ç»ç†è¯„ä¼°å‘é‡åŒ–æ–¹æ¡ˆé€‰æ‹©














