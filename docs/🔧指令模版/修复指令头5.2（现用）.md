🚀📌【指令头 v5.2 — 全系统研发规范 · 最终版（适用于所有 Cursor 任务）】

本文件不含任何业务内容，只定义 Cursor 的执行规范与约束。
你只需要在每个任务开头粘贴本段，然后再写任务内容即可。
此版本为目前最严格、最可控、最稳定的工程指令头。

🔒 ① 必读规范文件（Cursor 必须阅读，不得跳过）

以下文档必须在执行前阅读并应用：

【AI 模块研发边界】（禁止修改本地 AI 模块）

/Users/leo/Desktop/drivequiz研发规范/AI板块整体架构说明.md

【核心架构规范】

/Users/leo/Desktop/drivequiz研发规范/🧩 AI 服务研发规范（ai-service 统一架构规范 v1.0）.md
/Users/leo/Desktop/drivequiz研发规范/🧩 AI 核心服务规范（ai-core 统一架构规范 v2.0）.md

【AI 操作规范】

/Users/leo/Desktop/drivequiz研发规范/JSON清洗与语言过滤规范.md

【数据库结构文档】

（涉及字段修改必须同步更新）
/Users/leo/Desktop/drivequiz研发规范/数据库结构_DRIVEQUIZ.md
/Users/leo/Desktop/drivequiz研发规范/数据库结构_AI_SERVICE.md

【文件结构文档】

（文件增删变更必须同步更新）
/Users/leo/Desktop/drivequiz研发规范/文件结构.md

🟥 ② 执行前置：必须先输出「规范对齐检查摘要」

任何任务开始前，Cursor 必须输出 5–8 行检查摘要，包含：

🔍 规范对齐检查摘要
1. 已读取所有规范文件（列出文件名）
2. 本任务受哪些规范约束（A? B? C? D? E?）
3. 强关联条款（例如 A1、A2、B1、B3、E1、E3）
4. 本次任务将修改的文件路径（仅列路径）
5. 有无数据库/文件结构相关影响


⚠️ 若没有此摘要 → 任务自动失败。

🟥 ③ 全局红线规范（不可违反，违反即失败）
🔴 A. 架构红线（必须遵守）
编号	规则
A1	路由层禁止出现任何业务逻辑（逻辑必须下沉到 utils/service/ai-core）
A2	所有 AI 逻辑必须只写在 ai-core，不得写在 ai-service 或其他服务
A3	ai-service 与 local-ai-service 行为必须保持完全一致
A4	所有接口参数 & 返回结构必须保持统一（BFF / Next.js API / ai-service）
🔴 B. 数据库 & 文件结构红线（必须遵守）
编号	规则
B1	若修改字段/表结构，必须同步更新数据库结构文档（含生成时间）
B2	文件新增/删除/迁移必须同步更新文件结构文档
B3	所有 Kysely 类型必须与数据库结构完全一致
B4	禁止创建数据库文档中不存在的“隐形字段”
🔴 C. 测试红线（仅 AI 相关任务时必须启用）
编号	规则
C1	必须双环境测试：local-ai-service + ai-service（Render）
C2	必须提供测试日志（请求体、响应体、耗时、错误）
C3	若任一失败 → Cursor 必须继续排查修复，不得要求用户重试
🔴 D. 执行报告红线（所有任务必须输出）
编号	规则
D1	必须生成完整执行报告（固定模板）
D2	必须逐条标注 A1–E10 是否“已遵守 / 不适用 / 需修复”
🟣（新增）E. 反冗余规范（v5.2 最核心增强 · 严格执行）

Cursor 修改代码时最容易出错的正是冗余、重复、旧逻辑未清理。
以下规则为 强制红线级别。

🔵 E1. 新增逻辑必须伴随旧逻辑清理（Add + Cleanup 必须同时完成）

Cursor 不能只新增代码。

必须：

找到旧逻辑

判断是否仍需保留

若不需要 → 必须删除，而不是注释掉或放任不管

执行报告必须包含：

删除旧逻辑摘要：
- 删除文件：
- 删除行号：
- 删除原因：

🔵 E2. 禁止“补丁堆叠”与“多版本共存”

例如：

handleAI()

handleAI_v2()

handleAI_new()

→ ❌ 全部禁止。

必须保持：

✔ 一个功能一个最终版本
✔ 一个入口
✔ 一个实现

旧版本必须删除。

🔵 E3. 代码必须遵守 Single Source of Truth（单一事实来源）

禁止：

同一逻辑在多个文件重复

同一函数 copy 两份

同一算法多种版本共存

必须：

✔ 合并至一个唯一位置
✔ 所有调用引用此唯一实现

🔵 E4. 必须更新所有引用点，禁止遗留旧调用

Cursor 必须自动搜索项目：

rg "oldFunction"
rg "oldAPI"
rg "oldField"


然后：

更新所有引用

删除所有旧引用

保证没有废弃入口残留

执行报告必须包含：

引用点更新检查：
- 更新引用数量：X
- 遗留引用数量：0（否则必须继续修复）

🔵 E5. 清理未使用的 imports / 调试代码 / 冗余变量

Cursor 必须：

删除所有未使用 imports

删除 console.log、debug 代码

删除未使用的辅助函数

删除死代码和无效分支

🔵 E6. 禁止新增未被引用的代码

包括：

新增函数无调用

新增文件无引用

新增类型未使用

如果未引用 → 必须删除。

🔵 E7. 避免无关变更（Minimal Change Set）

Cursor 不能：

重写整个文件

修改与任务无关的模块

进行风格化重构（如大幅空行/格式调整）

必须：

✔ 修改最小必要范围
✔ 且删除过时逻辑

🔵 E8. 必须使用 Diff 思维修改代码（Patch 范围必须最小）

每次变更必须只影响：

受影响的代码块

相关引用点

冗余清理

不允许：

整文件重构

重命名无关变量

改写不相关流程

🔵 E9. 禁止增加不必要的 AI / DB 请求（性能红线）

Cursor 必须优化：

合并重复请求

去除循环中重复调用

不要多次执行 AI 调用逻辑

不要新增额外查询

若代码会增加请求次数 → 必须拒绝并提出修正方案。

🔵 E10. 执行报告必须包含“冗余检测”

执行报告必须输出：

冗余检测结果：
- 是否存在重复逻辑：NO
- 是否清理所有旧逻辑：YES
- 是否存在未引用新增代码：NO
- 是否减少不必要请求：YES（说明）

🟣（新增）F. AI 模块边界红线（主服务修改时必须遵守）

以下规则为 强制红线，适用于所有非 AI 模块任务（例如 drivequiz 主服务、admin、前端、BFF、数据库、任务处理器等）。

🟣 F1. 禁止修改任何 AI 模块代码（ai-core / ai-service / local-ai-service）

主服务相关任务 不得修改以下目录的任何文件：

packages/ai-core/**
apps/ai-service/**
apps/local-ai-service/**


包括但不限于：

不得改 sceneRunner

不得改 providers

不得改 AI config

不得改 AI 路由

不得改 AI prompt、模板、输出格式

不得改 RAG 检索逻辑

不得改 JSON.parse/response_format 相关内容

这些均属于 AI 统一架构体系，禁止在主服务任务中被修改。

🟣 F2. 若主服务任务需要与 AI 协同调整 → 必须“禁止修改”，改为提出需求

Cursor 必须执行：

若任务依赖 AI 模块变更：
- 不得修改 AI 相关文件
- 不得生成临时代码
- 不得写本地 patch

必须在报告最后提出：
《AI 模块协同调整建议》


Cursor 必须输出类似结构：

AI 模块协同调整建议：
- 本次任务需要 AI 输出字段增加/修改：
- 建议由 AI-Core 统一处理的内容：
- 影响的 sceneKey：
- 影响的 outputFormat：
- 需要新增/调整的 JSON 字段：
- 建议的 ai-core 变更点：


最终由 ai-core 统一团队任务 单独创建新任务执行。

🟣 F3. 主服务不得绕过 AI 模块追加逻辑

禁止：

在主服务内写自定义 AI 调用

在主服务内追加 AI 输出补丁

在主服务内修改 AI 清洗流程

在主服务内构建 messages、prompt、response_format

在主服务内 parse AI 原始输出

必须始终：

✔ 调用统一的 ai-core 流水线
✔ 使用 ai-core 提供的最终结构
✔ 不得扩展、不得篡改

🟣 F4. 如不确定是否属于 AI 范围 → 一律视为 AI 模块，不可改动

Cursor 必须遵循：

只要逻辑与 AI 推断 / AI 清洗 / AI 场景 / AI 数据流 / JSON 输出 等有关系，则视为 AI 范围 → 禁止修改。


若不确定：

✔ 只能在执行报告中提出“AI 模块协同建议”
✘ 不得自己修改

🟣 F5. 执行报告必须新增一项：“AI 模块边界自检”

Cursor 必须加入以下检查：

AI 模块边界自检：
- 是否修改任何 ai-core/ai-service/local-ai-service 文件：NO
- 是否新增了与 AI 相关的本地逻辑：NO
- 是否出现绕过 ai-core 的自定义 AI 调用：NO
- 若任务需要 AI 协同调整 → 是否已在报告末尾提出建议：YES/NO


若出现 YES（违反项）→ 任务失败。


若任何项为 NO → 必须继续修复直到通过。

🛠 ④ 若涉及数据库迁移（任务影响 DB 时必须执行）

执行报告必须包含：

迁移脚本文件名

修改的字段、类型、索引

影响的数据库（主库/AI 库）

同步更新两份数据库结构文档（含更新时间）

🗂 ⑤ 若涉及文件结构变更（任务涉及文件变化时必须执行）

执行报告必须包含：

新增文件

删除文件

路径变更

同步更新文件结构文档（含更新时间）

🧪 ⑥ 若任务需要测试（包含 AI 功能时必须执行）

Cursor 必须自动：

执行相关脚本

输出测试日志（local + remote）

若失败必须继续排查直到通过

📑 ⑦ 最终必须输出完整执行报告（固定模板）

路径格式：

docs/问题修复/<问题文件夹>/执行报告/<任务名>_执行报告.md


报告必须包含：

任务摘要

修改文件列表

红线自检（A1–E10）

测试结果（AI 双环境）

迁移脚本（如有）

更新后的数据库文档 / 文件结构文档（如有）

冗余检测报告

风险点与下一步建议

⚠️ 更新版本号（请更新 src/lib/version.ts 中 BUILD_TIME）必须执行，按照当前时间更新版本号