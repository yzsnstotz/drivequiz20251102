# 题目类型与选项格式说明

## 问题

1. **翻译场景的选项，针对是非题应该怎么填写？**
2. **在实际后台应用中是如何区分不同题目类型的格式的？**

## 答案

### 1. 题目类型定义

系统支持三种题目类型：
- `single`: 单选题
- `multiple`: 多选题
- `truefalse`: 是非题（判断题）

### 2. 数据库中的存储格式

在 `questions` 表中：
- `type` 字段：存储题目类型（`"single"` | `"multiple"` | `"truefalse"`）
- `options` 字段：
  - **单选题/多选题**：存储为字符串数组，例如 `["选项A", "选项B", "选项C", "选项D"]`
  - **是非题**：存储为 `null`（不存储选项）

### 3. 实际业务中的处理逻辑

#### 3.1 翻译场景（`question_translation`）

**格式生成规则**（由 `questionPromptBuilder.ts` 统一管理）：

- **单选题/多选题**：
  ```
  Content: 题干内容
  Options:
  - 选项1
  - 选项2
  - 选项3
  Explanation: 解析内容
  ```

- **是非题**：
  ```
  Content: 题干内容
  Explanation: 解析内容
  ```
  **注意**：是非题不输出 `Options` 部分

#### 3.2 润色场景（`question_polish`）

**格式生成规则**：

- **单选题/多选题**：
  ```
  Language: zh
  Content: 题干内容
  Options:
  - 选项1
  - 选项2
  - 选项3
  Explanation: 解析内容
  ```

- **是非题**：
  ```
  Language: zh
  Content: 题干内容
  Explanation: 解析内容
  ```
  **注意**：是非题不输出 `Options` 部分

### 4. 代码实现位置

#### 4.1 统一的题目拼装工具

**文件**：`src/lib/questionPromptBuilder.ts`

- `buildQuestionTranslationInput()`: 用于翻译场景
- `buildQuestionPolishInput()`: 用于润色场景

**关键逻辑**：
```typescript
if (questionType === "truefalse") {
  // 是非题不需要选项，跳过 Options 部分
} else if (options && options.length > 0) {
  // 单选或多选题：如果有选项则输出
  const optionsText = options.map((o) => `- ${o}`).join("\n");
  parts.push(`Options:\n${optionsText}`);
}
```

#### 4.2 实际业务调用

**翻译 API** (`src/app/api/admin/question-processing/translate/route.ts`):
- 从数据库读取题目时，同时读取 `type` 字段
- 调用 `translateWithPolish` 时传递 `questionType: question.type`

**批量处理** (`src/app/api/admin/question-processing/batch-process/route.ts`):
- 同样传递 `questionType: question.type`

**保存翻译结果** (`batch-process/route.ts`):
```typescript
if (question.type === "truefalse") {
  updatedOptions = null; // 是非题的 options 始终为 null
} else if (result.options && Array.isArray(result.options)) {
  updatedOptions = result.options.filter(...);
}
```

### 5. 场景测试页面

**文件**：`src/app/admin/ai/scenes/page.tsx`

**UI 功能**：
1. **题目类型选择器**：可以选择 `single`、`multiple` 或 `truefalse`
2. **选项输入框**：
   - 当选择 `single` 或 `multiple` 时显示
   - 当选择 `truefalse` 时自动隐藏
3. **提示信息**：
   - 是非题：显示 "是非题不需要填写选项，系统会自动处理"
   - 其他类型：显示 "选择题目类型以正确格式化选项"

### 6. 使用指南

#### 6.1 在场景测试中测试是非题

1. 选择场景：`question_translation` 或 `question_polish`
2. 选择题目类型：`truefalse`（是非题）
3. 填写题干内容（必需）
4. **不需要填写选项**（选项输入框会自动隐藏）
5. 填写解析（可选）
6. 点击测试

#### 6.2 在题目管理页面翻译是非题

系统会自动：
1. 从数据库读取题目的 `type` 字段
2. 如果是 `truefalse`，`options` 字段为 `null`
3. 调用翻译时，`questionPromptBuilder` 会自动跳过 `Options` 部分
4. 翻译结果保存时，`options` 字段保持为 `null`

### 7. 总结

- **是非题**：`options` 字段在数据库中为 `null`，在 AI 请求中不输出 `Options` 部分
- **单选题/多选题**：`options` 字段为字符串数组，在 AI 请求中输出 `Options` 部分
- **统一管理**：所有格式生成逻辑都在 `questionPromptBuilder.ts` 中，确保场景测试和实际业务完全一致
- **自动处理**：系统会根据题目类型自动决定是否输出选项，无需手动判断

