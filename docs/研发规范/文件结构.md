# DriveQuiz & AI-Service 代码结构说明 v1.0

**最后更新**: 2025-01-24  
**维护者**: 开发团队  
**重要**: 每次代码结构变更必须同步更新本文档

---

## 1. 仓库总体结构

```
v1/
├── apps/                          # 应用目录
│   ├── web/                       # Next.js 前端（用户端 + 管理后台）
│   ├── drivequiz-api/             # BFF / 主业务 API，直连 drivequiz 主库
│   ├── ai-service/                # AI 微服务，直连 ai-service 库
│   ├── question-processor/        # 题目处理服务
│   └── local-ai-service/          # 本地 AI 服务（Ollama）
├── packages/                      # 共享包
│   └── ai-core/                   # 公共 AI 调用封装
├── src/                           # 主应用源代码（Next.js）
│   ├── app/                       # Next.js App Router
│   │   ├── api/                   # API 路由
│   │   └── admin/                 # 后台管理页面
│   ├── components/                # React 组件
│   ├── lib/                       # 工具库
│   │   ├── db.ts                  # drivequiz 主库连接
│   │   ├── aiDb.ts                # ai-service 库连接
│   │   └── questionDb.ts          # 题目数据库操作
│   ├── contexts/                  # React Context
│   ├── data/                      # 静态数据
│   └── migrations/                # 数据库迁移文件
├── scripts/                       # 脚本文件
├── docs/                          # 文档
│   └── 研发规范/                  # 研发规范文档
│       ├── 数据库结构.md          # 数据库结构文档（本文档）
│       └── 文件结构.md            # 代码结构文档（本文档）
└── package.json                   # 根 package.json（monorepo 配置）
```

---

## 2. 核心应用说明

### 2.1 apps/web - Next.js 前端应用

**路径**: `apps/web/`

**说明**: Next.js 15 (App Router) 前端应用，包含用户端和管理后台

**关键目录**:
```
apps/web/
├── app/
│   ├── (main)/                    # 前台主模块
│   │   ├── license/               # 驾照学习
│   │   ├── vehicles/              # 车辆
│   │   ├── services/              # 服务
│   │   ├── profile/               # 我的
│   │   └── ai/                    # 智能助手
│   ├── admin/                     # 后台管理页面
│   │   ├── ai/                    # AI 管理
│   │   │   ├── config/            # AI 配置
│   │   │   ├── filters/           # AI 过滤器
│   │   │   ├── logs/              # AI 日志
│   │   │   └── monitor/           # AI 监控
│   │   └── questions/             # 题目管理
│   └── api/                       # API 路由（前端 API）
│       ├── ai/                    # AI 相关 API
│       │   ├── ask/               # AI 问答
│       │   └── chat/              # AI 聊天
│       └── admin/                 # 管理后台 API
│           └── ai/                # AI 管理 API
└── vercel.json                    # Vercel 部署配置
```

---

### 2.2 apps/drivequiz-api - 主业务 API

**路径**: `apps/drivequiz-api/`

**说明**: BFF (Backend For Frontend) / 主业务 API，直连 drivequiz 主库

**关键目录**:
```
apps/drivequiz-api/
├── src/
│   ├── index.ts                   # 服务入口
│   ├── lib/
│   │   └── db.ts                  # drivequiz 主库连接
│   ├── routes/                    # API 路由
│   │   ├── docs.ts                # 文档相关
│   │   ├── operations.ts          # 操作相关
│   │   └── health.ts              # 健康检查
│   ├── services/                  # 业务服务
│   │   ├── operation-logger.ts    # 操作日志服务
│   │   ├── upload-history.ts      # 上传历史服务
│   │   └── vectorizer.ts          # 向量化服务
│   └── types/                     # TypeScript 类型定义
├── migrations/                    # 数据库迁移文件（RAG 相关）
└── package.json
```

**数据库连接**: 使用 `DATABASE_URL` 或 `DRIVEQUIZ_DATABASE_URL`

---

### 2.3 apps/ai-service - AI 微服务

**路径**: `apps/ai-service/`

**说明**: AI 微服务，直连 ai-service 库，提供 AI 调用能力

**关键目录**:
```
apps/ai-service/
├── src/
│   ├── index.ts                   # 服务入口
│   ├── routes/                    # API 路由
│   │   ├── ask.ts                 # /v1/ask 路由（AI 问答）
│   │   └── admin/                 # 管理路由
│   │       ├── cache-prewarm.ts   # 缓存预热
│   │       ├── daily-summary.ts   # 每日汇总
│   │       └── ragIngest.ts       # RAG 数据导入
│   ├── lib/                       # 工具库
│   │   ├── sceneRunner.ts         # 场景执行逻辑
│   │   ├── openaiClient.ts        # OpenAI 客户端
│   │   ├── rag.ts                 # RAG 检索
│   │   ├── safety.ts              # 安全检测
│   │   ├── cache.ts                # 缓存管理
│   │   ├── configLoader.ts        # 配置加载
│   │   ├── dbLogger.ts            # 数据库日志
│   │   └── logger.ts              # 日志工具
│   ├── middlewares/                # 中间件
│   │   └── auth.ts                # 认证中间件
│   ├── jobs/                      # 定时任务
│   │   └── cron.dailySummarize.ts # 每日汇总任务
│   └── tasks/                     # 后台任务
│       └── dailySummarize.ts      # 每日汇总任务实现
├── Dockerfile
└── package.json
```

**数据库连接**: 使用 `AI_SERVICE_DATABASE_URL` 或 `AI_DATABASE_URL`

---

### 2.4 apps/question-processor - 题目处理服务

**路径**: `apps/question-processor/`

**说明**: 题目处理服务，提供题目翻译、润色等功能

**关键目录**:
```
apps/question-processor/
├── src/
│   ├── index.ts                   # 服务入口（Fastify）
│   ├── db.ts                      # 数据库连接（drivequiz 主库）
│   ├── ai.ts                      # AI 调用封装
│   ├── aiCache.ts                 # AI 缓存
│   └── aiConfig.ts                # AI 配置
└── package.json
```

**关键路由**:
- `POST /translate` - 翻译题目
- `POST /polish` - 润色题目
- `POST /batch-process` - 批量处理题目
- `GET /reviews` - 获取审核列表
- `POST /reviews/:id/approve` - 批准审核
- `POST /reviews/:id/reject` - 拒绝审核

**数据库连接**: 使用 `QUESTION_PROCESSOR_DATABASE_URL` 或 `DATABASE_URL`（drivequiz 主库）

---

### 2.5 packages/ai-core - 公共 AI 调用封装

**路径**: `packages/ai-core/`

**说明**: 前端/后端调用 AI 服务的统一封装

**关键文件**:
```
packages/ai-core/
├── src/
│   ├── sceneRunner.ts             # 场景执行器（统一封装）
│   ├── types.ts                   # 类型定义
│   └── index.ts                   # 导出入口
└── package.json
```

---

## 3. 主应用源代码（src/）

### 3.1 src/app - Next.js App Router

**路径**: `src/app/`

**说明**: Next.js App Router 路由和页面

**关键目录**:
```
src/app/
├── api/                           # API 路由（Next.js API Routes）
│   ├── admin/                     # 管理后台 API
│   │   ├── question-processing/   # 题目处理相关
│   │   │   ├── translate/         # 翻译 API
│   │   │   ├── batch-process/     # 批量处理 API
│   │   │   ├── error-stats/       # 错误统计 API（新增）
│   │   │   ├── tasks/             # 任务相关 API
│   │   │   │   └── [taskId]/      # 任务详情 API
│   │   │   │       └── items/     # 任务子项 API
│   │   │   └── _lib/              # 共享工具
│   │   │       └── batchProcessUtils.ts  # 批量处理工具
│   │   └── questions/             # 题目管理 API
│   └── ai/                        # AI 相关 API（前端调用）
│       ├── ask/                   # AI 问答
│       └── chat/                  # AI 聊天
└── admin/                         # 后台管理页面
    ├── questions/                 # 题目管理页面
    ├── question-processing/        # 题目处理页面
    │   ├── page.tsx               # 批量处理任务列表页
    │   └── error-dashboard/       # 错误统计仪表板（新增）
    │       └── page.tsx           # 错误统计仪表板页面
    └── ai/                        # AI 管理页面
```

---

### 3.2 src/lib - 工具库

**路径**: `src/lib/`

**关键文件**:

#### `src/lib/db.ts` - drivequiz 主库连接

**说明**: 主数据库连接配置，使用 Kysely ORM

**关键内容**:
- 定义所有 drivequiz 主库表结构（TypeScript 接口）
- 数据库连接池配置
- 导出 `db` 实例

**重要约定**:
- ✅ 所有题目相关操作使用此连接
- ✅ 所有业务数据操作使用此连接
- ❌ 不包含 `question_translations` 表定义（已废弃）

---

#### `src/lib/aiDb.ts` - ai-service 库连接

**说明**: AI 服务数据库连接配置

**关键内容**:
- 定义所有 ai-service 库表结构
- 数据库连接池配置
- 导出 `aiDb` 实例

**重要约定**:
- ✅ 所有 AI 配置和日志操作使用此连接
- ❌ 不包含任何题目相关表

---

#### `src/lib/questionDb.ts` - 题目数据库操作

**说明**: 题目相关的数据库操作封装

**关键函数**:
- `getQuestionsFromDb()` - 从数据库获取题目
- `saveQuestionToDb()` - 保存题目到数据库
- `getAIAnswerFromDb()` - 获取 AI 回答

**重要约定**:
- ✅ 直接从 `questions.content` JSON 中提取对应语言（不再使用 `question_translations` 表）

---

### 3.3 src/migrations - 数据库迁移文件

**路径**: `src/migrations/`

**说明**: 所有数据库迁移脚本

**命名格式**: `YYYYMMDD_description.sql`

**关键迁移文件**:
- `20250115_create_question_tables.sql` - 创建题目相关表
- `20250115_migrate_translations_to_content_jsonb.sql` - 将翻译数据迁移到 JSONB
- `20250120_update_questions_multilang_tags.sql` - 更新题目表支持多语言
- `20250121_add_debug_fields_to_task_items.sql` - 为 task_items 表添加调试字段（ai_request, ai_response, processed_data）
- `20250122_update_explanation_to_jsonb.sql` - 更新 explanation 字段为 JSONB
- `20250122_create_question_processing_task_items.sql` - 创建题目处理任务项表
- `20250124_drop_question_translations_table.sql` - 删除 question_translations 表
- `20251121_add_error_detail_to_task_items.sql` - 为 task_items 表添加 error_detail 字段（新增）
- `20250115_create_ai_tables.sql` - 创建 AI 相关表（ai-service 库）
- `20250120_create_ai_provider_config.sql` - 创建 AI Provider 配置表
- `20251113_create_ai_scene_config.sql` - 创建 AI 场景配置表

---

## 4. 与题库 & 翻译相关的关键文件

### 4.1 题目翻译写入逻辑

#### `src/app/api/admin/question-processing/_lib/batchProcessUtils.ts`

**说明**: 批量任务调度与处理（翻译、补漏、PIPELINE）

**关键函数**:
- `saveQuestionTranslation()` - **保存题目翻译到 `questions.content` JSONB**
- `fillMissingContent()` - 补漏内容
- `processFullPipelineBatch()` - 一体化处理
- `enforceTranslationConstraints()` - 翻译结果约束校验（包含诊断信息收集）
- `getSourceExplanationFromAiOutput()` - 从 AI 输出中获取源语言 explanation
- `buildUpdatedExplanationWithGuard()` - 带语言校验的 explanation 更新函数

**重要约定**:
- ✅ **翻译结果统一写入 `questions.content` 和 `questions.explanation` JSONB 字段**
- ✅ **JSON 结构**: `{ "zh": "...", "en": "...", "ja": "..." }`
- ✅ **错误诊断信息写入 `question_processing_task_items.error_detail` JSONB 字段**
- ❌ **不再使用 `question_translations` 表**

---

#### `src/app/api/admin/question-processing/error-stats/route.ts`（新增）

**说明**: 错误统计 API

**路由**: `GET /api/admin/question-processing/error-stats`

**功能**:
- 按错误码聚合统计
- 按目标语言聚合统计
- 按错误阶段聚合统计
- Top N 问题题目列表

**查询参数**:
- `from`: 开始日期（YYYY-MM-DD）
- `to`: 结束日期（YYYY-MM-DD）
- `scene`: 场景（full_pipeline / translate / polish 等）

---

#### `src/app/admin/question-processing/error-dashboard/page.tsx`（新增）

**说明**: 错误统计仪表板页面

**路由**: `/admin/question-processing/error-dashboard`

**功能**:
- 可视化展示错误码分布
- 可视化展示按目标语言分布
- 可视化展示按错误阶段分布
- Top N 问题题目列表（支持查看题目）

---

#### `src/app/api/admin/question-processing/translate/route.ts`

**说明**: 翻译 API 路由

**关键逻辑**:
- 调用 AI 服务进行翻译
- 将翻译结果写入 `questions.content` JSONB
- 将解析结果写入 `questions.explanation` JSONB

---

#### `apps/question-processor/src/index.ts`

**说明**: 题目处理服务主文件

**关键路由**:
- `POST /translate` - 翻译题目（写入 `questions.content` JSON）
- `POST /polish` - 润色题目（从 `questions.content` JSON 读取）
- `POST /batch-process` - 批量处理（写入 `questions.content` JSON）

**重要约定**:
- ✅ 所有翻译操作都基于 `questions.content` JSONB
- ❌ 不再访问 `question_translations` 表

---

### 4.2 数据库连接文件

#### `src/lib/db.ts` - drivequiz 主库

**说明**: 主数据库连接和类型定义

**关键内容**:
- 定义所有 drivequiz 主库表结构
- 数据库连接池配置
- 导出 `db` 实例

**表定义**:
- ✅ `questions` - 题目表（包含 `content` 和 `explanation` JSONB 字段）
- ✅ `question_ai_answers` - AI 回答表
- ✅ `question_polish_reviews` - 润色审核表
- ✅ `batch_process_tasks` - 批量处理任务表
- ❌ `question_translations` - **已注释掉，不再使用**

---

#### `src/lib/aiDb.ts` - ai-service 库

**说明**: AI 服务数据库连接和类型定义

**关键内容**:
- 定义所有 ai-service 库表结构
- 数据库连接池配置
- 导出 `aiDb` 实例

**表定义**:
- `ai_logs` - AI 问答日志表
- `ai_filters` - AI 过滤器表
- `ai_provider_config` - AI Provider 配置表
- `ai_scene_config` - AI 场景配置表
- `ai_rag_docs` - RAG 文档表
- `ai_vectors` - 向量存储表

---

## 5. 与 AI 调用相关的关键文件

### 5.1 AI 服务调用

#### `apps/ai-service/src/routes/ask.ts`

**说明**: `/v1/ask` 路由，处理 AI 问答请求

**关键逻辑**:
- 接收用户问题
- 调用场景执行器
- 记录日志到 `ai_logs` 表
- 返回 AI 回答

---

#### `apps/ai-service/src/lib/sceneRunner.ts`

**说明**: 场景执行逻辑

**关键功能**:
- 加载场景配置（从 `ai_scene_config` 表）
- 选择 AI Provider（从 `ai_provider_config` 表）
- 执行 AI 调用
- 记录统计信息

---

#### `packages/ai-core/src/sceneRunner.ts`

**说明**: 前端/后端调用 AI 服务的统一封装

**关键功能**:
- 统一 AI 调用接口
- 处理错误和重试
- 缓存管理

---

## 6. 关键约定

### 6.1 题库数据结构

- ✅ **`questions.content`**: 多语言 JSONB 格式
  ```json
  {
    "zh": "中文题干",
    "en": "English question",
    "ja": "日本語の問題"
  }
  ```

- ✅ **`questions.explanation`**: 多语言 JSONB 格式
  ```json
  {
    "zh": "中文解析",
    "en": "English explanation",
    "ja": "日本語の解説"
  }
  ```

- ❌ **不再使用 `question_translations` 表**

---

### 6.2 数据库划分规则

- ✅ **题库 & 业务数据** → drivequiz 主库
  - 使用 `src/lib/db.ts` 连接
  - 环境变量: `DATABASE_URL` 或 `DRIVEQUIZ_DATABASE_URL`

- ✅ **AI 配置 & 调用日志** → ai-service 库
  - 使用 `src/lib/aiDb.ts` 连接
  - 环境变量: `AI_SERVICE_DATABASE_URL` 或 `AI_DATABASE_URL`

- ❌ **ai-service 库不允许放业务题库数据**

---

### 6.3 翻译写入规则

**统一规则**: 所有翻译结果必须写入 `questions.content` 和 `questions.explanation` JSONB 字段

**实现方式**:
1. 读取当前 `questions.content` JSON
2. 按目标语言 `targetLanguage` 作为 key 写入
3. 更新 `questions.content` 字段
4. 同样处理 `questions.explanation` 字段

**示例代码**:
```typescript
// 更新 content JSONB 对象，添加目标语言
let updatedContent: any;
if (typeof currentQuestion.content === "object" && currentQuestion.content !== null) {
  updatedContent = { ...currentQuestion.content, [targetLang]: translatedContent };
} else if (typeof currentQuestion.content === "string") {
  updatedContent = { zh: currentQuestion.content, [targetLang]: translatedContent };
} else {
  updatedContent = { [targetLang]: translatedContent };
}

// 更新题目
await db
  .updateTable("questions")
  .set({
    content: updatedContent as any,
    explanation: updatedExplanation as any,
    updated_at: new Date(),
  })
  .where("id", "=", questionId)
  .execute();
```

---

## 7. 文档维护

**重要**: 每次涉及以下变更时，必须同步更新本文档：

- ✅ 新增/删除/修改应用或模块
- ✅ 改动主模块目录结构
- ✅ 改动数据库连接配置
- ✅ 改动翻译写入逻辑
- ✅ 新增关键文件或函数

**更新记录**:
- 2025-01-24: 初始版本，记录完整代码结构，标注 `question_translations` 相关代码已清理

