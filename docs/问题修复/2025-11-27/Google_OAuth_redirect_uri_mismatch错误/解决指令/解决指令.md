# Google OAuth redirect_uri_mismatch 错误解决指令

**问题 ID**: CP-20251127-001  
**创建日期**: 2025-11-27  
**优先级**: High

---

## 📋 问题概述

部署到 Vercel 生产环境后，Google OAuth 登录时出现 `redirect_uri_mismatch` 错误，导致用户无法使用 Google 账号登录。

**错误信息**:
```
错误 400： redirect_uri_mismatch
```

---

## 🎯 解决目标

1. ✅ 修复 Google OAuth redirect_uri_mismatch 错误
2. ✅ 确保用户可以通过 Google 账号正常登录
3. ✅ 提供清晰的诊断和配置指南

---

## 🔧 解决步骤

### 步骤 1：检查 Vercel 部署日志

**目的**: 确认当前使用的回调 URL

**操作**:
1. 登录 Vercel Dashboard
2. 进入项目 → **Deployments** → 最新部署
3. 查看 **Build Logs** 或 **Function Logs**
4. 查找以下日志行：

```
[NextAuth] 📋 环境变量诊断:
[NextAuth]   使用的 Auth URL: ...
[NextAuth]   Google Callback URL: ...
```

**预期结果**:
- 如果看到 "❌ 未设置"：需要执行步骤 2
- 如果看到具体的 URL：记录这个 URL，然后执行步骤 3

---

### 步骤 2：在 Vercel 中设置环境变量

**目的**: 配置 NextAuth 的基础 URL

**操作**:
1. **登录 Vercel Dashboard**
   - 访问 https://vercel.com/dashboard
   - 选择你的项目

2. **获取实际的部署域名**
   - 进入 **Deployments** 页面
   - 查看最新部署的 URL（例如：`https://drivequiz20251102-app.vercel.app`）
   - 或者查看 **Settings** → **Domains** 中配置的自定义域名
   - **复制这个完整的 URL**（包含 `https://`）

3. **设置环境变量**
   - 进入 **Settings** → **Environment Variables**
   - 点击 **Add** 按钮
   - 添加以下变量：

   | 变量名 | 值 | 环境 |
   |--------|-----|------|
   | `NEXTAUTH_URL` | `https://your-actual-domain.vercel.app` | Production |

   **重要提示**:
   - ✅ 必须使用完整的 HTTPS URL（包含 `https://`）
   - ✅ 不能包含末尾斜杠（如 `https://domain.com/` ❌）
   - ✅ 必须使用实际的部署域名，不能使用 `localhost`
   - ✅ 确保选择了正确的环境（Production）

4. **保存并重新部署**
   - 点击 **Save** 保存环境变量
   - 进入 **Deployments** 页面
   - 点击最新部署右侧的 **...** 菜单
   - 选择 **Redeploy** 重新部署

---

### 步骤 3：在 Google Cloud Console 中配置回调 URI

**目的**: 确保 Google OAuth 接受来自生产环境的回调请求

**操作**:
1. **登录 Google Cloud Console**
   - 访问 https://console.cloud.google.com/
   - 选择正确的项目

2. **进入 OAuth 2.0 客户端配置**
   - 导航到 **APIs & Services** → **Credentials**
   - 找到你的 OAuth 2.0 Client ID（应该与 `GOOGLE_CLIENT_ID` 环境变量一致）
   - 点击编辑（铅笔图标）

3. **配置 Authorized JavaScript origins**
   - 添加：`https://your-actual-domain.vercel.app`
   - ⚠️ **不要包含 `/api/auth/callback/google`**
   - 如果使用多个环境，可以同时添加：
     - `https://your-domain.vercel.app`（生产环境）
     - `http://localhost:3000`（开发环境）

4. **配置 Authorized redirect URIs**
   - 添加：`https://your-actual-domain.vercel.app/api/auth/callback/google`
   - ⚠️ **必须与步骤 1 中日志显示的 URL 完全一致**
   - 如果使用多个环境，可以同时添加：
     - `https://your-domain.vercel.app/api/auth/callback/google`（生产环境）
     - `http://localhost:3000/api/auth/callback/google`（开发环境）

5. **保存配置**
   - 点击 **Save** 保存更改
   - 配置通常立即生效，但可能需要几分钟

---

### 步骤 4：验证配置

**目的**: 确认配置正确并测试登录功能

**操作**:
1. **等待配置生效**
   - Google Cloud Console 配置可能需要 1-2 分钟生效
   - Vercel 重新部署完成后，等待几分钟

2. **检查新的部署日志**
   - 查看最新的 Vercel 部署日志
   - 确认以下日志显示正确的值：
     ```
     [NextAuth]   使用的 Auth URL: https://your-domain.vercel.app
     [NextAuth]   Google Callback URL: https://your-domain.vercel.app/api/auth/callback/google
     ```

3. **测试 Google 登录**
   - 访问生产环境应用
   - 点击 Google 登录按钮
   - 应该能够正常跳转到 Google 授权页面
   - 授权后应该能够成功登录

---

## ✅ 验证清单

完成以下所有项后，问题应该已解决：

- [ ] Vercel 环境变量 `NEXTAUTH_URL` 已设置（Production 环境）
- [ ] 环境变量值使用完整的 HTTPS URL（包含 `https://`）
- [ ] 环境变量值不包含末尾斜杠
- [ ] Google Cloud Console 中已添加生产环境的回调 URI
- [ ] 回调 URI 格式为：`https://your-domain.vercel.app/api/auth/callback/google`
- [ ] Google Cloud Console 中已添加对应的 JavaScript origin
- [ ] 已保存 Google Cloud Console 配置
- [ ] 已重新部署 Vercel 应用
- [ ] 部署日志显示正确的回调 URL
- [ ] Google 登录功能正常工作

---

## 🚨 常见问题排查

### Q1: 环境变量设置了但仍然是 "❌ 未设置"

**可能原因**:
- 环境变量设置了错误的**环境**（例如设置了 Development 而不是 Production）
- 没有重新部署

**解决方法**:
- 检查环境变量的**环境**设置，确保选择了 **Production**
- 重新部署应用

---

### Q2: 回调 URI 仍然不匹配

**可能原因**:
- Google Cloud Console 中的回调 URI 与日志显示的不完全一致
- 可能有多余的空格、斜杠或大小写问题

**解决方法**:
1. 从 Vercel 日志中**精确复制**回调 URL
2. 在 Google Cloud Console 中**精确粘贴**（不要手动输入）
3. 确保没有多余的空格或字符

---

### Q3: 多个环境（Production/Preview）都需要配置

**解决方法**:
- 在 Vercel 中为每个环境分别设置 `NEXTAUTH_URL`
- 在 Google Cloud Console 中为每个环境添加对应的回调 URI

---

## 📝 示例配置

### Vercel 环境变量（Production）

```
NEXTAUTH_URL=https://drivequiz20251102-app.vercel.app
```

### Google Cloud Console

**Authorized JavaScript origins**:
```
https://drivequiz20251102-app.vercel.app
http://localhost:3000
```

**Authorized redirect URIs**:
```
https://drivequiz20251102-app.vercel.app/api/auth/callback/google
http://localhost:3000/api/auth/callback/google
```

---

## 📚 相关文档

- [修复指南](../../Google_OAuth_redirect_uri_mismatch错误/修复指南.md)
- [快速检查清单](../../Google_OAuth_redirect_uri_mismatch错误/快速检查清单.md)
- [问题诊断报告](../诊断报告/问题诊断报告.md)

---

## ⚠️ 注意事项

1. **回调 URI 必须完全匹配**：协议、域名、路径必须与日志中显示的完全一致
2. **环境变量必须选择正确的环境**：如果只设置了 Development，Production 环境不会生效
3. **配置可能需要几分钟生效**：Google Cloud Console 的配置可能需要 1-2 分钟才能生效
4. **建议明确设置 NEXTAUTH_URL**：虽然代码提供了 VERCEL_URL 回退，但明确设置更可靠

---

## 🎯 完成标准

- ✅ 用户可以通过 Google 账号正常登录
- ✅ Vercel 部署日志显示正确的回调 URL
- ✅ Google Cloud Console 中配置了对应的回调 URI
- ✅ 所有验证清单项已完成

