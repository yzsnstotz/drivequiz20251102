🧩 任务概述（给 Cursor）

任务名称：Google OAuth redirect_uri_mismatch 最终修复（v3）
前置状态：

v2 已经实现 getAuthBaseUrl() 强校验、删除了 VERCEL_URL 回退，并更新了文档。

生产环境已配置：NEXTAUTH_URL=https://ai.zalem.app，但 Google 仍返回 redirect_uri_mismatch

生产日志中出现：NODE_TLS_REJECT_UNAUTHORIZED=0 的警告（安全风险，需要标记）

核心怀疑点：

Auth.js v5 实际使用的是 AUTH_URL / AUTH_TRUST_HOST 作为 base URL，而当前项目只配置和校验了 NEXTAUTH_URL。

因为 AUTH_URL 未显式设置，NextAuth 可能仍然用请求 Host 或别的 fallback 生成 redirect_uri，导致 Google 看到的地址与控制台配置不一致。

当前代码只在日志中展示了“我们认为的 callback URL”（${authBaseUrl}/api/auth/callback/google），但没保证 NextAuth 内部真的用的就是这一个。

⚠️ 禁止事项

❌ 不允许再引入任何新的第三方依赖。

❌ 不允许改动其他服务（ai-service / drivequiz-api 等），本次仅限 Web / NextAuth 这一侧。

❌ 不允许在路由层写业务逻辑（遵守 A1）。

🗂 涉及文件

路径以当前仓库为准，结合 v2 执行报告中的实际文件。

src/lib/env.ts

src/lib/auth.ts

src/app/api/auth/[...nextauth]/route.ts（如果存在）

docs/问题修复/Google_OAuth_redirect_uri_mismatch错误/修复指南.md

docs/问题修复/Google_OAuth_redirect_uri_mismatch错误/快速检查清单.md

docs/问题修复/2025-11-27/Google_OAuth_redirect_uri_mismatch错误/执行报告/执行报告.md（在此基础上追加 v3）

✅ Step 1：在 env 层显式同步 AUTH_URL ← NEXTAUTH_URL

文件：src/lib/env.ts

1.1 顶层增加环境变量同步逻辑

在 src/lib/env.ts 顶部（在任何函数外面，保证在 NextAuth 初始化之前执行），增加如下代码：

// src/lib/env.ts 顶部（在任何函数 / 导出之前）
if (process.env.NEXTAUTH_URL && !process.env.AUTH_URL) {
  // 将 NEXTAUTH_URL 同步给 AUTH_URL，确保 Auth.js v5 内部使用统一的 base URL
  process.env.AUTH_URL = process.env.NEXTAUTH_URL;

  if (process.env.NODE_ENV === "production") {
    console.log(
      "[NextAuth][Config] AUTH_URL 未设置，已在运行时自动同步为 NEXTAUTH_URL=",
      process.env.NEXTAUTH_URL,
    );
  } else {
    console.log(
      "[NextAuth][Config] (dev) AUTH_URL 同步自 NEXTAUTH_URL=",
      process.env.NEXTAUTH_URL,
    );
  }
}


目的：

对于 Auth.js v5，AUTH_URL 是推荐的主 URL 变量。

现在项目所有校验都基于 NEXTAUTH_URL，通过这一步保证 框架内部也用同一个值。

1.2 在 getAuthBaseUrl() 中增加 AUTH_URL 日志（只读）

在 getAuthBaseUrl() 函数中（v2 已存在），增加只读日志，不改变逻辑：

export function getAuthBaseUrl(): string {
  const isProduction = process.env.NODE_ENV === "production";
  const nextAuthUrl = process.env.NEXTAUTH_URL;
  const authUrl = process.env.AUTH_URL;

  console.log("[NextAuth][Config] 环境变量快照:", {
    NODE_ENV: process.env.NODE_ENV,
    NEXTAUTH_URL: nextAuthUrl,
    AUTH_URL: authUrl,
    AUTH_TRUST_HOST: process.env.AUTH_TRUST_HOST,
  });

  // 其余逻辑保持 v2 版本的强校验，不要降低校验强度
  // ...
}


要求：

不要削弱 v2 的 HTTPS / 无尾斜杠 / 生产必须配置的校验。

只是在进入函数时，打印一次关键 env 状态，方便以后排查。

✅ Step 2：在 auth 层对 NextAuth 配置做 URL / trustHost 对齐

文件：src/lib/auth.ts

找到 NextAuth 的主配置（大概率类似）：

export const { auth, handlers, signIn, signOut } = NextAuth({
  providers: [/* Google, Line, Twitter 等 */],
  // ...其他配置
});

2.1 显式设置 trustHost，避免“请求 Host”乱入

确认当前配置中是否有 trustHost：

如果 没有，请显式加上：

export const { auth, handlers, signIn, signOut } = NextAuth({
  providers: [/* ... */],
  trustHost: true,
  // ...
});


原因：

在生产环境下，我们希望 NextAuth 信任来自 AUTH_URL / NEXTAUTH_URL 的配置，同时又不依赖随机 preview 域名。

AUTH_URL 已在 Step 1 与 NEXTAUTH_URL 同步，因此只要在 Google 控制台配置的也是 https://ai.zalem.app/api/auth/callback/google，就能保持一致。

如果当前已经有 trustHost，请确认其值是 true，且不要自行手动拼接 base URL。

2.2 增强 Google Provider 的调试日志（仅日志，逻辑不变）

在 Google Provider 配置附近，增加一段详细日志，打印出 我们认为的 redirect URI：

import { getAuthBaseUrl } from "./env"; // 按实际路径调整

const authBaseUrl = getAuthBaseUrl();
const googleCallbackUrl = `${authBaseUrl}/api/auth/callback/google`;

console.log("[NextAuth][Google] 预期的 redirect_uri:", googleCallbackUrl);

export const { auth, handlers, signIn, signOut } = NextAuth({
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
      // 不要手动配置 redirectUri，保持默认行为，由 Auth.js 根据 AUTH_URL 生成
      // 仅保留必要的 scopes / profile / authorization 配置
    }),
    // 其他 providers ...
  ],
  trustHost: true,
  // ...
});


重点：

不要在 Google Provider 里手动写 redirectUri；由 Auth.js/NextAuth 根据 AUTH_URL 自动生成。

我们只通过日志输出“预期值”，帮助你对照 Google 控制台的设置。

✅ Step 3：新增一个只读诊断接口，直接返回服务器视角的 redirect_uri

文件：src/app/api/auth/debug/google-redirect/route.ts（新建）

该接口仅用于你自己调试，建议后续上线前加一层简单保护（例如仅允许特定 email / admin token），当前先以简单版本为主。

// src/app/api/auth/debug/google-redirect/route.ts
import { NextResponse } from "next/server";
import { getAuthBaseUrl } from "@/src/lib/env"; // 按实际路径调整

export async function GET() {
  const authBaseUrl = getAuthBaseUrl();
  const expectedRedirectUri = `${authBaseUrl}/api/auth/callback/google`;

  return NextResponse.json(
    {
      message: "Google OAuth redirect_uri diagnostics",
      NODE_ENV: process.env.NODE_ENV,
      NEXTAUTH_URL: process.env.NEXTAUTH_URL,
      AUTH_URL: process.env.AUTH_URL,
      AUTH_TRUST_HOST: process.env.AUTH_TRUST_HOST,
      expectedRedirectUri,
      note: "请在 Google Cloud Console 中将 expectedRedirectUri 精确加入 Authorized redirect URIs",
    },
    { status: 200 },
  );
}


验证方式：

部署后，用你实际访问的域名打开：

https://ai.zalem.app/api/auth/debug/google-redirect

返回 JSON 中的 expectedRedirectUri 就是服务器眼中要用的 redirect_uri，应该与你在 Google 控制台中的配置 逐字一致。

✅ Step 4：文档 & 执行报告（v3 增量）

文件：

docs/问题修复/Google_OAuth_redirect_uri_mismatch错误/修复指南.md

docs/问题修复/Google_OAuth_redirect_uri_mismatch错误/快速检查清单.md

docs/问题修复/2025-11-27/Google_OAuth_redirect_uri_mismatch错误/执行报告/执行报告.md（在原 v2 执行报告末尾追加 v3 小节）

4.1 在修复指南中新增“v3 补丁说明”小节

新增内容要点：

框架层对齐：

明确写出：

Auth.js v5 推荐使用 AUTH_URL，而此前仅配置了 NEXTAUTH_URL。

v3 已在代码中加入 AUTH_URL ← NEXTAUTH_URL 同步逻辑。

自诊断接口：

文档中给出 GET /api/auth/debug/google-redirect 的说明：

如何访问

如何对照 expectedRedirectUri 与 Google 控制台的设置。

环境变量 checklist 更新：

新增一条：

「（可选推荐）在 Vercel 中同时设置：

NEXTAUTH_URL=https://ai.zalem.app

AUTH_URL=https://ai.zalem.app」

4.2 在快速检查清单中补充两个关键检查点

访问 https://ai.zalem.app/api/auth/debug/google-redirect，确认：

expectedRedirectUri 为：https://ai.zalem.app/api/auth/callback/google；

NEXTAUTH_URL 和 AUTH_URL 一致。

在 Google Cloud Console 中确认 Authorized redirect URIs 包含：

https://ai.zalem.app/api/auth/callback/google（逐字一致）。

4.3 在 v2 执行报告末尾追加 v3 小节（概述即可）

在 v2_执行报告.md 的「结论」或「附录」之后，追加：

v3 改动摘要（本次增加 AUTH_URL 同步、诊断接口、日志增强）。

明确说明：

代码层面已经保证 Auth.js 使用与 NEXTAUTH_URL 一致的 base URL；

下一步的最终判断点是：

诊断接口的 expectedRedirectUri 与 Google 控制台完全一致；

Google 登录不再出现 redirect_uri_mismatch。

✅ Step 5：本次验收标准（写入新的执行报告）

请 Cursor 在新的执行报告（v3）中，至少包含以下人工验证结果：

生产环境环境变量快照（来自日志 + 诊断接口）：

NODE_ENV=production

NEXTAUTH_URL=https://ai.zalem.app

AUTH_URL=https://ai.zalem.app（如果你在 Vercel 也显式设置，就更理想）

诊断接口返回值：

expectedRedirectUri == https://ai.zalem.app/api/auth/callback/google

Google 控制台截图/说明（你自己确认即可，在报告中文字描述）：

已将 https://ai.zalem.app/api/auth/callback/google 加入 Authorized redirect URIs。

实际登录测试：

使用 https://ai.zalem.app 访问应用，点击“Google 登录”：

✅ 不再出现 redirect_uri_mismatch；

✅ 能正常完成 OAuth 流程并返回应用。

🔒 安全提醒（生产必须处理）

你日志中的这条警告：

(node:4) Warning: Setting the NODE_TLS_REJECT_UNAUTHORIZED environment variable to '0' makes TLS connections and HTTPS requests insecure...

说明当前生产环境设置了：NODE_TLS_REJECT_UNAUTHORIZED=0。

这会让所有 HTTPS 请求（包括调 Google）不做证书校验，属于严重安全风险。

这一项无法通过 Cursor 自动修复，需要你在 Vercel / 环境配置里：

删除 NODE_TLS_REJECT_UNAUTHORIZED，或

至少不要在生产环境设置为 0。

建议在 docs/问题修复/Google_OAuth_redirect_uri_mismatch错误/修复指南.md 中也加一句【安全注意事项】，标明生产环境禁止设置此变量为 0。