🧩 任务目标（给 Cursor）

问题ID：NEXTAUTH-ERROR-BADREQUEST-20251127-001
目标：
修复 NextAuth v5 中 /api/auth/error 直接访问返回 400 Bad Request 的问题，使其在以下场景下行为统一、友好：

直接访问 /api/auth/error（无任何参数）
→ 重定向到 /login/error?error=Default，展示默认错误页。

OAuth 登录失败后跳转（NextAuth 内部访问 /api/auth/error?error=Configuration 等）
→ 仍然能够正确落到 /login/error?error=Configuration，并且显示对应错误信息。

⚠️ 注意：

不修改 src/app/api/auth/[...nextauth]/route.ts 中已有的 NextAuth handlers 逻辑。

不修改 src/lib/auth.ts 中现有的 pages.error 配置（仍为 /login/error）

1️⃣ 文件与修改范围

需要涉及的文件（只允许修改/新增这些）：

新增：src/app/api/auth/error/route.ts（新建文件）

修改：src/app/login/error/page.tsx（增强默认错误处理逻辑）

不允许：

删除或改动 src/app/api/auth/[...nextauth]/route.ts 中现有 handlers 导出逻辑。

2️⃣ 具体修改步骤
Step 1：新增自定义错误端点 /api/auth/error

目标：
用更“具体”的路由 app/api/auth/error/route.ts 覆盖 catch-all [...nextauth] 对 /api/auth/error 的处理；所有访问 /api/auth/error 的请求统一重定向到 /login/error，并带上合适的 error 参数。

1.1 新建文件

在 src/app/api/auth/error/route.ts 新建文件，内容如下（TypeScript）：

// src/app/api/auth/error/route.ts
import { NextRequest, NextResponse } from "next/server";

export const dynamic = "force-dynamic";
export const revalidate = 0;
export const fetchCache = "force-no-store";
export const runtime = "nodejs";

/**
 * 自定义 NextAuth 错误端点：
 * - 统一处理所有 /api/auth/error 请求
 * - 没有 error 参数时，使用 "Default" 作为默认错误类型
 * - 始终重定向到 /login/error?error=<type>
 *
 * 这样既兼容 NextAuth v5 的内部调用，又修复直接访问返回 400 的问题。
 */
export function GET(request: NextRequest) {
  const url = new URL(request.url);
  const searchParams = url.searchParams;
  const error = searchParams.get("error") ?? "Default";

  const redirectUrl = new URL("/login/error", url.origin);
  redirectUrl.searchParams.set("error", error);

  return NextResponse.redirect(redirectUrl.toString());
}


要点说明：

使用 dynamic / revalidate / fetchCache / runtime 的设置与 [...nextauth] 保持一致，避免在 Vercel 上出现静态预渲染问题。

路径为 app/api/auth/error/route.ts，其路由优先级会高于 app/api/auth/[...nextauth]/route.ts 对 /api/auth/error 的匹配，只覆盖 error 端点，不影响其他 /api/auth/*。

如果 NextAuth 内部调用 /api/auth/error?error=Configuration，会被该路由捕获并重定向到 /login/error?error=Configuration，逻辑仍然正确。

如果用户直接访问 /api/auth/error，error 为空，则重定向到 /login/error?error=Default，避免 400 Bad Request。

Step 2：增强 /login/error 页面对默认错误的处理

当前错误页面核心逻辑：

function LoginErrorContent() {
  const { t } = useLanguage();
  const searchParams = useSearchParams();
  const error = searchParams.get("error");

  const getErrorMessage = () => {
    switch (error) {
      case "Configuration":
        return "OAuth配置错误，请检查环境变量设置";
      case "AccessDenied":
        return "访问被拒绝，请重试";
      case "Verification":
        return "验证失败，请重试";
      default:
        return error || "登录过程中发生错误";
    }
  };
}


由于我们会传递 "Default" 作为某些场景的默认错误类型，需要确保 "Default" 不会原样展示在页面上。

2.1 修改 getErrorMessage 逻辑

将默认分支改为显式处理 "Default" 以及空值：

  const getErrorMessage = () => {
    switch (error) {
      case "Configuration":
        return "OAuth配置错误，请检查环境变量设置";
      case "AccessDenied":
        return "访问被拒绝，请重试";
      case "Verification":
        return "验证失败，请重试";
      case "Default":
      case null:
      case "":
        return "登录过程中发生错误，请稍后重试";
      default:
        // 兜底：展示 error code，方便调试
        return `登录过程中发生错误（错误代码：${error}）`;
    }
  };


如果有多语言 t 函数可用，可以在这一步一并替换成对应的多语言 key，但本次任务 不强制要求改动文案多语言化，以免引入额外改动范围。

3️⃣ 自测 / 验证用例

请在本地 dev 模式下完成以下自测（pnpm dev）：

直接访问错误端点（原问题场景）

打开浏览器访问：http://localhost:3000/api/auth/error

预期：

不再返回 400 / "Bad Request"

浏览器被重定向到：/login/error?error=Default

页面文案显示为“登录过程中发生错误，请稍后重试”（或上述设定的默认文案）

带 error 参数访问错误端点

访问：http://localhost:3000/api/auth/error?error=Configuration

预期：

被重定向到：/login/error?error=Configuration

页面显示 “OAuth配置错误，请检查环境变量设置”

模拟 OAuth 失败跳转（如配置错误时）

保持现有 NextAuth 配置不变（不在本任务修改）

在登录页面点击对应 Provider（如配置暂时不正确时会触发错误）

预期：

NextAuth 仍然会构造 /api/auth/error?error=Configuration

请求被我们新路由捕获并重定向到 /login/error?error=Configuration

页面展示与用例 2 一致

确认不影响其他 Auth 路由

访问：/api/auth/session、/api/auth/providers 等接口

预期：

行为与修复前一致，正常返回，不受本次改动影响

4️⃣ 执行报告要求（让 Cursor 最后输出）

请在完成改动后，输出一段简短的“执行报告”，包含以下内容：

变更摘要

新增了 src/app/api/auth/error/route.ts，实现统一重定向逻辑

更新了 src/app/login/error/page.tsx 的 getErrorMessage，支持 "Default" 和兜底错误文案

受影响路由

/api/auth/error：由 NextAuth 默认 400 改为 HTTP 302 → /login/error?error=...

/login/error：默认错误 message 行为变化

自测结果

列表形式说明上述 4 条用例是否全部通过（通过/失败 + 简要说明）