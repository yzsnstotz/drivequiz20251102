🧩 任务背景与目标

问题：NextAuth v5 在生产环境（Vercel）中，/api/auth/session 和 /api/auth/providers 均返回 400 Bad Request，导致所有登录功能失效。

根因分析：
1）NEXTAUTH_SECRET / AUTH_SECRET / NEXTAUTH_URL / AUTH_URL 等环境变量可能未正确设置；
2）Auth v5 推荐使用 AUTH_* 命名，但当前代码仅使用 NEXTAUTH_SECRET 作为 secret，未兜底 AUTH_SECRET。

目标：
1）修复生产环境 400 错误，使 /api/auth/session / /api/auth/providers 正常返回 200；
2）统一处理 NEXTAUTH_* 与 AUTH_* 环境变量，增加启动时的配置校验与日志；
3）在不改动数据库结构的前提下，保留 session.strategy: "database" 与 Kysely + PostgreSQL 的现有架构。

⚠️ 本任务只允许修改 Next.js 应用内的认证相关文件：

src/app/api/auth/[...nextauth]/route.ts

src/lib/auth.ts

（可选）src/lib/env.ts 新增环境变量工具
严禁修改数据库结构、ai-service、题库相关逻辑。

一、需要人工在 Vercel 设置 / 校验的环境变量（给人看的，Cursor 只需在说明中提及）

请在 Vercel 项目中 手动 确认并设置：

至少满足以下之一（推荐两组都设）：

AUTH_SECRET（Auth.js v5 推荐）

NEXTAUTH_SECRET（兼容旧版本）

至少满足以下之一（推荐两组都设）：

AUTH_URL（Auth.js v5 推荐）

NEXTAUTH_URL（兼容旧版本）

数据库连接（保持现状，不在本次任务中修改）：

DATABASE_URL 或 POSTGRES_URL 已正确指向 Supabase/Postgres，并支持 SSL。

Cursor 不需要也无法操作 Vercel 控制台，只需在代码中对这些变量做兜底与校验。

二、代码修改范围

必须修改的文件：

src/lib/auth.ts

src/app/api/auth/[...nextauth]/route.ts

可选新增文件（建议）：

src/lib/env.ts —— 统一封装 getAuthConfigFromEnv，降低重复逻辑。

三、具体修改指令
1. 新增环境变量工具：src/lib/env.ts

如果项目中已有类似 env 工具文件，则在原文件中追加；否则新建。

操作指令：

新建文件 src/lib/env.ts（若已存在则合并逻辑），内容如下：

// src/lib/env.ts

type AuthEnvConfig = {
  secret: string;
  url: string;
};

export function getAuthEnvConfig(): AuthEnvConfig {
  const secret =
    process.env.NEXTAUTH_SECRET ??
    process.env.AUTH_SECRET ??
    "";

  const url =
    process.env.NEXTAUTH_URL ??
    process.env.AUTH_URL ??
    "";

  if (process.env.NODE_ENV === "production") {
    if (!secret) {
      console.error(
        "[NextAuth][Config] ❌ Auth secret is missing. Please set NEXTAUTH_SECRET or AUTH_SECRET in Vercel env."
      );
    }

    if (!url) {
      console.error(
        "[NextAuth][Config] ❌ Auth URL is missing. Please set NEXTAUTH_URL or AUTH_URL in Vercel env."
      );
    }
  }

  return { secret, url };
}


注意：这里只做「日志告警 + 返回空字符串」，不在工具函数中直接抛异常，避免构建阶段崩溃。真正的行为由 NextAuth 处理。

2. 调整 NextAuth 配置：src/lib/auth.ts

目标：

统一使用 getAuthEnvConfig() 提供的 secret；

保留 session.strategy: "database" 和现有 adapter；

增加 trustHost 配置，让 Auth.js 在生产环境正确识别 AUTH_URL / NEXTAUTH_URL。

操作指令：

在文件顶部引入 getAuthEnvConfig：

// src/lib/auth.ts
import { getAuthEnvConfig } from "@/lib/env";

// 在其他 import 之后，紧接着解析 env
const { secret: authSecret, url: authUrl } = getAuthEnvConfig();


在 authOptions: NextAuthConfig 定义中，做如下修改：

找到原来的：

export const authOptions: NextAuthConfig = {
  adapter: createPatchedKyselyAdapter(db),
  debug: process.env.NODE_ENV === "development",
  // ...
  session: {
    strategy: "database", // 使用数据库session策略
  },
  secret: process.env.NEXTAUTH_SECRET,
  // ...
};


修改为（注意字段顺序可保持接近原逻辑）：

export const authOptions: NextAuthConfig = {
  adapter: createPatchedKyselyAdapter(db),
  debug: process.env.NODE_ENV === "development",

  // ✅ 让 Auth.js 根据 AUTH_URL / NEXTAUTH_URL 正确推断 host
  trustHost: true,

  // ✅ 保留数据库 session 策略
  session: {
    strategy: "database",
  },

  // ✅ secret 同时兼容 NEXTAUTH_SECRET 与 AUTH_SECRET
  secret: authSecret || undefined,

  // 其余 providers / callbacks / pages 配置保持不变
  // ...
};


关键点：

使用 authSecret || undefined，如果没配置就让 Auth.js 自己处理并给出更明确的错误；

trustHost: true 对 Vercel + App Router + Auth v5 是推荐配置。

3. 优化 NextAuth 路由：src/app/api/auth/[...nextauth]/route.ts

当前文件已经做了动态路由声明和基础环境变量检查，但仍然出现 400。

需要做两点优化：

把环境变量检查逻辑与 getAuthEnvConfig 对齐，避免重复判断。

增加一层统一错误日志（不要吞掉 NextAuth 的错误，只在外层补充上下文）。

操作指令：

更新 import：

// src/app/api/auth/[...nextauth]/route.ts

import NextAuth from "next-auth";
import { authOptions } from "@/lib/auth";
import { getAuthEnvConfig } from "@/lib/env";


替换原有生产环境下的环境变量检查代码块：

找到原来的：

if (process.env.NODE_ENV === "production") {
  if (!process.env.NEXTAUTH_SECRET && !process.env.AUTH_SECRET) {
    console.error("[NextAuth] ❌ NEXTAUTH_SECRET 或 AUTH_SECRET 未设置");
  }

  if (!process.env.NEXTAUTH_URL && !process.env.AUTH_URL) {
    console.error("[NextAuth] ❌ NEXTAUTH_URL 或 AUTH_URL 未设置");
  }
}


替换为：

if (process.env.NODE_ENV === "production") {
  const { secret, url } = getAuthEnvConfig();

  if (!secret) {
    console.error(
      "[NextAuth][Route] ❌ Auth secret missing. Please set NEXTAUTH_SECRET or AUTH_SECRET."
    );
  }

  if (!url) {
    console.error(
      "[NextAuth][Route] ❌ Auth URL missing. Please set NEXTAUTH_URL or AUTH_URL."
    );
  }
}


对 handlers 增加一层轻量的错误日志包装（不要改变返回结构，仅用于增加上下文）：

找到：

const { handlers } = NextAuth(authOptions);

export const { GET, POST } = handlers;


修改为：

const { handlers } = NextAuth(authOptions);

export const GET = async (req: Request) => {
  try {
    return await handlers.GET!(req);
  } catch (error) {
    console.error("[NextAuth][GET] Unhandled error in /api/auth route:", error);
    throw error;
  }
};

export const POST = async (req: Request) => {
  try {
    return await handlers.POST!(req);
  } catch (error) {
    console.error("[NextAuth][POST] Unhandled error in /api/auth route:", error);
    throw error;
  }
};


注意：

保留原有 NextAuth handlers 行为，不自定义 Response；

仅在服务器控制台增加上下文日志，便于后续诊断。

四、禁止修改 / 必须保持不变的内容

数据库结构与连接逻辑

不修改任何 SQL / Supabase 表结构。

不调整 src/lib/db.ts 中的连接池配置与 SSL 设置。

业务模块

不修改题库、积分、AI 调用、批量处理、ai-service 等任何其他模块代码。

路由层职责

除上述错误日志包装外，不在路由层写业务逻辑，仅做请求转发和最小必要的校验（A1 原则）。

五、验证步骤（提交前必须自测）

请在本地与 Vercel 环境中至少完成以下验证：

本地开发环境

1）确保 .env.local 中配置了以下至少一组变量（可用占位值）：

AUTH_SECRET or NEXTAUTH_SECRET

AUTH_URL=http://localhost:3000 或 NEXTAUTH_URL=http://localhost:3000

2）启动 dev：

pnpm dev


3）在浏览器中访问 /login（或使用登录入口页面），打开开发者工具：

请求 GET /api/auth/session 返回 200；

请求 GET /api/auth/providers 返回 200 且包含配置的 provider 列表。

Vercel 预览环境

1）确认 Vercel 环境变量已正确设置（由人完成）；
2）触发部署后，在预览 URL 中重复上述测试；
3）从 Vercel 日志中确认：

不再出现 /api/auth/session 400；

如果环境变量缺失，应看到清晰的 [NextAuth][Config] / [NextAuth][Route] 日志提示。

六、执行报告要求（给 Cursor）

提交本次任务时，请在「执行报告」中至少包含：

变更文件列表：

src/lib/env.ts（新增或修改）

src/lib/auth.ts

src/app/api/auth/[...nextauth]/route.ts

关键代码片段对比（修改前 / 修改后简要对照）。

本地验证结果：

/api/auth/session 与 /api/auth/providers 在本地是否返回 200；

如果返回非 200，请贴出完整响应与控制台错误。

风险评估：

是否影响现有用户数据；

是否改变了 session 存储策略（应保持为 "database"）。