ç»™ Cursor çš„ä¸€æ¬¡æ€§ä¿®å¤æŒ‡ä»¤ï¼ˆlicense_type_tag æ— æ³•å†™å…¥é—®é¢˜ï¼‰

æœ¬æŒ‡ä»¤ä»…é’ˆå¯¹ ä¸»æœåŠ¡ / admin question-processing é“¾è·¯ï¼Œä¸å…è®¸ä¿®æ”¹ ai-serviceã€ai-core ç›¸å…³ä»£ç ã€‚å¦‚ç¡®æœ‰ AI Prompt / åœºæ™¯éœ€è¦è°ƒæ•´ï¼Œåªåœ¨æ‰§è¡ŒæŠ¥å‘Šæœ€åæå‡ºå»ºè®®ï¼Œä¸ç›´æ¥æ”¹åŠ¨ AI ä¾§ä»£ç ã€‚
å‚è€ƒæ–‡æ¡£å’Œç»“æ„è§ DriveQuiz ä»£ç ç»“æ„è¯´æ˜ä¸é—®é¢˜è¯Šæ–­æŠ¥å‘Šã€‚

æ­¥éª¤ 0ï¼šè§„èŒƒå¯¹é½è¯´æ˜ï¼ˆç”± Cursor è‡ªåŠ¨è¡¥ä¸€å¥å³å¯ï¼‰

å·²é˜…è¯»å¹¶éµå®ˆä»¥ä¸‹è§„èŒƒ/æ–‡æ¡£ï¼ˆåªéœ€åœ¨æ‰§è¡ŒæŠ¥å‘Šä¸­åˆ—å‡ºï¼Œä¸è¦é‡å¤ç²˜è´´å†…å®¹ï¼‰ï¼š

ã€Šæ•°æ®åº“ç»“æ„_DRIVEQUIZ.mdã€‹

ã€Šæ–‡ä»¶ç»“æ„.mdã€‹

ã€ŠğŸ§© AI æœåŠ¡ç ”å‘è§„èŒƒï¼ˆai-service ç»Ÿä¸€æ¶æ„è§„èŒƒ v1.0ï¼‰.mdã€‹

ã€ŠğŸ§© AI æ ¸å¿ƒæœåŠ¡è§„èŒƒï¼ˆai-core ç»Ÿä¸€æ¶æ„è§„èŒƒ v2.0ï¼‰.mdã€‹

ã€ŠDriveQuiz & AI-Service ä»£ç ç»“æ„è¯´æ˜ v1.5ã€‹

æœ¬æ¬¡ä¿®æ”¹èŒƒå›´ä»…é™ï¼š

src/app/api/admin/question-processing/_lib/batchProcessUtils.ts

src/lib/questionDb.ts

src/app/api/admin/question-processing/batch-process/route.ts

ä¸å¾—ä¿®æ”¹ä»»ä½• ai-service / ai-core ç›¸å…³ä»£ç ã€‚

æ­¥éª¤ 1ï¼šè¡¥é½ license_type_tag å…¨é“¾è·¯è°ƒè¯•æ—¥å¿—ï¼ˆå®šä½ä¸¢å¤±ç‚¹ï¼‰

ä¿®æ”¹æ–‡ä»¶ï¼šsrc/app/api/admin/question-processing/_lib/batchProcessUtils.tsã€src/lib/questionDb.ts

åœ¨ sanitizeAiPayload å†…éƒ¨ï¼Œåœ¨å¯¹ sanitized.tags.license_type_tag èµ‹å€¼åï¼Œå¢åŠ ä¸€æ¡ debug æ—¥å¿—ï¼ˆä½¿ç”¨é¡¹ç›®å†…ç°æœ‰ logger å·¥å…·ï¼Œè€Œä¸æ˜¯ console.logï¼‰ï¼š

logger.debug(
  "[question-processing] sanitizeAiPayload license_type_tag",
  { licenseTypeTagRaw: aiResult.tags?.licenseTypeTag ?? aiResult.tags?.license_type_tag, sanitizedLicenseTypeTag: sanitized.tags?.license_type_tag }
);


åœ¨ buildFullPipelineDbPayload å‡½æ•°ä¸­ï¼Œå¤„ç†å®Œ payload.license_type_tag åå¢åŠ æ—¥å¿—ï¼š

logger.debug(
  "[question-processing] buildFullPipelineDbPayload license_type_tag",
  { rawLicenseTypeTag: rawTags.license_type_tag, payloadLicenseTypeTag: payload.license_type_tag }
);


åœ¨ saveQuestionToDb ä¸­ï¼Œæ¸…æ´— license_type_tag å‰åå„æ‰“ä¸€æ¡æ—¥å¿—ï¼š

logger.debug("[questionDb] saveQuestionToDb input license_type_tag", {
  questionId: cleanedQuestion.id,
  inputLicenseTypeTag: (cleanedQuestion as any).license_type_tag,
  inputLegacyLicenseTags: (cleanedQuestion as any).license_tags ?? null,
});

// æ¸…æ´—å®Œ updateData.license_type_tag ä¹‹å
logger.debug("[questionDb] saveQuestionToDb updateData license_type_tag", {
  questionId: cleanedQuestion.id,
  updateLicenseTypeTag: (updateData as any).license_type_tag ?? null,
});


åœ¨ processFullPipelineBatch ä¸­ï¼Œæ„é€  dbPayload åï¼ˆä¹Ÿå°±æ˜¯å‡†å¤‡è°ƒç”¨ saveQuestionToDb ä¹‹å‰ï¼‰ï¼Œå¢åŠ æ—¥å¿—ï¼š

logger.debug("[processFullPipelineBatch] dbPayload license_type_tag", {
  questionId,
  licenseTypeTag: dbPayload.license_type_tag ?? null,
});


ç›®çš„ï¼šç¡®ä¿ä» aiResult â†’ sanitized.tags â†’ dbPayload â†’ saveQuestionToDb è¾“å…¥ â†’ updateData æ•´æ¡é“¾è·¯éƒ½æœ‰æ˜ç¡®æ—¥å¿—ï¼Œä»¥éªŒè¯å…·ä½“ä¸¢å¤±ç‚¹ã€‚

æ­¥éª¤ 2ï¼šç»Ÿä¸€ & åŠ å¼º tags å­—æ®µæ„å»ºé€»è¾‘ï¼ˆé¿å…å‘½ååˆ†è£‚ï¼‰

ä¿®æ”¹æ–‡ä»¶ï¼šsrc/app/api/admin/question-processing/_lib/batchProcessUtils.ts

2.1 ç¡®è®¤å¹¶æ”¶ç´§ sanitizeAiPayload é€»è¾‘

åœ¨ sanitizeAiPayload é‡Œï¼Œç¡®ä¿å¯¹ license_type_tag çš„å¤„ç†é€»è¾‘æ»¡è¶³ï¼š

è¾“å…¥æ¥æºï¼š

const licenseTypeTagRaw = aiResult.tags.licenseTypeTag ?? aiResult.tags.license_type_tag;


æ”¯æŒï¼š

æ•°ç»„ï¼š["ORDINARY", "MEDIUM"]

å•å­—ç¬¦ä¸²ï¼š"ORDINARY"

è¾“å‡ºç»Ÿä¸€ä¸º éç©ºå­—ç¬¦ä¸²æ•°ç»„ï¼Œå­—æ®µåå¿…é¡»ä¸º sanitized.tags.license_type_tagï¼š

if (Array.isArray(licenseTypeTagRaw)) {
  const cleaned = licenseTypeTagRaw
    .filter((t: any) => typeof t === "string" && t.trim().length > 0)
    .map((t: string) => t.trim());
  if (cleaned.length > 0) {
    sanitized.tags.license_type_tag = cleaned;
  }
} else if (typeof licenseTypeTagRaw === "string" && licenseTypeTagRaw.trim().length > 0) {
  sanitized.tags.license_type_tag = [licenseTypeTagRaw.trim()];
}


æ³¨æ„ï¼šä¸è¦å†ä½¿ç”¨ license_type_tagsï¼ˆå¤æ•°ï¼‰ç­‰å†å²å‘½åï¼Œå…¨éƒ¨ç»Ÿä¸€åˆ° license_type_tagï¼ˆå•æ•°ï¼Œæ•°ç»„ç±»å‹ï¼‰ã€‚

åŒæ ·ç¡®è®¤ stage_tagã€topic_tags çš„å¤„ç†é€»è¾‘ä¸ diagnostic ä¸­çš„ä»£ç ä¸€è‡´ï¼Œä¸è¦æ”¹åŠ¨è¯­ä¹‰ï¼Œåªä¿è¯å­—æ®µåç»Ÿä¸€ã€‚

2.2 buildFullPipelineDbPayload åªæ¶ˆè´¹ license_type_tagï¼ˆæ•°ç»„ï¼‰

åœ¨ buildFullPipelineDbPayload å‡½æ•°ä¸­ï¼Œä¿è¯é€»è¾‘å¦‚ä¸‹ï¼š

// rawTags ä¸º sanitizeAiPayload çš„è¾“å‡º
if (Array.isArray(rawTags.license_type_tag) && rawTags.license_type_tag.length > 0) {
  payload.license_type_tag = rawTags.license_type_tag;
} else {
  // ä¸è¦ä»ä»»ä½• legacy å­—æ®µæ¨æ–­ï¼Œé¿å…å¼•å…¥å™ªéŸ³ï¼›legacy å…¼å®¹æ”¾åœ¨ saveQuestionToDb åš
}


ç¡®ä¿è¿™é‡Œä¸å†è®¿é—® license_type_tags / licenseTags ç­‰å…¶ä»–å­—æ®µã€‚

æ­¥éª¤ 3ï¼šé‡æ„ saveQuestionToDb æ”¯æŒäº‹åŠ¡ & åˆç†æ¸…æ´— license_type_tag

ä¿®æ”¹æ–‡ä»¶ï¼šsrc/lib/questionDb.ts

3.1 å‡½æ•°ç­¾åæ”¹é€ ï¼šå¯æ¥æ”¶äº‹åŠ¡è¿æ¥

å°† saveQuestionToDb ç­¾åä»ï¼š

export async function saveQuestionToDb(question: SomeType) { ... }


æ”¹ä¸ºï¼š

import type { Kysely, Transaction } from "kysely";
import type { DB } from "./db"; // æŒ‰é¡¹ç›®å®é™…ç±»å‹å¯¼å…¥

export async function saveQuestionToDb(
  question: SomeType,
  options?: { dbOrTrx?: Kysely<DB> | Transaction<DB> }
) {
  const client = options?.dbOrTrx ?? db; // db ä¸ºå…¨å±€å®ä¾‹
  // ä¸‹æ–‡æ‰€æœ‰æ•°æ®åº“æ“ä½œç»Ÿä¸€ä½¿ç”¨ client
}


æ–‡ä»¶å†…éƒ¨æ‰€æœ‰ db è°ƒç”¨ç»Ÿä¸€æ”¹ç”¨ clientï¼ŒåŒ…æ‹¬ update, insert, select ç­‰ã€‚

è¿™æ ·æ—¢å…¼å®¹åŸæœ‰è°ƒç”¨ï¼ˆä¸ä¼  options æ—¶ä»ç”¨å…¨å±€ dbï¼‰ï¼Œä¹Ÿå…è®¸äº‹åŠ¡å†…å®‰å…¨è°ƒç”¨ã€‚

3.2 license_type_tag æ¸…æ´—é€»è¾‘ä¿®æ­£

åœ¨ saveQuestionToDb å†…éƒ¨ï¼Œå¯¹ license_type_tag çš„å¤„ç†ä¿æŒ å®½æ¾æ¥æ”¶ + ä¸¥æ ¼è¾“å‡ºï¼š

if ((cleanedQuestion as any).license_type_tag !== null && (cleanedQuestion as any).license_type_tag !== undefined) {
  let tags = (cleanedQuestion as any).license_type_tag;

  // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œè½¬ä¸ºå•å…ƒç´ æ•°ç»„
  if (typeof tags === "string") {
    tags = [tags];
  }

  if (Array.isArray(tags)) {
    const cleanedLicenseTypeTag = tags
      .filter((tag: any) => typeof tag === "string" && tag.trim() !== "")
      .map((tag: string) => tag.trim());

    (updateData as any).license_type_tag = cleanedLicenseTypeTag.length > 0 ? cleanedLicenseTypeTag : null;
  } else {
    (updateData as any).license_type_tag = null;
  }
}


å¹¶ä¿ç•™ä¹‹å‰å¯¹ legacy å­—æ®µ license_tags çš„å…¼å®¹é€»è¾‘ï¼Œä½†æ³¨æ„åªä½œä¸º å…œåº•ï¼š

if (
  (updateData as any).license_type_tag == null &&
  Array.isArray((cleanedQuestion as any).license_tags) &&
  (cleanedQuestion as any).license_tags.length > 0
) {
  const cleanedLegacy = (cleanedQuestion as any).license_tags
    .filter((tag: any) => typeof tag === "string" && tag.trim() !== "")
    .map((tag: string) => tag.trim());

  (updateData as any).license_type_tag = cleanedLegacy.length > 0 ? cleanedLegacy : null;
}

æ­¥éª¤ 4ï¼šåœ¨ processFullPipelineBatch ä¸­ä½¿ç”¨äº‹åŠ¡è¿æ¥è°ƒç”¨ saveQuestionToDb

ä¿®æ”¹æ–‡ä»¶ï¼šsrc/app/api/admin/question-processing/_lib/batchProcessUtils.ts

åœ¨ processFullPipelineBatch é‡Œï¼Œå½“å‰æœ‰ç±»ä¼¼ä»£ç ï¼ˆä¼ªä»£ç ï¼ŒæŒ‰å®é™…ç»“æ„è°ƒæ•´ï¼‰ï¼š

await db.transaction().execute(async (trx) => {
  // ...
  await saveQuestionToDb(updatedQuestion); // âš ï¸ å½“å‰ç›´æ¥ç”¨å…¨å±€ db
  // ...
});


å°†è°ƒç”¨æ”¹æˆä¼ å…¥ trxï¼š

await db.transaction().execute(async (trx) => {
  // ...
  await saveQuestionToDb(updatedQuestion, { dbOrTrx: trx });
  // ...
});


æœç´¢æ•´ä¸ªé¡¹ç›®ä¸­ saveQuestionToDb( è°ƒç”¨ç‚¹ï¼š

è‹¥åœ¨äº‹åŠ¡å†…ï¼Œç»Ÿä¸€æ”¹ä¸ºä¼ å…¥ { dbOrTrx: trx }

è‹¥ä¸åœ¨äº‹åŠ¡å†…ï¼Œä¿æŒä¸ä¼  options å³å¯

è¿™æ ·æ—¢ä¿®å¤äº†â€œäº‹åŠ¡å†…éƒ¨å´ç”¨å…¨å±€ dbâ€ çš„æ½œåœ¨ä¸€è‡´æ€§é—®é¢˜ï¼Œä¹Ÿé¿å…æœªæ¥ç±»ä¼¼å­—æ®µåªå†™äº†ä¸€åŠçš„æƒ…å†µã€‚

æ­¥éª¤ 5ï¼šç¡®è®¤ category_tags æ“ä½œä¹Ÿèµ°ç»Ÿä¸€ tags é“¾è·¯

ä¿®æ”¹æ–‡ä»¶ï¼šsrc/app/api/admin/question-processing/batch-process/route.ts

æ‰¾åˆ° category_tags æ“ä½œå¤„ç†é€»è¾‘ï¼ˆå¤§çº¦åœ¨ 2275-2434 è¡Œï¼‰ã€‚ç¡®è®¤å…¶ä½¿ç”¨æµç¨‹ä¸ºï¼š

ä» AI è¿”å›ç»“æœä¸­è·å–åŸå§‹ aiResult

ç»è¿‡ç»Ÿä¸€çš„ normalizeAIResult / sanitizeAiPayload å¤„ç†

æœ€ç»ˆé€šè¿‡åŒä¸€å¥— buildFullPipelineDbPayload / saveQuestionToDb å†™å…¥æ•°æ®åº“

å¦‚æœå½“å‰ category_tags ä»ç„¶ç›´æ¥ä½¿ç”¨åŸå§‹ AI è¿”å›å€¼ï¼ˆä¾‹å¦‚ç›´æ¥ä» generateCategoryAndTags è¿”å›ç»“æ„ä¸­å–å­—æ®µï¼‰ï¼Œåˆ™å¼ºåˆ¶æ”¹ä¸ºï¼š

const normalized = normalizeAIResult(rawAiResult);
const sanitized = sanitizeAiPayload(normalized);
const dbPayload = buildFullPipelineDbPayload({
  // è¿™é‡Œä¿æŒä¸ full_pipeline ç›¸åŒçš„å…¥å‚ç»“æ„
});

await saveQuestionToDb({ ...existingQuestion, ...dbPayload }, { dbOrTrx: trx });


ç¡®ä¿ category_tags è·¯å¾„ä¸‹æœ€ç»ˆä¹Ÿæ˜¯é€šè¿‡ license_type_tag å­—æ®µå†™å…¥ questions è¡¨ï¼Œä¸å­˜åœ¨å•ç‹¬å†™ license_tags çš„åˆ†æ”¯ã€‚

æ­¥éª¤ 6ï¼šæ‰§è¡ŒåéªŒè¯ & æ‰§è¡ŒæŠ¥å‘Šè¦æ±‚

å®Œæˆä»¥ä¸Šä»£ç æ”¹åŠ¨åï¼ŒCursor å¿…é¡»æ‰§è¡Œä»¥ä¸‹è‡ªæ£€å¹¶åœ¨æ‰§è¡ŒæŠ¥å‘Šä¸­å†™æ¸…æ¥šï¼š

æ„å»ºæ£€æŸ¥

æœ¬åœ°è¿è¡Œ pnpm lint / pnpm buildï¼ˆæŒ‰é¡¹ç›®ç°æœ‰è„šæœ¬ï¼‰ç¡®ä¿æ— ç±»å‹é”™è¯¯ä¸æ„å»ºé”™è¯¯ã€‚

åŠŸèƒ½éªŒè¯ï¼ˆæ‰‹å·¥ï¼‰

åœ¨æœ¬åœ°æˆ– staging ç¯å¢ƒåˆ›å»ºä¸€ä¸ªä»…å«å°‘æ•°é¢˜ç›®çš„æ‰¹é‡ä»»åŠ¡ï¼Œæ“ä½œç±»å‹ä¸ºï¼š

full_pipeline

category_tags

äººä¸ºæ„é€ ä¸€ä¸ª AI å“åº”ä¸­ licenseTypeTag åŒ…å« 2 ä¸ªå€¼ï¼ˆä¾‹å¦‚ ["ORDINARY", "MEDIUM"]ï¼‰çš„æ ·ä¾‹é¢˜ã€‚

æ‰§è¡Œä»»åŠ¡åï¼ŒæŸ¥è¯¢å¯¹åº”é¢˜ç›®ï¼š

SELECT id, license_type_tag, stage_tag, topic_tags
FROM questions
WHERE id = <æµ‹è¯•é¢˜ ID>;


ç¡®è®¤ï¼š

license_type_tag ä¸ºéç©ºæ•°ç»„ï¼ŒåŒ…å« AI è¿”å›å€¼ï¼ˆå¤§å°å†™å¯ä»¥åç»­å†ç»Ÿä¸€ï¼‰

stage_tagã€topic_tags ä»ç„¶æ­£å¸¸å†™å…¥

æ—¥å¿—éªŒè¯

åœ¨æ—¥å¿—ä¸­æˆªå–åŒä¸€é¢˜ç›®ä»ï¼š

sanitizeAiPayload license_type_tag

buildFullPipelineDbPayload license_type_tag

processFullPipelineBatch dbPayload license_type_tag

saveQuestionToDb input/update license_type_tag

ç¡®è®¤å­—æ®µåœ¨è¿™äº›ç¯èŠ‚å‡ä¸ä¸º null / ä¸¢å¤±ï¼Œå¹¶å°†ä¸€æ¡å®Œæ•´é“¾è·¯æ—¥å¿—ç²˜è´´åˆ°æ‰§è¡ŒæŠ¥å‘Šä¸­ã€‚

AI æ¨¡å—æ³¨æ„äº‹é¡¹è¯´æ˜

å¦‚æœåœ¨è°ƒè¯•è¿‡ç¨‹ä¸­å‘ç° AI è¿”å›æ ¼å¼ä¸è§„èŒƒä¸ä¸€è‡´ï¼ˆä¾‹å¦‚ prompt ä¸­ä»è¦æ±‚ä¸‹åˆ’çº¿å‘½åï¼Œä½†å®é™…è¿”å›é©¼å³°ï¼‰ï¼Œåªåœ¨æ‰§è¡ŒæŠ¥å‘Šçš„ ã€Œåç»­å»ºè®®ã€ å°èŠ‚ä¸­è¯´æ˜ï¼š

éœ€è¦åœ¨ ai-service / åœºæ™¯é…ç½®ä¸­ç»Ÿä¸€ tags å­—æ®µå‘½å

ä¸ç›´æ¥ä¿®æ”¹ä»»ä½• ai-service æˆ– ai-core çš„ä»£ç ã€‚