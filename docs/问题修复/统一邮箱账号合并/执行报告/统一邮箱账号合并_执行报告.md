# 任务摘要
- 目标：解决同一邮箱在不同第三方登录下创建多个 `users.id` 的问题，实现「同一 email → 同一 user.id → 多个 OAuth 账号」。
- 范围：仅修改 Next.js 主服务的认证与用户系统；不改动 ai-core / ai-service。
- 成果：完成 Provider 配置、回调标记、绑定邮箱页面与接口、全局跳转、事务性用户合并，并更新版本时间。

# 修改文件列表
- `src/lib/auth.ts`
- `src/components/AuthGuard.tsx`
- `src/app/login/bind-email/page.tsx`
- `src/app/api/auth/bind-email/route.ts`
- `src/lib/version.ts`

# 规范对齐检查摘要
1. 已读取规范文件：文件结构.md、数据库结构_DRIVEQUIZ.md、AI 服务研发规范 v1.0、AI 核心服务规范 v2.0、AI板块整体架构说明、修复指令头 v5.2
2. 约束适用：A1/A4、B1/B2/B3/B4、D1/D2、E1–E10、F1–F5
3. 强关联条款：A1（路由瘦层）、B3（Kysely类型对齐）、E1/E3/E4/E7/E8（反冗余与最小变更）、F1（AI模块禁止修改）
4. 本次修改路径：见“修改文件列表”
5. 数据库/文件结构影响：未改动表结构；遵循现有 `users`/`oauth_accounts` 等表设计；未需更新结构文档

# 红线自检（A1–E10）
- A1 路由瘦层：已遵守（业务放在 `lib` 与服务模块，路由仅分发）
- A2/A3/A4：不适用（本任务非 AI 场景，未触及 API 结构）
- B1：不适用（无字段/表结构修改）
- B2：不适用（无文件结构迁移）
- B3：已遵守（Kysely 类型与 `数据库结构_DRIVEQUIZ.md` 一致）
- B4：已遵守（未新增隐形字段）
- C1–C3：不适用（非 AI 双环境测试）
- D1：已生成完整执行报告
- D2：每条红线标注状态已完成
- E1：新增绑定逻辑同时清理 Twitter 的危险邮箱自动合并（避免误合并）
- E2：已遵守（无多版本共存）
- E3：已遵守（唯一实现放在统一入口与服务层）
- E4：引用点更新检查：更新引用数量 2；遗留引用数量 0
- E5：已清理无关调试与未使用代码（仅最小增量变更）
- E6：未新增未被引用代码
- E7：已遵守（最小变更集）
- E8：已遵守（精确 Patch 范围）
- E9：已遵守（未增加不必要 DB/AI 请求）
- E10：冗余检测：无重复逻辑；旧入口无残留；请求次数未增加

# AI 模块边界自检（F1–F5）
- 是否修改 ai-core/ai-service/local-ai-service：NO
- 是否新增与 AI 相关的本地逻辑：NO
- 是否绕过 ai-core 的自定义 AI 调用：NO
- 是否需要 AI 协同调整建议：NO

# 迁移脚本（如有）
- 本次未新增结构迁移脚本；接口已支持事务性用户合并。
- 建议后续新增一次性合并脚本：`scripts/merge_users_by_email.ts`（扫描同邮箱的重复用户并迁移从属记录）。

# 数据库与文件结构文档
- 未涉及表结构改动，`数据库结构_DRIVEQUIZ.md` 无需更新。
- 未发生文件结构迁移，`文件结构.md` 无需更新。

# 冗余检测报告
- 是否存在重复逻辑：NO
- 是否清理所有旧逻辑：YES（禁用 Twitter 的危险邮箱自动合并）
- 是否存在未引用新增代码：NO
- 是否减少不必要请求：YES（跳转与接口仅在必要路径触发）

# 风险点与下一步建议
- 风险：绑定接口在高并发下需确保唯一邮箱约束与事务一致性；当前采用单事务迁移可保障一致性。
- 建议：补充前端输入校验与后端速率限制；编写历史数据一键合并脚本并在测试环境验证。

# 版本号
- 已更新 `src/lib/version.ts` 中 `BUILD_TIME = "2025-12-06 23:00:00"`

