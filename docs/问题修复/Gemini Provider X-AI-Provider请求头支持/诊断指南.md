# Gemini Provider 500 错误诊断指南

## 问题现象
选择 gemini（通过 render）时返回 500 错误：
```
AI service error: 500 {"ok":false,"errorCode":"INTERNAL_ERROR","message":"Internal Server Error"}
```

## 诊断步骤

### 1. 检查浏览器控制台日志

打开浏览器开发者工具（F12），查看 Console 标签页，查找以下日志：

#### 1.1 检查配置读取日志
查找包含 `[getCurrentAiProvider]` 的日志：
```
[getCurrentAiProvider] 获取配置: {
  dbProvider: "gemini",  // ✅ 应该是 "gemini"
  provider: "render",
  hasDbProvider: true
}
```

**如果 `dbProvider` 为 `null` 或 `undefined`**：
- 检查 `/api/ai/config` API 是否正常返回
- 检查数据库中 `ai_config` 表的 `aiProvider` 值是否为 `gemini`

#### 1.2 检查请求头发送日志
查找包含 `[callAiDirect]` 的日志：
```
[callAiDirect] 读取数据库 provider 配置: {
  dbProvider: "gemini",  // ✅ 应该是 "gemini"
  willSendHeader: true   // ✅ 应该是 true
}

[callAiDirect] 调用 AI 服务: {
  provider: "render",
  xAiProviderHeader: "gemini",  // ✅ 应该有值 "gemini"
  ...
}
```

**如果 `xAiProviderHeader` 为 `undefined`**：
- 说明请求头没有发送
- 检查 `dbProvider` 是否为 `"gemini"`、`"openai"` 或 `"openrouter"` 之一

### 2. 检查网络请求

打开浏览器开发者工具（F12），查看 Network 标签页：

1. 找到对 `zalem.onrender.com/v1/ask` 的请求
2. 点击该请求，查看 Request Headers
3. 确认是否包含 `X-AI-Provider: gemini` 请求头

**如果没有 `X-AI-Provider` 头**：
- 说明主站代码没有正确发送请求头
- 检查浏览器控制台是否有错误日志

**如果有 `X-AI-Provider: gemini` 头**：
- 说明主站代码正常
- 问题在 ai-service 端

### 3. 检查 ai-service 端日志

如果主站正确发送了 `X-AI-Provider: gemini` 头，问题可能在 ai-service 端：

#### 3.1 检查 ai-service 是否正确接收请求头
在 ai-service 的日志中查找：
```
[ASK ROUTE] AI provider from header: {
  aiProvider: "gemini",  // ✅ 应该是 "gemini"
  ...
}
```

**如果没有这个日志，或者 `aiProvider` 不是 `"gemini"`**：
- 检查 ai-service 代码是否正确处理 `gemini` provider
- 检查 `apps/ai-service/src/routes/ask.ts` 中的 `aiProviderPromise` 函数

#### 3.2 检查 Gemini API 调用日志
在 ai-service 的日志中查找：
```
[SCENE-RUNNER] 调用 Gemini API: {
  provider: "gemini",
  model: "...",
  ...
}
```

**如果没有这个日志**：
- 说明 ai-service 没有正确识别 `gemini` provider
- 检查 `apps/ai-service/src/lib/sceneRunner.ts` 中的 `callModelWithProvider` 函数

#### 3.3 检查 Gemini API Key 配置
在 ai-service 的日志中查找错误信息：
```
GEMINI_API_KEY is not set
```

**如果有这个错误**：
- 说明 ai-service 的环境变量 `GEMINI_API_KEY` 未配置
- 需要在 Render 环境变量中配置 `GEMINI_API_KEY`

### 4. 常见问题排查

#### 问题 1: 请求头未发送
**症状**: 浏览器网络请求中没有 `X-AI-Provider` 头

**可能原因**:
1. 数据库 `aiProvider` 配置不是 `gemini`、`openai` 或 `openrouter`
2. `/api/ai/config` API 返回的 `dbProvider` 为 `null`
3. 前端代码未正确读取配置

**解决方法**:
1. 检查数据库配置：`SELECT * FROM ai_config WHERE key = 'aiProvider';`
2. 检查浏览器控制台日志，确认 `getCurrentAiProvider()` 的返回值
3. 检查 `/api/ai/config` API 的响应

#### 问题 2: ai-service 未识别 gemini
**症状**: 请求头已发送，但 ai-service 返回 500 错误

**可能原因**:
1. ai-service 代码未更新，不支持 `gemini` provider
2. ai-service 的 `getAiProviderFromConfig()` 函数不支持 `gemini`
3. ai-service 的 `callModelWithProvider()` 函数不支持 `gemini`

**解决方法**:
1. 确认 ai-service 代码已更新，支持 `gemini` provider
2. 检查 `apps/ai-service/src/lib/configLoader.ts` 中的 `getAiProviderFromConfig()` 函数
3. 检查 `apps/ai-service/src/lib/sceneRunner.ts` 中的 `callModelWithProvider()` 函数

#### 问题 3: Gemini API Key 未配置
**症状**: ai-service 日志显示 `GEMINI_API_KEY is not set`

**解决方法**:
1. 在 Render 环境变量中配置 `GEMINI_API_KEY`
2. 重启 ai-service 服务

#### 问题 4: Gemini API 调用失败
**症状**: ai-service 日志显示 Gemini API 调用错误

**可能原因**:
1. `GEMINI_API_KEY` 无效
2. Gemini API 服务不可用
3. 模型名称不正确

**解决方法**:
1. 验证 `GEMINI_API_KEY` 是否有效
2. 检查 Gemini API 服务状态
3. 检查数据库中的 `model` 配置是否正确

## 快速检查清单

- [ ] 数据库 `aiProvider` 配置为 `gemini`
- [ ] 浏览器控制台显示 `xAiProviderHeader: "gemini"`
- [ ] 网络请求包含 `X-AI-Provider: gemini` 头
- [ ] ai-service 日志显示 `aiProvider: "gemini"`
- [ ] ai-service 日志显示 `调用 Gemini API`
- [ ] Render 环境变量配置了 `GEMINI_API_KEY`
- [ ] Gemini API 调用成功

## 下一步

如果以上检查都通过，但仍然出现 500 错误，请：
1. 收集完整的浏览器控制台日志
2. 收集完整的网络请求信息（包括请求头和响应）
3. 收集 ai-service 的完整日志
4. 联系开发团队进行进一步排查

