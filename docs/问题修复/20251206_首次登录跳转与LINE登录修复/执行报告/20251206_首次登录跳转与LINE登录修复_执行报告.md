# 规范对齐检查摘要
1. 已读取规范文件：修复指令头 v5.2、文件结构.md、数据库结构_DRIVEQUIZ.md、AI 服务研发规范 v1.0、AI 核心服务规范 v2.0、AI板块整体架构说明.md
2. 约束适用：A1/A4、B1/B2/B3/B4、D1/D2、E1–E10、F1–F5
3. 强关联条款：A1（路由瘦层）、B3（Kysely 类型对齐）、E7/E8（最小变更/精确 Patch）、F1（禁止修改 AI 模块）
4. 本次修改文件：
   - src/lib/auth.ts
   - src/components/AuthGuard.tsx
   - src/lib/version.ts
   - （引用）src/lib/providers/line.ts（保持封装）
5. 数据库/文件结构影响：不涉及表结构变更；不需更新结构文档

# 任务摘要
- 修复首次用无邮箱/占位邮箱第三方登录后未跳转至 `/login/bind-email` 的问题
- 修复 LINE 登录环境变量错误与登录态丢失问题（恢复稳定 Provider 配置）

# 修改内容
- `src/lib/auth.ts`
  - signIn：显式检测 `user/profile/account` 邮箱，`trim` 后为空或以 `@oauth.local` 结尾则打标 `needsEmailBinding=true`
  - jwt：将 `needsEmailBinding` 写入 `token`
  - session：从 `token` 读取标记并写入 `session.needsEmailBinding`
  - LINE Provider：恢复采用 `src/lib/providers/line.ts`，从 `LINE_CLIENT_ID | LINE_CHANNEL_ID` 与 `LINE_CLIENT_SECRET | LINE_CHANNEL_SECRET` 读取配置，并设置 `allowDangerousEmailAccountLinking = true`
- `src/components/AuthGuard.tsx`
  - 增加 `PUBLIC_PATHS = ["/login", "/login/bind-email", "/login/error"]`
  - 未登录访问非公共页时跳转 `/login`
  - 已登录且 `needsEmailBinding` 且不在 `/login/bind-email` 时跳转绑定页
- `src/lib/version.ts`
  - 更新 `BUILD_TIME = "2025-12-06 23:45:00"`

# 红线自检（A1–E10）
- A1 路由瘦层：遵守，逻辑在 lib/组件与 Provider 层；路由未承载业务
- A4 接口统一：不适用
- B1/B2：不涉及结构变更
- B3：未改动 ORM 类型；与文档一致
- B4：未新增隐形字段
- D1/D2：本报告已生成，逐条自检
- E1：仅修复与清理，无冗余堆叠
- E2/E3：无多版本并存，唯一实现
- E4：引用点更新：LINE Provider 引用恢复 1 处；遗留引用 0
- E5：未新增调试/未用 imports
- E6：无未引用代码
- E7/E8：变更最小且精准
- E9：未增加不必要请求
- E10：冗余检测通过

# AI 模块边界自检（F1–F5）
- 修改 ai-core/ai-service/local-ai-service：NO
- 新增 AI 相关本地逻辑：NO
- 绕过 ai-core 自定义 AI 调用：NO
- 是否需要协同建议：NO

# 自测要点
- LINE 登录：授权回跳后 `status: authenticated`，首页有登录态；不再出现 env 错误。
- 无邮箱/占位邮箱 Provider：首次登录后落地受保护页时被跳转至 `/login/bind-email`；绑定成功后不再跳转。
- Google 登录：不会跳转到绑定页；同邮箱自动合并账户。

# 版本号
- 已更新 `src/lib/version.ts` 为 `2025-12-06 23:45:00`

