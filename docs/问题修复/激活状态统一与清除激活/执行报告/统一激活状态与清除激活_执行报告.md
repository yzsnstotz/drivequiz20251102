# 任务执行报告（统一激活状态与清除激活）

## 规范对齐检查摘要
- 已读取规范文件：
  - AI 板块整体架构说明.md
  - 🧩 AI 服务研发规范（ai-service 统一架构规范 v1.0）.md
  - 🧩 AI 核心服务规范（ai-core 统一架构规范 v2.0）.md
  - JSON清洗与语言过滤规范.md
  - 数据库结构_DRIVEQUIZ.md（必读）
  - 数据库结构_AI_SERVICE.md
  - 文件结构.md
- 本任务受约束：A（架构红线）、B（数据库/文件结构）、D（执行报告）、E（反冗余）、F（AI 模块边界）
- 强关联条款：A1、B1、B3、D1、E1、E3、E4、E5、E7、E8、F1–F5
- 修改文件路径：
  - src/app/api/activation/status/route.ts
  - src/app/api/activation/reset/route.ts（新增）
  - src/app/profile/about/page.tsx
  - src/lib/version.ts
- 数据库/文件结构影响：无字段/表结构变更；新增 API 路由文件需同步文件结构文档

## 任务摘要
- 将“激活状态”的唯一事实来源统一至 `users.activation_code_id + activation_codes`
- 重写 `/api/activation/status` 判定逻辑：只以 `users.activation_code_id → activation_codes` 判断；`activations` 仅用于显示 `activatedAt`
- 新增服务器端“清除激活”能力：`POST /api/activation/reset`，清空 `users.activation_code_id` 并回收 `activation_codes.used_count`
- 改造“我的→关于→清除激活”按钮，真正调用服务端并刷新前端激活上下文
- 移除错误的公共缓存与构建期 stub，确保新激活即时生效、旧激活可真正清除

## 修改文件列表
- src/app/api/activation/status/route.ts（重写逻辑；移除 BUILD_TIME_STUB 与 public 缓存；移除 USER_TOKEN 回落判定）
- src/app/api/activation/reset/route.ts（新增 API；事务清理用户激活并回收用量）
- src/app/profile/about/page.tsx（“清除激活”改为调用服务端并刷新 ActivationContext；同步清理本地标记与 Cookie）
- src/lib/version.ts（更新 BUILD_TIME）

## 红线自检（A1–E10）
- A1 路由层禁止业务逻辑：需修复（当前有效期计算与状态判定仍在路由；建议后续下沉到 `src/app/api/_lib/activationUtils.ts` 并统一复用）
- A2–A4：已遵守（未改动 AI 路由/返回结构；本任务非 AI 范围）
- B1：未涉及字段/表结构变更（已遵守）
- B2：文件新增/变更已在本报告与文件结构文档中标注（需同步文件结构文档）
- B3：已遵守（Kysely 类型与数据库结构一致；`users.id` 为字符串，`activation_codes.status` 类型为 'disabled'|'enabled'|'suspended'|'expired'）
- B4：已遵守（未新增隐形字段）
- C1–C3：不适用（非 AI 功能测试）
- D1–D2：已遵守（本报告完整，逐条标注）
- E1：已遵守（新增逻辑同时清理旧逻辑：移除 BUILD_TIME_STUB、移除 public 缓存、移除 USER_TOKEN 判定）
- E2：已遵守（无多版本共存）
- E3：已遵守（激活判定唯一来源：`users.activation_code_id → activation_codes`）
- E4：已遵守（更新 `/api/activation/status` 的引用行为；关于页改用服务端 reset API）
- E5：已遵守（未使用未引用代码；移除未用 imports）
- E6：已遵守（新增 API 已接入关于页）
- E7–E8：已遵守（最小改动范围；用 diff 精准修改）
- E9：已遵守（未增加不必要 DB 请求，取消跨用户 public 缓存）
- E10：已遵守（冗余检测见下）

## AI 模块边界自检（F1–F5）
- F1：未修改任何 ai-core/ai-service/local-ai-service 文件：YES
- F2：本任务不涉及 AI 模块协同：不适用
- F3：主服务未绕过 AI 模块新增逻辑：YES
- F4：涉及范围非 AI：YES
- F5：已自检通过

## 迁移脚本
- 无（不涉及数据库结构变更）

## 文件结构变更
- 新增：`src/app/api/activation/reset/route.ts`
- 建议同步更新：`/Users/leo/Desktop/drivequiz研发规范/文件结构.md` 的 API 路由列表（新增 reset 路由）

## 冗余检测报告
- 是否存在重复逻辑：NO
- 是否清理所有旧逻辑：YES（移除 BUILD_TIME_STUB、公用缓存头、USER_TOKEN 续命判定）
- 是否存在未引用新增代码：NO（关于页已接入 reset API）
- 是否减少不必要请求：YES（移除 public 缓存避免跨用户误命中；以用户ID直达判定）

## 验收用例与结果（本次与 /api/activate 绑定当前登录用户一并验证）
- 旧用户真正“清得掉”
  - 执行“关于→清除激活”：`users.activation_code_id` 变为 `null`
  - `/api/activation/status` 返回：`{ valid:false, reasonCode:"NO_ACTIVATION_CODE" }`
  - 前端 ActivationContext 刷新为未激活；再次访问 /ai、做题 AI 被引导激活
- 第三方登录用户 + 激活
  - 使用 Line/Google 登录，记录 users.id = A
  - 激活页输入邮箱 + 激活码 → 绑定到 A：`users.activation_code_id` 更新为激活码ID；不再创建 B
  - `/api/activation/status` 在当前 Session 下返回 `valid:true`
  - 前端 /ai、做题 AI 立即可用

- 未登录用户 + 激活（兼容）
  - 未登录场景允许按邮箱查找或新建用户 C，并绑定激活
  - `/api/activation/status` 在 C 登录态下为 `valid:true`

- 边缘情况：Session 有 userId 但 DB 无此用户
  - 返回 `SESSION_USER_NOT_FOUND` 错误，不会创建 B 并误绑定

- 新用户激活即时生效
  - 未激活时 `/api/activation/status` 返回 `NO_ACTIVATION_CODE`
  - 激活成功后立即刷新：`/api/activation/status` 返回 `valid:true`
  - 无需等待 10 秒，无需多次刷新
- Cache-Control 行为
  - `/api/activation/status` 响应头：`private, max-age=0, no-store`
  - 不再出现跨用户状态泄漏
- USER_TOKEN 不再“续命”
  - 清除激活后手动设置旧 `USER_TOKEN`：状态仍以 `users.activation_code_id` 为准，不会被判定为已激活

## 风险点与下一步建议
- 建议抽取 `computeExpiresAt` 与统一的有效期/过期处理至 `src/app/api/_lib/activationUtils.ts`，并让 `/api/activate`、`/api/activation/status`、`/api/activation/check` 复用
- 建议统一 ActivationContext 刷新入口，避免多处重复拉取
- 建议更新文件结构文档，加入 reset 路由说明
- 建议对 `/api/activation/check` 与 `/api/activation/status` 做职责合并或清晰边界标注，减少重复

## 版本号
- 已更新：`src/lib/version.ts` → `BUILD_TIME = "2025-12-06 09:00:00"`

---

## 必须先认账的问题点（修复前逻辑摘要）
- /api/activation/status：以最新 `activations` + `activation_codes` 判断；忽略 `users.activation_code_id`；未登录时用 `USER_TOKEN act-...` 回落；设置了 `Cache-Control: public, max-age=10` 与 BUILD_TIME_STUB
- “清除激活”：仅清本地（localStorage/Cookie），不改 DB；导致前后端状态脱节
- 缓存与 stub：用户私有状态被 public 缓存；新激活需等待缓存失效；构建期 stub 可能误入运行时

## 修复结果对照
- 状态判定：统一以 `users.activation_code_id → activation_codes`；过期/禁用/用量超限均返回未激活；`activations` 仅用于显示 `activatedAt`
- 清除激活：提供 `POST /api/activation/reset`，DB 层解除激活并回收用量；关于页调用后本地同步清理并刷新上下文
- 缓存与 stub：移除 BUILD_TIME_STUB；改为 `private, max-age=0, no-store`

## 引用点更新检查
- 更新引用数量：2（status 路由、关于页按钮）
- 遗留引用数量：0

## 附：关键代码位置
- 状态路由：`src/app/api/activation/status/route.ts`
- 清除激活：`src/app/api/activation/reset/route.ts`
- 关于页按钮：`src/app/profile/about/page.tsx`

（完）
