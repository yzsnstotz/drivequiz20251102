✅ Cursor 一次性修复指令（v1.2 — 补齐 UI 与集成测试）
🟩 任务标题：批量处理 JSON 容错与语言过滤 · 最终闭环任务单 v1.2

目标：补齐 v1.1 中未完成的 Task 5、测试未执行问题，并真正闭环整个批量处理链路。

🔧 Task 1 — 实现任务详情页（Task 5 强制执行）
新增文件：

apps/web/src/app/admin/question-processing/tasks/[id]/page.tsx

必须包含的内容：
1) 从 API 加载任务详情：

GET /api/admin/question-processing/tasks/[id]

数据字段包括：

task.id
task.status
task.details.server_logs  ← 必须展示
task.details.error_detail
task.created_at
task.updated_at

2) 展示 AI 调试日志（你在 v1.1 已实现 server_logs）

UI 功能：

按步骤过滤（AI_CALL_BEFORE / AI_CALL_AFTER / SANITIZE_AFTER / DB_WRITE_BEFORE）

展开/折叠大 JSON（使用 CodeBlock 样式）

高亮显示：

removedLanguages

cleanedJsonPreview

fixedJson

支持逐条复制

3) 展示错误（error_detail）

error_detail 必须格式化显示：

rawAiResponse
errorMessage
fixedJson
cleanJson

4) 任务基础信息模块

展示：

任务 ID

任务时间

输入数量

目标语言

处理场景（full_pipeline / translate）

Provider 信息（render/local）

🔧 Task 2 — 运行你写的 E2E 测试脚本并输出日志

Cursor 必须：

运行 tests/question_processing/full_pipeline_e2e.test.ts

输出执行日志（必须包含）

请求体

AI 响应

sanitize 过滤结果（被删除的语言）

DB 写入前的数据预览

DB 最终写入内容

结果必须包含：

local-ai-service 环境

render 模型环境

如果远程 provider 调用失败 → 必须自动降级到 local，并标记日志。

🔧 Task 3 — 任务详情页联动自动刷新机制

当任务 status = processing 时：

每 3 秒自动刷新一次（短轮询）

状态变化到 completed 或 failed 立即停止轮询

🔧 Task 4 — 为 batchProcessUtils 中所有日志写入补齐调用链编号

添加：

trace_id: crypto.randomUUID()


并确保：

所有日志 (server_logs) 都包含 trace_id，用于多步骤追踪。

🔧 Task 5 — 输出最终执行报告（必须）

包括：

文件变更（新增/修改列表）

全量代码 diff

前端页面截图（如无法截图 → 输出 DOM 结构）

E2E 测试结果

Redline A1–D2 再次对照检查

是否闭环？如未闭环 → 自动继续修复