# ä¿®å¤æŒ‡ä»¤å¤´5.2ï¼ˆç°ç”¨ï¼‰å¯¹é½ä¸æ‰§è¡ŒæŠ¥å‘Šï¼ˆLINE email æƒé™è¿‡æ¸¡ + ç»Ÿä¸€ç»‘å®šï¼‰

## è§„èŒƒè¾¹ç•Œ
- ä¸ä¿®æ”¹ `src/lib/providers/line.ts`ã€å…¶ scope/checks/authorization é…ç½®ï¼Œä¸åŠ¨ä»»ä½• LINE ç¯å¢ƒå˜é‡é€»è¾‘ã€‚
- ä¸ä¿®æ”¹ `ai-core` / `ai-service` / `local-ai-service`ã€‚
- ä»…ä¿®æ”¹ï¼š`auth` callbacksã€`bind-email` æµç¨‹ã€`accounts` ç»‘å®šé€»è¾‘ã€ç”³è¯· LINE email æƒé™çš„ UIã€ç»‘å®šé‚®ç®±è§¦å‘æœºåˆ¶ã€ç‰ˆæœ¬å·ä¸æŠ¥å‘Šã€‚
- è·¯ç”±å±‚ä¿æŒç˜¦ï¼›ç»‘å®šé€»è¾‘åœ¨ API ä¸ Adapter å±‚ï¼›è§†å›¾ä¸ç»„ä»¶éµå¾ªæœ€å°å˜æ›´ã€‚

## å·²é˜…è¯»æ–‡ä»¶ï¼ˆå«æ•°æ®åº“ç»“æ„ï¼‰
- `docs/ğŸ”§æŒ‡ä»¤æ¨¡ç‰ˆ/ä¿®å¤æŒ‡ä»¤å¤´5.2ï¼ˆç°ç”¨ï¼‰.md`
- æ•°æ®åº“ç»“æ„ï¼š`src/lib/db.ts`ã€`src/migrations/20251126_create_oauth_accounts.sql`ã€`src/migrations/20251126_alter_users_and_auth_ids_to_text.sql`ã€`src/migrations/20251126_create_nextauth_table_views.sql`
- è®¤è¯ä¸é€‚é…ï¼š`src/lib/auth.ts`ã€`src/lib/auth-kysely-adapter.ts`
- ç»‘å®šæ¥å£ï¼š`src/app/api/auth/bind-email/route.ts`
- ç»‘å®šé¡µ UIï¼š`src/app/login/bind-email/page.tsx`

## A. ç¬¬ä¸‰æ–¹ç»Ÿä¸€ç»‘å®š + ç»‘å®šé‚®ç®±è§¦å‘ä¿®å¤ï¼ˆå«è¯Šæ–­æ—¥å¿—ï¼‰
- è¯Šæ–­æ—¥å¿—ï¼š
  - åœ¨ `src/lib/auth.ts` çš„ `callbacks.signIn` ä¸­æ‰“å° providerã€`user.email`ã€`profile.email`ã€`account.email`ï¼›åœ¨ `jwt` ä¸ `session` ä¸­æ‰“å° `needsEmailBinding` æ ‡è®°ã€‚
  - ä»£ç å‚è€ƒï¼š`src/lib/auth.ts` å˜æ›´åä½ç½®ï¼ˆæŸ¥æ‰¾ `console.log("[signIn] provider:"` / `"[jwt] needsEmailBinding:"` / `"[session] needsEmailBinding:"`ï¼‰ã€‚
- ç»‘å®šè§¦å‘ä¿®å¤ï¼š
  - åœ¨ `signIn` ä¸­æ”¹ä¸ºä¾æ®â€œå½“å‰ Provider æ˜¯å¦æä¾›é‚®ç®±â€åˆ¤æ–­ï¼šä»¥ `profile.email` æˆ– `account.email` ä¸ºå‡†ï¼›ä¸ºç©ºæˆ–ä»¥ `@oauth.local` ç»“å°¾åˆ™ `user.needsEmailBinding = true`ã€‚
  - ä¿è¯ï¼šå³ä½¿ `users` è¡¨å·²æœ‰é‚®ç®±ï¼ˆå¦‚ç”¨æˆ·æ›¾ç”¨ Google ç™»å½•ï¼‰ï¼Œåªè¦å½“å‰ Providerï¼ˆå¦‚ LINEï¼‰æ²¡æœ‰é‚®ç®±ï¼Œæœ¬æ¬¡ç™»å½•ä»ä¼šè§¦å‘ç»‘å®šé‚®ç®±æµç¨‹ã€‚
- accounts è¡¨ï¼š
  - ä½¿ç”¨æ—¢æœ‰ `oauth_accounts` ä½œä¸ºå¤š Provider ç»‘å®šæºï¼Œå”¯ä¸€çº¦æŸ `(provider, provider_account_id)` å·²å­˜åœ¨ï¼›å¤–é”® `user_id` æŒ‡å‘ `users(id)`ï¼Œ`ON DELETE CASCADE`ï¼›è§†å›¾ `Account` ä¸ç±»å‹è¿ç§»åœ¨ 2025-11-26 å·²å®Œæˆã€‚
- Adapterï¼š
  - `src/lib/auth-kysely-adapter.ts` å·²é‡å†™ `linkAccount()` ç›´å†™ `oauth_accounts`ï¼›è¯»å–é€šè¿‡ `Account` è§†å›¾ä¿æŒå…¼å®¹ï¼›ä¸ä¾èµ– `users.oauth_provider` åˆ¤å®šç»‘å®šå…³ç³»ã€‚
- /bind-email åˆå¹¶ï¼š
  - `src/app/api/auth/bind-email/route.ts` æŒ‰ `accounts`ï¼ˆå³ `oauth_accounts`ï¼‰è¿›è¡Œå½’å¹¶ï¼šCase A æ›´æ–°å½“å‰ `users.email`ï¼›Case B äº‹åŠ¡è¿ç§»æ‰€æœ‰ä»å±è¡¨åˆ° `existingUser.id` å¹¶åˆ é™¤ä¸´æ—¶ç”¨æˆ·ã€‚

## B. LINE email æƒé™ UIï¼ˆå®¡æ ¸è¦æ±‚ï¼‰
- æ–‡ä»¶ï¼š`src/app/login/bind-email/page.tsx`
- å˜æ›´ï¼š
  - é¡µé¢é¡¶éƒ¨åŠ å…¥è‹±æ–‡/æ—¥æ–‡/ä¸­æ–‡è¯´æ˜æ–‡æœ¬ï¼Œä¸€æ¬¡æ€§å±•ç¤ºï¼›æ— éœ€åˆ‡æ¢è¯­è¨€ã€‚
  - å¢åŠ â€œæˆ‘å·²é˜…è¯»å¹¶åŒæ„â€å‹¾é€‰æ¡†ï¼ˆ`required`ï¼‰ï¼›æœªå‹¾é€‰ä¸å¯æäº¤ï¼›æŒ‰é’®åœ¨æœªåŒæ„æ—¶ç¦ç”¨ã€‚
- ç›®çš„ï¼šæ»¡è¶³ LINE åœ¨ç”³è¯·é‚®ç®±æƒé™æ—¶çš„å®¡æ ¸æˆªå›¾è¦æ±‚ï¼ˆè¯´æ˜ç”¨é€”ä¸ç”¨æˆ·åŒæ„ï¼‰ã€‚

## ç‰ˆæœ¬å·
- `src/lib/version.ts`ï¼š`BUILD_TIME = "2025-12-06 04:25:00"`ã€‚

## å˜æ›´æ–‡ä»¶åˆ—è¡¨
- `src/lib/auth.ts`ï¼šåŠ å…¥è¯Šæ–­æ—¥å¿—ï¼›æŒ‰å½“å‰ Provider é‚®ç®±ç¼ºå¤±/å ä½å¼ºåˆ¶è®¾ç½® `needsEmailBinding`ã€‚
- `src/app/login/bind-email/page.tsx`ï¼šåŠ å…¥è¯´æ˜ä¸åŒæ„å‹¾é€‰ï¼›æäº¤æ—¶è¦æ±‚åŒæ„ã€‚
- `src/lib/version.ts`ï¼šç‰ˆæœ¬å·æ›´æ–°ã€‚
- æœªæ”¹åŠ¨ï¼š`src/lib/providers/line.ts`ï¼›`auth.ts` å†… LINE Provider æ³¨å…¥ä¸é…ç½®ä¿æŒåŸæ ·ã€‚

## è‡ªæµ‹
- Google â†’ LINE åœºæ™¯ï¼šGoogle ç™»å½•æœ‰é‚®ç®±ï¼›å†ç”¨ LINEï¼ˆæ— é‚®ç®±ï¼‰ç™»å½•ï¼Œä¼šè§¦å‘ `needsEmailBinding=true` å¹¶è¿›å…¥ `/login/bind-email`ã€‚
- `/login/bind-email`ï¼šå‹¾é€‰åŒæ„åæäº¤é‚®ç®±ï¼›Case A æ›´æ–°å½“å‰ç”¨æˆ·é‚®ç®±ï¼›Case B è¿ç§» `oauth_accounts` ä¸ä»å±è¡¨ååˆ é™¤ä¸´æ—¶ç”¨æˆ·ã€‚
- LINE é»‘ç›’ä¿æŒï¼šç™»å½•æµç¨‹æ­£å¸¸ï¼Œsession `status: authenticated`ï¼Œåˆ·æ–°é¦–é¡µä»ç™»å½•ï¼›æ—  418 ä¸ env æŠ¥é”™é€€å›ã€‚

## æäº¤
- æ„å»ºé€šè¿‡å¹¶æ¨é€åˆ° `origin main`ã€‚
- å…³é”®æäº¤ç¼–å·ï¼š`0d3fb8a`ï¼ˆè¯Šæ–­æ—¥å¿—ä¸ç»‘å®š UIã€ç‰ˆæœ¬å·ï¼‰ã€‚

