# 执行报告 — 标签字段统一化_v3 · 数据库清洗脚本

## 规范边界
- 仅操作 DriveQuiz 主库 `questions` 表数据；不改 AI 模块；不改 DB 结构；依赖触发器 `sync_question_tags` 同步相关表。
- 目标字段：`license_type_tag[]`、`stage_tag`、`topic_tags[]`；归一入口：`normalizeQuestionTags`。

## 阅读文件
- `/Users/leo/Desktop/drivequiz研发规范/数据库结构_DRIVEQUIZ.md`
- `/Users/leo/Desktop/drivequiz研发规范/JSON清洗与语言过滤规范.md`
- `docs/其他文档/QUESTION_TAGS_SYSTEM.md`
- `src/lib/quizTags.ts`（`normalizeQuestionTags`、`RawQuestionTags`）

## 实施内容
- 新增脚本：`scripts/normalize-question-tags.ts`，按主键递增分页读取并归一更新，仅当归一结果与现值不一致时执行 `UPDATE`；`license_type_tag` 以 `::jsonb` 写入；`stage_tag` 与 `topic_tags` 直接写入；触发器负责同步冗余表。
- 新增运行脚本：`npm run normalize-tags`（等价 `npx tsx scripts/normalize-question-tags.ts`）。

## 运行结果
- 本地执行成功：`npm run normalize-tags`（通过注入 `.env.local` 中的数据库配置）
- 统计：`total=1431`，`updated=1430`
- 日志片段：
  - `[normalize-question-tags] processed: 500, updated: 500`
  - `[normalize-question-tags] processed: 1000, updated: 1000`
  - `[normalize-question-tags] processed: 1431, updated: 1430`

## 典型清洗映射示例
- `FULL` → `regular`
- `本免` → `regular`
- `gaikoku`/`foreign` → `foreign_exchange`
- 缺失值兜底：`license_type_tag=[]` → `['common_all']`；`stage_tag` 空 → `both`；`topic_tags` 空 → `['other']`

## 下一步
- 在 `.env.local` 或运行环境配置 `DATABASE_URL` 或 `POSTGRES_URL` 指向目标库。
- 在开发库执行：`npm run normalize-tags`，观察日志 `processed` 与 `updated` 计数。
- 生产环境：先备份数据库 → 配置 `.env.production` → 同步执行 → 复核：
  - `SELECT DISTINCT jsonb_array_elements_text(license_type_tag) FROM questions;`
  - `SELECT DISTINCT stage_tag FROM questions;`
  - `SELECT DISTINCT unnest(topic_tags) FROM questions;`
  确认所有值落在 `src/lib/quizTags.ts` 定义的枚举集合内。
