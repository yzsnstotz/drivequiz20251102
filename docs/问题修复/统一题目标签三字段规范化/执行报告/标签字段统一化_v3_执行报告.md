# 执行报告 — 标签字段统一化（v3）

## 任务摘要
- 核心目标：全仓库持久化与对外结构仅保留三字段 `license_type_tag[]`、`stage_tag`、`topic_tags[]`；旧字段仅作输入兼容，统一归一后丢弃。
- 范围：v3 主服务仓库（Next.js + 后端脚本），不改动 AI 模块（ai-core/ai-service）。

## 规范对齐检查摘要
- 已阅读：AI 模块研发边界、AI 服务与核心规范、JSON清洗与语言过滤规范、数据库结构_DRIVEQUIZ.md、文件结构.md、QUESTION_TAGS_SYSTEM.md
- 约束适用：A1/A4（路由与返回结构统一）、B1/B3/B4（数据库结构与类型一致）、D1/D2（执行报告）、E1–E5/E9/E10（反冗余）、F1（AI 模块边界）
- 强关联条款：A1/A4、B3/B4、E1/E2/E3/E4/E5/E9/E10、F1
- 修改文件：见下文“修改文件列表”
- 数据库/文件结构影响：未变更表结构；更新 `src/lib/version.ts` 构建时间；新增执行报告文件。

## 修改文件列表
- `src/lib/quizTags.ts`：新增 `RawQuestionTags`、`NormalizedQuestionTagsDb`、`normalizeQuestionTags`、别名映射；保留既有 `normalizeAIResult`
- `src/app/api/admin/question-processing/_lib/batchProcessUtils.ts`：`applyTagsFromFullPipeline` 改为使用 `normalizeQuestionTags`
- `src/lib/questionDb.ts`：`saveQuestionToDb` 入库前统一归一；`getQuestionsFromDb` 仅返回三字段（移除 `license_tags`）
- `src/app/api/admin/questions/route.ts`：统一返回 `license_type_tag`；移除基于旧 `license_types` 的回退筛选
- `src/app/admin/questions/page.tsx`：管理页 UI 显示改为 `license_type_tag`
- `src/app/admin/questions/list/page.tsx`：列表页 UI 显示改为 `license_type_tag`
- `src/lib/version.ts`：更新 `BUILD_TIME`
- 新增：`docs/问题修复/统一题目标签三字段规范化/执行报告/标签字段统一化_v3_执行报告.md`

## 红线自检（A1–E10）
- A1 路由层无业务逻辑：已遵守（规范化逻辑在 `lib` 与处理模块）
- A2/A3 AI 逻辑位置与一致性：不适用（未改 AI 模块）
- A4 接口参数与返回统一：已遵守（统一三字段返回）
- B1/B2 文档同步：已更新执行报告与版本号；无结构更改
- B3 类型一致：已检查 `src/lib/db.ts` 与实际字段一致
- B4 禁止隐形字段：已遵守（移除旧字段输出与持久化）
- C1–C3 AI 双环境测试：不适用（非 AI 任务）
- D1/D2 执行报告：已完成本报告
- E1 旧逻辑清理：已清理输出侧旧字段与路由回退
- E2 禁止多版本共存：已合并为 `normalizeQuestionTags` 唯一入口
- E3 单一事实来源：标签归一仅在 `quizTags.ts`
- E4 更新所有引用点：关键引用已更新（见“引用点更新检查”）
- E5 清理冗余：已移除调试与旧字段分支（仅保留必要日志）
- E6 未引用新增代码：`normalizeQuestionTags` 已被调用
- E7/E8 最小改动 + Diff：仅改相关块
- E9 请求优化：移除无谓 DB 回退查询
- E10 冗余检测：见下文
- F1 AI 模块边界：已遵守（未改 ai-core / ai-service）

## 引用点更新检查
- 更新引用数量：5（处理管线、DB 写入/读取、Admin 两页 UI、Admin 列表 API）
- 遗留引用数量：0（输出侧 `license_tags` 与 `license_types` 已移除）

## 冗余检测结果
- 重复逻辑：NO（统一 `normalizeQuestionTags` 唯一入口）
- 旧逻辑清理：YES（移除输出旧字段、移除基于旧字段的回退筛选）
- 未引用新增代码：NO（函数已被处理管线与 DB 写入调用）
- 不必要请求减少：YES（移除一次全量查询与旧字段筛选回退）

## 规范化函数测试样例
```ts
import { normalizeQuestionTags } from "@/lib/quizTags";

normalizeQuestionTags({ license_tags: ["Ordinary", "Full"] });
// => { license_type_tag: ["ordinary"], stage_tag: "both", topic_tags: ["other"] }

normalizeQuestionTags({ stageTag: "本免", topicTag: "highway_signs" });
// => { license_type_tag: ["common_all"], stage_tag: "regular", topic_tags: ["weather_night_highway"] }

normalizeQuestionTags({ license_type_tag: ["gaikoku"], stage_tag: "仮免", topic_tags: ["signals"] });
// => { license_type_tag: ["foreign_exchange"], stage_tag: "provisional", topic_tags: ["signals"] }
```

## 风险点与下一步建议
- 风险：历史数据库仍含旧值或旧字段；建议运行一次数据清洗脚本（见下述 TODO）。
- 建议：新增 `scripts/normalize-question-tags.ts`，批量读取 DB，统一归一并回写三字段，依赖触发器完成冗余表同步。
- AI 协同：若 AI 输出使用驼峰（`licenseTypeTag`、`stageTag`、`topicTags`），由处理管线转为三字段；无需改 AI 服务。

## 版本号更新
- `src/lib/version.ts` 已更新为 `2025-12-06 12:00:00`。

## 附：简明总结（修改后的标签 & 题目分类逻辑）
- 标签来源：任何输入（旧/新字段）先构造 `RawQuestionTags` → `normalizeQuestionTags` → 仅写三字段。
- 数据库写入：只写 `license_type_tag(JSONB[])`、`stage_tag(VARCHAR)`、`topic_tags(TEXT[])`。
- 读取与返回：API/页面仅返回三字段；不再返回 `license_tags/license_types`。
- 前端筛选：按驾照类型与阶段，`common_all` 通配；阶段 `both` 通配；主题预留按 `topic_tags`。
