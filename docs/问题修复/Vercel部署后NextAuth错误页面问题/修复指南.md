# Vercel 部署后 NextAuth 错误页面问题修复指南

**问题描述**: 部署到 Vercel 后访问 `https://drivequiz20251102-app-git-register-zalems-projects.vercel.app/api/auth/error` 时遇到问题

**修复日期**: 2025-11-27

---

## 一、问题分析

### 1.1 可能的原因

1. **NextAuth 路由导出方式不正确**
   - NextAuth v5 的 handler 导出方式与 v4 不同
   - 错误的导出方式会导致所有 NextAuth API 路由返回 405 错误

2. **环境变量配置缺失或不正确**
   - `NEXTAUTH_URL` 未设置或设置错误
   - `NEXTAUTH_SECRET` 未设置
   - OAuth Provider 的 `CLIENT_ID` 和 `CLIENT_SECRET` 未设置

3. **OAuth 回调 URL 配置错误**
   - OAuth Provider（Google、Twitter、Facebook 等）的回调 URL 指向本地地址
   - 未配置生产环境的回调 URL

---

## 二、修复步骤

### 2.1 代码修复（已完成）

**文件**: `src/app/api/auth/[...nextauth]/route.ts`

**修复内容**:
- 使用 NextAuth v5 正确的 handlers 解构方式
- 从 `handlers` 对象中解构出 `GET` 和 `POST` 方法

**修复后的代码**:
```typescript
const authHandlers = getHandlers();
export const { GET, POST } = authHandlers;
```

### 2.2 Vercel 环境变量配置（需要手动检查）

#### 必需的环境变量

在 Vercel 项目设置中，确保以下环境变量已正确配置：

1. **NextAuth 基础配置**
   ```
   NEXTAUTH_URL=https://drivequiz20251102-app-git-register-zalems-projects.vercel.app
   NEXTAUTH_SECRET=<你的密钥，至少32个字符>
   ```

2. **Google OAuth**
   ```
   GOOGLE_CLIENT_ID=<你的 Google Client ID>
   GOOGLE_CLIENT_SECRET=<你的 Google Client Secret>
   ```

3. **Twitter OAuth**
   ```
   TWITTER_CLIENT_ID=<你的 Twitter Client ID>
   TWITTER_CLIENT_SECRET=<你的 Twitter Client Secret>
   ```

4. **Facebook OAuth**
   ```
   FACEBOOK_CLIENT_ID=<你的 Facebook App ID>
   FACEBOOK_CLIENT_SECRET=<你的 Facebook App Secret>
   ```

5. **LINE OAuth**
   ```
   LINE_CLIENT_ID=<你的 LINE Channel ID>
   LINE_CLIENT_SECRET=<你的 LINE Channel Secret>
   ```

6. **微信 OAuth**（如果使用）
   ```
   WECHAT_CLIENT_ID=<你的微信 AppID>
   WECHAT_CLIENT_SECRET=<你的微信 AppSecret>
   WECHAT_REDIRECT_URI=https://drivequiz20251102-app-git-register-zalems-projects.vercel.app/api/auth/callback/wechat
   ```

7. **数据库连接**（如果使用）
   ```
   DATABASE_URL=<你的数据库连接字符串>
   POSTGRES_URL=<你的 PostgreSQL 连接字符串>
   ```

#### 如何设置环境变量

1. 登录 Vercel 控制台
2. 进入项目设置（Project Settings）
3. 点击 "Environment Variables" 标签
4. 添加或修改上述环境变量
5. **重要**: 添加环境变量后，需要重新部署应用

### 2.3 OAuth Provider 回调 URL 配置

#### Google OAuth

1. 访问 [Google Cloud Console](https://console.cloud.google.com/)
2. 进入 "APIs & Services" > "Credentials"
3. 选择你的 OAuth 2.0 Client ID
4. 在 "Authorized redirect URIs" 中添加：
   ```
   https://drivequiz20251102-app-git-register-zalems-projects.vercel.app/api/auth/callback/google
   ```

#### Twitter OAuth

1. 访问 [Twitter Developer Portal](https://developer.twitter.com/)
2. 进入你的 App 设置
3. 在 "Callback URI / Redirect URL" 中添加：
   ```
   https://drivequiz20251102-app-git-register-zalems-projects.vercel.app/api/auth/callback/twitter
   ```

#### Facebook OAuth

1. 访问 [Facebook Developers](https://developers.facebook.com/)
2. 进入你的 App 设置
3. 在 "Valid OAuth Redirect URIs" 中添加：
   ```
   https://drivequiz20251102-app-git-register-zalems-projects.vercel.app/api/auth/callback/facebook
   ```

#### LINE OAuth

1. 访问 [LINE Developers Console](https://developers.line.biz/)
2. 进入你的 Channel 设置
3. 在 "Callback URL" 中添加：
   ```
   https://drivequiz20251102-app-git-register-zalems-projects.vercel.app/api/auth/callback/line
   ```

---

## 三、验证修复

### 3.1 检查 NextAuth API 路由

部署后，访问以下 URL 应该返回正常响应（不是 405 错误）：

1. **Session 端点**
   ```
   https://drivequiz20251102-app-git-register-zalems-projects.vercel.app/api/auth/session
   ```
   - 应该返回 JSON 格式的会话信息或 `{}`

2. **Providers 端点**
   ```
   https://drivequiz20251102-app-git-register-zalems-projects.vercel.app/api/auth/providers
   ```
   - 应该返回 JSON 格式的 OAuth Provider 列表

3. **错误页面**
   ```
   https://drivequiz20251102-app-git-register-zalems-projects.vercel.app/api/auth/error
   ```
   - 应该重定向到 `/login/error` 页面，而不是返回 405 错误

### 3.2 测试 OAuth 登录

1. 访问登录页面
2. 点击各个 OAuth 登录按钮
3. 应该能够正常跳转到 OAuth Provider 的授权页面
4. 授权后应该能够正常回调并登录成功

---

## 四、常见问题排查

### 4.1 仍然返回 405 错误

**可能原因**:
- 环境变量未正确设置
- 需要重新部署应用

**解决方法**:
1. 检查 Vercel 环境变量配置
2. 在 Vercel 控制台触发重新部署
3. 检查构建日志，确认没有错误

### 4.2 OAuth 登录失败

**可能原因**:
- OAuth Provider 的回调 URL 未配置
- Client ID 或 Client Secret 错误

**解决方法**:
1. 检查 OAuth Provider 的回调 URL 配置
2. 确认环境变量中的 Client ID 和 Client Secret 正确
3. 检查 Vercel 日志，查看具体错误信息

### 4.3 错误页面显示不正确

**可能原因**:
- NextAuth 配置中的 `pages.error` 路径不正确

**解决方法**:
1. 检查 `src/lib/auth.ts` 中的 `pages.error` 配置
2. 确认 `/login/error` 页面存在且可访问

---

## 五、相关文件

- `src/app/api/auth/[...nextauth]/route.ts` - NextAuth 路由处理
- `src/lib/auth.ts` - NextAuth 配置
- `src/app/login/error/page.tsx` - 错误页面组件

---

## 六、参考文档

- [NextAuth.js v5 文档](https://authjs.dev/)
- [Vercel 环境变量配置](https://vercel.com/docs/concepts/projects/environment-variables)
- [NextAuth.js 部署指南](https://authjs.dev/getting-started/deployment)

---

**修复完成时间**: 2025-11-27 09:31:08  
**当前版本**: 2025-11-27 09:31:08

