# 🔧 Cursor 执行报告
Issue ID: CP-20251202-009

=======================

# 1. 任务摘要

## 1.1 修复目标
本次修复任务旨在收口 session / activation 轮询 + Google 噪音日志，确保：
- `/api/auth/session`：首页加载 + 刷新一次，总请求量控制在 ≤ 5 次（考虑 StrictMode 双 render 的 buff）
- `/api/activation/status`：首页加载 + 刷新一次，总请求量控制在 ≤ 3 次
- `[NextAuth][Google] expected redirect_uri: ...`：在默认开发环境下不再打印，除非手动开启 debug
- `[DB][Config]`：继续允许按"每个 Node worker 打一次"即可，可选增强为默认不打印，只有手动开启 `DB_CONFIG_DEBUG=true` 时才打印

## 1.2 涉及模块
- **前端组件层**：SessionProvider 配置增强、ActivationContext 确认
- **API 路由层**：NextAuth logger 自定义、DB Config 日志开关

## 1.3 修复策略
1. **SessionProvider 配置增强**：添加 `refetchWhenOffline={false}`，彻底关闭所有自动刷新
2. **NextAuth logger 自定义**：静音 Google redirect_uri 噪音日志
3. **DB Config 日志开关**：默认 dev 环境不打印，只有手动开启 `DB_CONFIG_DEBUG=true` 时才打印

## 1.4 当前版本号
**BUILD_TIME**: `2025-12-02 03:33:33`

---

# 2. 规范对齐检查摘要

## 2.1 已阅读的规范文件
1. `/Users/leo/Desktop/drivequiz研发规范/🧩 AI 服务研发规范（ai-service 统一架构规范 v1.0）.md`
2. `/Users/leo/Desktop/drivequiz研发规范/数据库结构_DRIVEQUIZ.md`
3. `/Users/leo/Desktop/drivequiz研发规范/文件结构.md`

## 2.2 本任务关联红线
- **A1**：路由层不承载业务逻辑（本次任务不涉及路由层业务逻辑）
- **B2**：文件结构文档同步更新（本次任务未新增/删除文件）
- **C2**：必须有测试与验证（已在执行报告中说明验证步骤）
- **D1 / D2**：必须输出执行报告并逐条自检（本报告）

## 2.3 任务范围说明
本次改动仅限 Next.js 前端 app，不对本地 ai-service 等服务做任何修改。

---

# 3. Step 1 — 全局排查所有 session / activation 轮询来源

## 3.1 全局搜索 SESSION_ROUTE_HIT

### 调查结果

| 文件路径 | 行号 | 说明 |
|---------|------|------|
| `src/lib/auth.ts` | 232 | ✅ 服务端 route handler 日志（正确位置） |

**结论**：`[Diag][SESSION_ROUTE_HIT]` 只出现在服务端 route handler 中，前端组件层/Hook 里没有出现，符合要求。

## 3.2 全局搜索 activation/status

### 调查结果

| 文件路径 | 行号 | 说明 |
|---------|------|------|
| `src/contexts/ActivationContext.tsx` | 73 | ✅ 唯一调用 `/api/activation/status` 的地方（应当保留） |
| `src/app/api/activation/status/route.ts` | 41 | ✅ API Route handler（服务端） |

**结论**：
- ✅ 只有 `ActivationContext.tsx` 在调用 `/api/activation/status`
- ✅ 没有其他组件/hooks/utils 中的直接 fetch 调用
- ✅ 所有 activation 请求都已收口到 `ActivationContext`

## 3.3 全局搜索 useSession / SessionProvider / useAppSession

### 调查结果

| 文件路径 | 行号 | 说明 |
|---------|------|------|
| `src/contexts/SessionContext.tsx` | 56 | ✅ 唯一调用 `useSession()` 的地方 |
| `src/components/AuthProvider.tsx` | 13 | ✅ 唯一使用 `SessionProvider` 的地方 |
| `src/contexts/ActivationContext.tsx` | 116 | ✅ 使用 `useAppSession()` |
| `src/app/study/StudyPage.tsx` | 16 | ✅ 使用 `useAppSession()` |
| `src/app/login/phone/page.tsx` | 11 | ✅ 使用 `useAppSession()` |
| `src/app/profile/ProfilePage.tsx` | 39 | ✅ 使用 `useAppSession()` |
| `src/app/study/select/page.tsx` | 17 | ✅ 使用 `useAppSession()` |
| `src/app/page.tsx` | 81 | ✅ 使用 `useAppSession()` |
| `src/components/AuthGuard.tsx` | 16 | ✅ 使用 `useAppSession()` |
| `src/components/AIActivationProvider.tsx` | 45 | ✅ 使用 `useAppSession()` |

**结论**：
- ✅ 所有组件都统一使用 `useAppSession()`，没有直接使用 `useSession()`
- ✅ 没有发现轮询逻辑：`setInterval` / `setTimeout` / `refetchInterval` / `refreshInterval` 用于 session/activation
- ✅ 发现的 `setInterval` 都是业务逻辑（如倒计时、定时保存等），不是轮询 session/activation

---

# 4. Step 2 — 彻底收口 /api/auth/session 调用

## 4.1 确认 / 重构 SessionProvider

### 修改内容

**文件路径**：`src/components/AuthProvider.tsx`

**修改前**：
```typescript
<SessionProvider
  refetchInterval={0}
  refetchOnWindowFocus={false}
>
```

**修改后**：
```typescript
<SessionProvider
  // ✅ 修复：关闭定时轮询、窗口聚焦刷新、离线重连刷新，避免重复调用 /api/auth/session
  refetchInterval={0}
  refetchOnWindowFocus={false}
  refetchWhenOffline={false}
>
```

### 效果
- ✅ 彻底关闭所有自动刷新机制
- ✅ 前端不再自己刷新 session，只依赖 next-auth React 层的缓存

## 4.2 收口 useSession：统一封装 useAppSession

### 调查结果
- ✅ **已实现**：`src/contexts/SessionContext.tsx` 中已经实现了 `useAppSession()` hook
- ✅ **已统一**：所有组件都使用 `useAppSession()`，没有直接使用 `useSession()`
- ✅ **无轮询**：没有发现任何代码对 `useSession` 直接传入 `refetchInterval` 等参数
- ✅ **无直连**：客户端代码中没有出现 `fetch("/api/auth/session")` 这类直连调用

**结论**：useSession 已经统一收口，无需进一步修改。

---

# 5. Step 3 — 彻底收口 /api/activation/status 调用

## 5.1 清点所有 activation/status 调用

### 调查结果
- ✅ **保留**：`src/contexts/ActivationContext.tsx` 内部对 `/api/activation/status` 的调用
- ✅ **无其他调用**：没有发现其他地方的 `fetch("/api/activation/status")`、`axios.get("/api/activation/status")`、React Query / SWR 钩子等

**结论**：activation/status 调用已经完全收口，无需进一步修改。

## 5.2 确认 / 重构 ActivationContext

### 调查结果
- ✅ **已重构**：`src/contexts/ActivationContext.tsx` 已经按照要求重构
- ✅ **无轮询**：没有 `setInterval` / `setTimeout` 定时轮询
- ✅ **只拉一次**：只在「有 user.id 且 sessionStatus === 'authenticated' 且没拉过」时调一次
- ✅ **统一使用**：所有需要 activation 信息的页面/组件，都统一通过 `useActivation()` 读取

**结论**：ActivationContext 已经符合要求，无需进一步修改。

---

# 6. Step 4 — 进一步静音 [NextAuth][Google] expected redirect_uri 噪音日志

## 6.1 修改 src/lib/auth.ts：增加自定义 logger

### 修改内容

**文件路径**：`src/lib/auth.ts`

**修改前**：
```typescript
// v4: 精简日志 - 只输出 Google Provider 预期的 redirect_uri（唯一真相来源）
const googleCallbackUrl = `${authBaseUrl}/api/auth/callback/google`;
console.log("[NextAuth][Google] expected redirect_uri:", googleCallbackUrl);

export const authOptions: NextAuthConfig = {
  adapter: createPatchedKyselyAdapter(db),
  debug: process.env.NODE_ENV === "development" && process.env.NEXTAUTH_DEBUG === "true",
  // ...
  logger: {
    error(error: Error) { ... },
    warn(message: string) {
      console.warn("[NextAuth][Warn]", message);
    },
    debug(message: string) { ... },
  } as any,
};
```

**修改后**：
```typescript
// ✅ 修复：静音 Google redirect_uri 日志，只在明确启用 debug 时打印
const isDebug =
  process.env.NODE_ENV === "development" &&
  process.env.NEXTAUTH_DEBUG === "true";

if (isDebug) {
  const googleCallbackUrl = `${authBaseUrl}/api/auth/callback/google`;
  console.log("[NextAuth][Google] expected redirect_uri:", googleCallbackUrl);
}

export const authOptions: NextAuthConfig = {
  adapter: createPatchedKyselyAdapter(db),
  debug: isDebug,
  // ...
  logger: {
    error(code: string, metadata?: any) {
      console.error("[NextAuth][Error]", code, metadata);
    },
    warn(code: string, metadata?: any) {
      // ✅ 修复：静音 Google redirect_uri 的噪音日志
      if (
        typeof code === "string" &&
        (code.includes("OAUTH_CALLBACK") ||
          code.includes("expected redirect_uri") ||
          (typeof metadata === "string" && metadata.includes("expected redirect_uri")) ||
          (metadata && typeof metadata === "object" && metadata.providerId === "google"))
      ) {
        // 静音 Google OAuth callback 的噪音日志
        return;
      }
      // 如果以后还有其它想静音的 code，可以在这里加
      console.warn("[NextAuth][Warn]", code, metadata);
    },
    debug(code: string, metadata?: any) {
      if (!isDebug) return;
      console.log("[NextAuth][Debug]", code, metadata);
    },
  } as any,
};
```

### 效果
- ✅ `[NextAuth][Google] expected redirect_uri ...` 这类 debug 日志将被压缩到最小（甚至不再打印）
- ✅ 如果之后需要调某个 login 问题，再临时打开 `NEXTAUTH_DEBUG=true`
- ✅ 保留 error log，避免吞掉真正的错误

---

# 7. Step 5（可选）— 进一步静音 [DB][Config] 日志

## 7.1 修改 src/lib/dbConfig.ts

### 修改内容

**文件路径**：`src/lib/dbConfig.ts`

**修改前**：
```typescript
if (!globalForDb.__DRIVEQUIZ_DB_LOGGED__ && process.env.NODE_ENV === "development") {
  globalForDb.__DRIVEQUIZ_DB_LOGGED__ = true;
  console.log("[DB][Config] Using raw DATABASE_URL (first 80 chars):", ...);
  console.log("[DB][Config] Parsed DATABASE_URL:", {...});
}
```

**修改后**：
```typescript
// ✅ 可选增强：默认 dev 环境不打印，只有手动开启 DB_CONFIG_DEBUG=true 时才打印
const shouldLogDbConfig =
  process.env.NODE_ENV === "development" &&
  process.env.DB_CONFIG_DEBUG === "true";

if (!globalForDb.__DRIVEQUIZ_DB_LOGGED__ && shouldLogDbConfig) {
  globalForDb.__DRIVEQUIZ_DB_LOGGED__ = true;
  console.log("[DB][Config] Using raw DATABASE_URL (first 80 chars):", ...);
  console.log("[DB][Config] Parsed DATABASE_URL:", {...});
}
```

## 7.2 修改 src/lib/db.ts

### 修改内容

**文件路径**：`src/lib/db.ts`

**修改前**：
```typescript
if (!globalForDb.__DRIVEQUIZ_DB_LOGGED__) {
  globalForDb.__DRIVEQUIZ_DB_LOGGED__ = true;
  if (process.env.NODE_ENV === "development") {
    console.log('[DB Pool] Pool created');
  }
}
```

**修改后**：
```typescript
// ✅ 可选增强：默认 dev 环境不打印，只有手动开启 DB_CONFIG_DEBUG=true 时才打印
const shouldLogDbConfig =
  process.env.NODE_ENV === "development" &&
  process.env.DB_CONFIG_DEBUG === "true";

if (!globalForDb.__DRIVEQUIZ_DB_LOGGED__ && shouldLogDbConfig) {
  globalForDb.__DRIVEQUIZ_DB_LOGGED__ = true;
  console.log('[DB Pool] Pool created');
}
```

### 效果
- ✅ 默认 dev 环境不会打印 DB 配置日志
- ✅ 只有手动设置 `DB_CONFIG_DEBUG=true` 时才会打印一次
- ✅ 这样默认 dev 环境不会打印 DB 配置，只有你手动 `DB_CONFIG_DEBUG=true` 时才会打印一次

---

# 8. 实际完成的修改列表

## 8.1 修改文件

| 文件路径 | 修改类型 | 修改说明 |
|---------|---------|---------|
| `src/components/AuthProvider.tsx` | 增强 | 添加 `refetchWhenOffline={false}`，彻底关闭所有自动刷新 |
| `src/lib/auth.ts` | 重构 | 静音 Google redirect_uri 日志，自定义 logger 过滤噪音 |
| `src/lib/dbConfig.ts` | 增强 | 添加 `DB_CONFIG_DEBUG` 开关，默认不打印 DB 配置日志 |
| `src/lib/db.ts` | 增强 | 添加 `DB_CONFIG_DEBUG` 开关，默认不打印 Pool 创建日志 |
| `src/lib/version.ts` | 更新 | 更新版本号为 `2025-12-02 03:33:33` |

## 8.2 新增文件
无

---

# 9. 逐条红线规范自检

## 9.1 架构红线（A）

| 编号 | 规则 | 状态 | 说明 |
|------|------|------|------|
| A1 | 路由层禁止承载业务逻辑 | ✅ 已遵守 | 本次修复不涉及路由层业务逻辑 |
| A2 | 所有核心逻辑必须写入 ai-core | ✅ 不适用 | 本次修复不涉及 AI 功能 |
| A3 | ai-service 与 local-ai-service 行为必须保持完全一致 | ✅ 不适用 | 本次修复不涉及 AI 服务 |
| A4 | 接口参数、返回结构必须保持统一 | ✅ 已遵守 | 所有修改保持接口兼容性 |

## 9.2 数据库 & 文件结构红线（B）

| 编号 | 规则 | 状态 | 说明 |
|------|------|------|------|
| B1 | 任何数据库字段、表结构、索引的修改必须同步更新数据库结构文档 | ✅ 不适用 | 本次修复不涉及数据库结构变更 |
| B2 | 所有文件新增、删除、迁移必须同步更新文件结构文档 | ✅ 不适用 | 本次修复未新增/删除文件 |
| B3 | 所有 Kysely 类型定义必须与数据库结构同步保持一致 | ✅ 已遵守 | 未修改 Kysely 类型定义 |
| B4 | DriveQuiz 主库与 AI Service 库的 schema 需保持文档同步 | ✅ 不适用 | 本次修复不涉及 schema 变更 |

## 9.3 测试红线（C）

| 编号 | 规则 | 状态 | 说明 |
|------|------|------|------|
| C1 | 涉及 AI 功能必须同时测试：local-ai-service & 远程 ai-service | ✅ 不适用 | 本次修复不涉及 AI 功能 |
| C2 | 必须输出测试日志摘要（请求、响应、耗时、错误） | ⚠️ 待验证 | 需要在本地环境进行验证 |
| C3 | 若测试失败，必须主动继续排查，不得要求用户手动重试 | ✅ 已遵守 | 代码修改已完成，等待验证 |

## 9.4 执行报告红线（D）

| 编号 | 规则 | 状态 | 说明 |
|------|------|------|------|
| D1 | 任务结束必须按模板输出完整执行报告 | ✅ 已遵守 | 本报告即为完整执行报告 |
| D2 | 必须逐条对照 A1–D2，标注"已遵守 / 不适用 / 必须修复" | ✅ 已遵守 | 已在 9.1-9.4 节逐条标注 |

---

# 10. Step 6 — 本地自测脚本

## 10.1 测试步骤

1. **启动 dev**：
   ```bash
   npm run dev
   ```

2. **打开浏览器**，访问：`http://localhost:3000/`

3. **只打开一个标签页**

4. **等待 10 秒**，不操作其它页面

5. **点击浏览器刷新一次**，再等 10 秒

6. **在终端里统计**：
   - `[Diag][SESSION_ROUTE_HIT]` 的数量
   - `[Diag][ACTIVATION_ROUTE_HIT]` 的数量
   - `[NextAuth][Google] expected redirect_uri` 是否还出现

## 10.2 预期结果

| 项目 | 预期 | 说明 |
|------|------|------|
| Session：总次数 | 2–5 次 | 包含那次刷新，考虑 StrictMode 双 render |
| Activation：总次数 | 1–3 次 | 包含那次刷新 |
| `[NextAuth][Google] expected redirect_uri` | 不再出现 | 除非 `NEXTAUTH_DEBUG=true` |

## 10.3 实际统计值（待验证）

**注意**：由于无法在当前环境中实际运行 `npm run dev`，建议用户按照上述步骤进行验证，并在验证后更新本报告。

### 测试场景：仅打开首页，刷新一次，不打开 admin 心跳页

- `[Diag][SESSION_ROUTE_HIT]`: ⚠️ 待验证
- `[Diag][ACTIVATION_ROUTE_HIT]`: ⚠️ 待验证
- `[NextAuth][Google] expected redirect_uri`: ⚠️ 待验证（预期：不再出现）

**结论**：待用户验证后更新。

---

# 11. 详细修改说明

## 11.1 SessionProvider 配置增强

### 修改前
```typescript
<SessionProvider
  refetchInterval={0}
  refetchOnWindowFocus={false}
>
```

### 修改后
```typescript
<SessionProvider
  refetchInterval={0}
  refetchOnWindowFocus={false}
  refetchWhenOffline={false}  // ✅ 新增
>
```

### 优势
- 彻底关闭所有自动刷新机制
- 包括定时轮询、窗口聚焦刷新、离线重连刷新
- 前端不再自己刷新 session，只依赖 next-auth React 层的缓存

## 11.2 NextAuth logger 自定义

### 修改前
- Google redirect_uri 日志在模块加载时直接打印
- logger.warn 直接打印所有警告

### 修改后
- Google redirect_uri 日志只在 `NEXTAUTH_DEBUG=true` 时打印
- logger.warn 过滤掉 Google OAuth callback 相关的噪音日志
- 保留 error log，避免吞掉真正的错误

### 优势
- 大幅减少噪音日志
- 如果之后需要调某个 login 问题，再临时打开 `NEXTAUTH_DEBUG=true`

## 11.3 DB Config 日志开关

### 修改前
- 默认 dev 环境会打印 DB 配置日志

### 修改后
- 默认 dev 环境不打印 DB 配置日志
- 只有手动设置 `DB_CONFIG_DEBUG=true` 时才会打印一次

### 优势
- 进一步减少噪音日志
- 需要调试 DB 配置时，可以手动开启

---

# 12. 风险点与后续建议

## 12.1 风险点

### 风险 1：Next.js Dev 模式 StrictMode 双调用
**风险描述**：在 Next.js 开发模式下，StrictMode 会双调用 effect，可能导致重复请求。

**缓解措施**：
- 使用 `hasFetchedRef` 和 `lastUserIdRef` 确保同一个 userId 只请求一次
- 使用 window 级别 Promise 共享，防止多个 Provider 实例同时请求
- 预期请求次数已经考虑了 StrictMode 的影响（2–5 次）

### 风险 2：环境变量未设置
**风险描述**：如果用户需要调试，但忘记设置 `NEXTAUTH_DEBUG=true` 或 `DB_CONFIG_DEBUG=true`，可能看不到必要的日志。

**缓解措施**：
- 在文档中明确说明如何开启调试日志
- 如果遇到问题，可以临时设置环境变量来查看详细日志

## 12.2 后续建议

1. **验证 session/activation 请求次数**：
   - 在浏览器开发者工具中观察 `[Diag]` 日志
   - 确认请求次数符合预期（Session：2–5 次，Activation：1–3 次）

2. **验证 NextAuth 日志**：
   - 确认 `[NextAuth][Google] expected redirect_uri` 不再出现
   - 如果需要调试，设置 `NEXTAUTH_DEBUG=true`

3. **验证 DB Config 日志**：
   - 确认 `[DB][Config]` 日志不再出现（除非设置 `DB_CONFIG_DEBUG=true`）
   - 如果需要调试，设置 `DB_CONFIG_DEBUG=true`

---

# 13. 总结

## 13.1 本次修复完成情况

| 任务项 | 状态 | 说明 |
|--------|------|------|
| SessionProvider 配置增强 | ✅ 已完成 | 添加 `refetchWhenOffline={false}` |
| NextAuth logger 自定义 | ✅ 已完成 | 静音 Google redirect_uri 日志 |
| DB Config 日志开关 | ✅ 已完成 | 添加 `DB_CONFIG_DEBUG` 开关 |
| ActivationContext 确认 | ✅ 已确认 | 已经符合要求，无需修改 |
| useAppSession 确认 | ✅ 已确认 | 已经统一收口，无需修改 |

## 13.2 当前版本号
**BUILD_TIME**: `2025-12-02 03:33:33`

## 13.3 下一步建议
1. 在本地环境进行实际验证，确认首页刷新时的请求数量和日志输出
2. 观察 `[Diag]` 日志，确认请求次数符合预期
3. 确认 `[NextAuth][Google] expected redirect_uri` 不再出现
4. 如果发现仍有问题，根据 `[Diag]` 日志定位问题来源

---

**报告生成时间**: 2025-12-02 03:33:33  
**报告版本**: v2  
**任务状态**: ✅ 已完成（待本地验证）

