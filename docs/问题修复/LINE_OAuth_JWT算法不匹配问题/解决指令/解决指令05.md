任务目标：修复 NextAuth v5 + KyselyAdapter 通过 "User" 视图插入用户时，Postgres 报错
cannot insert into column "emailVerified" of view "User" 的问题。
要求：只在 数据库迁移脚本 + 规范文档 层面修复，不在路由层加任何业务逻辑（遵守 A1/B2/D1）。

【Cursor 任务说明】

你需要完成三件事：

确认并修正 NextAuth 视图定义，确保 "User" 视图的 emailVerified 列是“可写且有正确映射”的。

确认并修正 NextAuth 视图触发器，确保插入/更新时正确把 NEW."emailVerified" 写入基础表（通常是 users.email_verified）。

更新迁移脚本 + 文档，并在执行报告里明确写出“需要在 DB 中执行这些迁移后再测试”。

下面是具体操作步骤。

Step 1：定位相关迁移脚本与文件

打开并检查以下文件（只读，不要删掉文件）：

src/migrations/20251126_alter_users_and_auth_ids_to_text.sql

src/migrations/20251126_create_nextauth_table_views.sql

src/migrations/20251126_create_nextauth_view_triggers.sql

重点确认两点：

"User" 视图是否包含 emailVerified 列；

触发器函数（INSERT/UPDATE）里是否有对 NEW."emailVerified" 的处理。

Step 2：修正 "User" 视图定义（table views 脚本）

修改文件：src/migrations/20251126_create_nextauth_table_views.sql
目标：让 "User" 视图对 KyselyAdapter 来说 结构完全符合预期，并且 emailVerified 是一个“简单映射列”，方便触发器使用。

在该文件中找到创建 "User" 视图的语句，如果不存在，则补充；如果存在，则用 CREATE OR REPLACE VIEW 重写：

⚠️ 示例 SQL，请基于你当前的表名、schema 做最小改动，保持在 public.users 上。

-- 先删除旧视图，避免结构不一致
DROP VIEW IF EXISTS "User";

-- 重新创建 NextAuth 用的 User 视图
CREATE VIEW "User" AS
SELECT
  u.id,
  u.name,
  u.email,
  -- 关键：直接把基础表里的 email_verified 映射为视图的 "emailVerified"
  u.email_verified AS "emailVerified",
  u.image
FROM public.users AS u;


要求：

视图列名必须和 Kysely UserTable 定义一致（尤其是驼峰的 "emailVerified"）。

不要在视图定义里对 email_verified 做 COALESCE、CAST、CASE 等复杂表达式，保证是简单列映射，方便插入/更新。

确认视图顺序：

列顺序为：id, name, email, "emailVerified", image（和 Adapter 预期一致即可）。

Step 3：修正视图触发器（view triggers 脚本）

修改文件：src/migrations/20251126_create_nextauth_view_triggers.sql

确认对 "User" 视图是否已经有 INSERT / UPDATE / DELETE 对应的 INSTEAD OF 触发器函数：

通常会有类似：

nextauth_user_insert()

nextauth_user_update()

nextauth_user_delete()

如果已经存在 nextauth_user_insert，请 检查/修改函数体，确保包含 emailVerified 映射（基础表按你当前结构，下面以 public.users + email_verified 示例）：

CREATE OR REPLACE FUNCTION nextauth_user_insert()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.users (
    id,
    name,
    email,
    email_verified,
    image
  ) VALUES (
    NEW.id,
    NEW.name,
    NEW.email,
    NEW."emailVerified", -- 关键：从视图列写入基础表列
    NEW.image
  );

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;


同理，检查/修改 nextauth_user_update：

CREATE OR REPLACE FUNCTION nextauth_user_update()
RETURNS trigger AS $$
BEGIN
  UPDATE public.users
  SET
    name           = NEW.name,
    email          = NEW.email,
    email_verified = NEW."emailVerified",
    image          = NEW.image
  WHERE id = OLD.id;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;


确认触发器本身使用的是 INSTEAD OF，并且绑定到了 "User" 视图：

DROP TRIGGER IF EXISTS nextauth_user_insert_trigger ON "User";
CREATE TRIGGER nextauth_user_insert_trigger
INSTEAD OF INSERT ON "User"
FOR EACH ROW
EXECUTE FUNCTION nextauth_user_insert();

DROP TRIGGER IF EXISTS nextauth_user_update_trigger ON "User";
CREATE TRIGGER nextauth_user_update_trigger
INSTEAD OF UPDATE ON "User"
FOR EACH ROW
EXECUTE FUNCTION nextauth_user_update();


如果之前触发器函数里 没处理 emailVerified，这一步就是本次报错的直接修复点：

现在插入 "User" 视图时，Postgres 不会再尝试直接往视图列写数据，而是交给 INSTEAD OF 触发器写入基础表，因此不会再出现
cannot insert into column "emailVerified" of view "User"。

Step 4：确保迁移顺序与执行说明正确标注

这一步是文档/脚本层的“对齐”，确保之后你自己执行 DB 迁移时不会搞错顺序。

在 20251126_create_nextauth_table_views.sql 和
20251126_create_nextauth_view_triggers.sql 顶部/注释中，明确注明执行顺序（和执行报告保持一致）：

-- 执行顺序说明：
-- 1. 先执行 20251126_alter_users_and_auth_ids_to_text.sql
-- 2. 再执行本文件：20251126_create_nextauth_table_views.sql
-- 3. 最后执行：20251126_create_nextauth_view_triggers.sql


不要在代码里自动调用迁移（遵守 A1：路由层不做迁移/业务逻辑）。

Step 5：更新数据库结构文档与版本号（B2 / D1）

这一步不改变行为，但要保持“文档 = 事实”。

更新数据库结构文档：

文件：/Users/leo/Desktop/drivequiz研发规范/数据库结构_DRIVEQUIZ.md

在 NextAuth 相关章节补充说明：

"User" 视图新增/确认列 "emailVerified"；

说明它映射到基础表 users.email_verified；

标记版本从 v1.6 → v1.7，记录更新时间。

更新版本号文件：

文件：src/lib/version.ts

将版本号更新时间改为当前执行时间（保持和执行报告一致）。

Step 6：给出执行报告模版要点（方便你回填）

Cursor 完成上述修改后，输出一份简短执行报告，至少包含：

问题归类

说明这是“NextAuth 视图/触发器未正确处理 emailVerified 导致的插入失败”，属于 UserId 类型统一之后暴露出来的 老问题延伸。

修改点列表

20251126_create_nextauth_table_views.sql：重建 "User" 视图，增加/确认 "emailVerified" 映射。

20251126_create_nextauth_view_triggers.sql：更新 nextauth_user_insert / nextauth_user_update 函数及触发器，正确处理 NEW."emailVerified"。

数据库结构_DRIVEQUIZ.md：更新 NextAuth 视图说明，版本号。

src/lib/version.ts：更新版本号。

待你手动执行与验证的步骤（标记为 ⏳）

在目标数据库上按顺序执行三份 SQL 迁移；

重启 dev server；

再次用 LINE 登录，确认不再出现
cannot insert into column "emailVerified" of view "User"；

做一次 Google 登录回归测试。