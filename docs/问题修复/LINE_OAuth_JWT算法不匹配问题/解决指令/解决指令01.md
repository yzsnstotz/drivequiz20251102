STEP 1ï¼šå®šä½ Auth é…ç½®æ–‡ä»¶

åœ¨ä»“åº“ä¸­æŸ¥æ‰¾ NextAuth( æˆ– import NextAuth from "next-auth"ã€‚

ç¡®è®¤é›†ä¸­é…ç½®æ–‡ä»¶è·¯å¾„ï¼š

å¦‚æœå­˜åœ¨ src/lib/auth.tsï¼Œä¼˜å…ˆä½¿ç”¨è¿™é‡Œã€‚

å¦åˆ™ä½¿ç”¨ src/auth.tsï¼ˆæˆ–é¡¹ç›®ä¸­å·²æœ‰çš„ç­‰ä»·æ–‡ä»¶ï¼‰ã€‚

åç»­æŒ‡ä»¤ç”¨ <AUTH_CONFIG_FILE> ä»£ç§°è¿™ä¸ªæ–‡ä»¶ã€‚

STEP 2ï¼šä¿®æ”¹ LINE Provider é…ç½®

åœ¨ <AUTH_CONFIG_FILE> ä¸­æ‰¾åˆ° Line Provider çš„é…ç½®ï¼Œå¤§è‡´ç±»ä¼¼ï¼š

import Line from "next-auth/providers/line";
// ...

export const { handlers, auth, signIn, signOut } = NextAuth({
  // ...
  providers: [
    Google({
      // ...
    }),
    Line({
      clientId: process.env.AUTH_LINE_ID!,
      clientSecret: process.env.AUTH_LINE_SECRET!,
      // å¯èƒ½è¿˜æœ‰å…¶å®ƒå‚æ•°
    }),
  ],
  // ...
});


åœ¨ ä¿æŒå·²æœ‰é…ç½®ä¸å˜ çš„å‰æä¸‹ï¼Œç»™ Line(...) é‡Œçš„å¯¹è±¡å¢åŠ  client å­—æ®µï¼š

âœ‚ï¸ è¯·è®© Cursor åšå¦‚ä¸‹ ç²¾ç¡®æ”¹åŠ¨ï¼š

å¦‚æœç›®å‰ Line é…ç½®æ˜¯è¿™æ ·ï¼š

Line({
  clientId: process.env.AUTH_LINE_ID!,
  clientSecret: process.env.AUTH_LINE_SECRET!,
}),


ğŸ‘‰ ä¿®æ”¹ä¸ºï¼š

Line({
  clientId: process.env.AUTH_LINE_ID!,
  clientSecret: process.env.AUTH_LINE_SECRET!,
  // å‘Šè¯‰ Auth.js / oauth4webapiï¼šLINE çš„ id_token ä½¿ç”¨ HS256
  client: {
    id_token_signed_response_alg: "HS256",
  },
}),


å¦‚æœå·²ç»å­˜åœ¨ client: { ... } é…ç½®ï¼Œåˆ™ åªéœ€è¦åœ¨å…¶ä¸­è¡¥ä¸€è¡Œï¼š

client: {
  // ä¿ç•™å·²æœ‰é…ç½®
  // ...
  id_token_signed_response_alg: "HS256",
},


ä¸è¦æ”¹åŠ¨ï¼š

å…¶ä»– Provider çš„é…ç½®ï¼ˆå¦‚ Googleï¼‰ã€‚

checks, idToken, authorization, token, userinfo ç­‰ç°æœ‰é…ç½®ã€‚

STEP 3ï¼šç¡®è®¤ route.ts ä¸æ‰¿è½½ä¸šåŠ¡é€»è¾‘

æ£€æŸ¥ src/app/api/auth/[...nextauth]/route.tsï¼Œç¡®ä¿æ˜¯ç±»ä¼¼ä¸‹é¢çš„å½¢å¼ï¼š

import { handlers } from "@/lib/auth"; // æˆ– "@/auth"

export const { GET, POST } = handlers;


å¦‚æœè¿™é‡Œæœ‰å¤šä½™é€»è¾‘ï¼ˆä¸å¤ªå¯èƒ½å½±å“å½“å‰é”™è¯¯ï¼Œä½†è¿èƒŒä½ è‡ªå·±çš„ A1 è§„èŒƒï¼‰ï¼Œå¯ä»¥é¡ºæ‰‹ï¼š

åˆ é™¤ä¸ä¸šåŠ¡ç›¸å…³çš„ä»£ç ï¼Œåªä¿ç•™ GET/POST è½¬å‘ã€‚

ï¼ˆå¦‚æœ Cursor éœ€è¦åŒæ­¥æ‰§è¡Œè¿™ä¸€æ­¥ï¼Œå¯ä»¥ä¸€èµ·åšï¼›å¦åˆ™å¯æš‚æ—¶ä¸åŠ¨ï¼Œè¿™ä¸ªé—®é¢˜ä¸ä½ å½“å‰çš„ HS256 æŠ¥é”™æ— å…³ã€‚ï¼‰

ğŸ” éªŒè¯æ­¥éª¤ï¼ˆè®© Cursor ä¹Ÿå†™åˆ°æ‰§è¡ŒæŠ¥å‘Šé‡Œï¼‰

ä¿®æ”¹å®Œæˆåï¼Œè¯· Cursor åœ¨â€œæ‰§è¡ŒæŠ¥å‘Šâ€é‡ŒæŒ‰ä»¥ä¸‹æ­¥éª¤è‡ªæµ‹å¹¶è®°å½•ç»“æœï¼š

é‡å¯ dev server

pnpm dev  # æˆ–ä½ é¡¹ç›®å½“å‰ä½¿ç”¨çš„å¯åŠ¨å‘½ä»¤


åœ¨æµè§ˆå™¨é‡Œæµ‹è¯• LINE ç™»å½•

è®¿é—®ï¼šhttp://localhost:3000/api/auth/signin

ç‚¹å‡» LINE ç™»å½•æŒ‰é’®ï¼Œå®Œæˆæˆæƒã€‚

è§‚å¯ŸæœåŠ¡å™¨æ—¥å¿—ï¼š

åŸæ¥çš„é”™è¯¯ï¼š

OperationProcessingError: unexpected JWT "alg" header parameter
...
"header": { "typ": "JWT", "alg": "HS256" },
"expected": "RS256",
"reason": "default value",
"provider": "line"


ä¿®å¤ååº”æ»¡è¶³ï¼š

ä¸å†å‡ºç° unexpected JWT "alg"ã€‚

ç”¨æˆ·å¯ä»¥æ­£å¸¸å®Œæˆå›è°ƒå¹¶åˆ›å»º sessionã€‚

å¦‚æœæœ‰ debug logï¼Œ[auth][details] ä¸­çš„ expected åº”è¯¥å˜ä¸º "HS256"ï¼ˆæˆ–ä¸å†è¾“å‡ºè¯¥æŠ¥é”™ï¼‰ã€‚

å›å½’æµ‹è¯• Google ç™»å½•

é€šè¿‡ Google ä¹Ÿç™»å½•ä¸€æ¬¡ï¼Œç¡®è®¤åŸæœ¬æ­£å¸¸çš„ provider ä¸å—å½±å“ã€‚

åœ¨æ‰§è¡ŒæŠ¥å‘Šä¸­å†™æ˜ï¼š

ä¿®æ”¹è¿‡çš„æ–‡ä»¶è·¯å¾„ä¸å…³é”® diffï¼ˆå°¤å…¶æ˜¯å¢åŠ çš„ client.id_token_signed_response_algï¼‰ã€‚

LINE ç™»å½•å›è°ƒæ˜¯å¦æˆåŠŸã€‚

æ˜¯å¦ä»ç„¶æœ‰ [auth][error] CallbackRouteError ç›¸å…³æ—¥å¿—ã€‚