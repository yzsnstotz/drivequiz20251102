ğŸ¯ ç›®æ ‡

å½“å‰ LINE ç™»å½•å›è°ƒæŠ¥é”™ï¼š

OperationProcessingError: unexpected JWT "alg" header parameter
[auth][details]: {
  "header": { "typ": "JWT", "alg": "HS256" },
  "expected": "RS256",
  "reason": "default value",
  "provider": "line"
}


è¯´æ˜ä¸¤ä»¶äº‹ï¼š

LINE è¿”å›çš„ id_token ç”¨çš„æ˜¯ HS256ã€‚

Auth.js / oauth4webapi é»˜è®¤æœŸæœ› RS256ï¼ˆreason: "default value"ï¼‰ï¼Œä»ç„¶åœ¨å°è¯•æ ¡éªŒ id_tokenã€‚

æˆ‘ä»¬è¦åšä¸¤å±‚é˜²æŠ¤ï¼š

å°½é‡ ä¸è¯·æ±‚ / ä¸ä¾èµ– id_tokenï¼Œåªèµ° access_token + userinfoã€‚

å³ä¾¿æœ‰ id_tokenï¼Œä¹Ÿè¦æŠŠ æœŸæœ›ç®—æ³•æ”¹æˆ HS256ï¼Œé¿å… RS256 é»˜è®¤å€¼æŠ¥é”™ã€‚

ğŸ›  ä¿®æ”¹èŒƒå›´

åªä¿®æ”¹ï¼šsrc/lib/auth.ts ä¸­è‡ªå®šä¹‰çš„ line provider é…ç½®å¯¹è±¡ã€‚

è·¯ç”±å±‚ src/app/api/auth/[...nextauth]/route.ts ä¸åšä»»ä½•ä¿®æ”¹ï¼ˆä¿æŒåªè°ƒç”¨ NextAuthï¼‰ã€‚

STEP 1ï¼šè°ƒæ•´ scopeï¼Œé¿å…è¯·æ±‚ id_token

æ‰“å¼€ï¼šsrc/lib/auth.ts

æ‰¾åˆ°æˆ‘ä»¬ä¹‹å‰å†™å…¥çš„è‡ªå®šä¹‰ LINE Providerï¼ˆå¤§è‡´é•¿è¿™æ ·ï¼‰ï¼š

{
  id: "line",
  name: "LINE",
  type: "oauth",
  clientId: process.env.LINE_CLIENT_ID || "",
  clientSecret: process.env.LINE_CLIENT_SECRET || "",
  checks: ["pkce", "state"],
  authorization: {
    url: "https://access.line.me/oauth2/v2.1/authorize",
    params: {
      response_type: "code",
      scope: "openid profile email",
    },
  },
  token: "https://api.line.me/oauth2/v2.1/token",
  userinfo: "https://api.line.me/v2/profile",
  async profile(profile: any) {
    return {
      id: profile.userId,
      name: profile.displayName,
      image: profile.pictureUrl,
      email: profile.email || null,
    };
  },
},


ä¿®æ”¹ scopeï¼ŒæŠŠ openid å’Œ email éƒ½å…ˆå»æ‰ï¼Œåªä¿ç•™ profileï¼Œé¿å… LINE ä¸‹å‘ id_tokenï¼š

authorization: {
  url: "https://access.line.me/oauth2/v2.1/authorize",
  params: {
    response_type: "code",
    scope: "profile", // ğŸ” è¿™é‡Œä» "openid profile email" æ”¹æˆ "profile"
  },
},


è¯´æ˜ï¼š

scope ä¸å« openid æ—¶ï¼ŒLINE å°± ä¸ä¼šè¿”å› id_tokenï¼ŒAuth.js ä¹Ÿå°±ä¸ä¼šå°è¯•å¯¹ id_token åš JWT æ ¡éªŒï¼Œè‡ªç„¶ä¸ä¼šè§¦å‘ alg é”™è¯¯ã€‚

æˆ‘ä»¬ç›®å‰åªç”¨ profile ä¿¡æ¯ï¼ˆuserId / displayName / pictureUrlï¼‰ï¼Œä¸ä¾èµ– email å’Œ OIDC claimsï¼Œè¿™æ ·æ˜¯è¶³å¤Ÿçš„ã€‚

STEP 2ï¼šæ˜¾å¼å‘Šè¯‰ Auth.js æœŸæœ› HS256ï¼ˆä¿é™©èµ·è§ï¼‰

å³ä¾¿æœ‰äº›æƒ…å†µä¸‹ LINE è¿˜æ˜¯å¸¦äº† id_tokenï¼Œæˆ‘ä»¬ä¹ŸæŠŠæœŸæœ›ç®—æ³•ä»é»˜è®¤ RS256 æ”¹æˆ HS256ï¼Œé¿å…å†æŠ¥åŒæ ·çš„é”™ã€‚

ç»§ç»­åœ¨ line provider å¯¹è±¡é‡Œï¼Œå¢åŠ  client å­—æ®µï¼š

{
  id: "line",
  name: "LINE",
  type: "oauth",
  clientId: process.env.LINE_CLIENT_ID || "",
  clientSecret: process.env.LINE_CLIENT_SECRET || "",
  // âœ… æ–°å¢ client é…ç½®ï¼Œè¦†ç›–é»˜è®¤ RS256
  client: {
    // ä¸»è¦æ˜¯è¿™ä¸€è¡Œï¼šæŠŠ id_token ç­¾åç®—æ³•ä»é»˜è®¤ RS256 æ”¹ä¸º HS256
    id_token_signed_response_alg: "HS256",
    // å¯ä»¥é¡ºä¾¿æŒ‡å®šè®¤è¯æ–¹å¼ï¼ˆéå¿…é¡»ï¼ŒæŒ‰éœ€ï¼‰
    token_endpoint_auth_method: "client_secret_basic",
  },
  checks: ["pkce", "state"],
  authorization: {
    url: "https://access.line.me/oauth2/v2.1/authorize",
    params: {
      response_type: "code",
      scope: "profile",
    },
  },
  token: "https://api.line.me/oauth2/v2.1/token",
  userinfo: "https://api.line.me/v2/profile",
  async profile(profile: any) {
    return {
      id: profile.userId,
      name: profile.displayName,
      image: profile.pictureUrl,
      email: null, // ç°åœ¨æˆ‘ä»¬ä¸èµ° email äº†ï¼Œç»Ÿä¸€è®¾ä¸º null
    };
  },
},


è¦ç‚¹ï¼š

id_token_signed_response_alg: "HS256" æ˜¯ç»™ oauth4webapi ç”¨çš„ï¼Œé˜²æ­¢å®ƒå†ç”¨é»˜è®¤ RS256 å»æ£€æŸ¥ HS256 çš„ tokenã€‚

å³ä½¿ scope å·²ç»å»æ‰ openidï¼Œè¿™ä¸€æ­¥ä¹Ÿä½œä¸ºâ€œå…œåº•â€ã€‚

STEP 3ï¼šç¡®è®¤æ²¡æœ‰æ®‹ç•™æ—§çš„ LineProvider / å†…ç½® line é…ç½®

å†åšä¸€æ¬¡æ¸…ç†æ£€æŸ¥ï¼ˆé˜²æ­¢å¤šä¸ªåŒå provider å¹²æ‰°ï¼‰ï¼š

åœ¨æ•´ä¸ªé¡¹ç›®é‡Œæœç´¢ "next-auth/providers/line"ï¼Œç¡®è®¤ï¼š

âŒ ä¸å†å­˜åœ¨ import Line from "next-auth/providers/line" æˆ–ç±»ä¼¼å†™æ³•ã€‚

æœç´¢ LineProviderï¼š

âŒ ä¸åº”å†æœ‰ LineProvider(...)ã€lineProviderBase ç­‰æ—§åŒ…è£…ä»£ç ã€‚

ç¡®è®¤ providers: [...] æ•°ç»„é‡Œ åªæœ‰ä¸€ä¸ª id: "line" çš„å¯¹è±¡ï¼Œå°±æ˜¯æˆ‘ä»¬è¿™æ¬¡æ”¹çš„è¿™ä¸ªã€‚

STEP 4ï¼šè®© Cursor æ‰§è¡Œåçš„è‡ªæ£€ & è¾“å‡ºè¦æ±‚

è®© Cursor å®Œæˆä¿®æ”¹åï¼ŒæŒ‰ä¸‹é¢å‡ ç‚¹åœ¨æ‰§è¡ŒæŠ¥å‘Šé‡Œè¯´æ˜ï¼ˆæ–¹ä¾¿ä½ å¯¹ç…§ logï¼‰ï¼š

æ–‡ä»¶ & diff æ¦‚è¦

ä¿®æ”¹äº† src/lib/auth.ts ä¸­ line providerï¼š

scope ä» "openid profile email" æ”¹ä¸º "profile"ã€‚

æ–°å¢ client: { id_token_signed_response_alg: "HS256", ... }ã€‚

ç¡®è®¤é¡¹ç›®ä¸­ä¸å†å¼•ç”¨ next-auth/providers/line å’Œä»»ä½• LineProvider åŒ…è£…ã€‚

æœ¬åœ°è¿è¡Œç»“æœï¼ˆCursor è‡ªæµ‹ï¼‰

å¯åŠ¨ dev æœåŠ¡å™¨æ˜¯å¦æˆåŠŸï¼ˆæ—  TS / ç¼–è¯‘é”™è¯¯ï¼‰ã€‚

æµ‹è¯•è°ƒç”¨ /api/auth/signin/line å¹¶å®Œæˆä¸€è½® OAuth æ˜¯å¦ä»ç„¶è§¦å‘ unexpected JWT "alg" æŠ¥é”™ï¼ˆé¢„æœŸï¼šä¸å†è§¦å‘ï¼‰ã€‚