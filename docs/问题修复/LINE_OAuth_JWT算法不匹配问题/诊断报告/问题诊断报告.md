# LINE OAuth JWT ç®—æ³•ä¸åŒ¹é…é—®é¢˜è¯Šæ–­æŠ¥å‘Š

**æŠ¥å‘Šæ—¥æœŸ**: 2025-11-26  
**é—®é¢˜ID**: LINE-OAUTH-20251126-001

---

## ğŸ“Œ ç¬¬ä¸€éƒ¨åˆ†ï¼šé—®é¢˜æ¦‚è¦ï¼ˆSummaryï¼‰

| å­—æ®µ | å¡«å†™å†…å®¹ |
|------|----------|
| **é—®é¢˜åç§°** | LINE OAuth ç™»å½•æ—¶ NextAuth éªŒè¯ ID token å¤±è´¥ï¼šJWT ç®—æ³•ä¸åŒ¹é…ï¼ˆHS256 vs RS256ï¼‰ |
| **é—®é¢˜ç­‰çº§** | Criticalï¼ˆé˜»å¡ LINE OAuth ç™»å½•åŠŸèƒ½ï¼‰ |
| **è§¦å‘æ—¶é—´** | 2025-11-26ï¼ˆåå¤å‡ºç°ï¼‰ |
| **è§¦å‘ç¯å¢ƒ** | Development / Production |
| **ç›¸å…³æ¨¡å—** | auth / login / oauth / nextauth / line |
| **å½“å‰çŠ¶æ€** | å¯å¤ç°ï¼Œå·²å°è¯•å¤šæ¬¡ä¿®å¤ä½†é—®é¢˜ä¾ç„¶å­˜åœ¨ |

---

## ğŸ“Œ ç¬¬äºŒéƒ¨åˆ†ï¼šå¤ç°è·¯å¾„ï¼ˆReproduce Stepsï¼‰

### å‰ç«¯æ“ä½œæ­¥éª¤

1. å¯åŠ¨ Next.js å¼€å‘æœåŠ¡å™¨ï¼ˆ`npm run dev`ï¼‰
2. è®¿é—®ç™»å½•é¡µé¢ï¼ˆ`http://localhost:3000/login`ï¼‰
3. ç‚¹å‡» "ä½¿ç”¨ LINE ç™»å½•" æŒ‰é’®
4. é€‰æ‹© "è·³è½¬æˆæƒ" ç™»å½•æ–¹å¼
5. ç‚¹å‡» "è·³è½¬æˆæƒ" æŒ‰é’®
6. åœ¨ LINE æˆæƒé¡µé¢å®Œæˆæˆæƒ
7. æˆæƒæˆåŠŸåï¼Œç³»ç»Ÿå°è¯•å¤„ç†å›è°ƒ

### è§¦å‘ç‚¹

- LINE OAuth æˆæƒæˆåŠŸï¼Œè¿”å›æˆæƒç ï¼ˆ`code`ï¼‰
- NextAuth ä½¿ç”¨æˆæƒç æ¢å– access token å’Œ id_token
- LINE API è¿”å›çš„ token å“åº”ä¸­åŒ…å« `id_token`ï¼ˆä½¿ç”¨ HS256 ç®—æ³•ç­¾åï¼‰
- NextAuth å°è¯•éªŒè¯ `id_token` æ—¶ï¼Œå‘ç°ç®—æ³•ä¸åŒ¹é…ï¼ˆæœŸæœ› RS256ï¼Œå®é™…ä¸º HS256ï¼‰
- éªŒè¯å¤±è´¥ï¼ŒæŠ›å‡º `OperationProcessingError`

### é”™è¯¯ä¿¡æ¯

```
[auth][error] CallbackRouteError: Read more at https://errors.authjs.dev#callbackrouteerror
[auth][cause]: OperationProcessingError: unexpected JWT "alg" header parameter
[auth][details]: {
  "header": {
    "typ": "JWT",
    "alg": "HS256"
  },
  "expected": "RS256",
  "reason": "default value",
  "provider": "line"
}
```

### é”™è¯¯å †æ ˆ

```
at OPE (webpack-internal:///(rsc)/./node_modules/oauth4webapi/build/index.js:214:12)
at checkSigningAlgorithm (webpack-internal:///(rsc)/./node_modules/oauth4webapi/build/index.js:2129:19)
at validateJwt (webpack-internal:///(rsc)/./node_modules/oauth4webapi/build/index.js:1831:5)
at processGenericAccessTokenResponse (webpack-internal:///(rsc)/./node_modules/oauth4webapi/build/index.js:1351:39)
at processAuthorizationCodeOAuth2Response (webpack-internal:///(rsc)/./node_modules/oauth4webapi/build/index.js:1545:20)
at handleOAuth (webpack-internal:///(rsc)/./node_modules/next-auth/node_modules/@auth/core/lib/actions/callback/oauth/callback.js:173:35)
```

### æ“ä½œç³»ç»Ÿ / æµè§ˆå™¨ / Node ç‰ˆæœ¬

- macOS / Chrome / Node.js 22.12.0
- Next.js version: 15.5.6
- NextAuth version: 5.0.0-beta.30
- LINE OAuth 2.1 API

---

## ğŸ“Œ ç¬¬ä¸‰éƒ¨åˆ†ï¼šå®é™…è¡Œä¸º vs é¢„æœŸè¡Œä¸º

### å®é™…è¡Œä¸º

1. âœ… LINE OAuth æˆæƒæˆåŠŸ
2. âœ… æˆæƒç è·å–æˆåŠŸ
3. âœ… Token äº¤æ¢æˆåŠŸï¼ˆè·å– access_token å’Œ id_tokenï¼‰
4. âŒ NextAuth å°è¯•éªŒè¯ id_token æ—¶å¤±è´¥
5. âŒ é”™è¯¯ï¼š`unexpected JWT "alg" header parameter`ï¼ˆHS256 vs RS256ï¼‰
6. âŒ ç”¨æˆ·è¢«é‡å®šå‘åˆ°é”™è¯¯é¡µé¢ (`/login/error?error=Configuration`)
7. âŒ ç™»å½•å¤±è´¥

### é¢„æœŸè¡Œä¸º

1. âœ… LINE OAuth æˆæƒæˆåŠŸ
2. âœ… æˆæƒç è·å–æˆåŠŸ
3. âœ… Token äº¤æ¢æˆåŠŸ
4. âœ… NextAuth éªŒè¯ id_token æˆåŠŸï¼ˆæˆ–è·³è¿‡éªŒè¯ï¼‰
5. âœ… ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ
6. âœ… ç”¨æˆ·æˆåŠŸç™»å½•ï¼Œé‡å®šå‘åˆ°é¦–é¡µæˆ–æŒ‡å®šé¡µé¢
7. âœ… Session å†™å…¥æ•°æ®åº“æˆåŠŸ

---

## ğŸ“Œ ç¬¬å››éƒ¨åˆ†ï¼šä»£ç ä½ç½®

### é—®é¢˜ä»£ç ä½ç½®

1. **LINE Provider é…ç½®**ï¼š`src/lib/providers/line.ts`
   - è¡Œæ•°ï¼š103-120
   - é—®é¢˜ï¼šè™½ç„¶æˆ‘ä»¬åœ¨ token å“åº”ä¸­åˆ é™¤äº† `id_token`ï¼Œä½† NextAuth ä»ç„¶ä»åŸå§‹å“åº”ä¸­è¯»å–å¹¶éªŒè¯å®ƒ

2. **NextAuth OAuth å¤„ç†**ï¼š`node_modules/oauth4webapi/build/index.js`
   - å‡½æ•°ï¼š`processGenericAccessTokenResponse`
   - è¡Œæ•°ï¼š1351
   - é—®é¢˜ï¼šNextAuth åœ¨å¤„ç† token å“åº”æ—¶ï¼Œä¼šè‡ªåŠ¨éªŒè¯ `id_token`ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

3. **JWT éªŒè¯é€»è¾‘**ï¼š`node_modules/oauth4webapi/build/index.js`
   - å‡½æ•°ï¼š`validateJwt`ã€`checkSigningAlgorithm`
   - è¡Œæ•°ï¼š1831, 2129
   - é—®é¢˜ï¼šNextAuth é»˜è®¤æœŸæœ› RS256 ç®—æ³•ï¼Œä½† LINE ä½¿ç”¨ HS256

### ç›¸å…³ä»£ç ç‰‡æ®µ

#### LINE Provider Token è¯·æ±‚å¤„ç†ï¼ˆsrc/lib/providers/line.tsï¼‰

```103:120:src/lib/providers/line.ts
        // LINE è¿”å›çš„ ID token ä½¿ç”¨ HS256 ç®—æ³•ç­¾å
        // NextAuth é»˜è®¤æœŸæœ› RS256ï¼Œä½† LINE ä½¿ç”¨ HS256
        // è™½ç„¶ LINE è¦æ±‚ openid scopeï¼ˆä¼šè¿”å› id_tokenï¼‰ï¼Œä½†æˆ‘ä»¬éœ€è¦åˆ é™¤å®ƒä»¥é¿å… NextAuth éªŒè¯
        // æˆ‘ä»¬å°†ä» userinfo API è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œè€Œä¸æ˜¯ä» id_token
        
        // åˆ›å»ºä¸€ä¸ªæ–°çš„ tokens å¯¹è±¡ï¼Œæ˜ç¡®æ’é™¤ id_token
        const { id_token, ...tokensWithoutIdToken } = tokens;
        
        return {
          access_token: tokens.access_token,
          expires_in: tokens.expires_in,
          // æ˜ç¡®ä¸è¿”å› id_tokenï¼Œé¿å… NextAuth å°è¯•éªŒè¯
          // LINE ä½¿ç”¨ HS256ï¼Œä½† NextAuth æœŸæœ› RS256
          // æˆ‘ä»¬å°†ä» userinfo API è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œè€Œä¸æ˜¯ä» id_token
          refresh_token: tokens.refresh_token,
          scope: tokens.scope,
          token_type: tokens.token_type,
        };
```

**é—®é¢˜åˆ†æ**ï¼š
- è™½ç„¶æˆ‘ä»¬åœ¨è¿”å›çš„ tokens å¯¹è±¡ä¸­åˆ é™¤äº† `id_token`ï¼Œä½† NextAuth çš„ `processGenericAccessTokenResponse` å‡½æ•°å¯èƒ½åœ¨å¤„ç†åŸå§‹å“åº”æ—¶å°±å·²ç»è¯»å–äº† `id_token`
- NextAuth ä½¿ç”¨ `oauth4webapi` åº“å¤„ç† OAuthï¼Œè¯¥åº“ä¼šè‡ªåŠ¨éªŒè¯ `id_token`ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

#### LINE Provider Authorization é…ç½®ï¼ˆsrc/lib/providers/line.tsï¼‰

```25:38:src/lib/providers/line.ts
    authorization: {
      url: "https://access.line.me/oauth2/v2.1/authorize",
      params: {
        response_type: "code",
        // LINE è¦æ±‚å¿…é¡»åŒ…å« openid scopeï¼Œå¦åˆ™ä¼šè¿”å› INVALID_SCOPE é”™è¯¯
        // è™½ç„¶ openid scope ä¼šå¯¼è‡´ LINE è¿”å› id_tokenï¼ˆä½¿ç”¨ HS256ï¼‰ï¼Œä½†æˆ‘ä»¬åœ¨ token å“åº”ä¸­ä¼šåˆ é™¤å®ƒ
        // è¿™æ ·æ—¢æ»¡è¶³ LINE çš„è¦æ±‚ï¼Œåˆé¿å… NextAuth éªŒè¯ JWT ç®—æ³•ä¸åŒ¹é…
        scope: "profile openid email",
        // æ³¨æ„ï¼š
        // 1. ä¸è®¾ç½® client_idï¼Œè®© NextAuth è‡ªåŠ¨ä» clientId å±æ€§æ·»åŠ 
        // 2. ä¸è®¾ç½® redirect_uriï¼Œè®© NextAuth è‡ªåŠ¨å¤„ç†ï¼ˆåŸºäº NEXTAUTH_URL å’Œ provider idï¼‰
        // 3. ä¸è®¾ç½® stateï¼Œè®© NextAuth è‡ªåŠ¨å¤„ç†ï¼ˆé€šè¿‡ checks: ["state"] é…ç½®ï¼‰
        // è¿™æ ·å¯ä»¥ç¡®ä¿ NextAuth æ­£ç¡®å¤„ç†æ‰€æœ‰ OAuth å‚æ•°
      },
    },
```

**é—®é¢˜åˆ†æ**ï¼š
- LINE API è¦æ±‚å¿…é¡»åŒ…å« `openid` scopeï¼Œå¦åˆ™ä¼šè¿”å› `INVALID_SCOPE` é”™è¯¯
- åŒ…å« `openid` scope ä¼šå¯¼è‡´ LINE è¿”å› `id_token`ï¼ˆä½¿ç”¨ HS256 ç®—æ³•ï¼‰
- è¿™æ˜¯ä¸€ä¸ªä¸¤éš¾çš„é—®é¢˜ï¼šéœ€è¦ `openid` scope æ‰èƒ½ä½¿ç”¨ LINE OAuthï¼Œä½† `openid` scope ä¼šå¯¼è‡´è¿”å› `id_token`ï¼Œè€Œ NextAuth æ— æ³•éªŒè¯ HS256 ç­¾åçš„ `id_token`

---

## ğŸ“Œ ç¬¬äº”éƒ¨åˆ†ï¼šé…ç½®ä¸ç¯å¢ƒï¼ˆConfig & Envï¼‰

### å½“å‰ä½¿ç”¨çš„ç¯å¢ƒå˜é‡

```bash
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=EDc1FLfOShSpObQdpL7wfAGJFF1c3R2usXoznl//bgE=

# LINE OAuth
LINE_CLIENT_ID=2008568634
LINE_CLIENT_SECRET=e50651c1957f1cb93133a4c71d237fb1
LINE_REDIRECT_URI=http://localhost:3000/api/auth/callback/line
```

### ç›¸å…³ä¾èµ–

- Next.js: 15.5.6
- NextAuth: 5.0.0-beta.30
- React: 18+
- TypeScript
- oauth4webapi: (NextAuth å†…éƒ¨ä¾èµ–)

### LINE Developers Console é…ç½®

- Channel ID: `2008568634`
- Channel Secret: `e50651c1957f1cb93133a4c71d237fb1`
- Callback URL: `http://localhost:3000/api/auth/callback/line`
- OAuth 2.1 API

### LINE OAuth è§„èŒƒ

- **æˆæƒç«¯ç‚¹**: `https://access.line.me/oauth2/v2.1/authorize`
- **Token ç«¯ç‚¹**: `https://api.line.me/oauth2/v2.1/token`
- **Userinfo ç«¯ç‚¹**: `https://api.line.me/v2/profile`
- **ID Token ç®—æ³•**: HS256ï¼ˆHMAC-SHA256ï¼‰
- **å¿…éœ€ Scope**: `openid`ï¼ˆLINE è¦æ±‚å¿…é¡»åŒ…å«ï¼‰

---

## ğŸ“Œ ç¬¬å…­éƒ¨åˆ†ï¼šé—®é¢˜å½±å“èŒƒå›´ï¼ˆImpact Analysisï¼‰

### å½±å“å“ªäº›æ¨¡å—ï¼Ÿ

1. **è®¤è¯æ¨¡å—** (`app/api/auth/[...nextauth]`)
   - LINE OAuth ç™»å½•å®Œå…¨ä¸å¯ç”¨
   - æ‰€æœ‰ä½¿ç”¨ LINE ç™»å½•çš„ç”¨æˆ·æ— æ³•ç™»å½•

2. **ç™»å½•æ¨¡å—** (`app/login`)
   - LINE OAuth ç™»å½•åŠŸèƒ½å®Œå…¨ä¸å¯ç”¨
   - ç”¨æˆ·æ— æ³•é€šè¿‡ LINE è´¦å·ç™»å½•

3. **ç”¨æˆ·ç®¡ç†æ¨¡å—**
   - æ— æ³•åˆ›å»ºæˆ–å…³è” LINE OAuth è´¦æˆ·
   - æ— æ³•è·å– LINE ç”¨æˆ·ä¿¡æ¯

### å½±å“å“ªäº›ç”¨æˆ·ï¼Ÿ

- **æ‰€æœ‰ä½¿ç”¨ LINE ç™»å½•çš„ç”¨æˆ·**
- **æ–°ç”¨æˆ·æ³¨å†Œ**ï¼ˆå¦‚æœé€‰æ‹© LINE ç™»å½•ï¼‰
- **ç°æœ‰ç”¨æˆ·ç™»å½•**ï¼ˆå¦‚æœä½¿ç”¨ LINE ç™»å½•ï¼‰

### ä¸šåŠ¡å½±å“

- **é«˜å½±å“**ï¼šé˜»å¡æ‰€æœ‰ LINE ç™»å½•åŠŸèƒ½
- **ç”¨æˆ·ä½“éªŒ**ï¼šç”¨æˆ·æ— æ³•ä½¿ç”¨ LINE è´¦å·ç™»å½•
- **æ•°æ®å®Œæ•´æ€§**ï¼šæ— æ³•åˆ›å»ºæˆ–æ›´æ–° LINE OAuth è´¦æˆ·è®°å½•

### æ˜¯å¦éœ€ç´§æ€¥ä¿®å¤ï¼Ÿ

- âœ… **éœ€è¦ç´§æ€¥ä¿®å¤**
  - é˜»å¡æ‰€æœ‰ LINE ç™»å½•åŠŸèƒ½
  - å½±å“ç”¨æˆ·ä½“éªŒå’Œä¸šåŠ¡åŠŸèƒ½

---

## ğŸ“Œ ç¬¬ä¸ƒéƒ¨åˆ†ï¼šCursor è‡ªæˆ‘åˆ†æï¼ˆRoot Cause Hypothesisï¼‰

### æ ¹æœ¬åŸå› åˆ†æ

**é—®é¢˜æ ¸å¿ƒ**ï¼š
1. **LINE OAuth è§„èŒƒè¦æ±‚**ï¼š
   - LINE API è¦æ±‚å¿…é¡»åŒ…å« `openid` scopeï¼Œå¦åˆ™è¿”å› `INVALID_SCOPE` é”™è¯¯
   - åŒ…å« `openid` scope ä¼šå¯¼è‡´ LINE è¿”å› `id_token`ï¼ˆä½¿ç”¨ HS256 ç®—æ³•ç­¾åï¼‰

2. **NextAuth éªŒè¯æœºåˆ¶**ï¼š
   - NextAuth v5 ä½¿ç”¨ `oauth4webapi` åº“å¤„ç† OAuth æµç¨‹
   - `oauth4webapi` åœ¨å¤„ç† token å“åº”æ—¶ï¼Œä¼šè‡ªåŠ¨éªŒè¯ `id_token`ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
   - NextAuth é»˜è®¤æœŸæœ› RS256 ç®—æ³•ï¼ˆRSA-SHA256ï¼‰ï¼Œä½† LINE ä½¿ç”¨ HS256 ç®—æ³•ï¼ˆHMAC-SHA256ï¼‰

3. **ç®—æ³•ä¸åŒ¹é…**ï¼š
   - LINE çš„ `id_token` ä½¿ç”¨ HS256 ç®—æ³•ç­¾å
   - NextAuth æœŸæœ› RS256 ç®—æ³•
   - éªŒè¯å¤±è´¥ï¼ŒæŠ›å‡º `OperationProcessingError`

4. **åˆ é™¤ id_token æ— æ•ˆçš„åŸå› **ï¼š
   - è™½ç„¶æˆ‘ä»¬åœ¨ `token.request` çš„è¿”å›ä¸­åˆ é™¤äº† `id_token`ï¼Œä½† NextAuth çš„ `processGenericAccessTokenResponse` å‡½æ•°å¯èƒ½åœ¨å¤„ç†åŸå§‹å“åº”æ—¶å°±å·²ç»è¯»å–äº† `id_token`
   - `oauth4webapi` åº“åœ¨å¤„ç† token å“åº”æ—¶ï¼Œä¼šå…ˆè§£æå“åº”ï¼Œç„¶åéªŒè¯ `id_token`ï¼Œæœ€åæ‰è°ƒç”¨æˆ‘ä»¬çš„ `token.request` å‡½æ•°

### å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1ï¼šé…ç½® NextAuth æ¥å— HS256 ç®—æ³•ï¼ˆæ¨èä½†å¯èƒ½ä¸å¯è¡Œï¼‰

- **ä¼˜ç‚¹**ï¼šå®Œå…¨è§£å†³ç®—æ³•ä¸åŒ¹é…é—®é¢˜
- **ç¼ºç‚¹**ï¼šNextAuth v5 å¯èƒ½ä¸æ”¯æŒé…ç½® JWT ç®—æ³•
- **å®ç°éš¾åº¦**ï¼šéœ€è¦æ£€æŸ¥ NextAuth v5 æ˜¯å¦æ”¯æŒè‡ªå®šä¹‰ JWT ç®—æ³•é…ç½®

#### æ–¹æ¡ˆ 2ï¼šåœ¨ token å“åº”å¤„ç†ä¹‹å‰æ‹¦æˆª id_tokenï¼ˆå½“å‰å°è¯•çš„æ–¹æ¡ˆï¼‰

- **ä¼˜ç‚¹**ï¼šé¿å… NextAuth éªŒè¯ id_token
- **ç¼ºç‚¹**ï¼šå¯èƒ½æ— æ³•å®Œå…¨æ‹¦æˆªï¼Œå› ä¸º NextAuth åœ¨å¤„ç†åŸå§‹å“åº”æ—¶å°±å·²ç»è¯»å–äº† id_token
- **å®ç°éš¾åº¦**ï¼šä¸­ç­‰ï¼ˆéœ€è¦æ·±å…¥äº†è§£ NextAuth å†…éƒ¨æœºåˆ¶ï¼‰

#### æ–¹æ¡ˆ 3ï¼šä½¿ç”¨è‡ªå®šä¹‰ OAuth æµç¨‹ï¼Œå®Œå…¨ç»•è¿‡ NextAuth çš„ id_token éªŒè¯

- **ä¼˜ç‚¹**ï¼šå®Œå…¨æ§åˆ¶ OAuth æµç¨‹
- **ç¼ºç‚¹**ï¼šéœ€è¦å¤§é‡è‡ªå®šä¹‰ä»£ç ï¼Œå¯èƒ½ç ´å NextAuth çš„é›†æˆ
- **å®ç°éš¾åº¦**ï¼šé«˜

#### æ–¹æ¡ˆ 4ï¼šä» scope ä¸­ç§»é™¤ openidï¼ˆå·²å°è¯•ï¼Œä½† LINE è¦æ±‚å¿…é¡»åŒ…å«ï¼‰

- **ä¼˜ç‚¹**ï¼šé¿å… LINE è¿”å› id_token
- **ç¼ºç‚¹**ï¼šLINE API ä¼šè¿”å› `INVALID_SCOPE` é”™è¯¯
- **å®ç°éš¾åº¦**ï¼šä½ï¼ˆä½†ä¸å¯è¡Œï¼‰

---

## ğŸ“Œ ç¬¬å…«éƒ¨åˆ†ï¼šå·²å°è¯•çš„ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤å°è¯• 1ï¼šæ·»åŠ  checks é…ç½®

**æ—¶é—´**ï¼š2025-11-26 06:03:11

**ä¿®æ”¹å†…å®¹**ï¼š
- åœ¨ LINE provider é…ç½®ä¸­æ·»åŠ  `checks: ["pkce", "state"]`
- ç›®çš„æ˜¯ç¡®ä¿ NextAuth è‡ªåŠ¨æ·»åŠ  `state` å‚æ•°

**ç»“æœ**ï¼š
- âœ… è§£å†³äº† `state` å‚æ•°ç¼ºå¤±é—®é¢˜
- âŒ ä½† JWT ç®—æ³•ä¸åŒ¹é…é—®é¢˜ä»ç„¶å­˜åœ¨

**ç›¸å…³æ–‡ä»¶**ï¼š
- `src/lib/providers/line.ts` (è¡Œ 24)

### ä¿®å¤å°è¯• 2ï¼šä» scope ä¸­ç§»é™¤ openid

**æ—¶é—´**ï¼š2025-11-26 06:17:19

**ä¿®æ”¹å†…å®¹**ï¼š
- å°† scope ä» `"profile openid email"` æ”¹ä¸º `"profile email"`
- ç›®çš„æ˜¯é¿å… LINE è¿”å› `id_token`

**ç»“æœ**ï¼š
- âŒ LINE API è¿”å› `INVALID_SCOPE` é”™è¯¯ï¼š`'openid' is needed for 'scope'.`
- âŒ æ— æ³•ä½¿ç”¨ LINE OAuth

**ç›¸å…³æ–‡ä»¶**ï¼š
- `src/lib/providers/line.ts` (è¡Œ 32)

### ä¿®å¤å°è¯• 3ï¼šæ¢å¤ openid scopeï¼Œåœ¨ token å“åº”ä¸­åˆ é™¤ id_token

**æ—¶é—´**ï¼š2025-11-26 06:20:51

**ä¿®æ”¹å†…å®¹**ï¼š
- æ¢å¤ scope ä¸º `"profile openid email"`ï¼ˆæ»¡è¶³ LINE çš„è¦æ±‚ï¼‰
- åœ¨ `token.request` çš„è¿”å›ä¸­ä½¿ç”¨è§£æ„èµ‹å€¼åˆ é™¤ `id_token` å­—æ®µ
- æ˜ç¡®è®¾ç½® `id_token: undefined`

**ç»“æœ**ï¼š
- âœ… æ»¡è¶³ LINE çš„è¦æ±‚ï¼ˆåŒ…å« `openid` scopeï¼‰
- âŒ ä½† NextAuth ä»ç„¶å°è¯•éªŒè¯ `id_token`ï¼Œé—®é¢˜ä¾ç„¶å­˜åœ¨

**ç›¸å…³æ–‡ä»¶**ï¼š
- `src/lib/providers/line.ts` (è¡Œ 32, 109-120)

**ä»£ç ç‰‡æ®µ**ï¼š
```typescript
// åˆ›å»ºä¸€ä¸ªæ–°çš„ tokens å¯¹è±¡ï¼Œæ˜ç¡®æ’é™¤ id_token
const { id_token, ...tokensWithoutIdToken } = tokens;

return {
  access_token: tokens.access_token,
  expires_in: tokens.expires_in,
  // æ˜ç¡®ä¸è¿”å› id_tokenï¼Œé¿å… NextAuth å°è¯•éªŒè¯
  refresh_token: tokens.refresh_token,
  scope: tokens.scope,
  token_type: tokens.token_type,
};
```

### ä¿®å¤å°è¯• 4ï¼šæ£€æŸ¥ NextAuth æ˜¯å¦æ”¯æŒé…ç½® JWT ç®—æ³•

**æ—¶é—´**ï¼š2025-11-26ï¼ˆè¿›è¡Œä¸­ï¼‰

**ä¿®æ”¹å†…å®¹**ï¼š
- æœç´¢ NextAuth v5 æ–‡æ¡£ï¼ŒæŸ¥æ‰¾æ˜¯å¦æ”¯æŒé…ç½® JWT ç®—æ³•
- æ£€æŸ¥ `oauth4webapi` åº“æ˜¯å¦æ”¯æŒè‡ªå®šä¹‰ JWT éªŒè¯

**ç»“æœ**ï¼š
- å¾…ç¡®è®¤

---

## ğŸ“Œ ç¬¬ä¹éƒ¨åˆ†ï¼šæŠ€æœ¯ç»†èŠ‚

### LINE OAuth 2.1 è§„èŒƒ

1. **æˆæƒæµç¨‹**ï¼š
   - ç”¨æˆ·æˆæƒåï¼ŒLINE è¿”å›æˆæƒç ï¼ˆ`code`ï¼‰
   - åº”ç”¨ä½¿ç”¨æˆæƒç æ¢å– access token å’Œ id_token

2. **ID Token è§„èŒƒ**ï¼š
   - LINE çš„ `id_token` ä½¿ç”¨ HS256 ç®—æ³•ç­¾å
   - ä½¿ç”¨ `client_secret` ä½œä¸ºç­¾åå¯†é’¥
   - åŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚ `sub`ã€`email` ç­‰ï¼‰

3. **Scope è¦æ±‚**ï¼š
   - LINE è¦æ±‚å¿…é¡»åŒ…å« `openid` scopeï¼Œå¦åˆ™è¿”å› `INVALID_SCOPE` é”™è¯¯
   - åŒ…å« `openid` scope ä¼šå¯¼è‡´ LINE è¿”å› `id_token`

### NextAuth v5 OAuth å¤„ç†æµç¨‹

1. **æˆæƒé˜¶æ®µ**ï¼š
   - NextAuth ç”Ÿæˆæˆæƒ URLï¼ŒåŒ…å« `state`ã€`code_challenge` ç­‰å‚æ•°
   - ç”¨æˆ·æˆæƒåï¼ŒOAuth æä¾›å•†è¿”å›æˆæƒç 

2. **Token äº¤æ¢é˜¶æ®µ**ï¼š
   - NextAuth ä½¿ç”¨æˆæƒç æ¢å– access token å’Œ id_token
   - `oauth4webapi` åº“å¤„ç† token å“åº”
   - å¦‚æœå“åº”ä¸­åŒ…å« `id_token`ï¼Œ`oauth4webapi` ä¼šè‡ªåŠ¨éªŒè¯å®ƒ

3. **JWT éªŒè¯**ï¼š
   - `oauth4webapi` ä½¿ç”¨ `validateJwt` å‡½æ•°éªŒè¯ `id_token`
   - é»˜è®¤æœŸæœ› RS256 ç®—æ³•ï¼ˆRSA-SHA256ï¼‰
   - å¦‚æœç®—æ³•ä¸åŒ¹é…ï¼ŒæŠ›å‡º `OperationProcessingError`

### é—®é¢˜æ ¹æº

**æ ¸å¿ƒçŸ›ç›¾**ï¼š
1. LINE è¦æ±‚å¿…é¡»åŒ…å« `openid` scope â†’ å¯¼è‡´è¿”å› `id_token`ï¼ˆHS256ï¼‰
2. NextAuth è‡ªåŠ¨éªŒè¯ `id_token` â†’ æœŸæœ› RS256 ç®—æ³•
3. ç®—æ³•ä¸åŒ¹é… â†’ éªŒè¯å¤±è´¥ â†’ ç™»å½•å¤±è´¥

**ä¸ºä»€ä¹ˆåˆ é™¤ id_token æ— æ•ˆ**ï¼š
- NextAuth çš„ `processGenericAccessTokenResponse` å‡½æ•°åœ¨å¤„ç† token å“åº”æ—¶ï¼Œä¼šå…ˆè§£æå“åº”ï¼Œç„¶åéªŒè¯ `id_token`ï¼Œæœ€åæ‰è°ƒç”¨æˆ‘ä»¬çš„ `token.request` å‡½æ•°
- å³ä½¿æˆ‘ä»¬åœ¨ `token.request` çš„è¿”å›ä¸­åˆ é™¤äº† `id_token`ï¼ŒNextAuth å·²ç»åœ¨ä¹‹å‰å°±è¯»å–å¹¶å°è¯•éªŒè¯äº†å®ƒ

---

## ğŸ“Œ ç¬¬åéƒ¨åˆ†ï¼šå»ºè®®çš„è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šé…ç½® NextAuth æ¥å— HS256 ç®—æ³•ï¼ˆæœ€ç†æƒ³ï¼‰

**æ­¥éª¤**ï¼š
1. æ£€æŸ¥ NextAuth v5 æ˜¯å¦æ”¯æŒé…ç½® JWT ç®—æ³•
2. å¦‚æœæ”¯æŒï¼Œåœ¨ LINE provider é…ç½®ä¸­æ·»åŠ ç®—æ³•é…ç½®
3. å¦‚æœä¸æ”¯æŒï¼Œè€ƒè™‘å‡çº§æˆ–é™çº§ NextAuth ç‰ˆæœ¬

**ä¼˜ç‚¹**ï¼š
- å®Œå…¨è§£å†³ç®—æ³•ä¸åŒ¹é…é—®é¢˜
- ä¿æŒ NextAuth çš„å®Œæ•´åŠŸèƒ½

**ç¼ºç‚¹**ï¼š
- å¯èƒ½ NextAuth v5 ä¸æ”¯æŒæ­¤é…ç½®
- éœ€è¦ä¿®æ”¹ NextAuth å†…éƒ¨é€»è¾‘

### æ–¹æ¡ˆ 2ï¼šä½¿ç”¨è‡ªå®šä¹‰ OAuth æµç¨‹ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰

**æ­¥éª¤**ï¼š
1. å®Œå…¨è‡ªå®šä¹‰ LINE OAuth æµç¨‹ï¼Œä¸ä¾èµ– NextAuth çš„ OAuth å¤„ç†
2. æ‰‹åŠ¨å¤„ç†æˆæƒã€token äº¤æ¢ã€ç”¨æˆ·ä¿¡æ¯è·å–
3. æ‰‹åŠ¨åˆ›å»º NextAuth session

**ä¼˜ç‚¹**ï¼š
- å®Œå…¨æ§åˆ¶ OAuth æµç¨‹
- å¯ä»¥è·³è¿‡ id_token éªŒè¯

**ç¼ºç‚¹**ï¼š
- éœ€è¦å¤§é‡è‡ªå®šä¹‰ä»£ç 
- å¯èƒ½ç ´å NextAuth çš„é›†æˆ
- ç»´æŠ¤æˆæœ¬é«˜

### æ–¹æ¡ˆ 3ï¼šè”ç³» NextAuth ç¤¾åŒºæˆ–æäº¤ Issueï¼ˆé•¿æœŸæ–¹æ¡ˆï¼‰

**æ­¥éª¤**ï¼š
1. åœ¨ NextAuth GitHub ä»“åº“æäº¤ issue
2. è¯´æ˜ LINE OAuth çš„ç‰¹æ®Šæƒ…å†µï¼ˆHS256 vs RS256ï¼‰
3. è¯·æ±‚æ·»åŠ æ”¯æŒ HS256 ç®—æ³•çš„é…ç½®é€‰é¡¹

**ä¼˜ç‚¹**ï¼š
- å¯èƒ½è·å¾—å®˜æ–¹æ”¯æŒ
- å¸®åŠ©å…¶ä»–å¼€å‘è€…

**ç¼ºç‚¹**ï¼š
- éœ€è¦ç­‰å¾…å®˜æ–¹å“åº”
- å¯èƒ½ä¸ä¼šç«‹å³è§£å†³

---

## ğŸ“Œ ç¬¬åä¸€éƒ¨åˆ†ï¼šç›¸å…³èµ„æº

### æ–‡æ¡£é“¾æ¥

- [NextAuth.js v5 æ–‡æ¡£](https://authjs.dev/)
- [LINE Login API æ–‡æ¡£](https://developers.line.biz/en/docs/line-login/)
- [OAuth 2.1 è§„èŒƒ](https://oauth.net/2.1/)
- [JWT ç®—æ³•è¯´æ˜](https://jwt.io/introduction)

### ç›¸å…³ Issue

- NextAuth GitHub Issuesï¼ˆå¾…æœç´¢ï¼‰
- LINE Developers ç¤¾åŒºï¼ˆå¾…æœç´¢ï¼‰

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-26  
**æŠ¥å‘Šç”Ÿæˆå·¥å…·**: Cursor AI Assistant  
**é—®é¢˜çŠ¶æ€**: å¾…è§£å†³

