# 🔧 Cursor 问题诊断报告
Issue ID: CP-20251202-012
=======================

## 📌 第一部分：问题概要（Summary）

| 字段 | 填写内容 |
|------|---------|
| 问题名称 | AI 聊天功能返回 500 Internal Server Error（主程序调用问题） |
| 问题等级 | **High** |
| 触发时间 | 2025-12-02（具体时间待确认） |
| 触发环境 | local / staging / production（待确认） |
| 相关模块 | **web**（主程序 Next.js 应用） |
| 当前状态 | **可复现** / 偶发（待确认） |

## 📌 第二部分：复现路径（Reproduce Steps）

### 前端操作步骤

1. 打开 AI 聊天页面（`/ai` 或相关路由）
2. 输入问题并发送
3. 触发 AI 服务调用

### 触发点

- **页面**: AI 聊天页面（`src/components/AIPage.tsx`）
- **按钮**: 发送消息按钮
- **URL**: `/api/ai/chat` 或直接调用 `callAiDirect()`

### 请求示例

**前端调用代码位置**: `src/components/AIPage.tsx:498-507`

```typescript
const payload = await callAiDirect({
  provider: currentProvider,
  question: q,
  locale: userLocale,
  scene: "chat",
  messages: historyMessages.length > 0 ? historyMessages : undefined,
  maxHistory: 10,
  model: currentModel,
});
```

**实际 API 调用**: `POST /v1/ask`（直接调用 ai-service）

### 操作系统 / 浏览器 / Node 版本

- 操作系统: macOS / Linux / Windows（待确认）
- 浏览器: Chrome / Firefox / Safari（待确认）
- Node 版本: 待确认

### 复现成功/失败截图

待补充

## 📌 第三部分：实际输出（Actual Behavior）

### 1. 前端日志

**错误信息**:
```
【Error】AI service error: 500 Internal Server Error（INTERNAL_ERROR）
```

**控制台日志示例**（来自 `src/lib/aiClient.front.ts`）:
```javascript
[callAiDirect] AI service 调用失败: {
  provider: "render",
  status: 500,
  statusText: "Internal Server Error",
  url: "https://.../v1/ask",
  errorCode: "INTERNAL_ERROR",
  errorMessage: "Internal Server Error",
  ...
}
```

### 2. 后端返回

**HTTP 状态码**: `500`

**响应内容**:
```json
{
  "ok": false,
  "errorCode": "INTERNAL_ERROR",
  "message": "Internal Server Error"
}
```

### 3. 服务器日志（ai-service）

**关键信息**:
- ✅ **AI service 一直可用，没有变动**
- ✅ **问题出在主程序（Next.js 应用）**
- ✅ **需要检查主程序调用 AI 服务的代码**

**ai-service 日志**（如果可获取）:
```
[ASK ROUTE] Error caught: {
  message: "...",
  statusCode: 500,
  ...
}
```

### 4. 本地运行日志

**Next.js 开发服务器日志**:
- 待补充具体日志

**Cursor 执行日志**:
- 待补充

## 📌 第四部分：期望行为（Expected Behavior）

1. **AI 聊天功能应该正常工作**
   - 用户输入问题后，应该能够成功调用 AI 服务
   - 应该返回 AI 生成的回答
   - 不应该出现 500 错误

2. **请求应该正确构建**
   - 请求体应该包含所有必需参数（`question`, `lang`, `scene` 等）
   - 请求头应该包含正确的认证令牌和 `X-AI-Provider` 头（如果适用）
   - 请求应该能够正确序列化为 JSON

3. **响应应该正确解析**
   - AI service 返回的响应应该能够正确解析为 JSON
   - 应该能够提取 `answer` 字段并显示给用户

## 📌 第五部分：代码定位（Code Snapshot）

### 1. 相关文件列表（绝对路径）

1. `/Users/leo/Desktop/v3/src/lib/aiClient.front.ts` - 前端 AI 客户端（直接调用 ai-service）
2. `/Users/leo/Desktop/v3/src/components/AIPage.tsx` - AI 聊天页面组件
3. `/Users/leo/Desktop/v3/src/app/api/ai/chat/route.ts` - AI 聊天 API 路由（如果使用）
4. `/Users/leo/Desktop/v3/src/lib/aiEndpoint.ts` - AI 端点解析
5. `/Users/leo/Desktop/v3/apps/ai-service/src/routes/ask.ts` - AI 服务主路由

### 2. 关键函数代码片段

#### 2.1 请求体构建（`src/lib/aiClient.front.ts:219-229`）

```219:229:src/lib/aiClient.front.ts
    const requestBody = {
      question: rest.question,
      lang: lang,
      scene: rest.scene,
      sourceLanguage: rest.sourceLanguage,
      targetLanguage: rest.targetLanguage,
      messages: rest.messages,
      maxHistory: rest.maxHistory,
      seedUrl: rest.seedUrl,
      model: rest.model,
    };
```

**潜在问题**:
- `scene` 参数可能为 `undefined`（如果未传递）
- `sourceLanguage`、`targetLanguage`、`messages` 等可选参数可能为 `undefined`，导致序列化问题
- 某些字段可能包含无效值

#### 2.2 getCurrentAiProvider 调用（`src/lib/aiClient.front.ts:157-173`）

```157:173:src/lib/aiClient.front.ts
  if (provider === "render") {
    try {
      const dbProvider = await getCurrentAiProvider();
      console.log("[callAiDirect] 读取数据库 provider 配置:", {
        dbProvider,
        willSendHeader: dbProvider === "openai" || dbProvider === "openrouter" || dbProvider === "gemini",
      });
      // 只发送需要发送的 provider（openai, openrouter, gemini）
      if (dbProvider === "openai" || dbProvider === "openrouter" || dbProvider === "gemini") {
        xAiProviderHeader = dbProvider;
      } else if (dbProvider) {
        console.warn("[callAiDirect] 数据库 provider 值不支持发送 X-AI-Provider 头:", dbProvider);
      }
    } catch (error) {
      console.warn("[callAiDirect] 获取数据库 provider 配置失败:", error);
    }
  }
```

**潜在问题**:
- `/api/ai/config` 接口可能返回错误或超时
- 数据库查询可能失败导致阻塞
- 缓存机制可能导致返回过期配置
- 没有超时机制，可能长时间阻塞

#### 2.3 响应解析（`src/lib/aiClient.front.ts:436`）

```436:436:src/lib/aiClient.front.ts
  const data = (await response.json()) as AiClientResponse;
```

**潜在问题**:
- AI service 可能返回非 JSON 格式的响应
- 响应体可能已被读取（虽然代码逻辑看起来正确）
- JSON 解析时可能抛出未捕获的异常
- 没有 try-catch 包裹 `response.json()` 调用

#### 2.4 请求头构建（`src/lib/aiClient.front.ts:206-215`）

```206:215:src/lib/aiClient.front.ts
    // 构建请求头
    const headers: Record<string, string> = {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`,
    };

    // 添加 X-AI-Provider 头（如果适用）
    if (xAiProviderHeader) {
      headers["X-AI-Provider"] = xAiProviderHeader;
    }
```

**潜在问题**:
- Token 格式可能不正确
- `X-AI-Provider` 头值可能不正确
- 请求头构建时可能出现异常

#### 2.5 前端调用位置（`src/components/AIPage.tsx:498-507`）

```498:507:src/components/AIPage.tsx
      // 直接调用 ai-service（使用当前配置的 provider）
      const payload = await callAiDirect({
        provider: currentProvider,
        question: q,
        locale: userLocale,
        scene: "chat",
        messages: historyMessages.length > 0 ? historyMessages : undefined,
        maxHistory: 10,
        model: currentModel,
      });
```

**潜在问题**:
- `currentProvider` 可能未正确初始化
- `userLocale` 格式可能不正确
- `scene: "chat"` 可能不是有效的场景标识
- `historyMessages` 格式可能不符合要求

### 3. commit diff

待补充（如有代码变更）

## 📌 第六部分：配置与环境（Config & Env）

### 1. 当前使用的场景（Scene）加载顺序

**场景标识**: `chat`

**场景配置**:
- 场景标识: `chat`
- Prompt 路径: 从 Supabase `ai_scene_config` 表读取
- 是否命中: 待确认

### 2. 当前 .env 中涉及本问题的变量

**必需环境变量**:
```bash
# AI Service 配置
AI_SERVICE_URL=https://zalem.onrender.com  # 或本地服务地址
AI_SERVICE_TOKEN=你的服务Token

# 数据库配置
SUPABASE_URL=你的Supabase项目URL
SUPABASE_SERVICE_KEY=你的Supabase服务密钥
```

**可选环境变量**:
```bash
# 本地开发
NODE_ENV=development
```

### 3. Cursor 执行的命令（如果有）

待补充

## 📌 第七部分：问题影响范围（Impact Analysis）

### 影响哪些模块？

- ✅ **web**（主程序 Next.js 应用）- 直接影响
- ⚠️ **ai-service** - 间接影响（虽然服务本身可用，但调用失败会影响用户体验）

### 是否影响用户？

- ✅ **是** - 用户无法正常使用 AI 聊天功能

### 是否影响管理员？

- ⚠️ **可能影响** - 如果管理员也使用 AI 聊天功能

### 是否影响生产环境？

- ⚠️ **待确认** - 需要确认问题是否在生产环境复现

### 是否影响积分/题库/AI调用等核心逻辑？

- ✅ **是** - 直接影响 AI 调用功能，这是核心功能之一

### 是否需紧急修复？

- ✅ **是** - 这是 High 级别问题，影响核心功能

## 📌 第八部分：Cursor 自我分析（Root Cause Hypothesis）

根据代码分析和问题描述，可能的原因包括：

### 1. 请求体格式问题

**位置**: `src/lib/aiClient.front.ts:219-229`

**可能原因**:
- `scene` 参数未正确传递或为 `undefined`
- `question` 参数格式不正确（可能为空字符串或 null）
- `messages` 格式不符合 AI service 的要求
- 某些字段为 `undefined` 导致 JSON 序列化问题
- `lang` 参数可能为 `undefined`（虽然代码中有默认值处理）

**验证方法**:
- 检查请求体构建时的日志
- 验证 JSON 序列化是否成功
- 检查 AI service 是否收到正确的请求体

### 2. getCurrentAiProvider 阻塞或失败

**位置**: `src/lib/aiClient.front.ts:157-173`

**可能原因**:
- `/api/ai/config` 接口返回错误（500、404 等）
- 数据库查询失败导致阻塞
- 缓存机制导致返回过期的配置
- 没有超时机制，可能长时间阻塞请求
- 网络问题导致 API 调用失败

**验证方法**:
- 检查 `/api/ai/config` 接口是否正常
- 检查数据库连接是否正常
- 检查是否有超时日志

### 3. 响应解析失败

**位置**: `src/lib/aiClient.front.ts:436`

**可能原因**:
- AI service 返回非 JSON 格式的响应（如 HTML 错误页面）
- 响应体已被读取（虽然代码逻辑看起来正确）
- JSON 解析时抛出未捕获的异常
- 响应状态码为 500，但响应体格式不正确

**验证方法**:
- 检查响应内容是否为有效 JSON
- 检查是否有 JSON 解析错误日志
- 检查 AI service 返回的原始响应

### 4. 请求头或认证问题

**位置**: `src/lib/aiClient.front.ts:206-215`

**可能原因**:
- Token 格式不正确（缺少 `Bearer` 前缀或格式错误）
- `X-AI-Provider` 头值不正确（如传递了无效的 provider 值）
- 请求头构建时出现异常
- Token 已过期或无效

**验证方法**:
- 检查请求头是否正确构建
- 检查 Token 是否有效
- 检查 AI service 是否收到正确的请求头

### 5. 场景配置问题

**位置**: `src/components/AIPage.tsx:503`

**可能原因**:
- `scene: "chat"` 可能不是有效的场景标识
- 数据库中可能没有 `chat` 场景的配置
- 场景配置可能被禁用（`enabled = false`）

**验证方法**:
- 检查 Supabase `ai_scene_config` 表中是否存在 `chat` 场景
- 检查场景配置是否启用
- 检查场景配置的 Prompt 是否正确

### 6. 端点解析问题

**位置**: `src/lib/aiClient.front.ts:137-150`

**可能原因**:
- `resolveAiEndpoint()` 可能返回错误的 URL 或 Token
- 环境变量可能未正确配置
- URL 拼接可能出错

**验证方法**:
- 检查 `AI_SERVICE_URL` 和 `AI_SERVICE_TOKEN` 环境变量
- 检查端点解析日志
- 验证 URL 是否正确

## 📌 第九部分：建议修复方向（Suggested Fixes）

### ✔ 方案 A（推荐）：增强请求体验证和错误处理

**文件**: `src/lib/aiClient.front.ts`

**修复内容**:
1. 在构建请求体前验证所有必需参数
   - 确保 `question` 不为空
   - 确保 `scene` 存在且有效
   - 验证 `lang` 格式正确
2. 过滤掉 `undefined` 和 `null` 值，避免序列化问题
   - 使用 `Object.entries()` 和 `filter()` 清理请求体
3. 添加请求体构建的详细日志
   - 记录清理前后的请求体
   - 记录序列化结果
4. 确保 `scene` 参数始终存在且有效
   - 如果未传递，使用默认值或抛出错误

**优点**:
- 最安全，不会破坏现有功能
- 能够快速定位问题
- 提供详细的错误信息

### ✔ 方案 B（最快速）：改进 getCurrentAiProvider 错误处理

**文件**: `src/lib/aiClient.front.ts:157-173`

**修复内容**:
1. 添加超时机制，避免长时间阻塞
   - 使用 `AbortController` 和 `setTimeout` 实现超时
   - 默认超时时间：5 秒
2. 如果获取配置失败，使用默认值继续执行
   - 如果 `getCurrentAiProvider()` 失败，不发送 `X-AI-Provider` 头
   - 让 AI service 使用默认配置
3. 确保不会因为配置获取失败而中断 AI 调用
   - 将 `getCurrentAiProvider()` 调用包装在 try-catch 中
   - 失败时记录警告但不抛出错误

**优点**:
- 修复速度快
- 不影响现有功能
- 提高系统容错性

### ✔ 方案 C（结构性改进）：增强响应解析的错误处理

**文件**: `src/lib/aiClient.front.ts:436-448`

**修复内容**:
1. 添加 try-catch 包裹 `response.json()` 调用
   - 捕获 JSON 解析异常
   - 提供详细的错误信息
2. 如果 JSON 解析失败，提供更详细的错误信息
   - 记录原始响应内容（前 500 字符）
   - 记录响应状态码和状态文本
3. 记录原始响应内容用于调试
   - 在开发环境中记录完整响应
   - 在生产环境中记录响应摘要

**优点**:
- 提高错误诊断能力
- 防止未捕获的异常
- 提供更好的调试信息

### ✔ 方案 D（补充）：添加请求前验证

**文件**: `src/lib/aiClient.front.ts:130-261`

**修复内容**:
1. 在发送请求前验证所有必需参数
   - 验证 `question` 不为空且为字符串
   - 验证 `provider` 有效
   - 验证 URL 和 Token 存在
2. 检查 URL 和 Token 是否有效
   - 验证 URL 格式正确
   - 验证 Token 不为空
3. 验证请求体是否可以正确序列化
   - 尝试序列化请求体
   - 如果失败，提前抛出错误

**优点**:
- 提前发现问题
- 减少无效请求
- 提供更好的错误提示

## 📌 第十部分：需要你（ChatGPT）决策的点（Decision Needed）

### 1. 问题复现确认

- [ ] 需要确认问题是否在所有环境（local / staging / production）都能复现
- [ ] 需要确认问题的复现频率（每次都能复现还是偶发）
- [ ] 需要获取具体的错误日志和响应内容

### 2. 修复方案选择

- [ ] 需要选择修复方案（A / B / C / D 或组合）
- [ ] 需要确认修复优先级（是否先修复最可能的原因）
- [ ] 需要确认是否同时实施多个方案

### 3. 测试验证

- [ ] 需要确认修复后的测试方法
- [ ] 需要确认是否需要添加单元测试
- [ ] 需要确认是否需要添加集成测试

### 4. 额外信息

- [ ] 需要获取 AI service 的详细日志（如果可能）
- [ ] 需要确认场景配置是否正确（`chat` 场景是否存在）
- [ ] 需要确认环境变量配置是否正确

## 📌 第十一部分：附录（Attachments）

### 1. 相关代码文件

- `src/lib/aiClient.front.ts` - 前端 AI 客户端完整代码
- `src/components/AIPage.tsx` - AI 聊天页面组件完整代码
- `apps/ai-service/src/routes/ask.ts` - AI 服务主路由（参考）

### 2. 问题分析文档

- `/Users/leo/Desktop/v3/ai.plan.md` - AI 聊天 500 错误诊断与修复计划（主程序问题）

### 3. 相关架构文档

- `/Users/leo/Desktop/drivequiz研发规范/AI板块整体架构说明.md` - AI 板块整体架构说明
- `/Users/leo/Desktop/drivequiz研发规范/🧩 AI 服务研发规范（ai-service 统一架构规范 v1.0）.md` - AI 服务研发规范
- `/Users/leo/Desktop/drivequiz研发规范/🧩 AI 核心服务规范（ai-core 统一架构规范 v2.0）.md` - AI 核心服务规范

### 4. 日志示例（待补充）

- 前端控制台日志
- Next.js 服务器日志
- AI service 日志（如果可获取）

### 5. 环境变量配置示例（待补充）

- `.env.local` 配置示例（脱敏）

---

**报告生成时间**: 2025-12-02  
**报告生成工具**: Cursor AI  
**报告版本**: v1.0

