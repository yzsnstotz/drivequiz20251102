

## âœ… æœ¬æ¬¡ä»»åŠ¡æ€»è§ˆ

> Issue ID: **CP-20251202-004**
> ç›®æ ‡ï¼š
>
> 1. å½»åº•è§£å†³ã€ŒæœåŠ¡å¯åŠ¨ / é¡µé¢åˆæ¬¡åŠ è½½æ—¶ã€`/api/auth/session`ã€`/api/activation/status`ã€`/api/user/license-preference` ç­‰ API å¹¶å‘è°ƒç”¨çš„é—®é¢˜ã€‚
> 2. å‡å°‘å› æ­¤å¯¼è‡´çš„æ•°æ®åº“è¿æ¥é«˜é¢‘åˆ›å»ºä¸é‡Šæ”¾ï¼ˆ`[DB Pool] New client connected / Client removed from pool`ï¼‰ã€‚
> 3. ä¿æŒç°æœ‰è®¤è¯ä¸æ¿€æ´»é€»è¾‘ä¸å˜ï¼Œåªåšã€Œè°ƒç”¨åˆå¹¶ / å»é‡ / ç¼“å­˜ã€å±‚é¢çš„ä¼˜åŒ–ã€‚

---

## 0. æŒ‡ä»¤å¤´

åœ¨æœ¬ä»»åŠ¡å¼€å¤´ï¼Œ**å®Œæ•´ç²˜è´´**ã€Šä¿®å¤æŒ‡ä»¤å¤´05ç‰ˆï¼ˆç°ç”¨ï¼‰.mdã€‹çš„å†…å®¹ï¼ˆæŒ‡ä»¤å¤´ v5ï¼‰ã€‚
è·¯å¾„ï¼š`/Users/leo/Desktop/drivequizç ”å‘è§„èŒƒ/ä¿®å¤æŒ‡ä»¤å¤´05ç‰ˆï¼ˆç°ç”¨ï¼‰.md`

---

## 1. è§„èŒƒå¯¹é½æ£€æŸ¥æ‘˜è¦ï¼ˆCursor å¿…é¡»å…ˆè¾“å‡ºï¼‰

åœ¨çœŸæ­£æ”¹ä»£ç ä¹‹å‰ï¼ŒCursor å…ˆè¾“å‡ºä¸€æ®µ 5â€“8 è¡Œçš„ã€Œè§„èŒƒå¯¹é½æ£€æŸ¥æ‘˜è¦ã€ï¼Œå†…å®¹åŒ…æ‹¬ï¼š

1. å·²é˜…è¯»è§„èŒƒæ–‡ä»¶ï¼ˆä»…åˆ—å…³é”®å‡ ä»½ï¼‰ï¼š

   * `/Users/leo/Desktop/drivequizç ”å‘è§„èŒƒ/ğŸ§© AI æœåŠ¡ç ”å‘è§„èŒƒï¼ˆai-service ç»Ÿä¸€æ¶æ„è§„èŒƒ v1.0ï¼‰.md`
   * `/Users/leo/Desktop/drivequizç ”å‘è§„èŒƒ/ğŸ§© AI æ ¸å¿ƒæœåŠ¡è§„èŒƒï¼ˆai-core ç»Ÿä¸€æ¶æ„è§„èŒƒ v2.0ï¼‰.md`
   * `/Users/leo/Desktop/drivequizç ”å‘è§„èŒƒ/æ–‡ä»¶ç»“æ„.md`
   * `æœåŠ¡å¯åŠ¨æ—¶å¤§é‡APIè¯·æ±‚å’Œæ•°æ®åº“è¿æ¥é—®é¢˜_è¯Šæ–­æŠ¥å‘Š.md`ï¼ˆå½“å‰ Issueï¼‰
2. æœ¬æ¬¡ä»»åŠ¡ç›¸å…³æ ¸å¿ƒçº¦æŸï¼š

   * A1ï¼šè·¯ç”±å±‚ä¸æ‰¿è½½ä¸šåŠ¡é€»è¾‘ï¼ˆåªèƒ½è°ƒç”¨ service / libï¼‰ã€‚
   * B2ï¼šæ–‡ä»¶ç»“æ„ä¸æ–‡æ¡£åŒæ­¥æ›´æ–°ã€‚
   * D1 / D2ï¼šå¿…é¡»è¾“å‡ºæ‰§è¡ŒæŠ¥å‘Š & å˜æ›´è¯´æ˜ã€‚
3. æœ¬æ¬¡ä»»åŠ¡é¢„è®¡å½±å“çš„æ–‡ä»¶ï¼ˆCursor å¯å…ˆæ‰«æç¡®è®¤ï¼‰ï¼š

   * `src/components/AuthProvider.tsx`
   * `src/contexts/ActivationContext.tsx`
   * `src/components/AIActivationProvider.tsx`
   * æ‰€æœ‰ç›´æ¥è°ƒç”¨ `useSession()` çš„ç»„ä»¶
   * `src/lib/db.ts`ï¼ˆæ•°æ®åº“è¿æ¥é…ç½® & Pool å•ä¾‹åŒ–ï¼‰

---

## 2. é—®é¢˜æ‹†è§£ä¸æ€»ä½“ä¿®å¤ç­–ç•¥

æ ¹æ®è¯Šæ–­æŠ¥å‘Šï¼Œå½“å‰ä¸»è¦é—®é¢˜ï¼š

1. **æœåŠ¡å¯åŠ¨ / é¡µé¢åˆæ¬¡åŠ è½½æ—¶**ï¼Œå¤šä¸ª Provider / ç»„ä»¶å¹¶è¡Œåˆå§‹åŒ–ï¼š

   * `AuthProvider` â†’ `useSession()` è§¦å‘ `/api/auth/session`ã€‚
   * `ActivationContext` â†’ åˆå§‹åŒ–æ—¶ `fetchActivationStatus()` è§¦å‘ `/api/activation/status`ã€‚
   * `AIActivationProvider` â†’ åˆå§‹åŒ–æ—¶ `checkActivationStatus()` å†è§¦å‘ `/api/activation/status`ï¼ˆæˆ–ç›¸å…³æ¥å£ï¼‰ã€‚
   * å…¶ä»–ç»„ä»¶å¯èƒ½è¿˜ä¼šé¢å¤–è®¿é—® `/api/user/license-preference` ç­‰ã€‚

2. è¿™äº›è¯·æ±‚ **ç¼ºå°‘å»é‡ + åˆå¹¶æœºåˆ¶**ï¼Œå¯¼è‡´ï¼š

   * åŒä¸€æ—¶é—´çª—å£å†…ï¼Œå¯¹ç›¸åŒæ¥å£å‘èµ·å¤šæ¬¡ HTTP è¯·æ±‚ï¼›
   * NextAuth adapter ä¸ºæ¯ä¸ª session è¯·æ±‚æ‰“å¼€æ–°çš„ DB è¿æ¥ï¼Œæ—¥å¿—å‡ºç°å¤§é‡
     `[DB Pool] New client connected` / `Client removed from pool`ã€‚

3. ç›®å‰è™½å·²å…³é—­ NextAuth çš„è½®è¯¢ï¼ˆ`refetchInterval={0}`ï¼‰ï¼Œä½†ç»„ä»¶åˆå§‹åŒ–çš„ã€Œç¬æ—¶æ´ªå³°ã€ä»å­˜åœ¨ã€‚

**æœ¬ä»»åŠ¡ç­–ç•¥ï¼š**

* å‰ç«¯ä¾§åšä¸‰ä»¶äº‹ï¼š

  1. **Session å•ç‚¹æ¥æº**ï¼šå…¨å±€åªå…è®¸ 1 ä¸ªåœ°æ–¹è°ƒç”¨ `useSession()`ï¼Œå…¶ä»–åœ°æ–¹é€šè¿‡è‡ªå®šä¹‰ context / hook å¤ç”¨ç»“æœã€‚
  2. **Activation è¯·æ±‚åˆå¹¶**ï¼š`/api/activation/status` åªåœ¨ä¸€ä¸ª Provider å†…è¯·æ±‚ä¸€æ¬¡ï¼Œå…¶å®ƒè°ƒç”¨å…±äº«åŒä¸€ç»“æœï¼Œ`AIActivationProvider` ä¸å†å•ç‹¬å‘è¯·æ±‚ã€‚
  3. **è¯·æ±‚çº§å»é‡ç¼“å­˜**ï¼šå¯¹ `fetchActivationStatus`ã€`fetchUserLicensePreference` ç­‰å°è£…é€šç”¨çš„ã€Œpending è¯·æ±‚å…±äº« + ç»“æœç¼“å­˜ã€å·¥å…·ã€‚

* åç«¯ / DB å±‚åšä¸¤ä»¶è¡¥å……ï¼š

  1. **ç¡®ä¿è¿æ¥æ± å•ä¾‹**ï¼š`src/lib/db.ts` ä½¿ç”¨ `globalThis` é¿å… dev æ¨¡å¼çƒ­æ›´æ–°æ—¶åå¤åˆ›å»º Poolã€‚
  2. **åˆç†è°ƒæ•´ Pool é…ç½®**ï¼ˆmax / idleTimeoutï¼‰ï¼Œé™ä½å¿«é€Ÿå»ºç«‹/é”€æ¯è¿æ¥çš„æŠ–åŠ¨ã€‚

---

## 3. å‰ç«¯ä¼˜åŒ–ï¼ˆä¸€ï¼‰ï¼šSession å•ç‚¹æ¥æºï¼ˆç»Ÿä¸€ useSessionï¼‰

### 3.1 æ–°å»º Session Contextï¼ˆApp çº§ï¼‰

**ç›®æ ‡ï¼š**

* åœ¨ App é¡¶å±‚åªç”¨ä¸€æ¬¡ `useSession()`ï¼Œç„¶åç”¨ä¸€ä¸ª `SessionContext` æŠŠ `session` å’Œ `status` ä¸‹å‘ç»™æ‰€æœ‰å­ç»„ä»¶ã€‚
* å…¶å®ƒç»„ä»¶ç¦æ­¢ç›´æ¥ä½¿ç”¨ `useSession()`ï¼Œç»Ÿä¸€æ”¹ç”¨ `useAppSession()`ï¼ˆè‡ªå®šä¹‰ hookï¼‰ã€‚

**å…·ä½“æ“ä½œï¼š**

1. æ–°å»ºæ–‡ä»¶ï¼š`src/contexts/SessionContext.tsx`ï¼Œå®ç°ç±»ä¼¼å¦‚ä¸‹ç»“æ„ï¼ˆCursor éœ€æŒ‰é¡¹ç›®å®é™…ç±»å‹è¡¥å…¨ï¼‰ï¼š

```tsx
// src/contexts/SessionContext.tsx
"use client";

import { createContext, useContext, useMemo } from "react";
import { useSession, SessionContextValue } from "next-auth/react";

type AppSessionContextValue = SessionContextValue;

const AppSessionContext = createContext<AppSessionContextValue | null>(null);

export function AppSessionProvider({ children }: { children: React.ReactNode }) {
  const sessionValue = useSession(); // âœ” åªæœ‰è¿™é‡Œè°ƒç”¨ useSession

  const value = useMemo(() => sessionValue, [sessionValue.data, sessionValue.status]);

  return (
    <AppSessionContext.Provider value={value}>
      {children}
    </AppSessionContext.Provider>
  );
}

export function useAppSession() {
  const ctx = useContext(AppSessionContext);
  if (!ctx) {
    throw new Error("useAppSession must be used within <AppSessionProvider>");
  }
  return ctx;
}
```

2. ä¿®æ”¹ `src/components/AuthProvider.tsx`ï¼š

   * ç›®å‰ `AuthProvider` åªåŒ…è£… `SessionProvider`ï¼Œéœ€è¦æ”¹æˆï¼š

```tsx
// src/components/AuthProvider.tsx
"use client";

import { SessionProvider } from "next-auth/react";
import { AppSessionProvider } from "@/contexts/SessionContext";

export default function AuthProvider({ children }: { children: React.ReactNode }) {
  return (
    <SessionProvider refetchInterval={0} refetchOnWindowFocus={false}>
      <AppSessionProvider>{children}</AppSessionProvider>
    </SessionProvider>
  );
}
```

* ä¿ç•™ä½ ä¹‹å‰å…³é—­è½®è¯¢çš„é€»è¾‘ã€‚

3. å…¨å±€æ›¿æ¢ç›´æ¥ `useSession()` è°ƒç”¨ï¼š

   * æœç´¢æ‰€æœ‰ `useSession(`ï¼š

     * é™¤äº† `SessionContext.tsx` è‡ªå·±ä»¥å¤–ï¼Œå…¶å®ƒç»„ä»¶å…¨éƒ¨æ”¹ä¸ºå¼•å…¥ `useAppSession`ï¼š

```tsx
// ä¹‹å‰
import { useSession } from "next-auth/react";

const { data: session, status } = useSession();

// ä¹‹å
import { useAppSession } from "@/contexts/SessionContext";

const { data: session, status } = useAppSession();
```

* ç¡®ä¿æ²¡æœ‰ç»„ä»¶åœ¨ `AuthProvider` å¤–è°ƒç”¨ `useAppSession`ï¼›å¦åˆ™æŠ¥é”™ä¿¡æ¯èƒ½å¾ˆå¥½åœ°æš´éœ²é—®é¢˜ã€‚

**é¢„æœŸæ•ˆæœï¼š**

* å¯¹ `/api/auth/session` çš„è¯·æ±‚ï¼Œåœ¨ä¸€æ¬¡é¡µé¢åŠ è½½å‘¨æœŸå†…åªå‘ç”Ÿ **ä¸€æ¬¡**ï¼ˆNextAuth å†…éƒ¨å¤„ç†ï¼Œåç»­ç»„ä»¶è¯»çš„æ˜¯åŒä¸€ sessionï¼‰ã€‚

---

## 4. å‰ç«¯ä¼˜åŒ–ï¼ˆäºŒï¼‰ï¼šActivation è¯·æ±‚åˆå¹¶ä¸ Provider èŒè´£é‡æ„

æ ¹æ®è¯Šæ–­æŠ¥å‘Šï¼š`ActivationContext` å’Œ `AIActivationProvider` éƒ½åœ¨ mount æ—¶ç‹¬ç«‹è®¿é—® `/api/activation/status`ã€‚

### 4.1 æŠŠæ¿€æ´»çŠ¶æ€çš„ã€Œä¸€æ¬¡è¯·æ±‚ã€æ”¶æ•›åˆ° ActivationContext

**ç›®æ ‡ï¼š**

* `/api/activation/status` çš„ã€Œä¸»åŠ¨è¯·æ±‚ã€åªèƒ½å‘ç”Ÿåœ¨ `ActivationContext` ä¸­ï¼›
* `AIActivationProvider` æ”¹ä¸ºåªè¯»å– `ActivationContext` çš„çŠ¶æ€ï¼Œä¸å†è‡ªå·±å‘è¯·æ±‚ã€‚

**æ“ä½œæ­¥éª¤ï¼š**

1. æ‰“å¼€ `src/contexts/ActivationContext.tsx`ï¼Œç¡®è®¤é‡Œé¢çš„ã€Œåˆå§‹åŠ è½½ã€é€»è¾‘ï¼š

```tsx
useEffect(() => {
  if (!session?.user?.email) {
    setStatus({ valid: false, reasonCode: "NOT_LOGGED_IN" });
    setLoading(false);
    return;
  }

  fetchActivationStatus().then((newStatus) => {
    setStatus(newStatus);
    setLoading(false);
  });
}, [session]);
```

> æ”¹é€ è¦æ±‚ï¼š
>
> * `fetchActivationStatus` å¿…é¡»é€šè¿‡ã€Œè¯·æ±‚å»é‡å·¥å…·ã€ï¼ˆè§ç¬¬ 5 èŠ‚ï¼‰å®ç° pending åˆå¹¶ + ç»“æœç¼“å­˜ï¼›
> * å¦‚æœå½“å‰å·²æœ‰ç¼“å­˜ç»“æœä¸”æœªè¿‡æœŸï¼Œåˆå§‹åŠ è½½ç›´æ¥ä½¿ç”¨ç¼“å­˜ï¼Œä¸å†å‘èµ·æ–°è¯·æ±‚ã€‚

2. ä¿®æ”¹ `src/components/AIActivationProvider.tsx`ï¼š

ç›®å‰ç±»ä¼¼ï¼š

```tsx
// åˆå§‹åŠ è½½å°± checkActivationStatus()
useEffect(() => {
  if (!session?.user?.email) return;
  checkActivationStatus();
  checkIntervalRef.current = setInterval(...);
}, [session, pathname, checkActivationStatus, isInteractivePage]);
```

**è¦æ±‚æ”¹é€ ä¸ºï¼š**

* ä¸å†ç›´æ¥å‘æœåŠ¡å™¨è¯·æ±‚æ¿€æ´»çŠ¶æ€ï¼Œè€Œæ˜¯ï¼š

  * é€šè¿‡ `useActivation()`ï¼ˆæˆ–ç±»ä¼¼ hookï¼‰è¯»å– ActivationContext ä¸­çš„ statusï¼›
  * ä»…åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸‹è§¦å‘åç«¯è¯·æ±‚ï¼š

    1. ç”¨æˆ·åœ¨ AI å¯¹è¯/äº’åŠ¨é¡µé¢ä¸­æ‰§è¡Œäº†ã€Œå‡çº§ / è´­ä¹° / æ¿€æ´»ã€ç­‰æ“ä½œåï¼Œæ˜¾å¼è°ƒç”¨ `refreshActivationStatus()`ï¼›
    2. å®šæ—¶è½®è¯¢æ—¶éœ€è¦ã€Œç¡®è®¤çŠ¶æ€æ˜¯å¦è¿‡æœŸã€ï¼Œä½†è½®è¯¢é—´éš”ä¿æŒè‡³å°‘ 30â€“60 åˆ†é’Ÿï¼Œå¹¶ä¸”ä»é€šè¿‡ ActivationContext çš„è¯·æ±‚å»é‡å·¥å…·ã€‚

* ä¼ªä»£ç ç¤ºä¾‹ï¼š

```tsx
// AIActivationProvider.tsx
import { useActivation } from "@/contexts/ActivationContext";

export function AIActivationProvider({ children }: { children: React.ReactNode }) {
  const { status, loading, refreshActivationStatus } = useActivation();

  useEffect(() => {
    // è¿™é‡Œåªå¤„ç† AI ä¸“å±çš„ä¸€äº› UI/é€»è¾‘ï¼Œä¸å†å•ç‹¬è¯·æ±‚æ¥å£
    // æ¯”å¦‚ï¼šå¦‚æœ status å˜åŒ–ï¼Œé‡ç½®ä¸€äº›æœ¬åœ° state
  }, [status]);

  // å¦‚éœ€å®šæ—¶åˆ·æ–°ï¼Œä¹Ÿåº”è°ƒç”¨ ActivationContext æä¾›çš„ refreshActivationStatus
  // ä¸¥ç¦åœ¨è¿™é‡Œè‡ªå·± fetch /api/activation/status

  return <>{children}</>;
}
```

3. åœ¨ `ActivationContext` ä¸­å¢åŠ ä¸€ä¸ª `refreshActivationStatus` æ–¹æ³•ï¼š

* è¯¥æ–¹æ³•å†…éƒ¨ä¹Ÿä½¿ç”¨ã€Œè¯·æ±‚å»é‡å·¥å…·ã€ï¼Œå¦‚ç›®æ ‡ key ä¸º `"activation_status"`ï¼›
* åœ¨æ—¶é—´ä¸Šéµå®ˆ TTLï¼ˆä¾‹å¦‚ 5 åˆ†é’Ÿå†…ä¸è¦é‡å¤è¯·æ±‚åŒä¸€ä¸ªç”¨æˆ· statusï¼Œé™¤éå¼ºåˆ¶åˆ·æ–°ï¼‰ã€‚

---

## 5. å‰ç«¯ä¼˜åŒ–ï¼ˆä¸‰ï¼‰ï¼šé€šç”¨è¯·æ±‚å»é‡ + ç»“æœç¼“å­˜å·¥å…·

### 5.1 æ–°å»ºå·¥å…·ï¼š`src/lib/requestCache.ts`

**ç›®æ ‡ï¼š**

* å¤šä¸ªç»„ä»¶åœ¨åŒä¸€æ—¶é—´æ®µè¯·æ±‚åŒä¸€ä¸ª API æ—¶ï¼Œ**åªå‘ä¸€æ¬¡ HTTP è¯·æ±‚**ï¼Œå…¶ä»–è°ƒç”¨å¤ç”¨åŒä¸€ Promiseï¼›
* ä½¿ç”¨ TTL çŸ­ç¼“å­˜ç»“æœï¼Œåœ¨ TTL å†…ç›¸åŒ key ä¹Ÿä¸å†è®¿é—®æœåŠ¡å™¨ã€‚

**å»ºè®®å®ç°ç»“æ„ï¼ˆCursor ç”¨ TS å®Œæ•´å®ç°ï¼‰ï¼š**

```ts
// src/lib/requestCache.ts
type CacheEntry<T> = {
  promise: Promise<T> | null;
  data: T | null;
  expiresAt: number;
};

const cache = new Map<string, CacheEntry<any>>();

export function fetchWithCache<T>(
  key: string,
  ttlMs: number,
  fetcher: () => Promise<T>
): Promise<T> {
  const now = Date.now();
  let entry = cache.get(key) as CacheEntry<T> | undefined;

  if (entry) {
    // 1) æœ‰åœ¨é£çš„ promiseï¼Œç›´æ¥è¿”å›ï¼ˆè¯·æ±‚å»é‡ï¼‰
    if (entry.promise) {
      return entry.promise;
    }
    // 2) æœ‰æœªè¿‡æœŸæ•°æ®ï¼Œç›´æ¥è¿”å›ï¼ˆç»“æœç¼“å­˜ï¼‰
    if (entry.data && entry.expiresAt > now) {
      return Promise.resolve(entry.data);
    }
  }

  // 3) éœ€è¦å‘æ–°è¯·æ±‚
  const newEntry: CacheEntry<T> = {
    promise: null,
    data: entry?.data ?? null,
    expiresAt: now + ttlMs,
  };
  cache.set(key, newEntry);

  const p = fetcher()
    .then((res) => {
      newEntry.data = res;
      newEntry.expiresAt = Date.now() + ttlMs;
      newEntry.promise = null;
      return res;
    })
    .catch((err) => {
      // è¯·æ±‚å¤±è´¥ï¼šä¿ç•™æ—§æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œç«‹å³å…è®¸ä¸‹ä¸€æ¬¡é‡è¯•
      newEntry.promise = null;
      throw err;
    });

  newEntry.promise = p;
  return p;
}
```

### 5.2 åœ¨ ActivationContext / LicensePreference ä¸­ä½¿ç”¨

1. `ActivationContext`ï¼š

```ts
import { fetchWithCache } from "@/lib/requestCache";

async function fetchActivationStatusCached(userEmail: string) {
  const key = `activation_status:${userEmail}`;
  return fetchWithCache(key, 5 * 60 * 1000, async () => {
    const res = await fetch("/api/activation/status");
    if (!res.ok) throw new Error("Failed to fetch activation status");
    return (await res.json()) as ActivationStatus;
  });
}
```

* åˆå§‹åŠ è½½å’Œ `refreshActivationStatus` éƒ½è°ƒç”¨ `fetchActivationStatusCached`ï¼Œä»è€Œå»é‡ã€‚

2. ç”¨æˆ·åå¥½ `/api/user/license-preference` åŒç†ï¼š

```ts
const key = `user_license_pref:${userId}`;
fetchWithCache(key, 10 * 60 * 1000, () => fetch(...));
```

---

## 6. åç«¯ / DB ä¼˜åŒ–ï¼šè¿æ¥æ± å•ä¾‹ä¸é…ç½®æ ¡å‡†

è¯Šæ–­æŠ¥å‘Šæ˜¾ç¤ºï¼ŒæœåŠ¡å¯åŠ¨åçŸ­æ—¶é—´å†…äº§ç”Ÿäº†å¤§é‡ã€ŒNew client connected / Client removed from poolã€ã€‚

### 6.1 ç¡®ä¿è¿æ¥æ± ï¼ˆPoolï¼‰åœ¨è¿›ç¨‹çº§åˆ«æ˜¯å•ä¾‹

æ‰“å¼€ `src/lib/db.ts`ï¼Œè¿›è¡Œå¦‚ä¸‹æ£€æŸ¥ä¸æ”¹é€ ï¼š

1. å¦‚æœå½“å‰æ˜¯ç®€å•ï¼š

```ts
import { Pool } from "pg";
export const pool = new Pool(config);
```

**å¿…é¡»æ”¹é€ ä¸ºï¼š**

```ts
import { Pool } from "pg";

declare global {
  // eslint-disable-next-line no-var
  var __DB_POOL__: Pool | undefined;
}

const createPool = () => {
  const pool = new Pool({
    // è¯»å– DATABASE_URLï¼Œè§£æ host/port/ssl ç­‰ï¼Œä¿æŒç°æœ‰é€»è¾‘
    // ...
    max: 10,
    idleTimeoutMillis: 30000,
    connectionTimeoutMillis: 5000,
  });

  // åœ¨è¿™é‡ŒæŒ‚è½½å°‘é‡å¿…è¦æ—¥å¿—ï¼Œè€Œä¸æ˜¯å¯¹æ¯æ¬¡å€Ÿè¿˜è¿æ¥éƒ½æ‰“å°
  return pool;
};

export const pool =
  global.__DB_POOL__ ??
  (global.__DB_POOL__ = createPool());
```

2. å¦‚æœå·²å­˜åœ¨ç±»ä¼¼ `globalThis` å•ä¾‹é€»è¾‘ï¼ŒCursor éœ€è¦æ£€æŸ¥ï¼š

   * dev æ¨¡å¼çƒ­é‡è½½æ˜¯å¦ä¼šå¤šæ¬¡æ‰§è¡Œ `createPool()`ï¼›
   * `[DB Pool] New client connected` æ—¥å¿—æ˜¯å¦æ˜¯ hook åœ¨ `pool.on("connect")` çº§åˆ«ï¼Œè€Œä¸æ˜¯æ¯æ¬¡ queryï¼›
   * å¦‚æ—¥å¿—è¿‡äºé¢‘ç¹ï¼Œè¯·æŠŠ logging å±‚æ”¹ä¸ºï¼š

     * ä»…åœ¨ `createPool()` æ—¶æ‰“ä¸€æ¡ `[DB Pool] Pool created`ï¼›
     * ä¸è¦åœ¨æ¯æ¬¡è¿æ¥å€Ÿ/è¿˜æ—¶æ‰“æ—¥å¿—ã€‚

> æ³¨ï¼šæœ¬ä»»åŠ¡ä¸å…è®¸æ”¹åŠ¨è¿æ¥å­—ç¬¦ä¸²è§£æ / SSL é…ç½®ï¼Œåªè°ƒæ•´ Pool ä½¿ç”¨æ–¹å¼å’Œå‚æ•°ã€‚

---

## 7. æµ‹è¯•è¦æ±‚ï¼ˆCursor å¿…é¡»æ‰§è¡Œå¹¶å†™å…¥æ‰§è¡ŒæŠ¥å‘Šï¼‰

1. **æœ¬åœ°å¯åŠ¨ devï¼š**

   * æ‰§è¡Œ `npm run dev`ï¼›
   * æ‰“å¼€æµè§ˆå™¨è®¿é—® `/` æˆ– `/favorites` é¡µé¢ã€‚

2. **è§‚å¯Ÿ Network é¢æ¿ 30 ç§’å†…ç»Ÿè®¡ï¼š**

   * `/api/auth/session`ï¼š

     * æœŸæœ›ï¼šåˆæ¬¡åŠ è½½åªå‡ºç° 1 æ¬¡ï¼Œä¹‹åä¸å†é‡å¤ï¼ˆé™¤éä½ æ‰‹åŠ¨åˆ·æ–°é¡µé¢ï¼‰ã€‚
   * `/api/activation/status`ï¼š

     * æœŸæœ›ï¼šåˆæ¬¡åŠ è½½åªå‡ºç° 1 æ¬¡ï¼›
     * è‹¥è¿›å…¥ AI äº’åŠ¨é¡µé¢æœ‰é¢å¤–åˆ·æ–°ï¼Œä¹Ÿåº”æ˜¯ã€Œæœ‰è¡Œä¸º â†’ æœ‰ refreshã€ï¼Œè€Œä¸æ˜¯é¡µé¢åˆšæ‰“å¼€å°±è¿å‘å¤šæ¬¡ã€‚
   * `/api/user/license-preference`ï¼š

     * æœŸæœ›ï¼šåŒä¸€ä¸ªé¡µé¢ç”Ÿå‘½å‘¨æœŸå†…ï¼Œåªå‡ºç° 1 æ¬¡è¯·æ±‚ã€‚

3. **è§‚å¯ŸæœåŠ¡å™¨æ—¥å¿—ï¼š**

   * æœŸæœ›ï¼š

     * `[DB Pool] New client connected` åœ¨å¯åŠ¨é˜¶æ®µå‡ºç° 1â€“2 æ¡å³å¯ï¼›
     * ä¸å†åœ¨çŸ­æ—¶é—´å†…è¿ç»­åˆ·å‡ åæ¡ï¼›
     * `Client removed from pool` ä¸åº”åœ¨çŸ­æ—¶é—´å†…è¿å‘å¤§é‡æ—¥å¿—ã€‚

4. **åŠŸèƒ½å›å½’ï¼š**

   * ç™»å½• / æœªç™»å½•ç”¨æˆ·è®¿é—®é¦–é¡µï¼Œç¡®è®¤é¡µé¢æ­£å¸¸æ¸²æŸ“ï¼›
   * æ£€æŸ¥æ¿€æ´»çŠ¶æ€æ˜¾ç¤ºæ˜¯å¦ç¬¦åˆä¹‹å‰é€»è¾‘ï¼ˆä¾‹å¦‚ï¼šæœªæ¿€æ´»æç¤ºã€å·²æ¿€æ´»æ ‡è¯†ç­‰ï¼‰ã€‚

---

## 8. æ‰§è¡ŒæŠ¥å‘Šä¸ç‰ˆæœ¬å·æ›´æ–°

1. **æ–°å¢æ‰§è¡ŒæŠ¥å‘Šæ–‡ä»¶ï¼š**

   * è·¯å¾„å»ºè®®ï¼š
     `docs/é—®é¢˜ä¿®å¤/CP-20251202-004/æ‰§è¡ŒæŠ¥å‘Š/CP-20251202-004_æœåŠ¡å¯åŠ¨æ—¶å¤§é‡APIè¯·æ±‚å’Œæ•°æ®åº“è¿æ¥é—®é¢˜_æ‰§è¡ŒæŠ¥å‘Š_v1.md`

   * å†…å®¹è‡³å°‘åŒ…æ‹¬ï¼š

     1. é—®é¢˜æ¦‚è¦ï¼ˆå¼•ç”¨è¯Šæ–­æŠ¥å‘Šå…³é”®å†…å®¹ï¼‰ã€‚
     2. ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨ã€‚
     3. Session å•ç‚¹æ¥æº & Activation è¯·æ±‚åˆå¹¶çš„å®ç°è¯´æ˜ã€‚
     4. `requestCache` å·¥å…·çš„è®¾è®¡ä¸ä½¿ç”¨ç‚¹ã€‚
     5. DB Pool å•ä¾‹ä¸é…ç½®è°ƒæ•´è¯´æ˜ã€‚
     6. æœ¬åœ°æµ‹è¯•æ­¥éª¤ & ç»“æœï¼ˆåŒ…å«ã€ŒNetwork æˆªå›¾è¯´æ˜ã€çš„æ–‡å­—æè¿°å³å¯ï¼‰ã€‚
     7. å¯èƒ½çš„é£é™©ç‚¹ä¸åç»­ä¼˜åŒ–å»ºè®®ï¼ˆä¾‹å¦‚ï¼šç”Ÿäº§ç¯å¢ƒå†è§‚å¯Ÿè¿æ¥æ•°ä¸å“åº”æ—¶é—´ï¼‰ã€‚

2. **ç‰ˆæœ¬å·æ›´æ–°ï¼š**

   * æ ¹æ®ä¿®å¤æŒ‡ä»¤å¤´ v5 è§„èŒƒï¼Œæ›´æ–° `src/lib/version.ts` ä¸­çš„ `BUILD_TIME` ä¸ºå½“å‰æ—¥æœ¬æ—¶é—´ï¼›
   * åœ¨æ‰§è¡ŒæŠ¥å‘Šå¼€å¤´æˆ–ç»“å°¾ï¼Œè®°å½•æœ¬æ¬¡ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ï¼š`2025-12-02T02:30:00+09:00`ï¼‰ã€‚

