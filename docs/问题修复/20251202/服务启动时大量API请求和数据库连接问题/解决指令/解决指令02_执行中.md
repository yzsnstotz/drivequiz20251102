🧭 最终交付：合并后的 Cursor 补充修复指令（可直接丢给 Cursor）

以下是 一次性强化版 Cursor 补充任务指令（包含所有必须补充项），请完整复制给 Cursor：

🚀【Cursor 补充修复任务 · 完整指令】

（CP-20251202-003 & CP-20251202-004 合并补充版本）

0. 使用《修复指令头05版（现用）》作为指令头

路径：/Users/leo/Desktop/drivequiz研发规范/修复指令头05版（现用）.md

1. 本次补充任务范围

本次任务必须完成以下 3 个主要内容：


（B）更新文件结构文档（遵守 B2）

在文件结构文档中新增以下条目：

src/contexts/SessionContext.tsx — 全局 Session 单点管理  
src/lib/requestCache.ts — 前端请求去重与短缓存工具


并注明：

使用者

依赖关系

作用范围

（C）验证 AIActivationProvider 的行为一致性

新增本地 E2E 测试并输出说明：

用户激活状态 expired → AI 页面是否自动降级

用户完成激活后 → AI 页面是否 refresh

ActivationContext.refresh 是否被正确触发

AIActivationProvider 中是否仍存在多余的请求（必须完全移除）

（D）修复 requestCache.ts 内存泄漏风险

必须：

加入定时清理 TTL 过期 key 的代码：

setInterval(() => {
  const now = Date.now();
  for (const [key, entry] of cache.entries()) {
    if (entry.expiresAt < now) cache.delete(key);
  }
}, 5 * 60 * 1000);


文档中标注 TTL 清理策略

确认 cache 不会跨用户泄漏敏感信息

2. 可选增强内容（若时间允许）
1. 改进 ActivationContext 的 key：改 email → userId

避免 email 为空或被修改导致的缓存错乱。

2. 增加连接池 error 监听
pool.on("error", (err) => console.error("DB Pool Error:", err));

3. 为 SessionContext 添加错误边界
3. 必须更新执行报告

新建：

docs/问题修复/CP-20251202-003-004/执行报告_v2.md


报告需包含：

本次补充任务摘要

4 项必须补充内容的结果

执行测试截图（若无法截图，描述 log 即可）

风险点与最终验证