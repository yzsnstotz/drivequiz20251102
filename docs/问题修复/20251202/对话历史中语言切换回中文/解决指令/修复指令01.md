

## 0. ä»»åŠ¡èŒƒå›´è¯´æ˜ï¼ˆå¿…é¡»å†™ç»™ Cursorï¼‰

> æœ¬æ¬¡ä»»åŠ¡ **ä»…å…è®¸ä¿®æ”¹** ä»¥ä¸‹æ–‡ä»¶ï¼š
>
> * `apps/ai-service/src/lib/sceneRunner.ts`
> * `apps/ai-service/src/routes/ask.ts`
> * `apps/local-ai-service/src/routes/ask.ts`
>
> ç¦æ­¢ä¿®æ”¹ï¼š
>
> * `apps/web/**` æˆ–å…¶ä»–å‰ç«¯ä»£ç 
> * ä»»ä½•æ•°æ®åº“ç»“æ„ï¼ˆä¸æ–°å¢/ä¸ä¿®æ”¹è¡¨å­—æ®µï¼‰
>
> ç›®æ ‡ï¼š
>
> 1. è®© ai-service / local-ai-service æ­£ç¡®æ¥æ”¶å¹¶å¤„ç†å‰ç«¯ä¼ æ¥çš„ `messages`ï¼ˆå¯¹è¯å†å²ï¼‰ï¼›
> 2. åœ¨ `runScene` / `buildMessages` ä¸­åˆå¹¶ **system prompt + å†å²å¯¹è¯ + å½“å‰é—®é¢˜**ï¼›
> 3. ä¿è¯ä¹‹å‰å·²ç»ä¿®å¥½çš„è¯­è¨€é€‰æ‹©é€»è¾‘ (`requestedLang` / `selectedLang` / å¤šè¯­è¨€ prompt) å®Œæ•´ä¿ç•™ã€‚

---

## 1. è§„èŒƒå¯¹é½æ£€æŸ¥æ‘˜è¦ï¼ˆCursor åŠ¨æ‰‹å‰å…ˆè¾“å‡ºï¼‰

è¯· Cursor åœ¨æ‰§è¡Œå‰å…ˆè¾“å‡ºä¸€æ®µâ€œè§„èŒƒå¯¹é½æ£€æŸ¥æ‘˜è¦â€ï¼ŒåŒ…æ‹¬ï¼š

* å·²é˜…è¯»çš„è§„èŒƒæ–‡æ¡£ï¼ˆåªéœ€è¦åˆ—å‡ºï¼Œä¸å¿…å±•å¼€ï¼‰ï¼š

  * `/Users/leo/Desktop/drivequizç ”å‘è§„èŒƒ/ğŸ§© AI æœåŠ¡ç ”å‘è§„èŒƒï¼ˆai-service ç»Ÿä¸€æ¶æ„è§„èŒƒ v1.0ï¼‰.md`
  * `/Users/leo/Desktop/drivequizç ”å‘è§„èŒƒ/ğŸ§© AI æ ¸å¿ƒæœåŠ¡è§„èŒƒï¼ˆai-core ç»Ÿä¸€æ¶æ„è§„èŒƒ v2.0ï¼‰.md`
  * `/Users/leo/Desktop/drivequizç ”å‘è§„èŒƒ/æ•°æ®åº“ç»“æ„_AI_SERVICE.md`
  * `/Users/leo/Desktop/drivequizç ”å‘è§„èŒƒ/AIæ¿å—æ•´ä½“æ¶æ„è¯´æ˜.md`ï¼ˆå¦‚å­˜åœ¨ï¼‰
* æœ¬ä»»åŠ¡çº¦æŸæ¡æ¬¾ï¼š

  * **A1**ï¼šè·¯ç”±å±‚åªåšå‚æ•°è§£æä¸è°ƒåº¦ï¼Œä¸šåŠ¡é€»è¾‘æ”¾åˆ° lib å±‚
  * **B1/B3**ï¼šä¸ä¿®æ”¹æ•°æ®åº“ç»“æ„ï¼Œä¿æŒä¸æ–‡æ¡£ä¸€è‡´
  * **C1â€“C3**ï¼šè¿œç¨‹ ai-service ä¸ local-ai-service è¡Œä¸ºä¸€è‡´ï¼Œå‡éœ€æ”¯æŒå¤šè½®å¯¹è¯
  * **D1/D2**ï¼šå¿…é¡»è¾“å‡ºæ‰§è¡ŒæŠ¥å‘Šï¼Œè¯´æ˜å½±å“èŒƒå›´ä¸æµ‹è¯•æƒ…å†µ
* é‡ç‚¹å½±å“æ–‡ä»¶ï¼ˆç¡®è®¤å³å¯ï¼‰ï¼š

  * `apps/ai-service/src/lib/sceneRunner.ts`
  * `apps/ai-service/src/routes/ask.ts`
  * `apps/local-ai-service/src/routes/ask.ts`

---

## 2. æ€»ä½“ä¿®å¤æ€è·¯ï¼ˆç»™ Cursor çš„è®¾è®¡çº¦æŸï¼‰

ç»“åˆè¯Šæ–­æŠ¥å‘Šï¼š

* å½“å‰ **å‰ç«¯å·²ç»æ­£ç¡®ä¼ äº† `messages`**ï¼›
* local-ai-service é‡Œæœ‰ `processHistory(messages, maxHistory)`ï¼Œä½†ç®—å‡º `history` å **æ²¡æœ‰ä¼ ç»™ `runScene`**ï¼›
* ai-service çš„ `/v1/ask` æ ¹æœ¬æ²¡è§£æ `messages`ï¼›
* `runScene` çš„ `RunSceneOptions` æ²¡æœ‰ `messages` å­—æ®µï¼Œå†…éƒ¨ç›´æ¥è°ƒç”¨ `buildMessages()`ï¼Œåªæ„é€ ä¸¤æ¡ï¼šsystem + å½“å‰ userï¼›
* `buildMessages` å®Œå…¨ä¸çŸ¥é“å†å²å¯¹è¯å­˜åœ¨ã€‚

ğŸ‘‰ å› æ­¤è¿™æ¬¡ä¿®å¤è¦åšåˆ°ï¼š

1. **æ¥å£å±‚**ï¼š

   * `RunSceneOptions` å¢åŠ  `messages?: ChatMessage[]`ï¼›
   * `buildMessages` å¢åŠ  `messages?` å‚æ•°ã€‚

2. **è·¯ç”±å±‚**ï¼š

   * ai-service `/v1/ask` è§£æ body.messagesï¼Œå¹¶ä¼ ç»™ `runScene`ï¼›
   * local-ai-service `/v1/ask` åœ¨ `processHistory` åæŠŠç»“æœä¼ å…¥ `runScene`ã€‚

3. **æ‰§è¡Œå±‚ï¼ˆsceneRunnerï¼‰**ï¼š

   * å¯¹äºä¸€èˆ¬é—®ç­”ç±»åœºæ™¯ï¼ˆåŒ…å« RAGï¼‰ï¼Œæœ€ç»ˆ messages æ ¼å¼ä¸ºï¼š

     * ç¬¬ä¸€æ¡ï¼š`system`ï¼ˆå½“å‰è¯­è¨€ promptï¼‰
     * ä¸­é—´ï¼šå†å²å¯¹è¯ï¼ˆuser / assistantï¼‰
     * æœ€åä¸€æ¡ï¼šå½“å‰é—®é¢˜ï¼ˆ`userPrefix + question + refPrefix + reference`ï¼‰
   * å¯¹äºç¿»è¯‘/æ¶¦è‰²ç­‰ç‰¹æ®Šåœºæ™¯ï¼Œç»´æŒåŸé€»è¾‘ï¼ˆä¸æ‹¼å†å²ï¼‰ï¼Œé¿å…ç ´åç°æœ‰è¡Œä¸ºã€‚

---

## 3. å…·ä½“ä¿®æ”¹æ­¥éª¤ï¼ˆæŒ‰æ–‡ä»¶æ‹†è§£ï¼‰

### 3.1 `apps/ai-service/src/lib/sceneRunner.ts` â€”â€” æ ¸å¿ƒæ‰§è¡Œå±‚æ”¹é€ 

#### 3.1.1 æ‰©å±• RunSceneOptions æ¥å£

æ‰¾åˆ° `RunSceneOptions` å®šä¹‰ï¼ˆè¯Šæ–­åœ¨ 53â€“78 è¡Œï¼‰ï¼š

åœ¨æ¥å£é‡Œæ–°å¢ä¸€ä¸ªå¯é€‰å­—æ®µï¼š

```ts
export interface RunSceneOptions {
  // ... ç°æœ‰å­—æ®µ ...
  // å¯¹è¯å†å²ï¼ˆåœ¨è·¯ç”±å±‚åšåŸºç¡€è¿‡æ»¤ï¼Œè¿™é‡Œå‡å®šæ ¼å¼å·²è§„èŒƒï¼‰
  messages?: Array<{
    role: "system" | "user" | "assistant";
    content: string;
  }>;
}
```

> è¦æ±‚ï¼š
>
> * ä¸è¦æ”¹åŠ¨ç°æœ‰å­—æ®µåå’Œå«ä¹‰ï¼›
> * åªæ–°å¢ `messages?`ï¼Œç¡®ä¿ä¸ä¼šç ´åç°æœ‰è°ƒç”¨ç‚¹ã€‚

---

#### 3.1.2 æ‰©å±• buildMessagesï¼šæ”¯æŒåˆå¹¶å†å²

æ‰¾åˆ° `buildMessages` å‡½æ•°ï¼ˆ447â€“473 è¡Œï¼‰ï¼š

å½“å‰ç­¾åç±»ä¼¼ï¼š

```ts
export function buildMessages(opts: {
  sysPrompt: string;
  userPrefix: string;
  question: string;
  refPrefix: string;
  reference?: string | null;
  sceneKey?: string;
}): Array<{ role: "system" | "user" | "assistant"; content: string }> { ... }
```

**ä¿®æ”¹ä¸ºï¼š**

```ts
export function buildMessages(opts: {
  sysPrompt: string;
  userPrefix: string;
  question: string;
  refPrefix: string;
  reference?: string | null;
  sceneKey?: string;
  // æ–°å¢ï¼šå¯¹è¯å†å²ï¼ˆå·²è¿‡æ»¤ï¼Œrole = user/assistant/systemï¼‰
  messages?: Array<{ role: "system" | "user" | "assistant"; content: string }>;
}): Array<{ role: "system" | "user" | "assistant"; content: string }> {
  const { sysPrompt, userPrefix, question, refPrefix, reference, sceneKey, messages } = opts;

  // ç¿»è¯‘/æ¶¦è‰²åœºæ™¯ï¼šä»ç„¶ä¸ä½¿ç”¨å†å²ï¼Œä¿æŒåŸæœ‰é€»è¾‘
  if (sceneKey === "question_translation" || sceneKey === "question_polish") {
    return [
      { role: "system", content: sysPrompt },
      { role: "user", content: question },
    ];
  }

  // å…¶ä»–åœºæ™¯ï¼šsystem + å†å² + å½“å‰ç”¨æˆ·é—®é¢˜ï¼ˆå« RAG å¼•ç”¨ï¼‰
  const finalMessages: Array<{ role: "system" | "user" | "assistant"; content: string }> = [];

  // 1) system promptï¼šå§‹ç»ˆä½¿ç”¨å½“å‰è¯­è¨€çš„ sysPrompt è¦†ç›–å†å²ä¸­çš„ system
  finalMessages.push({ role: "system", content: sysPrompt });

  // 2) å†å²å¯¹è¯ï¼šåªä¿ç•™ user/assistant çš„å†…å®¹ï¼Œé¿å…æ—§ system æ··å…¥
  if (messages && messages.length > 0) {
    for (const msg of messages) {
      if (
        msg &&
        typeof msg.content === "string" &&
        msg.content.trim().length > 0 &&
        (msg.role === "user" || msg.role === "assistant")
      ) {
        finalMessages.push({
          role: msg.role,
          content: msg.content,
        });
      }
    }
  }

  // 3) å½“å‰ç”¨æˆ·é—®é¢˜ + RAG å¼•ç”¨
  finalMessages.push({
    role: "user",
    content: `${userPrefix} ${question}\n\n${refPrefix}\n${reference || "ï¼ˆç„¡/Noneï¼‰"}`,
  });

  return finalMessages;
}
```

> è¯´æ˜ï¼š
>
> * æˆ‘ä»¬æ˜¾å¼ä¸¢å¼ƒå†å²é‡Œçš„ `system`ï¼Œä¿è¯å§‹ç»ˆç”¨æœ€æ–°è¯­è¨€çš„ system promptï¼›
> * å†å²æ¶ˆæ¯ä¸åŠ å‰ç¼€ / RAG å¼•ç”¨ï¼Œåªåœ¨**å½“å‰é—®é¢˜**ä¸ŠåŠ å‰ç¼€/å¼•ç”¨ï¼Œé¿å…ä¿¡æ¯è†¨èƒ€ï¼›
> * ç¿»è¯‘/æ¶¦è‰²åœºæ™¯ä¿æŒæ—§è¡Œä¸ºï¼Œé˜²æ­¢ break ç‰¹å®š pipelineã€‚

---

#### 3.1.3 åœ¨ runScene ä¸­æ¥æ”¶å¹¶ä¼ é€’ messages

åœ¨ `runScene` å‡½æ•°ä¸­ï¼ˆ738â€“803 è¡Œï¼‰ï¼Œç›®å‰è§£æ„ options æ—¶æ²¡æœ‰ `messages`ï¼š

æ‰¾åˆ°ï¼š

```ts
export async function runScene(
  options: RunSceneOptions
): Promise<SceneResult> {
  const { 
    sceneKey, 
    locale, 
    question, 
    reference, 
    userPrefix, 
    refPrefix, 
    config, 
    providerKind,
    aiProvider = "openai",
    model,
    ollamaBaseUrl,
    ollamaModel,
    sourceLanguage,
    targetLanguage,
    temperature = 0.4,
  } = options;
  // ...
  const messages = buildMessages({
    sysPrompt,
    userPrefix,
    question,
    refPrefix,
    reference,
    sceneKey,
  });
```

æ”¹ä¸ºï¼š

```ts
export async function runScene(
  options: RunSceneOptions
): Promise<SceneResult> {
  const { 
    sceneKey, 
    locale, 
    question, 
    reference, 
    userPrefix, 
    refPrefix, 
    config, 
    providerKind,
    aiProvider = "openai",
    model,
    ollamaBaseUrl,
    ollamaModel,
    sourceLanguage,
    targetLanguage,
    temperature = 0.4,
    messages, // æ–°å¢ï¼šè§£æ„å¯¹è¯å†å²
  } = options;

  // ...

  const messagesForModel = buildMessages({
    sysPrompt,
    userPrefix,
    question,
    refPrefix,
    reference,
    sceneKey,
    messages, // æŠŠå†å²ä¼ è¿›å»
  });

  // åç»­æ‰€æœ‰ä½¿ç”¨ messages çš„åœ°æ–¹æ”¹ä¸º messagesForModel
  console.log("[SCENE-RUNNER] å‡†å¤‡è°ƒç”¨æ¨¡å‹:", {
    sceneKey,
    providerKind,
    model: providerKind === "openai" ? model : ollamaModel,
    hasResponseFormat: !!responseFormat,
    responseFormat,
    messageCount: messagesForModel.length,
    sysPromptLength: sysPrompt.length,
    sysPromptPreview: sysPrompt.substring(0, 200) + "...",
  });

  // å®é™…è°ƒç”¨ provider æ—¶ä¹Ÿä½¿ç”¨ messagesForModel
  // ä¾‹å¦‚ï¼š
  // await openai.chat.completions.create({ messages: messagesForModel, ... })
  // await ollama.chat({ messages: messagesForModel, ... })
}
```

> æ³¨æ„ï¼š
>
> * ä¸è¦æ”¹å˜æ—¥å¿—å­—æ®µåï¼Œåªæ˜¯æŠŠ `messages` æ¢æˆæ–°çš„ `messagesForModel`ï¼›
> * ç¡®ä¿æ‰€æœ‰åç»­å¼•ç”¨ `messages` çš„åœ°æ–¹ç»Ÿä¸€æ›¿æ¢ä¸º `messagesForModel`ã€‚

---

### 3.2 `apps/local-ai-service/src/routes/ask.ts` â€”â€” ä½¿ç”¨ processHistory å¹¶ä¼ ç»™ runScene

è¯Šæ–­æŠ¥å‘Šæ˜¾ç¤ºï¼Œè¿™é‡Œå·²ç»æœ‰ `processHistory`ï¼š

```ts
// 3) å¤„ç†å¯¹è¯å†å²
const history = processHistory(messages, maxHistory);
```

ä½†æ²¡æœ‰ä¼ ç»™ `runScene`ã€‚

1. æ‰¾åˆ° `/v1/ask` è·¯ç”±ä¸­è°ƒç”¨ `runScene` çš„ä½ç½®ï¼ˆåº”åœ¨æ„é€  `sceneOptions` é‚£ä¸€æ®µï¼‰ã€‚
   ç°åœ¨å¤§è‡´ç±»ä¼¼ï¼š

   ```ts
   const sceneResult = await runScene({
     sceneKey: scene,
     locale: promptLocale,
     question: normalizedQuestion,
     reference,
     userPrefix,
     refPrefix,
     config: commonConfig,
     providerKind,
     aiProvider,
     model,
     serviceConfig,
     ollamaBaseUrl,
     ollamaModel,
     sourceLanguage,
     targetLanguage,
     temperature,
     sceneConfigTimeoutMs,
   });
   ```

2. åœ¨ä¸Šé¢å¯¹è±¡é‡Œè¡¥å……ï¼š

   ```ts
   messages: history,
   ```

   å®Œæ•´ç¤ºä¾‹ï¼š

   ```ts
   const sceneResult = await runScene({
     sceneKey: scene,
     locale: promptLocale,
     question: normalizedQuestion,
     reference,
     userPrefix,
     refPrefix,
     config: commonConfig,
     providerKind,
     aiProvider,
     model,
     serviceConfig,
     ollamaBaseUrl,
     ollamaModel,
     sourceLanguage,
     targetLanguage,
     temperature,
     sceneConfigTimeoutMs,
     messages: history, // æ–°å¢ï¼šå¯¹è¯å†å²
   });
   ```

3. å»ºè®®åœ¨æœ¬æ–‡ä»¶å·²æœ‰çš„æ—¥å¿—å¤„å¢åŠ ä¸€è¡Œç®€çŸ­è°ƒè¯•ä¿¡æ¯ï¼Œè®°å½•å†å²æ¡æ•°ï¼ˆä»…å¼€å‘è°ƒè¯•ç”¨ï¼‰ï¼š

   ```ts
   console.log("[LOCAL-AI] å†å²æ¶ˆæ¯æ¡æ•°:", {
     scene,
     historyCount: history.length,
   });
   ```

---

### 3.3 `apps/ai-service/src/routes/ask.ts` â€”â€” è§£æ messages å¹¶ä¼ ç»™ runScene

è¯Šæ–­æŠ¥å‘ŠæŒ‡å‡ºï¼šai-service `/v1/ask` å®Œå…¨æ²¡è§£æ `messages`ã€‚

#### 3.3.1 æ‰©å±• parseAndValidateBodyï¼ˆæˆ–ç›´æ¥è§£æ bodyï¼‰

1. æ‰¾åˆ°è§£æè¯·æ±‚ä½“çš„é€»è¾‘ï¼Œç±»ä¼¼ï¼š

   ```ts
   const {
     question,
     normalizedQuestion,
     lang,
     scene,
     sourceLanguage,
     targetLanguage,
     maxHistory = 10,
     // ...
   } = parseAndValidateBody(request.body);
   ```

2. è¯·åœ¨ `parseAndValidateBody` ä¸­å¢åŠ  `messages` å­—æ®µè§£æä¸åŸºç¡€æ ¡éªŒï¼ˆå¦‚æœè¿™ä¸ªå‡½æ•°åœ¨åŒæ–‡ä»¶ä¸­å®šä¹‰ï¼Œå°±ç›´æ¥æ”¹å®ƒï¼›å¦‚æœåœ¨åˆ«å¤„ï¼Œåˆ™æŒ‰è§„èŒƒæ‰©å±•è¿”å›å€¼ï¼‰ï¼š

   * è¦æ±‚ï¼š

     * `messages` æ˜¯æ•°ç»„æˆ– undefinedï¼›
     * æ¯é¡¹åŒ…å« `role` å’Œ `content`ï¼›
     * `role` é™åˆ¶åœ¨ `"user" | "assistant" | "system"`ï¼›
     * `content` ä¸ºéç©ºå­—ç¬¦ä¸²ï¼›
     * è¿‡æ»¤æ‰ä¸åˆæ³•é¡¹ã€‚

   ä¸€ä¸ªç®€åŒ–å®ç°ç¤ºä¾‹ï¼ˆå¯åœ¨ parseAndValidateBody å†…éƒ¨æˆ–è·¯ç”±å†…å†™ï¼‰ï¼š

   ```ts
   function sanitizeMessages(raw: any, maxHistory: number = 10) {
     if (!Array.isArray(raw)) return [];

     const valid = raw.filter(
       (msg) =>
         msg &&
         (msg.role === "user" || msg.role === "assistant" || msg.role === "system") &&
         typeof msg.content === "string" &&
         msg.content.trim().length > 0
     );

     // å»æ‰å¤šä½™ systemï¼ˆåªä¿ç•™ç¬¬ä¸€ä¸ªï¼‰ï¼Œä¸ local processHistory ä¿æŒè®¾è®¡ä¸€è‡´
     const systemMessages = valid.filter((msg) => msg.role === "system");
     const nonSystemMessages = valid.filter((msg) => msg.role !== "system");

     const recent = nonSystemMessages.slice(-maxHistory);

     const systemHead = systemMessages.length > 0 ? [systemMessages[0]] : [];

     return [...systemHead, ...recent];
   }
   ```

   > å¯é€‰æ‹©ï¼š
   >
   > * ç›´æ¥å¤ç”¨ local-ai-service ä¸­çš„ `processHistory` é€»è¾‘ï¼ˆå¤åˆ¶åŒä¸€å¥—å®ç°ï¼‰ï¼Œä¿è¯ä¸¤è¾¹è¡Œä¸ºä¸€è‡´ã€‚

3. åœ¨è·¯ç”±å‡½æ•°é‡Œï¼Œæ‹¿åˆ° body åè°ƒç”¨ï¼š

   ```ts
   const rawBody = request.body as any;
   const {
     question,
     normalizedQuestion,
     lang,
     scene,
     sourceLanguage,
     targetLanguage,
     maxHistory = 10,
     // ...
   } = parseAndValidateBody(rawBody);

   const history = sanitizeMessages(rawBody.messages, maxHistory);
   ```

#### 3.3.2 æŠŠ history ä¼ ç»™ runScene

åœ¨è°ƒç”¨ `runScene` çš„åœ°æ–¹ï¼Œåƒåˆšæ‰ local-ai-service ä¸€æ ·åŠ ä¸Šï¼š

```ts
const sceneResult = await runScene({
  sceneKey: scene,
  locale: promptLocale,
  question: normalizedQuestion,
  reference,
  userPrefix,
  refPrefix,
  config: commonConfig,
  providerKind,
  aiProvider,
  model,
  serviceConfig,
  ollamaBaseUrl,
  ollamaModel,
  sourceLanguage,
  targetLanguage,
  temperature,
  sceneConfigTimeoutMs,
  messages: history, // æ–°å¢ï¼šå¯¹è¯å†å²
});
```

å¹¶åœ¨ç°æœ‰ `[ASK ROUTE] ä½¿ç”¨åœºæ™¯æ‰§è¡Œæ¨¡å—` æ—¥å¿—ä¸­å¢åŠ ä¸€ä¸ªå­—æ®µæ–¹ä¾¿æ’æŸ¥ï¼š

```ts
console.log("[ASK ROUTE] ä½¿ç”¨åœºæ™¯æ‰§è¡Œæ¨¡å—:", {
  scene,
  locale: promptLocale,
  originalLang: lang,
  requestedLang,
  sourceLanguage,
  targetLanguage,
  model,
  aiProvider,
  historyCount: history.length, // æ–°å¢
});
```

---

## 4. æµ‹è¯•ç”¨ä¾‹è¦æ±‚ï¼ˆå¤šè½®å¯¹è¯ + è¯­è¨€ç¨³å®šæ€§ï¼‰

Cursor ä¿®æ”¹å®Œæˆåï¼Œè¯·æŒ‰ä»¥ä¸‹æµ‹è¯•çŸ©é˜µåœ¨ **è¿œç¨‹ ai-service** ä¸ **local-ai-service** ä¸Šåˆ†åˆ«éªŒè¯ï¼ˆå¯ä»¥ç”¨ curl / Postmanï¼Œæˆ–é€šè¿‡å‰ç«¯é¡µé¢ + åå°æ—¥å¿—ï¼‰ï¼š

### 4.1 åœºæ™¯ Aï¼šæ—¥æ–‡å¤šè½®å¯¹è¯ï¼ˆå…³é”®åœºæ™¯ï¼‰

#### ç¬¬ 1 è½®

è¯·æ±‚ï¼š

```json
{
  "scene": "chat",
  "question": "ã“ã‚“ã«ã¡ã¯",
  "lang": "ja",
  "model": "qwen2.5:3b-instruct",
  "maxHistory": 10,
  "messages": []
}
```

é¢„æœŸï¼š

* `requestedLang = "ja"`ï¼Œ`selectedLang = "ja"`ï¼ˆæˆ– fallback æ—¶æœ‰ warningï¼‰ï¼›
* `messageCount >= 2`ï¼ˆsystem + å½“å‰ userï¼‰ï¼›
* è¿”å›å†…å®¹ä¸º**æ—¥æ–‡**ã€‚

#### ç¬¬ 2 è½®

æŠŠç¬¬ 1 è½® Q/A ä½œä¸º historyï¼š

```json
{
  "scene": "chat",
  "question": "ã•ã£ãã®èª¬æ˜ã‚’ã‚‚ã†å°‘ã—ç°¡å˜ã«ã—ã¦ãã ã•ã„ã€‚",
  "lang": "ja",
  "model": "qwen2.5:3b-instruct",
  "maxHistory": 10,
  "messages": [
    { "role": "user", "content": "ã“ã‚“ã«ã¡ã¯" },
    { "role": "assistant", "content": "<ä¸Šä¸€è½®çš„æ—¥æ–‡å›ç­”>" }
  ]
}
```

é¢„æœŸï¼š

* ai-service / local-ai-service æ—¥å¿—ä¸­ï¼š

  * `[ASK ROUTE] ... historyCount: 2`ï¼›
  * `[SCENE-RUNNER] å‡†å¤‡è°ƒç”¨æ¨¡å‹: messageCount >= 3`ï¼ˆsystem + 2 æ¡å†å² + å½“å‰é—®é¢˜ï¼‰ï¼›
* è¿”å›å†…å®¹ä»ä¸º**æ—¥æ–‡**ï¼Œå¹¶ä¸”å¯¹ä¸Šä¸€è½®å›ç­”æœ‰ä¸Šä¸‹æ–‡æ„ŸçŸ¥ã€‚

### 4.2 åœºæ™¯ Bï¼šè‹±æ–‡å¤šè½®å¯¹è¯ï¼ˆåŒä¸Šï¼‰

åŒç†ï¼Œç”¨ `lang: "en"` + ç®€å•è‹±æ–‡é—®é¢˜åšä¸¤è½®æµ‹è¯•ï¼Œè¦æ±‚ï¼š

* è¯­è¨€ä¿æŒè‹±æ–‡ï¼›
* historyCount / messageCount ä¸é¢„æœŸä¸€è‡´ã€‚

### 4.3 åœºæ™¯ Cï¼šæ— å†å²æ—¶è¡Œä¸ºä¸å˜

å‘é€åªå¸¦ `question` / `lang` / `messages: []` çš„è¯·æ±‚ï¼Œç¡®è®¤æ¶ˆæ¯æ•°é‡ä»ç„¶æ˜¯ 2ï¼ˆsystem + å½“å‰ userï¼‰ï¼Œè¯­ä¹‰ä¸ä¿®å¤å‰ä¸€è‡´ã€‚

---

## 5. æ‰§è¡ŒæŠ¥å‘Šè¦æ±‚

è¯· Cursor æ–°å¢ä¸€ä»½æ‰§è¡ŒæŠ¥å‘Šï¼Œä¾‹å¦‚ï¼š

```text
docs/é—®é¢˜ä¿®å¤/CP-20251202-003_å¤šè½®å¯¹è¯å†å²ä¸è¯­è¨€ä¸€è‡´æ€§/æ‰§è¡ŒæŠ¥å‘Š/CP-20251202-003_å¤šè½®å¯¹è¯å†å²ä¸è¯­è¨€ä¸€è‡´æ€§_æ‰§è¡ŒæŠ¥å‘Š.md
```

å†…å®¹è‡³å°‘åŒ…æ‹¬ï¼š

1. **é—®é¢˜æ‘˜è¦**ï¼šå¼•ç”¨è¯Šæ–­æŠ¥å‘Šä¸­çš„ç»“è®ºâ€”â€”â€œbuildMessages/runScene æœªå¤„ç† messagesï¼Œå¯¼è‡´å¤šè½®å¯¹è¯è¯­è¨€åˆ‡å›ä¸­æ–‡â€ã€‚
2. **ä¿®æ”¹æ–‡ä»¶ä¸æ ¸å¿ƒå˜æ›´ç‚¹**ï¼š

   * sceneRunnerï¼šRunSceneOptions å¢åŠ  messagesï¼›buildMessages åˆå¹¶ sys + history + å½“å‰é—®é¢˜ï¼›
   * local-ai-service `/v1/ask`ï¼šä½¿ç”¨ processHistoryï¼Œå¹¶å°† history ä¼ ç»™ runSceneï¼›
   * ai-service `/v1/ask`ï¼šè§£æ messagesï¼Œæ„å»º historyï¼Œä¼ ç»™ runSceneã€‚
3. **è¯­è¨€é€»è¾‘ç¡®è®¤**ï¼š

   * è¯´æ˜æœ¬æ¬¡æ”¹åŠ¨ä¿æŒäº† `requestedLang/selectedLang` è¯­è¨€é€‰æ‹©ç­–ç•¥ä¸å˜ï¼Œåªæ˜¯å¢åŠ äº†å¯¹è¯å†å²æ”¯æŒã€‚
4. **æµ‹è¯•ç»“æœ**ï¼š

   * é’ˆå¯¹ åœºæ™¯ A/B/C çš„è¯·æ±‚ç¤ºä¾‹ã€å…³é”®æ—¥å¿—æˆªå–ï¼ˆhistoryCountã€messageCountã€selectedLangï¼‰ã€å®é™…è¿”å›è¯­è¨€æè¿°ã€‚
5. **å…¼å®¹æ€§è¯´æ˜**ï¼š

   * å•è½®å¯¹è¯è¡Œä¸ºä¸å˜ï¼›
   * æ—  DB ç»“æ„å˜æ›´ï¼›
   * ç‰¹æ®Šåœºæ™¯ï¼ˆç¿»è¯‘/æ¶¦è‰²ï¼‰ä¸æ‹¼æ¥å†å²ï¼Œä¿æŒåŸé€»è¾‘ã€‚


