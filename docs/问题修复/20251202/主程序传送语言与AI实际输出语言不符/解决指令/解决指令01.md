0. æœ¬æ¬¡ä»»åŠ¡èŒƒå›´å£°æ˜ï¼ˆå¿…é¡»å†™ï¼‰

æœ¬æ¬¡ä»»åŠ¡åªå…è®¸ä¿®æ”¹ä»¥ä¸‹æ–‡ä»¶ï¼š

apps/ai-service/src/routes/ask.ts

apps/ai-service/src/lib/sceneRunner.ts

apps/local-ai-service/src/routes/ask.ts

ç¦æ­¢ä¿®æ”¹ï¼š

web ä¸»ç¨‹åºï¼ˆNext.js / apps/web/**ï¼‰

æ•°æ®åº“ç»“æ„ï¼ˆç¦æ­¢æ–°å¢/ä¿®æ”¹è¡¨å­—æ®µï¼‰

ç›®æ ‡ï¼šè®© ai-service / local-ai-service å°Šé‡å‰ç«¯ä¼ å…¥çš„ langï¼Œä¼˜å…ˆä½¿ç”¨å¯¹åº”è¯­è¨€çš„ system promptï¼Œæ²¡æœ‰æ—¶å†é™çº§åˆ°ä¸­æ–‡ã€‚

1. è§„èŒƒå¯¹é½æ£€æŸ¥æ‘˜è¦ï¼ˆè®© Cursor å…ˆè¾“å‡ºä¸€æ®µï¼‰

è¯· Cursor åœ¨çœŸæ­£æ”¹ä»£ç å‰ï¼Œå…ˆè¾“å‡ºä¸€ä¸ªâ€œè§„èŒƒå¯¹é½æ£€æŸ¥æ‘˜è¦â€ï¼Œå†…å®¹åŒ…æ‹¬ï¼š

å·²é˜…è¯» / éœ€éµå®ˆæ–‡æ¡£ï¼š

/Users/leo/Desktop/drivequizç ”å‘è§„èŒƒ/ğŸ§© AI æœåŠ¡ç ”å‘è§„èŒƒï¼ˆai-service ç»Ÿä¸€æ¶æ„è§„èŒƒ v1.0ï¼‰.md

/Users/leo/Desktop/drivequizç ”å‘è§„èŒƒ/ğŸ§© AI æ ¸å¿ƒæœåŠ¡è§„èŒƒï¼ˆai-core ç»Ÿä¸€æ¶æ„è§„èŒƒ v2.0ï¼‰.md

/Users/leo/Desktop/drivequizç ”å‘è§„èŒƒ/æ•°æ®åº“ç»“æ„_AI_SERVICE.md

/Users/leo/Desktop/drivequizç ”å‘è§„èŒƒ/AIæ¿å—æ•´ä½“æ¶æ„è¯´æ˜.mdï¼ˆå¦‚æœ‰ï¼‰

æœ¬ä»»åŠ¡å—çº¦æŸæ¡æ¬¾ï¼š

A1ï¼šè·¯ç”±å±‚åªåšå‚æ•°è§£æå’Œè°ƒåº¦ï¼Œä¸å†™å¤æ‚ä¸šåŠ¡é€»è¾‘

B1/B3ï¼šæ•°æ®åº“ç»“æ„ä¸æ”¹ï¼Œä¿æŒä¸æ–‡æ¡£ä¸€è‡´

C1â€“C3ï¼šæœ¬åœ°(local-ai-service)ä¸è¿œç¨‹(ai-service)é€»è¾‘ä¿æŒä¸€è‡´ã€éƒ½è¦å¯ç”¨

D1/D2ï¼šå¿…é¡»è¾“å‡ºæ‰§è¡ŒæŠ¥å‘Šï¼Œè®°å½•æœ¬æ¬¡å˜æ›´

2. é—®é¢˜å…³é”®ç‚¹å›é¡¾ï¼ˆç»™ Cursor çœ‹ï¼‰

è¯Šæ–­æŠ¥å‘Šå·²ç»æŒ‡å‡ºé—®é¢˜é›†ä¸­åœ¨è¿™å‡ æ®µï¼š

ask è·¯ç”±å¼ºåˆ¶ä¸­æ–‡ locale

apps/ai-service/src/routes/ask.ts ä¸­ï¼š

// âœ… ä¿®å¤ï¼šå¼ºåˆ¶ä½¿ç”¨ 'zh' ä½œä¸º localeï¼Œå› ä¸ºåœºæ™¯é…ç½®åªä½¿ç”¨ä¸­æ–‡ prompt
const promptLocale = "zh"; // å¼ºåˆ¶ä½¿ç”¨ä¸­æ–‡ï¼Œé¿å…å› ç¼ºå°‘å…¶ä»–è¯­è¨€ prompt å¯¼è‡´çš„é”™è¯¯


sceneRunner åªæ‹¿ä¸­æ–‡ prompt

apps/ai-service/src/lib/sceneRunner.ts ä¸­ï¼š

// å¼ºåˆ¶åªä½¿ç”¨ä¸­æ–‡ promptï¼ˆå¿½ç•¥ locale å‚æ•°ï¼‰
let prompt = sceneConfig.system_prompt_zh;
let selectedLang = "zh";

console.log("[SCENE-RUNNER] ä½¿ç”¨ä¸­æ–‡ prompt (locale:", locale, "lang:", lang, ", å¼ºåˆ¶ä½¿ç”¨ä¸­æ–‡)");


local-ai-service é‡Œä¹Ÿæœ‰åŒæ ·çš„å¼ºåˆ¶ zh é€»è¾‘ï¼ˆè¯Šæ–­æŠ¥å‘ŠæŒ‡å‡º 545â€“546, 579â€“582 è¡Œæœ‰åŒæ ·å†™æ³•ï¼‰ã€‚

3. å…·ä½“ä¿®å¤æ­¥éª¤
3.1 å…¬å…±å·¥å…·å‡½æ•°ï¼šè§„èŒƒåŒ– lang / localeï¼ˆå»ºè®®æ”¾ sceneRunner æˆ–å•ç‹¬ utilï¼‰

æ–‡ä»¶ï¼šapps/ai-service/src/lib/sceneRunner.tsï¼ˆæˆ–åŒç›®å½• util æ–‡ä»¶ï¼ŒæŒ‰è§„èŒƒæ¥ï¼‰

æ–°å¢ä¸€ä¸ªç±»å‹ä¸å·¥å…·å‡½æ•°ï¼Œç”¨æ¥ç»Ÿä¸€æŠŠ lang/locale å˜æˆ 'zh' | 'ja' | 'en'ï¼š

type SupportedLang = "zh" | "ja" | "en";

function normalizeRequestedLang(
  lang?: string | null,
  locale?: string | null
): SupportedLang {
  const normalize = (v?: string | null): string => (v || "").toLowerCase();

  const l = normalize(lang);
  const loc = normalize(locale);

  // 1ï¼‰ä¼˜å…ˆç”¨ lang
  if (l === "zh" || l === "zh-cn") return "zh";
  if (l === "ja" || l === "ja-jp") return "ja";
  if (l === "en" || l === "en-us") return "en";

  // 2ï¼‰é€€è€Œç”¨ locale æ¨æ–­
  if (loc.startsWith("ja")) return "ja";
  if (loc.startsWith("en")) return "en";
  if (loc.startsWith("zh")) return "zh";

  // 3ï¼‰å…œåº•ï¼šä¸­æ–‡
  return "zh";
}


è¦æ±‚ï¼š

local-ai-service å¦‚æœ‰å•ç‹¬ sceneRunnerï¼Œå¯å¤ç”¨åŒæ ·é€»è¾‘ï¼ˆå¤åˆ¶æˆ–æŠ½å…¬å…±æ¨¡å—ï¼‰ï¼›

ä¸è¦å¼•å…¥æ–°çš„ç¬¬ä¸‰æ–¹åº“ã€‚

3.2 ä¿®å¤ /v1/ask è·¯ç”±ï¼šä¸å†å†™æ­» promptLocale = "zh"

æ–‡ä»¶ï¼šapps/ai-service/src/routes/ask.ts

æ‰¾åˆ°æ¥æ”¶ body çš„ä½ç½®ï¼Œå½“å‰å¤§è‡´æ˜¯ï¼š

const { question, normalizedQuestion, lang, scene, sourceLanguage, targetLanguage } =
  parseAndValidateBody(request.body);


æŠŠåŸæ¥çš„ï¼š

const promptLocale = "zh"; // å¼ºåˆ¶ä½¿ç”¨ä¸­æ–‡
const userPrefix = lang === "ja" ? "è³ªå•ï¼š" : lang === "en" ? "Question:" : "é—®é¢˜ï¼š";
const refPrefix =
  lang === "ja" ? "é–¢é€£å‚ç…§ï¼š" : lang === "en" ? "Related references:" : "ç›¸å…³å‚è€ƒèµ„æ–™ï¼š";


æ”¹ä¸ºï¼š

// 1ï¼‰è§„èŒƒåŒ–è¯·æ±‚è¯­è¨€ï¼ˆåŸºäº lang + å°†æ¥å¯èƒ½åŠ çš„ localeï¼‰
const requestedLang = normalizeRequestedLang(lang, request.body?.locale);

// 2ï¼‰promptLocale ç­‰åŒäºæœ€ç»ˆé€‰æ‹©çš„è¯­è¨€ï¼ˆzh/ja/enï¼‰
const promptLocale: SupportedLang = requestedLang;

// 3ï¼‰å‰ç¼€ä»ç„¶åŸºäºæœ€ç»ˆè¯­è¨€
const userPrefix =
  promptLocale === "ja" ? "è³ªå•ï¼š" : promptLocale === "en" ? "Question:" : "é—®é¢˜ï¼š";
const refPrefix =
  promptLocale === "ja"
    ? "é–¢é€£å‚ç…§ï¼š"
    : promptLocale === "en"
    ? "Related references:"
    : "ç›¸å…³å‚è€ƒèµ„æ–™ï¼š";


åœ¨è°ƒç”¨ runScene æ—¶ï¼Œä¼ å…¥è§„èŒƒåŒ–åçš„è¯­è¨€ï¼Œä¸å†æ˜¯å†™æ­» "zh"ï¼š

åŸæ¥ï¼š

sceneResult = await runScene({
  sceneKey: scene,
  locale: promptLocale, // ä»¥å‰æ˜¯å†™æ­» zh
  // ... å…¶ä»–å‚æ•°
});


æ”¹æˆï¼š

sceneResult = await runScene({
  sceneKey: scene,
  locale: promptLocale,   // "zh" | "ja" | "en"
  lang: requestedLang,    // æ˜ç¡®ä¼ ç»™ sceneRunnerï¼Œç”¨äºæ—¥å¿—ä¸é€‰æ‹©é€»è¾‘
  // ... å…¶ä»–ç°æœ‰å‚æ•°ä¿æŒä¸å˜
});


æŠŠ [ASK ROUTE] ä½¿ç”¨åœºæ™¯æ‰§è¡Œæ¨¡å— çš„æ—¥å¿—ç¨å¾®å¢å¼ºä¸€ä¸‹ï¼Œä¾¿äºä»¥åæ’æŸ¥ï¼š

console.log("[ASK ROUTE] ä½¿ç”¨åœºæ™¯æ‰§è¡Œæ¨¡å—:", {
  scene,
  locale: promptLocale,
  originalLang: lang,
  requestedLang,
  sourceLanguage,
  targetLanguage,
  model,
  aiProvider,
});


æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯ä½¿ç”¨ç°æœ‰å‚æ•° + æ–°å¢ requestedLang å­—æ®µï¼Œä¸è¦åˆ æ‰å·²æœ‰æ—¥å¿—ç»“æ„ã€‚

3.3 ä¿®å¤ sceneRunnerï¼šé€‰æ‹©å¯¹åº”è¯­è¨€ prompt + ç¼ºå¤±æ—¶é™çº§ä¸­æ–‡

æ–‡ä»¶ï¼šapps/ai-service/src/lib/sceneRunner.ts

å½“å‰é€»è¾‘å¤§è‡´æ˜¯ï¼š

let prompt = sceneConfig.system_prompt_zh;
let selectedLang = "zh";
// ...
console.log("[SCENE-RUNNER] ä½¿ç”¨ä¸­æ–‡ prompt (locale:", locale, "lang:", lang, ", å¼ºåˆ¶ä½¿ç”¨ä¸­æ–‡)");


è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤ä¿®æ”¹ï¼š

åœ¨ fetchSceneConfigFromDb ä¹‹åã€ä½¿ç”¨ prompt ä¹‹å‰ï¼Œå¼•å…¥ä¸Šé¢å®šä¹‰çš„ normalizeRequestedLangï¼š

const requestedLang = normalizeRequestedLang(lang, locale);


æ ¹æ® requestedLang å’Œ sceneConfig é€‰æ‹© promptï¼š

let prompt = "";
let selectedLang: SupportedLang = "zh";

// å…ˆå°è¯•ç”¨å¯¹åº”è¯­è¨€çš„ prompt
if (requestedLang === "ja" && sceneConfig.system_prompt_ja) {
  prompt = sceneConfig.system_prompt_ja;
  selectedLang = "ja";
} else if (requestedLang === "en" && sceneConfig.system_prompt_en) {
  prompt = sceneConfig.system_prompt_en;
  selectedLang = "en";
} else if (sceneConfig.system_prompt_zh) {
  // å¯¹åº”è¯­è¨€ç¼ºå¤±æ—¶é™çº§ä¸­æ–‡
  prompt = sceneConfig.system_prompt_zh;
  selectedLang = "zh";
  console.warn("[SCENE-RUNNER] requested prompt not found, fallback to zh", {
    sceneKey,
    requestedLang,
    hasZhPrompt: !!sceneConfig.system_prompt_zh,
    hasJaPrompt: !!sceneConfig.system_prompt_ja,
    hasEnPrompt: !!sceneConfig.system_prompt_en,
  });
} else {
  // æ‰€æœ‰ prompt éƒ½ä¸ºç©ºï¼Œç»™å‡ºè­¦å‘Šä½† allow ç©º prompt
  console.warn("[SCENE-RUNNER] all prompts empty, using empty system prompt", {
    sceneKey,
    requestedLang,
  });
  prompt = "";
  selectedLang = requestedLang;
}


æ›´æ–°æ—¥å¿—ï¼Œä¸å†ç¡¬ç¼–ç â€œä½¿ç”¨ä¸­æ–‡ promptâ€ï¼Œæ”¹ä¸ºé€šç”¨ç‰ˆæœ¬ï¼š

const finalPrompt = prompt || "";

console.log("[SCENE-RUNNER] åœºæ™¯é…ç½®è¯»å–æˆåŠŸ:", {
  sceneKey,
  locale,
  requestedLang,
  selectedLang,
  promptLength: finalPrompt.length,
  promptPreview: finalPrompt.substring(0, 200) + "...",
  hasZhPrompt: !!sceneConfig.system_prompt_zh,
  hasJaPrompt: !!sceneConfig.system_prompt_ja,
  hasEnPrompt: !!sceneConfig.system_prompt_en,
  outputFormat: sceneConfig.output_format,
});


æ³¨æ„ï¼š

ä¿ç•™åŸæ¥å…³äº hasZhPrompt / hasJaPrompt / hasEnPrompt çš„ä¿¡æ¯ï¼Œæ–¹ä¾¿åç»­è¡¥é…ç½®ã€‚

ä¸è¦å†æ‰“å°â€œå¼ºåˆ¶ä½¿ç”¨ä¸­æ–‡â€çš„æç¤ºã€‚

3.4 åŒæ­¥ä¿®æ”¹ local-ai-service çš„ /v1/ask

æ–‡ä»¶ï¼šapps/local-ai-service/src/routes/ask.ts

è¯Šæ–­æŠ¥å‘Šä¸­æŒ‡å‡ºï¼Œè¿™é‡Œä¹Ÿæœ‰ç±»ä¼¼çš„å¼ºåˆ¶ zh é€»è¾‘ã€‚å¤„ç†æ–¹å¼å’Œ ai-service ä¿æŒä¸€è‡´ï¼š

æ‰¾åˆ°æœ¬åœ° /v1/ask ä¸­ç±»ä¼¼ï¼š

const promptLocale = "zh";


æ”¹æˆä¸ 3.2 ä¸­å®Œå…¨ç›¸åŒçš„é€»è¾‘ï¼š

ä½¿ç”¨ normalizeRequestedLang(lang, body?.locale)ï¼›

å¾—åˆ° requestedLang å’Œ promptLocaleï¼›

å°† locale: promptLocale å’Œ lang: requestedLang ä¼ å…¥æœ¬åœ°çš„åœºæ™¯æ‰§è¡Œæ¨¡å—ï¼ˆå¦‚æœå‡½æ•°ç­¾åä¸åŒï¼ŒæŒ‰å®é™…å‚æ•°åé€‚é…ï¼‰ã€‚

æ—¥å¿—ä¹Ÿå»ºè®®åŒæ­¥å¢å¼ºï¼Œæ‰“å°ï¼š

console.log("[LOCAL-AI] ä½¿ç”¨åœºæ™¯æ‰§è¡Œæ¨¡å—:", {
  scene,
  locale: promptLocale,
  originalLang: lang,
  requestedLang,
  // ... å…¶ä»–å­—æ®µ
});

4. æµ‹è¯•è¦æ±‚ï¼ˆai-service & local-ai-service ä¸¤è¾¹éƒ½è¦è¦†ç›–ï¼‰

è¯· Cursor åœ¨æœ¬åœ°ç¯å¢ƒå¯¹ è¿œç¨‹ ai-service å’Œ local-ai-service å„è·‘ä¸€éä¸‹é¢ä¸‰ç§è¯·æ±‚ï¼ˆå¯ä»¥ç”¨ curl æˆ– Postmanï¼Œå†™åœ¨æ‰§è¡ŒæŠ¥å‘Šé‡Œï¼‰ï¼š

ç»Ÿä¸€è°ƒç”¨ /v1/askï¼Œbody ç¤ºä¾‹ï¼ˆåªéœ€è¦†ç›–å…³é”®å­—æ®µï¼‰ï¼š

4.1 åœºæ™¯ä¸€ï¼šä¸­æ–‡
{
  "scene": "chat",
  "question": "ä½ å¥½",
  "lang": "zh",
  "model": "qwen2.5:3b-instruct",
  "maxHistory": 0,
  "messages": []
}


é¢„æœŸï¼š

ai-service æ—¥å¿—ä¸­ï¼š

[ASK ROUTE] æ—¥å¿—ï¼šoriginalLang: "zh", requestedLang: "zh", locale: "zh";

[SCENE-RUNNER] åœºæ™¯é…ç½®è¯»å–æˆåŠŸ æ—¥å¿—ï¼šselectedLang: "zh", hasZhPrompt: trueã€‚

è¿”å›å†…å®¹ï¼šä¸­æ–‡ã€‚

4.2 åœºæ™¯äºŒï¼šæ—¥æ–‡
{
  "scene": "chat",
  "question": "ã“ã‚“ã«ã¡ã¯",
  "lang": "ja",
  "model": "qwen2.5:3b-instruct",
  "maxHistory": 0,
  "messages": []
}


é¢„æœŸï¼š

å¦‚ system_prompt_ja å­˜åœ¨ï¼š

requestedLang: "ja", locale: "ja", selectedLang: "ja", hasJaPrompt: trueï¼›

è¿”å›å†…å®¹å€¾å‘æ—¥æ–‡ã€‚

å¦‚ system_prompt_ja ä¸ºç©ºï¼š

çœ‹åˆ°ä¸€æ¡ fallback to zh çš„ warningï¼›

selectedLang: "zh", å®é™…ä½¿ç”¨ä¸­æ–‡ promptï¼›

è¿”å›å†…å®¹ä¸­æ–‡ï¼ˆè¿™æ˜¯é¢„æœŸçš„â€œé™çº§è¡Œä¸ºâ€ï¼Œä½†æœªæ¥å¯ä»¥é€šè¿‡è¡¥ prompt æ¶ˆé™¤ï¼‰ã€‚

4.3 åœºæ™¯ä¸‰ï¼šè‹±æ–‡
{
  "scene": "chat",
  "question": "Hello",
  "lang": "en",
  "model": "qwen2.5:3b-instruct",
  "maxHistory": 0,
  "messages": []
}


é¢„æœŸä¸æ—¥æ–‡ç±»ä¼¼ï¼Œåªæ˜¯è¯­è¨€æ¢æˆè‹±æ–‡ã€‚

è¦æ±‚ï¼š

è¿œç¨‹ ai-service å’Œ local-ai-service å„è‡³å°‘æµ‹è¯•ä¸€æ¬¡ä¸‰ç§è¯­è¨€ã€‚

æ‰§è¡ŒæŠ¥å‘Šé‡Œé™„ä¸Šå…³é”®æ—¥å¿—æˆªå–ï¼ˆå°¤å…¶åŒ…å« requestedLang, selectedLang, hasXPrompt å­—æ®µï¼‰ã€‚

5. æ‰§è¡ŒæŠ¥å‘Šè¦æ±‚ï¼ˆAI æœåŠ¡ç«¯ä¸“ç”¨ï¼‰

è¯· Cursor åˆ›å»ºæ–°çš„æ‰§è¡ŒæŠ¥å‘Šæ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š

docs/é—®é¢˜ä¿®å¤/CP-20251202-002_è¯­è¨€é€‰æ‹©ä¼ é€’é—®é¢˜_AI_SERVICE/æ‰§è¡ŒæŠ¥å‘Š/CP-20251202-002_è¯­è¨€é€‰æ‹©ä¼ é€’é—®é¢˜_AI_SERVICE_æ‰§è¡ŒæŠ¥å‘Š.md


æŠ¥å‘Šè‡³å°‘åŒ…å«ï¼š

é—®é¢˜æ‘˜è¦ï¼šå¼•ç”¨æœ¬æ¬¡æœåŠ¡ç«¯è¯Šæ–­çš„ç»“è®ºï¼ˆâ€œæ­¤å‰å¼ºåˆ¶ä½¿ç”¨ä¸­æ–‡ promptï¼Œå¿½ç•¥ langâ€ï¼‰ã€‚

ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨ï¼šåˆ—å‡ºä¸Šè¿° 3 ä¸ªæ–‡ä»¶çš„ç²¾ç¡®è·¯å¾„å’Œä¸»è¦æ”¹åŠ¨ç‚¹ã€‚

è¯­è¨€é€‰æ‹©ç­–ç•¥è¯´æ˜ï¼š

å¦‚ä½•ä» lang / locale æ¨å¯¼ requestedLangï¼›

å¦‚ä½•åœ¨ sceneRunner ä¸­åŸºäº requestedLang é€‰æ‹©å…·ä½“ promptï¼›

ç¼ºå¤±æ—¶å¦‚ä½•é™çº§å¹¶è®°å½• warningã€‚

æµ‹è¯•ç»“æœï¼šæŒ‰ 4.1â€“4.3 åœºæ™¯ï¼Œè¯´æ˜è¯·æ±‚å‚æ•° + logger å®é™…è¾“å‡º + è¿”å›è¯­è¨€æ˜¯å¦ç¬¦åˆé¢„æœŸã€‚

å…¼å®¹æ€§è¯´æ˜ï¼š

æœªä¿®æ”¹æ•°æ®åº“ç»“æ„ï¼›

å½“æ•°æ®åº“ä¸­åªæœ‰ä¸­æ–‡ prompt æ—¶ï¼Œç›®å‰è¡Œä¸ºä¸æ—§ç‰ˆæœ¬ä¸€è‡´ï¼ˆä»è¿”å›ä¸­æ–‡ï¼‰ï¼Œä½†å¢åŠ äº† warningï¼Œå¹¶ä¸ºå°†æ¥è¡¥å¤šè¯­è¨€ prompt åšå¥½å‡†å¤‡ã€‚