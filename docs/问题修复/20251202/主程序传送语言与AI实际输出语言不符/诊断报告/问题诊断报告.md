# 主程序传送语言与AI实际输出语言不符问题诊断报告

**报告日期**: 2025-12-02  
**问题类型**: 语言参数传递与处理不一致  
**严重程度**: 中等  
**影响范围**: 所有使用AI服务的场景（翻译、润色、填漏、标签等）

---

## 一、问题整体叙述

### 1.1 问题描述

主程序在调用AI服务时传递了语言参数（`lang` 或 `locale`，如 "zh"、"ja"、"en"），期望AI按照指定语言输出结果。但实际运行中发现，AI服务的输出语言与主程序传递的语言参数不一致，导致：

- 主程序传递 `lang: "ja"`，期望日文输出，但AI可能输出中文或其他语言
- 主程序传递 `lang: "en"`，期望英文输出，但AI可能输出中文或其他语言
- 主程序传递 `lang: "zh"`，期望中文输出，但AI可能输出其他语言

### 1.2 问题表现

1. **语言参数传递链路**：
   - 主程序通过 `callAiServer()` 传递 `locale` 参数
   - `callAiServer()` 将 `locale` 转换为 `lang` 参数传递给AI服务
   - AI服务接收 `lang` 参数，但在场景配置读取时强制使用 `promptLocale = "zh"`

2. **场景配置读取**：
   - AI服务始终使用中文版本的 system prompt（`system_prompt_zh`）
   - 忽略主程序传递的语言参数，不根据 `lang` 选择对应语言的 prompt

3. **输出语言不一致**：
   - AI模型收到中文的 system prompt，但可能根据用户输入或其他因素输出不同语言
   - 导致输出语言与主程序期望不符

---

## 二、问题原因分析

### 2.1 根本原因

**核心问题**：AI服务在读取场景配置时，强制使用中文 prompt，完全忽略了主程序传递的语言参数。

### 2.2 代码位置与逻辑

#### 2.2.1 主程序语言参数传递

**文件**: `src/lib/aiClient.server.ts`

```typescript:124:124:src/lib/aiClient.server.ts
lang: rest.locale || "zh",
```

主程序通过 `callAiServer()` 传递 `locale` 参数，并转换为 `lang` 参数传递给AI服务。

#### 2.2.2 AI服务接收语言参数

**文件**: `apps/ai-service/src/routes/ask.ts`

```typescript:212:212:apps/ai-service/src/routes/ask.ts
const { question, normalizedQuestion, lang, scene, sourceLanguage, targetLanguage } = parseAndValidateBody(request.body);
```

AI服务正确接收了 `lang` 参数。

#### 2.2.3 强制使用中文 prompt（问题所在）

**文件**: `apps/ai-service/src/routes/ask.ts`

```typescript:331:332:apps/ai-service/src/routes/ask.ts
// ✅ 修复：强制使用 'zh' 作为 locale，因为场景配置只使用中文 prompt
const promptLocale = "zh"; // 强制使用中文，避免因缺少其他语言 prompt 导致的错误
```

**问题**：无论主程序传递什么 `lang` 参数，AI服务都强制使用 `promptLocale = "zh"` 来读取场景配置。

#### 2.2.4 场景配置读取逻辑

**文件**: `apps/ai-service/src/lib/sceneRunner.ts`

```typescript:270:282:apps/ai-service/src/lib/sceneRunner.ts
// 强制只使用中文 prompt（忽略 locale 参数）
// 原因：批量任务处理时，数据库中可能只有中文 prompt，其他语言的 prompt 可能不存在
// 为了避免 scene_not_found 错误，统一使用中文 prompt
let prompt = sceneConfig.system_prompt_zh;
let selectedLang = "zh";

// 如果中文 prompt 不存在或为空，记录警告
if (!prompt || prompt.trim() === "") {
  console.warn("[SCENE-RUNNER] 中文 prompt 不存在或为空，使用空字符串:", { sceneKey, locale });
  prompt = "";
}

console.log("[SCENE-RUNNER] 使用中文 prompt (locale:", locale, "lang:", lang, ", 强制使用中文)");
```

**问题**：`fetchSceneConfigFromDb()` 函数虽然接收了 `locale` 参数，但完全忽略它，始终使用 `system_prompt_zh`。

#### 2.2.5 场景执行调用

**文件**: `apps/ai-service/src/routes/ask.ts`

```typescript:358:360:apps/ai-service/src/routes/ask.ts
sceneResult = await runScene({
  sceneKey: scene,
  locale: promptLocale, // 强制使用 'zh'
```

**问题**：传递给 `runScene()` 的 `locale` 参数始终是 `"zh"`，而不是主程序传递的 `lang` 参数。

### 2.3 设计意图与实际问题

#### 2.3.1 设计意图

根据代码注释，强制使用中文 prompt 的原因：
- **避免错误**：批量任务处理时，数据库中可能只有中文 prompt，其他语言的 prompt 可能不存在
- **向后兼容**：避免因缺少其他语言 prompt 导致的 `scene_not_found` 错误

#### 2.3.2 实际问题

虽然避免了配置缺失错误，但导致了新问题：
1. **语言参数被忽略**：主程序传递的语言参数完全无效
2. **输出语言不一致**：AI模型收到中文指令，但可能根据其他因素（如用户输入语言）输出不同语言
3. **用户体验差**：用户期望日文输出，但收到中文或其他语言

---

## 三、日志信息

### 3.1 关键日志位置

#### 3.1.1 主程序调用日志

**文件**: `src/lib/aiClient.server.ts`

```typescript:110:119:src/lib/aiClient.server.ts
console.log("[callAiServer] 调用 AI 服务:", {
  provider,
  url: `${url.substring(0, 50)}...`,
  scene: rest.scene,
  sourceLanguage: rest.sourceLanguage,
  targetLanguage: rest.targetLanguage,
  model: rest.model,
  timeoutMs: timeout,
  allRestKeys: Object.keys(rest),
});
```

**日志内容**：记录调用参数，但不包含 `locale` 或 `lang` 参数。

#### 3.1.2 AI服务接收日志

**文件**: `apps/ai-service/src/routes/ask.ts`

```typescript:346:354:apps/ai-service/src/routes/ask.ts
console.log("[ASK ROUTE] 使用场景执行模块:", {
  scene,
  locale: promptLocale,
  originalLang: lang,
  sourceLanguage,
  targetLanguage,
  model,
  aiProvider,
});
```

**日志内容**：
- `locale: promptLocale` - 始终为 `"zh"`
- `originalLang: lang` - 主程序传递的原始语言参数（被忽略）

#### 3.1.3 场景配置读取日志

**文件**: `apps/ai-service/src/lib/sceneRunner.ts`

```typescript:282:296:apps/ai-service/src/lib/sceneRunner.ts
console.log("[SCENE-RUNNER] 使用中文 prompt (locale:", locale, "lang:", lang, ", 强制使用中文)");

const finalPrompt = prompt || "";
console.log("[SCENE-RUNNER] 场景配置读取成功:", { 
  sceneKey, 
  locale, 
  selectedLang,
  promptLength: finalPrompt.length,
  promptPreview: finalPrompt.substring(0, 200) + "...",
  duration: `${duration}ms`,
  hasZhPrompt: !!sceneConfig.system_prompt_zh,
  hasJaPrompt: !!sceneConfig.system_prompt_ja,
  hasEnPrompt: !!sceneConfig.system_prompt_en,
  outputFormat: sceneConfig.output_format,
});
```

**日志内容**：
- `locale` - 传入的 locale 参数（但被忽略）
- `selectedLang` - 始终为 `"zh"`
- `hasZhPrompt`, `hasJaPrompt`, `hasEnPrompt` - 显示数据库中是否存在对应语言的 prompt

### 3.2 日志分析

从日志可以看出：
1. **主程序传递的语言参数被记录**：`originalLang: lang`
2. **但实际使用的 locale 被强制为中文**：`locale: promptLocale`（始终为 `"zh"`）
3. **场景配置读取时忽略 locale**：虽然接收了 `locale` 参数，但始终使用 `system_prompt_zh`

---

## 四、之前采取过的措施详情

### 4.1 措施一：强制使用中文 prompt

**时间**: 未知（根据代码注释推测为批量任务处理优化时）

**位置**: 
- `apps/ai-service/src/routes/ask.ts` (第331-332行)
- `apps/ai-service/src/lib/sceneRunner.ts` (第270-282行)
- `apps/local-ai-service/src/routes/ask.ts` (第545-546行, 第579-582行)

**措施内容**：
```typescript
// ✅ 修复：强制使用 'zh' 作为 locale，因为场景配置只使用中文 prompt
const promptLocale = "zh"; // 强制使用中文，避免因缺少其他语言 prompt 导致的错误
```

**原因**：
- 批量任务处理时，数据库中可能只有中文 prompt
- 避免因缺少其他语言 prompt 导致的 `scene_not_found` 错误

**效果**：
- ✅ 避免了配置缺失错误
- ❌ 导致语言参数被忽略
- ❌ 导致输出语言与期望不符

### 4.2 措施二：语言检测功能（历史措施）

**文件**: `docs/FIX_LANGUAGE_DETECTION.md`

**措施内容**：
- 添加语言自动检测功能 `detectLanguageFromQuestion()`
- 完全忽略传入的 `lang` 参数，只根据问题内容自动检测语言
- 强化系统提示词，明确要求AI用指定语言回复

**适用范围**：
- 仅适用于前端直接调用AI服务的场景
- 不适用于服务端批量处理场景

**当前状态**：
- 该措施可能已被后续的强制使用中文 prompt 措施覆盖
- 需要确认是否仍在生效

### 4.3 措施三：userPrefix 和 refPrefix 根据 lang 设置

**位置**: `apps/ai-service/src/routes/ask.ts`

```typescript:333:335:apps/ai-service/src/routes/ask.ts
const userPrefix = lang === "ja" ? "質問：" : lang === "en" ? "Question:" : "问题：";
const refPrefix =
  lang === "ja" ? "関連参照：" : lang === "en" ? "Related references:" : "相关参考资料：";
```

**措施内容**：
- 根据 `lang` 参数设置用户消息前缀和参考内容前缀
- 这部分逻辑正确使用了 `lang` 参数

**问题**：
- 虽然前缀使用了正确的语言，但 system prompt 仍然是中文
- 导致AI模型收到混合语言的指令（中文 system prompt + 多语言前缀）

---

## 五、影响范围分析

### 5.1 受影响的功能

1. **翻译场景** (`question_translation`)
   - 主程序传递 `targetLanguage`，期望输出对应语言
   - 但 system prompt 是中文，可能导致输出语言不一致

2. **润色场景** (`question_polish`)
   - 主程序传递 `locale`，期望输出对应语言的润色结果
   - 但 system prompt 是中文，可能导致输出语言不一致

3. **填漏场景** (`fill_missing`)
   - 主程序传递 `locale`，期望输出对应语言的填充内容
   - 但 system prompt 是中文，可能导致输出语言不一致

4. **标签场景** (`question_tagging`)
   - 主程序传递 `locale`，期望输出对应语言的标签
   - 但 system prompt 是中文，可能导致输出语言不一致

### 5.2 受影响的服务

1. **ai-service** (远程AI服务)
   - 所有使用场景执行模块的场景都受影响

2. **local-ai-service** (本地AI服务)
   - 同样强制使用中文 prompt，存在相同问题

### 5.3 受影响的主程序调用

1. **批量处理** (`src/app/api/admin/question-processing/batch-process/route.ts`)
   - 批量翻译、润色、填漏等操作

2. **问题处理器** (`apps/question-processor/src/ai.ts`)
   - 通过 `callAiServer()` 调用AI服务

3. **前端API** (`apps/web/app/api/ai/chat/route.ts`)
   - 前端聊天接口

---

## 六、数据库配置情况

### 6.1 场景配置表结构

**表名**: `ai_scene_config`

**字段**:
- `system_prompt_zh` (text) - 中文系统提示词
- `system_prompt_ja` (text) - 日文系统提示词
- `system_prompt_en` (text) - 英文系统提示词
- `output_format` (text) - 输出格式
- `enabled` (boolean) - 是否启用

### 6.2 配置读取逻辑

**文件**: `apps/ai-service/src/lib/sceneRunner.ts`

```typescript:216:216:apps/ai-service/src/lib/sceneRunner.ts
const url = `${supabaseUrl.replace(/\/+$/, "")}/rest/v1/ai_scene_config?scene_key=eq.${encodeURIComponent(sceneKey)}&enabled=eq.true&select=system_prompt_zh,system_prompt_ja,system_prompt_en,output_format`;
```

**问题**：
- 虽然查询了所有语言的 prompt，但只使用 `system_prompt_zh`
- 其他语言的 prompt 被忽略

### 6.3 配置完整性

根据日志输出，可以检查：
- `hasZhPrompt` - 是否存在中文 prompt
- `hasJaPrompt` - 是否存在日文 prompt
- `hasEnPrompt` - 是否存在英文 prompt

**需要确认**：
- 数据库中是否所有场景都有完整的多语言 prompt
- 如果只有中文 prompt，需要补充其他语言的 prompt

---

## 七、问题总结

### 7.1 核心问题

**主程序传递的语言参数被AI服务忽略，导致输出语言与期望不符。**

### 7.2 问题根源

1. **设计权衡**：为了避免配置缺失错误，强制使用中文 prompt
2. **副作用**：导致语言参数完全无效，输出语言不一致
3. **设计缺陷**：没有考虑主程序的语言需求

### 7.3 修复方向

需要平衡两个需求：
1. **避免配置缺失错误**：当数据库中没有对应语言的 prompt 时，需要有降级策略
2. **尊重语言参数**：当主程序传递了语言参数时，应该优先使用对应语言的 prompt

### 7.4 修复建议

1. **优先使用对应语言的 prompt**：
   - 根据主程序传递的 `lang` 参数选择对应的 prompt
   - 如果对应语言的 prompt 不存在，再降级使用中文 prompt

2. **完善数据库配置**：
   - 确保所有场景都有完整的多语言 prompt
   - 如果某个场景只有中文 prompt，需要补充其他语言的 prompt

3. **增强日志记录**：
   - 记录实际使用的 prompt 语言
   - 记录降级使用中文 prompt 的情况

---

## 八、相关文件清单

### 8.1 核心文件

1. **主程序调用层**:
   - `src/lib/aiClient.server.ts` - AI服务调用封装

2. **AI服务路由层**:
   - `apps/ai-service/src/routes/ask.ts` - AI服务主路由
   - `apps/local-ai-service/src/routes/ask.ts` - 本地AI服务路由

3. **场景执行层**:
   - `apps/ai-service/src/lib/sceneRunner.ts` - 场景执行引擎

### 8.2 相关文档

1. **架构文档**:
   - `docs/AI板块整体架构说明.md` - AI板块整体架构

2. **历史修复文档**:
   - `docs/FIX_LANGUAGE_DETECTION.md` - 语言检测修复文档

### 8.3 数据库表

1. **场景配置表**:
   - `ai_scene_config` - 场景配置表（包含多语言 prompt）

---

## 九、后续行动建议

### 9.1 立即行动

1. **确认数据库配置**：
   - 检查所有场景是否都有完整的多语言 prompt
   - 如果缺少，需要补充

2. **修复代码逻辑**：
   - 修改场景配置读取逻辑，优先使用对应语言的 prompt
   - 添加降级策略（如果对应语言不存在，使用中文 prompt）

3. **增强日志**：
   - 记录实际使用的 prompt 语言
   - 记录降级情况

### 9.2 长期优化

1. **完善多语言支持**：
   - 确保所有场景都有完整的多语言 prompt
   - 建立 prompt 翻译和维护流程

2. **统一语言处理**：
   - 统一语言参数的处理逻辑
   - 避免不同服务之间的不一致

---

**报告结束**

