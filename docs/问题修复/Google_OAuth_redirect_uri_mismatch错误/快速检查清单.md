# Google OAuth redirect_uri_mismatch 快速检查清单

## ⚠️ v4 变更说明（最新）

**版本**: v4.0  
**更新日期**: 2025-11-27

### v4 核心变更（精简+安全收口）

- ✅ **代码精简**: 删除所有手动配置的 `redirectUri`，统一使用 `getAuthBaseUrl()` 生成
- ✅ **TLS 安全强校验**: 生产环境检测到 `NODE_TLS_REJECT_UNAUTHORIZED=0` 时，直接阻止应用启动
- ✅ **精简日志**: env.ts 和 auth.ts 中只保留必要的日志（不超过 3 条）
- ✅ **诊断接口精简**: 只返回 `NODE_ENV`、`baseUrl`、`expectedRedirectUri` 和 `note`

### 完成标准（v4）

- ✅ 生产环境启动日志中必须看到：`[NextAuth][Config] NODE_ENV=production, NEXTAUTH_URL=..., AUTH_URL=...`
- ✅ 访问诊断接口 `https://your-domain.vercel.app/api/auth/debug/google-redirect`，确认：
  - `baseUrl` 为：`https://your-domain.vercel.app`
  - `expectedRedirectUri` 为：`https://your-domain.vercel.app/api/auth/callback/google`
- ✅ Google Cloud Console 中配置的回调 URI 与诊断接口返回的 `expectedRedirectUri` **逐字一致**
- ✅ 生产环境未设置 `NODE_TLS_REJECT_UNAUTHORIZED=0`（否则应用启动失败）
- ✅ Google OAuth 登录功能正常工作

### v3 变更说明（历史）

**版本**: v3.0  
**更新日期**: 2025-11-27

- ✅ **框架层对齐**: Auth.js v5 使用 `AUTH_URL`，v3 已自动同步 `AUTH_URL ↔ NEXTAUTH_URL`
- ✅ **自诊断接口**: 新增 `GET /api/auth/debug/google-redirect` 用于验证配置
- ✅ **增强日志**: 输出环境变量快照和预期的 redirect_uri

### v2 变更说明（历史）

**版本**: v2.0  
**更新日期**: 2025-11-27

- ❌ **已废弃**: v1 版本中的 `VERCEL_URL` 自动回退逻辑已完全移除
- ✅ **新要求**: 生产环境**必须**显式配置 `NEXTAUTH_URL` 环境变量
- ✅ **强校验**: 生产环境配置不符合要求时，应用将**无法启动**

---

## ✅ 必须完成的步骤（按顺序执行）

### 1️⃣ 使用诊断接口（v4 推荐）

**操作**：
1. 访问 `https://your-domain.vercel.app/api/auth/debug/google-redirect`
2. 查看返回的 JSON：
   ```json
   {
     "NODE_ENV": "production",
     "baseUrl": "https://your-domain.vercel.app",
     "expectedRedirectUri": "https://your-domain.vercel.app/api/auth/callback/google",
     "note": "请在 Google Cloud Console 中将 expectedRedirectUri 精确加入 Authorized redirect URIs"
   }
   ```

**如果看到错误**：
- ⚠️ **问题确认**：Vercel 环境变量未配置或配置错误
- ➡️ **下一步**：执行步骤 2

**如果看到具体的 URL**：
- ✅ **记录 `expectedRedirectUri`**：`https://xxx.vercel.app/api/auth/callback/google`
- ➡️ **下一步**：执行步骤 3，确保 Google Cloud Console 中配置了完全相同的 URI

### 1️⃣-备选：检查 Vercel 部署日志

**操作**：
1. 登录 Vercel Dashboard
2. 进入项目 → **Deployments** → 最新部署
3. 查看 **Build Logs** 或 **Function Logs**
4. 查找以下日志：

```
[NextAuth][Config] NODE_ENV=production, NEXTAUTH_URL=..., AUTH_URL=...
[NextAuth][Google] expected redirect_uri: https://.../api/auth/callback/google
```

**如果看到错误**：
- ⚠️ **问题确认**：Vercel 环境变量未配置或配置错误
- ➡️ **下一步**：执行步骤 2

**如果看到具体的 URL**：
- ✅ **记录这个 URL**：`https://xxx.vercel.app/api/auth/callback/google`
- ➡️ **下一步**：执行步骤 3，确保 Google Cloud Console 中配置了完全相同的 URI

---

### 2️⃣ 在 Vercel 中设置环境变量

**操作**：
1. Vercel Dashboard → 项目 → **Settings** → **Environment Variables**
2. 点击 **Add**
3. 添加：

| 变量名 | 值 | 环境 |
|--------|-----|------|
| `NEXTAUTH_URL` | `https://your-actual-domain.vercel.app` | Production |

**重要**：
- ✅ 使用完整的 HTTPS URL（包含 `https://`）
- ✅ 不要包含末尾斜杠
- ✅ 使用实际的部署域名（从 Deployments 页面复制）

**如何获取正确的域名**：
- Vercel Dashboard → **Deployments** → 查看最新部署的 URL
- 或者 **Settings** → **Domains** → 查看配置的域名

4. 点击 **Save**
5. 重新部署：**Deployments** → 最新部署 → **...** → **Redeploy**

---

### 3️⃣ 在 Google Cloud Console 中配置回调 URI

**操作**：
1. 访问 https://console.cloud.google.com/
2. 选择正确的项目
3. **APIs & Services** → **Credentials**
4. 找到你的 OAuth 2.0 Client ID → 点击编辑（铅笔图标）

**配置 Authorized redirect URIs**：
- 添加：`https://your-actual-domain.vercel.app/api/auth/callback/google`
- ⚠️ **必须与步骤 1 中日志显示的 URL 完全一致**

**配置 Authorized JavaScript origins**：
- 添加：`https://your-actual-domain.vercel.app`
- ⚠️ **不要包含 `/api/auth/callback/google`**

5. 点击 **Save**

---

### 4️⃣ 验证配置（v4 推荐：使用诊断接口）

**操作**：
1. 等待 1-2 分钟（让配置生效）
2. 重新部署 Vercel 应用（如果还没有）
3. **访问诊断接口**（v4 推荐）：
   - 打开：`https://your-domain.vercel.app/api/auth/debug/google-redirect`
   - 确认返回的 `baseUrl` 为：`https://your-domain.vercel.app`
   - 确认返回的 `expectedRedirectUri` 为：`https://your-domain.vercel.app/api/auth/callback/google`
4. **对照 Google Cloud Console**：
   - 确保 Google Cloud Console 中的回调 URI 与诊断接口返回的 `expectedRedirectUri` **逐字一致**
5. **检查 TLS 安全配置**（v4 新增）：
   - 确认 Vercel 环境变量中**没有** `NODE_TLS_REJECT_UNAUTHORIZED=0`
   - 如果存在，删除该环境变量并重新部署
6. 测试 Google 登录

---

## 🔍 常见错误

### 错误 1：环境变量设置了但仍然是 "❌ 未设置"

**可能原因**：
- 环境变量设置了错误的**环境**（例如设置了 Development 而不是 Production）
- 没有重新部署

**解决方法**：
- 检查环境变量的**环境**设置，确保选择了 **Production**
- 重新部署应用

---

### 错误 2：回调 URI 仍然不匹配

**可能原因**：
- Google Cloud Console 中的回调 URI 与日志显示的不完全一致
- 可能有多余的空格、斜杠或大小写问题

**解决方法**：
1. 从 Vercel 日志中**精确复制**回调 URL
2. 在 Google Cloud Console 中**精确粘贴**（不要手动输入）
3. 确保没有多余的空格或字符

---

### 错误 3：多个环境（Production/Preview）都需要配置

**解决方法**：
- 在 Vercel 中为每个环境分别设置 `NEXTAUTH_URL`
- 在 Google Cloud Console 中为每个环境添加对应的回调 URI

---

## 📝 示例配置

### Vercel 环境变量

```
NEXTAUTH_URL=https://drivequiz20251102-app.vercel.app
```

### Google Cloud Console

**Authorized JavaScript origins**:
```
https://drivequiz20251102-app.vercel.app
http://localhost:3000
```

**Authorized redirect URIs**:
```
https://drivequiz20251102-app.vercel.app/api/auth/callback/google
http://localhost:3000/api/auth/callback/google
```

---

## 🆘 如果问题仍然存在

1. **检查部署日志**：确认环境变量是否正确加载
2. **检查 Google Cloud Console**：确认回调 URI 是否完全匹配
3. **清除浏览器缓存**：可能缓存了旧的配置
4. **等待几分钟**：Google Cloud Console 配置可能需要时间生效

