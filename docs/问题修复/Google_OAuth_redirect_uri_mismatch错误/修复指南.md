# Google OAuth redirect_uri_mismatch 错误修复指南

**错误信息**: `错误 400： redirect_uri_mismatch`

**问题描述**: 部署到 Vercel 后，Google 登录时出现此错误，表示 Google Cloud Console 中配置的回调 URI 与 NextAuth 实际使用的回调 URI 不匹配。

---

## ⚠️ v2 变更说明（重要）

**版本**: v2.0  
**更新日期**: 2025-11-27

### v2 核心变更

1. **删除 VERCEL_URL 回退方案**
   - ❌ **已废弃**: v1 版本中的 `VERCEL_URL` 自动回退逻辑已完全移除
   - ✅ **新要求**: 生产环境**必须**显式配置 `NEXTAUTH_URL` 环境变量
   - ✅ **强校验**: 生产环境配置不符合要求时，应用将**无法启动**（fail fast 策略）

2. **强校验规则**
   - 生产环境必须设置 `NEXTAUTH_URL`
   - 必须使用 HTTPS（`https://` 起始）
   - 不能包含尾部斜杠（如 `https://domain.com/` ❌）

3. **统一入口函数**
   - 所有 OAuth 相关逻辑统一使用 `getAuthBaseUrl()` 函数
   - 不再允许直接访问 `process.env.NEXTAUTH_URL`、`AUTH_URL` 或 `VERCEL_URL`

### v1 历史记录（已废弃）

v1 版本曾使用 `VERCEL_URL` 作为回退方案，但此方案存在以下问题：
- 容易导致配置不一致
- 问题容易反复出现
- 不符合最佳实践

**v1 方案已完全移除，请以 v2 为准。**

---

## ⚠️ 快速诊断

### 步骤 1：查看 Vercel 部署日志

1. 登录 Vercel Dashboard
2. 进入你的项目 → **Deployments**
3. 点击最新的部署
4. 查看 **Build Logs** 或 **Function Logs**
5. 查找以下日志行：
   ```
   [NextAuth] 📋 环境变量诊断:
   [NextAuth]   使用的 Auth URL: https://...
   [NextAuth]   Google Callback URL: https://.../api/auth/callback/google
   ```

**如果看到 "❌ 未设置"**：
- 说明 Vercel 环境变量未配置，需要执行下面的步骤 1

**如果看到具体的 URL**：
- 复制这个 URL
- 确保 Google Cloud Console 中配置了完全相同的回调 URI

---

## 一、问题原因

`redirect_uri_mismatch` 错误通常由以下原因导致：

1. **Vercel 环境变量未设置**（最常见）
   - `NEXTAUTH_URL` 或 `AUTH_URL` 未在 Vercel 中配置
   - 导致 NextAuth 无法确定正确的回调 URI

2. **Google Cloud Console 中未配置生产环境的回调 URI**
   - 只配置了本地开发环境的回调 URI（如 `http://localhost:3000/api/auth/callback/google`）
   - 未添加 Vercel 部署后的生产环境回调 URI

3. **回调 URI 格式不匹配**
   - Google Cloud Console 中的回调 URI 与 NextAuth 实际使用的 URI 不完全一致
   - 协议（http/https）、域名、端口、路径必须完全匹配

---

## 二、修复步骤

### 步骤 1：在 Vercel 中设置环境变量（必须）

1. **登录 Vercel Dashboard**
   - 访问 https://vercel.com/dashboard
   - 选择你的项目

2. **获取实际的部署域名**
   - 在 Vercel Dashboard 中，进入 **Deployments** 页面
   - 查看最新部署的 URL（例如：`https://drivequiz20251102-app.vercel.app`）
   - 或者查看 **Settings** → **Domains** 中配置的自定义域名
   - **复制这个完整的 URL**（包含 `https://`）

3. **设置环境变量**
   - 进入 **Settings** → **Environment Variables**
   - 点击 **Add** 按钮
   - 添加以下变量：

   **变量名**: `NEXTAUTH_URL`
   **值**: `https://your-actual-domain.vercel.app`（使用步骤 2 中复制的 URL）
   **环境**: 选择 **Production**（如果 Preview 环境也需要，也选择 Preview）

   **或者使用**：
   **变量名**: `AUTH_URL`
   **值**: `https://your-actual-domain.vercel.app`
   **环境**: 选择 **Production**

   **重要提示**：
   - ✅ 必须使用完整的 HTTPS URL（包含 `https://`）
   - ✅ 不能包含末尾斜杠（如 `https://domain.com/` ❌）
   - ✅ 必须使用实际的部署域名，不能使用 `localhost`
   - ✅ 确保选择了正确的环境（Production/Preview）

4. **保存并重新部署**
   - 点击 **Save** 保存环境变量
   - 进入 **Deployments** 页面
   - 点击最新部署右侧的 **...** 菜单
   - 选择 **Redeploy** 重新部署

### 步骤 2：配置 Google Cloud Console

1. **登录 Google Cloud Console**
   - 访问 https://console.cloud.google.com/
   - 选择正确的项目

2. **进入 OAuth 2.0 客户端配置**
   - 导航到 **APIs & Services** → **Credentials**
   - 找到你的 OAuth 2.0 Client ID（应该与 `GOOGLE_CLIENT_ID` 环境变量一致）
   - 点击编辑（铅笔图标）

3. **配置 Authorized JavaScript origins**
   
   添加以下来源（根据你的实际部署情况）：
   
   ```
   https://your-domain.vercel.app
   https://your-project.vercel.app
   ```
   
   **注意**：
   - 如果使用自定义域名，添加自定义域名
   - 如果使用 Vercel 默认域名，添加 Vercel 域名
   - 可以同时添加多个域名（开发、预览、生产）

4. **配置 Authorized redirect URIs**
   
   **必须添加以下回调 URI**：
   
   ```
   https://your-domain.vercel.app/api/auth/callback/google
   https://your-project.vercel.app/api/auth/callback/google
   ```
   
   **如果使用多个环境，添加所有环境的回调 URI**：
   
   ```
   # 生产环境
   https://your-domain.vercel.app/api/auth/callback/google
   
   # Preview 环境（如果需要）
   https://your-project-git-main-your-team.vercel.app/api/auth/callback/google
   
   # 开发环境（本地）
   http://localhost:3000/api/auth/callback/google
   ```

5. **保存配置**
   - 点击 **Save** 保存更改
   - 配置通常立即生效，但可能需要几分钟

### 步骤 3：验证配置

1. **检查环境变量**
   - 在 Vercel 部署日志中查看 `NEXTAUTH_URL` 的值
   - 确认值与 Google Cloud Console 中配置的回调 URI 的域名部分一致

2. **重新部署**
   - 在 Vercel Dashboard 中，进入 **Deployments**
   - 点击最新部署右侧的 **...** 菜单
   - 选择 **Redeploy** 重新部署

3. **测试登录**
   - 访问部署后的应用
   - 尝试使用 Google 登录
   - 如果仍然失败，检查浏览器控制台和 Vercel 日志

---

## 三、常见问题排查

### Q1: 如何确认 NextAuth 使用的回调 URI？

**方法 1：查看构建日志**
- 在 Vercel 部署日志中查找：
  ```
  [NextAuth] Google Callback URL: https://your-domain.vercel.app/api/auth/callback/google
  ```

**方法 2：检查代码**
- NextAuth 会自动使用 `NEXTAUTH_URL` 或 `AUTH_URL` + `/api/auth/callback/google`
- 代码位置：`src/lib/auth.ts` 第 36 行

### Q2: 为什么需要配置多个回调 URI？

- **开发环境**：`http://localhost:3000/api/auth/callback/google`
- **Preview 环境**：`https://project-git-branch.vercel.app/api/auth/callback/google`
- **生产环境**：`https://your-domain.vercel.app/api/auth/callback/google`

每个环境都需要单独配置，因为 Google OAuth 会严格验证回调 URI。

### Q3: 可以使用通配符吗？

**不可以**。Google OAuth 不支持通配符，必须明确列出每个回调 URI。

### Q4: 如何确认 Vercel 环境变量是否正确？

1. 在 Vercel Dashboard 中查看环境变量
2. 在部署日志中查看环境变量值（注意：敏感值会被隐藏）
3. 在代码中添加临时日志输出（仅用于调试，完成后删除）

---

## 四、快速检查清单

在修复前，请确认以下所有项：

- [ ] Vercel 环境变量 `NEXTAUTH_URL` 或 `AUTH_URL` 已设置
- [ ] 环境变量值使用 HTTPS（生产环境）
- [ ] 环境变量值不包含末尾斜杠
- [ ] Google Cloud Console 中已添加生产环境的回调 URI
- [ ] 回调 URI 格式为：`https://your-domain.vercel.app/api/auth/callback/google`
- [ ] Google Cloud Console 中已添加对应的 JavaScript origin
- [ ] 已保存 Google Cloud Console 配置
- [ ] 已重新部署 Vercel 应用

---

## 五、示例配置

### Vercel 环境变量（Production）

```
NEXTAUTH_URL=https://drivequiz20251102-app.vercel.app
NEXTAUTH_SECRET=your-secret-key-here
GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-client-secret
```

### Google Cloud Console 配置

**Authorized JavaScript origins**:
```
https://drivequiz20251102-app.vercel.app
http://localhost:3000
```

**Authorized redirect URIs**:
```
https://drivequiz20251102-app.vercel.app/api/auth/callback/google
http://localhost:3000/api/auth/callback/google
```

---

## 六、如果问题仍然存在

1. **检查 Vercel 部署日志**
   - 查看是否有环境变量相关的错误
   - 查看 NextAuth 的调试日志

2. **检查浏览器控制台**
   - 查看是否有 JavaScript 错误
   - 查看网络请求，确认回调 URI

3. **验证 Google OAuth 配置**
   - 确认 Client ID 和 Client Secret 正确
   - 确认 OAuth 同意屏幕已配置
   - 确认应用状态为"已发布"（如果需要）

4. **联系支持**
   - 如果以上步骤都已完成但问题仍然存在，请提供：
     - Vercel 部署 URL
     - Google Cloud Console 中配置的回调 URI
     - 错误截图或日志

