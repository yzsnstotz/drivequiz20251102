# 前台题库加载逻辑缓存优先修复_执行报告

## 任务摘要
- 修复目标：将前台题库加载逻辑严格执行“缓存优先 + 后台异步更新”，有缓存立即返回、不等待网络；无缓存才同步请求服务器；后台检查更新不得阻塞首屏渲染。
- 涉及模块：题库前端加载器与使用页面（学习、模拟考试、大乱斗）。

## 规范对齐检查摘要
- 已读取规范文件：
  - /Users/leo/Desktop/v3/docs/🔧指令模版/修复指令头5.2（现用）.md
  - /Users/leo/Desktop/drivequiz研发规范/数据库结构_DRIVEQUIZ.md
  - /Users/leo/Desktop/drivequiz研发规范/数据库结构_AI_SERVICE.md
  - /Users/leo/Desktop/drivequiz研发规范/文件结构.md
- 本任务受约束：A（架构红线）、B（数据库/文件结构红线）、D（执行报告红线）、E（反冗余规范）、F（AI模块边界）
- 强关联条款：A1、B1/B2、D1、E1/E3/E7/E8/E9/E10、F1/F5
- 修改文件路径：
  - src/lib/questionsLoader.ts
  - src/lib/version.ts（BUILD_TIME）
- 数据库/文件结构影响：无数据库结构变更；新增执行报告文档文件。

## 修改文件列表
- src/lib/questionsLoader.ts（逻辑最小改动）
- src/lib/version.ts（更新时间戳）
- docs/问题修复/前台题库加载逻辑缓存优先修复/执行报告/前台题库加载逻辑缓存优先修复_执行报告.md（新增）

## 行为对比说明（关键）
- 修复前（基于现有代码实际行为）：
  - 有缓存但仅存在 `questionsByLocale` 时，被视为“无可用缓存”，主流程会 `await loadFromServer()` → 同步等待网络，首屏受网络影响。
  - `loadAllQuestions()` 在顶层 `questions` 为空时直接返回空数组，忽略 `questionsByLocale`，导致使用便捷方法的页面可能无题，继续显示加载或空状态。
  - 当存在顶层 `questions` 时，已能立即返回缓存，并在后台调用 `checkForUpdatesInBackground()`（非 await）。
- 修复后：
  - `loadUnifiedQuestionsPackage()` 在本地存在任一可用题源（顶层 `questions` 或任一 `questionsByLocale` 有题）时，立即返回缓存；后台触发 `checkForUpdatesInBackground(localVersion)`，不 await；首屏不受网络影响。
  - `loadAllQuestions()` 增加语言回退：questions → zh → zh-CN → zh_CN → 任意有题的 locale，仅依赖已返回的包，不引入新的网络等待。

## 原始调用关系 vs 修复后的调用关系
- 原始（问题点）：
  - 有缓存但仅有 `questionsByLocale` → 主流程判定无缓存 → `await loadFromServer()` → 内部 `await getLatestPackageVersion()` + `await fetchUnifiedPackage()`。
  - 造成“有缓存仍同步查网”的隐性每次查询行为。
- 修复后：
  - 有缓存（任一题源）→ 立即 `return cached`，并触发 `checkForUpdatesInBackground(localVersion).catch(...)`（fire-and-forget）。
  - 无缓存 → 才执行 `await loadFromServer()`（内部同步获取版本与包并写入 localStorage）。

## 关键代码摘要（证明点）
- 函数签名未改动：
  - `export async function loadUnifiedQuestionsPackage(): Promise<UnifiedPackage | null>`
  - `export async function loadAllQuestions(): Promise<Question[]>`
- 取消“有缓存时的同步网络阻塞”：
  - src/lib/questionsLoader.ts:282–299
    - 增加 `hasTopLevel || hasLocale` 判断；命中后直接返回 `cached`；仅触发 `checkForUpdatesInBackground(localVersion).catch(...)`，不 await。
  - 保留后台异步更新机制：`checkForUpdatesInBackground` 内部拉版本、必要时下载新包并更新缓存，但不影响当前返回。
- 语言回退：
  - src/lib/questionsLoader.ts:323–334
    - 顶层 `questions` 为空时，按 zh → zh-CN → zh_CN → 任意可用 locale 回退，确保调用方获得题数组。

## 页面调用确认
- 学习页：`src/app/study/learn/page.tsx:77` 使用 `loadUnifiedQuestionsPackage()`，在包内选择当前语言或默认题源；不主动引入新 await。
- 模拟考试页：`src/app/exam/ExamPage.tsx:93` 使用 `loadAllQuestions()`；语言回退后能可靠返回题数组。
- 大乱斗页：`src/components/RoyalBattlePage.tsx:37` 使用 `loadAllQuestions()`；洗牌前即可获得题数组。

## 红线自检（A1–E10）
- A1 路由层无业务逻辑：已遵守（仅修改 lib 逻辑）
- A2/A3/A4：不涉及 AI 路由/统一接口：不适用
- B1 数据库结构文档同步：不涉及结构变更：不适用
- B2 文件结构文档同步：仅新增执行报告文档：不适用
- B3 类型与数据库一致：未改动类型：已遵守
- B4 禁止隐形字段：未新增字段：已遵守
- D1 执行报告生成：已遵守（本文件）
- E1 新增同时清理旧逻辑：已遵守（仅修正判定逻辑，无多版本共存）
- E2 禁止补丁堆叠：已遵守
- E3 单一事实来源：题库加载逻辑仍唯一于 `questionsLoader.ts`：已遵守
- E4 更新所有引用点：无需更新引用（调用不变）：已遵守
- E5 清理未用 imports/调试：无新增未用代码：已遵守
- E6 禁止新增未引用代码：无：已遵守
- E7 最小改动：仅必要片段变更：已遵守
- E8 Diff 思维：变更范围最小：已遵守
- E9 禁止增加不必要请求：有缓存不查网，减少请求：已遵守
- E10 冗余检测：不存在重复逻辑/未引用新增代码：已遵守

## AI 模块边界自检（F）
- F1 未修改 ai-core/ai-service/local-ai-service：YES（未修改）
- F5 边界自检：未新增本地 AI 逻辑，未绕过 ai-core：通过

## 简单本地测试步骤
1) 首次加载（清空缓存）
   - 操作：`localStorage.clear()` 后进入学习/模拟考试/大乱斗页面
   - 预期：触发 `loadFromServer()`，同步请求 `/api/questions/version` 和 `/api/questions/package`，成功后写入 `dq_questions_package_v_{version}` 与当前版本键。
2) 第二次刷新（缓存存在并有题）
   - 预期：`loadUnifiedQuestionsPackage()` 立即返回缓存；页面首屏不等待网络；后台触发版本检查与包下载（不影响本次渲染）。

## 风险点与下一步建议
- 弱网环境的后台下载可能失败：当前已完全不影响首屏，可在后续加入指数退避与失败统计。
- 如需进一步压缩首屏耗时，可将包接口前端超时从 30s 下调到 15s（仅在无缓存时生效）。

## 版本号更新
- src/lib/version.ts → BUILD_TIME 更新为：`2025-12-06 12:00:00`

