# æ‰¹é‡å¤„ç†å…¥åº“å†…å®¹ä¸å®Œæ•´é—®é¢˜å®ç°æ–¹æ³•

**æ–‡æ¡£æ—¥æœŸ**: 2025-11-21  
**é—®é¢˜ID**: BP-20251121-003  
**å…³è”è¯Šæ–­**: æ‰¹é‡å¤„ç†å…¥åº“å†…å®¹ä¸å®Œæ•´é—®é¢˜è¯Šæ–­æŠ¥å‘Š.md

---

## ğŸ“Œ ç¬¬ä¸€éƒ¨åˆ†ï¼šå®ç°ç›®æ ‡

### 1.1 æ ¸å¿ƒç›®æ ‡

1. **ç¡®ä¿æ‰€æœ‰ç›®æ ‡è¯­è¨€çš„ explanation æ­£ç¡®å…¥åº“**
   - ja explanation æˆåŠŸå…¥åº“ï¼ˆå·²ä¿®å¤ï¼‰
   - en explanation æˆåŠŸå…¥åº“ï¼ˆæ­£å¸¸ï¼‰
   - zh explanation æ­£ç¡®è¡¥å……ï¼ˆå¾…è§£å†³ï¼‰

2. **é˜²æ­¢è¯­è¨€è¯¯åˆ¤**
   - æ—¥æ–‡ä¸è¢«è¯¯åˆ¤ä¸ºä¸­æ–‡ï¼ˆå·²ä¿®å¤ï¼‰
   - ä¸­æ–‡ä¸è¢«è¯¯åˆ¤ä¸ºæ—¥æ–‡ï¼ˆæ­£å¸¸ï¼‰

3. **æä¾›å®Œæ•´çš„è°ƒè¯•æ•°æ®**
   - AI è¯·æ±‚ä½“ï¼ˆåŒ…æ‹¬ promptï¼‰
   - AI å®Œæ•´å“åº”
   - æœ€ç»ˆå…¥åº“æ•°æ®ï¼ˆå·²å®ç°ï¼‰

### 1.2 æŠ€æœ¯çº¦æŸ

- éµå¾ªæ¶æ„çº¢çº¿ï¼šä¸šåŠ¡é€»è¾‘åœ¨å·¥å…·å±‚ï¼Œè·¯ç”±å±‚ä¸æ‰¿è½½ä¸šåŠ¡é€»è¾‘
- éµå¾ªæ•°æ®åº“è§„èŒƒï¼šæ‰€æœ‰å­—æ®µä¿®æ”¹éœ€åŒæ­¥æ–‡æ¡£
- éµå¾ªæµ‹è¯•è§„èŒƒï¼šAI åŠŸèƒ½éœ€åŒç¯å¢ƒæµ‹è¯•

---

## ğŸ“Œ ç¬¬äºŒéƒ¨åˆ†ï¼šå®ç°æ­¥éª¤

### æ­¥éª¤1ï¼šæ”¹è¿›æ—¥æ–‡è¯†åˆ«ï¼ˆå·²å®Œæˆï¼‰

#### 1.1 é—®é¢˜åˆ†æ

**é—®é¢˜**ï¼šæ—¥æ–‡ä½¿ç”¨å¤§é‡æ±‰å­—ï¼Œè¢« `isChineseContent` è¯¯åˆ¤ä¸ºä¸­æ–‡

**ç¤ºä¾‹**ï¼š
```
ja content: "å›³ä¸­ã®æ¨™è­˜ãŒå‰æ–¹å·¦æ›²ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ã€‚"
- æ±‰å­—æ•°é‡: 10 ä¸ª
- æ€»å­—ç¬¦æ•°: 18 ä¸ª
- ä¸­æ–‡å æ¯”: 55.6%
- åˆ¤å®šç»“æœ: è¯¯åˆ¤ä¸ºä¸­æ–‡
```

#### 1.2 å®ç°æ–¹æ³•

**æ–‡ä»¶**: `src/app/api/admin/question-processing/_lib/batchProcessUtils.ts`  
**ä½ç½®**: ç¬¬ 296-322 è¡Œ

**å…³é”®ä»£ç **ï¼š
```typescript
export function isChineseContent(text: string): boolean {
  const { englishRatio, chineseRatio } = analyzeTextLanguage(text);
  
  // ğŸ“Š æ”¹è¿›ï¼šæ£€æµ‹æ—¥æ–‡å‡åæ¥åŒºåˆ†ä¸­æ–‡å’Œæ—¥æ–‡
  // å¦‚æœåŒ…å«å¹³å‡åæˆ–ç‰‡å‡åï¼Œå¤§æ¦‚ç‡æ˜¯æ—¥æ–‡ï¼Œä¸æ˜¯ä¸­æ–‡
  const hasHiragana = /[\u3040-\u309F]/.test(text); // å¹³å‡åï¼šãŒã€ã®ã€ã‚’ ç­‰
  const hasKatakana = /[\u30A0-\u30FF]/.test(text); // ç‰‡å‡å
  const hasJapaneseKana = hasHiragana || hasKatakana;
  
  // å¦‚æœæœ‰æ—¥æ–‡å‡åï¼Œä¸åˆ¤å®šä¸ºä¸­æ–‡
  if (hasJapaneseKana) {
    if (process.env.DEBUG_BATCH_LANG === "1") {
      console.debug(
        `[isChineseContent] æ£€æµ‹åˆ°æ—¥æ–‡å‡åï¼ˆå¹³å‡å=${hasHiragana}, ç‰‡å‡å=${hasKatakana}ï¼‰ï¼Œä¸åˆ¤å®šä¸ºä¸­æ–‡, preview="${text.slice(0, 80)}"`,
      );
    }
    return false;
  }
  
  // çº¦å®šï¼šå½“ä¸­æ–‡å æ¯” > 20% ä¸”è‹±æ–‡å æ¯” < 30% æ—¶è®¤ä¸ºæ˜¯"ä¸»è¦ä¸­æ–‡"
  const isChinese = chineseRatio > 0.2 && englishRatio < 0.3;
  
  return isChinese;
}
```

**Unicode èŒƒå›´è¯´æ˜**ï¼š
- **å¹³å‡åï¼ˆHiraganaï¼‰**: U+3040 ~ U+309F
  - ä¾‹ï¼šã‚ã€ã„ã€ã†ã€ãˆã€ãŠã€ã‹ã€ãã€ãã€ã‘ã€ã“ã€ãŒã€ãã€ãã€ã’ã€ã”...
- **ç‰‡å‡åï¼ˆKatakanaï¼‰**: U+30A0 ~ U+30FF
  - ä¾‹ï¼šã‚¢ã€ã‚¤ã€ã‚¦ã€ã‚¨ã€ã‚ªã€ã‚«ã€ã‚­ã€ã‚¯ã€ã‚±ã€ã‚³ã€ã‚¬ã€ã‚®ã€ã‚°ã€ã‚²ã€ã‚´...

**ä¸ºä»€ä¹ˆæœ‰æ•ˆ**ï¼š
- æ—¥æ–‡å¿…å®šåŒ…å«å‡åï¼ˆåŠ©è¯ã€åŠ¨è¯è¯å°¾ç­‰ï¼‰
- ä¸­æ–‡ä¸ä½¿ç”¨å‡å
- å³ä½¿æ—¥æ–‡ä½¿ç”¨å¤§é‡æ±‰å­—ï¼Œåªè¦æœ‰å‡åå°±èƒ½å‡†ç¡®è¯†åˆ«

#### 1.3 æµ‹è¯•éªŒè¯

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```typescript
// æµ‹è¯•æ—¥æ–‡è¯†åˆ«
const jaText = "å›³ä¸­ã®æ¨™è­˜ãŒå‰æ–¹å·¦æ›²ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ã€‚";
const result = isChineseContent(jaText);
// é¢„æœŸï¼šfalseï¼ˆæ­£ç¡®è¯†åˆ«ä¸ºéä¸­æ–‡ï¼‰
```

**éªŒè¯æ—¥å¿—**ï¼š
```
[isChineseContent] æ£€æµ‹åˆ°æ—¥æ–‡å‡åï¼ˆå¹³å‡å=true, ç‰‡å‡å=falseï¼‰ï¼Œä¸åˆ¤å®šä¸ºä¸­æ–‡
```

---

### æ­¥éª¤2ï¼šæ·»åŠ è°ƒè¯•æ•°æ®ä¿å­˜ï¼ˆå·²å®Œæˆï¼‰

#### 2.1 æ•°æ®åº“è¿ç§»

**æ–‡ä»¶**: `src/migrations/20250121_add_debug_fields_to_task_items.sql`

**SQL è„šæœ¬**ï¼š
```sql
ALTER TABLE question_processing_task_items
ADD COLUMN IF NOT EXISTS ai_request JSONB,         -- AI è¯·æ±‚ä½“ï¼ˆå®Œæ•´å†…å®¹ï¼‰
ADD COLUMN IF NOT EXISTS ai_response JSONB,        -- AI å“åº”ï¼ˆå®Œæ•´å†…å®¹ï¼‰
ADD COLUMN IF NOT EXISTS processed_data JSONB;     -- å¤„ç†åè¦å…¥åº“çš„æ•°æ®
```

#### 2.2 ç±»å‹å®šä¹‰æ›´æ–°

**æ–‡ä»¶**: `src/lib/db.ts`

**å…³é”®ä»£ç **ï¼š
```typescript
interface QuestionProcessingTaskItemsTable {
  id: Generated<number>;
  task_id: string;
  question_id: number;
  operation: string;
  target_lang: string | null;
  status: "pending" | "processing" | "succeeded" | "failed" | "skipped";
  error_message: string | null;
  started_at: Date | null;
  finished_at: Date | null;
  ai_request: any | null;          // AI è¯·æ±‚ä½“ï¼ˆJSONBï¼‰
  ai_response: any | null;          // AI å“åº”ï¼ˆJSONBï¼‰
  processed_data: any | null;       // å¤„ç†åè¦å…¥åº“çš„æ•°æ®ï¼ˆJSONBï¼‰
  created_at: Generated<Date>;
  updated_at: Generated<Date>;
}
```

#### 2.3 ä¿å­˜è°ƒè¯•æ•°æ®

**æ–‡ä»¶**: `src/app/api/admin/question-processing/_lib/batchProcessUtils.ts`  
**ä½ç½®**: ç¬¬ 2095-2143 è¡Œ

**å…³é”®ä»£ç **ï¼š
```typescript
// ğŸ“Š è·å– scene é…ç½®ï¼ˆåŒ…å« promptï¼‰ï¼Œç”¨äºè°ƒè¯•æ•°æ®
const sceneConfig = await getSceneConfig("question_full_pipeline", sourceLanguage);

// ... AI è°ƒç”¨ ...

// ğŸ“Š æ„é€ å®Œæ•´çš„ AI è¯·æ±‚å’Œå“åº”æ•°æ®ï¼ˆåŒ…å« promptï¼‰
const aiRequestDebug = {
  scene: "question_full_pipeline",
  sceneName: sceneConfig?.sceneName || "question_full_pipeline",
  prompt: sceneConfig?.prompt || "[æ— æ³•è·å– prompt]",
  question: input,  // æ ¼å¼åŒ–åçš„é¢˜ç›®æ–‡æœ¬
  questionPayload: aiQuestionPayload,  // é¢å¤–çš„é¢˜ç›®å…ƒæ•°æ®
  sourceLanguage,
  targetLanguage: targetLanguages[0] || sourceLanguage,
  locale: sourceLanguage,
  type,
  targetLanguages,  // æ‰€æœ‰ç›®æ ‡è¯­è¨€
  outputFormat: sceneConfig?.outputFormat || null,
};

const aiResponseDebug = {
  provider: aiProvider,
  answer: aiResp.answer,
  model: aiResp.model,
  duration: aiCallDuration,
};

// ğŸ“Š è°ƒç”¨å›è°ƒå‡½æ•°ä¿å­˜è°ƒè¯•æ•°æ®åˆ°æ•°æ®åº“
if (onProgress) {
  await onProgress(question.id, {
    aiRequest: aiRequestDebug,
    aiResponse: aiResponseDebug,
    processedData: processedDataDebug,
  });
}
```

**æ–‡ä»¶**: `src/app/api/admin/question-processing/batch-process/route.ts`  
**ä½ç½®**: ç¬¬ 784-838 è¡Œ

**å…³é”®ä»£ç **ï¼š
```typescript
const updateTaskItem = async (
  itemId: number | null,
  status: "processing" | "succeeded" | "failed" | "skipped",
  errorMessage?: string | null,
  debugData?: {
    aiRequest?: any;
    aiResponse?: any;
    processedData?: any;
  }
): Promise<void> => {
  // ...
  
  // ğŸ“Š ä¿å­˜è°ƒè¯•æ•°æ®
  if (debugData) {
    if (debugData.aiRequest !== undefined) {
      updateData.ai_request = JSON.stringify(debugData.aiRequest);
    }
    if (debugData.aiResponse !== undefined) {
      updateData.ai_response = JSON.stringify(debugData.aiResponse);
    }
    if (debugData.processedData !== undefined) {
      updateData.processed_data = JSON.stringify(debugData.processedData);
    }
  }
  
  await db
    .updateTable("question_processing_task_items")
    .set(updateData)
    .where("id", "=", itemId)
    .execute();
};
```

#### 2.4 API è¿”å›è°ƒè¯•æ•°æ®

**æ–‡ä»¶**: `src/app/api/admin/question-processing/tasks/[taskId]/items/route.ts`  
**ä½ç½®**: ç¬¬ 106-171 è¡Œ

**å…³é”®ä»£ç **ï¼š
```typescript
// ğŸ“Š è§£æè°ƒè¯•æ•°æ®ï¼ˆæ–°æ ¼å¼ï¼Œä»æ•°æ®åº“å­—æ®µè¯»å–ï¼‰
let aiRequest = null;
let aiResponse = null;
let processedData = null;

try {
  if (item.ai_request) {
    aiRequest = typeof item.ai_request === 'string' 
      ? JSON.parse(item.ai_request) 
      : item.ai_request;
  }
} catch (e) {
  console.error(`[API Task Items] Failed to parse ai_request for item ${item.id}`);
}

// ... ç±»ä¼¼å¤„ç† ai_response å’Œ processed_data ...

return {
  // ... å…¶ä»–å­—æ®µ
  aiRequest,
  aiResponse,
  processedData,
};
```

#### 2.5 å‰ç«¯å±•ç¤º

**æ–‡ä»¶**: `src/app/admin/question-processing/page.tsx`  
**ä½ç½®**: ç¬¬ 2421-2556 è¡Œ

**å…³é”®ä»£ç **ï¼š
```typescript
{/* ğŸ“Š æ–°æ ¼å¼ï¼šAI è¯·æ±‚ä½“ */}
{item.aiRequest && (
  <div>
    <h4 className="text-sm font-semibold text-gray-700 mb-2">ğŸ“¤ AI è¯·æ±‚ä½“ï¼ˆå®Œæ•´ï¼‰</h4>
    <div className="bg-white border rounded-lg p-4">
      <pre className="text-xs text-gray-900 bg-blue-50 border border-blue-200 rounded p-3 font-mono whitespace-pre-wrap max-h-96 overflow-y-auto">
        {JSON.stringify(item.aiRequest, null, 2)}
      </pre>
    </div>
  </div>
)}

{/* ğŸ“Š æ–°æ ¼å¼ï¼šAI å“åº” */}
{item.aiResponse && (
  <div>
    <h4 className="text-sm font-semibold text-gray-700 mb-2">ğŸ“¥ AI å“åº”ï¼ˆå®Œæ•´ï¼‰</h4>
    <div className="bg-white border rounded-lg p-4">
      <pre className="text-xs text-gray-900 bg-green-50 border border-green-200 rounded p-3 font-mono whitespace-pre-wrap max-h-96 overflow-y-auto">
        {JSON.stringify(item.aiResponse, null, 2)}
      </pre>
    </div>
  </div>
)}

{/* ğŸ“Š æ–°æ ¼å¼ï¼šæœ€ç»ˆå…¥åº“æ•°æ® */}
{item.processedData && (
  <div>
    <h4 className="text-sm font-semibold text-gray-700 mb-2">ğŸ’¾ æœ€ç»ˆå…¥åº“æ•°æ®</h4>
    <div className="bg-white border rounded-lg p-4">
      <pre className="text-xs text-gray-900 bg-purple-50 border border-purple-200 rounded p-3 font-mono whitespace-pre-wrap max-h-96 overflow-y-auto">
        {JSON.stringify(item.processedData, null, 2)}
      </pre>
    </div>
  </div>
)}
```

---

### æ­¥éª¤3ï¼šæºè¯­è¨€ explanation è¡¥å……é€»è¾‘ï¼ˆéƒ¨åˆ†å®ç°ï¼‰

#### 3.1 å½“å‰å®ç°

**æ–‡ä»¶**: `src/app/api/admin/question-processing/_lib/batchProcessUtils.ts`  
**ä½ç½®**: ç¬¬ 2224-2267 è¡Œ

**å…³é”®ä»£ç **ï¼š
```typescript
// âœ… å¤„ç†æºè¯­è¨€ explanationï¼šå¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰ï¼Œå¯ä»¥ä½¿ç”¨ AI è¿”å›çš„ï¼ˆä½†è¦æ ¡éªŒè¯­è¨€ï¼‰
let hasSourceExplanation = false;
if (typeof question.explanation === "string" && question.explanation.trim()) {
  hasSourceExplanation = true;
} else if (typeof question.explanation === "object" && question.explanation !== null) {
  hasSourceExplanation = !!question.explanation[sourceLanguage];
}

if (!hasSourceExplanation && sourceExplanation) {
  // æ•°æ®åº“ä¸­æ²¡æœ‰æºè¯­è¨€ explanationï¼Œå¯ä»¥ä½¿ç”¨ AI è¿”å›çš„ï¼ˆä½†è¦ä¸¥æ ¼æ ¡éªŒè¯­è¨€ï¼‰
  const isEn = isEnglishContent(sourceExplanation);
  const isZh = isChineseContent(sourceExplanation);

  let shouldUseSourceExplanation = false;

  if (sourceLanguage === "zh" && isZh && !isEn) {
    shouldUseSourceExplanation = true;
  } else if (sourceLanguage === "en" && isEn && !isZh) {
    shouldUseSourceExplanation = true;
  } else if (sourceLanguage !== "zh" && sourceLanguage !== "en") {
    // å…¶ä»–è¯­è¨€ï¼ˆjaç­‰ï¼‰æš‚æ—¶å…è®¸ï¼Œæ‰“å°è­¦å‘Š
    shouldUseSourceExplanation = true;
    console.debug(
      `[processFullPipelineBatch] [Q${question.id}] [DEBUG] æºè¯­è¨€ä¸º ${sourceLanguage}ï¼ŒAI è¿”å›çš„ explanation æœªè¿›è¡Œè¯­è¨€æ ¡éªŒ`,
    );
  } else {
    console.warn(
      `[processFullPipelineBatch] [Q${question.id}] âš ï¸ AI è¿”å›çš„ sourceExplanation è¯­è¨€ä¸åŒ¹é…ï¼ˆæœŸæœ›=${sourceLanguage}, isZh=${isZh}, isEn=${isEn}ï¼‰ï¼Œè·³è¿‡`,
    );
  }

  if (shouldUseSourceExplanation) {
    if (typeof question.explanation === "string") {
      question.explanation = { [sourceLanguage]: sourceExplanation };
    } else if (typeof question.explanation === "object" && question.explanation !== null) {
      question.explanation[sourceLanguage] = sourceExplanation;
    } else {
      question.explanation = { [sourceLanguage]: sourceExplanation };
    }
    console.debug(
      `[processFullPipelineBatch] [Q${question.id}] [DEBUG] æ•°æ®åº“ä¸­æ— æºè¯­è¨€ explanationï¼Œå·²ä½¿ç”¨ AI è¿”å›çš„ sourceExplanation`,
    );
  }
}
```

#### 3.2 é—®é¢˜åˆ†æ

**å½“å‰é—®é¢˜**ï¼š
- âŒ æ²¡æœ‰æ£€æŸ¥ AI è¿”å›çš„ `source.language` æ˜¯å¦æ­£ç¡®
- âŒ å¦‚æœ AI è¿”å›é”™è¯¯çš„ `source.language`ï¼Œ`source.explanation` ä¹Ÿä¼šæ˜¯é”™è¯¯çš„è¯­è¨€
- âŒ è¯­è¨€æ£€æµ‹å¯èƒ½å¤±è´¥ï¼Œå¯¼è‡´æ— æ³•ä½¿ç”¨

#### 3.3 æ”¹è¿›æ–¹æ¡ˆï¼ˆå¯é€‰ï¼‰

**æ–¹æ¡ˆ Aï¼šæ£€æŸ¥ source.language**ï¼ˆå·²å®ç°ä½†å·²å›é€€ï¼‰

```typescript
if (!hasSourceExplanation && sourceExplanation) {
  // ğŸ” æ£€æŸ¥ AI è¿”å›çš„ source.language æ˜¯å¦æ­£ç¡®
  const aiSourceLanguage = parsed.source?.language;
  const sourceLanguageMatches = aiSourceLanguage === sourceLanguage;

  if (!sourceLanguageMatches) {
    console.warn(`âš ï¸ AI è¿”å›çš„ source.language=${aiSourceLanguage} ä¸æœŸæœ›çš„ ${sourceLanguage} ä¸åŒ¹é…ï¼Œè·³è¿‡ä½¿ç”¨ source.explanation`);
  } else {
    // åŸæœ‰çš„è¯­è¨€æ£€æµ‹å’Œä½¿ç”¨é€»è¾‘
  }
}
```

**æ–¹æ¡ˆ Bï¼šä» translations ä¸­æå–**ï¼ˆä¸æ¨èï¼‰

```typescript
// å¦‚æœ source.explanation ä¸å¯ç”¨ï¼Œå°è¯•ä» translations.zh ä¸­æå–
if (!hasSourceExplanation && !shouldUseSourceExplanation) {
  const zhTranslation = sanitized.translations?.zh;
  if (zhTranslation?.explanation) {
    const zhExplanation = zhTranslation.explanation;
    const isZh = isChineseContent(zhExplanation);
    if (isZh) {
      question.explanation = { [sourceLanguage]: zhExplanation };
      console.debug(`[processFullPipelineBatch] [Q${question.id}] [DEBUG] ä» translations.zh ä¸­æå– explanation`);
    }
  }
}
```

**é—®é¢˜**ï¼šè¿™ä¼šè¿å"ä¸ä¿®æ”¹æºè¯­è¨€å†…å®¹"çš„åŸåˆ™ï¼Œå¯èƒ½å¯¼è‡´æºå†…å®¹è¢« AI éšæ„ä¿®æ”¹ã€‚

---

## ğŸ“Œ ç¬¬ä¸‰éƒ¨åˆ†ï¼šå…³é”®ä»£ç ä½ç½®æ±‡æ€»

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œå· | å…³é”®ä»£ç  |
|------|------|------|----------|
| æ—¥æ–‡è¯†åˆ«æ”¹è¿› | `batchProcessUtils.ts` | 296-322 | `hasHiragana`, `hasKatakana` æ£€æµ‹ |
| æºè¯­è¨€ explanation è¡¥å…… | `batchProcessUtils.ts` | 2224-2267 | `hasSourceExplanation` æ£€æŸ¥é€»è¾‘ |
| ç¿»è¯‘ä¿å­˜é€»è¾‘ | `batchProcessUtils.ts` | 2417-2572 | `translationsToSave` å¾ªç¯å¤„ç† |
| è°ƒè¯•æ•°æ®æ„é€  | `batchProcessUtils.ts` | 2117-2143 | `aiRequestDebug`, `aiResponseDebug` |
| è°ƒè¯•æ•°æ®ä¿å­˜ | `batch-process/route.ts` | 784-838 | `updateTaskItem` å‡½æ•° |
| è°ƒè¯•æ•°æ®è¿”å› | `tasks/[taskId]/items/route.ts` | 106-171 | JSON è§£æå’Œè¿”å› |
| å‰ç«¯å±•ç¤º | `page.tsx` | 2421-2556 | JSON æ ¼å¼åŒ–æ˜¾ç¤º |

---

## ğŸ“Œ ç¬¬å››éƒ¨åˆ†ï¼šæµ‹è¯•éªŒè¯

### 4.1 å•å…ƒæµ‹è¯•

#### æµ‹è¯•1ï¼šæ—¥æ–‡è¯†åˆ«

```typescript
describe('isChineseContent', () => {
  it('åº”è¯¥æ­£ç¡®è¯†åˆ«æ—¥æ–‡ï¼ˆåŒ…å«å‡åï¼‰', () => {
    const jaText = "å›³ä¸­ã®æ¨™è­˜ãŒå‰æ–¹å·¦æ›²ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ã€‚";
    expect(isChineseContent(jaText)).toBe(false);
  });

  it('åº”è¯¥æ­£ç¡®è¯†åˆ«ä¸­æ–‡', () => {
    const zhText = "å›¾ä¸­çš„æ ‡å¿—è¡¨ç¤ºå‰æ–¹å·¦è½¬ã€‚";
    expect(isChineseContent(zhText)).toBe(true);
  });
});
```

#### æµ‹è¯•2ï¼šæºè¯­è¨€ explanation è¡¥å……

```typescript
describe('processFullPipelineBatch', () => {
  it('åº”è¯¥ä½¿ç”¨ AI è¿”å›çš„ source.explanation è¡¥å……ç¼ºå¤±çš„ zh explanation', async () => {
    // Mock AI è¿”å›æ­£ç¡®çš„ source.language
    const mockAiResponse = {
      source: {
        language: "zh",
        explanation: "ä¸­æ–‡è§£é‡Š"
      }
    };
    
    // éªŒè¯ explanation è¢«æ­£ç¡®è¡¥å……
    expect(question.explanation.zh).toBe("ä¸­æ–‡è§£é‡Š");
  });
});
```

### 4.2 é›†æˆæµ‹è¯•

#### æµ‹è¯•åœºæ™¯1ï¼šfull_pipeline å®Œæ•´æµç¨‹

**è¾“å…¥**ï¼š
- é¢˜ç›® ID: 12
- æºè¯­è¨€: zh
- ç›®æ ‡è¯­è¨€: ja, en

**éªŒè¯ç‚¹**ï¼š
1. âœ… ja å†…å®¹æˆåŠŸå…¥åº“
2. âœ… ja explanation æˆåŠŸå…¥åº“
3. âœ… en å†…å®¹å’Œ explanation æˆåŠŸå…¥åº“
4. âš ï¸ zh explanation å¯èƒ½ç¼ºå¤±ï¼ˆå–å†³äº AI æ¨¡å‹ï¼‰

#### æµ‹è¯•åœºæ™¯2ï¼šè°ƒè¯•æ•°æ®ä¿å­˜

**éªŒè¯ç‚¹**ï¼š
1. âœ… `ai_request` å­—æ®µåŒ…å«å®Œæ•´çš„è¯·æ±‚ä½“ï¼ˆåŒ…æ‹¬ promptï¼‰
2. âœ… `ai_response` å­—æ®µåŒ…å«å®Œæ•´çš„å“åº”
3. âœ… `processed_data` å­—æ®µåŒ…å«æœ€ç»ˆå…¥åº“çš„æ•°æ®
4. âœ… å‰ç«¯å¯ä»¥æ­£ç¡®æ˜¾ç¤ºæ‰€æœ‰è°ƒè¯•æ•°æ®

---

## ğŸ“Œ ç¬¬äº”éƒ¨åˆ†ï¼šéƒ¨ç½²å’ŒéªŒè¯

### 5.1 æ•°æ®åº“è¿ç§»

**æ‰§è¡Œå‘½ä»¤**ï¼š
```bash
psql "$DATABASE_URL" < src/migrations/20250121_add_debug_fields_to_task_items.sql
```

**éªŒè¯**ï¼š
```sql
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'question_processing_task_items' 
  AND column_name IN ('ai_request', 'ai_response', 'processed_data');
```

### 5.2 ä»£ç éƒ¨ç½²

**éƒ¨ç½²æ­¥éª¤**ï¼š
1. ç¡®ä¿æ‰€æœ‰ä¿®æ”¹çš„æ–‡ä»¶å·²æäº¤
2. è¿è¡Œ TypeScript ç¼–è¯‘æ£€æŸ¥
3. è¿è¡Œ linter æ£€æŸ¥
4. éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
5. æ‰§è¡Œé›†æˆæµ‹è¯•

**éªŒè¯å‘½ä»¤**ï¼š
```bash
# TypeScript æ£€æŸ¥
npm run type-check

# Linter æ£€æŸ¥
npm run lint

# æµ‹è¯•
npm run test
```

### 5.3 åŠŸèƒ½éªŒè¯

**éªŒè¯æ­¥éª¤**ï¼š
1. åˆ›å»º full_pipeline ä»»åŠ¡ï¼ˆé¢˜ç›® 12ï¼Œzhâ†’ja,enï¼‰
2. ç­‰å¾…ä»»åŠ¡å®Œæˆ
3. æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…é¡µçš„è°ƒè¯•æ•°æ®
4. éªŒè¯æ•°æ®åº“ä¸­çš„æœ€ç»ˆæ•°æ®

**é¢„æœŸç»“æœ**ï¼š
- âœ… å¯ä»¥çœ‹åˆ°å®Œæ•´çš„ AI è¯·æ±‚ä½“ï¼ˆåŒ…æ‹¬ promptï¼‰
- âœ… å¯ä»¥çœ‹åˆ°å®Œæ•´çš„ AI å“åº”
- âœ… å¯ä»¥çœ‹åˆ°æœ€ç»ˆå…¥åº“çš„æ•°æ®
- âœ… ja å’Œ en çš„ç¿»è¯‘æˆåŠŸå…¥åº“
- âš ï¸ zh explanation å¯èƒ½ç¼ºå¤±ï¼ˆAI æ¨¡å‹é—®é¢˜ï¼‰

---

## ğŸ“Œ ç¬¬å…­éƒ¨åˆ†ï¼šæ€»ç»“

### 6.1 å·²å®ç°åŠŸèƒ½

1. âœ… **æ—¥æ–‡è¯†åˆ«æ”¹è¿›**ï¼šé€šè¿‡å‡åæ£€æµ‹å‡†ç¡®åŒºåˆ†ä¸­æ—¥æ–‡
2. âœ… **è°ƒè¯•æ•°æ®ä¿å­˜**ï¼šå®Œæ•´çš„ AI è¯·æ±‚ã€å“åº”å’Œå…¥åº“æ•°æ®
3. âœ… **å‰ç«¯å±•ç¤º**ï¼šä»»åŠ¡è¯¦æƒ…é¡µå±•ç¤ºå®Œæ•´çš„è°ƒè¯•ä¿¡æ¯

### 6.2 å¾…è§£å†³é—®é¢˜

1. âš ï¸ **zh explanation ç¼ºå¤±**ï¼šéœ€è¦åˆ‡æ¢åˆ°æ›´å¼ºå¤§çš„ AI æ¨¡å‹æˆ–ä½¿ç”¨ fill_missing æ“ä½œ

### 6.3 æŠ€æœ¯è¦ç‚¹

1. **Unicode èŒƒå›´**ï¼šå¹³å‡å U+3040-U+309Fï¼Œç‰‡å‡å U+30A0-U+30FF
2. **JSONB å­˜å‚¨**ï¼šè°ƒè¯•æ•°æ®ä»¥ JSON å­—ç¬¦ä¸²å½¢å¼å­˜å‚¨åœ¨ JSONB å­—æ®µä¸­
3. **å›è°ƒæ¨¡å¼**ï¼šä½¿ç”¨ `onProgress` å›è°ƒè§£è€¦æ•°æ®ä¿å­˜é€»è¾‘

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2025-11-21  
**å®ç°çŠ¶æ€**: éƒ¨åˆ†å®Œæˆï¼ˆja ç¿»è¯‘å’Œè°ƒè¯•æ•°æ®å·²å®ç°ï¼Œzh explanation å¾…è§£å†³ï¼‰

