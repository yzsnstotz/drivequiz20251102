# 未激活用户学习/考试被拦截，激活页缺少学生免费入口 · 诊断报告

- 日期：2025-12-11
- 提出人：系统巡检
- 相关需求：未激活用户应可访问学习/考试；仅 AI 功能需激活；激活页需展示“学生免费申请入口”。

## 问题概述
1) 登录但未激活的用户访问学习/考试页时被重定向到激活页，违背“非 AI 功能无需激活”的预期。
2) 激活页缺少“学生免费申请入口”引导，导致学生优惠通道不可见。

## 复现路径
- 问题1：
  1. 登录一个未激活账号。
  2. 打开 `/study/learn` 或 `/study/exam`。
  3. 页面被强制跳转到 `/activation`，无法进入学习/考试。
- 问题2：
  1. 打开 `/activation`。
  2. 页面只提供激活码表单和商务/购买联系方式，不存在“学生免费申请入口”或跳转链接。

## 现象与影响
- 现象：学习/考试等非 AI 功能被激活校验拦截；激活页缺少学生免费通道入口。
- 影响：
  - 普通学习/考试用户被阻断，必须输入激活码才能继续，业务漏斗受阻。
  - 学生免费申请入口不可见，影响学生权益及潜在转化。

## 证据与定位
- 全局激活强制跳转逻辑应用在学习/考试页：
```20:35:src/hooks/useRequireActivation.ts
  useEffect(() => {
    if (!pathname || pathname.startsWith("/activation")) return;
    if (sessionLoading || activationLoading) return;
    if (sessionStatus !== "authenticated") return;

    const isActivated = activationStatus?.valid === true;
    if (isActivated) return;

    const search = typeof window !== "undefined" ? window.location.search || "" : "";
    const from = `${pathname}${search}`;
    router.replace(`/activation?from=${encodeURIComponent(from)}`);
  }, [activationLoading, activationStatus?.valid, pathname, router, sessionLoading, sessionStatus]);
```
- 学习/考试页面均引用该 Hook，导致未激活即跳转：
```14:56:src/app/study/learn/page.tsx
import { useRequireActivation } from "@/hooks/useRequireActivation";
...
  useRequireActivation();
```
```18:58:src/app/study/exam/page.tsx
import { useRequireActivation } from "@/hooks/useRequireActivation";
...
  useRequireActivation();
```
- 激活页仅提供激活码表单与商务/购买联系方式，无学生入口：
```181:346:src/app/activation/page.tsx
<form onSubmit={handleSubmit}> ... </form>
... 联系方式 ...
... 管理员登录入口 ...
```
- 学生免费申请与状态页存在但未被引用：
```132:242:src/app/student/ai-apply/page.tsx
<h1 className="text-2xl font-bold mb-4">学生免费 AI 激活申请</h1>
...
<button ... onClick={() => router.push("/student/ai-status")}>查看状态</button>
```

## 初步根因分析
- 问题1：`useRequireActivation` 未区分业务域，直接在学习/考试页调用，导致所有未激活用户被重定向到激活页。预期应仅在 AI 功能（如 `/ai` 及 AI 对话相关页面）启用激活校验，或在 Hook 内按路由白名单/黑名单限制。
- 问题2：激活页缺少指向 `/student/ai-apply` / `/student/ai-status` 的入口组件，UI 未暴露学生免费申请通道。

## 日志信息
- 前端/服务端现有日志中未查询到相关报错记录，问题为前端逻辑/缺失入口导致。未追加新日志采集。

## 历史/已采取措施
- 本次仅完成问题确认与代码定位，未对服务或前端做任何改动；未执行数据库操作或配置变更。

## 影响评估
- 学习/考试核心流程对未激活用户不可用，阻断正常使用。
- 学生优惠入口缺失，阻塞符合条件用户的免费申请路径。

## 后续建议（供后续指令/计划使用）
- 调整激活校验适用范围：
  - 移除学习/考试页的 `useRequireActivation` 调用，或在 Hook 内仅针对 AI 路由执行跳转，确保非 AI 功能可用。
- 在 `/activation` 页面添加“学生免费申请入口”CTA，跳转到 `/student/ai-apply`（并附“查看状态”指向 `/student/ai-status`）。
- 完成改动后回归测试：
  - 未激活用户可正常进入学习/考试；
  - AI 功能仍需激活码；
  - 激活页可正常跳转至学生申请/状态页；
  - 登录/未登录态、不同语言下体验一致。
