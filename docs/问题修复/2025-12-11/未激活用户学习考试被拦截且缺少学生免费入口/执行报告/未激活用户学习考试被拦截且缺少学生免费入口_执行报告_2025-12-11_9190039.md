# 未激活用户学习考试被拦截且缺少学生免费入口 · 执行报告（上传 & 多语言 & 接口修复）

- 日期：2025-12-11
- 关联问题：未激活用户学习/考试被拦截、激活页缺少学生入口（含学生免费申请上传与接口 500 报错）
- 关联诊断：`docs/问题修复/2025-12-11/未激活用户学习考试被拦截且缺少学生免费入口/诊断报告/未激活用户学习考试被拦截且缺少学生免费入口_诊断报告.md`
- 当前基线提交：9190039（提交前 HEAD，用于报告追踪）

## 任务摘要
- 学生申请/状态页接入全局多语言（zh/en/ja），移除硬编码中文并支持占位符替换。
- 新增学生证明上传入口：前端支持 5MB 单文件限制、调用新上传 API，自动填充 admissionDocs。
- 新增 `/api/upload/student-doc`：校验登录与 5MB 限制，落盘存储文件并返回可访问 URL/metadata。
- 修复 `/api/student/verification` 500：严格字段校验、admissionDocs 结构校验、日期安全转换、已生效审核阻止重复申请，错误返回 4xx。

## 修改文件
- `src/app/student/ai-apply/page.tsx`
- `src/app/student/ai-status/page.tsx`
- `src/app/api/student/verification/route.ts`
- `src/app/api/upload/student-doc/route.ts`（新）
- `src/constants/studentDocs.ts`（新：统一上传限制与前缀）
- `src/lib/i18n.ts`

## 关键逻辑说明
- 多语言：使用 `useLanguage` + 自定义 `tr` 占位符替换，所有表单、提示、按钮文案均来自 i18n（含 zh/en/ja 译文）。
- 上传前端：新增隐藏 file input，点击“添加文件”触发；前端校验 5MB 超限直接提示；上传成功写入 `admissionDocs`（fileId/url/name），提交前阻止空列表。
- 上传后端：`/api/upload/student-doc` 强制登录与 5MB 校验，文件存储于 `student_docs/` 目录并保存 meta，返回 `fileId/url/name/size/contentType`，GET 支持读取文件（默认 inline）。
- 验证接口：`admissionDocs` 结构化校验（必须含 fileId/name），日期合法性校验，已批准且有效期内返回 409，所有业务校验返回 4xx，异常捕获记录日志。

## 测试
- `npm run lint`：通过（存在既有 Warning，多文件依赖数组 & <img> 使用等，未改动相关文件）。
- `npm run build`：通过（同上 Warning，已记录）。
- 手动/逻辑验证：
  - 多语言切换 zh/en/ja 时，申请/状态页文案与占位符均来自 i18n（含占位符替换）。
  - 申请页上传文件 <5MB：前端不过载提示；上传成功后 admissionDocs 自动填充 fileId/url/name。
  - 上传 >5MB：前端提示限制；后端接口也会返回 413/400 防绕过。
  - 提交申请时 admissionDocs 为空会拦截；服务端也校验并返回 400。
  - `/api/student/verification`：字段缺失/日期非法/已有效批准 → 返回 4xx 业务错误，不再 500；正常请求写入 normalized admission_docs。

## 红线自检（A1–E10，F1–F5）
- A1–A4：未改动路由层业务下沉结构；新增逻辑在 API/页面内，符合规范。
- B1–B4：无数据库结构变更；仅写入现有 jsonb 字段。
- C1–C3：非 AI 模块，无新增 AI 调用；双环境测试不适用。
- D1–D2：本报告已生成；红线遵守情况如上。
- E1–E8：新增上传/校验同时清理硬编码文案；未新增未引用代码；无额外请求冗余。
- E9：上传/校验仅在用户操作触发，无额外请求。
- F1–F5：未修改 ai-core/ai-service/local-ai-service，未绕过 ai-core。

## 风险与后续
- 上传存储当前写入本地目录 `student_docs/`，需确保部署环境具备持久化存储/合适挂载；若需云存储（S3/Supabase/R2 等），可替换存储适配层保持同样返回结构。
- 现有 lint Warning 与 admin/其它模块相关，未在本次范围内改动。
