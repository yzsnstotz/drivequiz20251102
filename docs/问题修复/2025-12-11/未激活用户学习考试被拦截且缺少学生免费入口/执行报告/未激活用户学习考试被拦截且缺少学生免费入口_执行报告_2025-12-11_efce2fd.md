# 未激活用户学习考试被拦截且缺少学生免费入口 · 执行报告

- 日期：2025-12-11
- 关联诊断：`docs/问题修复/2025-12-11/未激活用户学习考试被拦截且缺少学生免费入口/诊断报告/未激活用户学习考试被拦截且缺少学生免费入口_诊断报告.md`
- 提交哈希：efce2fd（创建报告时的基线 HEAD）

## 任务摘要
- 限定 `useRequireActivation` 仅保护 `/ai` 路由，避免未激活用户访问学习/考试被误拦截。
- 学习/考试页移除激活 Hook 依赖，消除结构误导。
- 在激活页增加“学生免费申请入口”与“查看申请状态”按钮，直达 `/student/ai-apply` 与 `/student/ai-status`。
- 新增多语言文案键 `activation.studentStatus`，保持中/英/日一致。

## 修改文件
- `src/hooks/useRequireActivation.ts`
- `src/app/study/learn/page.tsx`
- `src/app/study/exam/page.tsx`
- `src/app/activation/page.tsx`
- `src/lib/i18n.ts`

## 关键变更说明
- Hook 仅在 `/ai` 前缀命中时重定向未激活用户，非 AI 功能不会再被跳转。
- 学习/考试页去除激活 Hook 调用，页面仅要求登录态。
- 激活页新增学生免费申请区块与状态入口，复用现有路由与风格。
- 补充 i18n 键，避免多语言缺失。

## 测试结果
- 场景A 未激活访问 `/study/learn`、`/study/exam`：通过（不再跳转 /activation，页面可见）。
- 场景B 未激活访问 `/ai`：通过（仍跳转 /activation?from=/ai）。
- 场景C 激活页学生入口：通过（按钮可跳转 `/student/ai-apply`，状态按钮可达 `/student/ai-status`，申请页“查看状态”仍可用）。
- 场景D 已激活访问 `/ai`/学习/考试：通过（无额外跳转）。
- 构建/静态检查：`npm run lint`、`npm run build` 通过；存在若干既有 ESLint Warning（admin/登录等文件的依赖数组与 `<img>` 用法），本次未改动这些文件，仅记录。

## 红线自检（A1–E10，F1–F5）
- A1–A4：未改动路由层业务下沉逻辑；仅调整 Hook 与页面入口，符合架构约束。
- B1–B4：无数据库/字段/文件结构调整。
- C1–C3：任务非 AI 核心改动，无新增 AI 调用，未做双环境测试，标记不适用。
- D1–D2：执行报告已生成；红线遵守情况如上。
- E1–E10：增量最小；无旧逻辑堆叠，删除学习/考试页的 Hook 调用；无新增未引用代码；无额外请求。
- F1–F5：未修改 ai-core / ai-service / local-ai-service；未新增绕过 ai-core 的逻辑。

## 冗余检测
- 重复逻辑：未发现。
- 旧调用清理：学习/考试页激活 Hook 已移除。
- 未引用新增代码：无。
- 额外请求：无新增。

## 风险与后续
- 需关注其他非 `/ai` 路由如未来新建页面是否仍误用该 Hook；当前限定前缀可避免误伤。
- 如需更细粒度的 AI 路由列表，可扩展 `AI_PROTECTED_PREFIXES` 并统一评审。
