# 学生审核通过后未激活 & 申请不显示 - 诊断报告（2025-12-11）

## 问题概述
- 前台：学生审核“通过”后，账号仍显示未激活；此前提交的申请记录在前台看不到（后台可见）。
- 时间：2025-12-11（最新部署后出现）。

## 复现/现象
- 审核通过：后台可更新状态为 approved，但前台激活状态仍为未激活。
- 申请不可见：前台查询学生申请状态时看不到之前的申请，但后台列表存在记录。

## 已知上下文（代码与逻辑，仅诊断，不做改动）
- 统一权益入口：`src/lib/entitlements.ts`，`getUserEffectiveEntitlement` 逻辑为“激活码优先，学生 approved 且 valid_from/valid_until 覆盖当前则视为激活（plan=STUDENT_FREE）”。
- 学生权益读取：`getStudentBasedEntitlement`（`src/lib/studentVerification.ts`）查询条件：status='approved' 且 valid_from<=now 或 null，且 valid_until>=now，按 valid_until desc 取 1 条。
- 激活状态接口：`/api/activation/status` 已改为调用 `getUserEffectiveEntitlement`，返回 `valid: true/false` 及 source/plan/validFrom/validUntil。
- 前台激活上下文：`src/contexts/ActivationContext.tsx` 等，依赖 `/api/activation/status` 判断是否激活。若接口仍返回 valid=false，则前台显示未激活。
- 数据：`student_verifications` 表中后台能看到记录，说明写入存在；前台“申请不显示”可能因 GET `/api/student/verification` 未返回或状态不符合筛选。

## 潜在原因假设
1) 学生权益未命中有效期条件：valid_from/valid_until 未写入或时区/格式导致 now 判定不在区间；或 approved 记录不存在 valid_until → 认为无效。
2) 前台 session 用户 ID 与 student_verifications.user_id 不匹配：例如使用 userid vs id，或环境账户不同，导致查询不到。
3) `/api/activation/status` 未返回学生权益：可能是激活码路径提前返回 reasonCode，未进入学生兜底；或 userId 解析错误。
4) 前台状态查询接口 `/api/student/verification` 返回空：可能是状态过滤（pending/approved），或使用 userDbId/userId 不一致。
5) 近期 reviewer_id/UUID 修复不影响此问题，但需确认未对查询造成异常（如 transaction 失败导致写入未完成）。

## 已采取措施（本次对照）
- 本报告仅诊断，未修改代码。
- 复用已有诊断报告路径规范，新建目录与报告文件。

## 建议的进一步排查方向（供后续修复参考）
1) 数据核对：在 DB 中确认该用户的 `student_verifications` 最新记录：status、valid_from、valid_until、user_id；确认 now 是否在有效期内。
2) 接口验证：用同一账号调用 `/api/activation/status`，查看返回值的 source/plan/validUntil；若 valid=false，关注 reasonCode（是否 NO_ACTIVATION_CODE 而未继续学生兜底）。
3) 前台申请列表：调用 `/api/student/verification`，确认返回数据是否为空；若为空，检查查询条件（用户 ID 及状态过滤）。
4) 用户标识一致性：核对前台 session 的 userDbId / userId 与 student_verifications.user_id 是否匹配；若不匹配需调整查询用户 ID 选取策略。
5) 时间字段写入：确认后台审核通过时是否写入 valid_from/valid_until；若未写入 valid_until，当前逻辑会判定无效。

（按指令，本次仅输出诊断报告，不包含修复实现。）
