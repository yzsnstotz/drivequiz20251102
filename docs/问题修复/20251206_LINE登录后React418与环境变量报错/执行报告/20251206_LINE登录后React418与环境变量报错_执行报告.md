# ä¿®å¤æŒ‡ä»¤å¤´5.2ï¼ˆç°ç”¨ï¼‰å¯¹é½ä¸æ‰§è¡ŒæŠ¥å‘Š

## è§„èŒƒè¾¹ç•Œ
- ä»…ä¿®æ”¹ Next.js ä¸»æœåŠ¡ä»£ç ï¼›ä¸ä¿®æ”¹ `ai-core`/`ai-service`/`local-ai-service`ã€‚
- è·¯ç”±å±‚ä¿æŒç˜¦ï¼›ä¸šåŠ¡é€»è¾‘ä½äº lib/å°è£…ä¸ç»„ä»¶å±‚ï¼›layout è´Ÿè´£ç»Ÿä¸€ä¿æŠ¤ä¸å£³ç»“æ„ã€‚
- æœ€å°å˜æ›´ã€ç²¾å‡† patchï¼›ä¸å¼•å…¥ä¸æ•°æ®åº“ç»“æ„æ–‡æ¡£ä¸ä¸€è‡´çš„å­—æ®µï¼›Kysely ç±»å‹ä¿æŒä¸€è‡´ã€‚
- å®Œæˆåæ›´æ–°ç‰ˆæœ¬å· `src/lib/version.ts` çš„ `BUILD_TIME`ã€‚

## å·²é˜…è¯»æ–‡ä»¶
- `docs/ğŸ”§æŒ‡ä»¤æ¨¡ç‰ˆ/ä¿®å¤æŒ‡ä»¤å¤´5.2ï¼ˆç°ç”¨ï¼‰.md`
- `docs/æ¶æ„æ–‡æ¡£/AI_PROVIDER_CONFIG_FLOW.md`
- `src/lib/env.ts`ï¼ˆç¯å¢ƒå˜é‡ä¸ URL æ ¡éªŒé€»è¾‘ï¼‰
- `src/lib/auth.ts`ï¼ˆNextAuth é…ç½®ä¸ providers æ³¨å†Œï¼‰
- `src/lib/providers/line.ts`ï¼ˆLINE Provider å°è£…ï¼‰
- `src/contexts/LanguageContext.tsx`ï¼ˆè¯­è¨€ä¸Šä¸‹æ–‡ä¸å®¢æˆ·ç«¯è¯­è¨€åˆå§‹åŒ–ï¼‰
- æ•°æ®åº“ç»“æ„ï¼š`src/lib/db.ts`ã€`src/lib/dbConfig.ts`ï¼ˆç»“æ„ä¸é€‚é…å™¨ä½¿ç”¨ï¼Œæ— å­—æ®µå˜æ›´ï¼‰

## ç›®æ ‡ä¸ç»“æœ
- ä¿æŒ LINE ç™»å½•æˆåŠŸï¼›å½»åº•æ¶ˆé™¤ç™»å½•åå‡ºç°çš„ React #418 Hydration é”™è¯¯ã€‚
- ç§»é™¤â€œåœç•™ä¸€æ®µæ—¶é—´åè·³åˆ°ç¯å¢ƒå˜é‡é”™è¯¯é¡µé¢å¹¶é€€å‡ºç™»å½•â€çš„è§¦å‘ç‚¹ï¼ˆä¸ LINE env ç›¸å…³çš„ç¡¬æ£€æŸ¥ï¼‰ã€‚

## é—®é¢˜å®šä½
- React #418ï¼šHydration failed because the server rendered HTML didn't match the client.
- æ ¹å› ï¼šè¯­è¨€ä¸Šä¸‹æ–‡åœ¨ SSR åˆå§‹ä¸º `'en'`ï¼Œè€Œå®¢æˆ·ç«¯é¦–æ¬¡æ¸²æŸ“é€šè¿‡ `getClientLanguage()` å–æµè§ˆå™¨è¯­è¨€ï¼ˆå¦‚ `ja`ï¼‰ï¼Œå¯¼è‡´é¦–é¡µç­‰ Client Component åœ¨é¦–å¸§å‡ºç° SSR/CSR æ–‡æœ¬ä¸ä¸€è‡´ã€‚
- ç»„ä»¶å½±å“é¢ï¼šé¦–é¡µ `src/app/page.tsx` åŠæ‰€æœ‰ä¾èµ– `useLanguage()` çš„é¦–å¸§æ–‡æ¡ˆï¼Œå°¤å…¶ Navbar çš„å“ç‰Œæ–‡æ¡ˆä¸å„æŒ‰é’®æ–‡æ¡ˆã€‚
- ç¯å¢ƒå˜é‡æŠ¥é”™ï¼šLINE Provider ä¹‹å‰å­˜åœ¨åœ¨ `auth.ts` ä¾§ç›´æ¥è¯»å– env å¹¶å¯èƒ½æŠ›é”™çš„è·¯å¾„ï¼›æ­¤å¤– Provider æœªç»Ÿä¸€è½¯å¤±è´¥ç­–ç•¥ã€‚

## ä¿®å¤æªæ–½
1) Hydration ä¸€è‡´æ€§ä¿®å¤
- æ–‡ä»¶ï¼š`src/contexts/LanguageContext.tsx`
- æ”¹åŠ¨ï¼šå°† `useState(() => getClientLanguage())` æ”¹ä¸º `useState('en')`ï¼Œç¡®ä¿ SSR ä¸å®¢æˆ·ç«¯é¦–æ¬¡æ¸²æŸ“è¯­è¨€ä¸€è‡´ï¼›æŒ‚è½½åå†ç”¨ `useEffect` åŒæ­¥åˆ°çœŸå®å®¢æˆ·ç«¯è¯­è¨€ã€‚
- å½±å“ï¼šé¦–å¸§è‹±æ–‡ä¸ SSR ä¸€è‡´ï¼Œé¿å… #418ï¼›æŒ‚è½½åè¯­è¨€åˆ‡æ¢è‡³ç”¨æˆ·é€‰æ‹©ï¼Œæ— ä¸šåŠ¡é€»è¾‘å˜æ›´ã€‚

2) LINE Provider ç¯å¢ƒå˜é‡è½¯å¤±è´¥ä¸ç»Ÿä¸€æ³¨å…¥
- æ–‡ä»¶ï¼š`src/lib/providers/line.ts`
- æ”¹åŠ¨ï¼šé‡å†™ä¸º `createLineProvider()`ï¼›å…¼å®¹ `LINE_CLIENT_ID|SECRET` ä¸æ—§å `LINE_CHANNEL_ID|SECRET`ï¼›env ç¼ºå¤±ä»… `console.warn` å¹¶è¿”å› `null`ï¼Œä¸æŠ›å¼‚å¸¸ï¼›`checks: ['state']`ï¼›`authorization.params.scope: 'profile openid email'`ã€‚
- æ–‡ä»¶ï¼š`src/lib/auth.ts`
- æ”¹åŠ¨ï¼šé€šè¿‡ `const lineProvider = createLineProvider()` æ³¨å…¥ï¼š`...(lineProvider ? [lineProvider] : [])`ï¼›ç§»é™¤åœ¨ `auth.ts` ä¸­ç›´æ¥é…ç½® LINE Provider ä¸ env ç¡¬æ£€æŸ¥ã€‚

3) ç‰ˆæœ¬å·æ›´æ–°
- æ–‡ä»¶ï¼š`src/lib/version.ts`
- æ”¹åŠ¨ï¼š`BUILD_TIME = "2025-12-06 23:59:00"`ã€‚

## éªŒè¯
- devï¼š`npm run dev` å¤ç°è·¯å¾„ï¼ˆæœ¬åœ°æ¨¡æ‹Ÿï¼‰ï¼šLINE ç™»å½• â†’ é¦–é¡µï¼›æ—  React #418 Hydration æŠ¥é”™ï¼ˆè¯­è¨€é¦–å¸§ä¸€è‡´ï¼‰ã€‚
- prodï¼š`npm run build && npm run start` æ„å»ºä¸å¯åŠ¨æ£€æŸ¥ï¼šæœªå‡ºç° #418ï¼›è·¯ç”±ä¸ API æ­£å¸¸ã€‚
- ç¯å¢ƒå˜é‡ï¼šç¼ºå¤±æ—¶ä»… provider ä¸æ³¨å†Œï¼Œä¸å½±å“ NextAuth å…¨å±€è¿è¡Œï¼›`/api/auth/session` æ­£å¸¸è¿”å›ä¼šè¯ã€‚

## å˜æ›´æ–‡ä»¶åˆ—è¡¨
- `src/lib/providers/line.ts`ï¼šç»Ÿä¸€å°è£…ä¸è½¯å¤±è´¥
- `src/lib/auth.ts`ï¼šä½¿ç”¨å°è£…æ³¨å…¥ provider
- `src/contexts/LanguageContext.tsx`ï¼šè¯­è¨€é¦–å¸§ä¸€è‡´æ€§ä¿®å¤
- `src/lib/version.ts`ï¼šç‰ˆæœ¬å·æ›´æ–°

## ç»“è®º
- LINE ç™»å½•ä¿æŒæˆåŠŸï¼›æ¶ˆé™¤ React #418 Hydration é”™è¯¯ï¼›ç§»é™¤ä¸ LINE ç›¸å…³çš„ env ç¡¬æ£€æŸ¥å¯¼è‡´çš„è¿è¡Œæ—¶é”™è¯¯é€€å‡ºè·¯å¾„ã€‚

