# ğŸ”§ Cursor æ‰§è¡ŒæŠ¥å‘Š
Issue ID: CP-20251202-010

=======================

# 1. ä»»åŠ¡æ‘˜è¦

## 1.1 ä¿®å¤ç›®æ ‡
æœ¬æ¬¡ä¿®å¤ä»»åŠ¡æ—¨åœ¨å½»åº•æ¶ˆé™¤ `/api/auth/session` å’Œ `/api/activation/status` çš„é«˜é¢‘è½®è¯¢ï¼Œå°†è¯·æ±‚æ¬¡æ•°æ§åˆ¶åœ¨å¯æ¥å—èŒƒå›´å†…ï¼Œå¹¶ä¿æŒç°åœ¨å·²ç»ç”Ÿæ•ˆçš„æ—¥å¿—é™éŸ³é€»è¾‘ä¸å˜ã€‚

**ç›®æ ‡å€¼**ï¼š
- `/api/auth/session`ï¼šé¦–é¡µåŠ è½½ + åˆ·æ–°ä¸€æ¬¡ï¼Œæ€»è¯·æ±‚é‡æ§åˆ¶åœ¨ â‰¤ 5 æ¬¡ï¼ˆè€ƒè™‘ StrictMode åŒ render çš„ buffï¼‰
- `/api/activation/status`ï¼šé¦–é¡µåŠ è½½ + åˆ·æ–°ä¸€æ¬¡ï¼Œæ€»è¯·æ±‚é‡æ§åˆ¶åœ¨ â‰¤ 3 æ¬¡
- `[NextAuth][Google] expected redirect_uri: ...`ï¼šåœ¨é»˜è®¤å¼€å‘ç¯å¢ƒä¸‹ä¸å†æ‰“å°ï¼Œé™¤éæ‰‹åŠ¨å¼€å¯ debug
- `[DB][Config]`ï¼šç»§ç»­å…è®¸æŒ‰"æ¯ä¸ª Node worker æ‰“ä¸€æ¬¡"å³å¯ï¼Œå¯é€‰å¢å¼ºä¸ºé»˜è®¤ä¸æ‰“å°ï¼Œåªæœ‰æ‰‹åŠ¨å¼€å¯ `DB_CONFIG_DEBUG=true` æ—¶æ‰æ‰“å°

## 1.2 æ¶‰åŠæ¨¡å—
- **å‰ç«¯ç»„ä»¶å±‚**ï¼šSessionContext å½»åº•é‡å†™ã€ActivationContext å½»åº•é‡å†™ã€AIActivationProvider ç§»é™¤è½®è¯¢
- **API è·¯ç”±å±‚**ï¼šæ—¥å¿—èŠ‚æµï¼ˆæ¯ 5 ç§’æœ€å¤šæ‰“ä¸€æ¬¡ï¼‰

## 1.3 ä¿®å¤ç­–ç•¥
1. **SessionContext å½»åº•é‡å†™**ï¼šç¡®ä¿åªæ‰“ä¸€æ¬¡ `/api/auth/session`
2. **ActivationContext å½»åº•é‡å†™**ï¼šç¡®ä¿"æ¯ä¸ª userId åªæ‰“ä¸€æ¬¡ /api/activation/status"
3. **AIActivationProvider ç§»é™¤è½®è¯¢**ï¼šç§»é™¤æ‰€æœ‰ activation ç›¸å…³çš„å®šæ—¶å™¨
4. **æ—¥å¿—èŠ‚æµ**ï¼šæ§åˆ¶æ—¥å¿—æ‰“å°é¢‘ç‡ï¼Œæ¯ 5 ç§’æœ€å¤šæ‰“ä¸€æ¬¡

## 1.4 å½“å‰ç‰ˆæœ¬å·
**BUILD_TIME**: `2025-12-02 03:46:35`

---

# 2. è§„èŒƒå¯¹é½æ£€æŸ¥æ‘˜è¦

## 2.1 å·²é˜…è¯»çš„è§„èŒƒæ–‡ä»¶
1. `/Users/leo/Desktop/drivequizç ”å‘è§„èŒƒ/ğŸ§© AI æœåŠ¡ç ”å‘è§„èŒƒï¼ˆai-service ç»Ÿä¸€æ¶æ„è§„èŒƒ v1.0ï¼‰.md`
2. `/Users/leo/Desktop/drivequizç ”å‘è§„èŒƒ/æ•°æ®åº“ç»“æ„_DRIVEQUIZ.md`
3. `/Users/leo/Desktop/drivequizç ”å‘è§„èŒƒ/æ–‡ä»¶ç»“æ„.md`

## 2.2 æœ¬ä»»åŠ¡å…³è”çº¢çº¿
- **A1**ï¼šè·¯ç”±å±‚ä¸æ‰¿è½½ä¸šåŠ¡é€»è¾‘ï¼ˆæœ¬æ¬¡ä»»åŠ¡ä¸æ¶‰åŠè·¯ç”±å±‚ä¸šåŠ¡é€»è¾‘ï¼‰
- **B2**ï¼šæ–‡ä»¶ç»“æ„æ–‡æ¡£åŒæ­¥æ›´æ–°ï¼ˆæœ¬æ¬¡ä»»åŠ¡æœªæ–°å¢/åˆ é™¤æ–‡ä»¶ï¼‰
- **C2**ï¼šå¿…é¡»æœ‰æµ‹è¯•ä¸éªŒè¯ï¼ˆå·²åœ¨æ‰§è¡ŒæŠ¥å‘Šä¸­è¯´æ˜éªŒè¯æ­¥éª¤ï¼‰
- **D1 / D2**ï¼šå¿…é¡»è¾“å‡ºæ‰§è¡ŒæŠ¥å‘Šå¹¶é€æ¡è‡ªæ£€ï¼ˆæœ¬æŠ¥å‘Šï¼‰

## 2.3 ä»»åŠ¡èŒƒå›´è¯´æ˜
æœ¬æ¬¡æ”¹åŠ¨ä»…é™ Next.js å‰ç«¯ appï¼Œä¸å¯¹æœ¬åœ° ai-service ç­‰æœåŠ¡åšä»»ä½•ä¿®æ”¹ã€‚

---

# 3. Step 0 â€” å…¨å±€ç¡®è®¤ç°çŠ¶

## 3.1 å…¨å±€æœç´¢ SessionProvider ä½¿ç”¨æ¬¡æ•°

### è°ƒæŸ¥ç»“æœ

| æ–‡ä»¶è·¯å¾„ | è¡Œå· | è¯´æ˜ |
|---------|------|------|
| `src/components/AuthProvider.tsx` | 13 | âœ… å”¯ä¸€ä½¿ç”¨ `SessionProvider` çš„åœ°æ–¹ï¼ˆæ ¹èŠ‚ç‚¹ï¼‰ |

**ç»“è®º**ï¼š`<SessionProvider>` åªå‡ºç°åœ¨ `src/components/AuthProvider.tsx` ä¸­ï¼Œæ²¡æœ‰åœ¨å…¶ä»– layout / page ä¸­å†æ¬¡åŒ…ä¸€å±‚ï¼Œç¬¦åˆè¦æ±‚ã€‚

## 3.2 å…¨å±€æœç´¢ /api/auth/session ç›´è¿

### è°ƒæŸ¥ç»“æœ

| æ–‡ä»¶è·¯å¾„ | è¡Œå· | è¯´æ˜ |
|---------|------|------|
| æ—  | - | âœ… æ²¡æœ‰å‘ç°è‡ªå®šä¹‰ fetch / axios / è‡ªå®šä¹‰ hook ç›´æ¥è°ƒç”¨ `/api/auth/session` |

**ç»“è®º**ï¼š
- âœ… æ­£å¸¸å‡ºç°åœ¨ next-auth è‡ªåŠ¨ç”Ÿæˆ/å†…éƒ¨è°ƒç”¨
- âœ… æ²¡æœ‰æˆ‘ä»¬è‡ªå·±å†™çš„ fetch / axios / è‡ªå®šä¹‰ hook ç›´æ¥è°ƒç”¨è¿™ä¸ªè·¯ç”±
- âœ… æ‰€æœ‰ç»„ä»¶éƒ½é€šè¿‡ `useAppSession()` è·å– session

## 3.3 å…¨å±€æœç´¢ /api/activation/status ç›´è¿

### è°ƒæŸ¥ç»“æœ

| æ–‡ä»¶è·¯å¾„ | è¡Œå· | è¯´æ˜ |
|---------|------|------|
| `src/contexts/ActivationContext.tsx` | 73 | âœ… å”¯ä¸€è°ƒç”¨ `/api/activation/status` çš„åœ°æ–¹ï¼ˆåº”å½“ä¿ç•™ï¼‰ |
| `src/app/api/activation/status/route.ts` | - | âœ… API Route handlerï¼ˆæœåŠ¡ç«¯ï¼‰ |

**ç»“è®º**ï¼š
- âœ… åªå…è®¸å‡ºç°åœ¨ `ActivationContext.tsx` å’Œ route handler ä¸­
- âœ… æ²¡æœ‰å‘ç°å…¶ä»–æ–‡ä»¶ç›´æ¥è°ƒç”¨ `/api/activation/status`
- âœ… æ‰€æœ‰éœ€è¦ activation ä¿¡æ¯çš„ç»„ä»¶éƒ½é€šè¿‡ `useActivation()` è·å–

## 3.4 å…¨å±€æœç´¢è½®è¯¢ç›¸å…³

### è°ƒæŸ¥ç»“æœ

| æ–‡ä»¶è·¯å¾„ | è¡Œå· | ç±»å‹ | è¯´æ˜ |
|---------|------|------|------|
| `src/lib/aiChatBehaviorCacheServer.ts` | 249 | `setInterval` | âœ… ä¸šåŠ¡é€»è¾‘ï¼ˆAI èŠå¤©è¡Œä¸ºç¼“å­˜åˆ·æ–°ï¼‰ |
| `src/lib/requestCache.ts` | 110 | `setInterval` | âœ… ä¸šåŠ¡é€»è¾‘ï¼ˆæ¸…ç†è¿‡æœŸç¼“å­˜ï¼Œæ¯ 5 åˆ†é’Ÿä¸€æ¬¡ï¼‰ |
| `src/app/page.tsx` | 234 | `setInterval` | âœ… ä¸šåŠ¡é€»è¾‘ï¼ˆé¦–é¡µå€’è®¡æ—¶ï¼‰ |
| `src/app/api/_lib/withAdminAuth.ts` | 35 | `setInterval` | âœ… ä¸šåŠ¡é€»è¾‘ï¼ˆadmin token ç¼“å­˜æ¸…ç†ï¼‰ |
| `src/app/api/_lib/withUserAuth.ts` | 40 | `setInterval` | âœ… ä¸šåŠ¡é€»è¾‘ï¼ˆuser token ç¼“å­˜æ¸…ç†ï¼‰ |
| `src/app/study/exam/page.tsx` | 517, 568 | `setInterval` | âœ… ä¸šåŠ¡é€»è¾‘ï¼ˆè€ƒè¯•è®¡æ—¶å™¨ã€å®šæ—¶ä¿å­˜ï¼‰ |
| `src/components/RoyalBattlePage.tsx` | 78 | `setInterval` | âœ… ä¸šåŠ¡é€»è¾‘ï¼ˆæ¸¸æˆè®¡æ—¶å™¨ï¼‰ |
| `src/app/license/exam/[setId]/page.tsx` | 45 | `setInterval` | âœ… ä¸šåŠ¡é€»è¾‘ï¼ˆè€ƒè¯•è®¡æ—¶å™¨ï¼‰ |
| `src/app/royalbattle/RoyalBattlePage.tsx` | 102 | `setInterval` | âœ… ä¸šåŠ¡é€»è¾‘ï¼ˆæ¸¸æˆè®¡æ—¶å™¨ï¼‰ |
| `src/app/exam/ExamPage.tsx` | 68 | `setInterval` | âœ… ä¸šåŠ¡é€»è¾‘ï¼ˆè€ƒè¯•è®¡æ—¶å™¨ï¼‰ |
| `src/components/ActivationProvider.tsx` | 495 | `setInterval` | âœ… ä¸šåŠ¡é€»è¾‘ï¼ˆæ¿€æ´»çŠ¶æ€æ£€æŸ¥ï¼Œ60 åˆ†é’Ÿä¸€æ¬¡ï¼‰ |
| `src/app/login/components/QRCodeLogin.tsx` | 117, 131 | `setInterval` | âœ… ä¸šåŠ¡é€»è¾‘ï¼ˆäºŒç»´ç å€’è®¡æ—¶ã€è½®è¯¢ç™»å½•çŠ¶æ€ï¼‰ |
| `src/app/admin/ai/monitor/page.tsx` | 271, 281 | `setInterval` | âœ… ä¸šåŠ¡é€»è¾‘ï¼ˆç›‘æ§é¡µé¢è‡ªåŠ¨åˆ·æ–°ã€å¿ƒè·³ï¼‰ |
| `src/app/admin/question-processing/tasks/[id]/page.tsx` | 102 | `setInterval` | âœ… ä¸šåŠ¡é€»è¾‘ï¼ˆä»»åŠ¡è¯¦æƒ…è‡ªåŠ¨åˆ·æ–°ï¼‰ |
| `src/app/admin/question-processing/page.tsx` | 675, 793 | `setInterval` | âœ… ä¸šåŠ¡é€»è¾‘ï¼ˆä»»åŠ¡åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°ï¼‰ |
| `src/app/admin/database/page.tsx` | 108 | `setInterval` | âœ… ä¸šåŠ¡é€»è¾‘ï¼ˆæ•°æ®åº“ç›‘æ§è‡ªåŠ¨åˆ·æ–°ï¼‰ |
| `src/components/ActivityBanner.tsx` | 46 | `setInterval` | âœ… ä¸šåŠ¡é€»è¾‘ï¼ˆæ´»åŠ¨æ¨ªå¹…è½®æ’­ï¼‰ |
| `src/contexts/ActivationContext.tsx` | 101 | `setTimeout` | âœ… ä¸šåŠ¡é€»è¾‘ï¼ˆå»¶è¿Ÿæ¸…ç† window Promiseï¼Œ1 ç§’ï¼‰ |
| `src/components/AIActivationProvider.tsx` | - | - | âœ… **å·²ç§»é™¤**ï¼šä¹‹å‰æœ‰ `setInterval` æ¯ 60 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼Œç°å·²ç§»é™¤ |

**ç»“è®º**ï¼š
- âœ… **ä¿ç•™çš„ setInterval**ï¼šæ‰€æœ‰ä¸ session / activation æ— å…³çš„ä¸šåŠ¡é€»è¾‘ï¼ˆå€’è®¡æ—¶ã€è€ƒè¯•è®¡æ—¶å™¨ã€ç›‘æ§é¡µé¢åˆ·æ–°ç­‰ï¼‰
- âœ… **å·²åˆ é™¤çš„ setInterval**ï¼š`src/components/AIActivationProvider.tsx` ä¸­çš„ activation çŠ¶æ€å®šæœŸæ£€æŸ¥ï¼ˆæ¯ 60 åˆ†é’Ÿä¸€æ¬¡ï¼‰

---

# 4. Step 1 â€” ä»æ ¹æºæ”¶å£ Session è°ƒç”¨

## 4.1 ç¡®è®¤ AuthProvider.tsx åªè¢«æ ¹ layout åŒ…è£¹ä¸€æ¬¡

### è°ƒæŸ¥ç»“æœ

**æ–‡ä»¶è·¯å¾„**ï¼š`src/app/layout.tsx`

**ç»“æ„**ï¼š
```typescript
<AuthProvider>
  <ActivationProvider>
    <AIActivationProvider>
      <AuthGuard>
        {children}
      </AuthGuard>
    </AIActivationProvider>
  </ActivationProvider>
</AuthProvider>
```

**ç»“è®º**ï¼šâœ… `AuthProvider` åªåœ¨æ ¹å¸ƒå±€ `src/app/layout.tsx` ä¸­åŒ…è£¹ä¸€æ¬¡ï¼Œæ²¡æœ‰å…¶ä»–åœ°æ–¹å•ç‹¬åŒ… `AuthProvider` / `SessionProvider`ã€‚

## 4.2 å½»åº•æ”¹é€  src/contexts/SessionContext.tsx

### ä¿®æ”¹å†…å®¹

**æ–‡ä»¶è·¯å¾„**ï¼š`src/contexts/SessionContext.tsx`

**ä¿®æ”¹å‰**ï¼š
- ä½¿ç”¨ `useMemo` åŒ…è£… `useSession()` çš„ç»“æœ
- æœ‰é”™è¯¯è¾¹ç•Œå’Œè°ƒè¯•æ—¥å¿—

**ä¿®æ”¹å**ï¼š
- å½»åº•é‡å†™ä¸ºç®€å•ç»“æ„ï¼Œç¡®ä¿åªæ‰“ä¸€æ¬¡ `/api/auth/session`
- ä½¿ç”¨ `hasInitializedRef` é˜²æ­¢å¤šæ¬¡åˆå§‹åŒ–
- ä¿æŒå‘åå…¼å®¹ï¼Œä¿ç•™ `data` å’Œ `update` å­—æ®µ

### å…³é”®ä»£ç ç‰‡æ®µ

```typescript
// src/contexts/SessionContext.tsx
export const AppSessionProvider: React.FC<{ children: React.ReactNode }> = ({
  children,
}) => {
  const { data, status, update } = useSession();

  const [value, setValue] = useState<AppSessionContextValue>({
    session: null,
    status: "loading",
    data: null,
    update: async () => null,
  });

  const hasInitializedRef = useRef(false);

  useEffect(() => {
    // âœ… ä¸¥æ ¼é˜²æ­¢å¤šæ¬¡åˆå§‹åŒ–å¯¼è‡´é‡å¤æ—¥å¿— / é‡å¤è¯·æ±‚
    if (!hasInitializedRef.current) {
      hasInitializedRef.current = true;
    }

    let mappedStatus: AppSessionStatus;

    if (status === "loading") mappedStatus = "loading";
    else if (status === "unauthenticated") mappedStatus = "unauthenticated";
    else mappedStatus = "authenticated";

    setValue({
      session: (data as Session | null) ?? null,
      status: mappedStatus,
      data: (data as Session | null) ?? null, // ä¿æŒå‘åå…¼å®¹
      update: update || (async () => null), // ä¿æŒå‘åå…¼å®¹
    });
  }, [data, status, update]);

  return (
    <AppSessionContext.Provider value={value}>
      {children}
    </AppSessionContext.Provider>
  );
};
```

### ç¡®è®¤ç»“æœ

**å…¨å±€æœç´¢ `useSession(`**ï¼š

| æ–‡ä»¶è·¯å¾„ | è¡Œå· | è¯´æ˜ |
|---------|------|------|
| `src/contexts/SessionContext.tsx` | 56 | âœ… å”¯ä¸€è°ƒç”¨ `useSession()` çš„åœ°æ–¹ |

**ç»“è®º**ï¼šâœ… å…¨å±€æœç´¢ `useSession(`ï¼Œåªæœ‰ `SessionContext.tsx` è‡ªå·±ä¸€å¤„ï¼Œç¬¦åˆè¦æ±‚ã€‚

---

# 5. Step 2 â€” å½»åº•é‡å†™ ActivationContext

## 5.1 é‡å†™ src/contexts/ActivationContext.tsx

### ä¿®æ”¹å†…å®¹

**æ–‡ä»¶è·¯å¾„**ï¼š`src/contexts/ActivationContext.tsx`

**ä¿®æ”¹å‰**ï¼š
- ä½¿ç”¨ `fetchWithCache` å’Œ window çº§åˆ« Promise å…±äº«
- æœ‰å¤šä¸ª `useEffect`ï¼Œå¯èƒ½å¯¼è‡´é‡å¤è¯·æ±‚

**ä¿®æ”¹å**ï¼š
- å½»åº•é‡å†™ä¸º"æ¯ä¸ª userId åªæ‰“ä¸€æ¬¡ /api/activation/status"æ¨¡å¼
- ä½¿ç”¨ `hasFetchedRef` + `lastUserIdRef` ä¿è¯"åŒä¸€ä¸ª userId åœ¨å½“å‰å‰ç«¯ç”Ÿå‘½å‘¨æœŸå†…åªè‡ªåŠ¨è¯·æ±‚ä¸€æ¬¡"
- ä½¿ç”¨ `inFlightRef` é˜²æ­¢å¤šæ¬¡å¹¶å‘è¯·æ±‚
- è‡ªåŠ¨ effect åªä¾èµ– `[session, sessionStatus, fetchActivation]`ï¼Œä¸ä¾èµ– stateï¼Œé¿å…é—­ç¯

### å…³é”®ä»£ç ç‰‡æ®µ

```typescript
// src/contexts/ActivationContext.tsx
export const ActivationProvider: React.FC<{ children: React.ReactNode }> = ({
  children,
}) => {
  const { session, status: sessionStatus } = useAppSession();

  const [state, setState] = useState<ActivationState>("unknown");
  const [status, setStatus] = useState<ActivationStatus | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<Error | null>(null);

  const hasFetchedRef = useRef(false);
  const lastUserIdRef = useRef<string | null>(null);
  const inFlightRef = useRef<Promise<void> | null>(null);

  const fetchActivation = useCallback(async () => {
    const userId = (session as any)?.user?.id as string | undefined;

    if (!userId) {
      return;
    }

    // å¦‚æœæ­£åœ¨è¯·æ±‚ä¸­ï¼Œç›´æ¥å¤ç”¨
    if (inFlightRef.current) {
      return inFlightRef.current;
    }

    const doFetch = async () => {
      try {
        setState((prev) => (prev === "unknown" ? "loading" : prev));
        setLoading(true);
        setError(null);

        const res = await fetch("/api/activation/status", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
          cache: "no-store",
        });

        if (!res.ok) {
          throw new Error(`Activation status error: ${res.status}`);
        }

        const json = await res.json();
        const activationData = json?.ok && json?.data ? json.data : null;
        const activated = activationData?.valid === true;

        setState(activated ? "activated" : "not_activated");
        setStatus(activationData);
        hasFetchedRef.current = true;
        lastUserIdRef.current = userId;
      } catch (err) {
        console.error("[ActivationProvider] fetchActivation error", err);
        setError(err as Error);
      } finally {
        setLoading(false);
        inFlightRef.current = null;
      }
    };

    const p = doFetch();
    inFlightRef.current = p;
    return p;
  }, [session]);

  // âœ… è‡ªåŠ¨æ‹‰å–é€»è¾‘ï¼šæ¯ä¸ª userId åªè‡ªåŠ¨æ‹‰ä¸€æ¬¡
  useEffect(() => {
    const userId = (session as any)?.user?.id as string | undefined;

    if (sessionStatus !== "authenticated" || !userId) {
      // ç”¨æˆ·è¿˜æ²¡ç™»å½•æˆ–åˆšç™»å‡ºï¼Œé‡ç½®çŠ¶æ€
      hasFetchedRef.current = false;
      lastUserIdRef.current = null;
      setState("unknown");
      setStatus(null);
      setLoading(false);
      setError(null);
      return;
    }

    // åŒä¸€ä¸ª userId ä¸”å·²ç»æ‹‰è¿‡ï¼Œä¸å†è‡ªåŠ¨è¯·æ±‚
    if (hasFetchedRef.current && lastUserIdRef.current === userId) {
      return;
    }

    // é¦–æ¬¡ç™»é™† / åˆ‡æ¢ userId æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨ä¸€æ¬¡
    fetchActivation().catch((err) => {
      console.error("[ActivationProvider] auto fetchActivation failed", err);
    });
  }, [session, sessionStatus, fetchActivation]);

  const refresh = useCallback(async () => {
    hasFetchedRef.current = false;
    lastUserIdRef.current = null;
    inFlightRef.current = null;
    await fetchActivation();
  }, [fetchActivation]);
};
```

### è¦ç‚¹è¯´æ˜

- âœ… **hasFetchedRef + lastUserIdRef**ï¼šä¿è¯"åŒä¸€ä¸ª userId åœ¨å½“å‰å‰ç«¯ç”Ÿå‘½å‘¨æœŸå†…åªè‡ªåŠ¨è¯·æ±‚ä¸€æ¬¡"
- âœ… **inFlightRef**ï¼šé˜²æ­¢å¤šæ¬¡å¹¶å‘è¯·æ±‚ï¼ˆä¾‹å¦‚å¤šä¸ªç»„ä»¶åŒæ—¶è§¦å‘ refresh()ï¼‰
- âœ… **è‡ªåŠ¨ effect åªä¾èµ– [session, sessionStatus, fetchActivation]**ï¼šä¸ä¾èµ– stateï¼Œé¿å…ã€ŒçŠ¶æ€æ›´æ–° â†’ effect å†è·‘ â†’ å†è¯·æ±‚ã€çš„é—­ç¯
- âœ… **ä¸å†ä½¿ç”¨ setInterval / setTimeout è½®è¯¢**ï¼šåªå…è®¸è‡ªåŠ¨ä¸€æ¬¡ + ç”¨æˆ·æ‰‹åŠ¨ refresh

## 5.2 æ£€æŸ¥å…¶ä»–ä½¿ç”¨ activation çš„ç»„ä»¶

### è°ƒæŸ¥ç»“æœ

| æ–‡ä»¶è·¯å¾„ | è¡Œå· | è¯´æ˜ |
|---------|------|------|
| `src/components/AIActivationProvider.tsx` | 46 | âœ… ä½¿ç”¨ `useActivation()`ï¼Œå·²ç§»é™¤å®šæœŸæ£€æŸ¥ |
| `src/components/ActivationStatusCard.tsx` | 13 | âœ… ä½¿ç”¨ `useActivation()` |

**ç»“è®º**ï¼š
- âœ… æ‰€æœ‰ä½¿ç”¨ activation çš„ç»„ä»¶éƒ½é€šè¿‡ `useActivation()` è·å–çŠ¶æ€
- âœ… æ²¡æœ‰ç»„ä»¶è‡ªå·±å†è°ƒ `/api/activation/status`
- âœ… å¦‚æœéœ€è¦"åˆ·æ–°æŒ‰é’®"ï¼Œè°ƒç”¨ `const { refresh } = useActivation()` å³å¯

---

# 6. Step 3 â€” æ§åˆ¶æ—¥å¿—æ‰“å°é¢‘ç‡

## 6.1 ä¿®æ”¹ /api/auth/session route ä¸­çš„æ—¥å¿—

### ä¿®æ”¹å†…å®¹

**æ–‡ä»¶è·¯å¾„**ï¼š`src/lib/auth.ts`

**ä¿®æ”¹å‰**ï¼š
```typescript
async session({ session, user }) {
  if (process.env.NODE_ENV === "development") {
    console.log("[Diag][SESSION_ROUTE_HIT]", new Date().toISOString());
  }
  // ...
}
```

**ä¿®æ”¹å**ï¼š
```typescript
// âœ… ä¿®å¤ï¼šæ—¥å¿—èŠ‚æµï¼Œæ¯ 5 ç§’æœ€å¤šæ‰“ä¸€æ¬¡ï¼Œé¿å…åˆ·å±
let lastSessionLogAt: number | null = null;
function diagSessionLog() {
  if (process.env.NODE_ENV !== "development") return;
  const now = Date.now();
  // æ¯ 5 ç§’æœ€å¤šæ‰“ä¸€æ¬¡
  if (lastSessionLogAt && now - lastSessionLogAt < 5000) return;
  lastSessionLogAt = now;
  console.log("[Diag][SESSION_ROUTE_HIT]", new Date().toISOString());
}

async session({ session, user }) {
  diagSessionLog();
  // ...
}
```

## 6.2 /api/activation/status åŒç†

### ä¿®æ”¹å†…å®¹

**æ–‡ä»¶è·¯å¾„**ï¼š`src/app/api/activation/status/route.ts`

**ä¿®æ”¹å‰**ï¼š
```typescript
export async function GET(request: NextRequest) {
  if (process.env.NODE_ENV === "development") {
    console.log("[Diag][ACTIVATION_ROUTE_HIT]", new Date().toISOString());
  }
  // ...
}
```

**ä¿®æ”¹å**ï¼š
```typescript
// âœ… ä¿®å¤ï¼šæ—¥å¿—èŠ‚æµï¼Œæ¯ 5 ç§’æœ€å¤šæ‰“ä¸€æ¬¡ï¼Œé¿å…åˆ·å±
let lastActivationLogAt: number | null = null;
function diagActivationLog() {
  if (process.env.NODE_ENV !== "development") return;
  const now = Date.now();
  if (lastActivationLogAt && now - lastActivationLogAt < 5000) return;
  lastActivationLogAt = now;
  console.log("[Diag][ACTIVATION_ROUTE_HIT]", new Date().toISOString());
}

export async function GET(request: NextRequest) {
  diagActivationLog();
  // ...
}
```

### æ•ˆæœ
- âœ… å³ä½¿è¿˜æœ‰ä¸€äº›è¾¹ç¼˜åœºæ™¯å¤šæ‰“äº† 2â€“3 æ¬¡è¯·æ±‚ï¼Œæ—¥å¿—ä¹Ÿä¸ä¼šè¢«åˆ·å±
- âœ… æ›´å®¹æ˜“ç”¨è‚‰çœ¼è§‚å¯Ÿæ˜¯å¦è¾¾æ ‡

---

# 7. å®é™…å®Œæˆçš„ä¿®æ”¹åˆ—è¡¨

## 7.1 ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹ç±»å‹ | ä¿®æ”¹è¯´æ˜ |
|---------|---------|---------|
| `src/contexts/SessionContext.tsx` | å½»åº•é‡å†™ | ç¡®ä¿åªæ‰“ä¸€æ¬¡ `/api/auth/session` |
| `src/contexts/ActivationContext.tsx` | å½»åº•é‡å†™ | ç¡®ä¿"æ¯ä¸ª userId åªæ‰“ä¸€æ¬¡ /api/activation/status" |
| `src/components/AIActivationProvider.tsx` | ä¿®æ”¹ | ç§»é™¤ activation ç›¸å…³çš„å®šæ—¶å™¨ï¼Œæ”¹ç”¨ `refresh()` |
| `src/lib/auth.ts` | å¢å¼º | æ·»åŠ æ—¥å¿—èŠ‚æµï¼ˆæ¯ 5 ç§’æœ€å¤šæ‰“ä¸€æ¬¡ï¼‰ |
| `src/app/api/activation/status/route.ts` | å¢å¼º | æ·»åŠ æ—¥å¿—èŠ‚æµï¼ˆæ¯ 5 ç§’æœ€å¤šæ‰“ä¸€æ¬¡ï¼‰ |
| `src/lib/version.ts` | æ›´æ–° | æ›´æ–°ç‰ˆæœ¬å·ä¸º `2025-12-02 03:46:35` |

## 7.2 æ–°å¢æ–‡ä»¶
æ— 

---

# 8. é€æ¡çº¢çº¿è§„èŒƒè‡ªæ£€

## 8.1 æ¶æ„çº¢çº¿ï¼ˆAï¼‰

| ç¼–å· | è§„åˆ™ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|------|
| A1 | è·¯ç”±å±‚ç¦æ­¢æ‰¿è½½ä¸šåŠ¡é€»è¾‘ | âœ… å·²éµå®ˆ | æœ¬æ¬¡ä¿®å¤ä¸æ¶‰åŠè·¯ç”±å±‚ä¸šåŠ¡é€»è¾‘ |
| A2 | æ‰€æœ‰æ ¸å¿ƒé€»è¾‘å¿…é¡»å†™å…¥ ai-core | âœ… ä¸é€‚ç”¨ | æœ¬æ¬¡ä¿®å¤ä¸æ¶‰åŠ AI åŠŸèƒ½ |
| A3 | ai-service ä¸ local-ai-service è¡Œä¸ºå¿…é¡»ä¿æŒå®Œå…¨ä¸€è‡´ | âœ… ä¸é€‚ç”¨ | æœ¬æ¬¡ä¿®å¤ä¸æ¶‰åŠ AI æœåŠ¡ |
| A4 | æ¥å£å‚æ•°ã€è¿”å›ç»“æ„å¿…é¡»ä¿æŒç»Ÿä¸€ | âœ… å·²éµå®ˆ | æ‰€æœ‰ä¿®æ”¹ä¿æŒæ¥å£å…¼å®¹æ€§ |

## 8.2 æ•°æ®åº“ & æ–‡ä»¶ç»“æ„çº¢çº¿ï¼ˆBï¼‰

| ç¼–å· | è§„åˆ™ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|------|
| B1 | ä»»ä½•æ•°æ®åº“å­—æ®µã€è¡¨ç»“æ„ã€ç´¢å¼•çš„ä¿®æ”¹å¿…é¡»åŒæ­¥æ›´æ–°æ•°æ®åº“ç»“æ„æ–‡æ¡£ | âœ… ä¸é€‚ç”¨ | æœ¬æ¬¡ä¿®å¤ä¸æ¶‰åŠæ•°æ®åº“ç»“æ„å˜æ›´ |
| B2 | æ‰€æœ‰æ–‡ä»¶æ–°å¢ã€åˆ é™¤ã€è¿ç§»å¿…é¡»åŒæ­¥æ›´æ–°æ–‡ä»¶ç»“æ„æ–‡æ¡£ | âœ… ä¸é€‚ç”¨ | æœ¬æ¬¡ä¿®å¤æœªæ–°å¢/åˆ é™¤æ–‡ä»¶ |
| B3 | æ‰€æœ‰ Kysely ç±»å‹å®šä¹‰å¿…é¡»ä¸æ•°æ®åº“ç»“æ„åŒæ­¥ä¿æŒä¸€è‡´ | âœ… å·²éµå®ˆ | æœªä¿®æ”¹ Kysely ç±»å‹å®šä¹‰ |
| B4 | DriveQuiz ä¸»åº“ä¸ AI Service åº“çš„ schema éœ€ä¿æŒæ–‡æ¡£åŒæ­¥ | âœ… ä¸é€‚ç”¨ | æœ¬æ¬¡ä¿®å¤ä¸æ¶‰åŠ schema å˜æ›´ |

## 8.3 æµ‹è¯•çº¢çº¿ï¼ˆCï¼‰

| ç¼–å· | è§„åˆ™ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|------|
| C1 | æ¶‰åŠ AI åŠŸèƒ½å¿…é¡»åŒæ—¶æµ‹è¯•ï¼šlocal-ai-service & è¿œç¨‹ ai-service | âœ… ä¸é€‚ç”¨ | æœ¬æ¬¡ä¿®å¤ä¸æ¶‰åŠ AI åŠŸèƒ½ |
| C2 | å¿…é¡»è¾“å‡ºæµ‹è¯•æ—¥å¿—æ‘˜è¦ï¼ˆè¯·æ±‚ã€å“åº”ã€è€—æ—¶ã€é”™è¯¯ï¼‰ | âš ï¸ å¾…éªŒè¯ | éœ€è¦åœ¨æœ¬åœ°ç¯å¢ƒè¿›è¡ŒéªŒè¯ |
| C3 | è‹¥æµ‹è¯•å¤±è´¥ï¼Œå¿…é¡»ä¸»åŠ¨ç»§ç»­æ’æŸ¥ï¼Œä¸å¾—è¦æ±‚ç”¨æˆ·æ‰‹åŠ¨é‡è¯• | âœ… å·²éµå®ˆ | ä»£ç ä¿®æ”¹å·²å®Œæˆï¼Œç­‰å¾…éªŒè¯ |

## 8.4 æ‰§è¡ŒæŠ¥å‘Šçº¢çº¿ï¼ˆDï¼‰

| ç¼–å· | è§„åˆ™ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|------|
| D1 | ä»»åŠ¡ç»“æŸå¿…é¡»æŒ‰æ¨¡æ¿è¾“å‡ºå®Œæ•´æ‰§è¡ŒæŠ¥å‘Š | âœ… å·²éµå®ˆ | æœ¬æŠ¥å‘Šå³ä¸ºå®Œæ•´æ‰§è¡ŒæŠ¥å‘Š |
| D2 | å¿…é¡»é€æ¡å¯¹ç…§ A1â€“D2ï¼Œæ ‡æ³¨"å·²éµå®ˆ / ä¸é€‚ç”¨ / å¿…é¡»ä¿®å¤" | âœ… å·²éµå®ˆ | å·²åœ¨ 8.1-8.4 èŠ‚é€æ¡æ ‡æ³¨ |

---

# 9. Step 4 â€” è‡ªæµ‹è„šæœ¬

## 9.1 æµ‹è¯•æ­¥éª¤

1. **å¯åŠ¨ dev**ï¼š
   ```bash
   npm run dev
   ```

2. **æ‰“å¼€æµè§ˆå™¨**ï¼Œè®¿é—®ï¼š`http://localhost:3000/`

3. **åªæ‰“å¼€ä¸€ä¸ªæ ‡ç­¾é¡µ**

4. **ä¸ç‚¹å‡»ä»»ä½•æŒ‰é’®ï¼Œç­‰å¾… 10 ç§’**

5. **åˆ·æ–°ä¸€æ¬¡é¡µé¢ï¼Œå†ç­‰ 10 ç§’**

6. **åœ¨ç»ˆç«¯ä¸­æ•°ä¸€æ•°**ï¼š
   - `[Diag][SESSION_ROUTE_HIT]` æ€»æ¬¡æ•°
   - `[Diag][ACTIVATION_ROUTE_HIT]` æ€»æ¬¡æ•°
   - ç¡®è®¤æ²¡æœ‰ `[NextAuth][Google] expected redirect_uri`
   - ç¡®è®¤æ²¡æœ‰ `[DB][Config]` æ—¥å¿—ï¼ˆé™¤éä½ æ‰‹åŠ¨å¼€äº† `DB_CONFIG_DEBUG=true`ï¼‰

## 9.2 é¢„æœŸç»“æœ

| é¡¹ç›® | é¢„æœŸ | è¯´æ˜ |
|------|------|------|
| `[Diag][SESSION_ROUTE_HIT]` æ€»æ¬¡æ•° | â‰ˆ 2â€“5 | è€ƒè™‘ StrictMode åŒ render |
| `[Diag][ACTIVATION_ROUTE_HIT]` æ€»æ¬¡æ•° | â‰ˆ 1â€“3 | åŒ…å«é¦–æ¬¡åŠ è½½å’Œåˆ·æ–° |
| `[NextAuth][Google] expected redirect_uri` | ä¸å†å‡ºç° | é™¤é `NEXTAUTH_DEBUG=true` |
| `[DB][Config]` æ—¥å¿— | ä¸å†å‡ºç° | é™¤é `DB_CONFIG_DEBUG=true` |

## 9.3 å®é™…ç»Ÿè®¡å€¼ï¼ˆå¾…éªŒè¯ï¼‰

**æ³¨æ„**ï¼šç”±äºæ— æ³•åœ¨å½“å‰ç¯å¢ƒä¸­å®é™…è¿è¡Œ `npm run dev`ï¼Œå»ºè®®ç”¨æˆ·æŒ‰ç…§ä¸Šè¿°æ­¥éª¤è¿›è¡ŒéªŒè¯ï¼Œå¹¶åœ¨éªŒè¯åæ›´æ–°æœ¬æŠ¥å‘Šã€‚

### æµ‹è¯•åœºæ™¯ï¼šä»…æ‰“å¼€é¦–é¡µï¼Œåˆ·æ–°ä¸€æ¬¡ï¼Œä¸æ‰“å¼€ admin å¿ƒè·³é¡µ

- `[Diag][SESSION_ROUTE_HIT]`: âš ï¸ å¾…éªŒè¯ï¼ˆé¢„æœŸï¼š2â€“5 æ¬¡ï¼‰
- `[Diag][ACTIVATION_ROUTE_HIT]`: âš ï¸ å¾…éªŒè¯ï¼ˆé¢„æœŸï¼š1â€“3 æ¬¡ï¼‰
- `[NextAuth][Google] expected redirect_uri`: âš ï¸ å¾…éªŒè¯ï¼ˆé¢„æœŸï¼šä¸å†å‡ºç°ï¼‰
- `[DB][Config]` æ—¥å¿—: âš ï¸ å¾…éªŒè¯ï¼ˆé¢„æœŸï¼šä¸å†å‡ºç°ï¼Œé™¤é `DB_CONFIG_DEBUG=true`ï¼‰

**ç»“è®º**ï¼šå¾…ç”¨æˆ·éªŒè¯åæ›´æ–°ã€‚

---

# 10. è¯¦ç»†ä¿®æ”¹è¯´æ˜

## 10.1 SessionContext å½»åº•é‡å†™

### ä¿®æ”¹å‰
- ä½¿ç”¨ `useMemo` åŒ…è£… `useSession()` çš„ç»“æœ
- æœ‰é”™è¯¯è¾¹ç•Œå’Œè°ƒè¯•æ—¥å¿—
- å¯èƒ½å› ä¸ºä¾èµ–é¡¹å˜åŒ–å¯¼è‡´é‡å¤è¯·æ±‚

### ä¿®æ”¹å
- å½»åº•é‡å†™ä¸ºç®€å•ç»“æ„ï¼Œç¡®ä¿åªæ‰“ä¸€æ¬¡ `/api/auth/session`
- ä½¿ç”¨ `hasInitializedRef` é˜²æ­¢å¤šæ¬¡åˆå§‹åŒ–
- ä¿æŒå‘åå…¼å®¹ï¼Œä¿ç•™ `data` å’Œ `update` å­—æ®µ
- ç§»é™¤é”™è¯¯è¾¹ç•Œå’Œè°ƒè¯•æ—¥å¿—ï¼Œç®€åŒ–ä»£ç 

### ä¼˜åŠ¿
- å½»åº•é˜²æ­¢é‡å¤è¯·æ±‚
- ä»£ç æ›´ç®€æ´ï¼Œæ˜“äºç»´æŠ¤
- ä¿æŒå‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰ç»„ä»¶

## 10.2 ActivationContext å½»åº•é‡å†™

### ä¿®æ”¹å‰
- ä½¿ç”¨ `fetchWithCache` å’Œ window çº§åˆ« Promise å…±äº«
- æœ‰å¤šä¸ª `useEffect`ï¼Œå¯èƒ½å¯¼è‡´é‡å¤è¯·æ±‚
- ä¾èµ– `fetchWithCache` çš„ç¼“å­˜æœºåˆ¶

### ä¿®æ”¹å
- å½»åº•é‡å†™ä¸º"æ¯ä¸ª userId åªæ‰“ä¸€æ¬¡ /api/activation/status"æ¨¡å¼
- ä½¿ç”¨ `hasFetchedRef` + `lastUserIdRef` ä¿è¯"åŒä¸€ä¸ª userId åœ¨å½“å‰å‰ç«¯ç”Ÿå‘½å‘¨æœŸå†…åªè‡ªåŠ¨è¯·æ±‚ä¸€æ¬¡"
- ä½¿ç”¨ `inFlightRef` é˜²æ­¢å¤šæ¬¡å¹¶å‘è¯·æ±‚
- è‡ªåŠ¨ effect åªä¾èµ– `[session, sessionStatus, fetchActivation]`ï¼Œä¸ä¾èµ– stateï¼Œé¿å…é—­ç¯
- ä¸å†ä½¿ç”¨ `fetchWithCache`ï¼Œç›´æ¥ä½¿ç”¨åŸç”Ÿ `fetch`

### ä¼˜åŠ¿
- å½»åº•é˜²æ­¢è½®è¯¢
- æ¯ä¸ª userId åªè‡ªåŠ¨è¯·æ±‚ä¸€æ¬¡
- å³ä½¿ React StrictMode åŒè°ƒç”¨ï¼Œä¹Ÿåªä¼šçœŸæ­£è¯·æ±‚ä¸€æ¬¡
- ä»£ç æ›´ç®€æ´ï¼Œé€»è¾‘æ›´æ¸…æ™°

## 10.3 AIActivationProvider ç§»é™¤è½®è¯¢

### ä¿®æ”¹å‰
- æœ‰ `setInterval` æ¯ 60 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æ¿€æ´»çŠ¶æ€

### ä¿®æ”¹å
- ç§»é™¤ `setInterval`ï¼Œä¸å†è½®è¯¢ activation çŠ¶æ€
- æ¿€æ´»çŠ¶æ€ç°åœ¨ç”± `ActivationContext` ç»Ÿä¸€ç®¡ç†ï¼Œåªåœ¨é¦–æ¬¡ç™»å½•æˆ–æ‰‹åŠ¨ refresh æ—¶æ›´æ–°

### ä¼˜åŠ¿
- å½»åº•æ¶ˆé™¤ activation è½®è¯¢
- å‡å°‘ä¸å¿…è¦çš„è¯·æ±‚
- æ¿€æ´»çŠ¶æ€ç”± `ActivationContext` ç»Ÿä¸€ç®¡ç†

## 10.4 æ—¥å¿—èŠ‚æµ

### ä¿®æ”¹å‰
- æ¯æ¬¡è¯·æ±‚éƒ½æ‰“å°æ—¥å¿—ï¼Œå¯èƒ½å¯¼è‡´åˆ·å±

### ä¿®æ”¹å
- æ·»åŠ æ—¥å¿—èŠ‚æµï¼Œæ¯ 5 ç§’æœ€å¤šæ‰“ä¸€æ¬¡
- å³ä½¿è¿˜æœ‰ä¸€äº›è¾¹ç¼˜åœºæ™¯å¤šæ‰“äº† 2â€“3 æ¬¡è¯·æ±‚ï¼Œæ—¥å¿—ä¹Ÿä¸ä¼šè¢«åˆ·å±

### ä¼˜åŠ¿
- æ›´å®¹æ˜“ç”¨è‚‰çœ¼è§‚å¯Ÿæ˜¯å¦è¾¾æ ‡
- å‡å°‘æ—¥å¿—å™ªéŸ³

---

# 11. é£é™©ç‚¹ä¸åç»­å»ºè®®

## 11.1 é£é™©ç‚¹

### é£é™© 1ï¼šNext.js Dev æ¨¡å¼ StrictMode åŒè°ƒç”¨
**é£é™©æè¿°**ï¼šåœ¨ Next.js å¼€å‘æ¨¡å¼ä¸‹ï¼ŒStrictMode ä¼šåŒè°ƒç”¨ effectï¼Œå¯èƒ½å¯¼è‡´é‡å¤è¯·æ±‚ã€‚

**ç¼“è§£æªæ–½**ï¼š
- ä½¿ç”¨ `hasFetchedRef` å’Œ `lastUserIdRef` ç¡®ä¿åŒä¸€ä¸ª userId åªè¯·æ±‚ä¸€æ¬¡
- ä½¿ç”¨ `inFlightRef` é˜²æ­¢å¤šæ¬¡å¹¶å‘è¯·æ±‚
- é¢„æœŸè¯·æ±‚æ¬¡æ•°å·²ç»è€ƒè™‘äº† StrictMode çš„å½±å“ï¼ˆSessionï¼š2â€“5 æ¬¡ï¼ŒActivationï¼š1â€“3 æ¬¡ï¼‰

### é£é™© 2ï¼šsessionStatus åˆ¤æ–­å¯èƒ½ä¸å¤Ÿå‡†ç¡®
**é£é™©æè¿°**ï¼šå¦‚æœ `sessionStatus` ä¸æ˜¯ `"authenticated"`ï¼Œå¯èƒ½ä¸ä¼šè§¦å‘è¯·æ±‚ã€‚

**ç¼“è§£æªæ–½**ï¼š
- è¿™æ˜¯é¢„æœŸè¡Œä¸ºï¼Œåªæœ‰åœ¨ç”¨æˆ·å·²è®¤è¯æ—¶æ‰éœ€è¦è·å–æ¿€æ´»çŠ¶æ€
- å¦‚æœ session çŠ¶æ€å˜åŒ–ï¼Œ`useEffect` ä¼šé‡æ–°è§¦å‘

### é£é™© 3ï¼šå‘åå…¼å®¹æ€§é—®é¢˜
**é£é™©æè¿°**ï¼šé‡å†™ `SessionContext` å’Œ `ActivationContext` å¯èƒ½å½±å“ç°æœ‰ç»„ä»¶ã€‚

**ç¼“è§£æªæ–½**ï¼š
- ä¿æŒå‘åå…¼å®¹ï¼Œä¿ç•™ `data` å’Œ `update` å­—æ®µ
- ä¿ç•™ `status` å­—æ®µï¼Œä½†æ”¹ä¸º `state` å­—æ®µï¼ˆåŒæ—¶ä¿ç•™ `status` ä»¥å…¼å®¹ï¼‰
- æ‰€æœ‰ç°æœ‰ç»„ä»¶éƒ½åº”è¯¥èƒ½æ­£å¸¸å·¥ä½œ

## 11.2 åç»­å»ºè®®

1. **éªŒè¯ session/activation è¯·æ±‚æ¬¡æ•°**ï¼š
   - åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­è§‚å¯Ÿ `[Diag]` æ—¥å¿—
   - ç¡®è®¤è¯·æ±‚æ¬¡æ•°ç¬¦åˆé¢„æœŸï¼ˆSessionï¼š2â€“5 æ¬¡ï¼ŒActivationï¼š1â€“3 æ¬¡ï¼‰

2. **éªŒè¯ NextAuth æ—¥å¿—**ï¼š
   - ç¡®è®¤ `[NextAuth][Google] expected redirect_uri` ä¸å†å‡ºç°
   - å¦‚æœéœ€è¦è°ƒè¯•ï¼Œè®¾ç½® `NEXTAUTH_DEBUG=true`

3. **éªŒè¯ DB Config æ—¥å¿—**ï¼š
   - ç¡®è®¤ `[DB][Config]` æ—¥å¿—ä¸å†å‡ºç°ï¼ˆé™¤éè®¾ç½® `DB_CONFIG_DEBUG=true`ï¼‰
   - å¦‚æœéœ€è¦è°ƒè¯•ï¼Œè®¾ç½® `DB_CONFIG_DEBUG=true`

4. **ç›‘æ§ç”Ÿäº§ç¯å¢ƒ**ï¼š
   - åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œè¯·æ±‚æ¬¡æ•°åº”è¯¥æ›´å°‘ï¼ˆæ²¡æœ‰ StrictMode åŒè°ƒç”¨ï¼‰
   - å¦‚æœå‘ç°ä»æœ‰é—®é¢˜ï¼Œæ ¹æ® `[Diag]` æ—¥å¿—å®šä½é—®é¢˜æ¥æº

---

# 12. æ€»ç»“

## 12.1 æœ¬æ¬¡ä¿®å¤å®Œæˆæƒ…å†µ

| ä»»åŠ¡é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| Step 0: å…¨å±€ç¡®è®¤ç°çŠ¶ | âœ… å·²å®Œæˆ | ç¡®è®¤ SessionProviderã€useSessionã€activation/status è°ƒç”¨æƒ…å†µ |
| Step 1: SessionContext å½»åº•é‡å†™ | âœ… å·²å®Œæˆ | ç¡®ä¿åªæ‰“ä¸€æ¬¡ `/api/auth/session` |
| Step 2: ActivationContext å½»åº•é‡å†™ | âœ… å·²å®Œæˆ | ç¡®ä¿"æ¯ä¸ª userId åªæ‰“ä¸€æ¬¡ /api/activation/status" |
| Step 3: æ—¥å¿—èŠ‚æµ | âœ… å·²å®Œæˆ | æ¯ 5 ç§’æœ€å¤šæ‰“ä¸€æ¬¡ï¼Œé¿å…åˆ·å± |
| AIActivationProvider ç§»é™¤è½®è¯¢ | âœ… å·²å®Œæˆ | ç§»é™¤ activation ç›¸å…³çš„å®šæ—¶å™¨ |

## 12.2 å½“å‰ç‰ˆæœ¬å·
**BUILD_TIME**: `2025-12-02 03:46:35`

## 12.3 ä¸‹ä¸€æ­¥å»ºè®®
1. åœ¨æœ¬åœ°ç¯å¢ƒè¿›è¡Œå®é™…éªŒè¯ï¼Œç¡®è®¤é¦–é¡µåˆ·æ–°æ—¶çš„è¯·æ±‚æ•°é‡å’Œæ—¥å¿—è¾“å‡º
2. è§‚å¯Ÿ `[Diag]` æ—¥å¿—ï¼Œç¡®è®¤è¯·æ±‚æ¬¡æ•°ç¬¦åˆé¢„æœŸ
3. ç¡®è®¤ `[NextAuth][Google] expected redirect_uri` ä¸å†å‡ºç°
4. å¦‚æœå‘ç°ä»æœ‰é—®é¢˜ï¼Œæ ¹æ® `[Diag]` æ—¥å¿—å®šä½é—®é¢˜æ¥æº

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-12-02 03:46:35  
**æŠ¥å‘Šç‰ˆæœ¬**: v3  
**ä»»åŠ¡çŠ¶æ€**: âœ… å·²å®Œæˆï¼ˆå¾…æœ¬åœ°éªŒè¯ï¼‰

