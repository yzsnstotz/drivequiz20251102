# 修复前台商户页面多语言字段显示问题_执行报告

**报告日期**: 2025-11-29  
**任务名称**: 修复前台商户页面多语言字段显示问题  
**版本号**: 2025-11-29 11:59:59

---

## 📌 任务摘要

修复前台商户页面（`/nearby`）无法显示已创建商户的问题。问题原因是在数据库中，商户的 `name`、`description`、`address` 字段是多语言 JSONB 格式，但前台页面期望的是字符串格式，导致无法正确显示。修复了 `NearbyPage.tsx` 中的类型定义和显示逻辑，使用 `getMultilangContent` 函数正确处理多语言字段。

---

## 📌 修改文件列表

1. **src/app/nearby/NearbyPage.tsx**
   - 更新 `Merchant` 类型定义，将 `name`、`description`、`address` 字段改为支持多语言对象格式
   - 修改商户名称、描述、地址的显示逻辑，使用 `getMultilangContent` 函数处理多语言字段
   - 修复图片 `alt` 属性，使用 `getMultilangContent` 处理商户名称

2. **src/app/api/merchants/route.ts**
   - 添加注释说明多语言字段保持对象格式

3. **src/lib/version.ts**
   - 更新版本号为 `2025-11-29 11:59:59`

---

## 📌 逐条红线规范自检（A1–D2）

### 🔴 A. 架构红线

| 编号 | 规则 | 状态 | 说明 |
|------|------|------|------|
| A1 | 路由层禁止承载业务逻辑 | ✅ 已遵守 | 本次修改仅涉及前端组件逻辑和 API 数据格式，不涉及路由层业务逻辑 |
| A2 | 所有核心逻辑必须写入 ai-core | ⚪ 不适用 | 本次任务不涉及 AI 功能 |
| A3 | ai-service 与 local-ai-service 行为必须保持完全一致 | ⚪ 不适用 | 本次任务不涉及 AI 服务 |
| A4 | 接口参数、返回结构必须保持统一 | ✅ 已遵守 | 本次修改保持了 API 返回结构的一致性，多语言字段保持对象格式 |

### 🔴 B. 数据库 & 文件结构红线

| 编号 | 规则 | 状态 | 说明 |
|------|------|------|------|
| B1 | 任何数据库字段、表结构、索引的修改必须同步更新数据库结构文档 | ⚪ 不适用 | 本次任务不涉及数据库结构修改 |
| B2 | 所有文件新增、删除、迁移必须同步更新文件结构文档 | ⚪ 不适用 | 本次任务未新增、删除或迁移文件 |
| B3 | 所有 Kysely 类型定义必须与数据库结构同步保持一致 | ⚪ 不适用 | 本次任务不涉及数据库类型定义 |
| B4 | DriveQuiz 主库与 AI Service 库的 schema 需保持文档同步 | ⚪ 不适用 | 本次任务不涉及数据库 schema 修改 |

### 🔴 C. 测试红线（AI 调用必须双环境测试）

| 编号 | 规则 | 状态 | 说明 |
|------|------|------|------|
| C1 | 涉及 AI 功能必须同时测试：local-ai-service & 远程 ai-service | ⚪ 不适用 | 本次任务不涉及 AI 功能 |
| C2 | 必须输出测试日志摘要（请求、响应、耗时、错误） | ⚪ 不适用 | 本次任务不涉及 AI 调用 |
| C3 | 若测试失败，必须主动继续排查，不得要求用户手动重试 | ⚪ 不适用 | 本次任务不涉及 AI 调用测试 |

### 🔴 D. 执行报告红线（最终必须输出）

| 编号 | 规则 | 状态 | 说明 |
|------|------|------|------|
| D1 | 任务结束必须按模板输出完整执行报告 | ✅ 已遵守 | 本报告即为完整执行报告 |
| D2 | 必须逐条对照 A1–D2，标注"已遵守 / 不适用 / 必须修复" | ✅ 已遵守 | 已逐条对照并标注状态 |

### 🔴 E. 清除冗余和肥胖代码

| 编号 | 规则 | 状态 | 说明 |
|------|------|------|------|
| E1 | 删除目标功能流程中残留的无用调试代码、重复日志、未再使用的辅助函数 | ✅ 已遵守 | 本次修改未引入冗余代码 |
| E2 | 移除冗余/过时代码，保证目标功能流程结构简洁、职责单一 | ✅ 已遵守 | 本次修改优化了代码逻辑，未引入冗余代码 |

---

## 📌 问题分析

### 问题描述

用户创建了商户，但前台服务页面（`/nearby`）无法显示商户信息。

### 根本原因

1. **类型不匹配**：
   - 数据库中，`merchants` 表的 `name`、`description`、`address` 字段是多语言 JSONB 格式（`{zh?: string, en?: string, ja?: string}`）
   - 但 `NearbyPage.tsx` 中的 `Merchant` 类型定义是 `name: string`，期望的是字符串格式
   - 当 API 返回多语言对象时，前端无法正确处理

2. **显示逻辑问题**：
   - 在显示商户信息时，直接使用 `merchant.name`、`merchant.description`、`merchant.address`
   - 如果这些字段是多语言对象，React 会报错（Objects are not valid as a React child）

3. **API 数据格式**：
   - `/api/merchants` API 直接返回了数据库中的多语言对象，没有进行转换
   - 这是正确的做法，因为保持了数据的完整性，但前端需要正确处理

### 修复方案

1. **更新类型定义**：
   - 将 `Merchant` 类型中的 `name`、`description`、`address` 字段改为支持多语言对象格式
   - 使用联合类型：`string | { zh?: string; en?: string; ja?: string; default?: string }`

2. **修复显示逻辑**：
   - 使用 `getMultilangContent` 函数处理多语言字段
   - 确保所有显示商户信息的地方都使用 `getMultilangContent` 函数

3. **保持 API 数据格式**：
   - API 继续返回多语言对象格式，保持数据完整性
   - 前端负责根据当前语言选择合适的内容显示

---

## 📌 修改详情

### 1. 更新 Merchant 类型定义

**修改前**：
```typescript
type Merchant = {
  id: number;
  name: string; // ❌ 只支持字符串
  description: string | null; // ❌ 只支持字符串
  address: string | null; // ❌ 只支持字符串
  phone: string | null;
  email: string | null;
  imageUrl: string | null;
  category: string | null;
};
```

**修改后**：
```typescript
type Merchant = {
  id: number;
  name: string | { zh?: string; en?: string; ja?: string; default?: string }; // ✅ 支持多语言对象
  description: string | { zh?: string; en?: string; ja?: string; default?: string } | null; // ✅ 支持多语言对象
  address: string | { zh?: string; en?: string; ja?: string; default?: string } | null; // ✅ 支持多语言对象
  phone: string | null;
  email: string | null;
  imageUrl: string | null;
  category: string | null;
};
```

### 2. 修复商户名称显示

**修改前**：
```typescript
<h3 className="text-lg font-bold text-gray-900">{merchant.name}</h3> // ❌ 如果是对象，会报错
```

**修改后**：
```typescript
<h3 className="text-lg font-bold text-gray-900">
  {getMultilangContent(merchant.name, language, '商户')} // ✅ 正确处理多语言
</h3>
```

### 3. 修复商户描述显示

**修改前**：
```typescript
{merchant.description && (
  <p className="text-sm text-gray-600 mb-2">{merchant.description}</p> // ❌ 如果是对象，会报错
)}
```

**修改后**：
```typescript
{merchant.description && (
  <p className="text-sm text-gray-600 mb-2">
    {getMultilangContent(merchant.description, language, '')} // ✅ 正确处理多语言
  </p>
)}
```

### 4. 修复商户地址显示

**修改前**：
```typescript
<span>{merchant.address}</span> // ❌ 如果是对象，会报错
```

**修改后**：
```typescript
<span>{getMultilangContent(merchant.address, language, '')}</span> // ✅ 正确处理多语言
```

### 5. 修复图片 alt 属性

**修改前**：
```typescript
<img
  src={merchant.imageUrl}
  alt={merchant.name} // ❌ 如果是对象，会报错
  className="w-full h-full object-cover rounded-lg"
/>
```

**修改后**：
```typescript
<img
  src={merchant.imageUrl}
  alt={getMultilangContent(merchant.name, language, '商户')} // ✅ 正确处理多语言
  className="w-full h-full object-cover rounded-lg"
/>
```

---

## 📌 测试结果

### 前端组件测试

**测试环境**：
- Next.js 15.5.6
- React 18+
- TypeScript

**测试项**：
1. ✅ 类型检查通过（无 TypeScript 错误）
2. ✅ Lint 检查通过（无 ESLint 错误）
3. ✅ 商户名称正确显示（多语言对象格式）
4. ✅ 商户描述正确显示（多语言对象格式）
5. ✅ 商户地址正确显示（多语言对象格式）
6. ✅ 图片 alt 属性正确显示（多语言对象格式）
7. ✅ 语言切换时，商户信息正确更新

**测试场景**：
- ✅ 商户名称是多语言对象（`{zh: "商户名称", en: "Merchant Name"}`）
- ✅ 商户名称是字符串（向后兼容）
- ✅ 商户描述是多语言对象
- ✅ 商户描述是字符串（向后兼容）
- ✅ 商户地址是多语言对象
- ✅ 商户地址是字符串（向后兼容）
- ✅ 切换语言时，显示对应语言的内容

---

## 📌 迁移脚本

**不适用**：本次任务不涉及数据库迁移。

---

## 📌 更新后的文档

**不适用**：本次任务不涉及数据库结构或文件结构的修改。

---

## 📌 风险点与下一步建议

### 风险点

1. **向后兼容性**：修改后的代码支持字符串和多语言对象两种格式，确保向后兼容
2. **数据一致性**：确保所有商户数据都使用多语言对象格式，避免混合使用

### 下一步建议

1. **全面检查**：建议检查其他页面中是否有类似的商户显示问题
2. **类型安全**：建议在 API 层面统一多语言字段的格式，避免混合使用
3. **测试覆盖**：建议添加单元测试，确保多语言字段处理逻辑正确

---

## 📌 总结

本次修复成功解决了前台商户页面无法显示已创建商户的问题。通过更新类型定义和使用 `getMultilangContent` 函数处理多语言字段，确保了商户信息能够正确显示，并支持多语言切换。

**当前版本号**: 2025-11-29 11:59:59

**修复状态**: ✅ 已完成

