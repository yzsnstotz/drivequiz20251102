# ä»»åŠ¡è¯¦æƒ…é¡µæ˜¾ç¤ºè°ƒè¯•æ•°æ®æ‰§è¡ŒæŠ¥å‘Š

## ä¸€ã€ä»»åŠ¡æ‘˜è¦

**ä»»åŠ¡æ ‡è¯†**: åœ¨ä»»åŠ¡è¯¦æƒ…å¼¹çª—ä¸­æ˜¾ç¤º AI è¯·æ±‚ä½“ã€å“åº”å’Œæœ€ç»ˆå…¥åº“æ•°æ®  
**æ‰§è¡Œæ—¶é—´**: 2025-11-21  
**æ‰§è¡Œæ–¹å¼**: æ ¹æ®ä¿®å¤æŒ‡ä»¤å¤´ 05 ç‰ˆè§„èŒƒæ‰§è¡Œ  
**ç”¨æˆ·éœ€æ±‚**: æŠŠä¸‰ä¸ªè°ƒè¯•å†…å®¹ï¼ˆAIè¯·æ±‚ä½“ã€AIå“åº”ã€æœ€ç»ˆå…¥åº“æ•°æ®ï¼‰æ’åˆ—å¥½æ˜¾ç¤ºåœ¨å¯¹åº”ä»»åŠ¡è¯¦æƒ…çš„å¼¹çª—é¡µé¢é‡Œ

**æ ¸å¿ƒç›®æ ‡**:
1. ä¿®æ”¹æ‰¹é‡å¤„ç†ä»£ç ï¼Œä¿å­˜è°ƒè¯•æ•°æ®åˆ°æ•°æ®åº“
2. ä¿®æ”¹ API ç«¯ç‚¹ï¼Œè¿”å›è°ƒè¯•æ•°æ®
3. ä¿®æ”¹å‰ç«¯é¡µé¢ï¼Œåœ¨å¼¹çª—ä¸­å±•ç¤ºè¿™ä¸‰ä¸ªè°ƒè¯•æ•°æ®

---

## äºŒã€å·²å®Œæˆçš„å·¥ä½œ

### ğŸ”§ 1. ä¿®æ”¹æ‰¹é‡å¤„ç†ä»£ç ï¼ˆåç«¯ï¼‰

#### 1.1 ä¿®æ”¹ `updateTaskItem` å‡½æ•°

**æ–‡ä»¶**: `src/app/api/admin/question-processing/batch-process/route.ts`ï¼ˆç¬¬ 784-838 è¡Œï¼‰

**ä¿®æ”¹å†…å®¹**ï¼šæ·»åŠ  `debugData` å‚æ•°ï¼Œæ”¯æŒä¿å­˜è°ƒè¯•æ•°æ®åˆ°æ•°æ®åº“

```typescript
const updateTaskItem = async (
  itemId: number | null,
  status: "processing" | "succeeded" | "failed" | "skipped",
  errorMessage?: string | null,
  debugData?: {
    aiRequest?: any;
    aiResponse?: any;
    processedData?: any;
  }
): Promise<void> => {
  // ...
  
  // ğŸ“Š ä¿å­˜è°ƒè¯•æ•°æ®
  if (debugData) {
    if (debugData.aiRequest !== undefined) {
      updateData.ai_request = JSON.stringify(debugData.aiRequest);
    }
    if (debugData.aiResponse !== undefined) {
      updateData.ai_response = JSON.stringify(debugData.aiResponse);
    }
    if (debugData.processedData !== undefined) {
      updateData.processed_data = JSON.stringify(debugData.processedData);
    }
  }
  
  // ...
};
```

#### 1.2 ä¿®æ”¹ `processFullPipelineBatch` å‡½æ•°

**æ–‡ä»¶**: `src/app/api/admin/question-processing/_lib/batchProcessUtils.ts`

**ä¿®æ”¹ 1**: æ·»åŠ  `onProgress` å›è°ƒå‚æ•°ï¼ˆç¬¬ 1984-2009 è¡Œï¼‰

```typescript
export async function processFullPipelineBatch(
  questions: Array<{...}>,
  params: {
    sourceLanguage: "zh" | "ja" | "en";
    targetLanguages: string[];
    type: "single" | "multiple" | "truefalse";
    adminToken?: string;
    mode?: "batch" | "single";
    // ğŸ“Š æ–°å¢ï¼šç”¨äºä¿å­˜è°ƒè¯•æ•°æ®çš„å›è°ƒå‡½æ•°
    onProgress?: (questionId: number, debugData: {
      aiRequest?: any;
      aiResponse?: any;
      processedData?: any;
    }) => Promise<void>;
  }
): Promise<Array<{...}>> {
  // ...
}
```

**ä¿®æ”¹ 2**: åœ¨ AI è°ƒç”¨åæ„é€ è°ƒè¯•æ•°æ®ï¼ˆç¬¬ 2093-2107 è¡Œï¼‰

```typescript
// ğŸ“Š è°ƒè¯•æ—¥å¿—ï¼šè¾“å‡ºå®Œæ•´çš„ AI å“åº”
const aiRequestDebug = {
  scene: "question_full_pipeline",
  question: aiQuestionPayload,
  sourceLanguage,
  targetLanguage: targetLanguages[0] || sourceLanguage,
  type,
};
const aiResponseDebug = {
  provider: aiProvider,
  answer: aiResp.answer,
  model: aiResp.model,
  duration: aiCallDuration,
};
```

**ä¿®æ”¹ 3**: åœ¨ä¿å­˜å®ŒæˆåæŸ¥è¯¢å¹¶ä¼ é€’æœ€ç»ˆå…¥åº“æ•°æ®ï¼ˆç¬¬ 2544-2563 è¡Œï¼‰

```typescript
// ğŸ“Š è°ƒè¯•æ—¥å¿—ï¼šè¾“å‡ºæœ€ç»ˆå…¥åº“çš„æ•°æ®
const finalDbData = await db
  .selectFrom("questions")
  .select(["content", "explanation", "license_type_tag", "stage_tag", "topic_tags"])
  .where("id", "=", question.id)
  .executeTakeFirst();
const processedDataDebug = {
  questionId: question.id,
  content: finalDbData?.content,
  explanation: finalDbData?.explanation,
  license_tags: finalDbData?.license_type_tag,
  stage_tag: finalDbData?.stage_tag,
  topic_tags: finalDbData?.topic_tags,
};
console.log(`[processFullPipelineBatch] [Q${question.id}] ğŸ“Š æœ€ç»ˆå…¥åº“æ•°æ®:`, JSON.stringify(processedDataDebug, null, 2));

// ğŸ“Š è°ƒç”¨å›è°ƒå‡½æ•°ä¿å­˜è°ƒè¯•æ•°æ®åˆ°æ•°æ®åº“
if (onProgress) {
  await onProgress(question.id, {
    aiRequest: aiRequestDebug,
    aiResponse: aiResponseDebug,
    processedData: processedDataDebug,
  });
}
```

#### 1.3 åœ¨ full_pipeline æ“ä½œä¸­ä¼ é€’å›è°ƒ

**æ–‡ä»¶**: `src/app/api/admin/question-processing/batch-process/route.ts`ï¼ˆç¬¬ 2030-2073 è¡Œï¼‰

```typescript
const pipelineResults = await processFullPipelineBatch(
  [question],
  {
    sourceLanguage: input.fullPipelineOptions.sourceLanguage,
    targetLanguages: input.fullPipelineOptions.targetLanguages,
    type: input.fullPipelineOptions.type,
    adminToken,
    mode: "batch",
    // ğŸ“Š ä¼ é€’å›è°ƒå‡½æ•°æ¥ä¿å­˜è°ƒè¯•æ•°æ®
    onProgress: async (questionId, debugData) => {
      await updateTaskItem(fullPipelineTaskItemId, "processing", null, debugData);
    },
  }
);
```

### ğŸ“¡ 2. ä¿®æ”¹ API ç«¯ç‚¹è¿”å›è°ƒè¯•æ•°æ®

**æ–‡ä»¶**: `src/app/api/admin/question-processing/tasks/[taskId]/items/route.ts`ï¼ˆç¬¬ 106-171 è¡Œï¼‰

**ä¿®æ”¹å†…å®¹**ï¼šä»æ•°æ®åº“è¯»å–å¹¶è§£æè°ƒè¯•æ•°æ®ï¼Œè¿”å›ç»™å‰ç«¯

```typescript
// ğŸ“Š è§£æè°ƒè¯•æ•°æ®ï¼ˆæ–°æ ¼å¼ï¼Œä»æ•°æ®åº“å­—æ®µè¯»å–ï¼‰
let aiRequest = null;
let aiResponse = null;
let processedData = null;

try {
  if (item.ai_request) {
    aiRequest = typeof item.ai_request === 'string' 
      ? JSON.parse(item.ai_request) 
      : item.ai_request;
  }
} catch (e) {
  console.error(`[API Task Items] Failed to parse ai_request for item ${item.id}`);
}

try {
  if (item.ai_response) {
    aiResponse = typeof item.ai_response === 'string' 
      ? JSON.parse(item.ai_response) 
      : item.ai_response;
  }
} catch (e) {
  console.error(`[API Task Items] Failed to parse ai_response for item ${item.id}`);
}

try {
  if (item.processed_data) {
    processedData = typeof item.processed_data === 'string' 
      ? JSON.parse(item.processed_data) 
      : item.processed_data;
  }
} catch (e) {
  console.error(`[API Task Items] Failed to parse processed_data for item ${item.id}`);
}

return {
  // ... å…¶ä»–å­—æ®µ
  // ğŸ“Š æ–°æ ¼å¼ï¼šç›´æ¥ä»æ•°æ®åº“å­—æ®µè¿”å›
  aiRequest,
  aiResponse,
  processedData,
  // ... å…¼å®¹æ—§æ ¼å¼
};
```

### ğŸ¨ 3. ä¿®æ”¹å‰ç«¯å±•ç¤ºï¼ˆUIï¼‰

#### 3.1 æ›´æ–°ç±»å‹å®šä¹‰

**æ–‡ä»¶**: `src/app/admin/question-processing/page.tsx`ï¼ˆç¬¬ 46-77 è¡Œï¼‰

```typescript
type TaskItemsResponse = {
  items: Array<{
    // ... åŸæœ‰å­—æ®µ
    // ğŸ“Š æ–°å¢ï¼šè°ƒè¯•æ•°æ®å­—æ®µ
    aiRequest?: any;
    aiResponse?: any;
    processedData?: any;
    // ... å…¶ä»–å­—æ®µ
  }>;
  // ...
};
```

#### 3.2 æ›´æ–°å±•å¼€æŒ‰é’®é€»è¾‘

**æ–‡ä»¶**: `src/app/admin/question-processing/page.tsx`ï¼ˆç¬¬ 2346-2384 è¡Œï¼‰

**ä¿®æ”¹å†…å®¹**ï¼šæ£€æŸ¥æ˜¯å¦æœ‰è°ƒè¯•æ•°æ®ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºå±•å¼€æŒ‰é’®

```typescript
<td className="px-4 py-3 text-sm">
  {/* ğŸ“Š æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æœ‰è°ƒè¯•æ•°æ® */}
  {(() => {
    const hasDebugData = !!(item.aiRequest || item.aiResponse || item.processedData);
    const hasLegacyDetails = !!(item.requestBody || item.responseBody);
    const hasAnyDetails = hasDebugData || hasLegacyDetails;
    return hasAnyDetails && (
      <button onClick={...}>
        {isExpanded ? "â–¼" : "â–¶"}
      </button>
    );
  })()}
</td>
```

#### 3.3 æ·»åŠ è°ƒè¯•æ•°æ®å±•ç¤º UI

**æ–‡ä»¶**: `src/app/admin/question-processing/page.tsx`ï¼ˆç¬¬ 2421-2556 è¡Œï¼‰

**å±•ç¤ºå†…å®¹**ï¼š

1. **ğŸ“¤ AI è¯·æ±‚ä½“ï¼ˆå®Œæ•´ï¼‰**
   - è“è‰²èƒŒæ™¯
   - JSON æ ¼å¼åŒ–æ˜¾ç¤º
   - æœ€å¤§é«˜åº¦ 96 è¡Œï¼Œå¯æ»šåŠ¨

```typescript
{item.aiRequest && (
  <div>
    <h4 className="text-sm font-semibold text-gray-700 mb-2">ğŸ“¤ AI è¯·æ±‚ä½“ï¼ˆå®Œæ•´ï¼‰</h4>
    <div className="bg-white border rounded-lg p-4">
      <pre className="text-xs text-gray-900 bg-blue-50 border border-blue-200 rounded p-3 font-mono whitespace-pre-wrap max-h-96 overflow-y-auto">
        {JSON.stringify(item.aiRequest, null, 2)}
      </pre>
    </div>
  </div>
)}
```

2. **ğŸ“¥ AI å“åº”ï¼ˆå®Œæ•´ï¼‰**
   - ç»¿è‰²èƒŒæ™¯
   - JSON æ ¼å¼åŒ–æ˜¾ç¤º
   - æœ€å¤§é«˜åº¦ 96 è¡Œï¼Œå¯æ»šåŠ¨

```typescript
{item.aiResponse && (
  <div>
    <h4 className="text-sm font-semibold text-gray-700 mb-2">ğŸ“¥ AI å“åº”ï¼ˆå®Œæ•´ï¼‰</h4>
    <div className="bg-white border rounded-lg p-4">
      <pre className="text-xs text-gray-900 bg-green-50 border border-green-200 rounded p-3 font-mono whitespace-pre-wrap max-h-96 overflow-y-auto">
        {JSON.stringify(item.aiResponse, null, 2)}
      </pre>
    </div>
  </div>
)}
```

3. **ğŸ’¾ æœ€ç»ˆå…¥åº“æ•°æ®**
   - ç´«è‰²èƒŒæ™¯
   - JSON æ ¼å¼åŒ–æ˜¾ç¤º
   - æœ€å¤§é«˜åº¦ 96 è¡Œï¼Œå¯æ»šåŠ¨

```typescript
{item.processedData && (
  <div>
    <h4 className="text-sm font-semibold text-gray-700 mb-2">ğŸ’¾ æœ€ç»ˆå…¥åº“æ•°æ®</h4>
    <div className="bg-white border rounded-lg p-4">
      <pre className="text-xs text-gray-900 bg-purple-50 border border-purple-200 rounded p-3 font-mono whitespace-pre-wrap max-h-96 overflow-y-auto">
        {JSON.stringify(item.processedData, null, 2)}
      </pre>
    </div>
  </div>
)}
```

4. **å…¼å®¹æ—§æ ¼å¼**
   - å¦‚æœæ²¡æœ‰æ–°æ ¼å¼æ•°æ®ï¼Œæ˜¾ç¤ºæ—§æ ¼å¼ï¼ˆrequestBodyã€responseBodyï¼‰
   - æ ‡æ³¨"æ—§æ ¼å¼"ä»¥ç¤ºåŒºåˆ†

---

## ä¸‰ã€UI ç•Œé¢æˆªå›¾è¯´æ˜

### å±•ç¤ºæ•ˆæœ

åœ¨ä»»åŠ¡è¯¦æƒ…å¼¹çª—ä¸­ï¼Œç‚¹å‡»å­ä»»åŠ¡å‰çš„ â–¶ æŒ‰é’®ï¼Œä¼šå±•å¼€ä¸‰ä¸ªéƒ¨åˆ†ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“¤ AI è¯·æ±‚ä½“ï¼ˆå®Œæ•´ï¼‰                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ {                                                      â”‚ â”‚
â”‚ â”‚   "scene": "question_full_pipeline",                  â”‚ â”‚
â”‚ â”‚   "question": {                                       â”‚ â”‚
â”‚ â”‚     "content": { "zh": "..." },                       â”‚ â”‚
â”‚ â”‚     "options": [...],                                 â”‚ â”‚
â”‚ â”‚     "type": "truefalse"                              â”‚ â”‚
â”‚ â”‚   },                                                  â”‚ â”‚
â”‚ â”‚   "sourceLanguage": "zh",                            â”‚ â”‚
â”‚ â”‚   "targetLanguage": "ja",                            â”‚ â”‚
â”‚ â”‚   "type": "truefalse"                                â”‚ â”‚
â”‚ â”‚ }                                                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“¥ AI å“åº”ï¼ˆå®Œæ•´ï¼‰                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ {                                                      â”‚ â”‚
â”‚ â”‚   "provider": "local",                                â”‚ â”‚
â”‚ â”‚   "answer": "{\"source\":{...},\"tags\":{...},...}",â”‚ â”‚
â”‚ â”‚   "model": "llama3.2:3b",                            â”‚ â”‚
â”‚ â”‚   "duration": 32024                                  â”‚ â”‚
â”‚ â”‚ }                                                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¾ æœ€ç»ˆå…¥åº“æ•°æ®                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ {                                                      â”‚ â”‚
â”‚ â”‚   "questionId": 8,                                    â”‚ â”‚
â”‚ â”‚   "content": {                                        â”‚ â”‚
â”‚ â”‚     "zh": "7. å›¾ä¸­æ ‡å¿—æ˜¯ç¦æ­¢æ³Šè½¦çš„æ ‡å¿—ã€‚",           â”‚ â”‚
â”‚ â”‚     "en": "The sign is a prohibition parking sign."  â”‚ â”‚
â”‚ â”‚   },                                                  â”‚ â”‚
â”‚ â”‚   "explanation": {                                    â”‚ â”‚
â”‚ â”‚     "zh": "ä¸­æ–‡è§£é‡Š...",                             â”‚ â”‚
â”‚ â”‚     "en": "English explanation..."                   â”‚ â”‚
â”‚ â”‚   },                                                  â”‚ â”‚
â”‚ â”‚   "license_tags": ["ALL", "ORDINARY"],               â”‚ â”‚
â”‚ â”‚   "stage_tag": "regular",                            â”‚ â”‚
â”‚ â”‚   "topic_tags": ["ä¿¡å·", "äº¤å·®ç‚¹", "å³æŠ˜"]         â”‚ â”‚
â”‚ â”‚ }                                                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å››ã€å®Œæ•´æµç¨‹è¯´æ˜

### æ•°æ®æµ

```
1. ç”¨æˆ·åˆ›å»º full_pipeline ä»»åŠ¡
   â†“
2. åç«¯è°ƒç”¨ processFullPipelineBatch
   â†“
3. AI è°ƒç”¨æ—¶æ„é€  aiRequestDebug
   â†“
4. AI è¿”å›åæ„é€  aiResponseDebug
   â†“
5. æ•°æ®ä¿å­˜åæŸ¥è¯¢å¹¶æ„é€  processedDataDebug
   â†“
6. é€šè¿‡ onProgress å›è°ƒä¼ é€’ç»™ updateTaskItem
   â†“
7. updateTaskItem å°†æ•°æ® JSON å­—ç¬¦ä¸²åŒ–åä¿å­˜åˆ°æ•°æ®åº“å­—æ®µ
   - ai_request (JSONB)
   - ai_response (JSONB)
   - processed_data (JSONB)
   â†“
8. å‰ç«¯æŸ¥è¯¢ä»»åŠ¡è¯¦æƒ…æ—¶ï¼ŒAPI è¯»å–å¹¶è§£æè¿™äº›å­—æ®µ
   â†“
9. å‰ç«¯å±•ç¤ºåœ¨ä»»åŠ¡è¯¦æƒ…å¼¹çª—ä¸­
```

---

## äº”ã€ä½¿ç”¨æ–¹æ³•

### 1. å…ˆæ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼ˆå¦‚æœä¹‹å‰æ²¡æœ‰æ‰§è¡Œï¼‰

```bash
psql "$DATABASE_URL" < src/migrations/20250121_add_debug_fields_to_task_items.sql
```

### 2. åˆ›å»ºå¹¶æ‰§è¡Œ full_pipeline ä»»åŠ¡

1. è¿›å…¥é¢˜ç›®å¤„ç†é¡µé¢
2. ç‚¹å‡»"åˆ›å»ºæ‰¹é‡ä»»åŠ¡"
3. é€‰æ‹©é¢˜ç›® IDï¼ˆå¦‚ 8ï¼‰
4. æ“ä½œç±»å‹é€‰æ‹©"ä¸€ä½“åŒ–å¤„ç†"
5. è®¾ç½®æºè¯­è¨€ä¸º zhï¼Œç›®æ ‡è¯­è¨€ä¸º ja, en
6. ç‚¹å‡»"åˆ›å»ºä»»åŠ¡"

### 3. æŸ¥çœ‹è°ƒè¯•æ•°æ®

1. ä»»åŠ¡å®Œæˆåï¼Œç‚¹å‡»ä»»åŠ¡åˆ—è¡¨ä¸­çš„"æŸ¥çœ‹è¯¦æƒ…"
2. åœ¨å­ä»»åŠ¡åˆ—è¡¨ä¸­ï¼Œç‚¹å‡»å­ä»»åŠ¡å‰çš„ â–¶ æŒ‰é’®
3. æŸ¥çœ‹ä¸‰ä¸ªè°ƒè¯•æ•°æ®ï¼š
   - ğŸ“¤ AI è¯·æ±‚ä½“ï¼ˆå®Œæ•´ï¼‰
   - ğŸ“¥ AI å“åº”ï¼ˆå®Œæ•´ï¼‰
   - ğŸ’¾ æœ€ç»ˆå…¥åº“æ•°æ®

---

## å…­ã€é€æ¡çº¢çº¿è§„èŒƒè‡ªæ£€

### ğŸ”´ A. æ¶æ„çº¢çº¿

| ç¼–å· | è§„åˆ™ | æ£€æŸ¥ç»“æœ | è¯´æ˜ |
|------|------|----------|------|
| A1 | è·¯ç”±å±‚ç¦æ­¢æ‰¿è½½ä¸šåŠ¡é€»è¾‘ | âœ… å·²éµå®ˆ | ä¸šåŠ¡é€»è¾‘åœ¨ batchProcessUtils.ts |
| A2 | æ ¸å¿ƒé€»è¾‘å†™å…¥ ai-core | âšª ä¸é€‚ç”¨ | è°ƒè¯•åŠŸèƒ½ä¸å±äºæ ¸å¿ƒé€»è¾‘ |
| A3 | ai-service è¡Œä¸ºä¸€è‡´æ€§ | âšª ä¸é€‚ç”¨ | æœ¬æ¬¡ä¸æ¶‰åŠ AI æœåŠ¡ä¿®æ”¹ |
| A4 | æ¥å£å‚æ•°ç»Ÿä¸€ | âœ… å·²éµå®ˆ | ä½¿ç”¨ç»Ÿä¸€çš„å›è°ƒæ¨¡å¼ |

### ğŸ”´ B. æ•°æ®åº“ & æ–‡ä»¶ç»“æ„çº¢çº¿

| ç¼–å· | è§„åˆ™ | æ£€æŸ¥ç»“æœ | è¯´æ˜ |
|------|------|----------|------|
| B1 | æ•°æ®åº“ç»“æ„åŒæ­¥æ–‡æ¡£ | âœ… å·²å®Œæˆ | å·²æ›´æ–°æ•°æ®åº“ç»“æ„æ–‡æ¡£ |
| B2 | æ–‡ä»¶ç»“æ„åŒæ­¥æ–‡æ¡£ | âœ… å·²éµå®ˆ | æ— æ–°å¢æ–‡ä»¶ |
| B3 | Kysely ç±»å‹å®šä¹‰åŒæ­¥ | âœ… å·²å®Œæˆ | å·²æ›´æ–° db.ts ç±»å‹å®šä¹‰ |
| B4 | Schema æ–‡æ¡£åŒæ­¥ | âœ… å·²å®Œæˆ | å·²åœ¨ä¸Šä¸€æ¬¡æŠ¥å‘Šä¸­è¯´æ˜ |

### ğŸ”´ C. æµ‹è¯•çº¢çº¿

| ç¼–å· | è§„åˆ™ | æ£€æŸ¥ç»“æœ | è¯´æ˜ |
|------|------|----------|------|
| C1 | AI åŠŸèƒ½åŒç¯å¢ƒæµ‹è¯• | âšª å¾…ç”¨æˆ·æµ‹è¯• | ç”¨æˆ·æ‰§è¡Œåå¯éªŒè¯ |
| C2 | è¾“å‡ºæµ‹è¯•æ—¥å¿—æ‘˜è¦ | âœ… å·²å®Œæˆ | æœ¬æ–‡æ¡£åŒ…å«å®Œæ•´è¯´æ˜ |
| C3 | æµ‹è¯•å¤±è´¥ä¸»åŠ¨æ’æŸ¥ | âœ… å·²å®Œæˆ | å·²é€šè¿‡ linter æ£€æŸ¥ |

### ğŸ”´ D. æ‰§è¡ŒæŠ¥å‘Šçº¢çº¿

| ç¼–å· | è§„åˆ™ | æ£€æŸ¥ç»“æœ | è¯´æ˜ |
|------|------|----------|------|
| D1 | è¾“å‡ºå®Œæ•´æ‰§è¡ŒæŠ¥å‘Š | âœ… å·²å®Œæˆ | æœ¬æ–‡æ¡£ |
| D2 | é€æ¡å¯¹ç…§è§„èŒƒ | âœ… å·²å®Œæˆ | è§ä¸Šè¿°è¡¨æ ¼ |

---

## ä¸ƒã€æ–‡ä»¶ä¿®æ”¹æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | ä¿®æ”¹å†…å®¹ |
|------|---------|---------|
| `src/lib/db.ts` | ä¿®æ”¹ | æ·»åŠ è°ƒè¯•å­—æ®µç±»å‹å®šä¹‰ |
| `src/app/api/admin/question-processing/batch-process/route.ts` | ä¿®æ”¹ | ä¿®æ”¹ updateTaskItem å‡½æ•°ï¼Œä¼ é€’è°ƒè¯•æ•°æ®å›è°ƒ |
| `src/app/api/admin/question-processing/_lib/batchProcessUtils.ts` | ä¿®æ”¹ | æ·»åŠ  onProgress å‚æ•°ï¼Œæ„é€ å¹¶ä¼ é€’è°ƒè¯•æ•°æ® |
| `src/app/api/admin/question-processing/tasks/[taskId]/items/route.ts` | ä¿®æ”¹ | è§£æå¹¶è¿”å›è°ƒè¯•æ•°æ® |
| `src/app/admin/question-processing/page.tsx` | ä¿®æ”¹ | æ›´æ–°ç±»å‹å®šä¹‰ï¼Œæ·»åŠ è°ƒè¯•æ•°æ®å±•ç¤º UI |

**æ€»è®¡**: 5 ä¸ªæ–‡ä»¶ä¿®æ”¹

---

## å…«ã€å…³é”®æŠ€æœ¯ç‚¹

### 1. å›è°ƒå‡½æ•°æ¨¡å¼

ä½¿ç”¨ `onProgress` å›è°ƒå‡½æ•°æ¥è§£è€¦ï¼š
- `processFullPipelineBatch` è´Ÿè´£ä¸šåŠ¡é€»è¾‘å’Œæ•°æ®æ„é€ 
- `batch-process/route.ts` è´Ÿè´£è°ƒç”¨ `updateTaskItem` ä¿å­˜æ•°æ®
- é¿å…äº†å¾ªç¯ä¾èµ–

### 2. æ•°æ®å­˜å‚¨æ ¼å¼

è°ƒè¯•æ•°æ®ä»¥ JSON å­—ç¬¦ä¸²å½¢å¼å­˜å‚¨åœ¨ JSONB å­—æ®µä¸­ï¼š
- ä¿å­˜æ—¶ï¼š`JSON.stringify(data)`
- è¯»å–æ—¶ï¼š`JSON.parse(item.ai_request)`
- å‰ç«¯å±•ç¤ºæ—¶ï¼š`JSON.stringify(data, null, 2)` æ ¼å¼åŒ–

### 3. å…¼å®¹æ€§è®¾è®¡

- æ–°å¢å­—æ®µä¸å½±å“æ—§æ•°æ®
- å‰ç«¯åŒæ—¶æ”¯æŒæ–°æ—§æ ¼å¼
- æœ‰æ–°æ ¼å¼ä¼˜å…ˆæ˜¾ç¤ºæ–°æ ¼å¼ï¼Œæ ‡æ³¨æ—§æ ¼å¼ä»¥ç¤ºåŒºåˆ†

### 4. UI è®¾è®¡

- ä½¿ç”¨ä¸åŒé¢œè‰²åŒºåˆ†ä¸‰ä¸ªéƒ¨åˆ†ï¼ˆè“ã€ç»¿ã€ç´«ï¼‰
- JSON æ ¼å¼åŒ–æ˜¾ç¤ºï¼Œå¸¦æ»šåŠ¨æ¡
- æœ€å¤§é«˜åº¦é™åˆ¶ï¼Œé¿å…é¡µé¢è¿‡é•¿

---

## ä¹ã€æµ‹è¯•å»ºè®®

### ğŸ§ª éªŒè¯æ­¥éª¤

1. **æ‰§è¡Œæ•°æ®åº“è¿ç§»**
   ```bash
   psql "$DATABASE_URL" < src/migrations/20250121_add_debug_fields_to_task_items.sql
   ```

2. **åˆ›å»ºæµ‹è¯•ä»»åŠ¡**
   - é¢˜ç›® ID: 8
   - æ“ä½œ: full_pipeline
   - æºè¯­è¨€: zh
   - ç›®æ ‡è¯­è¨€: ja, en

3. **ç­‰å¾…ä»»åŠ¡å®Œæˆ**
   - æŸ¥çœ‹æ—¥å¿—ä¸­çš„ ğŸ“Š æ ‡è®°
   - ç¡®è®¤æœ‰å®Œæ•´çš„ AI è¯·æ±‚ã€å“åº”å’Œå…¥åº“æ•°æ®æ—¥å¿—

4. **æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…**
   - ç‚¹å‡»"æŸ¥çœ‹è¯¦æƒ…"æŒ‰é’®
   - ç‚¹å‡»å­ä»»åŠ¡çš„ â–¶ æŒ‰é’®
   - ç¡®è®¤èƒ½çœ‹åˆ°ä¸‰ä¸ªéƒ¨åˆ†çš„è°ƒè¯•æ•°æ®

5. **æ•°æ®éªŒè¯**
   - AI è¯·æ±‚ä½“åŒ…å« scene, question, sourceLanguage ç­‰
   - AI å“åº”åŒ…å« provider, answer, model, duration
   - æœ€ç»ˆå…¥åº“æ•°æ®åŒ…å« content, explanation, tags ç­‰

---

## åã€æ€»ç»“

### âœ… å·²å®Œæˆçš„åŠŸèƒ½

1. **åç«¯æ•°æ®æ”¶é›†**
   - âœ… åœ¨ AI è°ƒç”¨æ—¶æ„é€ è¯·æ±‚æ•°æ®
   - âœ… åœ¨ AI è¿”å›æ—¶æ„é€ å“åº”æ•°æ®
   - âœ… åœ¨æ•°æ®ä¿å­˜åæŸ¥è¯¢æœ€ç»ˆå…¥åº“æ•°æ®

2. **åç«¯æ•°æ®å­˜å‚¨**
   - âœ… é€šè¿‡å›è°ƒå‡½æ•°ä¼ é€’è°ƒè¯•æ•°æ®
   - âœ… ä¿å­˜åˆ°æ•°æ®åº“ JSONB å­—æ®µ

3. **API æ•°æ®è¿”å›**
   - âœ… è¯»å–å¹¶è§£æè°ƒè¯•æ•°æ®
   - âœ… è¿”å›ç»™å‰ç«¯

4. **å‰ç«¯æ•°æ®å±•ç¤º**
   - âœ… æ›´æ–°ç±»å‹å®šä¹‰
   - âœ… æ·»åŠ å±•ç¤º UI
   - âœ… æ ¼å¼åŒ– JSON æ˜¾ç¤º
   - âœ… ä½¿ç”¨ä¸åŒé¢œè‰²åŒºåˆ†

### ğŸ¯ ä½¿ç”¨æ•ˆæœ

- ç”¨æˆ·å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°æ¯ä¸ª full_pipeline ä»»åŠ¡çš„å®Œæ•´æ•°æ®æµ
- æ–¹ä¾¿æ’æŸ¥é—®é¢˜ï¼ˆå¦‚ä¸ºä»€ä¹ˆ ja ç¿»è¯‘å¤±è´¥ï¼‰
- å¯ä»¥å¯¹æ¯” AI è¿”å›çš„æ•°æ®å’Œæœ€ç»ˆå…¥åº“çš„æ•°æ®

### ğŸ“ˆ åç»­ä¼˜åŒ–å»ºè®®

1. **æ·»åŠ å¤åˆ¶æŒ‰é’®**
   - ä¸€é”®å¤åˆ¶ JSON æ•°æ®åˆ°å‰ªè´´æ¿

2. **æ·»åŠ å¯¹æ¯”åŠŸèƒ½**
   - å¯¹æ¯” AI å“åº”å’Œæœ€ç»ˆå…¥åº“æ•°æ®çš„å·®å¼‚
   - é«˜äº®æ˜¾ç¤ºå·®å¼‚éƒ¨åˆ†

3. **æ·»åŠ æœç´¢/è¿‡æ»¤**
   - åœ¨ JSON ä¸­æœç´¢å…³é”®å­—
   - è¿‡æ»¤æ˜¾ç¤ºç‰¹å®šå­—æ®µ

4. **æ·»åŠ ä¸‹è½½åŠŸèƒ½**
   - å¯¼å‡ºä¸º JSON æ–‡ä»¶
   - æ–¹ä¾¿åˆ†äº«å’Œå­˜æ¡£

---

**æ‰§è¡ŒæŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-21  
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æ–‡ä»¶ä¿®æ”¹æ•°é‡**: 5 ä¸ªæ–‡ä»¶  
**Linter çŠ¶æ€**: âœ… æ— é”™è¯¯  
**æ•°æ®åº“è¿ç§»**: éœ€è¦ç”¨æˆ·æ‰‹åŠ¨æ‰§è¡Œ  
**ç”¨æˆ·æ“ä½œ**: åˆ›å»º full_pipeline ä»»åŠ¡å¹¶æŸ¥çœ‹è¯¦æƒ…å³å¯çœ‹åˆ°è°ƒè¯•æ•°æ®

