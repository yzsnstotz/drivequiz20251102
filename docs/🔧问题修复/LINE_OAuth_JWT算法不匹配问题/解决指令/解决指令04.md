【Cursor 指令 1】全局确认再无 parseInt(user.id) 等旧逻辑

目标：确认代码层完全跟“字符串 ID（UUID）”方案对齐，排除代码侧残留问题。

在仓库根目录全局搜索：

关键词：

parseInt(user.id

parseInt(session.user.id

userDbId（特别关注是否还被当成 number 使用）

文件重点：

src/lib/auth.ts

src/app/api/_lib/withUserAuth.ts

src/app/api/auth/phone/route.ts

任何包含 withUserAuth / UserInfo 的文件

对于仍然存在的：

如果还在把 user.id / session.user.id 转成 number：

一律改为直接使用 string，不要再 parseInt。

UserInfo.userDbId：

确保类型是 string，且赋值时直接用 userId（UUID），不要再走 parseInt。

✅ 目标：在整个 codebase 中，把 “用户 ID = string（UUID）” 做到完全一致。

【Cursor 指令 2】核对 Kysely DB 类型定义与执行报告一致

目标：确认 TypeScript 层面的 DB schema 与“字符串 ID”策略完全一致。

打开 src/lib/db.ts（或存放 Kysely DB 类型定义的文件），确认以下内容：

UserTable.id：

interface UserTable {
  id: Generated<string>; // ✅ 必须是 string
  ...
}


所有和用户关联的 user_id 字段，都必须是 string：

OAuthAccountTable.user_id: string

SessionTable.user_id: string

UserProfileTable.user_id: string

UserInterestsTable.user_id: string

UserBehaviorTable.user_id: string

AdLogsTable.user_id: string | null

如果有字段还在用 number 或 Generated<number>：

立刻改成 string / Generated<string>，保持和执行报告 v4 完全一致。

✅ 目标：Kysely 类型定义已经是“全部 string”，现在只剩数据库物理表没迁移到位。

【Cursor 指令 3】对齐“迁移目录”与“迁移脚本”确保真的会执行

目标：保证 20251126_alter_users_and_auth_ids_to_text.sql 是放在 真正被迁移工具使用的目录，而不是孤立在某个地方。

在项目中搜索 Kysely Migrator 配置：

搜索关键词：new Migrator( 或 Migrator({ 或 migrationFolder

典型路径可能是：

src/lib/db/migrate.ts

scripts/migrate.ts

或 src/lib/db/migrations.ts 等

找到 Migrator 配置后，确认迁移目录：

const migrator = new Migrator({
  db,
  provider: new FileMigrationProvider({
    fs,
    path,
    migrationFolder: "XXX", // 这里是关键
  }),
});


记下 migrationFolder 的真实值，比如：

"src/lib/migrations"

或 "migrations"

对比执行报告 v4 里提到的迁移文件路径：

报告中的路径目前是：

src/migrations/20251126_alter_users_and_auth_ids_to_text.sql

如果 migrationFolder 不是 src/migrations：

把 20251126_alter_users_and_auth_ids_to_text.sql 和 20251126_create_nextauth_view_triggers.sql
移动到实际的 migrationFolder 目录下。

保持文件名不变（前缀时间戳 + 描述），保证执行顺序正确。

确认 SQL 内容至少包含这些核心操作（只校验，不重写）：

users.id：

ALTER TABLE public.users
  ALTER COLUMN id TYPE text USING id::text;
ALTER TABLE public.users
  ALTER COLUMN id DROP DEFAULT;
DROP SEQUENCE IF EXISTS users_id_seq;


各 user_id：

ALTER TABLE public.oauth_accounts
  ALTER COLUMN user_id TYPE text USING user_id::text;

ALTER TABLE public.sessions
  ALTER COLUMN user_id TYPE text USING user_id::text;

-- 以及 user_profiles / user_interests / user_behaviors / ad_logs 等


如果 Migrator 没有提供脚本入口（比如 pnpm db:migrate）：

在 package.json 里补一个脚本（Cursor 可以改）：

{
  "scripts": {
    "db:migrate": "ts-node src/lib/db/migrate.ts"
  }
}


✅ 目标：确保这两个迁移 SQL 文件位于 Kysely 实际使用的迁移目录，而不是只存在于报告里。