ğŸ›  Cursor ä¿®å¤æŒ‡ä»¤ï¼šå½»åº•è§£å†³ emailVerified è§†å›¾æ’å…¥å¤±è´¥

ç›®æ ‡ï¼š

ä¸å†ä¾èµ–å¤æ‚è¡¨è¾¾å¼å’Œè§¦å‘å™¨ã€‚

è®© NextAuth çš„ KyselyAdapter èƒ½ç›´æ¥å¯¹ "User" è§†å›¾åš INSERT / UPDATEã€‚

ä¿æŒä¸ NextAuth é¢„æœŸçš„ç±»å‹ä¸€è‡´ï¼šemailVerified = æ—¶é—´æˆ³ï¼ˆtimestamp / timestamptzï¼‰ï¼Œè€Œä¸æ˜¯ booleanã€‚

0. è§„èŒƒçº¦æŸå£°æ˜ï¼ˆå¿…é¡»éµå®ˆï¼‰

æœ¬ä»»åŠ¡å—ä»¥ä¸‹è§„èŒƒçº¦æŸï¼š

A1ï¼šè·¯ç”±å±‚ç¦æ­¢æ‰¿è½½ä¸šåŠ¡é€»è¾‘ï¼ˆä¸å¾—åœ¨ route.ts é‡Œåšä»»ä½• hack ç»•è¿‡ DBï¼‰ã€‚

B1 / B2ï¼šæ‰€æœ‰ DB ç»“æ„å˜æ›´å¿…é¡»åŒæ­¥æ›´æ–° /æ•°æ®åº“ç»“æ„_DRIVEQUIZ.mdã€‚

D1ï¼šä»»åŠ¡ç»“æŸå¿…é¡»è¾“å‡ºæ‰§è¡ŒæŠ¥å‘Šï¼ˆCursor è‡ªå·±å¡«ï¼‰ã€‚

1. å…ˆæ£€æŸ¥å½“å‰ DB çŠ¶æ€ï¼ˆå†™åˆ°æ‰§è¡ŒæŠ¥å‘Šé‡Œï¼‰

åœ¨ Supabase / ç›®æ ‡æ•°æ®åº“ä¸Šæ‰§è¡Œä»¥ä¸‹ SQLï¼Œå¹¶æŠŠç»“æœå†™å…¥æ‰§è¡ŒæŠ¥å‘Šçš„ã€Œè¯Šæ–­éƒ¨åˆ†ã€ï¼š

-- 1.1 æŸ¥çœ‹ "User" è§†å›¾çš„å®šä¹‰
SELECT pg_get_viewdef('public."User"'::regclass, true);

-- 1.2 æŸ¥çœ‹å½“å‰ "User" è§†å›¾ä¸Šçš„è§¦å‘å™¨
SELECT trigger_name, event_manipulation, action_statement
FROM information_schema.triggers
WHERE event_object_table = 'User'
ORDER BY trigger_name;

-- 1.3 æŸ¥çœ‹åº•å±‚ users è¡¨å…³é”®å­—æ®µ
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'users'
  AND column_name IN ('phone_verified_at', 'email_verified_at', 'email_verified');


è¦æ±‚ï¼š

åœ¨æ‰§è¡ŒæŠ¥å‘Šé‡Œæ˜ç¡®è®°å½•ï¼š

å½“å‰ "User" è§†å›¾ä¸­ emailVerified æ˜¯ä»€ä¹ˆè¡¨è¾¾å¼ã€ä»€ä¹ˆç±»å‹ã€‚

"User" ä¸Šæ˜¯å¦å­˜åœ¨ INSTEAD OF INSERT/UPDATE è§¦å‘å™¨ã€‚

users è¡¨é‡Œä¸ â€œéªŒè¯æ—¶é—´â€ ç›¸å…³çš„å­—æ®µæœ‰å“ªäº›ã€ç±»å‹æ˜¯ä»€ä¹ˆã€‚

2. è®¾è®¡ç»Ÿä¸€æ–¹æ¡ˆï¼ˆæŒ‡ä»¤ï¼‰

æˆ‘ä»¬ç°åœ¨ç®€åŒ– & çº åä¹‹å‰çš„è®¾è®¡ï¼š

NextAuth é¢„æœŸ

User.emailVerified ç±»å‹ï¼šæ—¶é—´æˆ³ï¼ˆDate | nullï¼‰ï¼Œè¡¨ç¤ºã€Œé‚®ç®±éªŒè¯æ—¶é—´ã€ã€‚

DriveQuiz å®é™…

ä¹‹å‰è¯•å›¾ç”¨ phone_verified_atï¼ˆtimestamptzï¼‰æ¥æ˜ å°„åˆ° emailVerifiedï¼Œä½†ä¸­é—´æ…å…¥äº† boolean è¡¨è¾¾å¼ + è§¦å‘å™¨ï¼Œå¯¼è‡´è§†å›¾ä¸å¯å†™ã€‚

æ–°çš„ç»Ÿä¸€ç­–ç•¥

ä¿ç•™ã€Œç”¨æŸä¸ªæ—¶é—´æˆ³å­—æ®µä»£è¡¨ emailVerifiedã€çš„æ€è·¯ï¼Œä½†å¿…é¡»æ˜¯ç›´æ¥åˆ—æ˜ å°„ï¼Œä¸èƒ½å†ç”¨è¡¨è¾¾å¼ã€‚

ä¸å†ä½¿ç”¨ INSTEAD OF è§¦å‘å™¨ï¼Œç›´æ¥ç”¨ PostgreSQL çš„ã€Œå¯æ›´æ–°è§†å›¾ã€èƒ½åŠ›ã€‚

çº¦å®šï¼š
è‹¥ users è¡¨å­˜åœ¨ phone_verified_at timestamptzï¼Œåˆ™ç”¨å®ƒç›´æ¥æ˜ å°„æˆ emailVerifiedï¼›
è‹¥ä¸å­˜åœ¨ï¼Œåˆ™æ–°å¢ email_verified_at timestamptzï¼Œå¹¶æ˜ å°„è¯¥å­—æ®µã€‚

3. ç¼–å†™ & è°ƒæ•´è¿ç§»è„šæœ¬
3.1 æ–°å¢æˆ–è°ƒæ•´åº•å±‚æ—¶é—´æˆ³åˆ—

åœ¨ src/migrations æ–°å¢ä¸€ä¸ªè¿ç§»æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š

20251126_fix_user_view_emailverified_timestamp.sql

å†…å®¹ç¤ºä¾‹ï¼ˆCursor æŒ‰å®é™…å­—æ®µåå¾®è°ƒï¼‰ï¼š

BEGIN;

-- 3.1.1 å¦‚æœæ²¡æœ‰ phone_verified_at / email_verified_atï¼Œå°±è¡¥ä¸Šä¸€ä¸ª email_verified_at
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'users' AND column_name = 'phone_verified_at'
  ) AND NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'users' AND column_name = 'email_verified_at'
  ) THEN
    ALTER TABLE users
      ADD COLUMN email_verified_at timestamptz NULL;
  END IF;
END;
$$;

-- 3.1.2 å¦‚æœåªæœ‰ phone_verified_at æ²¡æœ‰ email_verified_atï¼Œå°±æ²¿ç”¨ phone_verified_at åšæ˜ å°„
-- åé¢è§†å›¾é‡Œç»Ÿä¸€å†™æˆï¼šphone_verified_at AS "emailVerified"

COMMIT;


è¯´æ˜ï¼š

å¦‚æœåç»­å‘ç° users è¡¨å·²ç»æœ‰ email_verified_at ä¸”ä¸šåŠ¡ä¸Šæ›´åˆç†ï¼Œä¹Ÿå¯ä»¥åœ¨è¿™ä¸ªè„šæœ¬é‡ŒæŠŠè§†å›¾æ˜ å°„æ”¹ä¸º email_verified_at AS "emailVerified"ã€‚

3.2 ç»Ÿä¸€é‡å»º "User" è§†å›¾ï¼ˆå…³é”®ï¼‰

åœ¨ åŒä¸€ä¸ªè¿ç§»è„šæœ¬ ä¸­ï¼ˆæˆ–è€…å•ç‹¬è„šæœ¬ï¼Œæ³¨æ„é¡ºåºï¼‰ï¼Œé‡å»ºè§†å›¾ï¼Œåˆ æ‰æ‰€æœ‰è§¦å‘å™¨çš„ä¾èµ–ï¼š

BEGIN;

-- 3.2.1 åˆ é™¤è€è§†å›¾ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
DROP VIEW IF EXISTS "User" CASCADE;

-- 3.2.2 ä½¿ç”¨ã€Œå¯æ›´æ–°è§†å›¾ã€çš„å½¢å¼é‡å»º
-- è¿™é‡Œç”¨ phone_verified_at æ˜ å°„æˆ emailVerifiedï¼ˆtimestamp ç±»å‹ï¼‰
CREATE VIEW "User" AS
SELECT
  u.id,
  u.name,
  u.email,
  u.phone_verified_at AS "emailVerified",  -- ç›´æ¥åˆ—æ˜ å°„ï¼šç±»å‹ä¸º timestamptz
  u.image,
  u.created_at AS "createdAt",
  u.updated_at AS "updatedAt"
FROM users u;

COMMIT;


æ³¨æ„ç‚¹ï¼š

è§†å›¾å®šä¹‰ä¸­ï¼Œ"emailVerified" å¿…é¡»æ˜¯ ç›´æ¥åˆ—å¼•ç”¨ï¼šu.xxx AS "emailVerified"ï¼Œä¸è¦å†ç”¨ä»»ä½•è¡¨è¾¾å¼ï¼ˆCOALESCEã€::boolean ç­‰ï¼‰ã€‚

è¿™æ · PostgreSQL ä¼šæŠŠ "User" è§†å›¾å½“ä½œã€Œå¯æ›´æ–°è§†å›¾ã€ï¼Œå…è®¸å¯¹ emailVerified åš INSERT/UPDATEã€‚

ä¹Ÿä¸å†éœ€è¦ INSTEAD OF è§¦å‘å™¨ã€‚

3.3 ç§»é™¤æ—§çš„è§¦å‘å™¨ & å‡½æ•°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

åœ¨åŒä¸€ä¸ªè¿ç§»æ–‡ä»¶é‡Œï¼Œå®‰å…¨æ¸…ç†æ®‹ç•™çš„è§¦å‘å™¨ä¸å‡½æ•°ï¼š

BEGIN;

-- åˆ é™¤è§†å›¾ä¸Šçš„è§¦å‘å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
DO $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM pg_trigger
    WHERE tgrelid = 'public."User"'::regclass
      AND tgname = 'user_view_insert'
  ) THEN
    DROP TRIGGER user_view_insert ON "User";
  END IF;

  IF EXISTS (
    SELECT 1 FROM pg_trigger
    WHERE tgrelid = 'public."User"'::regclass
      AND tgname = 'user_view_update'
  ) THEN
    DROP TRIGGER user_view_update ON "User";
  END IF;
END;
$$;

-- åˆ é™¤æ—§çš„å‡½æ•°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
DROP FUNCTION IF EXISTS user_view_insert() CASCADE;
DROP FUNCTION IF EXISTS user_view_update() CASCADE;

COMMIT;

4. åŒæ­¥æ›´æ–°æ–‡æ¡£ & ç±»å‹å®šä¹‰
4.1 æ›´æ–°æ•°æ®åº“ç»“æ„æ–‡æ¡£

æ–‡ä»¶ï¼š/Users/leo/Desktop/drivequizç ”å‘è§„èŒƒ/æ•°æ®åº“ç»“æ„_DRIVEQUIZ.md

è¦æ±‚ Cursor ä¿®æ”¹ / æ–°å¢ï¼š

åœ¨ã€ŒUser è§†å›¾ã€å°èŠ‚ä¸­ï¼Œæ˜ç¡®å†™å‡ºæœ€æ–°å®šä¹‰ï¼Œä¾‹å¦‚ï¼ˆä¼ªæ–‡æ¡£ï¼‰ï¼š

è§†å›¾ "User"ï¼š

id: uuid

name: text

email: text

emailVerified: timestamptz, æ˜ å°„è‡ª users.phone_verified_at

image: text

createdAt: timestamptz, æ˜ å°„è‡ª users.created_at

updatedAt: timestamptz, æ˜ å°„è‡ª users.updated_at

åœ¨ã€Œå­—æ®µæ˜ å°„å…³ç³»ã€è¯´æ˜ä¸­ï¼Œæ˜ç¡®å†™å‡ºï¼š

User.emailVerified â†” users.phone_verified_atï¼ˆæ—¶é—´æˆ³ï¼Œè¡¨ç¤ºéªŒè¯æ—¶é—´ï¼‰ã€‚

ä¸å†é€šè¿‡ boolean è¡¨è¾¾å¼è®¡ç®—ï¼Œä¸å†ä½¿ç”¨è§†å›¾è§¦å‘å™¨ã€‚

æ–‡æ¡£ç‰ˆæœ¬å· + æ›´æ–°æ—¶é—´æŒ‰ä½ ä»¬æ—¢å®šè§„åˆ™é€’å¢ã€‚

4.2 æ›´æ–° Kysely ç±»å‹å®šä¹‰ï¼ˆè‹¥æœ‰ï¼‰

æ‰¾åˆ° DB ç±»å‹å®šä¹‰ï¼ˆä¾‹å¦‚ src/lib/db/types.ts æˆ–ç±»ä¼¼æ–‡ä»¶ï¼‰ï¼Œæ£€æŸ¥ "User" çš„ç±»å‹ï¼š

ç¡®ä¿ emailVerified è¢«å®šä¹‰ä¸º Date | nullï¼ˆæˆ–å¯¹åº”çš„ ColumnType<Date, Date | null, Date | null>ï¼‰ï¼Œè€Œä¸æ˜¯ booleanã€‚

ç¡®è®¤ User è¡¨/è§†å›¾çš„åˆ—åå¤§å°å†™ä¸ NextAuth KyselyAdapter ä½¿ç”¨çš„ä¸€è‡´ï¼šid, name, email, emailVerified, image, createdAt, updatedAtã€‚

5. æœ¬åœ°æ‰§è¡Œè¿ç§» & å›å½’æµ‹è¯•ï¼ˆCursor åœ¨æŠ¥å‘Šä¸­å†™æ­¥éª¤ï¼‰

è¿è¡Œè¿ç§»ï¼ˆæŒ‰ä½ ä»¬é¡¹ç›®å‘½ä»¤ï¼Œæ¯”å¦‚ï¼‰ï¼š

pnpm db:migrate
# æˆ–
npm run db:migrate


é‡å¯ dev serverï¼š

pnpm dev
# æˆ– npm run dev


æ‰‹åŠ¨æµ‹è¯•ï¼š

æ‰“å¼€ /api/auth/signin/lineï¼Œç”¨ LINE ç™»å½•ä¸€æ¬¡ã€‚

æœŸæœ›ç»“æœï¼š

ä¸å†å‡ºç° cannot insert into column "emailVerified" of view "User"ã€‚

å¯ä»¥æˆåŠŸåˆ›å»º/ç™»å½•ç”¨æˆ·ã€‚

å†ç”¨ Google ç™»å½•åšä¸€æ¬¡å›å½’æµ‹è¯•ï¼Œç¡®è®¤æ—§é€»è¾‘ä¸å—å½±å“ã€‚

6. æ‰§è¡ŒæŠ¥å‘Šè¦æ±‚ï¼ˆç»™ Cursorï¼‰

è¯· Cursor åœ¨è¿™æ¬¡ä»»åŠ¡ç»“æŸæ—¶æŒ‰ç°æœ‰æ¨¡æ¿è¡¥ä¸€ä»½æ‰§è¡ŒæŠ¥å‘Šï¼Œé‡ç‚¹åŒ…å«ï¼š

ã€Œé—®é¢˜ç¡®è®¤ã€ï¼šæ˜ç¡®å†™å‡ºè¿™æ˜¯æ—§é—®é¢˜æœªä¿®å¤ï¼Œè€Œä¸æ˜¯æ–°é—®é¢˜ã€‚

ã€Œè¯Šæ–­ç»“æœã€ï¼šè´´å‡ºä¹‹å‰è§†å›¾å®šä¹‰å’Œè§¦å‘å™¨æ£€æŸ¥çš„ç»“æœã€‚

ã€Œå˜æ›´å†…å®¹ã€ï¼šåˆ—å‡ºæ–°è¿ç§»æ–‡ä»¶åã€å…³é”® SQLã€è§†å›¾æ–°å®šä¹‰ã€‚

ã€ŒéªŒè¯ç»“æœã€ï¼šè¯´æ˜ LINE ç™»å½• / Google ç™»å½•æµ‹è¯•æ˜¯å¦é€šè¿‡ã€‚

ã€Œè§„èŒƒå¯¹ç…§ã€ï¼šA1 / B1 / B2 / D1 é€æ¡æ‰“å‹¾ã€‚