# ä¿®å¤ NearbyPage React Key é‡å¤é”™è¯¯_æ‰§è¡ŒæŠ¥å‘Š

**æŠ¥å‘Šæ—¥æœŸ**: 2025-11-29  
**ä»»åŠ¡åç§°**: ä¿®å¤ NearbyPage ä¸­ React Key é‡å¤é”™è¯¯  
**ç‰ˆæœ¬å·**: 2025-11-29 11:36:08

---

## ğŸ“Œ ä»»åŠ¡æ‘˜è¦

ä¿®å¤ NearbyPage ç»„ä»¶ä¸­ React é”™è¯¯ï¼š`Encountered two children with the same key, [object Object]`ã€‚è¯¥é”™è¯¯æ˜¯ç”±äºåˆ†ç±»åç§°ï¼ˆ`name`ï¼‰å­—æ®µæ˜¯å¤šè¯­è¨€å¯¹è±¡æ ¼å¼ï¼ˆ`{zh, en, ja}`ï¼‰ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²ï¼Œå¯¼è‡´åœ¨ `map` ä¸­ä½¿ç”¨å¯¹è±¡ä½œä¸º key æ—¶ï¼ŒReact å°†å…¶è½¬æ¢ä¸ºå­—ç¬¦ä¸² `[object Object]`ï¼Œä»è€Œäº§ç”Ÿé‡å¤çš„ keyã€‚

---

## ğŸ“Œ ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨

1. **src/app/nearby/NearbyPage.tsx**
   - æ›´æ–° `MerchantCategory` ç±»å‹å®šä¹‰ï¼Œ`name` å­—æ®µæ”¯æŒå¤šè¯­è¨€å¯¹è±¡æ ¼å¼
   - ä¿®å¤åˆ†ç±»ç­›é€‰æŒ‰é’®çš„ key ä½¿ç”¨ï¼Œä» `category.name`ï¼ˆå¯¹è±¡ï¼‰æ”¹ä¸º `category.id`ï¼ˆæ•°å­—ï¼‰
   - æ·»åŠ  `getMultilangContent` å¯¼å…¥ï¼Œç”¨äºå¤„ç†å¤šè¯­è¨€å†…å®¹
   - ä¿®å¤åˆ†ç±»åç§°æ˜¾ç¤ºé€»è¾‘ï¼Œä½¿ç”¨ `getMultilangContent` æ­£ç¡®æ˜¾ç¤ºå¤šè¯­è¨€å†…å®¹
   - ä¿®å¤åˆ†ç±»é€‰æ‹©é€»è¾‘ï¼Œä½¿ç”¨ `selectedCategoryId`ï¼ˆæ•°å­—ï¼‰æ›¿ä»£ `selectedCategory`ï¼ˆå­—ç¬¦ä¸²ï¼‰
   - ä¼˜åŒ–å•†æˆ·åŠ è½½é€»è¾‘ï¼Œæ·»åŠ  `loadMerchantsByCategoryName` å‡½æ•°
   - ä¿®å¤åˆå§‹åŠ è½½é€»è¾‘ï¼Œç¡®ä¿æ­£ç¡®åŠ è½½ç¬¬ä¸€ä¸ªåˆ†ç±»çš„å•†æˆ·

2. **src/lib/version.ts**
   - æ›´æ–°ç‰ˆæœ¬å·ä¸º `2025-11-29 11:36:08`

---

## ğŸ“Œ é€æ¡çº¢çº¿è§„èŒƒè‡ªæ£€ï¼ˆA1â€“D2ï¼‰

### ğŸ”´ A. æ¶æ„çº¢çº¿

| ç¼–å· | è§„åˆ™ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|------|
| A1 | è·¯ç”±å±‚ç¦æ­¢æ‰¿è½½ä¸šåŠ¡é€»è¾‘ | âœ… å·²éµå®ˆ | æœ¬æ¬¡ä¿®æ”¹ä»…æ¶‰åŠå‰ç«¯ç»„ä»¶æ¸²æŸ“é€»è¾‘ï¼Œä¸æ¶‰åŠè·¯ç”±å±‚ä¸šåŠ¡é€»è¾‘ |
| A2 | æ‰€æœ‰æ ¸å¿ƒé€»è¾‘å¿…é¡»å†™å…¥ ai-core | âšª ä¸é€‚ç”¨ | æœ¬æ¬¡ä»»åŠ¡ä¸æ¶‰åŠ AI åŠŸèƒ½ |
| A3 | ai-service ä¸ local-ai-service è¡Œä¸ºå¿…é¡»ä¿æŒå®Œå…¨ä¸€è‡´ | âšª ä¸é€‚ç”¨ | æœ¬æ¬¡ä»»åŠ¡ä¸æ¶‰åŠ AI æœåŠ¡ |
| A4 | æ¥å£å‚æ•°ã€è¿”å›ç»“æ„å¿…é¡»ä¿æŒç»Ÿä¸€ | âœ… å·²éµå®ˆ | æœ¬æ¬¡ä¿®æ”¹ä¸å½±å“æ¥å£ç»“æ„ï¼Œä»…ä¿®å¤å‰ç«¯æ¸²æŸ“é€»è¾‘ |

### ğŸ”´ B. æ•°æ®åº“ & æ–‡ä»¶ç»“æ„çº¢çº¿

| ç¼–å· | è§„åˆ™ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|------|
| B1 | ä»»ä½•æ•°æ®åº“å­—æ®µã€è¡¨ç»“æ„ã€ç´¢å¼•çš„ä¿®æ”¹å¿…é¡»åŒæ­¥æ›´æ–°æ•°æ®åº“ç»“æ„æ–‡æ¡£ | âšª ä¸é€‚ç”¨ | æœ¬æ¬¡ä»»åŠ¡ä¸æ¶‰åŠæ•°æ®åº“ç»“æ„ä¿®æ”¹ |
| B2 | æ‰€æœ‰æ–‡ä»¶æ–°å¢ã€åˆ é™¤ã€è¿ç§»å¿…é¡»åŒæ­¥æ›´æ–°æ–‡ä»¶ç»“æ„æ–‡æ¡£ | âšª ä¸é€‚ç”¨ | æœ¬æ¬¡ä»»åŠ¡æœªæ–°å¢ã€åˆ é™¤æˆ–è¿ç§»æ–‡ä»¶ |
| B3 | æ‰€æœ‰ Kysely ç±»å‹å®šä¹‰å¿…é¡»ä¸æ•°æ®åº“ç»“æ„åŒæ­¥ä¿æŒä¸€è‡´ | âšª ä¸é€‚ç”¨ | æœ¬æ¬¡ä»»åŠ¡ä¸æ¶‰åŠæ•°æ®åº“ç±»å‹å®šä¹‰ |
| B4 | DriveQuiz ä¸»åº“ä¸ AI Service åº“çš„ schema éœ€ä¿æŒæ–‡æ¡£åŒæ­¥ | âšª ä¸é€‚ç”¨ | æœ¬æ¬¡ä»»åŠ¡ä¸æ¶‰åŠæ•°æ®åº“ schema ä¿®æ”¹ |

### ğŸ”´ C. æµ‹è¯•çº¢çº¿ï¼ˆAI è°ƒç”¨å¿…é¡»åŒç¯å¢ƒæµ‹è¯•ï¼‰

| ç¼–å· | è§„åˆ™ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|------|
| C1 | æ¶‰åŠ AI åŠŸèƒ½å¿…é¡»åŒæ—¶æµ‹è¯•ï¼šlocal-ai-service & è¿œç¨‹ ai-service | âšª ä¸é€‚ç”¨ | æœ¬æ¬¡ä»»åŠ¡ä¸æ¶‰åŠ AI åŠŸèƒ½ |
| C2 | å¿…é¡»è¾“å‡ºæµ‹è¯•æ—¥å¿—æ‘˜è¦ï¼ˆè¯·æ±‚ã€å“åº”ã€è€—æ—¶ã€é”™è¯¯ï¼‰ | âšª ä¸é€‚ç”¨ | æœ¬æ¬¡ä»»åŠ¡ä¸æ¶‰åŠ AI è°ƒç”¨ |
| C3 | è‹¥æµ‹è¯•å¤±è´¥ï¼Œå¿…é¡»ä¸»åŠ¨ç»§ç»­æ’æŸ¥ï¼Œä¸å¾—è¦æ±‚ç”¨æˆ·æ‰‹åŠ¨é‡è¯• | âšª ä¸é€‚ç”¨ | æœ¬æ¬¡ä»»åŠ¡ä¸æ¶‰åŠ AI è°ƒç”¨æµ‹è¯• |

### ğŸ”´ D. æ‰§è¡ŒæŠ¥å‘Šçº¢çº¿ï¼ˆæœ€ç»ˆå¿…é¡»è¾“å‡ºï¼‰

| ç¼–å· | è§„åˆ™ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|------|
| D1 | ä»»åŠ¡ç»“æŸå¿…é¡»æŒ‰æ¨¡æ¿è¾“å‡ºå®Œæ•´æ‰§è¡ŒæŠ¥å‘Š | âœ… å·²éµå®ˆ | æœ¬æŠ¥å‘Šå³ä¸ºå®Œæ•´æ‰§è¡ŒæŠ¥å‘Š |
| D2 | å¿…é¡»é€æ¡å¯¹ç…§ A1â€“D2ï¼Œæ ‡æ³¨"å·²éµå®ˆ / ä¸é€‚ç”¨ / å¿…é¡»ä¿®å¤" | âœ… å·²éµå®ˆ | å·²é€æ¡å¯¹ç…§å¹¶æ ‡æ³¨çŠ¶æ€ |

### ğŸ”´ E. æ¸…é™¤å†—ä½™å’Œè‚¥èƒ–ä»£ç 

| ç¼–å· | è§„åˆ™ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|------|
| E1 | åˆ é™¤ç›®æ ‡åŠŸèƒ½æµç¨‹ä¸­æ®‹ç•™çš„æ— ç”¨è°ƒè¯•ä»£ç ã€é‡å¤æ—¥å¿—ã€æœªå†ä½¿ç”¨çš„è¾…åŠ©å‡½æ•° | âœ… å·²éµå®ˆ | æœ¬æ¬¡ä¿®æ”¹æœªå¼•å…¥å†—ä½™ä»£ç  |
| E2 | ç§»é™¤å†—ä½™/è¿‡æ—¶ä»£ç ï¼Œä¿è¯ç›®æ ‡åŠŸèƒ½æµç¨‹ç»“æ„ç®€æ´ã€èŒè´£å•ä¸€ | âœ… å·²éµå®ˆ | æœ¬æ¬¡ä¿®æ”¹ä¼˜åŒ–äº†ä»£ç ç»“æ„ï¼Œæœªå¼•å…¥å†—ä½™ä»£ç  |

---

## ğŸ“Œ é—®é¢˜åˆ†æ

### é”™è¯¯ä¿¡æ¯

```
Encountered two children with the same key, `[object Object]`. Keys should be unique so that components maintain their identity across updates.
```

### æ ¹æœ¬åŸå› 

1. **API è¿”å›æ ¼å¼é—®é¢˜**ï¼š
   - `/api/merchant-categories` è¿”å›çš„ `name` å­—æ®µæ˜¯å¤šè¯­è¨€å¯¹è±¡æ ¼å¼ï¼ˆ`{zh: "...", en: "...", ja: "..."}`ï¼‰ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²
   - ä»£ç ä¸­ `MerchantCategory` ç±»å‹å®šä¹‰ `name` ä¸º `string`ï¼Œä¸å®é™…æ•°æ®æ ¼å¼ä¸åŒ¹é…

2. **Key ä½¿ç”¨é”™è¯¯**ï¼š
   - åœ¨ `allCategories.map(category => ...)` ä¸­ï¼Œ`category` æ˜¯ `cat.name`ï¼ˆå¤šè¯­è¨€å¯¹è±¡ï¼‰
   - ä½¿ç”¨ `key={category}` æ—¶ï¼ŒReact å°†å¯¹è±¡è½¬æ¢ä¸ºå­—ç¬¦ä¸² `[object Object]`
   - å¤šä¸ªåˆ†ç±»éƒ½ä½¿ç”¨ç›¸åŒçš„ keyï¼Œå¯¼è‡´ React æŠ¥é”™

3. **ç±»å‹å®šä¹‰ä¸å‡†ç¡®**ï¼š
   - `MerchantCategory` ç±»å‹å®šä¹‰ä¸­ `name` å­—æ®µç±»å‹ä¸º `string`ï¼Œä½†å®é™…æ˜¯å¤šè¯­è¨€å¯¹è±¡

### ä¿®å¤æ–¹æ¡ˆ

1. **æ›´æ–°ç±»å‹å®šä¹‰**ï¼š
   - å°† `MerchantCategory.name` ç±»å‹æ›´æ–°ä¸º `string | { zh?: string; en?: string; ja?: string; default?: string }`

2. **ä¿®å¤ Key ä½¿ç”¨**ï¼š
   - ä½¿ç”¨ `category.id` ä½œä¸º keyï¼Œè€Œä¸æ˜¯ `category.name`
   - `id` æ˜¯æ•°å­—ï¼Œä¿è¯å”¯ä¸€æ€§

3. **ä¿®å¤å¤šè¯­è¨€æ˜¾ç¤º**ï¼š
   - ä½¿ç”¨ `getMultilangContent` å‡½æ•°å¤„ç†å¤šè¯­è¨€å¯¹è±¡
   - ç¡®ä¿æ˜¾ç¤ºçš„æ˜¯å­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯å¯¹è±¡

4. **ä¼˜åŒ–é€‰æ‹©é€»è¾‘**ï¼š
   - ä½¿ç”¨ `selectedCategoryId`ï¼ˆæ•°å­—ï¼‰æ›¿ä»£ `selectedCategory`ï¼ˆå­—ç¬¦ä¸²ï¼‰
   - ç®€åŒ–åˆ†ç±»é€‰æ‹©å’Œæ¯”è¾ƒé€»è¾‘

---

## ğŸ“Œ ä¿®æ”¹è¯¦æƒ…

### 1. ç±»å‹å®šä¹‰æ›´æ–°

**ä¿®æ”¹å‰**ï¼š
```typescript
type MerchantCategory = {
  id: number;
  name: string;
  displayOrder: number;
};
```

**ä¿®æ”¹å**ï¼š
```typescript
type MerchantCategory = {
  id: number;
  name: string | { zh?: string; en?: string; ja?: string; default?: string };
  displayOrder: number;
};
```

### 2. å¯¼å…¥å¤šè¯­è¨€å·¥å…·å‡½æ•°

**æ–°å¢**ï¼š
```typescript
import { getMultilangContent } from '@/lib/multilangUtils';
```

### 3. çŠ¶æ€ç®¡ç†æ›´æ–°

**ä¿®æ”¹å‰**ï¼š
```typescript
const [selectedCategory, setSelectedCategory] = useState<string>('');
```

**ä¿®æ”¹å**ï¼š
```typescript
const [selectedCategoryId, setSelectedCategoryId] = useState<number | null>(null);
```

### 4. åˆ†ç±»ç­›é€‰æŒ‰é’®ä¿®å¤

**ä¿®æ”¹å‰**ï¼š
```typescript
const allCategories = categories.map(cat => cat.name);

{allCategories.map(category => (
  <button
    key={category}  // âŒ category æ˜¯å¯¹è±¡ï¼Œè½¬æ¢ä¸º [object Object]
    onClick={() => handleCategoryChange(category)}
    className={...}
  >
    {category}  // âŒ ç›´æ¥æ¸²æŸ“å¯¹è±¡
  </button>
))}
```

**ä¿®æ”¹å**ï¼š
```typescript
{categories.map(category => {
  const categoryName = typeof category.name === 'string' 
    ? category.name 
    : getMultilangContent(category.name, language, '');
  const isSelected = selectedCategoryId === category.id;
  
  return (
    <button
      key={category.id}  // âœ… ä½¿ç”¨æ•°å­— ID ä½œä¸º key
      onClick={() => handleCategoryChange(category.id)}
      className={...}
    >
      {categoryName}  // âœ… æ˜¾ç¤ºå­—ç¬¦ä¸²
    </button>
  );
})}
```

### 5. å•†æˆ·åŠ è½½é€»è¾‘ä¼˜åŒ–

**æ–°å¢å‡½æ•°**ï¼š
```typescript
const loadMerchantsByCategoryName = async (categoryName: string) => {
  try {
    const url = `/api/merchants?category=${encodeURIComponent(categoryName)}`;
    const res = await fetch(url);
    if (res.ok) {
      const data = await res.json();
      if (data.ok) {
        setMerchants(data.data.items || []);
      }
    }
  } catch (error) {
    console.error('åŠ è½½å•†æˆ·å¤±è´¥:', error);
  }
};
```

**ä¼˜åŒ–åçš„ loadMerchants**ï¼š
```typescript
const loadMerchants = async (categoryId?: number | null) => {
  try {
    if (categoryId !== null && categoryId !== undefined) {
      const category = categories.find(cat => cat.id === categoryId);
      if (category) {
        const categoryName = typeof category.name === 'string' 
          ? category.name 
          : getMultilangContent(category.name, language, '');
        if (categoryName) {
          await loadMerchantsByCategoryName(categoryName);
          return;
        }
      }
    }
    // åŠ è½½æ‰€æœ‰å•†æˆ·
    const res = await fetch('/api/merchants');
    // ...
  } catch (error) {
    console.error('åŠ è½½å•†æˆ·å¤±è´¥:', error);
  }
};
```

---

## ğŸ“Œ æµ‹è¯•ç»“æœ

### å‰ç«¯ç»„ä»¶æµ‹è¯•

**æµ‹è¯•ç¯å¢ƒ**ï¼š
- Next.js 15.5.6
- React 18+
- TypeScript

**æµ‹è¯•é¡¹**ï¼š
1. âœ… ç±»å‹æ£€æŸ¥é€šè¿‡ï¼ˆæ—  TypeScript é”™è¯¯ï¼‰
2. âœ… Lint æ£€æŸ¥é€šè¿‡ï¼ˆæ—  ESLint é”™è¯¯ï¼‰
3. âœ… åˆ†ç±»ç­›é€‰æŒ‰é’®æ­£å¸¸æ¸²æŸ“ï¼Œæ—  key é‡å¤é”™è¯¯
4. âœ… åˆ†ç±»åç§°æ­£ç¡®æ˜¾ç¤ºï¼ˆæ”¯æŒå¤šè¯­è¨€ï¼‰
5. âœ… åˆ†ç±»é€‰æ‹©åŠŸèƒ½æ­£å¸¸
6. âœ… å•†æˆ·åˆ—è¡¨åŠ è½½æ­£å¸¸

**æµ‹è¯•åœºæ™¯**ï¼š
- âœ… åˆ†ç±»åç§°ä¸ºå­—ç¬¦ä¸²æ ¼å¼
- âœ… åˆ†ç±»åç§°ä¸ºå¤šè¯­è¨€å¯¹è±¡æ ¼å¼ï¼ˆåŒ…å« zh, en, jaï¼‰
- âœ… åˆ†ç±»åç§°ä¸ºå¤šè¯­è¨€å¯¹è±¡æ ¼å¼ï¼ˆä¸åŒ…å«æŸäº›è¯­è¨€ï¼‰
- âœ… åˆ‡æ¢åˆ†ç±»æ—¶å•†æˆ·åˆ—è¡¨æ­£ç¡®æ›´æ–°
- âœ… åˆå§‹åŠ è½½æ—¶æ­£ç¡®æ˜¾ç¤ºç¬¬ä¸€ä¸ªåˆ†ç±»çš„å•†æˆ·

---

## ğŸ“Œ è¿ç§»è„šæœ¬

**ä¸é€‚ç”¨**ï¼šæœ¬æ¬¡ä»»åŠ¡ä¸æ¶‰åŠæ•°æ®åº“è¿ç§»ã€‚

---

## ğŸ“Œ æ›´æ–°åçš„æ–‡æ¡£

**ä¸é€‚ç”¨**ï¼šæœ¬æ¬¡ä»»åŠ¡ä¸æ¶‰åŠæ•°æ®åº“ç»“æ„æˆ–æ–‡ä»¶ç»“æ„çš„ä¿®æ”¹ã€‚

---

## ğŸ“Œ é£é™©ç‚¹ä¸ä¸‹ä¸€æ­¥å»ºè®®

### é£é™©ç‚¹

1. **æ€§èƒ½å½±å“**ï¼šæ·»åŠ äº†å¤šè¯­è¨€å†…å®¹å¤„ç†ï¼Œä½†å½±å“å¾®ä¹å…¶å¾®
2. **å…¼å®¹æ€§**ï¼šä¿®æ”¹åçš„ä»£ç å®Œå…¨å‘åå…¼å®¹ï¼Œæ”¯æŒæ—§æ ¼å¼ï¼ˆå­—ç¬¦ä¸²ï¼‰å’Œæ–°æ ¼å¼ï¼ˆå¤šè¯­è¨€å¯¹è±¡ï¼‰

### ä¸‹ä¸€æ­¥å»ºè®®

1. **ä»£ç å®¡æŸ¥**ï¼šå»ºè®®å®¡æŸ¥å…¶ä»–å¯èƒ½å­˜åœ¨ç±»ä¼¼é—®é¢˜çš„ç»„ä»¶ï¼ˆå¦‚ CarsPageã€StudyPage ç­‰ï¼‰
2. **ç±»å‹å®šä¹‰**ï¼šå»ºè®®å®Œå–„æ‰€æœ‰å¤šè¯­è¨€å­—æ®µçš„ç±»å‹å®šä¹‰ï¼Œç¡®ä¿ç±»å‹å®‰å…¨
3. **å•å…ƒæµ‹è¯•**ï¼šå»ºè®®ä¸ºå¤šè¯­è¨€å†…å®¹å¤„ç†æ·»åŠ å•å…ƒæµ‹è¯•

---

## ğŸ“Œ æ€»ç»“

æœ¬æ¬¡ä¿®å¤æˆåŠŸè§£å†³äº† NearbyPage ç»„ä»¶ä¸­ React key é‡å¤é”™è¯¯çš„é—®é¢˜ã€‚é€šè¿‡ä½¿ç”¨åˆ†ç±» ID ä½œä¸º keyï¼Œå¹¶æ­£ç¡®å¤„ç†å¤šè¯­è¨€å¯¹è±¡æ ¼å¼çš„åˆ†ç±»åç§°ï¼Œç¡®ä¿äº†ç»„ä»¶çš„æ­£ç¡®æ¸²æŸ“å’ŒåŠŸèƒ½æ­£å¸¸è¿è¡Œã€‚

**å½“å‰ç‰ˆæœ¬å·**: 2025-11-29 11:36:08

**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ

