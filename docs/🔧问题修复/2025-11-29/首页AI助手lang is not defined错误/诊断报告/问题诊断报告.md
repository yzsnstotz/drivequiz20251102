# 🔧 Cursor 问题诊断报告

**Issue ID**: CP-20251129-002  
**报告日期**: 2025-11-29  
**问题名称**: 首页AI助手en和ja语言下返回"lang is not defined"错误

---

## 📌 第一部分：问题概要（Summary）

| 字段 | 填写内容 |
|------|----------|
| 问题名称 | 首页AI助手在英文和日文设置下均回复"【Error】lang is not defined"和"【エラー】lang is not defined" |
| 问题等级 | **High** |
| 触发时间 | 2025-11-29（具体时间待确认） |
| 触发环境 | **production**（生产环境） |
| 相关模块 | **ai-service** / **web** |
| 当前状态 | **可复现** |

---

## 📌 第二部分：复现路径（Reproduce Steps）

### 前端操作步骤

1. 访问首页 AI 助手页面（`/ai`）
2. 将系统语言切换为英文（en）或日文（ja）
3. 在 AI 助手对话框中输入任意问题
4. 点击发送

### 触发点

- **页面**: `/ai`（首页 AI 助手页面）
- **组件**: `src/components/AIPage.tsx`
- **API 路由**: `/api/ai/chat` → `apps/ai-service/src/routes/ask.ts`

### 请求示例

```typescript
// 前端调用
await callAiDirect({
  provider: currentProvider,
  question: "用户问题",
  locale: "en-US", // 或 "ja-JP"
  scene: "chat",
  messages: historyMessages,
  maxHistory: 10,
  model: currentModel,
});
```

### 操作系统 / 浏览器 / Node 版本

- **环境**: 生产环境（Vercel）
- **浏览器**: 所有主流浏览器
- **Node 版本**: 生产环境配置

---

## 📌 第三部分：实际输出（Actual Behavior）

### 1. 前端日志

**错误响应内容**:
- **英文环境**: `【Error】lang is not defined`
- **日文环境**: `【エラー】lang is not defined`

### 2. 后端返回

**HTTP 状态码**: `200 OK`

**响应内容**:
```json
{
  "ok": true,
  "data": {
    "answer": "【Error】lang is not defined", // 或 "【エラー】lang is not defined"
    "model": "gpt-4o-mini",
    "safetyFlag": "ok"
  }
}
```

### 3. 服务器日志

**关键日志标识**:
- `[SCENE-RUNNER] 读取场景配置`
- `[SCENE-RUNNER] 场景配置读取成功`
- `[SCENE-RUNNER] 替换占位符前`
- `[SCENE-RUNNER] 替换占位符后`
- `[SCENE-RUNNER] 准备调用模型`

**注意**: 需要查看生产环境实际日志以确认具体内容。

### 4. 数据库查询结果

**诊断脚本执行结果**:
```bash
npx tsx scripts/test-ai-db-connection.ts
```

**查询结果**:
- ✅ 数据库连接成功
- ✅ 找到 chat 场景配置
- ✅ 日文 Prompt: 未包含 `{lang}` 占位符
- ✅ 英文 Prompt: 未包含 `{lang}` 占位符
- ✅ 配置内容与用户提供的标准配置一致

**完整配置内容**:

**日文 Prompt**:
```
あなたは ZALEM の運転免許学習アシスタントです。日本の交通法規と問題集の知識に基づいて、簡潔かつ正確に回答してください。推測や捏造は禁止し、関係のない内容は出力しないでください。運転免許に関連する質問には、日本の交通法規に基づいて回答してください。運転免許に関係のない質問には、丁寧に運転免許関連の質問のみに回答できることを説明してください。
```

**英文 Prompt**:
```
You are ZALEM's driving-test study assistant. Answer based on Japan's traffic laws and question bank. Be concise and accurate. Do not fabricate or include unrelated content. If users ask about driving test related questions, answer based on Japan's traffic laws. If questions are unrelated to driving tests, politely explain that you can only answer driving test related questions.
```

---

## 📌 第四部分：期望行为（Expected Behavior）

1. **正常响应**: AI 助手应该根据用户问题返回相关的驾驶考试学习内容
2. **语言匹配**: 响应语言应该与用户设置的语言一致（英文环境返回英文，日文环境返回日文）
3. **无错误信息**: 不应该返回 "lang is not defined" 这样的错误信息
4. **功能正常**: AI 助手应该能够正常理解并回答用户问题

---

## 📌 第五部分：代码定位（Code Snapshot）

### 1. 相关文件列表

**前端文件**:
- `src/components/AIPage.tsx` - 首页 AI 助手组件
- `src/lib/aiClient.front.ts` - 前端 AI 客户端

**后端文件**:
- `apps/ai-service/src/routes/ask.ts` - AI 服务主路由
- `apps/ai-service/src/lib/sceneRunner.ts` - 场景执行引擎（核心逻辑）

**数据库相关**:
- `src/lib/aiDb.ts` - AI 数据库连接
- `src/migrations/20251113_create_ai_scene_config.sql` - 场景配置表迁移脚本

### 2. 关键函数代码片段

#### 场景配置读取 (`apps/ai-service/src/lib/sceneRunner.ts`)

```typescript
export async function getSceneConfig(
  sceneKey: string,
  locale: string,
  config: { supabaseUrl: string; supabaseServiceKey: string },
  options?: { timeoutMs?: number }
): Promise<SceneConfig | null> {
  // 通过 Supabase REST API 查询场景配置
  const url = `${supabaseUrl.replace(/\/+$/, "")}/rest/v1/ai_scene_config?scene_key=eq.${encodeURIComponent(sceneKey)}&enabled=eq.true&select=system_prompt_zh,system_prompt_ja,system_prompt_en,output_format`;
  
  // 根据 locale 选择对应的 prompt
  const lang = locale.toLowerCase().trim();
  let prompt = sceneConfig.system_prompt_zh;
  
  if (lang.startsWith("ja") && sceneConfig.system_prompt_ja) {
    prompt = sceneConfig.system_prompt_ja;
  } else if (lang.startsWith("en") && sceneConfig.system_prompt_en) {
    prompt = sceneConfig.system_prompt_en;
  }
  
  return { prompt: finalPrompt, outputFormat: sceneConfig.output_format };
}
```

#### 占位符替换 (`apps/ai-service/src/lib/sceneRunner.ts`)

```typescript
export function replacePlaceholders(
  prompt: string,
  sourceLanguage?: string | null,
  targetLanguage?: string | null
): string {
  let result = prompt;
  
  // 只支持 {sourceLanguage} 和 {targetLanguage}
  if (sourceLanguage) {
    result = result.replace(/{sourceLanguage}/gi, sourceLanguage);
    result = result.replace(/{源语言}/g, sourceLanguage);
  }
  
  if (targetLanguage) {
    result = result.replace(/{targetLanguage}/gi, targetLanguage);
    result = result.replace(/{目标语言}/g, targetLanguage);
  }
  
  // ⚠️ 注意：不支持 {lang} 占位符
  return result;
}
```

#### 场景执行主函数 (`apps/ai-service/src/lib/sceneRunner.ts`)

```typescript
export async function runScene(options: RunSceneOptions): Promise<SceneResult> {
  // 1. 读取场景配置
  const sceneConfig = await getSceneConfig(sceneKey, locale, config, { timeoutMs });
  
  // 2. 替换占位符
  const sysPrompt = replacePlaceholders(sceneConfig.prompt, sourceLanguage || undefined, targetLanguage || undefined);
  
  // 3. 构建消息
  const messages = buildMessages({
    sysPrompt,
    userPrefix,
    question,
    refPrefix,
    reference,
    sceneKey,
  });
  
  // 4. 调用模型
  const modelResponse = await callModelWithProvider(providerKind, {
    model: actualModel,
    messages,
    responseFormat,
    // ...
  });
  
  return result;
}
```

### 3. 关键发现

**代码逻辑检查结果**:
- ✅ `getSceneConfig` - 直接从 Supabase REST API 读取，不做修改
- ✅ `replacePlaceholders` - 只替换 `{sourceLanguage}` 和 `{targetLanguage}`，**不支持 `{lang}`**
- ✅ `buildMessages` - 直接使用 `sysPrompt`，不做修改
- ✅ `callModelWithProvider` - 直接传递消息数组，不做修改

**结论**: 代码逻辑正常，没有引入 `{lang}` 占位符的地方。

---

## 📌 第六部分：配置与环境（Config & Env）

### 1. 当前使用的场景（Scene）加载顺序

| scene name | prompt path | 是否命中 |
|------------|-------------|----------|
| `chat` | `ai_scene_config.system_prompt_en` (en) / `system_prompt_ja` (ja) | ✅ 已命中 |

### 2. 当前 .env 中涉及本问题的变量

**本地环境** (`.env.local`):
```
AI_DATABASE_URL=postgresql://postgres:***@db.cgpmpfnjzlzbquakmmrj.supabase.co:5432/postgres?sslmode=require
```

**生产环境**: 需要确认 Vercel 环境变量配置

### 3. Cursor 执行的命令

```bash
# 诊断脚本
npx tsx scripts/test-ai-db-connection.ts
npx tsx scripts/query-chat-scene-config.ts
```

---

## 📌 第七部分：问题影响范围（Impact Analysis）

### 影响哪些模块？

- ✅ **ai-service** - AI 服务核心模块
- ✅ **web** - 前端用户界面
- ✅ **用户功能** - 首页 AI 助手功能完全不可用（英文和日文环境）

### 是否影响用户？

- ✅ **是** - 严重影响用户体验
- ✅ 英文和日文用户无法正常使用 AI 助手功能
- ✅ 返回错误信息而非正常回答

### 是否影响管理员？

- ❌ **否** - 管理员功能不受影响

### 是否影响生产环境？

- ✅ **是** - 问题发生在生产环境

### 是否影响积分/题库/AI调用等核心逻辑？

- ✅ **是** - 影响 AI 调用核心逻辑
- ❌ **否** - 不影响积分和题库功能

### 是否需紧急修复？

- ✅ **是** - 需要紧急修复，影响核心功能

---

## 📌 第八部分：Cursor 自我分析（Root Cause Hypothesis）

### 可能原因分析

#### 可能性1：Supabase REST API 返回的数据与直接数据库查询不同 ⭐⭐⭐⭐⭐

**分析**:
- 代码通过 Supabase REST API 查询场景配置：`/rest/v1/ai_scene_config?scene_key=eq.chat`
- 直接数据库查询显示配置正常，不包含 `{lang}` 占位符
- 但 Supabase REST API 可能返回不同的数据

**可能原因**:
- Supabase RLS (Row Level Security) 策略影响返回结果
- Supabase 视图或触发器修改了数据
- Supabase 缓存问题导致返回旧数据
- 生产环境的 Supabase 配置与本地不同

**验证方法**:
- 查看生产环境日志中的 `[SCENE-RUNNER] 场景配置读取成功` 日志
- 确认实际从 Supabase REST API 读取的 prompt 内容

#### 可能性2：数据库实际配置与查询结果不一致 ⭐⭐⭐

**分析**:
- 本地查询显示配置正常
- 但生产环境数据库可能包含 `{lang}` 占位符
- 可能被手动修改过

**验证方法**:
- 直接查询生产环境数据库
- 检查是否有其他环境或配置

#### 可能性3：代码在构建 prompt 时引入了 `{lang}` ⭐

**分析**:
- 代码逻辑检查未发现引入 `{lang}` 的地方
- 但可能有其他代码路径未检查到

**验证方法**:
- 完整代码审查
- 查看完整调用链

#### 可能性4：AI 模型误解析 ⭐

**分析**:
- AI 模型可能误将某些内容解析为 `{lang}` 变量
- 可能性较低

**验证方法**:
- 查看实际发送给 AI 的完整 prompt 内容

---

## 📌 第九部分：建议修复方向（Suggested Fixes）

### ✔ 方案 A（推荐）：检查并修复 Supabase 配置

**步骤**:
1. 查看生产环境服务器日志，确认实际读取的 prompt 内容
2. 如果日志显示包含 `{lang}`，检查 Supabase 配置：
   - 检查 RLS 策略
   - 检查是否有视图或触发器
   - 检查 Supabase 缓存
3. 修复 Supabase 配置或直接更新数据库配置

**优点**:
- 最安全，不影响代码
- 直接解决根本问题

**缺点**:
- 需要访问生产环境日志和 Supabase 配置

### ✔ 方案 B：扩展占位符替换支持

**步骤**:
1. 修改 `replacePlaceholders` 函数，添加 `{lang}` 占位符支持
2. 在 `runScene` 函数中，从 `locale` 提取 `lang` 值并传递给 `replacePlaceholders`

**优点**:
- 快速修复
- 如果确实需要使用 `{lang}` 占位符，此方案支持

**缺点**:
- 需要修改代码（根据规范，需要生成独立指令）
- 如果问题不在占位符，此方案无效

### ✔ 方案 C：预防性数据库修复

**步骤**:
1. 执行 SQL 脚本，确保数据库配置正确
2. 移除所有可能的 `{lang}` 占位符
3. 恢复标准配置

**优点**:
- 预防性修复，确保配置正确
- 不影响代码

**缺点**:
- 如果问题不在数据库配置，此方案无效

---

## 📌 第十部分：需要你（ChatGPT）决策的点（Decision Needed）

### 1. 需要确认的点

- ⚠️ **生产环境日志**: 需要查看生产环境实际日志，确认：
  - `[SCENE-RUNNER] 场景配置读取成功` 日志中的 `promptPreview`
  - `[SCENE-RUNNER] 替换占位符前` 和 `替换占位符后` 日志
  - `[SCENE-RUNNER] 准备调用模型` 日志中的 `sysPromptPreview`

### 2. 需要选择方案的点

- ⚠️ **修复方案选择**: 
  - 如果日志显示包含 `{lang}` → 选择方案 A（检查 Supabase 配置）
  - 如果日志显示正常 → 需要进一步调查，可能需要方案 B（扩展占位符支持）

### 3. 需要额外信息

- ⚠️ **生产环境访问**: 需要访问生产环境日志和 Supabase 配置
- ⚠️ **错误发生时间**: 需要确认错误首次发生的时间点
- ⚠️ **影响范围**: 需要确认是否所有英文和日文用户都受影响

---

## 📌 第十一部分：附录（Attachments）

### 1. 诊断脚本

**文件**: `scripts/test-ai-db-connection.ts`
- 用于测试数据库连接和查询场景配置
- 检查是否包含 `{lang}` 占位符

**文件**: `scripts/query-chat-scene-config.ts`
- 专门查询 chat 场景配置
- 显示完整配置内容

### 2. 流程分析文档

**文件**: `scripts/analyze-prompt-flow.md`
- 详细的 prompt 流程分析
- 代码调用链说明

### 3. SQL 修复脚本

**文件**: `scripts/generate-fix-sql.sql`
- 预防性修复脚本
- 移除 `{lang}` 占位符
- 恢复标准配置

### 4. 数据库查询结果

**查询命令**:
```bash
npx tsx scripts/test-ai-db-connection.ts
```

**查询结果摘要**:
- ✅ 数据库连接成功
- ✅ 找到 8 个场景配置
- ✅ chat 场景配置正常
- ✅ 日文和英文 prompt 均不包含 `{lang}` 占位符

### 5. 代码检查结果

**检查范围**:
- `apps/ai-service/src/lib/sceneRunner.ts` - 场景执行引擎
- `apps/ai-service/src/routes/ask.ts` - 主路由
- `src/components/AIPage.tsx` - 前端组件
- `src/lib/aiClient.front.ts` - 前端客户端

**检查结论**:
- ✅ 代码逻辑正常
- ✅ 没有引入 `{lang}` 占位符的地方
- ✅ 占位符替换函数只支持 `{sourceLanguage}` 和 `{targetLanguage}`

---

## 📌 第十二部分：之前采取过的措施详情

### 措施1：数据库配置检查

**执行时间**: 2025-11-29

**执行内容**:
1. 创建诊断脚本 `scripts/test-ai-db-connection.ts`
2. 执行数据库查询，检查 chat 场景配置
3. 检查是否包含 `{lang}` 占位符

**执行结果**:
- ✅ 数据库配置正常
- ✅ 不包含 `{lang}` 占位符
- ✅ 配置内容与标准配置一致

### 措施2：代码逻辑检查

**执行时间**: 2025-11-29

**执行内容**:
1. 检查 `getSceneConfig` 函数
2. 检查 `replacePlaceholders` 函数
3. 检查 `buildMessages` 函数
4. 检查 `callModelWithProvider` 函数
5. 检查完整调用链

**执行结果**:
- ✅ 代码逻辑正常
- ✅ 没有引入 `{lang}` 占位符的地方
- ✅ 占位符替换函数不支持 `{lang}`

### 措施3：生成诊断和修复脚本

**执行时间**: 2025-11-29

**执行内容**:
1. 创建流程分析文档 `scripts/analyze-prompt-flow.md`
2. 创建 SQL 修复脚本 `scripts/generate-fix-sql.sql`
3. 创建诊断脚本 `scripts/query-chat-scene-config.ts`

**执行结果**:
- ✅ 诊断工具已就绪
- ✅ 修复脚本已生成（待确认问题根源后执行）

### 措施4：场景 Key 确认

**执行时间**: 2025-11-29

**执行内容**:
1. 检查前端调用代码
2. 确认场景 key 为 `"chat"`

**执行结果**:
- ✅ 确认场景 key: `"chat"`
- ✅ 前端调用正确

---

## 📌 总结

### 当前状态

- ✅ **数据库配置**: 正常，不包含 `{lang}` 占位符
- ✅ **代码逻辑**: 正常，没有引入 `{lang}` 的地方
- ⚠️ **问题根源**: 待确认，最可能是 Supabase REST API 返回的数据与直接数据库查询不同

### 下一步行动

1. **优先**: 查看生产环境服务器日志，确认实际读取和发送的 prompt 内容
2. **其次**: 检查 Supabase 配置（RLS 策略、视图、触发器、缓存）
3. **最后**: 根据日志结果选择修复方案

### 风险评估

- **风险级别**: **High**
- **影响范围**: 所有英文和日文用户
- **紧急程度**: **紧急** - 需要尽快修复

---

**报告结束**







