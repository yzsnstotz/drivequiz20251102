# 题库加载逻辑对比分析报告

> **生成日期**: 2025-11-29  
> **对比分支**: main vs tempfix  
> **问题**: 本地代码题库无法加载

---

## 一、关键差异总结

### 1. `src/lib/questionsLoader.ts` 的差异

#### main 分支
```typescript
export async function loadUnifiedQuestionsPackage(): Promise<UnifiedPackage | null> {
  // 1) 先读取本地版本号和缓存（同步操作，立即返回）
  const localVersion = getLocalPackageVersion();
  
  // 如果有本地缓存，立即返回（不等待网络请求）
  if (localVersion) {
    const cached = getCachedPackage(localVersion);
    if (cached?.questions && cached.questions.length > 0) {
      console.log(`[loadUnifiedQuestionsPackage] 使用本地缓存（版本: ${localVersion}）`);
      
      // 在后台异步检查更新（不阻塞主流程）
      checkForUpdatesInBackground(localVersion).catch(err => {
        // 静默处理错误，不影响主流程
        console.warn(`[loadUnifiedQuestionsPackage] 后台检查更新失败:`, err);
      });
      
      return cached;
    }
  }
  
  // 如果没有缓存，才需要从服务器加载
  console.log(`[loadUnifiedQuestionsPackage] 没有本地缓存，从服务器加载`);
  return await loadFromServer();
}
```

**特点**：
- ❌ 没有 try-catch 包裹
- ✅ 如果出错，错误会直接传播到调用者
- ✅ 调用者（如 `study/learn/page.tsx`）有 try-catch，会捕获错误并处理

#### tempfix 分支
```typescript
export async function loadUnifiedQuestionsPackage(): Promise<UnifiedPackage | null> {
  // 函数开头打印日志
  console.log("[loadUnifiedQuestionsPackage] start", { timestamp: new Date().toISOString() });
  
  try {
    // 1) 先读取本地版本号和缓存（同步操作，立即返回）
    const localVersion = getLocalPackageVersion();
    
    // 如果有本地缓存，立即返回（不等待网络请求）
    if (localVersion) {
      const cached = getCachedPackage(localVersion);
      if (cached?.questions && cached.questions.length > 0) {
        console.log("[loadUnifiedQuestionsPackage] 使用本地缓存", {
          version: localVersion,
          questionCount: cached.questions.length,
        });
        
        // 在后台异步检查更新（不阻塞主流程）
        checkForUpdatesInBackground(localVersion).catch(err => {
          // 静默处理错误，不影响主流程
          console.warn(`[loadUnifiedQuestionsPackage] 后台检查更新失败:`, err);
        });
        
        return cached;
      }
    }
    
    // 如果没有缓存，才需要从服务器加载
    console.log("[loadUnifiedQuestionsPackage] no cache, loadFromServer()");
    const result = await loadFromServer();
    
    if (result) {
      console.log("[loadUnifiedQuestionsPackage] loaded from server", {
        questionCount: result.questions?.length || 0,
      });
    }
    
    return result;
  } catch (error) {
    // 捕获异常时打印错误日志，但不要吞掉错误，交给 Error Boundary 捕获
    console.error("[loadUnifiedQuestionsPackage] error", error);
    throw error; // 重新抛出错误，让 Error Boundary 处理
  }
}
```

**特点**：
- ✅ 有 try-catch 包裹整个函数
- ⚠️ 在 catch 中会 throw error，可能导致错误被 Error Boundary 捕获
- ✅ 添加了更详细的日志

### 2. `src/app/study/learn/page.tsx` 和 `src/app/study/exam/page.tsx` 的差异

#### main 分支
```typescript
const loadQuestions = async () => {
  console.log('[StudyMode] Starting to load questions', { licenseType, stage, timestamp: new Date().toISOString() });
  
  if (!licenseType || !stage) {
    console.warn('[StudyMode] Missing licenseType or stage, redirecting to /study', { licenseType, stage });
    router.push("/study");
    return;
  }

  try {
    console.log('[StudyMode] Setting loading state to true');
    setIsLoading(true);
    
    console.log('[StudyMode] Calling loadUnifiedQuestionsPackage...');
    const pkg = await loadUnifiedQuestionsPackage();
    console.log('[StudyMode] Package loaded:', { 
      hasPackage: !!pkg, 
      hasQuestions: !!(pkg?.questions), 
      questionCount: pkg?.questions?.length || 0,
      hasQuestionsByLocale: !!(pkg?.questionsByLocale),
    });
    
    if (!isMounted) {
      console.log('[StudyMode] Component unmounted, aborting');
      return;
    }
    
    const allQuestions = (pkg?.questions || []) as Question[];
    // ... 后续处理
  } catch (error) {
    // 错误处理
  }
};

loadQuestions();
```

#### tempfix 分支
```typescript
const loadQuestions = async () => {
  console.log('[StudyMode] loadQuestions function called', { licenseType, stage, timestamp: new Date().toISOString() });
  
  if (!licenseType || !stage) {
    console.warn('[StudyMode] Missing licenseType or stage, redirecting to /study', { licenseType, stage });
    router.push("/study");
    return;
  }

  try {
    console.log('[StudyMode] Setting loading state to true');
    setIsLoading(true);
    
    console.log('[StudyMode] Calling loadUnifiedQuestionsPackage...');
    const pkg = await loadUnifiedQuestionsPackage();
    console.log('[StudyMode] Package loaded:', { 
      hasPackage: !!pkg, 
      hasQuestions: !!(pkg?.questions), 
      questionCount: pkg?.questions?.length || 0,
      hasQuestionsByLocale: !!(pkg?.questionsByLocale),
    });
    
    if (!isMounted) {
      console.log('[StudyMode] Component unmounted, aborting');
      return;
    }
    
    const allQuestions = (pkg?.questions || []) as Question[];
    // ... 后续处理
  } catch (error) {
    // 错误处理
  }
};

// 添加全局错误监听器
const handleError = (event: ErrorEvent) => {
  console.error('[StudyMode] Global error caught:', {
    message: event.message,
    filename: event.filename,
    lineno: event.lineno,
    colno: event.colno,
    error: event.error,
  });
};

const handleUnhandledRejection = (event: PromiseRejectionEvent) => {
  console.error('[StudyMode] Unhandled promise rejection:', {
    reason: event.reason,
    promise: event.promise,
  });
};

window.addEventListener('error', handleError);
window.addEventListener('unhandledrejection', handleUnhandledRejection);

// 调用加载函数
loadQuestions().catch((error) => {
  console.error('[StudyMode] loadQuestions promise rejected:', {
    error: error instanceof Error ? error.message : String(error),
    stack: error instanceof Error ? error.stack : undefined,
  });
});

return () => {
  isMounted = false;
  window.removeEventListener('error', handleError);
  window.removeEventListener('unhandledrejection', handleUnhandledRejection);
};
```

**差异**：
- ✅ tempfix 分支添加了全局错误监听器
- ✅ tempfix 分支在调用 `loadQuestions()` 时添加了 `.catch()` 处理
- ✅ tempfix 分支添加了 `StudyErrorBoundary` 包裹

---

## 二、关键问题分析

### 问题 1: 多语言支持不一致 ⚠️ **关键问题**

**发现**：
- `src/components/QuestionPage.tsx` 使用了 `questionsByLocale`，优先使用多语言包：
  ```typescript
  let allQuestions: any[] = [];
  if (pkg?.questionsByLocale && pkg.questionsByLocale[language]) {
    allQuestions = pkg.questionsByLocale[language];
  } else {
    allQuestions = pkg?.questions || [];
  }
  ```

- `src/app/study/learn/page.tsx` 和 `src/app/study/exam/page.tsx` **只使用了 `pkg?.questions`**，没有使用 `questionsByLocale`：
  ```typescript
  const allQuestions = (pkg?.questions || []) as Question[];
  ```

**影响**：
- 如果服务器返回的数据只有 `questionsByLocale` 而没有 `questions`，那么 `study/learn/page.tsx` 和 `study/exam/page.tsx` 就会加载不到题目
- 这可能导致题目加载失败，即使数据已经成功从服务器获取

**解决方案**：
需要修改 `study/learn/page.tsx` 和 `study/exam/page.tsx`，使其也支持 `questionsByLocale`，与 `QuestionPage.tsx` 保持一致。

### 问题 2: 错误处理机制差异

**main 分支**：
- `loadUnifiedQuestionsPackage` 没有 try-catch，错误直接传播
- 调用者有 try-catch，可以捕获错误

**tempfix 分支**：
- `loadUnifiedQuestionsPackage` 有 try-catch，会 throw error
- 如果错误被抛出，可能被 Error Boundary 捕获，但题目加载失败
- 调用者也有 try-catch，理论上应该能捕获错误

**分析**：
- 理论上，tempfix 分支的错误处理应该更完善
- 但如果 `loadUnifiedQuestionsPackage` 抛出错误，而调用者的 try-catch 没有正确捕获，可能会导致问题

### 问题 3: 缓存检查逻辑

**两个分支的缓存检查逻辑相同**：
```typescript
if (cached?.questions && cached.questions.length > 0) {
  return cached;
}
```

**潜在问题**：
- 如果缓存中只有 `questionsByLocale` 而没有 `questions`，缓存检查会失败
- 即使缓存中有数据，也可能因为检查条件不满足而重新从服务器加载

---

## 三、问题根源推测

基于以上分析，**最可能的问题是**：

1. **多语言支持不一致**：`study/learn/page.tsx` 和 `study/exam/page.tsx` 没有使用 `questionsByLocale`，如果服务器返回的数据只有 `questionsByLocale` 而没有 `questions`，就会加载不到题目。

2. **缓存检查逻辑不完整**：缓存检查只检查 `cached?.questions`，如果缓存中只有 `questionsByLocale` 而没有 `questions`，缓存检查会失败，导致重新从服务器加载。

3. **错误处理可能导致静默失败**：虽然 tempfix 分支添加了 Error Boundary 和错误监听器，但如果错误在特定时机抛出，可能仍然会导致题目加载失败。

---

## 四、修复建议

### 建议 1: 统一多语言支持逻辑

修改 `src/app/study/learn/page.tsx` 和 `src/app/study/exam/page.tsx`，使其也支持 `questionsByLocale`：

```typescript
const { language } = useLanguage(); // 需要获取当前语言

// 优先使用当前语言的多语言包，如果没有则使用默认的questions
let allQuestions: any[] = [];
if (pkg?.questionsByLocale && pkg.questionsByLocale[language]) {
  allQuestions = pkg.questionsByLocale[language];
} else {
  allQuestions = pkg?.questions || [];
}
```

### 建议 2: 改进缓存检查逻辑

修改 `src/lib/questionsLoader.ts` 中的缓存检查逻辑，同时检查 `questions` 和 `questionsByLocale`：

```typescript
if (localVersion) {
  const cached = getCachedPackage(localVersion);
  // 检查是否有 questions 或 questionsByLocale
  const hasQuestions = cached?.questions && cached.questions.length > 0;
  const hasQuestionsByLocale = cached?.questionsByLocale && Object.keys(cached.questionsByLocale).length > 0;
  
  if (hasQuestions || hasQuestionsByLocale) {
    console.log("[loadUnifiedQuestionsPackage] 使用本地缓存", {
      version: localVersion,
      questionCount: cached.questions?.length || 0,
      localeCount: cached.questionsByLocale ? Object.keys(cached.questionsByLocale).length : 0,
    });
    
    // 在后台异步检查更新（不阻塞主流程）
    checkForUpdatesInBackground(localVersion).catch(err => {
      console.warn(`[loadUnifiedQuestionsPackage] 后台检查更新失败:`, err);
    });
    
    return cached;
  }
}
```

### 建议 3: 增强错误处理和日志

在 `study/learn/page.tsx` 和 `study/exam/page.tsx` 中，添加更详细的错误处理和日志：

```typescript
const pkg = await loadUnifiedQuestionsPackage();
console.log('[StudyMode] Package loaded:', { 
  hasPackage: !!pkg, 
  hasQuestions: !!(pkg?.questions), 
  questionCount: pkg?.questions?.length || 0,
  hasQuestionsByLocale: !!(pkg?.questionsByLocale),
  questionsByLocaleKeys: pkg?.questionsByLocale ? Object.keys(pkg.questionsByLocale) : [],
});

if (!pkg) {
  console.error("[StudyMode] Package is null");
  setIsLoading(false);
  return;
}

// 优先使用当前语言的多语言包
let allQuestions: any[] = [];
if (pkg.questionsByLocale && pkg.questionsByLocale[language]) {
  allQuestions = pkg.questionsByLocale[language];
  console.log(`[StudyMode] Using questionsByLocale for language: ${language}, count: ${allQuestions.length}`);
} else {
  allQuestions = pkg.questions || [];
  console.log(`[StudyMode] Using default questions, count: ${allQuestions.length}`);
}

if (!allQuestions || allQuestions.length === 0) {
  console.error("[StudyMode] Failed to load questions: no questions available", {
    hasPackage: !!pkg,
    hasQuestions: !!(pkg?.questions),
    hasQuestionsByLocale: !!(pkg?.questionsByLocale),
    currentLanguage: language,
    availableLocales: pkg?.questionsByLocale ? Object.keys(pkg.questionsByLocale) : [],
  });
  setIsLoading(false);
  return;
}
```

---

## 五、验证步骤

1. **检查服务器返回的数据结构**：
   - 查看 `/api/questions/package` 返回的数据是否包含 `questions` 和 `questionsByLocale`
   - 确认当前语言对应的 `questionsByLocale` 是否存在

2. **检查本地缓存**：
   - 查看 localStorage 中的缓存数据
   - 确认缓存中是否包含 `questions` 和 `questionsByLocale`

3. **测试不同语言环境**：
   - 测试中文、英文、日文环境下的题目加载
   - 确认多语言支持是否正常工作

4. **检查错误日志**：
   - 查看浏览器控制台的错误日志
   - 确认是否有未捕获的错误或 Promise rejection

---

## 六、总结

**最可能的问题根源**：
1. **多语言支持不一致**：`study/learn/page.tsx` 和 `study/exam/page.tsx` 没有使用 `questionsByLocale`，如果服务器返回的数据只有 `questionsByLocale` 而没有 `questions`，就会加载不到题目。

2. **缓存检查逻辑不完整**：缓存检查只检查 `cached?.questions`，如果缓存中只有 `questionsByLocale` 而没有 `questions`，缓存检查会失败。

**建议优先修复**：
1. 修改 `study/learn/page.tsx` 和 `study/exam/page.tsx`，使其支持 `questionsByLocale`
2. 改进缓存检查逻辑，同时检查 `questions` 和 `questionsByLocale`
3. 增强错误处理和日志，便于问题诊断

---

**报告生成时间**: 2025-11-29

