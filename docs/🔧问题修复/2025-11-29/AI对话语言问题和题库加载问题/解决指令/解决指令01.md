一、规范对齐检查摘要（给 Cursor 用）

⚠️ 本段请在 Cursor 任务开头原样输出一遍，再写后续步骤。

已阅读并需遵守的规范文件：

🧩 AI 服务研发规范（ai-service 统一架构规范 v1.0）.md

🧩 AI 核心服务规范（ai-core 统一架构规范 v2.0）.md

数据库结构_DRIVEQUIZ.md

数据库结构_AI_SERVICE.md

文件结构.md

修复指令头05版（现用）.md

本任务强关联红线条款：

A1：路由层禁止承载业务逻辑（业务逻辑写在 lib / hooks / components 工具函数层）。

A2：AI 相关核心逻辑如涉及必须走 ai-core / ai-service 约定，但本任务不改 ai-service / ai-core，只在 web 做兼容与验证。

B1–B4：本次不改任何数据库字段 / 表结构 / 索引；必须确保 Kysely 类型与现有 DB 结构一致。

B2：如新增前端文件，需同步更新 docs/研发规范/文件结构.md。

D1–D2：必须输出执行报告，并逐条标注 A1–D2 的遵守情况。

本次任务预计影响文件（仅列路径）：

src/components/AIPage.tsx

src/lib/aiClient.front.ts / src/lib/aiClient.server.ts（只加日志，不改调用协议）

apps/web/app/api/ai/chat/route.ts（仅加日志，禁止写业务逻辑）

src/app/study/learn/page.tsx / src/app/study/exam/page.tsx

src/lib/questionsLoader.ts

src/lib/imageUtils.ts

新增：src/components/StudyErrorBoundary.tsx（或类似命名的 Error Boundary 组件）。

明确禁止修改的部分：

apps/ai-service/** 以及任何本地 ai-core / local-ai-service 代码（根据现行规范，AI 模块已外部化，不在本仓库推进）。

任何数据库 schema / migration / Supabase 结构。

二、任务拆分总览
任务 1：AI 对话语言问题（前端语言验证 + 日志链路打通）

目标：

确认从用户设置语言 → locale → lang → API 请求 → 响应这一链路在 web 端完全可见；

增加一个轻量级语言验证机制，当回复语言与用户设置不一致时，给用户提示，并打日志，方便后续确认是外部 ai-service 逻辑问题。

任务 2：题库无法加载（Error Boundary + 提前日志 + 回滚图片校验）

目标：

保证 /study/learn / /study/exam 组件至少能渲染并打印日志；

若子组件或图片/题目加载函数抛错，由 Error Boundary 捕获并输出错误与兜底 UI，而不是静默空白页；

简化 isValidImageUrl，确保绝不抛错，先恢复基础功能，再逐步加严校验。

下面是给 Cursor 的详细执行指令。

三、任务 1：AI 对话语言问题 – 详细修复指令

相关诊断来源：问题诊断报告第 1/3/4/5/8/9 部分。

1.1 加强语言参数日志（链路打通）

修改文件：

src/components/AIPage.tsx

src/lib/aiClient.front.ts

src/lib/aiClient.server.ts

apps/web/app/api/ai/chat/route.ts

具体要求：

在 AIPage.tsx 中，调用 callAiDirect 前后，已经有部分日志：

const userLocale = languageToLocale(language);
console.log("[AIPage] 使用用户设置的语言:", { ... });
const payload = await callAiDirect({ ... });


在收到 AI 回复后再追加一条日志：

日志内容包括：

userLanguage（设置值，如 "en"）

userLocale（如 "en-US"）

requestLang（实际发送给后端的 lang）

replyPreview（回复前 80 字符）

时间戳

在 src/lib/aiClient.front.ts：已有 localeToLang 和请求体构造，当前日志里已经记录了 lang 字段。

确保在发送 fetch 前打印一条结构化日志：

tag：[aiClient.front] send

包含：locale, lang, scene, model, provider。

在收到响应后打印一条日志：

tag：[aiClient.front] response

包含 HTTP 状态、lang、响应文本前 80 字符。

在 src/lib/aiClient.server.ts 中做同样的日志处理（如果存在服务端直连 ai-service 的分支），保持前后端日志字段一致，便于对照。

在 apps/web/app/api/ai/chat/route.ts 中：

在从前端 body 解构出 lang / scene 的位置，加一条只读日志：

tag：[api/ai/chat] incoming

日志内容包括：lang, scene, model, sourceLanguage, targetLanguage。

⚠️ 按 A1 要求：严禁在 route 中写任何业务判断（如语言 fallback 逻辑）；只允许读取和 log。

1.2 新增轻量级语言检测工具（前端）

新工具函数位置建议：

在 src/lib/i18n.ts 中增加一个纯前端工具函数（如果该文件本身是通用 i18n 工具）

或新建 src/lib/languageDetector.ts，由 AIPage.tsx 调用。若新建文件，需同步更新 docs/研发规范/文件结构.md。

函数需求（伪代码级别）：

export type DetectedLang = "en" | "zh" | "ja" | "mixed" | "unknown";

export function detectLangFromText(text: string): DetectedLang {
  // 只用简单字符集规则，不调用外部 AI：
  // - 大量 ASCII 字母 && 少量 CJK → "en"
  // - 大量 CJK（\u4E00-\u9FFF）且几乎无假名 → "zh"
  // - 存在大量假名（\u3040-\u309F, \u30A0-\u30FF） → "ja"
  // - 多种字符集混合 → "mixed"
  // - 太短或无法判断 → "unknown"
}


要求：

绝不抛错（对 null/undefined 做防御处理）。

纯函数，无副作用，方便单测。

1.3 在 AIPage 中添加“语言验证机制”（不自动重试）

修改文件：

src/components/AIPage.tsx

具体逻辑：

在拿到 AI 回复文本后（即现在显示在对话框之前的那一步）：

使用 detectLangFromText(replyText) 得到 detectedLang。

与当前用户设置的 userLanguage 对比：

如果：

userLanguage === "en" 且 detectedLang !== "en"

或 userLanguage === "zh" 且 detectedLang !== "zh"

或 userLanguage === "ja" 且 detectedLang !== "ja"

则：

打一条告警日志：[AIPage] language mismatch，附上上述字段。

在 UI 上以非打断式的方式提示用户，例如在对话框上方增加一条小的 warning bar：

文案示意（中文）：

“AI 回复的语言（检测为: {detectedLang}）可能与当前设置的语言（{userLanguage}）不一致，这可能是外部 AI 服务的行为所致。”

不要自动重试，保持行为只读，以免引入循环调用。

可以预留一个“反馈”入口（例如小按钮），但不在本任务实现具体逻辑，仅打印点击日志，方便后续 product 再设计。

所有逻辑必须在组件/工具层实现，不允许写入 API route 层（遵守 A1）。

说明：这样我们在不修改外部 ai-service 的前提下，明确把“语言不一致”标记为外部服务问题，同时给用户透明反馈，并为后续对接 ai-service 团队保留日志依据。

四、任务 2：题库无法加载 – 详细修复指令

诊断要点：

进入 /study/learn / /study/exam 页面时，控制台完全无日志输出，包括已经添加的若干日志。

基本可以确认：组件没有“真正渲染到 hooks 阶段”，很可能在函数体或子组件渲染早期抛错。

2.1 新增 Study 专用 Error Boundary

新增文件：

src/components/StudyErrorBoundary.tsx（文件名可调整，但需同步更新 docs/研发规范/文件结构.md）

实现要求：

使用 class 组件实现标准 React Error Boundary（componentDidCatch, getDerivedStateFromError）。

props：

children: React.ReactNode

可选 fallback?: React.ReactNode，默认显示一个简单提示：

“题目加载过程中出现错误，请稍后重试或联系客服。”

在 componentDidCatch 中：

使用 console.error("[StudyErrorBoundary] 捕获到错误", error, info); 打日志。

可以根据需要上报到现有的错误上报通道（若已有 util）。

确保该组件以 use client 开头。

2.2 用 Error Boundary 包裹学习/考试页面

修改文件：

src/app/study/learn/page.tsx

src/app/study/exam/page.tsx

要求：

如果这两个 page 是 Server Component，请在其返回的顶层 JSX 中用 <StudyErrorBoundary> 包裹实际的 Client 组件（StudyModePage 之类）。

如果是 Client Component（"use client"），直接在 JSX 最外层使用：

return (
  <StudyErrorBoundary>
    {/* 原有内容 */}
  </StudyErrorBoundary>
);


在组件函数体最开始（在 hooks 之前）添加一条简单日志：

console.log("[StudyPage] rendering", { page: "learn", timestamp: new Date().toISOString() });


对考试页同理。即便子组件抛错，这条日志也应该出现 —— 如果仍完全不出现，则表明 Router 层 / Suspense 层有问题，后续可以据此继续诊断。

2.3 简化 isValidImageUrl，彻底避免抛错

修改文件：

src/lib/imageUtils.ts

根据诊断报告： 图片 URL 校验函数是最近改动点，且被怀疑有抛错风险。

要求：

将 isValidImageUrl 精简为绝不抛错的实现，例如：

只做这些检查：

typeof url === "string"

url.trim().length > 0

url 以 http:// / https:// / / 开头之一。

所有其他情况：返回 false，不要抛错。

用 try/catch 包一下，确保任何内部错误都被吃掉，返回 false 并打一次 console.warn（限流）。

确保所有使用 isValidImageUrl 的地方都采用“防御式渲染”：

如果返回 false，直接不渲染 <img>，而不是抛错。

不要在这里引入任何异步操作或正则炸弹（避免性能问题）。

2.4 加强题目加载日志（但不改协议）

修改文件：

src/lib/questionsLoader.ts

在 loadUnifiedQuestionsPackage 中：

在函数开头打印：

console.log("[loadUnifiedQuestionsPackage] start", { timestamp: new Date().toISOString() });


在命中本地缓存分支返回前，加日志：

console.log("[loadUnifiedQuestionsPackage] 使用本地缓存", { version: localVersion, questionCount: cached?.questions?.length ?? 0 });


在走到 loadFromServer() 前后也加日志：

调用前：[loadUnifiedQuestionsPackage] no cache, loadFromServer()

调用成功后：[loadUnifiedQuestionsPackage] loaded from server + 题目数量。

捕获异常时：console.error("[loadUnifiedQuestionsPackage] error", err);，但不要吞掉错误 —— 交给 Error Boundary 捕获。

重点：这里不改任何 API URL 或协议字段，保证与现有 BFF / 后端契合，符合 A1/A4/B3。

五、版本号与执行报告要求

按照你现有的指令头 v5.0 执行要求，这里只强调关键点。

更新版本号：

修改 src/lib/version.ts 中的 BUILD_TIME 为当前日期时间（ISO 字符串或你们约定格式），并在执行报告摘要中写明当前版本号。

文件结构文档更新：

如果新增了 src/components/StudyErrorBoundary.tsx 或其他新文件，必须同步更新 docs/研发规范/文件结构.md 中对应目录结构与生成时间 / 版本号。

执行报告路径：

建议：

docs/问题修复/CP-20251129-001/执行报告/ai_language_and_study_loading_执行报告.md

执行报告中需包含：

任务摘要（对应诊断报告的两个问题）。

修改文件列表。

A1–D2 红线规范自检状态。

本地测试结果（至少说明：

AI 对话页面在英文/中文/日文设置下的实际表现与语言验证日志，

/study/learn 和 /study/exam 页面是否能够正常渲染、是否能打印日志、是否出现 Error Boundary 兜底 UI）。

没有数据库/迁移操作的确认说明。