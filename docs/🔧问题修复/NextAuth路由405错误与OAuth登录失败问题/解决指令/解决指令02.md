✅ 方案确认

最终选择方案：🅰 继续使用 NextAuth.js，按 NextAuth v5 正确姿势修复路由与 Google 登录。

不做认证方案切换，不引入 Supabase Auth。

修复目标：

/api/auth/* 不再返回 405

signIn("google") 正常跳转到 Google 授权

授权后正常回到站内页面（如 /dashboard），Session 写入成功

下面是 给 Cursor 的一次性修复指令概要（你下一步如果需要，我可以直接帮你写成完整「Cursor 执行指令 + 执行报告要求」版本）：

🛠 修复概要（NextAuth v5 + Google 登录）
1. 修复关键路由：src/app/api/auth/[...nextauth]/route.ts

问题根源（见诊断报告）
当前实现用了类似：

const handler = NextAuth(authOptions);

export async function GET(req: NextRequest, context: any) {
  return handler.GET(req, context);
}

export async function POST(req: NextRequest, context: any) {
  return handler.POST(req, context);
}


在 NextAuth v5 beta 里，NextAuth(authOptions) 返回的不是带 .GET / .POST 方法的对象

正确用法是：直接把 handler 作为 GET / POST 导出

现有写法导致 GET /api/auth/session / GET /api/auth/providers / GET /api/auth/error 全部 405

修复要求（符合 A1：路由只做分发，不写业务逻辑）：

// src/app/api/auth/[...nextauth]/route.ts
import NextAuth from "next-auth";
import { authOptions } from "@/lib/auth";

// NextAuth v5 推荐用法：生成一个 handler
const handler = NextAuth(authOptions);

// 直接把 handler 作为 GET / POST 导出，路由层不做任何业务逻辑
export { handler as GET, handler as POST };


路由层职责只剩一件事：把请求交给 NextAuth，不做任何多余逻辑 ✅ 符合 A1。

2. 校正 NextAuth 配置：src/lib/auth.ts

目标是确保：

Google Provider 配置完备（clientId、clientSecret、callback URL）

URL / secret / adapter 都与当前环境一致

不在 auth.ts 里做与路由重复的逻辑

一个参考结构（伪代码，Cursor 需要对照你现有文件做最小变更）：

// src/lib/auth.ts
import type { NextAuthConfig } from "next-auth";
import GoogleProvider from "next-auth/providers/google";
// 如果有 LINE Provider，也在这里集中管理
// import LineProvider from "next-auth/providers/line";
import { KyselyAdapter } from "@auth/kysely-adapter";
import { db } from "@/lib/db"; // 你现有的 Kysely 实例

export const authOptions: NextAuthConfig = {
  adapter: KyselyAdapter(db),
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
      // 一般情况下不必手写 callbackUrl，NextAuth 会用 /api/auth/callback/google
    }),
    // LineProvider(...) 如果有
  ],
  pages: {
    signIn: "/login", // 对齐你的登录页
    error: "/login?error=oauth", // 方便错误展示
  },
  session: {
    strategy: "jwt",
  },
  // 这里可以按需保留 callbacks / events，但不要搬到 route.ts 去
};


关键点：

GOOGLE_CLIENT_ID / GOOGLE_CLIENT_SECRET 必须与 Google Cloud Console 当前应用 一致

Google 控制台的 Authorized redirect URI 必须包含：

https://你的域名/api/auth/callback/google

开发环境：http://localhost:3000/api/auth/callback/google

3. 登录页调用方式：src/app/login/page.tsx

确认登录页使用的是 NextAuth 正式入口，而不是随手拼 URL：

import { signIn } from "next-auth/react";

const handleGoogleLogin = () => {
  signIn("google", {
    // callbackUrl 可选，不传则回到 NEXTAUTH_URL / 当前 origin
    callbackUrl: "/dashboard", 
  });
};


不要手动跳转到 /api/auth/signin/google，交给 signIn("google") 统一处理

避免自定义 fetch 去调用 /api/auth/providers / /api/auth/session，这些都由 next-auth/react 内部完成

4. 环境变量 & NextAuth 核心配置

确保 .env.local 中存在并正确设置：

NEXTAUTH_URL="http://localhost:3000"  # 本地开发
# 正式环境例如：
# NEXTAUTH_URL="https://drivequiz.yourdomain.com"

NEXTAUTH_SECRET="一个足够长的随机字符串"

GOOGLE_CLIENT_ID="..."
GOOGLE_CLIENT_SECRET="..."


NEXTAUTH_URL 要与当前访问域名一致（本地和生产各配一套）

Google 控制台中的 OAuth 回调地址 要与 NEXTAUTH_URL + /api/auth/callback/google 严格匹配

5. 版本一致性检查（防止文档/安装版本不一致）

诊断报告里提到：

package.json 标记：next-auth@5.0.0-beta.25

实际安装：beta.30

建议 Cursor 做一次对齐：

在 package.json 里写死一个版本，比如：
"next-auth": "5.0.0-beta.30"

重新安装依赖：pnpm install 或 npm install

确认 node_modules/next-auth/package.json 版本与 package.json 一致

6. 执行完成后的「执行报告」（满足 D1）

让 Cursor 在执行完以上修改后，输出一份简短的执行报告，至少包含：

修改文件列表

src/app/api/auth/[...nextauth]/route.ts

src/lib/auth.ts

src/app/login/page.tsx（如果有改）

package.json（如果版本对齐）

关键变更摘要

路由从 export async function GET/POST 改为 export { handler as GET, handler as POST }

authOptions 中确认了 Google Provider 配置

登录按钮调用方式确认为 signIn("google")

NEXTAUTH_URL 等环境变量检查结果

本地验证结果

访问 /login 页面是否仍能正常渲染

打开 DevTools Network：

GET /api/auth/session 返回 200（不再是 405）

点击 “Google 登录” 后能跳转到 Google 授权页

完成授权后回到站内，/api/auth/session 返回有用户信息