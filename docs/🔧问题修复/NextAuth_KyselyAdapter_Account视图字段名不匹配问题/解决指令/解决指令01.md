âš™ï¸ ä»»åŠ¡æ ‡é¢˜
ä¿®å¤ NextAuth KyselyAdapter linkAccount å†™å…¥ Account è§†å›¾å­—æ®µåä¸åŒ¹é…é—®é¢˜ï¼ˆæ–°å¢é€‚é…å±‚ï¼Œä¿ç•™ db.ts ç°æœ‰ç»“æ„ï¼‰

ğŸ“ çº¦æŸå‰ç½®

ä¸¥æ ¼éµå®ˆç°æœ‰ç ”å‘è§„èŒƒä¸æ–‡ä»¶ç»“æ„ï¼š

docs/ç ”å‘è§„èŒƒ/æ•°æ®åº“ç»“æ„_DRIVEQUIZ.md

docs/ç ”å‘è§„èŒƒ/æ–‡ä»¶ç»“æ„.md

docs/é—®é¢˜ä¿®å¤/LINE_OAuth_JWTç®—æ³•ä¸åŒ¹é…é—®é¢˜/è¯Šæ–­æŠ¥å‘Š/é—®é¢˜è¯Šæ–­æŠ¥å‘Š.mdï¼ˆæœ¬é—®é¢˜å¯¹åº”çš„è¯Šæ–­æŠ¥å‘Šï¼‰

ç¦æ­¢æ”¹åŠ¨ç¬¬ä¸‰æ–¹åº“æºç ï¼ˆnode_modules/@auth/*ï¼‰ï¼Œæ‰€æœ‰ä¿®å¤åœ¨æœ¬ä»“åº“å†…å®Œæˆã€‚

src/lib/db.ts å¿…é¡»ä¿ç•™ï¼Œå¹¶ç»§ç»­ä½œä¸ºå”¯ä¸€çš„ Kysely Database å®šä¹‰ä¸è¿æ¥å…¥å£ã€‚

âœ… Step 1ï¼šç¡®è®¤ / ç¨³å›ºå½“å‰ db.ts å®šä¹‰ï¼ˆåªå…è®¸å°ä¿®æ­£ï¼Œä¸è¦æ¨ç¿»ï¼‰

æ‰“å¼€ src/lib/db.tsï¼Œæ£€æŸ¥å¹¶ä¿è¯ä»¥ä¸‹å†…å®¹å­˜åœ¨ä¸”å‘½åä¸€è‡´ï¼š

// 1) OAuthAccountTableï¼šåº•å±‚è¡¨ oauth_accountsï¼ˆä¸‹åˆ’çº¿å‘½åï¼‰
interface OAuthAccountTable {
  id: Generated<number>;
  user_id: string;
  provider: string;
  provider_account_id: string;
  access_token: string | null;
  refresh_token: string | null;
  id_token: string | null;
  token_type: string | null;
  scope: string | null;
  session_state: string | null;
  expires_at: ColumnType<Date | null, string | null, never>;
  created_at: ColumnType<Date, string | undefined, never>;
  updated_at: ColumnType<Date, string | undefined, never>;
}

// 2) AccountTableï¼šè§†å›¾ "Account"ï¼ˆé©¼å³°å‘½åï¼Œè‡³å°‘è¦åŒ…å«æŸ¥è¯¢ç”¨å­—æ®µï¼‰
interface AccountTable {
  id: string;
  userId: string;
  provider: string;
  providerAccountId: string;
  // token ç›¸å…³å­—æ®µå¯ä»¥æš‚æ—¶ä¿æŒ camelCase å®šä¹‰ï¼Œå¦‚ç¡®æœ‰éœ€è¦å†è¡¥ï¼š
  accessToken: string | null;
  refreshToken: string | null;
  expiresAt: Date | null;
  tokenType: string | null;
  scope: string | null;
  idToken: string | null;
  sessionState: string | null;
  createdAt: Date;
  updatedAt: Date;
}

interface Database {
  oauth_accounts: OAuthAccountTable;
  Account: AccountTable;
  // ... å…¶ä»–ä¸šåŠ¡è¡¨ä¿æŒä¸åŠ¨
}

export const db = new Kysely<Database>({ /* ä¿æŒç°æœ‰è¿æ¥é…ç½® */ });


ä¸è¦åˆ é™¤ AccountTable / Database.Accountï¼Œåªå…è®¸å°èŒƒå›´å­—æ®µä¿®æ­£ï¼Œä¿æŒä¸è¯Šæ–­æŠ¥å‘Šä¸€è‡´ã€‚

âœ… Step 2ï¼šæ–°å»ºã€Œé€‚é…å±‚ã€åŒ…è£… KyselyAdapterï¼Œä»…é‡å†™ linkAccount

æ–°å»ºæ–‡ä»¶ï¼šsrc/lib/auth-kysely-adapter.tsï¼Œå†…å®¹å¦‚ä¸‹ï¼ˆå…è®¸åœ¨ç±»å‹ä¸Šåšå°ä¼˜åŒ–ï¼Œä½†é€»è¾‘ç»“æ„å¿…é¡»ä¿æŒï¼‰ï¼š

import type { Kysely } from 'kysely';
import type { Adapter, AdapterAccount } from '@auth/core/adapters';
import { KyselyAdapter as OriginalKyselyAdapter } from '@auth/kysely-adapter';
import type { Database } from './db';

// å¼ºåˆ¶çº¦æŸï¼šæ•´ä¸ªé¡¹ç›®ç»Ÿä¸€ç”¨è¿™ä¸ªé€‚é…åçš„ Adapter
export function createPatchedKyselyAdapter(db: Kysely<Database>): Adapter {
  const base = OriginalKyselyAdapter(db) as Adapter;

  return {
    ...base,

    // åªé‡å†™ linkAccountï¼Œç»•è¿‡ "Account" è§†å›¾å†™å…¥é—®é¢˜ï¼Œç›´æ¥å†™ oauth_accounts åº•å±‚è¡¨
    async linkAccount(account: AdapterAccount) {
      // 1. ä» AdapterAccount ä¸­æŠ½å–éœ€è¦çš„å­—æ®µ
      const {
        provider,
        providerAccountId,
        userId,
        access_token,
        refresh_token,
        id_token,
        token_type,
        scope,
        expires_at,
        // æŸäº› provider å¯èƒ½ä¼šå¸¦ä¸Š session_state
        // @ts-expect-error: session_state ä¸åœ¨ AdapterAccount ç±»å‹é‡Œï¼Œä½†åœ¨å®é™…è¿”å›ä¸­å­˜åœ¨
        session_state,
      } = account as any;

      if (!userId) {
        throw new Error('[auth] linkAccount: missing userId');
      }

      const now = new Date();

      // 2. ç›´æ¥å†™å…¥åº•å±‚è¡¨ oauth_accountsï¼ˆå­—æ®µå…¨éƒ¨ç”¨ä¸‹åˆ’çº¿å‘½åï¼‰
      await db
        .insertInto('oauth_accounts')
        .values({
          user_id: userId,
          provider,
          provider_account_id: providerAccountId,
          access_token: access_token ?? null,
          refresh_token: refresh_token ?? null,
          id_token: id_token ?? null,
          token_type: token_type ?? null,
          scope: scope ?? null,
          session_state: session_state ?? null,
          expires_at: expires_at ? new Date(expires_at * 1000) : null,
          created_at: now,
          updated_at: now,
        })
        .executeTakeFirstOrThrow();

      // 3. æŒ‰ NextAuth çº¦å®šè¿”å›åŸå§‹ AdapterAccount
      return account;
    },
  };
}


è¯´æ˜ï¼š

è¿™æ · linkAccount å®Œå…¨ç»•å¼€ è§†å›¾ "Account"ï¼Œä¸å†èµ° INSERT INTO "Account" (...)ï¼Œè‡ªç„¶ä¸ä¼šå†è§¦å‘ "access_token" åˆ—ä¸å­˜åœ¨çš„é—®é¢˜ã€‚

å…¶ä»–æ–¹æ³•ï¼ˆgetUserByAccount ç­‰ï¼‰ä»ç„¶ä½¿ç”¨åŸå§‹ KyselyAdapter çš„é€»è¾‘å’Œè§†å›¾ "Account"ï¼Œä¸éœ€è¦æ”¹åŠ¨ã€‚

âœ… Step 3ï¼šåœ¨ src/lib/auth.ts ä¸­æ”¹ç”¨æ–°çš„ Adapter

æ‰“å¼€ src/lib/auth.tsï¼Œæ‰¾åˆ°å½“å‰ NextAuth é…ç½®ä¸­ä½¿ç”¨ KyselyAdapter çš„ä½ç½®ï¼Œæ¯”å¦‚ï¼š

import { KyselyAdapter } from '@auth/kysely-adapter';
import { db } from './db';

export const authOptions: NextAuthConfig = {
  adapter: KyselyAdapter(db),
  // ...
};


æ›¿æ¢ä¸ºä½¿ç”¨åˆšæ‰çš„æ–°å‡½æ•°ï¼š

import { db } from './db';
import { createPatchedKyselyAdapter } from './auth-kysely-adapter';

export const authOptions: NextAuthConfig = {
  adapter: createPatchedKyselyAdapter(db),
  // ...
};


ç¦æ­¢ å†åœ¨å…¶ä»–æ–‡ä»¶ä¸­ç›´æ¥ä½¿ç”¨ KyselyAdapter(db)ï¼Œå…¨éƒ¨ç»Ÿä¸€èµ° createPatchedKyselyAdapter(db)ã€‚

âœ… Step 4ï¼šæœ€å°åŒ–æ•°æ®åº“è°ƒæ•´ & éªŒè¯

ä¿ç•™ç°æœ‰çš„ Account è§†å›¾å’Œè§¦å‘å™¨è¿ç§»æ–‡ä»¶ï¼Œä¸è¦å†å¤§æ”¹ï¼š

è§†å›¾ "Account" ç»§ç»­ç”¨äºæŸ¥è¯¢ï¼ˆgetUserByAccount ç­‰ï¼‰ï¼Œå­—æ®µä¿æŒé©¼å³°å‘½åã€‚

åº•å±‚çœŸå®æ•°æ®è½åœ¨ oauth_accounts è¡¨ï¼Œç”±æˆ‘ä»¬é‡å†™çš„ linkAccount ç›´æ¥å†™å…¥ã€‚

è¿è¡Œè¿ç§»åï¼Œé‡æ–°å¯åŠ¨ dev ç¯å¢ƒï¼ŒæŒ‰å¤ç°æ­¥éª¤èµ°ä¸€é LINE ç™»å½•ï¼Œç¡®è®¤ï¼š

ä¸å†å‡ºç° column "access_token" of relation "Account" does not existã€‚

ç”¨æˆ·å¯ä»¥æ­£å¸¸ç™»å½•ï¼Œoauth_accounts è¡¨ä¸­æ–°å¢ä¸€æ¡è®°å½•ã€‚

æ›´æ–° src/lib/version.ts ä¸­çš„ç‰ˆæœ¬å·å’Œä¿®å¤æ—¶é—´ï¼Œå¹¶åœ¨é—®é¢˜è¯Šæ–­æŠ¥å‘Šä¸­è¿½åŠ ã€Œæœ¬æ¬¡ä¿®å¤æ–¹æ¡ˆã€å°èŠ‚ã€‚