# NextAuth KyselyAdapter Account è§†å›¾å­—æ®µåä¸åŒ¹é…é—®é¢˜è¯Šæ–­æŠ¥å‘Š

**æŠ¥å‘Šæ—¥æœŸ**: 2025-11-26  
**é—®é¢˜ID**: NEXTAUTH-ACCOUNT-20251126-001

---

## ğŸ“Œ ç¬¬ä¸€éƒ¨åˆ†ï¼šé—®é¢˜æ¦‚è¦ï¼ˆSummaryï¼‰

| å­—æ®µ | å¡«å†™å†…å®¹ |
|------|----------|
| **é—®é¢˜åç§°** | NextAuth KyselyAdapter å†™å…¥ Account è§†å›¾æ—¶å­—æ®µåä¸åŒ¹é…ï¼š`column "access_token" of relation "Account" does not exist` |
| **é—®é¢˜ç­‰çº§** | Criticalï¼ˆé˜»å¡ LINE OAuth ç™»å½•åŠŸèƒ½ï¼‰ |
| **è§¦å‘æ—¶é—´** | 2025-11-26ï¼ˆåå¤å‡ºç°ï¼‰ |
| **è§¦å‘ç¯å¢ƒ** | Development / Production |
| **ç›¸å…³æ¨¡å—** | auth / login / oauth / nextauth / kysely / database |
| **å½“å‰çŠ¶æ€** | å¯å¤ç°ï¼Œå·²å°è¯•å¤šæ¬¡ä¿®å¤ä½†é—®é¢˜ä¾ç„¶å­˜åœ¨ |

---

## ğŸ“Œ ç¬¬äºŒéƒ¨åˆ†ï¼šå¤ç°è·¯å¾„ï¼ˆReproduce Stepsï¼‰

### å‰ç«¯æ“ä½œæ­¥éª¤

1. å¯åŠ¨ Next.js å¼€å‘æœåŠ¡å™¨ï¼ˆ`npm run dev`ï¼‰
2. è®¿é—®ç™»å½•é¡µé¢ï¼ˆ`http://localhost:3000/login`ï¼‰
3. ç‚¹å‡» "ä½¿ç”¨ LINE ç™»å½•" æŒ‰é’®
4. é€‰æ‹© "è·³è½¬æˆæƒ" ç™»å½•æ–¹å¼
5. ç‚¹å‡» "è·³è½¬æˆæƒ" æŒ‰é’®
6. åœ¨ LINE æˆæƒé¡µé¢å®Œæˆæˆæƒ
7. æˆæƒæˆåŠŸåï¼Œç³»ç»Ÿå°è¯•å¤„ç†å›è°ƒ

### è§¦å‘ç‚¹

- LINE OAuth æˆæƒæˆåŠŸï¼Œè¿”å›æˆæƒç ï¼ˆ`code`ï¼‰
- NextAuth ä½¿ç”¨æˆæƒç æ¢å– access token
- NextAuth è°ƒç”¨ `adapter_linkAccount` å°è¯•å°†è´¦æˆ·ä¿¡æ¯å†™å…¥æ•°æ®åº“
- KyselyAdapter æ‰§è¡Œ `INSERT INTO "Account"` æ“ä½œ
- Kysely æ ¹æ® `Database` æ¥å£ä¸­çš„ `Account` ç±»å‹å®šä¹‰ç”Ÿæˆ SQL
- **é—®é¢˜ç‚¹**ï¼šKyselyAdapter ä¼ å…¥çš„å¯¹è±¡ä½¿ç”¨ä¸‹åˆ’çº¿å‘½åï¼ˆ`access_token`ï¼‰ï¼Œä½†è§†å›¾ä½¿ç”¨é©¼å³°å‘½åï¼ˆ`accessToken`ï¼‰
- PostgreSQL æŠ¥é”™ï¼š`column "access_token" of relation "Account" does not exist`

### é”™è¯¯ä¿¡æ¯

```
[auth][error] AdapterError: Read more at https://errors.authjs.dev#adaptererror
[auth][cause]: error: column "access_token" of relation "Account" does not exist
```

### é”™è¯¯å †æ ˆ

```
at PostgresConnection.executeQuery (webpack-internal:///(rsc)/./node_modules/kysely/dist/esm/dialect/postgres/postgres-driver.js:111:101)
at async InsertQueryBuilder.execute (webpack-internal:///(rsc)/./node_modules/kysely/dist/esm/query-builder/insert-query-builder.js:1125:24)
at async linkAccount (webpack-internal:///(rsc)/./node_modules/@auth/kysely-adapter/index.js:114:13)
at async handleLoginOrRegister (webpack-internal:///(rsc)/./node_modules/next-auth/node_modules/@auth/core/lib/actions/callback/handle-login.js:270:9)
```

### æ“ä½œç³»ç»Ÿ / æµè§ˆå™¨ / Node ç‰ˆæœ¬

- macOS / Chrome / Node.js 22.12.0
- Next.js version: 15.5.6
- NextAuth version: 5.0.0-beta.30
- Kysely version: 0.27.3
- @auth/kysely-adapter version: 2.2.0

---

## ğŸ“Œ ç¬¬ä¸‰éƒ¨åˆ†ï¼šå®é™…è¡Œä¸º vs é¢„æœŸè¡Œä¸º

### å®é™…è¡Œä¸º

1. âœ… LINE OAuth æˆæƒæˆåŠŸ
2. âœ… æˆæƒç è·å–æˆåŠŸ
3. âœ… Token äº¤æ¢æˆåŠŸï¼ˆè·å– access_tokenï¼‰
4. âœ… ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼ˆ`adapter_createUser`ï¼‰
5. âŒ è´¦æˆ·å…³è”å¤±è´¥ï¼ˆ`adapter_linkAccount`ï¼‰
6. âŒ é”™è¯¯ï¼š`column "access_token" of relation "Account" does not exist`
7. âŒ ç”¨æˆ·è¢«é‡å®šå‘åˆ°é”™è¯¯é¡µé¢
8. âŒ ç™»å½•å¤±è´¥

### é¢„æœŸè¡Œä¸º

1. âœ… LINE OAuth æˆæƒæˆåŠŸ
2. âœ… æˆæƒç è·å–æˆåŠŸ
3. âœ… Token äº¤æ¢æˆåŠŸ
4. âœ… ç”¨æˆ·åˆ›å»ºæˆåŠŸ
5. âœ… è´¦æˆ·å…³è”æˆåŠŸï¼ˆ`adapter_linkAccount`ï¼‰
6. âœ… Session åˆ›å»ºæˆåŠŸ
7. âœ… ç”¨æˆ·æˆåŠŸç™»å½•ï¼Œé‡å®šå‘åˆ°é¦–é¡µæˆ–æŒ‡å®šé¡µé¢

---

## ğŸ“Œ ç¬¬å››éƒ¨åˆ†ï¼šé—®é¢˜æ ¹æœ¬åŸå› åˆ†æ

### æ ¸å¿ƒé—®é¢˜

**å­—æ®µåå‘½åä¸ä¸€è‡´å¯¼è‡´çš„ç±»å‹ç³»ç»Ÿä¸æ•°æ®åº“è§†å›¾ä¸åŒ¹é…**

### è¯¦ç»†åˆ†æ

#### 1. NextAuth AdapterAccount æ¥å£å®šä¹‰

NextAuth çš„ `AdapterAccount` æ¥å£ç»§æ‰¿è‡ª `Account` æ¥å£ï¼Œè€Œ `Account` æ¥å£ç»§æ‰¿è‡ª `TokenEndpointResponse`ï¼š

```typescript
// @auth/core/types.d.ts
export interface Account extends Partial<TokenEndpointResponse> {
  provider: string;
  providerAccountId: string;  // é©¼å³°å‘½å
  type: ProviderType;
  userId?: string;  // é©¼å³°å‘½å
  expires_at?: number;  // ä¸‹åˆ’çº¿å‘½åï¼ˆæ¥è‡ª TokenEndpointResponseï¼‰
}

// oauth4webapi/build/index.d.ts
export interface TokenEndpointResponse {
  readonly access_token: string;  // ä¸‹åˆ’çº¿å‘½å
  readonly refresh_token?: string;  // ä¸‹åˆ’çº¿å‘½å
  readonly id_token?: string;  // ä¸‹åˆ’çº¿å‘½å
  readonly token_type?: string;  // ä¸‹åˆ’çº¿å‘½å
  // ...
}
```

**å…³é”®å‘ç°**ï¼š
- `AdapterAccount` æ¥å£æ··åˆä½¿ç”¨é©¼å³°å‘½åï¼ˆ`providerAccountId`ã€`userId`ï¼‰å’Œä¸‹åˆ’çº¿å‘½åï¼ˆ`access_token`ã€`refresh_token`ï¼‰
- è¿™æ˜¯å› ä¸º `Account` æ¥å£ç»§æ‰¿è‡ª `TokenEndpointResponse`ï¼Œè€Œ OAuth 2.0 æ ‡å‡†ä½¿ç”¨ä¸‹åˆ’çº¿å‘½å

#### 2. KyselyAdapter çš„å†™å…¥è¡Œä¸º

KyselyAdapter åœ¨ `linkAccount` å‡½æ•°ä¸­ï¼š

```typescript
// @auth/kysely-adapter/src/index.ts
async linkAccount(account) {
  await db
    .insertInto("Account")
    .values(to(account))  // ç›´æ¥ä¼ å…¥ AdapterAccount å¯¹è±¡
    .executeTakeFirstOrThrow()
  return account
}
```

**å…³é”®å‘ç°**ï¼š
- `to(account)` å¯¹äº PostgreSQL åªæ˜¯è¿”å›åŸå¯¹è±¡ï¼ˆä¸è¿›è¡Œå­—æ®µåè½¬æ¢ï¼‰
- Kysely æ ¹æ® `Database` æ¥å£ä¸­çš„ `Account` ç±»å‹å®šä¹‰æ¥éªŒè¯å­—æ®µå
- å¦‚æœ `Database.Account` ä½¿ç”¨é©¼å³°å‘½åï¼ŒKysely æœŸæœ›ä¼ å…¥çš„å¯¹è±¡ä¹Ÿä½¿ç”¨é©¼å³°å‘½å
- ä½†å®é™…ä¼ å…¥çš„ `AdapterAccount` å¯¹è±¡ä½¿ç”¨ä¸‹åˆ’çº¿å‘½åï¼ˆ`access_token`ï¼‰

#### 3. KyselyAdapter çš„æŸ¥è¯¢è¡Œä¸º

KyselyAdapter åœ¨ `getUserByAccount` å‡½æ•°ä¸­ï¼š

```typescript
// @auth/kysely-adapter/src/index.ts
async getUserByAccount({ providerAccountId, provider }) {
  const result = await db
    .selectFrom("User")
    .innerJoin("Account", "User.id", "Account.userId")  // ä½¿ç”¨é©¼å³°å‘½å
    .selectAll("User")
    .where("Account.providerAccountId", "=", providerAccountId)  // ä½¿ç”¨é©¼å³°å‘½å
    .where("Account.provider", "=", provider)
    .executeTakeFirst()
  // ...
}
```

**å…³é”®å‘ç°**ï¼š
- KyselyAdapter åœ¨æŸ¥è¯¢æ—¶ä½¿ç”¨é©¼å³°å‘½åï¼ˆ`Account.userId`ã€`Account.providerAccountId`ï¼‰
- è¿™è¯´æ˜ KyselyAdapter æœŸæœ›è§†å›¾ä½¿ç”¨é©¼å³°å‘½å

#### 4. æ•°æ®åº“è§†å›¾å®šä¹‰

å½“å‰ `Account` è§†å›¾å®šä¹‰ï¼ˆ`20251126_create_nextauth_table_views.sql`ï¼‰ï¼š

```sql
CREATE VIEW "Account" AS
SELECT 
  id::text as id,
  user_id::text as "userId",  -- é©¼å³°å‘½å
  provider,
  provider_account_id as "providerAccountId",  -- é©¼å³°å‘½å
  access_token as "accessToken",  -- é©¼å³°å‘½å
  refresh_token as "refreshToken",  -- é©¼å³°å‘½å
  -- ...
FROM oauth_accounts;
```

**å…³é”®å‘ç°**ï¼š
- è§†å›¾ä½¿ç”¨é©¼å³°å‘½åï¼Œä¸ KyselyAdapter çš„æŸ¥è¯¢è¡Œä¸ºä¸€è‡´
- ä½† KyselyAdapter å†™å…¥æ—¶ä¼ å…¥çš„å¯¹è±¡ä½¿ç”¨ä¸‹åˆ’çº¿å‘½åï¼ˆ`access_token`ï¼‰
- å¯¼è‡´å­—æ®µåä¸åŒ¹é…

#### 5. Kysely ç±»å‹å®šä¹‰

å½“å‰ `Database` æ¥å£å®šä¹‰ï¼ˆ`src/lib/db.ts`ï¼‰ï¼š

```typescript
interface AccountTable {
  id: string;
  userId: string;  // é©¼å³°å‘½å
  provider: string;
  providerAccountId: string;  // é©¼å³°å‘½å
  accessToken: string | null;  // é©¼å³°å‘½å
  refreshToken: string | null;  // é©¼å³°å‘½å
  // ...
}

interface Database {
  Account: AccountTable;  // ä½¿ç”¨é©¼å³°å‘½å
  // ...
}
```

**å…³é”®å‘ç°**ï¼š
- `AccountTable` æ¥å£ä½¿ç”¨é©¼å³°å‘½åï¼Œä¸è§†å›¾å®šä¹‰ä¸€è‡´
- ä½† KyselyAdapter å†™å…¥æ—¶ä¼ å…¥çš„å¯¹è±¡ä½¿ç”¨ä¸‹åˆ’çº¿å‘½å
- Kysely æ ¹æ® `AccountTable` ç±»å‹å®šä¹‰éªŒè¯å­—æ®µåï¼ŒæœŸæœ›é©¼å³°å‘½å
- ä½†å®é™…ä¼ å…¥çš„å¯¹è±¡ä½¿ç”¨ä¸‹åˆ’çº¿å‘½åï¼Œå¯¼è‡´éªŒè¯å¤±è´¥

### é—®é¢˜æ ¹æºæ€»ç»“

1. **å‘½åä¸ä¸€è‡´çš„æ ¹æº**ï¼š
   - NextAuth çš„ `AdapterAccount` æ¥å£æ··åˆä½¿ç”¨é©¼å³°å‘½åå’Œä¸‹åˆ’çº¿å‘½å
   - `TokenEndpointResponse`ï¼ˆOAuth 2.0 æ ‡å‡†ï¼‰ä½¿ç”¨ä¸‹åˆ’çº¿å‘½å
   - `Account` æ¥å£çš„éƒ¨åˆ†å­—æ®µï¼ˆå¦‚ `providerAccountId`ã€`userId`ï¼‰ä½¿ç”¨é©¼å³°å‘½å

2. **KyselyAdapter çš„è¡Œä¸º**ï¼š
   - æŸ¥è¯¢æ—¶ä½¿ç”¨é©¼å³°å‘½åï¼ˆæœŸæœ›è§†å›¾ä½¿ç”¨é©¼å³°å‘½åï¼‰
   - å†™å…¥æ—¶ç›´æ¥ä¼ å…¥ `AdapterAccount` å¯¹è±¡ï¼ˆä½¿ç”¨ä¸‹åˆ’çº¿å‘½åï¼‰

3. **ç±»å‹ç³»ç»Ÿä¸æ•°æ®åº“è§†å›¾çš„å†²çª**ï¼š
   - Kysely æ ¹æ® `Database.Account` ç±»å‹å®šä¹‰éªŒè¯å­—æ®µå
   - å¦‚æœ `AccountTable` ä½¿ç”¨é©¼å³°å‘½åï¼ŒKysely æœŸæœ›ä¼ å…¥çš„å¯¹è±¡ä¹Ÿä½¿ç”¨é©¼å³°å‘½å
   - ä½†å®é™…ä¼ å…¥çš„å¯¹è±¡ä½¿ç”¨ä¸‹åˆ’çº¿å‘½åï¼Œå¯¼è‡´éªŒè¯å¤±è´¥

---

## ğŸ“Œ ç¬¬äº”éƒ¨åˆ†ï¼šå·²é‡‡å–çš„ä¿®å¤æªæ–½

### æªæ–½1ï¼šåˆ›å»º AccountTable æ¥å£ï¼ˆä½¿ç”¨é©¼å³°å‘½åï¼‰

**æ—¶é—´**: 2025-11-26 21:42:51

**æ–‡ä»¶**: `src/lib/db.ts`

**å†…å®¹**:
```typescript
interface AccountTable {
  id: string;
  userId: string;  // é©¼å³°å‘½å
  provider: string;
  providerAccountId: string;  // é©¼å³°å‘½å
  accessToken: string | null;  // é©¼å³°å‘½å
  refreshToken: string | null;  // é©¼å³°å‘½å
  expiresAt: Date | null;  // é©¼å³°å‘½å
  tokenType: string | null;  // é©¼å³°å‘½å
  scope: string | null;
  idToken: string | null;  // é©¼å³°å‘½å
  sessionState: string | null;  // é©¼å³°å‘½å
  createdAt: Date;  // é©¼å³°å‘½å
  updatedAt: Date;  // é©¼å³°å‘½å
}

interface Database {
  Account: AccountTable;  // ä½¿ç”¨ AccountTable è€Œä¸æ˜¯ OAuthAccountTable
  // ...
}
```

**ç›®çš„**: 
- è®© Kysely æœŸæœ›è§†å›¾ä½¿ç”¨é©¼å³°å‘½å
- ä¸ KyselyAdapter çš„æŸ¥è¯¢è¡Œä¸ºä¸€è‡´

**ç»“æœ**: 
- âŒ é—®é¢˜ä¾ç„¶å­˜åœ¨
- KyselyAdapter å†™å…¥æ—¶ä¼ å…¥çš„å¯¹è±¡ä»ç„¶ä½¿ç”¨ä¸‹åˆ’çº¿å‘½å

### æªæ–½2ï¼šä¿®æ”¹ Account è§†å›¾ä½¿ç”¨é©¼å³°å‘½å

**æ—¶é—´**: 2025-11-26 21:38:06

**æ–‡ä»¶**: 
- `src/migrations/20251126_create_nextauth_table_views.sql`
- `src/migrations/20251126_alter_users_and_auth_ids_to_text.sql`

**å†…å®¹**:
```sql
CREATE VIEW "Account" AS
SELECT 
  id::text as id,
  user_id::text as "userId",  -- é©¼å³°å‘½å
  provider,
  provider_account_id as "providerAccountId",  -- é©¼å³°å‘½å
  access_token as "accessToken",  -- é©¼å³°å‘½å
  refresh_token as "refreshToken",  -- é©¼å³°å‘½å
  -- ...
FROM oauth_accounts;
```

**ç›®çš„**: 
- è®©è§†å›¾ä½¿ç”¨é©¼å³°å‘½åï¼Œä¸ KyselyAdapter çš„æŸ¥è¯¢è¡Œä¸ºä¸€è‡´

**ç»“æœ**: 
- âŒ é—®é¢˜ä¾ç„¶å­˜åœ¨
- KyselyAdapter å†™å…¥æ—¶ä¼ å…¥çš„å¯¹è±¡ä»ç„¶ä½¿ç”¨ä¸‹åˆ’çº¿å‘½å

### æªæ–½3ï¼šä¿®æ”¹è§¦å‘å™¨åŒæ—¶æ”¯æŒä¸¤ç§å‘½åæ–¹å¼

**æ—¶é—´**: 2025-11-26 21:58:30

**æ–‡ä»¶**: `src/migrations/20251126_create_nextauth_view_triggers.sql`

**å†…å®¹**:
```sql
CREATE OR REPLACE FUNCTION account_view_insert()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO oauth_accounts (...) VALUES (
    COALESCE(NEW."userId", NEW.user_id),  -- æ”¯æŒé©¼å³°æˆ–ä¸‹åˆ’çº¿
    COALESCE(NEW."accessToken", NEW.access_token),  -- æ”¯æŒé©¼å³°æˆ–ä¸‹åˆ’çº¿
    -- ...
  );
END;
$$ LANGUAGE plpgsql;
```

**ç›®çš„**: 
- è®©è§¦å‘å™¨åŒæ—¶æ”¯æŒé©¼å³°å‘½åå’Œä¸‹åˆ’çº¿å‘½å
- å¤„ç† KyselyAdapter å†™å…¥æ—¶ä¼ å…¥çš„å¯¹è±¡ä½¿ç”¨ä¸‹åˆ’çº¿å‘½åçš„æƒ…å†µ

**ç»“æœ**: 
- âŒ é—®é¢˜ä¾ç„¶å­˜åœ¨
- **æ ¹æœ¬åŸå› **ï¼šKysely åœ¨ç”Ÿæˆ SQL æ—¶ï¼Œæ ¹æ® `Database.Account` ç±»å‹å®šä¹‰éªŒè¯å­—æ®µå
- å¦‚æœ `AccountTable` ä½¿ç”¨é©¼å³°å‘½åï¼ŒKysely æœŸæœ›ä¼ å…¥çš„å¯¹è±¡ä¹Ÿä½¿ç”¨é©¼å³°å‘½å
- ä½†å®é™…ä¼ å…¥çš„å¯¹è±¡ä½¿ç”¨ä¸‹åˆ’çº¿å‘½åï¼Œå¯¼è‡´ Kysely åœ¨ç”Ÿæˆ SQL æ—¶å°±å¤±è´¥äº†ï¼ˆåœ¨è§¦å‘å™¨æ‰§è¡Œä¹‹å‰ï¼‰

### æªæ–½æ€»ç»“

æ‰€æœ‰å·²é‡‡å–çš„æªæ–½éƒ½è¯•å›¾è§£å†³å­—æ®µåä¸åŒ¹é…é—®é¢˜ï¼Œä½†éƒ½æœªèƒ½è§£å†³æ ¹æœ¬åŸå› ï¼š

1. **é—®é¢˜ä¸åœ¨è§†å›¾å®šä¹‰**ï¼šè§†å›¾å®šä¹‰æ˜¯æ­£ç¡®çš„ï¼ˆä½¿ç”¨é©¼å³°å‘½åï¼‰
2. **é—®é¢˜ä¸åœ¨è§¦å‘å™¨**ï¼šè§¦å‘å™¨å¯ä»¥å¤„ç†ä¸¤ç§å‘½åæ–¹å¼
3. **é—®é¢˜åœ¨ Kysely çš„ç±»å‹éªŒè¯**ï¼šKysely æ ¹æ® `Database.Account` ç±»å‹å®šä¹‰éªŒè¯å­—æ®µåï¼ŒæœŸæœ›é©¼å³°å‘½åï¼Œä½†å®é™…ä¼ å…¥çš„å¯¹è±¡ä½¿ç”¨ä¸‹åˆ’çº¿å‘½å

---

## ğŸ“Œ ç¬¬å…­éƒ¨åˆ†ï¼šdb.ts ä¸­ AccountTable æ¥å£çš„å¿…è¦æ€§è®ºè¯

### ä¸ºä»€ä¹ˆéœ€è¦ AccountTable æ¥å£ï¼Ÿ

#### 1. Kysely ç±»å‹ç³»ç»Ÿçš„è¦æ±‚

Kysely æ˜¯ä¸€ä¸ªç±»å‹å®‰å…¨çš„ SQL æŸ¥è¯¢æ„å»ºå™¨ï¼Œå®ƒè¦æ±‚ï¼š

1. **ç±»å‹å®šä¹‰å¿…é¡»ä¸æ•°æ®åº“ç»“æ„ä¸€è‡´**ï¼š
   - Kysely æ ¹æ® `Database` æ¥å£ä¸­çš„ç±»å‹å®šä¹‰æ¥éªŒè¯å­—æ®µå
   - å¦‚æœ `Database.Account` ä½¿ç”¨é©¼å³°å‘½åï¼ŒKysely æœŸæœ›è§†å›¾ä¹Ÿä½¿ç”¨é©¼å³°å‘½å
   - å¦‚æœ `Database.Account` ä½¿ç”¨ä¸‹åˆ’çº¿å‘½åï¼ŒKysely æœŸæœ›è§†å›¾ä¹Ÿä½¿ç”¨ä¸‹åˆ’çº¿å‘½å

2. **ç±»å‹å®‰å…¨**ï¼š
   - Kysely åœ¨ç¼–è¯‘æ—¶æ£€æŸ¥å­—æ®µåæ˜¯å¦æ­£ç¡®
   - å¦‚æœç±»å‹å®šä¹‰ä¸æ•°æ®åº“ç»“æ„ä¸åŒ¹é…ï¼ŒTypeScript ä¼šæŠ¥é”™

#### 2. KyselyAdapter çš„æŸ¥è¯¢è¡Œä¸º

KyselyAdapter åœ¨æŸ¥è¯¢æ—¶ä½¿ç”¨é©¼å³°å‘½åï¼š

```typescript
// @auth/kysely-adapter/src/index.ts
async getUserByAccount({ providerAccountId, provider }) {
  const result = await db
    .selectFrom("User")
    .innerJoin("Account", "User.id", "Account.userId")  // ä½¿ç”¨é©¼å³°å‘½å
    .selectAll("User")
    .where("Account.providerAccountId", "=", providerAccountId)  // ä½¿ç”¨é©¼å³°å‘½å
    .where("Account.provider", "=", provider)
    .executeTakeFirst()
  // ...
}
```

**ç»“è®º**ï¼š
- KyselyAdapter æœŸæœ›è§†å›¾ä½¿ç”¨é©¼å³°å‘½å
- å› æ­¤ï¼Œ`Database.Account` å¿…é¡»ä½¿ç”¨é©¼å³°å‘½å
- å› æ­¤ï¼Œéœ€è¦ `AccountTable` æ¥å£ï¼ˆä½¿ç”¨é©¼å³°å‘½åï¼‰

#### 3. ä¸ OAuthAccountTable çš„åŒºåˆ«

`OAuthAccountTable` æ¥å£å®šä¹‰åº•å±‚è¡¨ç»“æ„ï¼ˆä½¿ç”¨ä¸‹åˆ’çº¿å‘½åï¼‰ï¼š

```typescript
interface OAuthAccountTable {
  id: Generated<number>;
  user_id: string;  // ä¸‹åˆ’çº¿å‘½å
  provider: string;
  provider_account_id: string;  // ä¸‹åˆ’çº¿å‘½å
  access_token: string | null;  // ä¸‹åˆ’çº¿å‘½å
  // ...
}
```

`AccountTable` æ¥å£å®šä¹‰è§†å›¾ç»“æ„ï¼ˆä½¿ç”¨é©¼å³°å‘½åï¼‰ï¼š

```typescript
interface AccountTable {
  id: string;
  userId: string;  // é©¼å³°å‘½å
  provider: string;
  providerAccountId: string;  // é©¼å³°å‘½å
  accessToken: string | null;  // é©¼å³°å‘½å
  // ...
}
```

**ç»“è®º**ï¼š
- `OAuthAccountTable` ç”¨äºåº•å±‚è¡¨ï¼ˆ`oauth_accounts`ï¼‰
- `AccountTable` ç”¨äºè§†å›¾ï¼ˆ`Account`ï¼‰
- ä¸¤è€…å¿…é¡»åˆ†å¼€å®šä¹‰ï¼Œå› ä¸ºå‘½åçº¦å®šä¸åŒ

#### 4. ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ä½¿ç”¨ OAuthAccountTableï¼Ÿ

å¦‚æœ `Database.Account` ä½¿ç”¨ `OAuthAccountTable`ï¼ˆä¸‹åˆ’çº¿å‘½åï¼‰ï¼š

1. **æŸ¥è¯¢å¤±è´¥**ï¼š
   - KyselyAdapter æŸ¥è¯¢æ—¶ä½¿ç”¨é©¼å³°å‘½åï¼ˆ`Account.userId`ï¼‰
   - ä½†è§†å›¾ä½¿ç”¨ä¸‹åˆ’çº¿å‘½åï¼ˆ`user_id`ï¼‰
   - å¯¼è‡´æŸ¥è¯¢å¤±è´¥

2. **ç±»å‹ä¸åŒ¹é…**ï¼š
   - Kysely æœŸæœ›è§†å›¾ä½¿ç”¨ä¸‹åˆ’çº¿å‘½å
   - ä½†è§†å›¾å®é™…ä½¿ç”¨é©¼å³°å‘½å
   - å¯¼è‡´ç±»å‹ä¸åŒ¹é…

**ç»“è®º**ï¼š
- ä¸èƒ½ç›´æ¥ä½¿ç”¨ `OAuthAccountTable`
- å¿…é¡»åˆ›å»º `AccountTable` æ¥å£ï¼ˆä½¿ç”¨é©¼å³°å‘½åï¼‰

### AccountTable æ¥å£çš„å¿…è¦æ€§æ€»ç»“

1. **ç±»å‹å®‰å…¨**ï¼šKysely éœ€è¦ç±»å‹å®šä¹‰æ¥éªŒè¯å­—æ®µå
2. **æŸ¥è¯¢å…¼å®¹**ï¼šKyselyAdapter æŸ¥è¯¢æ—¶ä½¿ç”¨é©¼å³°å‘½åï¼Œè§†å›¾å¿…é¡»ä½¿ç”¨é©¼å³°å‘½å
3. **å‘½åçº¦å®š**ï¼šè§†å›¾ä½¿ç”¨é©¼å³°å‘½åï¼Œåº•å±‚è¡¨ä½¿ç”¨ä¸‹åˆ’çº¿å‘½åï¼Œå¿…é¡»åˆ†å¼€å®šä¹‰
4. **æ¶æ„æ¸…æ™°**ï¼šæ˜ç¡®åŒºåˆ†è§†å›¾ç±»å‹å®šä¹‰å’Œè¡¨ç±»å‹å®šä¹‰

---

## ğŸ“Œ ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå½“å‰é—®é¢˜çŠ¶æ€

### é—®é¢˜ä¾ç„¶å­˜åœ¨

å°½ç®¡é‡‡å–äº†å¤šé¡¹ä¿®å¤æªæ–½ï¼Œé—®é¢˜ä¾ç„¶å­˜åœ¨ï¼š

```
[auth][error] AdapterError: Read more at https://errors.authjs.dev#adaptererror
[auth][cause]: error: column "access_token" of relation "Account" does not exist
```

### æ ¹æœ¬åŸå› 

**Kysely åœ¨ç”Ÿæˆ SQL æ—¶ï¼Œæ ¹æ® `Database.Account` ç±»å‹å®šä¹‰éªŒè¯å­—æ®µåï¼ŒæœŸæœ›é©¼å³°å‘½åï¼Œä½†å®é™…ä¼ å…¥çš„å¯¹è±¡ä½¿ç”¨ä¸‹åˆ’çº¿å‘½åï¼Œå¯¼è‡´éªŒè¯å¤±è´¥ã€‚**

### é—®é¢˜æµç¨‹

1. KyselyAdapter è°ƒç”¨ `linkAccount(account)`
2. ä¼ å…¥çš„ `account` å¯¹è±¡ä½¿ç”¨ä¸‹åˆ’çº¿å‘½åï¼ˆ`access_token`ï¼‰
3. Kysely æ ¹æ® `Database.Account`ï¼ˆ`AccountTable`ï¼‰ç±»å‹å®šä¹‰éªŒè¯å­—æ®µå
4. `AccountTable` ä½¿ç”¨é©¼å³°å‘½åï¼ˆ`accessToken`ï¼‰
5. Kysely æœŸæœ›ä¼ å…¥çš„å¯¹è±¡ä¹Ÿä½¿ç”¨é©¼å³°å‘½å
6. ä½†å®é™…ä¼ å…¥çš„å¯¹è±¡ä½¿ç”¨ä¸‹åˆ’çº¿å‘½å
7. **Kysely åœ¨ç”Ÿæˆ SQL æ—¶å°±å¤±è´¥äº†**ï¼ˆåœ¨è§¦å‘å™¨æ‰§è¡Œä¹‹å‰ï¼‰

### ä¸ºä»€ä¹ˆè§¦å‘å™¨æ— æ³•è§£å†³ï¼Ÿ

è§¦å‘å™¨åœ¨ PostgreSQL å±‚é¢æ‰§è¡Œï¼Œä½†é—®é¢˜å‘ç”Ÿåœ¨ Kysely ç”Ÿæˆ SQL æ—¶ï¼š

1. Kysely æ ¹æ®ç±»å‹å®šä¹‰ç”Ÿæˆ SQL
2. å¦‚æœå­—æ®µåä¸åŒ¹é…ï¼ŒKysely åœ¨ç”Ÿæˆ SQL æ—¶å°±å¤±è´¥äº†
3. SQL æ°¸è¿œä¸ä¼šåˆ°è¾¾ PostgreSQL
4. è§¦å‘å™¨æ°¸è¿œä¸ä¼šæ‰§è¡Œ

---

## ğŸ“Œ ç¬¬å…«éƒ¨åˆ†ï¼šå¯èƒ½çš„è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®æ”¹ AccountTable æ¥å£ä½¿ç”¨ä¸‹åˆ’çº¿å‘½å

**æ€è·¯**ï¼š
- è®© `AccountTable` æ¥å£ä½¿ç”¨ä¸‹åˆ’çº¿å‘½åï¼ˆä¸ `TokenEndpointResponse` ä¸€è‡´ï¼‰
- ä¿®æ”¹è§†å›¾å®šä¹‰ä¹Ÿä½¿ç”¨ä¸‹åˆ’çº¿å‘½å
- ä¿®æ”¹è§¦å‘å™¨å¤„ç†ä¸‹åˆ’çº¿å‘½å

**ä¼˜ç‚¹**ï¼š
- ä¸ `TokenEndpointResponse` ä¸€è‡´
- KyselyAdapter å†™å…¥æ—¶ä¼ å…¥çš„å¯¹è±¡ä½¿ç”¨ä¸‹åˆ’çº¿å‘½åï¼Œå¯ä»¥ç›´æ¥åŒ¹é…

**ç¼ºç‚¹**ï¼š
- KyselyAdapter æŸ¥è¯¢æ—¶ä½¿ç”¨é©¼å³°å‘½åï¼ˆ`Account.userId`ï¼‰ï¼Œéœ€è¦ä¿®æ”¹æŸ¥è¯¢é€»è¾‘
- ä½† KyselyAdapter æ˜¯ç¬¬ä¸‰æ–¹åº“ï¼Œæ— æ³•ä¿®æ”¹

**å¯è¡Œæ€§**ï¼šâŒ ä¸å¯è¡Œï¼ˆæ— æ³•ä¿®æ”¹ KyselyAdapter çš„æŸ¥è¯¢é€»è¾‘ï¼‰

### æ–¹æ¡ˆ2ï¼šåœ¨ KyselyAdapter å’Œæ•°æ®åº“ä¹‹é—´æ·»åŠ é€‚é…å±‚

**æ€è·¯**ï¼š
- åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„ KyselyAdapter åŒ…è£…å™¨
- åœ¨å†™å…¥æ—¶ï¼Œå°†ä¸‹åˆ’çº¿å‘½åè½¬æ¢ä¸ºé©¼å³°å‘½å
- åœ¨è¯»å–æ—¶ï¼Œå°†é©¼å³°å‘½åè½¬æ¢ä¸ºä¸‹åˆ’çº¿å‘½å

**ä¼˜ç‚¹**ï¼š
- ä¸éœ€è¦ä¿®æ”¹è§†å›¾å®šä¹‰
- ä¸éœ€è¦ä¿®æ”¹è§¦å‘å™¨

**ç¼ºç‚¹**ï¼š
- éœ€è¦ç»´æŠ¤é¢å¤–çš„é€‚é…å±‚
- å¯èƒ½å½±å“æ€§èƒ½

**å¯è¡Œæ€§**ï¼šâœ… å¯è¡Œï¼ˆä½†éœ€è¦é¢å¤–ç»´æŠ¤ï¼‰

### æ–¹æ¡ˆ3ï¼šä¿®æ”¹è§†å›¾åŒæ—¶æ”¯æŒä¸¤ç§å‘½åæ–¹å¼ï¼ˆä½¿ç”¨åˆ«åï¼‰

**æ€è·¯**ï¼š
- PostgreSQL è§†å›¾ä¸èƒ½æœ‰é‡å¤çš„åˆ—å
- ä½†å¯ä»¥é€šè¿‡è®¡ç®—åˆ—æˆ–å‡½æ•°æ¥å®ç°

**ä¼˜ç‚¹**ï¼š
- ä¸éœ€è¦ä¿®æ”¹ç±»å‹å®šä¹‰
- ä¸éœ€è¦ä¿®æ”¹è§¦å‘å™¨

**ç¼ºç‚¹**ï¼š
- PostgreSQL è§†å›¾ä¸èƒ½æœ‰é‡å¤çš„åˆ—å
- æ— æ³•å®ç°

**å¯è¡Œæ€§**ï¼šâŒ ä¸å¯è¡Œï¼ˆPostgreSQL é™åˆ¶ï¼‰

### æ–¹æ¡ˆ4ï¼šä½¿ç”¨ Kysely çš„å­—æ®µæ˜ å°„åŠŸèƒ½

**æ€è·¯**ï¼š
- ä½¿ç”¨ Kysely çš„å­—æ®µæ˜ å°„åŠŸèƒ½ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
- åœ¨ç±»å‹å®šä¹‰ä¸­æŒ‡å®šå­—æ®µæ˜ å°„è§„åˆ™

**ä¼˜ç‚¹**ï¼š
- ä¸éœ€è¦ä¿®æ”¹è§†å›¾å®šä¹‰
- ä¸éœ€è¦ä¿®æ”¹è§¦å‘å™¨

**ç¼ºç‚¹**ï¼š
- Kysely å¯èƒ½ä¸æ”¯æŒå­—æ®µæ˜ å°„åŠŸèƒ½
- éœ€è¦éªŒè¯

**å¯è¡Œæ€§**ï¼šâ“ éœ€è¦éªŒè¯

### æ¨èæ–¹æ¡ˆ

**æ–¹æ¡ˆ2ï¼šåœ¨ KyselyAdapter å’Œæ•°æ®åº“ä¹‹é—´æ·»åŠ é€‚é…å±‚**

è¿™æ˜¯æœ€å¯è¡Œçš„æ–¹æ¡ˆï¼Œå› ä¸ºï¼š
1. ä¸éœ€è¦ä¿®æ”¹ç¬¬ä¸‰æ–¹åº“ï¼ˆKyselyAdapterï¼‰
2. ä¸éœ€è¦ä¿®æ”¹æ•°æ®åº“è§†å›¾å®šä¹‰
3. å¯ä»¥å®Œå…¨æ§åˆ¶å­—æ®µåè½¬æ¢é€»è¾‘

---

## ğŸ“Œ ç¬¬ä¹éƒ¨åˆ†ï¼šç›¸å…³æ–‡ä»¶æ¸…å•

### å·²ä¿®æ”¹çš„æ–‡ä»¶

1. `src/lib/db.ts`
   - æ–°å¢ `AccountTable` æ¥å£ï¼ˆä½¿ç”¨é©¼å³°å‘½åï¼‰
   - æ›´æ–° `Database` æ¥å£ï¼Œä½¿ç”¨ `AccountTable` è€Œä¸æ˜¯ `OAuthAccountTable`

2. `src/migrations/20251126_create_nextauth_table_views.sql`
   - ä¿®æ”¹ `Account` è§†å›¾å®šä¹‰ï¼Œä½¿ç”¨é©¼å³°å‘½å

3. `src/migrations/20251126_alter_users_and_auth_ids_to_text.sql`
   - ä¿®æ”¹ `Account` è§†å›¾å®šä¹‰ï¼Œä½¿ç”¨é©¼å³°å‘½å

4. `src/migrations/20251126_create_nextauth_view_triggers.sql`
   - ä¿®æ”¹ `account_view_insert()` å’Œ `account_view_update()` å‡½æ•°ï¼Œä½¿ç”¨ `COALESCE` åŒæ—¶æ”¯æŒé©¼å³°å’Œä¸‹åˆ’çº¿å‘½å

5. `src/lib/version.ts`
   - æ›´æ–°ç‰ˆæœ¬å·ä¸º `2025-11-26 21:58:30`

### ç›¸å…³ä»£ç æ–‡ä»¶

1. `src/lib/auth.ts` - NextAuth é…ç½®
2. `src/lib/db.ts` - Kysely ç±»å‹å®šä¹‰
3. `src/migrations/20251126_create_nextauth_table_views.sql` - è§†å›¾å®šä¹‰
4. `src/migrations/20251126_create_nextauth_view_triggers.sql` - è§¦å‘å™¨å®šä¹‰

### ç¬¬ä¸‰æ–¹åº“

1. `@auth/kysely-adapter` - NextAuth KyselyAdapter
2. `kysely` - Kysely ORM
3. `@auth/core` - NextAuth æ ¸å¿ƒåº“
4. `oauth4webapi` - OAuth 4 Web API

---

## ğŸ“Œ ç¬¬åéƒ¨åˆ†ï¼šé™„å½•ï¼ˆAttachmentsï¼‰

### ç›¸å…³ä»£ç ç‰‡æ®µ

#### KyselyAdapter linkAccount å‡½æ•°

```typescript
// node_modules/@auth/kysely-adapter/src/index.ts
async linkAccount(account) {
  await db
    .insertInto("Account")
    .values(to(account))  // ç›´æ¥ä¼ å…¥ AdapterAccount å¯¹è±¡
    .executeTakeFirstOrThrow()
  return account
}
```

#### AdapterAccount æ¥å£å®šä¹‰

```typescript
// node_modules/@auth/core/types.d.ts
export interface Account extends Partial<TokenEndpointResponse> {
  provider: string;
  providerAccountId: string;  // é©¼å³°å‘½å
  type: ProviderType;
  userId?: string;  // é©¼å³°å‘½å
  expires_at?: number;  // ä¸‹åˆ’çº¿å‘½å
}

// node_modules/oauth4webapi/build/index.d.ts
export interface TokenEndpointResponse {
  readonly access_token: string;  // ä¸‹åˆ’çº¿å‘½å
  readonly refresh_token?: string;  // ä¸‹åˆ’çº¿å‘½å
  readonly id_token?: string;  // ä¸‹åˆ’çº¿å‘½å
  readonly token_type?: string;  // ä¸‹åˆ’çº¿å‘½å
}
```

#### AccountTable æ¥å£å®šä¹‰

```typescript
// src/lib/db.ts
interface AccountTable {
  id: string;
  userId: string;  // é©¼å³°å‘½å
  provider: string;
  providerAccountId: string;  // é©¼å³°å‘½å
  accessToken: string | null;  // é©¼å³°å‘½å
  refreshToken: string | null;  // é©¼å³°å‘½å
  expiresAt: Date | null;  // é©¼å³°å‘½å
  tokenType: string | null;  // é©¼å³°å‘½å
  scope: string | null;
  idToken: string | null;  // é©¼å³°å‘½å
  sessionState: string | null;  // é©¼å³°å‘½å
  createdAt: Date;  // é©¼å³°å‘½å
  updatedAt: Date;  // é©¼å³°å‘½å
}
```

### æ•°æ®åº“è¡¨ç»“æ„

- `oauth_accounts` è¡¨ï¼šä½¿ç”¨ä¸‹åˆ’çº¿å‘½åï¼ˆ`user_id`ã€`access_token` ç­‰ï¼‰
- `Account` è§†å›¾ï¼šä½¿ç”¨é©¼å³°å‘½åï¼ˆ`userId`ã€`accessToken` ç­‰ï¼‰

### ç›¸å…³æ–‡æ¡£

- `docs/ç ”å‘è§„èŒƒ/æ•°æ®åº“ç»“æ„_DRIVEQUIZ.md`
- `docs/ç ”å‘è§„èŒƒ/æ–‡ä»¶ç»“æ„.md`
- `docs/é—®é¢˜ä¿®å¤/LINE_OAuth_JWTç®—æ³•ä¸åŒ¹é…é—®é¢˜/è¯Šæ–­æŠ¥å‘Š/é—®é¢˜è¯Šæ–­æŠ¥å‘Š.md`

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-26  
**æŠ¥å‘Šç”Ÿæˆå·¥å…·**: Cursor AI Assistant

