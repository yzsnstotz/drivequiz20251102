# 数据库配置修复说明

## 问题诊断

### 发现的问题
1. ❌ `.env` 文件使用 `POSTGRES_URL`，但代码优先使用 `DATABASE_URL`
2. ❌ 连接字符串格式有问题（`sslmode=disable` 和奇怪的参数 `supa=base-pooler.x`）
3. ❌ 缺少 `AI_DATABASE_URL` 环境变量
4. ❌ 数据库名称错误（`drive-quiz` 应该是 `postgres`）

## 修复方案

### 已创建的 `.env.local` 文件

```bash
# DriveQuiz 主应用数据库（使用连接池，端口 6543）
DATABASE_URL=postgresql://postgres.vdtnzjvmvrcdplawwiae:tcaZ6b577mojAkYw@aws-1-ap-southeast-1.pooler.supabase.com:6543/postgres?sslmode=require

# AI Service 数据库（直接连接，端口 5432）
AI_DATABASE_URL=postgresql://postgres:zKV0rtIV1QOByu89@db.cgpmpfnjzlzbquakmmrj.supabase.co:5432/postgres?sslmode=require

# 管理员 Token
ADMIN_TOKEN=Aa123456

# 时区
TZ=UTC
```

## 关键修复点

### 1. 使用 `DATABASE_URL` 而不是 `POSTGRES_URL`
- 代码优先读取 `DATABASE_URL`
- `.env.local` 会覆盖 `.env` 中的配置

### 2. 修复连接字符串格式
- ✅ 使用 `postgresql://` 协议（而不是 `postgres://`）
- ✅ 使用 `sslmode=require`（而不是 `sslmode=disable`）
- ✅ 数据库名称改为 `postgres`（而不是 `drive-quiz`）
- ✅ 移除奇怪的参数 `supa=base-pooler.x`

### 3. 添加 `AI_DATABASE_URL`
- ✅ 用于 AI Service 数据库连接
- ✅ 使用直接连接（端口 5432）

## 验证结果

### 数据库连接状态
```json
{
  "connection": {
    "status": "success",
    "error": null
  },
  "tables": {
    "status": "complete"
  }
}
```

✅ **数据库连接已成功！**

## 注意事项

### 连接池 vs 直接连接

**当前配置使用连接池**（端口 6543）：
- ✅ 优点：连接稳定，适合高并发
- ⚠️ 注意：某些高级功能可能不支持

**如果需要直接连接**（端口 5432）：
- 可以取消注释 `.env.local` 中的备用配置
- 需要确保网络可以访问 `db.vdtnzjvmvrcdplawwiae.supabase.co:5432`

### 环境变量优先级

Next.js 环境变量加载顺序：
1. `.env.local`（最高优先级，本地开发）
2. `.env.development`（开发环境）
3. `.env`（默认配置）

## 下一步

1. ✅ 数据库连接已修复
2. ✅ 开发服务器已重启
3. ✅ 可以正常访问 http://localhost:3000

现在可以正常使用应用了！

