✅ Cursor 一次性补充修复指令（Based on 执行报告 v1.0）

目标：让 Cursor 对照执行报告补齐所有遗漏项，更新文档、补全测试、强化规范落地。
必须一次性完成，不得拆分，也不得漏项。

🟥 任务标题：批量处理 JSON 容错与目标语言过滤 · 补充修复任务单 v1.1
🔧 Task 0 — 严格加载研发规范（必须执行）

在本任务开始前：

自动加载项目内以下规范文件（只读）：

/mnt/data/🧩 AI 核心服务规范（ai-core 统一架构规范 v2.0）.md

/mnt/data/🧩 AI 服务研发规范（ai-service 统一架构规范 v1.0）.md

/mnt/data/文件结构.md

/mnt/data/数据库结构_AI_SERVICE.md

/mnt/data/数据库结构_DRIVEQUIZ.md

所有修改必须遵循其中的红线要求。

🔧 Task 1 — 更新文件结构文档（修复报告中的未完成项 B2）

执行报告指出：

⚠️ B2：新增 jsonUtils.ts 文件，但文件结构文档尚未同步更新。

你必须：

✅ 修改 docs/文件结构.md（或项目中对应的文件结构文档），补充以下内容：
apps/web/
└── src/
    └── app/
        └── api/
            └── admin/
                └── question-processing/
                    └── _lib/
                        └── jsonUtils.ts   ← 新增（统一 JSON 清理与 DB JSONB 规范化工具）


要求：

文档中体现新增文件的用途说明（JSON 清洗、sanitize）。

保持文档层级对齐项目结构。

🔧 Task 2 — 添加端到端自测脚本（弥补执行报告中的 C1/C2）

执行报告显示：

JSON 清洗与语种过滤已单元测试，但 缺少集成测试（C1、C2 未达成）

你必须新增：

📁 新增文件：

tests/question_processing/full_pipeline_e2e.test.ts

📌 测试内容（必须包含）：

调用 /api/admin/question-processing/batch-process：

输入三道题

sourceLanguage = zh

targetLanguages = ["ja"]

scene = "question_full_pipeline"

断言：

response 成功

tasks 表记录正常生成

questions.content/ explanation 中：

只有 zh / ja

en 等多余 language 不得出现

无 JSON 解析报错

Postgres JSONB 写入均成功

远程 AI（render）与本地 AI（local-ai-service）必须各跑一次

必须在测试代码中打印：请求体、AI 响应、耗时、每步结果

🔧 Task 3 — 对 sanitizeAiPayload 增加严格类型验证（架构红线强化）

执行报告中虽然实现了过滤，但仍缺少：

“保证 sanitize 阶段输出始终符合类型定义”

你必须增强：

📌 在 sanitizeAiPayload 尾部：

新增：

// 强制类型检查：translations 必须是 Record<string, any>
if (typeof sanitized.translations !== 'object' || Array.isArray(sanitized.translations)) {
  throw new Error("[sanitizeAiPayload] translations must be an object");
}

// 保证所有 language key 都为字符串
for (const key of Object.keys(sanitized.translations)) {
  if (typeof key !== "string") {
    throw new Error(`[sanitizeAiPayload] Invalid language key: ${key}`);
  }
}


目的：

完全符合研发规范 A4：接口结构必须强类型且可被外部调用信赖。

🔧 Task 4 — 在 batchProcessUtils 全局写入 AI 诊断日志（增强可视化 Debug）

你之前要求：

“所有错误必须显示在批量处理页面的任务详情里”

执行报告没有覆盖这一点。

你必须新增：

📌 在以下位置，写入完整 AI 调用调试日志：

full_pipeline 调用前

full_pipeline AI 返回后

sanitize 之后（展示被过滤掉的语言）

保存入库前（展示清洗后的 JSON）

日志格式必须为：

[BATCH][questionId=xxx] step=xxx
payload=...
result=...
removedLanguages=[ "en" ]       ← 必须包含
cleanedJsonPreview=...


这些日志必须写入 tasks 的 logs JSON 字段（用于前端展示）。

🔧 Task 5 — 修复 full_pipeline 任务详情 UI 无法展示 AI 错误的问题

执行报告没有提到 UI 侧，但你之前多次提出：

“在后台看不到错误，必须修复 UI”

你必须：

📌 修改 apps/web/src/app/admin/question-processing/tasks/[id]/page.tsx：

支持展示 AI 调试日志（Task 4 的 logs 字段）

支持展开/收缩大 JSON

支持高亮显示 removedLanguages、fixedJsonPreview

支持按步骤过滤（AI 调用 / sanitize / DB 写入）

🔧 Task 6 — 文档补充：新增《JSON 清洗与语言过滤规范》文档

新增文件：

docs/研发规范/JSON清洗与语言过滤规范.md

内容必须包含：

cleanJsonString 的用途、输入输出、异常情况

sanitizeJsonForDb 的数据库写入规范

sanitizeAiPayload 的语种过滤规则

full_pipeline 调用路径

前后端日志规范

最佳实践样例

该文档将作为 future tasks 的标准引用文件。

🔧 Task 7 — 全量回归测试与报告（必须比 v1.0 更详细）

Cursor 必须在执行结束后输出：

测试题目 ID

请求体

全量 AI 返回示例

过滤前后对比：

before: { zh, ja, en }
after: { zh, ja }
removed: ["en"]


DB 中最终 JSONB 内容

无 JSON parse 错误

无 invalid input syntax 错误

执行截图或日志摘要

🎯 输出格式要求（Cursor 必须遵守）

执行结束后，Cursor 需返回：

文件修改清单（新增/修改/删除）

所有代码 diff（按文件分类）

完整测试日志

回归测试结果

研发红线逐条检查（A1–D2 全部覆盖）

最终确认：是否所有问题已完全闭环？若否，自动继续修复