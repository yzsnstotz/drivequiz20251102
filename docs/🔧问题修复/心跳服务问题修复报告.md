# 心跳服务问题修复报告

**指令版本：0001**  
**修复日期：2025-11-17**

## 一、问题分析

### 1.1 问题现象

从日志中观察到两个主要问题：

#### 问题 1：Local 服务健康检查失败
```
[heartbeat] local 健康检查错误: {
  error: 'fetch failed',
  stack: 'TypeError: fetch failed...'
}
```
- **错误类型**：`TypeError: fetch failed`
- **URL**：`http://localhost:8788/healthz`
- **可能原因**：
  1. 本地 AI 服务未运行
  2. Next.js 服务端无法访问 localhost（在某些部署环境中）
  3. 端口被占用或服务未正确启动

#### 问题 2：Render 服务健康检查超时
```
[heartbeat] render 健康检查超时
```
- **错误类型**：超时（5秒）
- **URL**：`https://zalem.onrender.com/healthz`
- **可能原因**：
  1. 5秒超时时间太短
  2. 网络延迟较高
  3. Render 服务响应较慢（冷启动）

### 1.2 根本原因

1. **超时时间设置不合理**：
   - Local 服务：3秒超时（太短）
   - Render 服务：5秒超时（可能不够，特别是冷启动时）

2. **错误处理不够友好**：
   - `fetch failed` 错误信息不够清晰
   - 没有区分不同类型的错误（网络错误、服务未运行、超时等）
   - 对于 localhost 连接失败，没有提供明确的提示

3. **日志信息不够详细**：
   - 缺少对 localhost 的特殊处理提示
   - 错误堆栈信息过长，影响可读性

## 二、修复方案

### 2.1 增加超时时间

**修改前**：
- Local 服务：3秒超时
- Render 服务：5秒超时

**修改后**：
- Local 服务：5秒超时（增加 2 秒）
- Render 服务：10秒超时（增加 5 秒，考虑冷启动）

**理由**：
- Local 服务可能需要更多时间启动或响应
- Render 服务在冷启动时可能需要 5-10 秒响应
- 10秒超时对于健康检查来说仍然合理

### 2.2 改进错误处理

**新增错误类型识别**：
1. **超时错误**：`AbortError` → 显示超时时间
2. **网络连接错误**：`fetch failed` / `ECONNREFUSED` / `ENOTFOUND` → 提供更友好的错误信息
3. **Localhost 特殊处理**：如果是 localhost 且连接失败，提示"服务未运行或无法访问"

**错误信息优化**：
- 区分不同类型的错误
- 对于 localhost 连接失败，提供明确的提示信息
- 限制错误堆栈长度，提高可读性

### 2.3 改进日志输出

**新增日志信息**：
- 检测是否为 localhost
- 提供更详细的错误上下文
- 对于 localhost 连接失败，提供解决建议

## 三、代码变更

### 3.1 文件：`src/app/api/admin/ai/heartbeat/route.ts`

**主要变更**：

1. **增加超时时间**：
   ```typescript
   // 修改前
   const timeoutId = setTimeout(() => controller.abort(), provider === "local" ? 3000 : 5000);
   
   // 修改后
   const timeoutMs = provider === "local" ? 5000 : 10000;
   const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
   ```

2. **改进错误处理**：
   ```typescript
   // 新增：检测 localhost
   const isLocalhost = baseUrl.includes("localhost") || baseUrl.includes("127.0.0.1");
   
   // 改进：区分不同类型的错误
   if (err.name === "AbortError") {
     // 超时错误
     const timeoutSeconds = provider === "local" ? "5s" : "10s";
     providerStatus.lastError = `Timeout (${timeoutSeconds})`;
   } else if (err.message?.includes("fetch failed") || err.code === "ECONNREFUSED" || err.code === "ENOTFOUND") {
     // 网络连接错误
     if (isLocalhost && provider === "local") {
       providerStatus.lastError = "Service not running or unreachable (localhost)";
       // 提供解决建议
     } else {
       providerStatus.lastError = `Network error: ${err.message || "Connection failed"}`;
     }
   }
   ```

3. **改进日志输出**：
   ```typescript
   // 新增：记录是否为 localhost
   console.log(`[heartbeat] 检查 ${provider} 服务:`, {
     url: `${url.substring(0, 50)}...`,
     healthUrl,
     hasToken: !!token,
     isLocalhost,
   });
   
   // 改进：限制堆栈长度
   console.error(`[heartbeat] ${provider} 健康检查错误:`, {
     error: err.message,
     code: err.code,
     stack: err.stack?.substring(0, 500), // 限制堆栈长度
   });
   ```

## 四、预期效果

### 4.1 错误信息更清晰

**修改前**：
```
lastError: "fetch failed"
```

**修改后**：
- Local 服务未运行：
  ```
  lastError: "Service not running or unreachable (localhost)"
  ```
- Render 服务超时：
  ```
  lastError: "Timeout (10s)"
  ```
- 网络错误：
  ```
  lastError: "Network error: Connection failed"
  ```

### 4.2 超时时间更合理

- Local 服务：5秒（足够本地服务响应）
- Render 服务：10秒（考虑冷启动和网络延迟）

### 4.3 日志更详细

- 显示是否为 localhost
- 提供解决建议（对于 localhost 连接失败）
- 限制堆栈长度，提高可读性

## 五、测试建议

### 5.1 测试场景

1. **Local 服务未运行**：
   - 停止本地 AI 服务
   - 访问心跳接口
   - 验证错误信息是否为 "Service not running or unreachable (localhost)"

2. **Local 服务正常运行**：
   - 启动本地 AI 服务
   - 访问心跳接口
   - 验证状态是否为 "up"

3. **Render 服务正常**：
   - 访问心跳接口
   - 验证状态是否为 "up"（可能需要等待几秒）

4. **Render 服务超时**：
   - 如果服务响应慢，验证是否在 10 秒后超时
   - 验证错误信息是否为 "Timeout (10s)"

### 5.2 验证步骤

1. **检查超时时间**：
   ```bash
   # 访问心跳接口，观察响应时间
   curl http://localhost:3000/api/admin/ai/heartbeat
   ```

2. **检查错误信息**：
   - 停止本地 AI 服务
   - 访问心跳接口
   - 验证错误信息是否清晰

3. **检查日志**：
   - 查看控制台日志
   - 验证日志信息是否详细且有用

## 六、已知限制

1. **Localhost 访问限制**：
   - 在某些部署环境（如 Vercel）中，服务端无法访问 localhost
   - 这是环境限制，不是代码问题
   - 建议：在生产环境中使用公网可访问的 URL

2. **网络延迟**：
   - Render 服务可能因为网络延迟而超时
   - 10秒超时应该足够，但如果网络非常慢，仍可能超时

3. **服务冷启动**：
   - Render 服务在冷启动时可能需要更长时间
   - 10秒超时应该足够，但如果服务完全冷启动，可能需要更长时间

## 七、后续优化建议

1. **重试机制**：
   - 对于超时错误，可以添加重试机制
   - 例如：第一次失败后，等待 2 秒再重试一次

2. **健康检查缓存**：
   - 可以缓存健康检查结果（例如 30 秒）
   - 减少对服务的请求压力

3. **监控告警**：
   - 如果服务连续多次失败，可以发送告警
   - 帮助及时发现服务问题

## 八、总结

本次修复主要解决了以下问题：

1. ✅ **增加超时时间**：Local 5秒，Render 10秒
2. ✅ **改进错误处理**：区分不同类型的错误，提供更友好的错误信息
3. ✅ **改进日志输出**：提供更详细的日志信息，包括解决建议

修复后的代码能够：
- 更准确地识别不同类型的错误
- 提供更友好的错误信息
- 更好地处理网络延迟和服务冷启动

**建议**：在生产环境中，确保本地 AI 服务使用公网可访问的 URL（如通过 Cloudflare Tunnel），而不是 localhost。

