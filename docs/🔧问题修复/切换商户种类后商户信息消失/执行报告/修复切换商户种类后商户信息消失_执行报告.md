# 修复切换商户种类后商户信息消失_执行报告

**报告日期**: 2025-11-29  
**任务名称**: 修复切换商户种类后商户信息消失的问题  
**版本号**: 2025-11-29 12:02:15

---

## 📌 任务摘要

修复前台服务页面（`/nearby`）切换商户种类后商户信息消失的问题。问题原因是在切换分类时，使用当前语言的分类名称查询商户，但数据库中商户的 `category` 字段存储的是中文名称，导致查询失败。修复了 `NearbyPage.tsx` 中的分类查询逻辑，确保始终使用中文名称查询商户。

---

## 📌 修改文件列表

1. **src/app/nearby/NearbyPage.tsx**
   - 修复 `loadMerchants` 函数，确保使用中文名称查询商户（因为数据库中存储的是中文名称）
   - 修复 `loadData` 函数中的初始加载逻辑，确保使用中文名称查询商户

2. **src/lib/version.ts**
   - 更新版本号为 `2025-11-29 12:02:15`

---

## 📌 逐条红线规范自检（A1–D2）

### 🔴 A. 架构红线

| 编号 | 规则 | 状态 | 说明 |
|------|------|------|------|
| A1 | 路由层禁止承载业务逻辑 | ✅ 已遵守 | 本次修改仅涉及前端组件逻辑，不涉及路由层业务逻辑 |
| A2 | 所有核心逻辑必须写入 ai-core | ⚪ 不适用 | 本次任务不涉及 AI 功能 |
| A3 | ai-service 与 local-ai-service 行为必须保持完全一致 | ⚪ 不适用 | 本次任务不涉及 AI 服务 |
| A4 | 接口参数、返回结构必须保持统一 | ✅ 已遵守 | 本次修改不影响接口结构，仅修复前端查询逻辑 |

### 🔴 B. 数据库 & 文件结构红线

| 编号 | 规则 | 状态 | 说明 |
|------|------|------|------|
| B1 | 任何数据库字段、表结构、索引的修改必须同步更新数据库结构文档 | ⚪ 不适用 | 本次任务不涉及数据库结构修改 |
| B2 | 所有文件新增、删除、迁移必须同步更新文件结构文档 | ⚪ 不适用 | 本次任务未新增、删除或迁移文件 |
| B3 | 所有 Kysely 类型定义必须与数据库结构同步保持一致 | ⚪ 不适用 | 本次任务不涉及数据库类型定义 |
| B4 | DriveQuiz 主库与 AI Service 库的 schema 需保持文档同步 | ⚪ 不适用 | 本次任务不涉及数据库 schema 修改 |

### 🔴 C. 测试红线（AI 调用必须双环境测试）

| 编号 | 规则 | 状态 | 说明 |
|------|------|------|------|
| C1 | 涉及 AI 功能必须同时测试：local-ai-service & 远程 ai-service | ⚪ 不适用 | 本次任务不涉及 AI 功能 |
| C2 | 必须输出测试日志摘要（请求、响应、耗时、错误） | ⚪ 不适用 | 本次任务不涉及 AI 调用 |
| C3 | 若测试失败，必须主动继续排查，不得要求用户手动重试 | ⚪ 不适用 | 本次任务不涉及 AI 调用测试 |

### 🔴 D. 执行报告红线（最终必须输出）

| 编号 | 规则 | 状态 | 说明 |
|------|------|------|------|
| D1 | 任务结束必须按模板输出完整执行报告 | ✅ 已遵守 | 本报告即为完整执行报告 |
| D2 | 必须逐条对照 A1–D2，标注"已遵守 / 不适用 / 必须修复" | ✅ 已遵守 | 已逐条对照并标注状态 |

### 🔴 E. 清除冗余和肥胖代码

| 编号 | 规则 | 状态 | 说明 |
|------|------|------|------|
| E1 | 删除目标功能流程中残留的无用调试代码、重复日志、未再使用的辅助函数 | ✅ 已遵守 | 本次修改未引入冗余代码 |
| E2 | 移除冗余/过时代码，保证目标功能流程结构简洁、职责单一 | ✅ 已遵守 | 本次修改优化了代码逻辑，未引入冗余代码 |

---

## 📌 问题分析

### 问题描述

在服务页面（`/nearby`）切换商户种类后，商户信息消失，无法显示。

### 根本原因

1. **数据存储格式不一致**：
   - 商户的 `category` 字段在数据库中存储的是中文名称（字符串），例如 "中餐"、"日本料理" 等
   - 分类的 `name` 字段是多语言对象（JSONB），例如 `{zh: "中餐", en: "Chinese", ja: "中華料理"}`

2. **查询逻辑问题**：
   - 在 `NearbyPage.tsx` 中，当切换分类时，`loadMerchants` 函数会根据当前语言获取分类名称
   - 如果当前语言是英文，就会获取英文名称（如 "Chinese"），然后用这个名称去查询商户
   - 但数据库中商户的 `category` 字段存储的是中文名称（如 "中餐"），导致查询失败

3. **初始加载逻辑问题**：
   - 在 `loadData` 函数中，初始加载时也使用了当前语言的分类名称，导致同样的问题

### 修复方案

1. **统一使用中文名称查询**：
   - 在 `loadMerchants` 函数中，无论当前语言是什么，都使用中文名称（`'zh'`）来查询商户
   - 确保查询使用的分类名称与数据库中存储的格式一致

2. **修复初始加载逻辑**：
   - 在 `loadData` 函数中，初始加载时也使用中文名称查询商户

---

## 📌 修改详情

### 1. 修复 loadMerchants 函数

**修改前**：
```typescript
const loadMerchants = async (categoryId?: number | null) => {
  try {
    if (categoryId !== null && categoryId !== undefined) {
      const category = categories.find(cat => cat.id === categoryId);
      if (category) {
        // ❌ 使用当前语言的分类名称
        const categoryName = typeof category.name === 'string' 
          ? category.name 
          : getMultilangContent(category.name, language, '');
        if (categoryName) {
          await loadMerchantsByCategoryName(categoryName);
          return;
        }
      }
    }
    // ...
  }
};
```

**修改后**：
```typescript
const loadMerchants = async (categoryId?: number | null) => {
  try {
    if (categoryId !== null && categoryId !== undefined) {
      const category = categories.find(cat => cat.id === categoryId);
      if (category) {
        // ✅ 使用中文名称查询（因为数据库中存储的是中文名称）
        const categoryName = typeof category.name === 'string' 
          ? category.name 
          : getMultilangContent(category.name, 'zh', '');
        if (categoryName) {
          await loadMerchantsByCategoryName(categoryName);
          return;
        }
      }
    }
    // ...
  }
};
```

### 2. 修复 loadData 函数

**修改前**：
```typescript
const firstCategory = loadedCategories[0];
// ❌ 使用当前语言的分类名称
const categoryName = typeof firstCategory.name === 'string' 
  ? firstCategory.name 
  : getMultilangContent(firstCategory.name, language, '');
if (categoryName) {
  await loadMerchantsByCategoryName(categoryName);
}
```

**修改后**：
```typescript
const firstCategory = loadedCategories[0];
// ✅ 使用中文名称查询（因为数据库中存储的是中文名称）
const categoryName = typeof firstCategory.name === 'string' 
  ? firstCategory.name 
  : getMultilangContent(firstCategory.name, 'zh', '');
if (categoryName) {
  await loadMerchantsByCategoryName(categoryName);
}
```

---

## 📌 测试结果

### 前端组件测试

**测试环境**：
- Next.js 15.5.6
- React 18+
- TypeScript

**测试项**：
1. ✅ 类型检查通过（无 TypeScript 错误）
2. ✅ Lint 检查通过（无 ESLint 错误）
3. ✅ 切换分类时，商户信息正确显示
4. ✅ 初始加载时，商户信息正确显示
5. ✅ 切换语言时，商户信息仍然正确显示（因为查询使用的是中文名称，不受语言切换影响）

**测试场景**：
- ✅ 中文环境下切换分类
- ✅ 英文环境下切换分类
- ✅ 日文环境下切换分类
- ✅ 初始加载时选择第一个分类
- ✅ 切换到"全部"分类（加载所有商户）

---

## 📌 迁移脚本

**不适用**：本次任务不涉及数据库迁移。

---

## 📌 更新后的文档

**不适用**：本次任务不涉及数据库结构或文件结构的修改。

---

## 📌 风险点与下一步建议

### 风险点

1. **数据一致性**：确保所有商户的 `category` 字段都使用中文名称存储
2. **多语言支持**：虽然查询使用中文名称，但显示仍然支持多语言

### 下一步建议

1. **数据清理**：如果需要，可以考虑统一所有商户的 `category` 字段格式
2. **API 优化**：建议修改 API，支持通过分类 ID 查询，而不是通过分类名称查询，这样可以避免语言不一致的问题
3. **类型安全**：建议在类型定义中明确 `category` 字段的格式要求

---

## 📌 总结

本次修复成功解决了切换商户种类后商户信息消失的问题。通过统一使用中文名称查询商户，确保了查询逻辑与数据存储格式的一致性，无论当前语言是什么，都能正确显示商户信息。

**当前版本号**: 2025-11-29 12:02:15

**修复状态**: ✅ 已完成

