ğŸ¯ ä»»åŠ¡ç›®æ ‡

æ’¤æ‰ç›®å‰åœ¨ /api/auth/[...nextauth] é‡Œé‚£å¥—ç”¨ require + path.join(process.cwd(), "src", "lib", "auth") çš„åŠ¨æ€åŠ è½½æ–¹æ¡ˆï¼Œ
æ”¹å› æ ‡å‡†çš„ NextAuth v5 é™æ€ import å†™æ³•ï¼Œ
è§£å†³ Vercel æ„å»ºæ—¶æŠ¥é”™ï¼š
Error: Cannot find module '/vercel/path0/src/lib/auth'ï¼Œ
åŒæ—¶æ¶ˆé™¤ Critical dependency: the request of a dependency is an expression è­¦å‘Šã€‚

0. è§„èŒƒçº¦æŸ & æ–‡ä»¶èŒƒå›´
å¿…é¡»éµå®ˆçš„çº¦æŸï¼ˆç®€è¦ï¼‰

è·¯ç”±å±‚åªè´Ÿè´£ æ‹¼è£… NextAuth handler å’Œå¯¼å‡º GET/POSTï¼Œä¸é‡æ–°å†™ä¸šåŠ¡é€»è¾‘ã€‚

ä¸æ”¹ src/lib/auth.ts å†…éƒ¨çš„ä¸šåŠ¡é…ç½®ï¼Œåªä¿è¯å¯¼å‡ºå½¢å¼æ­£ç¡®ã€‚

ä¸å†ä½¿ç”¨ä»»ä½• require() / path.join / process.cwd() åŠ¨æ€ hackã€‚

å…è®¸ä¿®æ”¹çš„æ–‡ä»¶

src/app/api/auth/[...nextauth]/route.ts

ï¼ˆå¦‚æœ‰å¿…è¦ï¼‰src/lib/auth.ts çš„å¯¼å‡ºå½¢å¼ï¼Œä½†ä¸èƒ½æ”¹ä¸šåŠ¡å†…å®¹ã€‚

1. åˆ é™¤åŠ¨æ€ require å®ç°ï¼Œæ¢å¤æ ‡å‡† NextAuth v5 å†™æ³•
1.1 æ‰“å¼€å¹¶æ¸…ç† src/app/api/auth/[...nextauth]/route.ts

å½“å‰å®ç°å¤§è‡´é•¿è¿™æ ·ï¼ˆè¯Šæ–­æŠ¥å‘Šå·²ç»™å‡ºï¼‰ï¼š

// ç¤ºä¾‹ï¼šå½“å‰ç»“æ„ï¼ˆä¼ªä»£ç ï¼Œå®é™…å‘½åå¯èƒ½ç•¥æœ‰å·®å¼‚ï¼‰
import NextAuth from "next-auth";
import path from "path";

let handlers: { GET: any; POST: any } | null = null;

function getHandlers() {
  if (!handlers) {
    const authPath = path.join(process.cwd(), "src", "lib", "auth");
    const authModule = require(authPath);   // âŒ è¿™é‡Œæ„å»ºæ—¶æŠ¥ MODULE_NOT_FOUND
    const { authOptions } = authModule;
    const nextAuth = NextAuth(authOptions);
    handlers = nextAuth.handlers;
  }
  return handlers;
}

const authHandlers = getHandlers();
export const { GET, POST } = authHandlers;


ğŸ‘‰ è¦æ±‚ï¼šæŠŠä¸Šé¢è¿™ä¸€æ•´å¥— getHandlers + require + path.join ç›¸å…³é€»è¾‘å…¨éƒ¨åˆ æ‰ï¼ŒåŒ…æ‹¬ï¼š

import path from "path";

let handlers = ...

function getHandlers() { ... }

const authHandlers = getHandlers();

è¿™äº›å°±æ˜¯æŠ¥å‘Šé‡Œæ˜ç¡®å»ºè®®â€œåº”è¯¥æ’¤å›â€çš„éƒ¨åˆ†ã€‚

1.2 ä½¿ç”¨é™æ€ import + å®˜æ–¹æ¨èè§£æ„å†™æ³•

src/lib/auth.ts å½“å‰æœ‰ä¸€ä¸ªå¯¼å‡ºçš„ authOptionsï¼ˆæˆ– authConfig / authConfigDefaultï¼Œå…·ä½“çœ‹æ–‡ä»¶ï¼‰ï¼ŒæŠ¥å‘Šé‡Œæ˜¯æŒ‰ authOptions è®°çš„ï¼š

è¯·æ”¹æˆ æç®€ã€æ ‡å‡†çš„ NextAuth v5 App Router å†™æ³•ï¼š

// src/app/api/auth/[...nextauth]/route.ts
import NextAuth from "next-auth";
import { authOptions } from "@/lib/auth"; // å¦‚æœå®é™…å¯¼å‡ºåä¸åŒï¼Œè¯·æŒ‰å®é™…è°ƒæ•´

const { handlers } = NextAuth(authOptions);

export const { GET, POST } = handlers;


å¦‚æœ src/lib/auth.ts æ˜¯é»˜è®¤å¯¼å‡ºï¼ˆä¾‹å¦‚ export default authConfigï¼‰ï¼Œé‚£å°±ï¼š
import authOptions from "@/lib/auth";
ç„¶åä»ç„¶ç”¨ NextAuth(authOptions)ã€‚

è¿™æ ·æœ‰å‡ ä¸ªå¥½å¤„ï¼š

ä¸å†ç”¨ require()ï¼Œwebpack ä¸ä¼šå†æŠ¥ Critical dependency: the request of a dependency is an expressionã€‚

Vercel æ„å»ºç¯å¢ƒä¼šæŒ‰ Next.js/NextAuth æ ‡å‡†è·¯å¾„å»è§£ææ¨¡å—ï¼Œä¸ä¾èµ– /vercel/path0/src/... è¿™ç§ç¡¬ç¼–ç è·¯å¾„ã€‚

ä»£ç å›å½’åˆ° NextAuth å®˜æ–¹æ–‡æ¡£çš„æ¨¡å¼ï¼Œæ›´å®¹æ˜“ç»´æŠ¤ã€‚

2. æ ¡æ­£ src/lib/auth.ts çš„å¯¼å‡ºå½¢å¼ï¼ˆå¦‚æœ‰éœ€è¦ï¼‰

è¿™ä¸€æ­¥æ˜¯â€œå…œåº•â€ï¼šå¦‚æœ 1.2 ä¸­çš„ import { authOptions } from "@/lib/auth"; æŠ¥ TS é”™æˆ–æ„å»ºé”™ï¼Œå†æ”¹è¿™ä¸ªæ–‡ä»¶ã€‚

2.1 æ‰“å¼€ src/lib/auth.tsï¼Œæ£€æŸ¥å¯¼å‡º

ç¡®ä¿é‡Œé¢æ˜¯ç±»ä¼¼ä¸‹é¢è¿™ç§ç»“æ„ï¼ˆå‚è€ƒæŠ¥å‘Šä¸­â€œå°è¯• 1-2ï¼šAPI å…¼å®¹æ€§ä¿®å¤â€ï¼‰ï¼š

// ç¤ºä¾‹
import type { NextAuthConfig } from "next-auth";

export const authOptions: NextAuthConfig = {
  // providers, callbacks, pages, session, ...
};


å¦‚æœç°åœ¨æ˜¯é»˜è®¤å¯¼å‡ºï¼š

const authOptions: NextAuthConfig = { ... };
export default authOptions;


é‚£ä½ æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼ˆäºŒé€‰ä¸€å³å¯ï¼‰ï¼š

ä¿æŒé»˜è®¤å¯¼å‡ºï¼š

auth.tsï¼šexport default authOptions;

route.tsï¼šimport authOptions from "@/lib/auth";

æ”¹æˆå…·åå¯¼å‡ºï¼ˆæ¨èï¼‰ï¼š

auth.tsï¼šexport const authOptions: NextAuthConfig = {...};

route.tsï¼šimport { authOptions } from "@/lib/auth";

åªè¦ route.ts å’Œ auth.ts çš„å¯¼å‡º/å¯¼å…¥ä¸€è‡´ å³å¯ï¼Œä¸è¦åŒæ—¶é»˜è®¤å¯¼å‡º + å…·åå¯¼å‡ºæå¤æ‚ã€‚

3. ä¿ç•™å·²ç”Ÿæ•ˆçš„ NextAuth v5 å…¼å®¹æ€§ä¿®å¤

è¯Šæ–­æŠ¥å‘Šé‡Œæåˆ°ï¼Œä¸‹é¢è¿™äº›æ”¹åŠ¨æ˜¯â€œå¿…è¦ä¸”å·²ç”Ÿæ•ˆâ€çš„ï¼Œä¸è¦å›æ»šï¼š

NextAuthOptions â†’ NextAuthConfig

getServerSession â†’ auth()ï¼ˆåœ¨ç”¨åˆ°çš„åœ°æ–¹ï¼‰

handler è§£æ„æ–¹å¼ä»æ—§å†™æ³•æ”¹æˆäº† NextAuth(authOptions).handlers

è¿™ä¸€è½®æ”¹åŠ¨ åªå¤„ç†â€œæ¨¡å—åŠ è½½ & æ„å»ºâ€é—®é¢˜ï¼Œä¸åŠ¨è¿™äº›å·²æœ‰çš„ v5 é€‚é…é€»è¾‘ã€‚

4. æœ¬åœ°éªŒè¯ & è¾“å‡ºè¦æ±‚

è®© Cursor æŒ‰ä¸‹é¢æ­¥éª¤åšæœ¬åœ°éªŒè¯ï¼Œå¹¶åœ¨æ‰§è¡ŒæŠ¥å‘Šé‡Œæ˜ç¡®ç»™ä½ çœ‹ã€‚

4.1 ä»£ç æ£€æŸ¥
npm run lint


å…è®¸ä¿ç•™ä¹‹å‰é‚£äº› React hooks çš„ warningï¼ˆå®ƒä»¬åœ¨ Vercel log é‡Œä¹Ÿåªæ˜¯ warningï¼‰ï¼Œ

é‡ç‚¹æ˜¯ ä¸èƒ½å‡ºç°æ–°çš„ errorã€‚

4.2 æœ¬åœ°æ„å»º
npm run build


æ‰§è¡Œå®Œæˆåï¼ŒæŠ¥å‘Šä¸­è¦ç»™å‡ºè¿™äº›å…³é”®ç‚¹ï¼š

âœ… æ²¡æœ‰å†å‡ºç°ï¼š

Error: Cannot find module '/vercel/path0/src/lib/auth'

Failed to collect page data for /api/auth/[...nextauth]

âš  Critical dependency: the request of a dependency is an expression
æ¥è‡ª route.ts çš„è¿™æ¡è­¦å‘Šåº”è¯¥ä¹Ÿä¼šæ¶ˆå¤±ï¼ˆå› ä¸ºæˆ‘ä»¬åˆ æ‰äº†åŠ¨æ€ requireï¼‰ã€‚

æ„å»ºè¾“å‡ºé‡Œ /api/auth/[...nextauth] æ­£å¸¸åˆ—å‡ºï¼Œç±»ä¼¼ï¼š

â”œ Æ’ /api/auth/[...nextauth]  xxx B  xxx kB

4.3 è¯· Cursor åœ¨æ‰§è¡ŒæŠ¥å‘Šä¸­æ˜ç¡®ç²˜è´´ä»¥ä¸‹å†…å®¹ï¼ˆä¾¿äºä½ å¿«é€Ÿ eyeballï¼‰ï¼š

ä¿®æ”¹åçš„ src/app/api/auth/[...nextauth]/route.ts å…¨é‡ä»£ç ã€‚

src/lib/auth.ts ä¸­ä¸å¯¼å‡ºç›¸å…³çš„éƒ¨åˆ†ï¼ˆå¯ä»¥åªè´´åŒ…å« authOptions çš„é‚£æ®µï¼‰ã€‚

npm run build æ—¥å¿—ä¸­å…³äºï¼š

Collecting page data...

/api/auth/[...nextauth]

æ˜¯å¦è¿˜æœ‰ ModuleNotFound / Critical dependency