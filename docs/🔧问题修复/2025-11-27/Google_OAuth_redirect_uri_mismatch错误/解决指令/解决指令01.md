任务名称：Google OAuth redirect_uri_mismatch 问题彻底修复（v2）
相关现状：

当前已在 src/lib/auth.ts 增强了环境变量诊断日志。

当前在 src/lib/env.ts 增加了 VERCEL_URL 回退，用作临时方案。

文档层面已经有完整的诊断报告、修复指南、快速检查清单、解决指令和执行报告。

核心问题：
代码仍允许在生产环境下默默使用 VERCEL_URL 推导回调 URL，只要 Google Console 里没配对应域名，就会继续出现 redirect_uri_mismatch，而且问题容易反复。

本次改动目标：

删除/废弃 VERCEL_URL 回退逻辑，生产环境只接受显式配置的 NEXTAUTH_URL。

在代码层 强校验 NEXTAUTH_URL：

生产环境缺失 / 非 https / 有尾斜杠时直接报错（阻止应用正常启动）。

统一封装一个 getAuthBaseUrl() 工具函数，所有 OAuth 相关逻辑只通过它拿 base URL，不再散落使用 process.env.*。

更新现有文档，说明：v1 的 VERCEL_URL 回退方案已废弃；以 v2 为准。

🚫 禁止修改范围

禁止改动其他服务 / 仓库：

本任务只修改 Web 项目（Next.js / NextAuth）内的文件，不修改 ai-service、drivequiz-api 等其他服务。

禁止在路由中写业务逻辑：

OAuth 配置逻辑保持在 src/lib/auth.ts / src/lib/env.ts 这类工具层。

禁止引入新的第三方库：

只使用现有 Node / TS 能力（例如正则、URL 校验等），不添加依赖。

🗂 需要修改/确认的文件

以下路径以当前执行报告中提到的文件为准。

src/lib/env.ts

src/lib/auth.ts

（如果存在）src/app/api/auth/[...nextauth]/route.ts 或等价的 NextAuth 路由初始化文件

文档目录：

docs/问题修复/Google_OAuth_redirect_uri_mismatch错误/修复指南.md

docs/问题修复/Google_OAuth_redirect_uri_mismatch错误/快速检查清单.md

docs/问题修复/2025-11-27/Google_OAuth_redirect_uri_mismatch错误/ 下的三份文档（诊断报告 / 解决指令 / 执行报告）

✅ Step 1：env 层统一封装 getAuthBaseUrl（强校验）

文件：src/lib/env.ts

1.1 新增导出函数

新增一个导出函数：getAuthBaseUrl(): string，要求：

读取优先级：

如果存在 process.env.NEXTAUTH_URL，使用它。

不再使用 AUTH_URL 和 VERCEL_URL 作为回退。

按环境区分：

NODE_ENV !== "production" 时：

若 NEXTAUTH_URL 存在，仍按正常校验规则（见下）；

若不存在，则默认使用 http://localhost:3000，但在控制台给出明确警告（开发友好）。

NODE_ENV === "production" 时：

必须存在 NEXTAUTH_URL，否则：

在服务器启动时抛出错误（可以是 throw new Error(...)），信息需包含：

缺失的变量名

配置指引（提示参见 docs/问题修复 下的文档）。

格式校验（生产环境必须通过，否则抛错；开发环境只警告）：

必须为 https:// 起始；

不能包含尾部 /（不能是 https://xxx.com/）；

可以使用简单的正则或 URL 对象校验。

函数内要包含结构化的日志输出：

在生产环境启动时，输出一次类似：

[NextAuth][Config] 使用的 Auth Base URL: https://...

若格式不符合要求（但开发环境），输出 warning。

注意：彻底删除现有的 VERCEL_URL 回退逻辑，包括所有使用 process.env.VERCEL_URL 拼 URL 的代码。

✅ Step 2：auth 层统一使用 getAuthBaseUrl（不再手写 redirect_uri）

文件：src/lib/auth.ts

2.1 移除旧的环境变量拼接逻辑

当前 auth.ts 内存在类似逻辑：

手动计算 effectiveAuthUrl = process.env.NEXTAUTH_URL || process.env.AUTH_URL || ""

再用 ${effectiveAuthUrl}/api/auth/callback/google 拼接回调 URL 并输出日志

本次要求：

删除所有直接访问 process.env.NEXTAUTH_URL / AUTH_URL / VERCEL_URL 的逻辑。

改为统一调用 getAuthBaseUrl()：

如：const authBaseUrl = getAuthBaseUrl();

日志调整：

使用 authBaseUrl 输出：

[NextAuth] 使用的 Auth URL: ${authBaseUrl}

[NextAuth] Google Callback URL: ${authBaseUrl}/api/auth/callback/google

保留现有“诊断日志 + 修复提示”的结构，但不再提及 VERCEL_URL 回退方案。

2.2 NextAuth 配置与 base URL 关联

确保 NextAuth / Auth.js 配置中：

trustHost 等配置保持推荐写法，不必自行指定 redirect_uri（让 NextAuth 自动基于 NEXTAUTH_URL 生成）。

如果当前存在自定义 redirectProxyUrl 或手工 override callback URL 的代码，需要删除或改为使用 authBaseUrl 构造，并确保与 Google Console 的配置模板一致（<AUTH_BASE_URL>/api/auth/callback/google）。

要求：任何与 OAuth 回调 URL 相关的字符串，都必须由 authBaseUrl + 固定路径拼接出来，不允许在项目其他地方自己写死域名或 path。

✅ Step 3：NextAuth 路由文件检查（可选但建议）

文件：src/app/api/auth/[...nextauth]/route.ts（或等价文件）

任务：

检查当前是否在这里对 NextAuth 做了额外的 baseUrl / callbacks.redirect / pages 的硬编码。

如果有任何“写死域名 / 写死 redirect_uri”的逻辑，一律移除或改为基于 authBaseUrl 或 NextAuth 默认行为：

例如，在 callbacks.redirect 中不要手动拼 https://xxx.com/api/auth/callback/google。

确保最终的逻辑是：

由 NEXTAUTH_URL 决定 Host；

由 NextAuth 默认路径 /api/auth/callback/google 组合；

代码本身对“域名 + 协议”的认知只有一处：getAuthBaseUrl()。

✅ Step 4：文档 v2 更新（强调“强校验 + 禁用回退”）

目录：

docs/问题修复/Google_OAuth_redirect_uri_mismatch错误/修复指南.md

docs/问题修复/Google_OAuth_redirect_uri_mismatch错误/快速检查清单.md

docs/问题修复/2025-11-27/Google_OAuth_redirect_uri_mismatch错误/ 下的三份文档（诊断 / 解决指令 / 执行报告）

要求：

保留现有 v1 内容，但在显眼位置新增 v2 变更说明：

明确写出：

VERCEL_URL 回退方案已废弃，仅作为历史记录；

生产环境必须显式配置 NEXTAUTH_URL，否则服务不会启动。

在“解决指令”和“快速检查清单”中：

更新 “完成标准”：

增加一项：生产环境启动日志中必须看到 使用的 Auth URL: https://...，且没有关于 VERCEL_URL 的警告。

在“问题诊断报告”和“执行报告”中：

增加一节“v2 改动摘要”：说明“从弱诊断 + 回退策略”升级为“强约束 + fail fast 策略”。

✅ Step 5：验证与验收标准

请 Cursor 在完成上述修改后，执行以下验证并在新的执行报告中记录：

本地开发环境

不设置 NEXTAUTH_URL，启动 dev：

预期：服务可以启动，日志中有 warning，base URL 默认 http://localhost:3000。

设置 NEXTAUTH_URL=http://localhost:3000（非 https）：

预期：开发环境允许启动，但给出明显 warning，提示生产环境必须为 https。

生产模拟（本地或 CI 中模拟）

NODE_ENV=production 且未设置 NEXTAUTH_URL：

预期：在调用 getAuthBaseUrl() 时抛出错误，阻止应用启动。错误信息需要包含明确的配置指引。

NODE_ENV=production 且 NEXTAUTH_URL=https://example.com/（有尾斜杠）：

预期：同样抛错，并提示不能带尾斜杠。

NODE_ENV=production 且 NEXTAUTH_URL=https://example.com：

预期：启动成功，日志中正确显示：

使用的 Auth URL: https://example.com

Google Callback URL: https://example.com/api/auth/callback/google

Google Console 配置对齐

确认文档中的示例配置与 authBaseUrl 逻辑完全一致：

Authorized JavaScript origins 使用 https://<AUTH_BASE_URL_HOST>；

Authorized redirect URIs 使用 <AUTH_BASE_URL>/api/auth/callback/google。

最终验收标准（写入新的执行报告）

任何环境下都不存在使用 VERCEL_URL 拼接回调 URL 的行为；

生产环境必须配置正确的 NEXTAUTH_URL 才能启动；

部署后，Google OAuth 登录不再出现 redirect_uri_mismatch；

所有变更均在执行报告中按模块说明（env / auth / docs），并更新“未解决问题 & TODO”列表为 ✅ 已解决。