修复指令（v5：显式解析 DATABASE_URL，强制覆盖 host）

目标：

在 src/lib/db.ts 中，从 process.env.DATABASE_URL 里显式解析 host/port/user/password/database/ssl；

用这个解析结果去构造 new Pool(config)，彻底无视任何 PGHOST 等环境变量；

保持代码简洁，不再新增复杂模块，也不再引入 pg.defaults / 额外 SSL 补丁；

打一条安全的调试日志（不输出密码），便于确认 host 已经是正确的 Supabase 域名，而不是 base。

1. 修改目标文件

src/lib/db.ts

如果项目里有 src/lib/aiDb.ts 使用同一个 Supabase 数据库，可以复用同样的 helper；
但当前登录报错发生在 NextAuth 的主库上，最关键是先修 src/lib/db.ts。

2. 在 src/lib/db.ts 中实现连接字符串解析 + Pool 配置

让 Cursor 按下面思路改：

确保导入了 Pool 和 PoolConfig：

import { Pool, PoolConfig } from "pg";


在文件中（靠上位置就行）新增一个小工具函数，用 URL 来解析 DATABASE_URL：

function buildPoolConfigFromConnectionString(connectionString: string): PoolConfig {
  const url = new URL(connectionString);

  const host = url.hostname;
  const port = url.port ? Number(url.port) : 5432;
  const database = url.pathname ? url.pathname.slice(1) : undefined;
  const user = url.username ? decodeURIComponent(url.username) : undefined;
  const password = url.password ? decodeURIComponent(url.password) : undefined;

  const sslMode = url.searchParams.get("sslmode");

  // 对于 Supabase 的托管 Postgres，官方建议是关闭证书严格校验
  // 这里不再玩复杂逻辑，统一用 rejectUnauthorized: false
  const ssl =
    sslMode && sslMode !== "disable"
      ? { rejectUnauthorized: false }
      : undefined;

  console.log("[DB][Config] Parsed DATABASE_URL:", {
    host,
    port,
    database,
    sslMode,
    sslEnabled: !!ssl,
  });

  const config: PoolConfig = {
    host,
    port,
    database,
    user,
    password,
    ssl,
    max: 20,
    idleTimeoutMillis: 30_000,
    connectionTimeoutMillis: 30_000,
  };

  return config;
}


注意：

日志中只打印 host/port/database/sslMode，不打印密码；

这段逻辑完全基于 DATABASE_URL，不会再受 PGHOST 等环境变量影响。

在 createDbInstance() 里，替换原来的 new Pool({ connectionString, ... })：

原来类似（v4 的写法大致是这样）：

const poolConfig = {
  connectionString,
  max: 20,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 30000,
};

const pool = new Pool(poolConfig);


改成：

const poolConfig = buildPoolConfigFromConnectionString(connectionString);

const pool = new Pool(poolConfig);


保留/新增一条简单日志，用来确认 DATABASE_URL 读到的是你刚刚在 Vercel 填的那条：

console.log(
  "[DB][Config] Using raw DATABASE_URL (first 80 chars):",
  connectionString.substring(0, 80) + "...",
);


其他逻辑（Kysely 初始化、placeholder 分支等等）保持不动，不要再加任何 PG/SSL 相关花活。

3. 其它代码位置保持现状

让 Cursor 确认以下几点，若无则不改：

全局搜索 new Pool(

除 src/lib/db.ts（和 src/lib/aiDb.ts 如存在）外，不允许有其他地方新建 Pool。

全局搜索 host: "base"、"base" 与 PGHOST：

代码中不得再出现任何类似配置。

不要再引入任何 pg.defaults.* 或新建 SSL helper 模块。