ğŸ§© ä»»åŠ¡æ€»è¿°ï¼ˆç»™ Cursorï¼‰

ç›®æ ‡ï¼šå½»åº•ä¿®å¤ç”Ÿäº§ç¯å¢ƒ NextAuth OAuth å›è°ƒåå‡ºç°çš„
SELF_SIGNED_CERT_IN_CHAIN / AdapterErrorï¼Œ
å¹¶æ¸…ç†ç°æœ‰ db.ts ä¸­çš„å†—ä½™ SSL é…ç½®ä»£ç ã€‚
è¦æ±‚åªå¯¹ Postgres å®¢æˆ·ç«¯ pg è®¾ç½® SSL é»˜è®¤å€¼ï¼Œ
ç¦æ­¢ ä½¿ç”¨ NODE_TLS_REJECT_UNAUTHORIZED=0ã€‚

1. ä¿®æ”¹ / æ–°å¢æ–‡ä»¶åˆ—è¡¨

src/lib/db.ts

src/lib/pgSslDefaults.tsï¼ˆæ–°æ–‡ä»¶ï¼‰

src/lib/auth-kysely-adapter.tsï¼ˆç¡®è®¤ä¸å†åˆ›å»ºè‡ªå·±çš„ Kysely / Poolï¼‰

é¡¹ç›®æ ¹ç›®å½•ï¼šå…¨å±€æœç´¢å¹¶æ¸…ç†æ‰€æœ‰å¤šä½™çš„ pg.Pool / SSL é…ç½®

2. æ–°å¢ï¼šç»Ÿä¸€çš„ pg SSL é»˜è®¤é…ç½®æ¨¡å—
2.1 æ–°å»ºæ–‡ä»¶ï¼šsrc/lib/pgSslDefaults.ts

æ–°å¢æ¨¡å—åªè´Ÿè´£ä¸€ä»¶äº‹ï¼š
åœ¨é¦–æ¬¡ä½¿ç”¨æ•°æ®åº“å‰ï¼Œåˆå§‹åŒ– pg.defaults.sslï¼Œ
è¿™æ ·æ— è®ºæ˜¯æˆ‘ä»¬è‡ªå·±çš„ Kyselyï¼Œè¿˜æ˜¯ @auth/kysely-adapter å†…éƒ¨ç”¨åˆ°çš„ pg.Poolï¼Œéƒ½ä¼šä½¿ç”¨æ­£ç¡®çš„ SSL é…ç½®ã€‚

// src/lib/pgSslDefaults.ts
import type { PoolConfig } from "pg";
import pg from "pg";

/**
 * åªåˆå§‹åŒ–ä¸€æ¬¡çš„æ ‡è®°ï¼Œé¿å…é‡å¤æ—¥å¿—å’Œé‡å¤é…ç½®
 */
let sslPatched = false;

/**
 * æ ¹æ® connectionString åˆ¤æ–­æ˜¯å¦ä¸ºéœ€è¦ SSL çš„æ‰˜ç®¡åº“ï¼ˆå¦‚ Supabaseï¼‰
 */
function shouldUseSsl(connectionString: string): boolean {
  if (!connectionString) return false;
  const lower = connectionString.toLowerCase();
  return (
    lower.includes("supabase.co") ||
    lower.includes("supabase.com") ||
    lower.includes("sslmode=require") ||
    lower.includes("aws-1-ap-southeast-1.pooler.supabase.com")
  );
}

/**
 * åˆå§‹åŒ– pg.defaults.sslï¼Œç»Ÿä¸€ä¸ºæ‰€æœ‰ä½¿ç”¨ pg çš„å®¢æˆ·ç«¯è®¾ç½® SSL ç­–ç•¥ã€‚
 *
 * å®‰å…¨çº§åˆ«ï¼š
 * 1. å¦‚æœ‰ DB_CA_CERT -> ä½¿ç”¨ CA è¯ä¹¦ï¼Œä¸¥æ ¼éªŒè¯
 * 2. å¦åˆ™ï¼Œåœ¨éœ€è¦ SSL çš„åœºæ™¯ä¸‹ä½¿ç”¨ { rejectUnauthorized: false }
 *    ä»…å½±å“ DB è¿æ¥ï¼Œä¸ä¿®æ”¹ NODE_TLS_REJECT_UNAUTHORIZED
 */
export function initPgSslDefaults(connectionString: string): void {
  if (sslPatched) {
    return;
  }

  const isProd = process.env.NODE_ENV === "production";
  const needSsl = isProd || shouldUseSsl(connectionString);

  if (!needSsl) {
    // æœ¬åœ°é Supabase ç›´è¿åœºæ™¯ï¼Œä¸å¼ºåˆ¶ SSL
    console.log("[DB][SSL] Using plain connection (no SSL defaults).");
    sslPatched = true;
    return;
  }

  let sslConfig: PoolConfig["ssl"] = undefined;
  const ca = process.env.DB_CA_CERT;

  if (ca && ca.trim().length > 0) {
    sslConfig = { ca } as any;
  } else {
    sslConfig = { rejectUnauthorized: false } as any;
  }

  // ç»Ÿä¸€è®¾ç½® pg é»˜è®¤ SSL
  pg.defaults.ssl = sslConfig;

  console.log("[DB][SSL] pg.defaults.ssl initialized:", {
    enabled: !!sslConfig,
    mode: ca ? "ca-cert" : "rejectUnauthorized-false",
  });

  sslPatched = true;
}

3. æ”¹é€ ï¼šsrc/lib/db.ts ç»Ÿä¸€ä½¿ç”¨ pg é»˜è®¤ SSLï¼Œåˆ é™¤å†—ä½™é€»è¾‘

ç›®çš„ï¼š

åœ¨åˆ›å»ºè¿æ¥æ± å‰è°ƒç”¨ initPgSslDefaults()ï¼Œ

ç§»é™¤åŸæ¥çš„ buildDbSslConfig() / ssl å­—æ®µç­‰è‡ªå®šä¹‰ SSL é€»è¾‘ï¼Œ

é¿å…é‡å¤å’Œæ··ä¹±ã€‚

3.1 åœ¨æ–‡ä»¶é¡¶éƒ¨å¢åŠ å¯¼å…¥
// src/lib/db.ts
import { Pool } from "pg";
import { Kysely, PostgresDialect } from "kysely";
import { initPgSslDefaults } from "./pgSslDefaults"; // ğŸ‘ˆ æ–°å¢
// ... å…¶ä»–å·²æœ‰ import ä¿æŒä¸å˜

3.2 åˆ é™¤æ—§çš„ buildDbSslConfig ç›¸å…³ä»£ç 

åˆ é™¤æ•´ä¸ª buildDbSslConfig() å‡½æ•°ï¼›

åˆ é™¤æ‰€æœ‰ä¸ä¹‹ç›¸å…³çš„ç±»å‹å®šä¹‰ / æ³¨é‡Šï¼›

åˆ é™¤æ—§çš„ SSL æ—¥å¿—é€»è¾‘ï¼Œä¾‹å¦‚ï¼š

[DB Config] âœ… SSL enabled for Supabase connection

hasSSL / sslConfig ç­‰å˜é‡

3.3 åœ¨ createDbInstance() ä¸­æ”¶å£åˆ° pg é»˜è®¤ SSL

æ‰¾åˆ°åˆ›å»º Pool / Kysely çš„é€»è¾‘ï¼ˆä¼ªä»£ç ç±»ä¼¼ï¼‰ï¼š

function createDbInstance() {
  const connectionString = process.env.DATABASE_URL ?? "...";

  // æ—§ä»£ç ï¼ˆç¤ºä¾‹ï¼‰ï¼š
  // const ssl = buildDbSslConfig(connectionString);
  // console.log("[DB][Config] Using SSL config:", { ... });
  // const pool = new Pool({ connectionString, ssl, ... });

  // ğŸ‘‰ æ›¿æ¢ä¸ºï¼š
  initPgSslDefaults(connectionString);

  console.log("[DB][Config] Using connection string (first 80 chars):",
    connectionString.substring(0, 80) + "...",
  );

  const pool = new Pool({
    connectionString,
    // âŒ ä¸å†æ˜¾å¼ä¼  sslï¼Œç»Ÿä¸€èµ° pg.defaults.ssl
    // ssl ç›¸å…³é€»è¾‘å·²åœ¨ initPgSslDefaults ä¸­å¤„ç†
    max: 20,
    idleTimeoutMillis: 30_000,
    connectionTimeoutMillis: 10_000,
  });

  const dialect = new PostgresDialect({ pool });

  const db = new Kysely<Database>({
    dialect,
  });

  return db;
}


è¦ç‚¹ï¼š

ä¸è¦å†æ‰‹åŠ¨ç»™ Pool ä¼  ssl å­—æ®µï¼›

æ‰€æœ‰ SSL ç›¸å…³çš„åˆ¤æ–­å’Œæ—¥å¿—ï¼Œç»Ÿä¸€æ”¾åœ¨ initPgSslDefaults() é‡Œï¼›

ä¿ç•™å¿…è¦çš„è¿æ¥æ± å‚æ•°ï¼ˆmax / idleTimeout ç­‰ï¼‰ã€‚

4. ç¡®è®¤ NextAuth Adapter 100% å¤ç”¨åŒä¸€ä¸ª db
4.1 æ£€æŸ¥ src/lib/auth-kysely-adapter.ts

ç¡®ä¿æ–‡ä»¶ä¸­ æ²¡æœ‰ new Kysely(...) / new Pool(...)ã€‚
å¿…é¡»æ˜¯è¿™ç§å½¢å¼ï¼š

// src/lib/auth-kysely-adapter.ts
import type { Kysely } from "kysely";
import type { Adapter } from "@auth/core/adapters";
import { KyselyAdapter as OriginalKyselyAdapter } from "@auth/kysely-adapter";

export function createPatchedKyselyAdapter(db: Kysely<Database>): Adapter {
  const base = OriginalKyselyAdapter(db as any) as Adapter;

  // å¦‚æœ‰é¢å¤– patchï¼Œåœ¨è¿™é‡ŒåŒ…ä¸€å±‚ï¼›ä¸¥ç¦å†å»ºæ–°çš„ Kysely/Pool
  return {
    ...base,
    // ... è‡ªå®šä¹‰å®ç°ä¿æŒä¸å˜
  };
}


å¦‚æœå‘ç°ä»ç„¶æœ‰åˆ›å»º Kysely / Pool çš„é€»è¾‘ï¼Œä¸€å¾‹åˆ é™¤ï¼Œç»Ÿä¸€ä½¿ç”¨ä¼ å…¥çš„ dbã€‚

4.2 æ£€æŸ¥ src/lib/auth.ts

ä¿è¯é…ç½®ä¸ºï¼š

import { db } from "./db";
import { createPatchedKyselyAdapter } from "./auth-kysely-adapter";

export const authOptions: NextAuthConfig = {
  adapter: createPatchedKyselyAdapter(db),
  // ... å…¶ä»– NextAuth é…ç½®
};

5. å…¨é¡¹ç›®çº§æ¸…ç†ï¼šç§»é™¤æ‰€æœ‰å¤šä½™ Pool / SSL é…ç½®

å¯¹æ•´ä¸ªä»“åº“åšä¸€æ¬¡æœç´¢ï¼ŒæŒ‰ä»¥ä¸‹è§„åˆ™å¤„ç†ï¼š

æœç´¢å…³é”®å­—ï¼š

new Pool(

pg.Pool

ssl:

NODE_TLS_REJECT_UNAUTHORIZED

è§„èŒƒï¼š

é™¤ src/lib/db.ts å¤–ï¼Œä¸å¾—å†æ‰‹åŠ¨åˆ›å»º pg.Poolï¼›
å¦‚ç¡®å®æœ‰å…¶ä»–æœåŠ¡ï¼ˆä¾‹å¦‚ aiDb.ts ä½¿ç”¨ AI å‘é‡åº“ï¼‰ï¼Œä¹Ÿå¿…é¡»ï¼š

åœ¨å¯¹åº”æ¨¡å—ä¸­è°ƒç”¨ initPgSslDefaults(connectionString)ï¼›

æˆ–è€…ç»Ÿä¸€æ”¹ä¸ºä» db.ts å¯¼å‡ºçš„ db / aiDb å·¥å‚ï¼Œå¤ç”¨é€»è¾‘ã€‚

é¡¹ç›®ä¸­ å¿…é¡»ä¸å­˜åœ¨ å¯¹ NODE_TLS_REJECT_UNAUTHORIZED çš„èµ‹å€¼ï¼š

process.env.NODE_TLS_REJECT_UNAUTHORIZED = "0"; // âŒ å¿…é¡»åˆ é™¤


åˆ é™¤æ‰€æœ‰æ—§çš„ SSL æ—¥å¿—ã€å˜é‡ï¼ˆå¦‚æœè¿˜æ®‹ç•™ï¼‰ï¼š

hasSSL

sslConfig

[DB Config] âœ… SSL enabled for Supabase connection ç­‰

6. éªŒæ”¶æ­¥éª¤ï¼ˆCursor å®Œæˆåå¿…é¡»è‡ªæµ‹ï¼‰

åœ¨æœ¬åœ°ï¼ˆè¿åŒä¸€ä¸ª Supabase æ•°æ®åº“ï¼‰è¿è¡Œ npm run dev æˆ– pnpm devã€‚

è®¿é—®æœ¬åœ° /api/auth/debug æˆ–ç›´æ¥è§¦å‘ Google/LINE/X ç™»å½•ã€‚

é¢„æœŸæ—¥å¿—ï¼ˆæœ¬åœ°ï¼‰ï¼š

æœ‰ [DB][SSL] pg.defaults.ssl initialized: æ—¥å¿—ï¼›

ä¸å†å‡ºç° SELF_SIGNED_CERT_IN_CHAINã€‚

æ¨é€ & éƒ¨ç½²åˆ° Vercel åï¼Œåœ¨ç”Ÿäº§æ—¥å¿—ä¸­æ£€æŸ¥ï¼š

âœ… å‡ºç°ç±»ä¼¼ï¼š

[DB][SSL] pg.defaults.ssl initialized: { enabled: true, mode: 'rejectUnauthorized-false' }
[DB][Config] Using connection string (first 80 chars): postgresql://postgres.vdtnzjvmvrcdplawwiae:...


âœ… å†æ¬¡é€šè¿‡ Google / LINE / X ç™»å½•ï¼š

ä¸å†å‡ºç° [NextAuth][AdapterError][cause] SELF_SIGNED_CERT_IN_CHAINï¼›

OAuth å›è°ƒèƒ½å¤Ÿæ­£å¸¸å®Œæˆï¼Œç”¨æˆ·æˆåŠŸç™»å½•ã€‚