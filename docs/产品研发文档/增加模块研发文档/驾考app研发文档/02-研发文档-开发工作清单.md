# ZALEM 后台管理系统 - 研发文档(开发工作清单)

**文档版本**: v1.0  
**文档日期**: 2025-11-01  
**适用范围**: 开发团队  
**规范依据**: 
- `Zalem 后台管理 · 统一参数 & 接口规范 v1.0.md`
- `ZALEM 后台管理 API · 统一研发规范 vNext.md`

---

## 📋 目录结构规范

### 必须遵守的路径规范

- ✅ 根别名: `@` 指向 `src/`
  - ✅ 使用: `@/lib/db`、`@/app/api/_lib/errors`
  - ❌ 禁止: `@/src/...`、相对路径 `../../..`
- ✅ 迁移文件: 位于仓库根目录 `migrations/*.sql`
  - ✅ 正确: `migrations/20251101_add_activation_admin_fields.sql`
  - ❌ 禁止: `src/migrations/...`

---

## 1. 数据库层(已完成 ✅)

### 1.1 迁移脚本

**文件**: `migrations/20251101_add_activation_admin_fields.sql`

**工作清单**:
- [x] 创建迁移脚本文件
- [x] 添加`status`字段(VARCHAR(20), CHECK约束)
- [x] 添加`expires_at`字段(TIMESTAMP NULL)
- [x] 添加`enabled_at`字段(TIMESTAMP NULL)
- [x] 添加`notes`字段(TEXT NULL)
- [x] 确保`used_count`和`usage_limit`字段存在
- [x] 创建索引: `idx_activation_codes_status`
- [x] 创建索引: `idx_activation_codes_expires_at`
- [x] 添加回滚指令注释

**规范要求**:
- ✅ 使用`BEGIN/COMMIT`事务包裹
- ✅ 使用`IF NOT EXISTS`避免重复执行
- ✅ 添加CHECK约束保证数据完整性
- ✅ 为高频查询字段建立索引

### 1.2 数据库类型定义

**文件**: `src/lib/db.ts`

**工作清单**:
- [x] 定义`ActivationCodeTable`接口(包含新增字段)
- [x] 定义`ActivationTable`接口
- [x] 定义`Database`总接口
- [x] 配置Kysely连接
- [x] 仅导出`db`实例(不导出`Database`类型)

**规范要求**:
- ✅ 字段命名: `snake_case`
- ✅ 时间字段类型: `Date | null`
- ✅ 状态字段类型: 联合类型 `"disabled" | "enabled" | "suspended" | "expired"`
- ✅ 禁止导出`Database`类型

---

## 2. 工具库层(已完成 ✅)

### 2.1 统一错误处理

**文件**: `src/app/api/_lib/errors.ts`

**工作清单**:
- [x] 定义`ErrorResponse`接口
- [x] 实现`success()`函数
- [x] 实现错误响应生成器
- [x] 实现常用错误函数:
  - [x] `badRequest()` - 400
  - [x] `unauthorized()` - 401
  - [x] `forbidden()` - 403
  - [x] `notFound()` - 404
  - [x] `conflict()` - 409
  - [x] `invalidState()` - 409
  - [x] `internalError()` - 500

**规范要求**:
- ✅ 统一响应格式: `{ ok: false, errorCode, message }`
- ✅ 禁止手写`NextResponse.json()`返回错误
- ✅ 所有错误使用工具函数

### 2.2 分页工具

**文件**: `src/app/api/_lib/pagination.ts`

**工作清单**:
- [x] 定义`PaginationParams`接口
- [x] 定义`PaginationMeta`接口
- [x] 实现`parsePagination()`函数
- [x] 实现`getPaginationMeta()`函数

**规范要求**:
- ✅ 默认值: `page=1`, `limit=20`, `order='desc'`
- ✅ `limit`上限: 100
- ✅ `getPaginationMeta()`签名: `(page: number, limit: number, total: number)`
- ✅ 禁止使用旧版签名(对象入参版已废弃)

**⚠️ 潜在问题**:
- 规范文档中提到对象入参版`getPaginationMeta({ page, limit, total })`,但当前实现是位置参数版
- 需要确认是否统一为对象入参版,如果是,需要全量替换调用处

### 2.3 参数验证工具

**文件**: `src/app/api/_lib/validators.ts`

**工作清单**:
- [x] 定义`VALID_STATUSES`常量数组
- [x] 定义`ActivationStatus`类型
- [x] 实现`parseISODate()`函数
- [x] 实现`validateUsageLimit()`函数
- [x] 实现`validateCount()`函数
- [x] 实现`validateStatus()`函数
- [x] 实现`validateActivationCodeCreate()`组合验证函数

**规范要求**:
- ✅ 所有枚举入参先白名单校验
- ✅ 日期格式: ISO 8601
- ✅ 数值范围校验: `count`(1-10000), `usageLimit`(≥1)
- ✅ 校验失败抛出错误响应

### 2.4 管理员鉴权

**文件**: `src/app/api/_lib/withAdminAuth.ts`

**工作清单**:
- [x] 实现`withAdminAuth()`高阶函数
- [x] 检查`Authorization`头存在
- [x] 验证Bearer Token格式
- [x] 比较Token与`ADMIN_TOKEN`环境变量
- [x] 返回统一错误响应

**规范要求**:
- ✅ 所有`/api/admin/**`必须使用此中间件
- ✅ 错误码: `AUTH_REQUIRED`(401)或`FORBIDDEN`(403)
- ✅ 禁止在日志中泄露Token

---

## 3. 后台管理API层(已完成 ✅)

### 3.1 激活码列表查询

**文件**: `src/app/api/admin/activation-codes/route.ts` (GET方法)

**工作清单**:
- [x] 使用`withAdminAuth`包装
- [x] 解析分页参数(`page`, `limit`, `sortBy`, `order`)
- [x] 解析筛选参数(`status`, `code`, `expiresBefore`, `expiresAfter`)
- [x] 实现基础查询构建器
- [x] 实现状态筛选(白名单校验)
- [x] 实现激活码模糊搜索
- [x] 实现到期时间范围筛选
- [x] 实现计数查询(与主查询过滤一致)
- [x] 实现排序(白名单映射)
- [x] 实现分页(limit/offset)
- [x] 返回统一响应格式

**规范要求**:
- ✅ 排序字段白名单校验
- ✅ 使用SQL模板表达式处理时间比较(符合K-4)
- ✅ 计数查询独立构造,过滤条件一致(符合K-2)
- ✅ 输出字段转换为`camelCase`
- ✅ 时间输出使用`toISOString()`

**⚠️ 潜在问题**:
- `sortBy`未进行白名单校验,直接使用可能导致SQL注入风险
- 需要定义排序白名单并映射到数据库列名

### 3.2 批量生成激活码

**文件**: `src/app/api/admin/activation-codes/route.ts` (POST方法)

**工作清单**:
- [x] 使用`withAdminAuth`包装
- [x] 解析请求体
- [x] 使用`validateActivationCodeCreate()`验证
- [x] 生成唯一激活码(6位字母数字)
- [x] 批量插入数据库
- [x] 返回生成的激活码列表

**规范要求**:
- ✅ `count`范围: 1-10000
- ✅ 生成时禁止`expired`状态(建议校验)
- ✅ 使用事务保证原子性(可选,批量插入)
- ✅ 返回完整数据对象

**⚠️ 潜在问题**:
- 未对生成数量上限进行事务保护(大量插入可能超时)
- 激活码生成算法可能存在碰撞风险(建议添加唯一性检查)

### 3.3 编辑激活码

**文件**: `src/app/api/admin/activation-codes/[id]/route.ts` (PUT方法)

**工作清单**:
- [x] 使用`withAdminAuth`包装
- [x] 解析路由参数`id`
- [x] 校验ID有效性
- [x] 解析请求体(至少一个字段)
- [x] 查询激活码是否存在
- [x] 校验状态流转合法性(禁止从`expired`改回)
- [x] 白名单校验状态值
- [x] 解析和校验日期字段
- [x] 更新数据库
- [x] 返回更新后的对象

**规范要求**:
- ✅ 状态流转校验: 禁止`expired`改回其他状态
- ✅ 使用`invalidState()`返回409错误
- ✅ 时间字段使用`parseISODate()`解析
- ✅ 更新`updated_at`字段

### 3.4 删除激活码

**文件**: `src/app/api/admin/activation-codes/[id]/route.ts` (DELETE方法)

**工作清单**:
- [x] 使用`withAdminAuth`包装
- [x] 解析路由参数`id`
- [x] 校验ID有效性
- [x] 查询激活码是否存在
- [x] 检查是否已使用(`used_count > 0`)
- [x] 已使用则返回409错误
- [x] 执行删除
- [x] 返回删除结果

**规范要求**:
- ✅ 已使用的激活码禁止删除
- ✅ 使用`conflict()`返回409错误
- ✅ 返回删除数量确认

### 3.5 统计信息

**文件**: `src/app/api/admin/activation-codes/stats/route.ts`

**工作清单**:
- [x] 使用`withAdminAuth`包装
- [x] 查询总数
- [x] 按状态分组统计
- [x] 统计已用/未用数量
- [x] 计算使用率
- [x] 组装响应数据
- [x] 返回统一格式

**规范要求**:
- ✅ 确保缺省状态数量为0
- ✅ 使用率计算: `used / total`
- ✅ 聚合结果使用`Number()`转换(符合K-6)

### 3.6 用户查询

**文件**: `src/app/api/admin/users/route.ts`

**工作清单**:
- [x] 使用`withAdminAuth`包装
- [x] 解析查询参数(`email`, `code`, `page`, `limit`, `sortBy`, `order`)
- [x] 实现排序白名单和映射函数(符合S-4)
- [x] 实现计数查询(LEFT JOIN)
- [x] 实现大小写不敏感搜索(使用SQL模板,符合K-5)
- [x] 实现主查询(LEFT JOIN)
- [x] 实现排序(白名单映射)
- [x] 实现分页
- [x] 映射输出字段(`camelCase`)
- [x] 时间字段转换为ISO格式

**规范要求**:
- ✅ 排序白名单: `['activatedAt', 'email', 'code']`
- ✅ 使用`sql<boolean>`模板实现ILIKE(符合K-5)
- ✅ LEFT JOIN关联`activation_codes`表
- ✅ 输出字段统一`camelCase`
- ✅ 计数查询与主查询过滤一致

**✅ 符合规范**: 该文件已完全符合vNext规范要求

### 3.7 过期检查任务

**文件**: `src/app/api/admin/tasks/sweep-expired/route.ts`

**工作清单**:
- [x] 使用`withAdminAuth`包装
- [x] 解析`mode`参数(dry-run模式)
- [x] 实现过期条件SQL模板
- [x] 实现dry-run模式(仅统计)
- [x] 实现执行模式(批量更新)
- [x] 返回受影响数量

**规范要求**:
- ✅ 过期条件: `expires_at IS NOT NULL AND expires_at < NOW() AND status != 'expired'`
- ✅ 支持dry-run预览
- ✅ 使用SQL模板表达式(符合K-4)
- ✅ 返回执行时间戳

**⚠️ 潜在问题**:
- 定时任务自动化配置未完成(需要配置cron job)

---

## 4. 用户激活接口优化(待完成 ⚠️)

### 4.1 激活接口增强

**文件**: `src/app/api/activate/route.ts`

**待完成工作清单**:
- [ ] 检查激活码状态是否为`enabled`(拒绝`suspended`和`expired`)
- [ ] 检查激活码是否过期(`expires_at < now()`)
- [ ] 如果过期,自动更新状态为`expired`并拒绝
- [ ] 可选: 首次使用时自动启用(`disabled → enabled`并设置`enabled_at`)
- [ ] 保持原有使用次数检查逻辑
- [ ] 使用统一错误响应格式(当前使用自定义格式)

**规范要求**:
- ✅ 状态检查: `suspended` → 403, `expired` → 409
- ✅ 过期检查: 自动更新为`expired`并拒绝
- ✅ 错误响应使用工具函数(不使用自定义格式)
- ✅ 响应格式统一: `{ ok: true/false, ... }`

**⚠️ 当前问题**:
- 未检查激活码状态(`status`字段)
- 未检查过期时间(`expires_at`)
- 响应格式不统一(使用`success`而非`ok`)
- 未使用统一错误处理工具

---

## 5. 前端管理界面(待开发 ❌)

### 5.1 基础布局

**文件**: `src/app/admin/layout.tsx`

**待完成工作清单**:
- [ ] 创建管理后台布局组件
- [ ] 实现导航菜单
- [ ] 实现Token检查(未登录跳转登录页)
- [ ] 实现登出功能

### 5.2 登录页面

**文件**: `src/app/admin/login/page.tsx`

**待完成工作清单**:
- [ ] 创建登录表单
- [ ] Token输入框
- [ ] 提交按钮
- [ ] Token验证逻辑
- [ ] Token持久化到localStorage
- [ ] 登录成功后跳转

### 5.3 API客户端

**文件**: `src/lib/apiClient.ts`

**待完成工作清单**:
- [ ] 创建统一fetch封装
- [ ] 自动添加`Authorization`头
- [ ] 从localStorage读取Token
- [ ] 统一错误处理
- [ ] 响应格式解析

### 5.4 激活码列表页

**文件**: `src/app/admin/activation-codes/page.tsx`

**待完成工作清单**:
- [ ] 列表展示组件
- [ ] 搜索表单(状态、激活码、到期时间)
- [ ] 筛选组件
- [ ] 排序组件
- [ ] 分页组件
- [ ] 编辑/删除操作按钮
- [ ] 调用`GET /api/admin/activation-codes`

### 5.5 激活码生成页

**文件**: `src/app/admin/activation-codes/new/page.tsx`

**待完成工作清单**:
- [ ] 生成表单组件
- [ ] 数量输入(1-10000)
- [ ] 使用次数输入(≥1)
- [ ] 状态选择(disabled/enabled/suspended)
- [ ] 到期时间选择器
- [ ] 备注输入框
- [ ] 提交按钮
- [ ] 调用`POST /api/admin/activation-codes`
- [ ] 结果展示(生成的激活码列表)

### 5.6 激活码编辑页

**文件**: `src/app/admin/activation-codes/[id]/edit/page.tsx`

**待完成工作清单**:
- [ ] 编辑表单组件
- [ ] 加载激活码数据(`GET /api/admin/activation-codes/:id`)
- [ ] 使用次数编辑
- [ ] 状态选择(禁止expired改回)
- [ ] 到期时间编辑
- [ ] 备注编辑
- [ ] 提交按钮
- [ ] 调用`PUT /api/admin/activation-codes/:id`
- [ ] 状态流转提示

### 5.7 统计仪表板

**文件**: `src/app/admin/stats/page.tsx`

**待完成工作清单**:
- [ ] 仪表板布局
- [ ] 总数卡片
- [ ] 状态分布图表(饼图/柱状图)
- [ ] 使用率图表
- [ ] 调用`GET /api/admin/activation-codes/stats`
- [ ] 数据刷新功能

### 5.8 用户查询页

**文件**: `src/app/admin/users/page.tsx`

**待完成工作清单**:
- [ ] 搜索表单(邮箱、激活码)
- [ ] 列表展示组件
- [ ] 分页组件
- [ ] 排序功能
- [ ] 调用`GET /api/admin/users`

### 5.9 任务管理页

**文件**: `src/app/admin/tasks/page.tsx`

**待完成工作清单**:
- [ ] 任务列表展示
- [ ] 过期检查任务卡片
- [ ] Dry-run按钮
- [ ] 执行按钮
- [ ] 执行结果展示
- [ ] 调用`POST /api/admin/tasks/sweep-expired`

### 5.10 公共组件

**目录**: `src/components/admin/`

**待完成工作清单**:
- [ ] `Pagination.tsx` - 分页组件
- [ ] `FilterBar.tsx` - 筛选栏组件
- [ ] `StatusBadge.tsx` - 状态标签组件
- [ ] `DatePicker.tsx` - 日期选择器
- [ ] `ConfirmDialog.tsx` - 确认对话框
- [ ] `LoadingSpinner.tsx` - 加载动画

---

## 6. 环境配置(部分完成 ⚠️)

### 6.1 环境变量

**文件**: `.env.example` (待创建)

**待完成工作清单**:
- [ ] 创建`.env.example`文件
- [ ] 添加`DATABASE_URL`说明
- [ ] 添加`ADMIN_TOKEN`说明
- [ ] 添加`TZ=UTC`说明
- [ ] 添加安全提示(不得提交真实`.env`)

**规范要求**:
- ✅ 必须包含上述3个环境变量
- ✅ 添加注释说明用途
- ✅ 添加安全警告

### 6.2 定时任务配置

**待完成工作清单**:
- [ ] 配置cron job调用`/api/admin/tasks/sweep-expired`
- [ ] 建议执行频率: 每天凌晨
- [ ] 可选: 使用Vercel Cron Jobs或其他调度服务

---

## 7. 文档(部分完成 ✅)

### 7.1 API文档

**文件**: `API接口快速参考.md`

**待完成工作清单**:
- [ ] 检查文档完整性
- [ ] 确保示例curl命令包含鉴权头
- [ ] 确保路径、参数、响应格式与实现一致

### 7.2 数据库文档

**文件**: `数据库架构说明.md`

**待完成工作清单**:
- [ ] 检查文档完整性
- [ ] 确保包含新增字段说明
- [ ] 确保包含索引说明

---

## 8. 测试(待补充 ❌)

### 8.1 单元测试

**待完成工作清单**:
- [ ] 工具库测试(`errors.ts`, `pagination.ts`, `validators.ts`)
- [ ] 鉴权中间件测试
- [ ] API接口测试(使用测试框架)

### 8.2 集成测试

**待完成工作清单**:
- [ ] 完整业务流程测试
- [ ] 数据库操作测试
- [ ] 错误处理测试

### 8.3 E2E测试(可选)

**待完成工作清单**:
- [ ] 前端页面流程测试
- [ ] 用户激活流程测试

---

## 9. 代码审查清单(CI/CD)

### 9.1 规范检查

- [x] 禁止嵌套where
- [x] 计数查询独立构造
- [x] 排序字段白名单校验(部分完成,需检查)
- [x] 时间比较使用SQL模板
- [x] ILIKE使用SQL模板
- [x] 聚合结果使用Number()转换
- [x] 不导出Database类型
- [x] 统一错误响应格式(部分完成,激活接口待更新)
- [x] 输出字段camelCase
- [x] 时间输出toISOString()

### 9.2 类型检查

- [ ] `npx tsc --noEmit` 通过
- [ ] 无隐式any
- [ ] 无未使用变量

### 9.3 Lint检查

- [ ] ESLint无阻断错误
- [ ] Prettier格式化一致

---

## 10. 部署清单

### 10.1 数据库迁移

- [ ] 执行迁移脚本到生产环境
- [ ] 验证迁移成功
- [ ] 准备回滚方案

### 10.2 环境变量配置

- [ ] 配置生产环境`DATABASE_URL`
- [ ] 配置生产环境`ADMIN_TOKEN`
- [ ] 配置`TZ=UTC`

### 10.3 定时任务配置

- [ ] 配置生产环境cron job
- [ ] 测试定时任务执行
- [ ] 监控任务执行情况

---

**文档维护者**: 开发团队  
**最后更新**: 2025-11-01  
**状态**: 后端API基本完成,前端界面和激活接口优化待开发
