# ZALEM 后台管理系统 - 产品需求文档

**文档版本**: v1.0  
**文档日期**: 2025-11-01  
**适用范围**: 产品经理、业务方、开发团队

---

## 📋 业务目标

在**不改变现有用户激活流程**的前提下,为 ZALEM 驾照学习平台增加后台管理能力,支持激活码全生命周期管理、用户状态查询和自动化到期处理。

---

## 1. 激活码管理功能

### 1.1 激活码列表查询

**业务需求**: 管理员需要能够查看所有激活码的列表,并支持多种筛选和排序方式。

**功能清单**:
- ✅ 分页查询(默认每页20条,最大100条)
- ✅ 按状态筛选(已过期/未启用/已启用/挂起)
- ✅ 按激活码模糊搜索
- ✅ 按到期时间范围筛选(到期前/到期后)
- ✅ 多字段排序(创建时间/启用时间/到期时间/使用次数/使用上限/状态)
- ✅ 显示激活码完整信息(状态、使用次数、到期时间、备注等)

### 1.2 批量生成激活码

**业务需求**: 管理员需要能够批量生成新的激活码,用于分发或售卖。

**功能清单**:
- ✅ 支持批量生成(1-10000个)
- ✅ 设置使用次数限制
- ✅ 设置初始状态(默认未启用)
- ✅ 设置到期时间(可选)
- ✅ 添加备注(渠道/用途标识)
- ✅ 自动生成唯一激活码(6位字母数字组合)

### 1.3 编辑激活码

**业务需求**: 管理员需要能够修改激活码的属性,包括使用次数、状态、到期时间等。

**功能清单**:
- ✅ 修改使用次数限制
- ✅ 手动调整状态(未启用/已启用/挂起/已过期)
- ✅ 修改到期时间
- ✅ 添加/修改备注
- ✅ 状态流转校验(不允许将已过期状态改回其他状态)

### 1.4 删除激活码

**业务需求**: 管理员需要能够删除无效或错误的激活码。

**功能清单**:
- ✅ 删除指定激活码
- ✅ 已使用的激活码禁止删除(业务保护)
- ✅ 返回删除结果确认

### 1.5 统计信息

**业务需求**: 管理员需要查看激活码的整体统计信息,了解业务数据。

**功能清单**:
- ✅ 激活码总数统计
- ✅ 各状态数量统计(已启用/未启用/已过期/挂起)
- ✅ 使用情况统计(已用/未用数量)
- ✅ 使用率计算(已用数量/总数)

---

## 2. 激活码状态管理

### 2.1 状态定义

**业务需求**: 激活码需要有明确的状态机,支持业务流转。

**状态枚举**:
- **disabled (未启用)**: 默认状态,未启用不可使用
- **enabled (已启用)**: 可以使用
- **suspended (挂起)**: 临时禁用,不能用于激活
- **expired (已过期)**: 到期时间已过,自动或手动标记

### 2.2 状态流转规则

**业务需求**: 确保状态流转符合业务逻辑。

**规则清单**:
- ✅ 手动状态调整(通过编辑接口)
- ✅ 禁止将"已过期"状态改回其他状态(业务保护)
- ✅ 过期自动标记(通过定时任务)

### 2.3 到期时间管理

**业务需求**: 激活码支持设置到期时间,到期后自动失效。

**功能清单**:
- ✅ 设置到期时间(可选,ISO 8601格式)
- ✅ 过期自动检查(定时任务)
- ✅ 过期激活码不能用于激活(需在激活接口实现)

---

## 3. 用户状态查询功能

**业务需求**: 管理员需要能够查询用户的激活记录和相关信息。

**功能清单**:
- ✅ 按邮箱查询用户激活记录
- ✅ 按激活码查询使用情况
- ✅ 分页查询(默认每页20条)
- ✅ 显示用户激活信息(邮箱、激活码、激活时间、IP地址、User-Agent)
- ✅ 显示关联激活码状态(状态、到期时间)
- ✅ 多字段排序(激活时间/邮箱/激活码)

---

## 4. 自动化任务

### 4.1 过期检查任务

**业务需求**: 自动将过期的激活码标记为"已过期"状态。

**功能清单**:
- ✅ 批量扫描过期激活码(`expires_at < 当前时间`)
- ✅ 自动将过期激活码状态更新为"expired"
- ✅ 支持dry-run模式(预览将受影响的数量,不执行更新)
- ✅ 返回受影响数量统计

**执行频率建议**: 每天凌晨执行一次

---

## 5. 权限与安全

### 5.1 管理员鉴权

**业务需求**: 所有后台管理接口必须进行权限验证。

**功能清单**:
- ✅ Bearer Token认证(`Authorization: Bearer <ADMIN_TOKEN>`)
- ✅ 所有`/api/admin/**`接口必须鉴权
- ✅ 无效Token返回401/403错误

### 5.2 数据安全

**业务需求**: 确保敏感信息不被泄露。

**功能清单**:
- ✅ 错误信息不泄露Token等敏感信息
- ✅ 日志不记录敏感数据
- ✅ 输入参数白名单校验

---

## 6. 前端管理界面(待开发)

### 6.1 登录页面

**业务需求**: 管理员登录入口。

**功能清单**:
- ❌ 登录页面(`/admin/login`)
- ❌ Token输入界面
- ❌ Token持久化(localStorage)

### 6.2 激活码管理页面

**业务需求**: 激活码的完整管理界面。

**功能清单**:
- ❌ 激活码列表页(`/admin/activation-codes`)
  - 列表展示、搜索、筛选、排序
  - 分页组件
  - 编辑/删除操作
- ❌ 激活码生成页(`/admin/activation-codes/new`)
  - 批量生成表单
  - 参数配置(数量、使用次数、状态、到期时间、备注)
- ❌ 激活码编辑页
  - 编辑表单
  - 状态流转提示

### 6.3 统计仪表板

**业务需求**: 数据可视化展示。

**功能清单**:
- ❌ 统计仪表板(`/admin/stats`)
  - 总数展示
  - 状态分布图表
  - 使用率图表

### 6.4 用户查询页面

**业务需求**: 用户激活记录查询界面。

**功能清单**:
- ❌ 用户查询页(`/admin/users`)
  - 搜索表单(邮箱/激活码)
  - 结果列表展示
  - 分页组件

### 6.5 任务管理页面

**业务需求**: 自动化任务执行界面。

**功能清单**:
- ❌ 任务管理页(`/admin/tasks`)
  - 过期检查任务执行按钮
  - Dry-run预览
  - 执行结果展示

---

## 7. 数据格式规范

### 7.1 时间格式

**业务需求**: 统一使用ISO 8601 UTC格式。

**格式要求**:
- ✅ 输入/输出: `2025-12-31T23:59:59Z`
- ✅ 时区: UTC

### 7.2 命名规范

**业务需求**: 保持代码和API的一致性。

**规范要求**:
- ✅ 数据库字段: `snake_case`(如: `expires_at`)
- ✅ API JSON字段: `camelCase`(如: `expiresAt`)
- ✅ 枚举值: 小写字符串(如: `enabled`)

### 7.3 分页规范

**业务需求**: 统一分页参数和响应格式。

**规范要求**:
- ✅ 查询参数: `page`(默认1)、`limit`(默认20,最大100)
- ✅ 响应格式: `{ page, limit, total, totalPages }`

---

## 8. 验收标准

### 8.1 功能验收

- [x] 所有后台管理API接口实现完成
- [x] 数据库字段和索引已添加
- [x] 鉴权系统正常工作
- [x] 状态管理逻辑正确
- [ ] 激活接口包含过期和状态检查
- [ ] 定时任务已配置自动化执行
- [ ] 前端管理界面开发完成

### 8.2 性能验收

- [x] 查询接口支持分页,避免大数据量查询
- [x] 数据库索引已建立,查询性能良好
- [ ] 前端页面加载时间<2秒

### 8.3 安全验收

- [x] 所有后台接口需要鉴权
- [x] 输入参数白名单校验
- [x] 错误信息不泄露敏感数据
- [ ] Token安全存储(前端)

---

## 9. 业务流程

### 9.1 激活码生成流程

1. 管理员登录后台
2. 进入激活码生成页面
3. 填写生成参数(数量、使用次数、状态、到期时间、备注)
4. 点击生成按钮
5. 系统批量生成激活码并保存到数据库
6. 返回生成结果列表

### 9.2 激活码使用流程

1. 用户在前端输入邮箱和激活码
2. 调用`/api/activate`接口
3. 系统检查:
   - 激活码是否存在
   - 激活码状态是否为"enabled"
   - 激活码是否已过期
   - 使用次数是否超限
4. 验证通过后更新使用次数,记录激活信息
5. 返回激活成功

### 9.3 过期检查流程

1. 定时任务(建议每天凌晨)调用`/api/admin/tasks/sweep-expired`
2. 系统扫描所有`expires_at < 当前时间`且状态非"expired"的激活码
3. 批量将过期激活码状态更新为"expired"
4. 返回受影响数量

---

## 10. 非功能需求

### 10.1 可用性

- 后台管理界面操作简单直观
- 错误提示明确易懂
- 加载状态提示清晰

### 10.2 可靠性

- 数据库操作使用事务保证一致性
- 错误处理完善,避免系统崩溃
- 定时任务失败不影响其他功能

### 10.3 可维护性

- 代码结构清晰,遵循统一规范
- 日志记录完善,便于排查问题
- 文档完整,便于后续维护

---

**文档维护者**: 产品团队  
**最后更新**: 2025-11-01  
**状态**: 业务需求已明确,待开发实现
