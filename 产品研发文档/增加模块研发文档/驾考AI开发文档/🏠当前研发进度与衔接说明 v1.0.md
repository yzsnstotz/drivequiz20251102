# 🧭 当前研发进度与衔接说明 v1.0

## 一、总体状态
- 当前版本：v1.0.2（核心功能实现阶段）
- 当前负责人窗口：Cursor
- 最新更新时间：2025-11-03 14:37:18
- 当前阶段目标：完成 AI-Service 与主站 API 路由集成，实现前端组件对接
- 当前状态标签：🚧 开发中

---

## 二、模块进度
| 模块 | 状态 | 负责人 | 下一步行动 |
|------|------|----------|-------------|
| /apps/ai-service/src/index.ts | ✅ 已完成 | O1-BE | 无需修改 |
| /apps/ai-service/src/routes/ask.ts | ✅ 已完成 | O1-BE | 无需修改 |
| /apps/ai-service/src/lib/rag.ts | ✅ 已完成 | O1-BE | 验证 Supabase RPC 连接 |
| /apps/ai-service/src/lib/cache.ts | ✅ 已完成 | O1-BE | 无需修改 |
| /apps/ai-service/src/lib/openaiClient.ts | ✅ 已完成 | O1-BE | 无需修改 |
| /apps/ai-service/src/lib/safety.ts | ✅ 已完成 | O1-BE | 无需修改 |
| /src/app/api/ai/ask/route.ts | ✅ 已完成 | O1-FE | 等待 AI-Service 联调测试 |
| /apps/ai-service/src/tasks/dailySummarize.ts | ✅ 已完成 | O1-BE | 加入定时任务注册 |
| /src/components/AIPage.tsx | 🚧 基础 UI | O1-FE | 接入 /api/ai/ask 接口，完善交互逻辑 |
| /src/app/admin/ai-monitor | 💤 未开始 | O1-FE | UI 设计中 |

---

## 三、接口状态
| 接口 | 状态 | 测试 | 备注 |
|------|------|------|------|
| POST /v1/ask | ✅ 已完成 | ⏳ 待集成测试 | AI-Service 核心路由已实现 |
| POST /api/ai/ask | ✅ 已完成 | ⏳ 待集成测试 | 主站 API 路由已实现，待联调验证 |
| GET /api/admin/ai/logs | 💤 未开始 | - | 等待数据库表创建与需求确认 |
| GET /api/admin/ai/summary | 💤 未开始 | - | 等待 dailySummarize 数据源 |
| GET /api/admin/ai/filters | 💤 未开始 | - | 等待需求确认 |
| POST /api/admin/ai/rag/docs | 💤 未开始 | - | 等待向量化流程实现 |

---

## 四、数据库迁移进度
| 表名 | 状态 | 说明 |
|------|------|------|
| ai_logs | 💤 未建 | 需创建迁移脚本（记录问答调用） |
| ai_vectors / ai_docs_embeddings | 💤 未建 | 需创建 Supabase pgvector 表与 RPC 函数 match_documents |
| ai_daily_summary | 💤 未建 | 等 dailySummarize 完成后迁移 |

---

## 五、测试与部署状态
- ⏳ 本地运行测试待进行（需验证主站与 AI-Service 联调）
- 💤 Railway 部署配置待创建
- 💤 Supabase 向量化验证待配置（RPC 函数 match_documents 待创建）
- 💤 日志落库功能待实现（ai_logs 表待创建）
- 💤 成本估算功能待实现（需扩展 token 统计）
- 💤 单元测试待编写
- 💤 集成测试待编写

---

## 六、下阶段任务（Next Steps）
1. [ ] **AI-Service 与主站联调测试**：验证 /api/ai/ask 调用 /v1/ask 端到端流程
2. [ ] **集成 AIPage 组件**：连接 /api/ai/ask 接口，实现问答交互与错误处理
3. [ ] **创建数据库迁移脚本**：ai_logs, ai_docs_embeddings, ai_daily_summary
4. [ ] **创建 Supabase RPC**：实现 match_documents 函数供 RAG 检索使用
5. [ ] **实现日志落库功能**：在 ask.ts 中调用后记录到 ai_logs 表
6. [ ] **扩展成本估算**：统计 tokens 并计算费用
7. [ ] **注册 dailySummarize 定时任务**：接入 pg_cron 或 Vercel Cron
8. [ ] **创建管理后台监控页面**：/src/app/admin/ai-monitor（调用量 & 成本图表）
9. [ ] **编写单元测试与集成测试**：覆盖核心功能
10. [ ] **Railway 部署配置与验证**：创建部署配置文件
11. [ ] **建立监控与告警机制**：高成本报警（Slack/Discord Webhook）

---

## 七、衔接说明
- **上一个开发窗口**：ChatGPT（提供架构与规范文档）
- **当前执行窗口**：Cursor（核心功能开发中）
- **下一步衔接窗口**：Cursor / O1（完成主站集成与测试）
- 所有任务均需遵守《研发规范 v1.0》与《接口与命名规范 v1.0》

**已完成的核心功能：**
- ✅ AI-Service 项目结构（Fastify）
- ✅ `/v1/ask` 核心路由逻辑（安全检测、RAG、缓存、OpenAI 调用）
- ✅ LRU 缓存层（内存实现）
- ✅ 内容安全检查模块（本地规则）
- ✅ OpenAI 客户端封装
- ✅ RAG 检索模块（Supabase Vector 调用，待验证）
- ✅ `/api/ai/ask` 主站 API 路由（JWT 验证、配额、转发）
- ✅ dailySummarize 任务实现（待定时注册）
- ✅ AIPage 基础 UI 组件（待 API 集成）

**待完成的关键任务：**
- 🔧 AI-Service 与主站联调测试（高优先级）
- 🔧 集成 AIPage 与后端 API（高优先级）
- 🔧 创建数据库表与迁移脚本（中优先级）
- 🔧 实现日志落库与成本统计（中优先级）
- 🔧 创建 Supabase RPC 函数（中优先级）
- 🔧 dailySummarize 定时任务注册（低优先级）

**已知问题与注意事项：**
- ✅ `/apps/ai-service/routes/ask.ts`：已修复 `getRagContext` 传参问题
- ✅ `/src/app/api/ai/ask/route.ts`：已实现完整的 JWT 验证、配额管理与错误处理
- ⚠️ RAG 模块依赖 Supabase RPC 函数 `match_documents`，需在 Supabase 中创建该函数
- ⚠️ 当前缓存使用内存 LRU，生产环境建议扩展为 Redis
- ⚠️ 主站 API 路由与 AI-Service 联调待验证，需确保环境变量配置正确

---

> _此文档由 Cursor 自动生成，用于保持 ZALEM 项目研发接力的上下文连续性。_
