name: æ„å»ºæ£€æŸ¥å’Œè‡ªåŠ¨ä¿®å¤

on:
  push:
    branches: [ feat/language-system, main, master ]
  pull_request:
    branches: [ feat/language-system, main, master ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥
      id: typecheck
      continue-on-error: true
      run: |
        npx tsc --noEmit 2>&1 | tee typecheck-errors.log
        if [ $? -eq 0 ]; then
          echo "typecheck_status=success" >> $GITHUB_OUTPUT
        else
          echo "typecheck_status=failed" >> $GITHUB_OUTPUT
        fi
        
    - name: è¿è¡Œæ„å»ºæ£€æŸ¥
      id: build
      continue-on-error: true
      run: |
        npm run build 2>&1 | tee build-errors.log
        if [ $? -eq 0 ]; then
          echo "build_status=success" >> $GITHUB_OUTPUT
        else
          echo "build_status=failed" >> $GITHUB_OUTPUT
        fi
        
    - name: ä¸Šä¼ æ„å»ºæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          typecheck-errors.log
          build-errors.log
        retention-days: 7
        
    - name: åˆ†æé”™è¯¯å¹¶åˆ›å»º Issue
      if: steps.build.outputs.build_status == 'failed' || steps.typecheck.outputs.typecheck_status == 'failed'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          
          // è¯»å–æ„å»ºæ—¥å¿—
          let buildLog = '';
          let typecheckLog = '';
          
          try {
            buildLog = fs.readFileSync('build-errors.log', 'utf8');
          } catch (e) {
            console.log('æ— æ³•è¯»å– build-errors.log');
          }
          
          try {
            typecheckLog = fs.readFileSync('typecheck-errors.log', 'utf8');
          } catch (e) {
            console.log('æ— æ³•è¯»å– typecheck-errors.log');
          }
          
          // æå–é”™è¯¯ä¿¡æ¯
          const errors = [];
          
          // ä»æ„å»ºæ—¥å¿—ä¸­æå– TypeScript é”™è¯¯
          const buildErrorMatch = buildLog.match(/Type error:.*?\n.*?(\d+:\d+)/s);
          if (buildErrorMatch) {
            errors.push({
              type: 'TypeScript ç±»å‹é”™è¯¯',
              message: buildErrorMatch[0].substring(0, 500),
              file: buildErrorMatch[1] || 'æœªçŸ¥æ–‡ä»¶'
            });
          }
          
          // ä»ç±»å‹æ£€æŸ¥æ—¥å¿—ä¸­æå–é”™è¯¯
          const typecheckErrors = typecheckLog.match(/error TS\d+.*/g);
          if (typecheckErrors) {
            typecheckErrors.slice(0, 5).forEach(err => {
              errors.push({
                type: 'TypeScript ç¼–è¯‘é”™è¯¯',
                message: err.substring(0, 200)
              });
            });
          }
          
          // åˆ›å»º Issue
          if (errors.length > 0) {
            const issueBody = `## ğŸš¨ æ„å»ºå¤±è´¥æŠ¥å‘Š
            
            **åˆ†æ”¯**: ${{ github.ref }}
            **æäº¤**: ${{ github.sha }}
            **è§¦å‘è€…**: ${{ github.actor }}
            
            ### å‘ç°çš„é”™è¯¯
            
            ${errors.map((err, i) => `
            #### é”™è¯¯ ${i + 1}: ${err.type}
            \`\`\`
            ${err.message}
            \`\`\`
            `).join('\n')}
            
            ### å®Œæ•´æ—¥å¿—
            
            è¯·æŸ¥çœ‹ [æ„å»ºæ—¥å¿— Artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ---
            *æ­¤ Issue ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ æ„å»ºå¤±è´¥: ${context.ref.replace('refs/heads/', '')} - ${new Date().toLocaleString('zh-CN')}`,
              body: issueBody,
              labels: ['bug', 'build-error', 'automated']
            });
          }
          
    - name: æ„å»ºå¤±è´¥é€šçŸ¥
      if: steps.build.outputs.build_status == 'failed'
      run: |
        echo "âŒ æ„å»ºå¤±è´¥ï¼è¯·æ£€æŸ¥æ—¥å¿—ã€‚"
        exit 1

