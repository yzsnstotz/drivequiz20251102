name: guard-dynamic-route-options

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Ensure all route.ts have segment options at top (within first 30 lines)
        run: |
          files=$(git ls-files "src/app/**/route.ts")
          echo "Found $(echo "$files" | wc -l) route.ts files"
          fail=0
          for f in $files; do
            if [ ! -f "$f" ]; then
              echo "⚠️  File not found: $f"
              continue
            fi
            # Check if all four constants exist within first 30 lines
            head -n 30 "$f" | grep -q 'export const dynamic = "force-dynamic"'
            a=$?
            head -n 30 "$f" | grep -q 'export const revalidate = 0'
            b=$?
            head -n 30 "$f" | grep -q 'export const fetchCache = "force-no-store"'
            c=$?
            head -n 30 "$f" | grep -q 'export const runtime = "nodejs"'
            d=$?
            if [ $a -ne 0 ] || [ $b -ne 0 ] || [ $c -ne 0 ] || [ $d -ne 0 ]; then
              echo "::error file=$f::Missing required route segment options at top of file"
              echo "❌ $f: Missing required route segment options within first 30 lines"
              echo "   dynamic=$a revalidate=$b fetchCache=$c runtime=$d"
              fail=1
            else
              echo "✅ $f"
            fi
          done
          if [ $fail -eq 0 ]; then
            echo "✅ All route.ts files have required segment options at top"
          fi
          exit $fail
